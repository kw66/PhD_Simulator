<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç ”ç©¶ç”Ÿæ¨¡æ‹Ÿå™¨</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #6c5ce7;
            --secondary-color: #a29bfe;
            --accent-color: #fd79a8;
            --success-color: #00b894;
            --warning-color: #fdcb6e;
            --danger-color: #e17055;
            --info-color: #74b9ff;
            --light-bg: #f8f9fa;
            --card-bg: #ffffff;
            --text-primary: #2d3436;
            --text-secondary: #636e72;
            --border-color: #dfe6e9;
            --shadow: 0 4px 15px rgba(0,0,0,0.1);
            --shadow-hover: 0 8px 25px rgba(0,0,0,0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: var(--text-primary);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: var(--shadow-hover);
            transform: scale(0.8);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-content {
            margin-bottom: 20px;
            line-height: 1.8;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-family: inherit;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #55efc4);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #fab1a0);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #ffeaa7);
            color: var(--text-primary);
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info-color), #a0d2ff);
            color: white;
        }

        .btn-accent {
            background: linear-gradient(135deg, var(--accent-color), #ffb8d0);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        #start-screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .start-container {
            background: var(--card-bg);
            border-radius: 30px;
            padding: 40px;
            max-width: 900px;
            width: 100%;
            box-shadow: var(--shadow-hover);
            text-align: center;
        }

        .game-title {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .game-author {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .game-intro {
            font-size: 1rem;
            color: var(--text-secondary);
            line-height: 1.8;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--light-bg);
            border-radius: 15px;
            text-align: left;
        }

        .character-selection h3 {
            font-size: 1.3rem;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .character-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .character-card {
            background: var(--light-bg);
            border: 3px solid transparent;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .character-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow);
            border-color: var(--secondary-color);
        }

        .character-card.selected {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, rgba(108,92,231,0.1), rgba(162,155,254,0.1));
        }

        .character-card .icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .character-card .name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .character-card .desc {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .character-card .bonus {
            padding: 8px 12px;
            background: rgba(0,184,148,0.15);
            border-radius: 8px;
            font-size: 0.85rem;
            color: var(--success-color);
            font-weight: 500;
        }

        .start-btn {
            font-size: 1.2rem;
            padding: 15px 50px;
        }

        #game-screen {
            display: none;
            min-height: 100vh;
            padding: 15px;
        }

        .game-container {
            display: grid;
            grid-template-columns: 300px 1fr 320px;
            gap: 15px;
            max-width: 1700px;
            margin: 0 auto;
        }

        .panel {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .panel-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }

        .left-column {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .attribute-bar {
            margin-bottom: 12px;
        }

        .attribute-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .attribute-label .name {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .attribute-label .value {
            font-weight: 600;
            color: var(--primary-color);
        }

        .progress-bar {
            height: 14px;
            background: var(--border-color);
            border-radius: 7px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 7px;
            transition: width 0.5s ease;
        }

        .progress-fill.san { background: linear-gradient(90deg, #e17055, #fdcb6e); }
        .progress-fill.research { background: linear-gradient(90deg, #6c5ce7, #a29bfe); }
        .progress-fill.social { background: linear-gradient(90deg, #00b894, #55efc4); }
        .progress-fill.favor { background: linear-gradient(90deg, #fd79a8, #ffb8d0); }

        .gold-display {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
            border-radius: 12px;
            margin-top: 10px;
        }

        .gold-display .gold-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .gold-display .gold-info i {
            color: #d68910;
            font-size: 1.3rem;
        }

        .buff-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            max-height: 150px;
            overflow-y: auto;
        }

        .buff-tag {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .buff-tag.permanent {
            background: linear-gradient(135deg, rgba(0,184,148,0.2), rgba(85,239,196,0.2));
            color: #00a878;
            border: 1px solid var(--success-color);
        }

        .buff-tag.temporary {
            background: linear-gradient(135deg, rgba(116,185,255,0.2), rgba(162,155,254,0.2));
            color: #4a90d9;
            border: 1px solid var(--info-color);
        }

        .research-summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .research-stat {
            padding: 10px;
            background: var(--light-bg);
            border-radius: 10px;
            text-align: center;
        }

        .research-stat .label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .research-stat .value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .paper-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .paper-item {
            padding: 12px;
            background: var(--light-bg);
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid var(--primary-color);
        }

        .paper-item.grade-A { border-left-color: #e17055; }
        .paper-item.grade-B { border-left-color: #fdcb6e; }
        .paper-item.grade-C { border-left-color: #00b894; }

        .paper-item .title {
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .paper-item .meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .middle-column {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .graduation-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .date-display {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .date-box {
            padding: 12px 25px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 12px;
            text-align: center;
        }

        .date-box .year {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .date-box .month {
            font-size: 0.9rem;
        }

        .remaining-time {
            padding: 12px 18px;
            background: linear-gradient(135deg, var(--warning-color), #ffeaa7);
            border-radius: 12px;
            font-weight: 500;
        }

        .graduation-target {
            padding: 12px 18px;
            background: var(--light-bg);
            border-radius: 12px;
        }

        .graduation-target .label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .graduation-target .target {
            font-weight: 600;
            color: var(--primary-color);
        }

        .log-content {
            height: 280px;
            overflow-y: auto;
            padding: 10px;
            background: var(--light-bg);
            border-radius: 12px;
        }

        .log-entry {
            padding: 10px 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            background: white;
            border-left: 3px solid var(--primary-color);
            font-size: 0.9rem;
        }

        .log-entry .date {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 0.85rem;
        }

        .log-entry .result {
            color: var(--success-color);
            font-weight: 500;
        }

        .log-entry.negative .result {
            color: var(--danger-color);
        }

        .action-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .action-btn {
            padding: 15px 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
        }

        .action-btn i {
            font-size: 1.5rem;
        }

        .action-btn.next-month {
            grid-column: span 3;
            flex-direction: row;
            justify-content: center;
        }

        .paper-slots {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .paper-slot {
            padding: 15px;
            background: var(--light-bg);
            border-radius: 15px;
            border: 2px dashed var(--border-color);
        }

        .paper-slot.active {
            border-style: solid;
            border-color: var(--primary-color);
        }

        .paper-slot.locked {
            opacity: 0.5;
        }

        .paper-slot .slot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .paper-slot .slot-title {
            font-weight: 600;
            color: var(--primary-color);
        }

        .paper-slot .paper-title {
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 10px;
            word-break: break-word;
        }

        .paper-scores {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }

        .score-box {
            text-align: center;
            padding: 8px;
            background: white;
            border-radius: 8px;
        }

        .score-box .label {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        .score-box .value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .paper-total {
            text-align: center;
            padding: 8px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 8px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .paper-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .paper-actions .btn {
            padding: 8px;
            font-size: 0.8rem;
            justify-content: center;
        }

        .new-paper-btn {
            width: 100%;
            padding: 25px;
            border: 2px dashed var(--primary-color);
            background: transparent;
            color: var(--primary-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            font-family: inherit;
        }

        .new-paper-btn:hover {
            background: rgba(108,92,231,0.1);
        }

        .reviewing-badge {
            display: inline-block;
            padding: 4px 10px;
            background: var(--warning-color);
            color: var(--text-primary);
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light-bg);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--secondary-color);
            border-radius: 3px;
        }

        @media (max-width: 1200px) {
            .game-container {
                grid-template-columns: 1fr;
            }
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <!-- å¼€å§‹ç•Œé¢ -->
    <div id="start-screen">
        <div class="start-container">
            <h1 class="game-title">ğŸ“ ç ”ç©¶ç”Ÿæ¨¡æ‹Ÿå™¨</h1>
            <p class="game-author">by è½æ˜Ÿå³¦</p>
            
            <div class="game-intro">
                <p>ğŸ“š <strong>æ¬¢è¿æ¥åˆ°ç ”ç©¶ç”Ÿæ¨¡æ‹Ÿå™¨ï¼</strong></p>
                <p>åœ¨è¿™é‡Œï¼Œä½ å°†ä½“éªŒä¸€æ®µå……å®çš„ç ”ç©¶ç”Ÿç”Ÿæ¶¯ã€‚ä½ éœ€è¦å¹³è¡¡ç§‘ç ”ã€ç”Ÿæ´»å’Œäººé™…å…³ç³»ï¼ŒåŠªåŠ›å‘è¡¨è®ºæ–‡ï¼Œæœ€ç»ˆé¡ºåˆ©æ¯•ä¸šã€‚</p>
                <br>
                <p>ğŸ¯ <strong>æ¸¸æˆç›®æ ‡</strong>ï¼šæ»¡è¶³æ¯•ä¸šçš„ç§‘ç ”åˆ†æ•°è¦æ±‚</p>
                <p>â€¢ ç¡•å£«æ¯•ä¸šï¼šç§‘ç ”åˆ† â‰¥ 1 ï¼ˆå­¦åˆ¶3å¹´ï¼‰</p>
                <p>â€¢ åšå£«æ¯•ä¸šï¼šç§‘ç ”åˆ† â‰¥ 7 ï¼ˆå­¦åˆ¶5å¹´ï¼‰</p>
                <br>
                <p>ğŸ“ <strong>è®ºæ–‡ç§‘ç ”åˆ†</strong>ï¼šAç±»=4åˆ†ï¼ŒBç±»=2åˆ†ï¼ŒCç±»=1åˆ†</p>
                <br>
                <p>âš ï¸ <strong>æ³¨æ„</strong>ï¼šä¿æŒSANå€¼ã€å¯¼å¸ˆå¥½æ„Ÿåº¦å’Œé‡‘é’±ä¸ºæ­£æ•°ï¼Œå¦åˆ™å°†è§¦å‘ä¸è‰¯ç»“å±€ï¼</p>
            </div>

            <div class="character-selection">
                <h3><i class="fas fa-users"></i> é€‰æ‹©ä½ çš„è§’è‰²</h3>
                <div class="character-grid" id="character-grid">
                    <!-- è§’è‰²å¡ç‰‡å°†ç”±JSç”Ÿæˆ -->
                </div>
            </div>

            <button class="btn btn-primary start-btn" id="start-btn" disabled>
                <i class="fas fa-play"></i> å¼€å§‹æ–°çš„ç”Ÿæ¶¯
            </button>
        </div>
    </div>

    <!-- æ¸¸æˆä¸»ç•Œé¢ -->
    <div id="game-screen">
        <div class="game-container">
            <!-- å·¦ä¾§æ  -->
            <div class="left-column">
                <div class="panel" id="attributes-panel">
                    <div class="panel-title"><i class="fas fa-chart-bar"></i> ä¸ªäººå±æ€§</div>
                    <div class="attribute-bar">
                        <div class="attribute-label">
                            <span class="name"><i class="fas fa-brain"></i> SANå€¼</span>
                            <span class="value"><span id="san-value">20</span>/<span id="san-max">20</span></span>
                        </div>
                        <div class="progress-bar"><div class="progress-fill san" id="san-bar"></div></div>
                    </div>
                    <div class="attribute-bar">
                        <div class="attribute-label">
                            <span class="name"><i class="fas fa-flask"></i> ç§‘ç ”èƒ½åŠ›</span>
                            <span class="value"><span id="research-value">1</span>/20</span>
                        </div>
                        <div class="progress-bar"><div class="progress-fill research" id="research-bar"></div></div>
                    </div>
                    <div class="attribute-bar">
                        <div class="attribute-label">
                            <span class="name"><i class="fas fa-users"></i> ç¤¾äº¤èƒ½åŠ›</span>
                            <span class="value"><span id="social-value">1</span>/20</span>
                        </div>
                        <div class="progress-bar"><div class="progress-fill social" id="social-bar"></div></div>
                    </div>
                    <div class="attribute-bar">
                        <div class="attribute-label">
                            <span class="name"><i class="fas fa-heart"></i> å¯¼å¸ˆå¥½æ„Ÿåº¦</span>
                            <span class="value"><span id="favor-value">1</span>/20</span>
                        </div>
                        <div class="progress-bar"><div class="progress-fill favor" id="favor-bar"></div></div>
                    </div>
                    <div class="gold-display">
                        <div class="gold-info"><i class="fas fa-coins"></i><span><span id="gold-value">1</span> é‡‘å¸</span></div>
                        <button class="btn btn-warning" style="padding: 8px 16px;" onclick="openShop()"><i class="fas fa-store"></i> å•†åº—</button>
                    </div>
                </div>

                <div class="panel" id="buff-panel">
                    <div class="panel-title"><i class="fas fa-magic"></i> å¢ç›Šæ•ˆæœ</div>
                    <div class="buff-list" id="buff-list"><span style="color: var(--text-secondary);">æš‚æ— å¢ç›Šæ•ˆæœ</span></div>
                </div>

                <div class="panel" id="research-panel">
                    <div class="panel-title"><i class="fas fa-award"></i> ç§‘ç ”æˆæœ</div>
                    <div class="research-summary">
                        <div class="research-stat"><div class="label">Aç±»è®ºæ–‡</div><div class="value" id="paper-a-count">0</div></div>
                        <div class="research-stat"><div class="label">Bç±»è®ºæ–‡</div><div class="value" id="paper-b-count">0</div></div>
                        <div class="research-stat"><div class="label">Cç±»è®ºæ–‡</div><div class="value" id="paper-c-count">0</div></div>
                        <div class="research-stat"><div class="label">æ€»ç§‘ç ”åˆ†</div><div class="value" id="total-score">0</div></div>
                        <div class="research-stat" style="grid-column: span 2;"><div class="label">æ€»å¼•ç”¨æ•°</div><div class="value" id="total-citations">0</div></div>
                    </div>
                    <div class="paper-list" id="published-papers">
                        <p style="color: var(--text-secondary); font-size: 0.85rem; text-align: center;">æš‚æ— å·²å‘è¡¨è®ºæ–‡<br><small>Aç±»=4åˆ† Bç±»=2åˆ† Cç±»=1åˆ†</small></p>
                    </div>
                </div>
            </div>

            <!-- ä¸­é—´æ  -->
            <div class="middle-column">
                <div class="panel" id="graduation-panel">
                    <div class="panel-title"><i class="fas fa-graduation-cap"></i> æ¯•ä¸šä¿¡æ¯</div>
                    <div class="graduation-info">
                        <div class="date-display">
                            <div class="date-box">
                                <div class="year">ç¬¬<span id="current-year">1</span>å¹´</div>
                                <div class="month">ç¬¬<span id="current-month">1</span>æœˆ</div>
                            </div>
                            <div class="remaining-time"><i class="fas fa-hourglass-half"></i> å‰©ä½™ <span id="remaining-time">36</span> ä¸ªæœˆ</div>
                        </div>
                        <div class="graduation-target">
                            <div class="label">ğŸ¯ æ¯•ä¸šç›®æ ‡</div>
                            <div class="target" id="graduation-target">ç¡•å£«æ¯•ä¸šï¼šç§‘ç ”åˆ† â‰¥ 1</div>
                        </div>
                    </div>
                </div>

                <div class="panel" id="log-panel" style="flex:1;">
                    <div class="panel-title"><i class="fas fa-scroll"></i> æ¸¸æˆæ—¥å¿—</div>
                    <div class="log-content" id="log-content"></div>
                </div>

                <div class="panel" id="action-panel">
                    <div class="panel-title"><i class="fas fa-gamepad"></i> æ“ä½œ</div>
                    <div class="action-grid">
                        <button class="btn btn-info action-btn" id="btn-read" onclick="readPaper()"><i class="fas fa-book-open"></i><span>çœ‹è®ºæ–‡</span></button>
                        <button class="btn btn-warning action-btn" id="btn-work" onclick="partTimeJob()"><i class="fas fa-briefcase"></i><span>æ‰“å·¥</span></button>
                        <button class="btn btn-accent action-btn" id="btn-idea" onclick="thinkIdea()"><i class="fas fa-lightbulb"></i><span>æƒ³idea</span></button>
                        <button class="btn btn-primary action-btn" id="btn-experiment" onclick="doExperiment()"><i class="fas fa-vial"></i><span>åšå®éªŒ</span></button>
                        <button class="btn btn-success action-btn" id="btn-write" onclick="writePaper()"><i class="fas fa-pen-fancy"></i><span>å†™è®ºæ–‡</span></button>
                        <button class="btn btn-danger action-btn" id="btn-next" onclick="nextMonth()"><i class="fas fa-forward"></i><span>ä¸‹ä¸€æœˆ</span></button>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§æ  -->
            <div class="right-column">
                <div class="panel" id="workstation-panel">
                    <div class="panel-title"><i class="fas fa-file-alt"></i> è®ºæ–‡å·¥ä½œç«™</div>
                    <div class="paper-slots" id="paper-slots"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- é€šç”¨å¼¹çª— -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal" id="modal">
            <h3 class="modal-title" id="modal-title">æ ‡é¢˜</h3>
            <div class="modal-content" id="modal-content">å†…å®¹</div>
            <div class="modal-buttons" id="modal-buttons"></div>
        </div>
    </div>

    <script>
        // ==================== æ¸¸æˆæ•°æ® ====================
        const characters = [
            { id: 'normal', name: 'å¤§å¤šæ•°', icon: 'ğŸ‘¤', desc: 'èŠ¸èŠ¸ä¼—ç”Ÿä¸­çš„æ™®é€šä¸€å‘˜', bonus: 'æ²¡æœ‰ä»»ä½•å±æ€§å˜åŒ–', stats: {} },
            { id: 'genius', name: 'é™¢å£«è½¬ä¸–', icon: 'ğŸ”¬', desc: 'å¤©ç”Ÿå°±æ˜¯åšç§‘ç ”çš„æ–™', bonus: 'ç§‘ç ”èƒ½åŠ›åˆå§‹ +5', stats: { research: 5 } },
            { id: 'social', name: 'ç¤¾äº¤è¾¾äºº', icon: 'ğŸ¤', desc: 'å…«é¢ç²ç‘çš„ç¤¾äº¤é«˜æ‰‹', bonus: 'ç¤¾äº¤èƒ½åŠ›åˆå§‹ +5', stats: { social: 5 } },
            { id: 'rich', name: 'å¯Œå¯æ•Œå›½', icon: 'ğŸ’°', desc: 'å®¶å¢ƒæ®·å®æ— å¿§æ— è™‘', bonus: 'é‡‘å¸å€¼åˆå§‹ +5', stats: { gold: 5 } },
            { id: 'teacher-child', name: 'å¯¼å¸ˆå­å¥³', icon: 'ğŸ‘¨â€ğŸ‘§', desc: 'è¿‘æ°´æ¥¼å°å…ˆå¾—æœˆ', bonus: 'å¯¼å¸ˆå¥½æ„Ÿåº¦åˆå§‹ +5', stats: { favor: 5 } },
            { id: 'chosen', name: 'å¤©é€‰ä¹‹äºº', icon: 'â­', desc: 'å‘½è¿çš„å® å„¿å…¨é¢å‘å±•', bonus: 'ç§‘ç ”+2 ç¤¾äº¤+2 å¥½æ„Ÿ+2 é‡‘å¸+2', stats: { research: 2, social: 2, favor: 2, gold: 2 } }
        ];

        const paperTitleWords = {
            adjectives: ['Deep', 'Neural', 'Efficient', 'Scalable', 'Robust', 'Adaptive', 'Dynamic', 'Multi-modal', 'Self-supervised', 'Federated', 'Attention-based', 'Graph-based', 'Hierarchical', 'Contrastive', 'Progressive', 'Unified'],
            nouns: ['Learning', 'Networks', 'Transformers', 'Models', 'Representations', 'Framework', 'Architecture', 'Approach', 'Method', 'System', 'Embeddings', 'Reasoning', 'Generation', 'Recognition'],
            verbs: ['Understanding', 'Generating', 'Predicting', 'Detecting', 'Recognizing', 'Synthesizing', 'Optimizing', 'Training', 'Enhancing', 'Improving'],
            domains: ['Vision', 'Language', 'Speech', 'Text', 'Images', 'Videos', 'Knowledge', 'Data', 'Graphs', 'Medical', '3D', 'Autonomous']
        };

        const shopItems = [
            { id: 'chair', name: 'äººä½“å·¥å­¦æ¤…', desc: 'æ°¸ä¹…buff-æ¯æœˆSANå€¼+1', price: 10, once: true, bought: false },
            { id: 'gpu_rent', name: 'ç§ŸGPUæœåŠ¡å™¨', desc: 'ä¸´æ—¶buff-ä¸‹æ¬¡åšå®éªŒå¤šåš1æ¬¡', price: 2, once: false },
            { id: 'gpu_buy', name: 'è´­ä¹°GPUæœåŠ¡å™¨', desc: 'æ°¸ä¹…buff-æ¯æ¬¡åšå®éªŒå¤šåš1æ¬¡', price: 12, once: false },
            { id: 'keyboard', name: 'æœºæ¢°é”®ç›˜', desc: 'æ°¸ä¹…buff-æ¯æ¬¡å†™è®ºæ–‡å˜ä¸ºSANå€¼-3', price: 8, once: true, bought: false },
            { id: 'monitor', name: '4Kæ˜¾ç¤ºå™¨', desc: 'æ°¸ä¹…buff-è¯»è®ºæ–‡å˜ä¸ºSANå€¼-1', price: 8, once: true, bought: false },
            { id: 'coffee', name: 'å†°ç¾å¼', desc: 'SANå€¼+2', price: 1, monthlyOnce: true, boughtThisMonth: false },
            { id: 'polish', name: 'è®ºæ–‡æ¶¦è‰²æœåŠ¡', desc: 'ä¸´æ—¶buff-ä¸‹æ¬¡è®ºæ–‡å†™ä½œåˆ†æ•°+5', price: 3, monthlyOnce: true, boughtThisMonth: false }
        ];

        // ==================== æ¸¸æˆçŠ¶æ€ ====================
        let gameState = {};
        let selectedCharacter = null;

        function getInitialState() {
            return {
                character: null,
                characterName: '',
                degree: 'master',
                year: 1,
                month: 1,
                totalMonths: 0,
                maxYears: 3,
                san: 20,
                sanMax: 20,
                research: 1,
                social: 1,
                favor: 1,
                gold: 1,
                paperA: 0,
                paperB: 0,
                paperC: 0,
                totalScore: 0,
                totalCitations: 0,
                publishedPapers: [],
                paperSlots: 1,
                papers: [null, null, null, null],
                buffs: { permanent: [], temporary: [] },
                actionUsed: false,
                readCount: 0,
                firstPaperAccepted: false,
                firstAPaperAccepted: false,
                hasLover: false,
                loverType: null,
                bigBullCooperation: false,
                rejectedCount: 0,
                teaBreakCount: 0,
                tourCount: 0,
                metBigBull: false,
                metBeautiful: false,
                metSmart: false,
                bigBullDeepCount: 0,
                beautifulCount: 0,
                smartCount: 0
            };
        }

        // ==================== åˆå§‹åŒ– ====================
        function init() {
            renderCharacterGrid();
            document.getElementById('start-btn').addEventListener('click', startGame);
        }

        function renderCharacterGrid() {
            const grid = document.getElementById('character-grid');
            grid.innerHTML = characters.map(char => `
                <div class="character-card" data-id="${char.id}" onclick="selectCharacter('${char.id}')">
                    <div class="icon">${char.icon}</div>
                    <div class="name">${char.name}</div>
                    <div class="desc">${char.desc}</div>
                    <div class="bonus">${char.bonus}</div>
                </div>
            `).join('');
        }

        function selectCharacter(id) {
            selectedCharacter = characters.find(c => c.id === id);
            document.querySelectorAll('.character-card').forEach(card => {
                card.classList.toggle('selected', card.dataset.id === id);
            });
            document.getElementById('start-btn').disabled = false;
        }

        function startGame() {
            if (!selectedCharacter) return;

            gameState = getInitialState();
            gameState.character = selectedCharacter.id;
            gameState.characterName = selectedCharacter.name;

            // åº”ç”¨è§’è‰²åŠ æˆ
            if (selectedCharacter.stats.research) gameState.research += selectedCharacter.stats.research;
            if (selectedCharacter.stats.social) gameState.social += selectedCharacter.stats.social;
            if (selectedCharacter.stats.favor) gameState.favor += selectedCharacter.stats.favor;
            if (selectedCharacter.stats.gold) gameState.gold += selectedCharacter.stats.gold;

            // é‡ç½®å•†åº—
            shopItems.forEach(item => {
                if (item.once) item.bought = false;
                if (item.monthlyOnce) item.boughtThisMonth = false;
            });

            // åˆ‡æ¢ç•Œé¢
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-screen').style.display = 'block';

            // åˆå§‹åŒ–ç•Œé¢
            document.getElementById('log-content').innerHTML = '';
            checkResearchUnlock(true);
            updateAllUI();
            renderPaperSlots();

            // åˆå§‹æ—¥å¿—
            addLog('æ¸¸æˆå¼€å§‹', `æ¬¢è¿æ¥åˆ°ç ”ç©¶ç”Ÿæ¨¡æ‹Ÿå™¨ï¼ä½ é€‰æ‹©äº†ã€${gameState.characterName}ã€‘`);
            addLog('æ¸¸æˆç›®æ ‡', 'ç¡•å£«æ¯•ä¸šéœ€è¦ç§‘ç ”åˆ†â‰¥1ï¼Œåšå£«æ¯•ä¸šéœ€è¦ç§‘ç ”åˆ†â‰¥7');
            addLog('æ¸¸æˆæç¤º', 'è®ºæ–‡ç§‘ç ”åˆ†ï¼šAç±»=4åˆ†ï¼ŒBç±»=2åˆ†ï¼ŒCç±»=1åˆ†');
            addLog('æ“ä½œæç¤º', 'æ¯æœˆå¯æ‰§è¡Œä¸€æ¬¡æŒç»­æ“ä½œï¼ˆçœ‹è®ºæ–‡/æ‰“å·¥/æƒ³idea/åšå®éªŒ/å†™è®ºæ–‡ï¼‰');
        }

        // ==================== UIæ›´æ–° ====================
        function updateAllUI() {
            updateAttributes();
            updateGraduation();
            updateBuffs();
            updateResearchResults();
            updateActionButtons();
        }

        function updateAttributes() {
            document.getElementById('san-value').textContent = gameState.san;
            document.getElementById('san-max').textContent = gameState.sanMax;
            document.getElementById('san-bar').style.width = `${Math.max(0, (gameState.san / gameState.sanMax) * 100)}%`;

            document.getElementById('research-value').textContent = gameState.research;
            document.getElementById('research-bar').style.width = `${(gameState.research / 20) * 100}%`;

            document.getElementById('social-value').textContent = gameState.social;
            document.getElementById('social-bar').style.width = `${(gameState.social / 20) * 100}%`;

            document.getElementById('favor-value').textContent = gameState.favor;
            document.getElementById('favor-bar').style.width = `${Math.max(0, (gameState.favor / 20) * 100)}%`;

            document.getElementById('gold-value').textContent = gameState.gold;
        }

        function updateGraduation() {
            document.getElementById('current-year').textContent = gameState.year;
            document.getElementById('current-month').textContent = gameState.month;
            const remaining = (gameState.maxYears * 12) - gameState.totalMonths;
            document.getElementById('remaining-time').textContent = remaining;
            document.getElementById('graduation-target').textContent = 
                gameState.degree === 'master' ? 'ç¡•å£«æ¯•ä¸šï¼šç§‘ç ”åˆ† â‰¥ 1' : 'åšå£«æ¯•ä¸šï¼šç§‘ç ”åˆ† â‰¥ 7';
        }

        function updateBuffs() {
            const list = document.getElementById('buff-list');
            const allBuffs = [...gameState.buffs.permanent, ...gameState.buffs.temporary];
            if (allBuffs.length === 0) {
                list.innerHTML = '<span style="color: var(--text-secondary);">æš‚æ— å¢ç›Šæ•ˆæœ</span>';
                return;
            }
            list.innerHTML = allBuffs.map(buff => `
                <span class="buff-tag ${buff.permanent ? 'permanent' : 'temporary'}">
                    <i class="fas ${buff.permanent ? 'fa-infinity' : 'fa-clock'}"></i>
                    ${buff.name}
                </span>
            `).join('');
        }

        function updateResearchResults() {
            document.getElementById('paper-a-count').textContent = gameState.paperA;
            document.getElementById('paper-b-count').textContent = gameState.paperB;
            document.getElementById('paper-c-count').textContent = gameState.paperC;
            document.getElementById('total-score').textContent = gameState.totalScore;
            document.getElementById('total-citations').textContent = gameState.totalCitations;

            const paperList = document.getElementById('published-papers');
            if (gameState.publishedPapers.length === 0) {
                paperList.innerHTML = '<p style="color: var(--text-secondary); font-size: 0.85rem; text-align: center;">æš‚æ— å·²å‘è¡¨è®ºæ–‡<br><small>Aç±»=4åˆ† Bç±»=2åˆ† Cç±»=1åˆ†</small></p>';
            } else {
                paperList.innerHTML = gameState.publishedPapers.map(p => `
                    <div class="paper-item grade-${p.grade}">
                        <div class="title">${p.title}</div>
                        <div class="meta">
                            <span>${p.grade}ç±» | ${p.acceptType}</span>
                            <span>åˆ†æ•°:${p.score} å¼•ç”¨:${p.citations}</span>
                        </div>
                    </div>
                `).join('');
            }
        }

        function updateActionButtons() {
            const btns = ['btn-read', 'btn-work', 'btn-idea', 'btn-experiment', 'btn-write'];
            btns.forEach(id => {
                const btn = document.getElementById(id);
                btn.disabled = gameState.actionUsed;
                btn.style.opacity = gameState.actionUsed ? '0.5' : '1';
            });
        }

        // ==================== è®ºæ–‡å·¥ä½œç«™ ====================
        function renderPaperSlots() {
            const container = document.getElementById('paper-slots');
            let html = '';
            for (let i = 0; i < 4; i++) {
                const unlocked = i < gameState.paperSlots;
                const paper = gameState.papers[i];
                
                if (!unlocked) {
                    const req = [0, 6, 12, 18][i];
                    html += `<div class="paper-slot locked">
                        <div class="slot-header">
                            <span class="slot-title">è®ºæ–‡æ§½ ${i + 1}</span>
                            <span class="reviewing-badge"><i class="fas fa-lock"></i> ç§‘ç ”${req}è§£é”</span>
                        </div>
                    </div>`;
                } else if (!paper) {
                    html += `<div class="paper-slot">
                        <div class="slot-header">
                            <span class="slot-title">è®ºæ–‡æ§½ ${i + 1}</span>
                            <span style="color:var(--text-secondary)">ç©ºé—²</span>
                        </div>
                        <button class="new-paper-btn" onclick="createNewPaper(${i})">
                            <i class="fas fa-plus"></i> å¼€å¯æ–°è®ºæ–‡
                        </button>
                    </div>`;
                } else {
                    const total = paper.ideaScore + paper.expScore + paper.writeScore;
                    const canSubmit = paper.ideaScore > 0 && paper.expScore > 0 && paper.writeScore > 0 && !paper.reviewing;
                    html += `<div class="paper-slot active">
                        <div class="slot-header">
                            <span class="slot-title">è®ºæ–‡æ§½ ${i + 1}</span>
                            ${paper.reviewing ? `<span class="reviewing-badge"><i class="fas fa-hourglass-half"></i> å®¡ç¨¿ä¸­(${paper.reviewMonths}æœˆ)</span>` : ''}
                        </div>
                        <div class="paper-title">${paper.title}</div>
                        <div class="paper-scores">
                            <div class="score-box"><div class="label">Ideaåˆ†</div><div class="value">${paper.ideaScore}</div></div>
                            <div class="score-box"><div class="label">å®éªŒåˆ†</div><div class="value">${paper.expScore}</div></div>
                            <div class="score-box"><div class="label">å†™ä½œåˆ†</div><div class="value">${paper.writeScore}</div></div>
                        </div>
                        <div class="paper-total">æ€»åˆ†: ${total}</div>
                        <div class="paper-actions">
                            <button class="btn btn-danger" onclick="submitPaper(${i},'A')" ${!canSubmit?'disabled':''}><i class="fas fa-star"></i> æŠ•A</button>
                            <button class="btn btn-warning" onclick="submitPaper(${i},'B')" ${!canSubmit?'disabled':''}><i class="fas fa-certificate"></i> æŠ•B</button>
                            <button class="btn btn-success" onclick="submitPaper(${i},'C')" ${!canSubmit?'disabled':''}><i class="fas fa-check"></i> æŠ•C</button>
                            <button class="btn btn-info" onclick="abandonPaper(${i})" ${paper.reviewing?'disabled':''}><i class="fas fa-trash"></i> æ”¾å¼ƒ</button>
                        </div>
                    </div>`;
                }
            }
            container.innerHTML = html;
        }

        function generatePaperTitle() {
            const w = paperTitleWords;
            const templates = [
                () => `${rand(w.adjectives)} ${rand(w.nouns)} for ${rand(w.domains)} ${rand(w.verbs)}`,
                () => `${rand(w.verbs)} ${rand(w.domains)} with ${rand(w.adjectives)} ${rand(w.nouns)}`,
                () => `${rand(w.adjectives)} ${rand(w.adjectives)} ${rand(w.nouns)}`,
                () => `Towards ${rand(w.adjectives)} ${rand(w.domains)} ${rand(w.nouns)}`,
                () => `${rand(w.domains)} ${rand(w.verbs)} via ${rand(w.adjectives)} ${rand(w.nouns)}`
            ];
            return rand(templates)();
        }

        function createNewPaper(slot) {
            const title = generatePaperTitle();
            gameState.papers[slot] = {
                title: title,
                ideaScore: 0,
                expScore: 0,
                writeScore: 0,
                reviewing: false,
                reviewMonths: 0,
                submittedGrade: null
            };
            addLog('æ–°è®ºæ–‡', `åœ¨è®ºæ–‡æ§½${slot + 1}å¼€å¯äº†æ–°è®ºæ–‡ï¼š${title}`);
            renderPaperSlots();
        }

        function checkResearchUnlock(silent = false) {
            const thresholds = [0, 6, 12, 18];
            let newUnlock = false;
            for (let i = 1; i < 4; i++) {
                if (gameState.research >= thresholds[i] && gameState.paperSlots <= i) {
                    gameState.paperSlots = i + 1;
                    newUnlock = true;
                }
            }
            if (newUnlock && !silent) {
                showModal('ğŸ‰ æ–°è®ºæ–‡æ§½è§£é”ï¼', 
                    `<p>æ­å–œï¼ä½ çš„ç§‘ç ”èƒ½åŠ›è¾¾åˆ° ${gameState.research}ï¼Œè§£é”äº†è®ºæ–‡æ§½ ${gameState.paperSlots}ï¼</p>`,
                    [{ text: 'å¤ªæ£’äº†ï¼', class: 'btn-primary', action: closeModal }]);
                renderPaperSlots();
            }
        }

        // ==================== æ“ä½œåŠŸèƒ½ ====================
        function readPaper() {
            if (gameState.actionUsed) return;
            gameState.actionUsed = true;
            
            const has4K = gameState.buffs.permanent.some(b => b.type === 'read_san_reduce');
            gameState.san -= has4K ? 1 : 2;
            gameState.readCount++;

            gameState.buffs.temporary.push({ type: 'idea_bonus', name: 'ä¸‹æ¬¡æƒ³ideaåˆ†æ•°+1', value: 1, permanent: false });

            let result = has4K ? 'SANå€¼-1ï¼ˆ4Kæ˜¾ç¤ºå™¨ç”Ÿæ•ˆï¼‰' : 'SANå€¼-2';
            result += 'ï¼Œè·å¾—ä¸´æ—¶buffï¼šä¸‹æ¬¡æƒ³ideaåˆ†æ•°+1';

            if (gameState.readCount % 10 === 0) {
                gameState.research = Math.min(20, gameState.research + 1);
                result += 'ï¼Œé˜…è¯»è®ºæ–‡è¾¾åˆ°10æ¬¡ï¼Œç§‘ç ”èƒ½åŠ›+1';
                checkResearchUnlock();
            }

            addLog('çœ‹è®ºæ–‡', 'è®¤çœŸé˜…è¯»äº†å­¦æœ¯è®ºæ–‡', result);
            updateAllUI();
            checkGameOver();
        }

        function partTimeJob() {
            if (gameState.actionUsed) return;
            gameState.actionUsed = true;
            gameState.san -= 5;
            gameState.gold += 2;
            addLog('æ‰“å·¥', 'è¾›è‹¦å·¥ä½œèµšå–ç”Ÿæ´»è´¹', 'SANå€¼-5ï¼Œé‡‘é’±+2');
            updateAllUI();
            checkGameOver();
        }

        function thinkIdea() {
            if (gameState.actionUsed) return;
            const available = gameState.papers.map((p, i) => ({ paper: p, index: i }))
                .filter(({ paper }) => paper && !paper.reviewing);
            if (available.length === 0) {
                showModal('æ— æ³•æ“ä½œ', '<p>æ²¡æœ‰å¯ç”¨çš„è®ºæ–‡ï¼è¯·å…ˆå¼€å¯ä¸€ç¯‡æ–°è®ºæ–‡ã€‚</p>', 
                    [{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
                return;
            }
            showPaperSelectModal('æƒ³idea', available, (index) => {
                gameState.actionUsed = true;
                gameState.san -= 2;
                const paper = gameState.papers[index];
                
                let times = 1 + countBuff('idea_times');
                let bestScore = paper.ideaScore;
                let lastGen = 0;
                for (let i = 0; i < times; i++) {
                    const gen = calculateScore('idea');
                    lastGen = gen;
                    if (gen > bestScore) bestScore = gen;
                }
                
                let result = `SANå€¼-2`;
                if (times > 1) result += `ï¼ˆæƒ³${times}æ¬¡ï¼‰`;
                if (bestScore > paper.ideaScore) {
                    paper.ideaScore = bestScore;
                    result += `ï¼Œideaåˆ†æ›´æ–°ä¸º${bestScore}`;
                } else {
                    result += `ï¼Œideaåˆ†æœªæ›´æ–°ï¼ˆç”Ÿæˆ${lastGen}ï¼Œå½“å‰${paper.ideaScore}ï¼‰`;
                }
                
                consumeTempBuff('idea_times');
                consumeTempBuff('idea_bonus');
                addLog('æƒ³idea', `ä¸ºè®ºæ–‡"${paper.title.substring(0, 20)}..."æ€è€ƒidea`, result);
                updateAllUI();
                renderPaperSlots();
                checkGameOver();
            });
        }

        function doExperiment() {
            if (gameState.actionUsed) return;
            const available = gameState.papers.map((p, i) => ({ paper: p, index: i }))
                .filter(({ paper }) => paper && !paper.reviewing && paper.ideaScore > 0);
            if (available.length === 0) {
                showModal('æ— æ³•æ“ä½œ', '<p>æ²¡æœ‰å¯ç”¨çš„è®ºæ–‡ï¼éœ€è¦å…ˆæœ‰ideaåˆ†å¤§äº0çš„è®ºæ–‡ã€‚</p>', 
                    [{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
                return;
            }
            showPaperSelectModal('åšå®éªŒ', available, (index) => {
                gameState.actionUsed = true;
                gameState.san -= 3;
                const paper = gameState.papers[index];
                
                let times = 1 + countBuff('exp_times');
                let bestScore = paper.expScore;
                let lastGen = 0;
                for (let i = 0; i < times; i++) {
                    const gen = calculateScore('exp');
                    lastGen = gen;
                    if (gen > bestScore) bestScore = gen;
                }
                
                let result = `SANå€¼-3`;
                if (times > 1) result += `ï¼ˆå®éªŒ${times}æ¬¡ï¼‰`;
                if (bestScore > paper.expScore) {
                    paper.expScore = bestScore;
                    result += `ï¼Œå®éªŒåˆ†æ›´æ–°ä¸º${bestScore}`;
                } else {
                    result += `ï¼Œå®éªŒåˆ†æœªæ›´æ–°ï¼ˆç”Ÿæˆ${lastGen}ï¼Œå½“å‰${paper.expScore}ï¼‰`;
                }
                
                consumeTempBuff('exp_times');
                consumeTempBuff('exp_bonus');
                addLog('åšå®éªŒ', `ä¸ºè®ºæ–‡"${paper.title.substring(0, 20)}..."åšå®éªŒ`, result);
                updateAllUI();
                renderPaperSlots();
                checkGameOver();
            });
        }

        function writePaper() {
            if (gameState.actionUsed) return;
            const available = gameState.papers.map((p, i) => ({ paper: p, index: i }))
                .filter(({ paper }) => paper && !paper.reviewing && paper.expScore > 0);
            if (available.length === 0) {
                showModal('æ— æ³•æ“ä½œ', '<p>æ²¡æœ‰å¯ç”¨çš„è®ºæ–‡ï¼éœ€è¦å…ˆæœ‰å®éªŒåˆ†å¤§äº0çš„è®ºæ–‡ã€‚</p>', 
                    [{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
                return;
            }
            showPaperSelectModal('å†™è®ºæ–‡', available, (index) => {
                gameState.actionUsed = true;
                const hasKeyboard = gameState.buffs.permanent.some(b => b.type === 'write_san_reduce');
                gameState.san -= hasKeyboard ? 3 : 4;
                const paper = gameState.papers[index];
                
                let times = 1 + countBuff('write_times');
                let bestScore = paper.writeScore;
                let lastGen = 0;
                for (let i = 0; i < times; i++) {
                    const gen = calculateScore('write');
                    lastGen = gen;
                    if (gen > bestScore) bestScore = gen;
                }
                
                let result = hasKeyboard ? 'SANå€¼-3ï¼ˆæœºæ¢°é”®ç›˜ç”Ÿæ•ˆï¼‰' : 'SANå€¼-4';
                if (times > 1) result += `ï¼ˆå†™${times}æ¬¡ï¼‰`;
                if (bestScore > paper.writeScore) {
                    paper.writeScore = bestScore;
                    result += `ï¼Œå†™ä½œåˆ†æ›´æ–°ä¸º${bestScore}`;
                } else {
                    result += `ï¼Œå†™ä½œåˆ†æœªæ›´æ–°ï¼ˆç”Ÿæˆ${lastGen}ï¼Œå½“å‰${paper.writeScore}ï¼‰`;
                }
                
                consumeTempBuff('write_times');
                consumeTempBuff('write_bonus');
                addLog('å†™è®ºæ–‡', `ä¸ºè®ºæ–‡"${paper.title.substring(0, 20)}..."å†™ä½œ`, result);
                updateAllUI();
                renderPaperSlots();
                checkGameOver();
            });
        }

        function calculateScore(type) {
            const base = gameState.research * (0.5 + Math.random());
            const randomBonus = Math.floor(Math.random() * 6);
            let score = Math.round(base + randomBonus);

            // åº”ç”¨buff
            let bonus = 0, multiplier = 1;
            const buffType = type + '_bonus';
            [...gameState.buffs.permanent, ...gameState.buffs.temporary].forEach(b => {
                if (b.type === buffType) {
                    if (b.multiply) multiplier *= b.value;
                    else bonus += b.value;
                }
            });
            return Math.round(score * multiplier + bonus);
        }

        function countBuff(type) {
            let count = 0;
            [...gameState.buffs.permanent, ...gameState.buffs.temporary].forEach(b => {
                if (b.type === type) count += b.value;
            });
            return count;
        }

        function consumeTempBuff(type) {
            const idx = gameState.buffs.temporary.findIndex(b => b.type === type);
            if (idx !== -1) gameState.buffs.temporary.splice(idx, 1);
        }

        // ==================== ä¸‹ä¸€ä¸ªæœˆ ====================
        function nextMonth() {
            gameState.actionUsed = false;
            gameState.month++;
            gameState.totalMonths++;

            if (gameState.month > 12) {
                gameState.month = 1;
                gameState.year++;
            }

            // å‘å·¥èµ„å’Œå¼€é”€
            const salary = gameState.degree === 'master' ? 1 : 3;
            gameState.gold += salary - 1;

            // ä¼‘æ¯æ¢å¤
            gameState.san = Math.min(gameState.sanMax, gameState.san + 1);

            // æ‹äººbuff
            if (gameState.hasLover) {
                gameState.san = Math.min(gameState.sanMax, gameState.san + 3);
            }

            // äººä½“å·¥å­¦æ¤…buff
            if (gameState.buffs.permanent.some(b => b.type === 'monthly_san')) {
                gameState.san = Math.min(gameState.sanMax, gameState.san + 1);
            }

            // è®ºæ–‡åˆ†æ•°è¡°å‡
            gameState.papers.forEach(paper => {
                if (paper) {
                    if (paper.ideaScore > 1) paper.ideaScore--;
                    if (paper.expScore > 1) paper.expScore--;
                }
            });

            // å®¡ç¨¿è¿›åº¦
            gameState.papers.forEach((paper, idx) => {
                if (paper && paper.reviewing) {
                    paper.reviewMonths--;
                    if (paper.reviewMonths <= 0) {
                        processPaperResult(idx);
                    }
                }
            });

            // æ›´æ–°å¼•ç”¨
            updateCitations();

            // é‡ç½®æœˆåº¦å•†å“
            shopItems.forEach(item => {
                if (item.monthlyOnce) item.boughtThisMonth = false;
            });

            let logResult = `å·¥èµ„+${salary}ï¼Œå¼€é”€-1ï¼Œä¼‘æ¯SAN+1`;
            if (gameState.hasLover) logResult += 'ï¼Œæ‹äººSAN+3';
            addLog('è¿›å…¥ä¸‹ä¸€æœˆ', `ç¬¬${gameState.year}å¹´ç¬¬${gameState.month}æœˆ`, logResult);

            // éšæœºäº‹ä»¶
            if (gameState.totalMonths >= 2 && gameState.totalMonths % 2 === 0) {
                triggerRandomEvent();
            }

            // æ£€æŸ¥æ¯•ä¸š
            checkGraduation();

            updateAllUI();
            renderPaperSlots();
            checkGameOver();
        }

        function updateCitations() {
            gameState.publishedPapers.forEach(paper => {
                paper.monthsSincePublish = (paper.monthsSincePublish || 0) + 1;
                let shouldUpdate = false;
                if (paper.grade === 'A') shouldUpdate = true;
                else if (paper.grade === 'B' && paper.monthsSincePublish % 3 === 0) shouldUpdate = true;
                else if (paper.grade === 'C' && paper.monthsSincePublish % 6 === 0) shouldUpdate = true;

                if (shouldUpdate) {
                    let gain = Math.round(paper.score / 10);
                    if (paper.acceptType === 'Oral') gain = Math.round(gain * 1.5);
                    if (paper.acceptType === 'Best Paper') gain = Math.round(gain * 5);
                    paper.citations += gain;
                    gameState.totalCitations += gain;
                }
            });
        }
        // ==================== è®ºæ–‡æŠ•ç¨¿ä¸å®¡ç¨¿ ====================
        function submitPaper(slot, grade) {
            const paper = gameState.papers[slot];
            if (!paper || paper.reviewing) return;
            if (paper.ideaScore <= 0 || paper.expScore <= 0 || paper.writeScore <= 0) return;

            paper.reviewing = true;
            paper.reviewMonths = 4;
            paper.submittedGrade = grade;

            addLog('æŠ•ç¨¿', `å°†è®ºæ–‡"${paper.title.substring(0, 20)}..."æŠ•è‡³${grade}ç±»ä¼šè®®`, 'è¿›å…¥4ä¸ªæœˆå®¡ç¨¿æœŸ');
            renderPaperSlots();
        }

        function abandonPaper(slot) {
            const paper = gameState.papers[slot];
            if (!paper || paper.reviewing) return;
            
            showModal('ç¡®è®¤æ”¾å¼ƒ', '<p>ç¡®å®šè¦æ”¾å¼ƒè¿™ç¯‡è®ºæ–‡å—ï¼Ÿæ‰€æœ‰è¿›åº¦å°†ä¸¢å¤±ï¼</p>', [
                { text: 'å–æ¶ˆ', class: 'btn-info', action: closeModal },
                { text: 'ç¡®å®šæ”¾å¼ƒ', class: 'btn-danger', action: () => {
                    addLog('æ”¾å¼ƒè®ºæ–‡', `æ”¾å¼ƒäº†è®ºæ–‡"${paper.title.substring(0, 20)}..."`, 'è®ºæ–‡æ§½å·²æ¸…ç©º');
                    gameState.papers[slot] = null;
                    closeModal();
                    renderPaperSlots();
                }}
            ]);
        }

        function processPaperResult(slot) {
            const paper = gameState.papers[slot];
            const grade = paper.submittedGrade;
            const totalScore = paper.ideaScore + paper.expScore + paper.writeScore;

            // ç”Ÿæˆå®¡ç¨¿äºº
            const reviewers = [generateReviewer(), generateReviewer(), generateReviewer()];
            
            // è®¡ç®—ç»“æœ
            let totalReviewScore = 0;
            const results = reviewers.map(reviewer => {
                const result = getReviewResult(reviewer, grade, totalScore);
                totalReviewScore += result.score;
                return { reviewer, ...result };
            });

            // åˆ¤å®šç»“æœ
            let acceptType = null, accepted = false;
            if (totalReviewScore >= 3) { acceptType = 'Best Paper'; accepted = true; }
            else if (totalReviewScore >= 2) { acceptType = 'Oral'; accepted = true; }
            else if (totalReviewScore >= 0) { acceptType = 'Poster'; accepted = true; }

            // åº”ç”¨å®¡ç¨¿äººæ”¹è¿›
            results.forEach(r => {
                if (r.improvement > 0) {
                    if (r.improvementType === 'idea') paper.ideaScore += r.improvement;
                    else if (r.improvementType === 'exp') paper.expScore += r.improvement;
                    else paper.writeScore += r.improvement;
                }
            });

            showReviewResultModal(paper, grade, results, totalReviewScore, acceptType, accepted, slot);
        }

        function generateReviewer() {
            const r = Math.random();
            if (r < 0.4) return { type: 'normal', name: 'æ™®é€šå®¡ç¨¿äºº' };
            if (r < 0.5) return { type: 'kind', name: 'å¿ƒè½¯å®¡ç¨¿äºº' };
            if (r < 0.6) return { type: 'expert', name: 'èµ„æ·±å¤§ç‰›' };
            if (r < 0.7) return { type: 'hostile', name: 'æ¶æ„å°åŒè¡Œ' };
            if (r < 0.9) return { type: 'gpt', name: 'GPTå®¡ç¨¿äºº' };
            return { type: 'questions', name: '40ä¸ªé—®é¢˜å®¡ç¨¿äºº' };
        }

        function getReviewResult(reviewer, grade, score) {
            let thresholds;
            if (grade === 'A') {
                switch (reviewer.type) {
                    case 'kind': thresholds = { reject: 40, borderline: 60 }; break;
                    case 'normal': case 'expert': thresholds = { reject: 50, borderline: 70 }; break;
                    case 'gpt': thresholds = { reject: 40, borderline: 80 }; break;
                    case 'hostile': case 'questions': thresholds = { reject: 80, borderline: 90 }; break;
                }
            } else if (grade === 'B') {
                thresholds = { reject: 30, borderline: 50 };
            } else {
                thresholds = { reject: 15, borderline: 30 };
            }

            let decision, reviewScore;
            if (score < thresholds.reject) { decision = 'Reject'; reviewScore = -1; }
            else if (score < thresholds.borderline) { decision = 'Borderline'; reviewScore = 0; }
            else { decision = 'Accept'; reviewScore = 1; }

            const comment = generateComment(decision, reviewer.type);
            
            let improvement = 0, improvementType = '';
            if ((reviewer.type === 'normal' || reviewer.type === 'expert') && decision !== 'Reject') {
                improvement = reviewer.type === 'expert' ? 6 : 3;
                improvementType = ['idea', 'exp', 'write'][Math.floor(Math.random() * 3)];
            }

            return { decision, score: reviewScore, comment, improvement, improvementType };
        }

        function generateComment(decision, type) {
            if (type === 'questions') return 'æˆ‘æœ‰40ä¸ªé—®é¢˜ã€‚';
            const positive = ['åˆ›æ–°æ€§å¼ºï¼Œå®éªŒå……åˆ†', 'å†™ä½œæ¸…æ™°ï¼Œè´¡çŒ®æ˜ç¡®', 'æ–¹æ³•æ–°é¢–ï¼Œç»“æœæœ‰è¯´æœåŠ›', 'å·¥ä½œæ‰å®ï¼Œæœ‰é‡è¦è´¡çŒ®'];
            const negative = ['ç¼ºä¹åˆ›æ–°', 'å†™ä½œä¸è¶³ï¼Œè¡¨è¾¾ä¸æ¸…', 'å®éªŒä¸è¶³ï¼Œç¼ºå°‘å¯¹æ¯”', 'è´¡çŒ®æœ‰é™ï¼Œå¢é‡å·¥ä½œ'];
            const neutral = ['æœ‰ä¸€å®šåˆ›æ–°ä½†å®éªŒå¯åŠ å¼º', 'æƒ³æ³•æœ‰è¶£ä½†å†™ä½œéœ€æ”¹è¿›', 'å·¥ä½œè¿˜å¯ä»¥ä½†ç¼ºå°‘æ·±å…¥åˆ†æ'];
            if (decision === 'Accept') return rand(positive);
            if (decision === 'Reject') return rand(negative);
            return rand([...positive, ...negative, ...neutral]);
        }

        function showReviewResultModal(paper, grade, results, totalScore, acceptType, accepted, slot) {
            let html = `<div style="margin-bottom:15px;">
                <strong>è®ºæ–‡ï¼š</strong>${paper.title}<br>
                <strong>æŠ•ç¨¿ï¼š</strong>${grade}ç±» | <strong>æ€»åˆ†ï¼š</strong>${paper.ideaScore + paper.expScore + paper.writeScore}
            </div><div style="margin-bottom:15px;">`;
            
            results.forEach(r => {
                const color = r.decision === 'Accept' ? 'var(--success-color)' : r.decision === 'Reject' ? 'var(--danger-color)' : 'var(--warning-color)';
                html += `<div style="padding:10px;background:var(--light-bg);border-radius:8px;margin-bottom:8px;">
                    <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
                        <strong>${r.reviewer.name}</strong>
                        <span style="color:${color};font-weight:600;">${r.decision} (${r.score > 0 ? '+' : ''}${r.score})</span>
                    </div>
                    <div style="font-size:0.85rem;color:var(--text-secondary);">"${r.comment}"</div>
                    ${r.improvement > 0 ? `<div style="color:var(--success-color);font-size:0.8rem;margin-top:5px;">
                        ${r.improvementType === 'idea' ? 'Idea' : r.improvementType === 'exp' ? 'å®éªŒ' : 'å†™ä½œ'}åˆ†+${r.improvement}</div>` : ''}
                </div>`;
            });
            html += '</div>';

            if (accepted) {
                const colors = { 'Poster': '#74b9ff', 'Oral': '#fdcb6e', 'Best Paper': '#fd79a8' };
                html += `<div style="text-align:center;padding:15px;background:linear-gradient(135deg,${colors[acceptType]}33,${colors[acceptType]}66);border-radius:12px;">
                    <div style="font-size:2rem;margin-bottom:10px;">ğŸ‰</div>
                    <div style="font-size:1.2rem;font-weight:700;color:${colors[acceptType]};">æ­å–œï¼è®ºæ–‡è¢«æ¥æ”¶ä¸º ${acceptType}ï¼</div>
                    <div style="margin-top:8px;font-size:0.9rem;">æ€»å®¡ç¨¿åˆ†: ${totalScore}</div>
                </div>`;
            } else {
                html += `<div style="text-align:center;padding:15px;background:rgba(225,112,85,0.15);border-radius:12px;">
                    <div style="font-size:2rem;margin-bottom:10px;">ğŸ˜¢</div>
                    <div style="font-size:1.2rem;font-weight:700;color:var(--danger-color);">å¾ˆé—æ†¾ï¼Œè®ºæ–‡è¢«æ‹’ç¨¿äº†</div>
                    <div style="margin-top:8px;font-size:0.9rem;">æ€»å®¡ç¨¿åˆ†: ${totalScore}</div>
                </div>`;
            }

            showModal('ğŸ“ å®¡ç¨¿ç»“æœ', html, [
                { text: 'ç¡®å®š', class: 'btn-primary', action: () => {
                    if (accepted) {
                        handlePaperAccepted(paper, grade, acceptType, slot);
                    } else {
                        gameState.rejectedCount++;
                        paper.reviewing = false;
                        paper.submittedGrade = null;
                        addLog('æ‹’ç¨¿', `è®ºæ–‡"${paper.title.substring(0, 20)}..."è¢«${grade}ç±»ä¼šè®®æ‹’ç¨¿`, 'å¯ä»¥ç»§ç»­ä¿®æ”¹åé‡æŠ•');
                    }
                    closeModal();
                    renderPaperSlots();
                    updateAllUI();
                }}
            ]);
        }

        function handlePaperAccepted(paper, grade, acceptType, slot) {
            const scoreMap = { 'A': 4, 'B': 2, 'C': 1 };
            const sanGain = { 'A': { 'Poster': 6, 'Oral': 8, 'Best Paper': 12 }, 'B': { 'Poster': 3, 'Oral': 4, 'Best Paper': 5 }, 'C': { 'Poster': 2, 'Oral': 2, 'Best Paper': 3 } };
            const favorGain = { 'A': { 'Poster': 2, 'Oral': 3, 'Best Paper': 4 }, 'B': { 'Poster': 1, 'Oral': 1, 'Best Paper': 2 }, 'C': { 'Poster': 0, 'Oral': 0, 'Best Paper': 1 } };

            gameState.san = Math.min(gameState.sanMax, gameState.san + sanGain[grade][acceptType]);
            gameState.favor = Math.min(20, gameState.favor + favorGain[grade][acceptType]);
            gameState.totalScore += scoreMap[grade];

            if (grade === 'A') gameState.paperA++;
            else if (grade === 'B') gameState.paperB++;
            else gameState.paperC++;

            let bonusResearch = 0;
            if (!gameState.firstPaperAccepted) { gameState.firstPaperAccepted = true; bonusResearch++; }
            if (grade === 'A' && !gameState.firstAPaperAccepted) { gameState.firstAPaperAccepted = true; bonusResearch++; }
            gameState.research = Math.min(20, gameState.research + bonusResearch);

            const finalScore = paper.ideaScore + paper.expScore + paper.writeScore;
            gameState.publishedPapers.push({
                title: paper.title, grade, acceptType, score: finalScore, citations: 0, monthsSincePublish: 0
            });

            gameState.papers[slot] = null;

            let result = `SANå€¼+${sanGain[grade][acceptType]}ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦+${favorGain[grade][acceptType]}ï¼Œç§‘ç ”åˆ†+${scoreMap[grade]}`;
            if (bonusResearch > 0) result += `ï¼Œç§‘ç ”èƒ½åŠ›+${bonusResearch}`;
            addLog('è®ºæ–‡ä¸­ç¨¿', `${grade}ç±»è®ºæ–‡è¢«æ¥æ”¶ä¸º${acceptType}`, result);

            checkResearchUnlock();
            setTimeout(() => showConferenceModal(grade), 300);
        }

        // ==================== å¼€ä¼šç³»ç»Ÿ ====================
        function showConferenceModal(grade) {
            showModal('ğŸ“ å¼€ä¼šé€‰æ‹©', '<p>æ­å–œè®ºæ–‡è¢«æ¥æ”¶ï¼éœ€è¦å‚åŠ å­¦æœ¯ä¼šè®®è¿›è¡Œå±•ç¤ºã€‚è¯·é€‰æ‹©å‚ä¼šæ–¹å¼ï¼š</p>', [
                { text: 'ğŸ’° è‡ªå·±å‡ºé’±ï¼ˆé‡‘é’±-4ï¼‰', class: 'btn-warning', action: () => {
                    gameState.gold -= 4;
                    addLog('å¼€ä¼š', 'è‡ªå·±å‡ºé’±å‚åŠ å­¦æœ¯ä¼šè®®', 'é‡‘é’±-4');
                    closeModal();
                    updateAllUI();
                    setTimeout(showConferenceEventModal, 200);
                }},
                { text: 'ğŸ‘¨â€ğŸ« å¯¼å¸ˆæŠ¥é”€ï¼ˆå¥½æ„Ÿåº¦-2ï¼‰', class: 'btn-info', action: () => {
                    gameState.favor -= 2;
                    addLog('å¼€ä¼š', 'å¯¼å¸ˆæŠ¥é”€å‚åŠ å­¦æœ¯ä¼šè®®', 'å¯¼å¸ˆå¥½æ„Ÿåº¦-2');
                    closeModal();
                    updateAllUI();
                    setTimeout(showConferenceEventModal, 200);
                }},
                { text: 'ğŸ‘¥ è¯·äººä»£å‚åŠ ï¼ˆé‡‘é’±-1ï¼‰', class: 'btn-primary', action: () => {
                    gameState.gold -= 1;
                    addLog('å¼€ä¼š', 'è¯·äººä»£ä¸ºå‚åŠ å­¦æœ¯ä¼šè®®', 'é‡‘é’±-1');
                    closeModal();
                    updateAllUI();
                }}
            ]);
        }

        function showConferenceEventModal() {
            let options = [
                { text: 'ğŸ–ï¸ é¡ºä¾¿æ—…æ¸¸', fn: () => { 
                    gameState.san = Math.min(gameState.sanMax, gameState.san + 6); 
                    gameState.tourCount++;
                    return 'SANå€¼+6'; 
                }},
                { text: 'â˜• èŒ¶æ­‡+æ™šå®´', fn: () => { 
                    gameState.san = Math.min(gameState.sanMax, gameState.san + 1); 
                    gameState.social = Math.min(20, gameState.social + 1); 
                    gameState.teaBreakCount++;
                    return 'SANå€¼+1ï¼Œç¤¾äº¤èƒ½åŠ›+1'; 
                }},
                { text: 'ğŸ”¬ åŒè¡Œäº¤æµ', fn: () => { 
                    gameState.buffs.temporary.push({ type: 'exp_times', name: 'ä¸‹æ¬¡åšå®éªŒå¤šåš3æ¬¡', value: 3, permanent: false }); 
                    return 'ä¸´æ—¶buff-ä¸‹æ¬¡åšå®éªŒå¤šåš3æ¬¡'; 
                }},
                { text: 'ğŸ’¡ å¹¿æ³›äº¤æµ', fn: () => { 
                    gameState.buffs.temporary.push({ type: 'idea_times', name: 'ä¸‹æ¬¡æƒ³ideaå¤šæƒ³3æ¬¡', value: 3, permanent: false }); 
                    return 'ä¸´æ—¶buff-ä¸‹æ¬¡æƒ³ideaå¤šæƒ³3æ¬¡'; 
                }},
                { text: 'ğŸŒŸ æ‰¾å¤§ç‰›äº¤æµ', fn: () => { 
                    gameState.buffs.temporary.push({ type: 'idea_bonus', name: 'ä¸‹æ¬¡æƒ³ideaåˆ†æ•°Ã—1.25', value: 1.25, multiply: true, permanent: false }); 
                    gameState.metBigBull = true;
                    return 'ä¸´æ—¶buff-ä¸‹æ¬¡æƒ³ideaåˆ†æ•°Ã—1.25'; 
                }},
                { text: 'ğŸ¢ æ‰¾ä¼ä¸šäº¤æµ', fn: () => { 
                    gameState.buffs.temporary.push({ type: 'exp_bonus', name: 'ä¸‹æ¬¡åšå®éªŒåˆ†æ•°Ã—1.25', value: 1.25, multiply: true, permanent: false }); 
                    return 'ä¸´æ—¶buff-ä¸‹æ¬¡åšå®éªŒåˆ†æ•°Ã—1.25'; 
                }},
                { text: 'ğŸ¤ æ‰¾åŒå­¦åˆä½œ', fn: () => { 
                    gameState.buffs.temporary.push({ type: 'exp_bonus', name: 'ä¸‹æ¬¡åšå®éªŒåˆ†æ•°+5', value: 5, permanent: false }); 
                    return 'ä¸´æ—¶buff-ä¸‹æ¬¡åšå®éªŒåˆ†æ•°+5'; 
                }}
            ];

            // ç¤¾äº¤â‰¥6çš„é€‰é¡¹
            if (gameState.social >= 6) {
                options.push(
                    { text: 'ğŸ“ æ‰¾å¤§ç‰›åˆä½œ', fn: () => { 
                        gameState.buffs.temporary.push({ type: 'write_bonus', name: 'ä¸‹æ¬¡å†™è®ºæ–‡åˆ†æ•°+8', value: 8, permanent: false }); 
                        gameState.social = Math.min(20, gameState.social + 1);
                        gameState.metBigBull = true;
                        return 'ä¸´æ—¶buff-ä¸‹æ¬¡å†™è®ºæ–‡åˆ†æ•°+8ï¼Œç¤¾äº¤èƒ½åŠ›+1'; 
                    }},
                    { text: 'ğŸ’• å’Œå¥½çœ‹çš„å¼‚æ€§å­¦è€…äº¤æµ', fn: () => { 
                        gameState.san = Math.min(gameState.sanMax, gameState.san + 5); 
                        gameState.social = Math.min(20, gameState.social + 1);
                        gameState.metBeautiful = true;
                        gameState.beautifulCount++;
                        return 'SANå€¼+5ï¼Œç¤¾äº¤èƒ½åŠ›+1'; 
                    }},
                    { text: 'ğŸ§  å’Œèªæ…§çš„å¼‚æ€§å­¦è€…äº¤æµ', fn: () => { 
                        gameState.san = Math.min(gameState.sanMax, gameState.san + 1); 
                        gameState.social = Math.min(20, gameState.social + 1);
                        gameState.buffs.temporary.push({ type: 'idea_times', name: 'ä¸‹æ¬¡æƒ³ideaå¤šæƒ³2æ¬¡', value: 2, permanent: false });
                        gameState.metSmart = true;
                        gameState.smartCount++;
                        return 'SANå€¼+1ï¼Œç¤¾äº¤èƒ½åŠ›+1ï¼Œä¸´æ—¶buff-ä¸‹æ¬¡æƒ³ideaå¤šæƒ³2æ¬¡'; 
                    }}
                );
            }

            // æ·±å…¥åˆä½œé€‰é¡¹
            if (gameState.metBigBull && !gameState.bigBullCooperation) {
                options.push({ text: 'ğŸŒŸ å’Œä¸Šæ¬¡é‚£ä¸ªå¤§ç‰›æ·±å…¥åˆä½œ', fn: () => {
                    gameState.buffs.temporary.push({ type: 'write_bonus', name: 'ä¸‹æ¬¡å†™è®ºæ–‡åˆ†æ•°+10', value: 10, permanent: false });
                    gameState.bigBullDeepCount++;
                    if (gameState.research >= 12 && gameState.bigBullDeepCount >= 2) {
                        setTimeout(showBigBullCoopModal, 300);
                    }
                    return 'ä¸´æ—¶buff-ä¸‹æ¬¡å†™è®ºæ–‡åˆ†æ•°+10';
                }});
            }

            if (gameState.metBeautiful && !gameState.hasLover) {
                options.push({ text: 'ğŸ’• å’Œä¸Šæ¬¡é‚£ä¸ªå¥½çœ‹çš„å¼‚æ€§å­¦è€…äº¤æµ', fn: () => {
                    gameState.san = Math.min(gameState.sanMax, gameState.san + 8);
                    gameState.sanMax += 3;
                    gameState.beautifulCount++;
                    if (gameState.social >= 12 && gameState.beautifulCount >= 2) {
                        setTimeout(() => showLoverModal('beautiful'), 300);
                    }
                    return 'SANå€¼+8ï¼ŒSANå€¼ä¸Šé™+3';
                }});
            }

            if (gameState.metSmart && !gameState.hasLover) {
                options.push({ text: 'ğŸ§  å’Œä¸Šæ¬¡é‚£ä¸ªèªæ…§çš„å¼‚æ€§å­¦è€…äº¤æµ', fn: () => {
                    gameState.san = Math.min(gameState.sanMax, gameState.san + 1);
                    gameState.research = Math.min(20, gameState.research + 1);
                    gameState.smartCount++;
                    if (gameState.social >= 12 && gameState.smartCount >= 2) {
                        setTimeout(() => showLoverModal('smart'), 300);
                    }
                    return 'SANå€¼+1ï¼Œç§‘ç ”èƒ½åŠ›+1';
                }});
            }

            const selected = shuffle(options).slice(0, 3);
            showModal('ğŸ‰ å¼€ä¼šäº‹ä»¶', '<p>åœ¨å­¦æœ¯ä¼šè®®ä¸Šï¼Œä½ å¯ä»¥é€‰æ‹©ï¼š</p>', selected.map(opt => ({
                text: opt.text, class: 'btn-primary', action: () => {
                    const result = opt.fn();
                    addLog('å¼€ä¼šäº‹ä»¶', opt.text.replace(/^[^\s]+\s/, ''), result);
                    closeModal();
                    updateAllUI();
                    updateBuffs();
                }
            })));
        }

        function showLoverModal(type) {
            const desc = type === 'beautiful' ? 'ä½ å’Œé‚£ä¸ªå¥½çœ‹çš„å¼‚æ€§å­¦è€…è¶Šæ¥è¶Šç†Ÿæ‚‰äº†' : 'ä½ å’Œé‚£ä¸ªèªæ…§çš„å¼‚æ€§å­¦è€…è¶Šæ¥è¶Šé»˜å¥‘äº†';
            showModal('ğŸ’• å‘å±•å…³ç³»', `<p>${desc}ï¼Œæ˜¯å¦æˆä¸ºæ‹äººï¼Ÿ</p>`, [
                { text: 'è¿˜æ˜¯ç®—äº†', class: 'btn-info', action: closeModal },
                { text: 'â¤ï¸ æˆä¸ºæ‹äºº', class: 'btn-accent', action: () => {
                    gameState.hasLover = true;
                    gameState.loverType = type;
                    if (type === 'beautiful') {
                        gameState.san = gameState.sanMax;
                        gameState.sanMax += 4;
                        addLog('æ‹çˆ±', 'å’Œå¥½çœ‹çš„å¼‚æ€§å­¦è€…æˆä¸ºæ‹äºº', 'SANå€¼å›æ»¡ï¼Œæ¯æœˆSANå€¼+3ï¼ŒSANå€¼ä¸Šé™+4');
                    } else {
                        gameState.san = Math.min(gameState.sanMax, gameState.san + 1);
                        gameState.research = Math.min(20, gameState.research + 1);
                        gameState.buffs.permanent.push(
                            { type: 'idea_times', name: 'æ¯æ¬¡æƒ³ideaå¤šæƒ³1æ¬¡', value: 1, permanent: true },
                            { type: 'exp_times', name: 'æ¯æ¬¡åšå®éªŒå¤šåš1æ¬¡', value: 1, permanent: true },
                            { type: 'write_times', name: 'æ¯æ¬¡å†™è®ºæ–‡å¤šå†™1æ¬¡', value: 1, permanent: true }
                        );
                        addLog('æ‹çˆ±', 'å’Œèªæ…§çš„å¼‚æ€§å­¦è€…æˆä¸ºæ‹äºº', 'SANå€¼+1ï¼Œç§‘ç ”èƒ½åŠ›+1ï¼Œæ°¸ä¹…buff-æ¯æ¬¡æƒ³idea/åšå®éªŒ/å†™è®ºæ–‡å¤šä¸€æ¬¡');
                    }
                    closeModal();
                    updateAllUI();
                    checkResearchUnlock();
                }}
            ]);
        }

        function showBigBullCoopModal() {
            showModal('ğŸŒŸ è”åˆåŸ¹å…»', '<p>å¤§ç‰›å¯¹ä½ çš„ç§‘ç ”èƒ½åŠ›å°è±¡æ·±åˆ»ï¼Œæè®®ä¸ä½ çš„å¯¼å¸ˆè”åˆåŸ¹å…»ä½ ï¼Œæ˜¯å¦æ¥å—ï¼Ÿ</p>', [
                { text: 'å©‰æ‹’', class: 'btn-info', action: closeModal },
                { text: 'âœ¨ æ¥å—è”åˆåŸ¹å…»', class: 'btn-primary', action: () => {
                    gameState.bigBullCooperation = true;
                    gameState.buffs.permanent.push({ type: 'write_bonus', name: 'æ¯æ¬¡å†™è®ºæ–‡åˆ†æ•°+10', value: 10, permanent: true });
                    addLog('è”åˆåŸ¹å…»', 'å¯¼å¸ˆä¸å¤§ç‰›è”åˆåŸ¹å…»', 'æ°¸ä¹…buff-æ¯æ¬¡å†™è®ºæ–‡åˆ†æ•°+10');
                    closeModal();
                    updateBuffs();
                }}
            ]);
        }

        // ==================== å•†åº—ç³»ç»Ÿ ====================
        function openShop() {
            let html = '<div style="display:flex;flex-direction:column;gap:10px;">';
            shopItems.forEach(item => {
                const canBuy = gameState.gold >= item.price && !(item.once && item.bought) && !(item.monthlyOnce && item.boughtThisMonth);
                const reason = gameState.gold < item.price ? 'é‡‘å¸ä¸è¶³' : (item.once && item.bought) ? 'å·²è´­ä¹°' : (item.monthlyOnce && item.boughtThisMonth) ? 'æœ¬æœˆå·²è´­' : '';
                html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--light-bg);border-radius:10px;${!canBuy ? 'opacity:0.6;' : ''}">
                    <div><div style="font-weight:600;">${item.name}</div><div style="font-size:0.85rem;color:var(--text-secondary);">${item.desc}</div></div>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <span style="color:#d68910;font-weight:600;">ğŸ’°${item.price}</span>
                        <button class="btn btn-primary" style="padding:8px 16px;" onclick="buyItem('${item.id}')" ${!canBuy ? 'disabled' : ''}>${reason || 'è´­ä¹°'}</button>
                    </div>
                </div>`;
            });
            html += '</div>';
            showModal('ğŸ›’ å•†åº—', html, [{ text: 'å…³é—­', class: 'btn-info', action: closeModal }]);
        }

        function buyItem(id) {
            const item = shopItems.find(i => i.id === id);
            if (!item || gameState.gold < item.price) return;
            
            gameState.gold -= item.price;
            let result = `é‡‘é’±-${item.price}`;
            
            switch (id) {
                case 'chair':
                    item.bought = true;
                    gameState.buffs.permanent.push({ type: 'monthly_san', name: 'æ¯æœˆSANå€¼+1', value: 1, permanent: true });
                    result += 'ï¼Œè·å¾—æ°¸ä¹…buff-æ¯æœˆSANå€¼+1';
                    break;
                case 'gpu_rent':
                    gameState.buffs.temporary.push({ type: 'exp_times', name: 'ä¸‹æ¬¡åšå®éªŒå¤šåš1æ¬¡', value: 1, permanent: false });
                    result += 'ï¼Œè·å¾—ä¸´æ—¶buff-ä¸‹æ¬¡åšå®éªŒå¤šåš1æ¬¡';
                    break;
                case 'gpu_buy':
                    gameState.buffs.permanent.push({ type: 'exp_times', name: 'æ¯æ¬¡åšå®éªŒå¤šåš1æ¬¡', value: 1, permanent: true });
                    result += 'ï¼Œè·å¾—æ°¸ä¹…buff-æ¯æ¬¡åšå®éªŒå¤šåš1æ¬¡';
                    break;
                case 'keyboard':
                    item.bought = true;
                    gameState.buffs.permanent.push({ type: 'write_san_reduce', name: 'å†™è®ºæ–‡SAN-3', value: 1, permanent: true });
                    result += 'ï¼Œè·å¾—æ°¸ä¹…buff-æ¯æ¬¡å†™è®ºæ–‡å˜ä¸ºSANå€¼-3';
                    break;
                case 'monitor':
                    item.bought = true;
                    gameState.buffs.permanent.push({ type: 'read_san_reduce', name: 'è¯»è®ºæ–‡SAN-1', value: 1, permanent: true });
                    result += 'ï¼Œè·å¾—æ°¸ä¹…buff-è¯»è®ºæ–‡å˜ä¸ºSANå€¼-1';
                    break;
                case 'coffee':
                    item.boughtThisMonth = true;
                    gameState.san = Math.min(gameState.sanMax, gameState.san + 2);
                    result += 'ï¼ŒSANå€¼+2';
                    break;
                case 'polish':
                    item.boughtThisMonth = true;
                    gameState.buffs.temporary.push({ type: 'write_bonus', name: 'ä¸‹æ¬¡è®ºæ–‡å†™ä½œåˆ†æ•°+5', value: 5, permanent: false });
                    result += 'ï¼Œè·å¾—ä¸´æ—¶buff-ä¸‹æ¬¡è®ºæ–‡å†™ä½œåˆ†æ•°+5';
                    break;
            }
            
            addLog('è´­ä¹°', `è´­ä¹°äº†${item.name}`, result);
            closeModal();
            openShop();
            updateAllUI();
            updateBuffs();
        }
        // ==================== éšæœºäº‹ä»¶ç³»ç»Ÿ ====================
        function triggerRandomEvent() {
            // å¥–å­¦é‡‘äº‹ä»¶ - æ¯å¹´ç¬¬1ä¸ªæœˆ
            if (gameState.year >= 2 && gameState.month === 1) {
                triggerScholarshipEvent();
                return;
            }
            // æ•™å¸ˆèŠ‚äº‹ä»¶ - æ¯å¹´ç¬¬2ä¸ªæœˆ
            if (gameState.month === 2) {
                triggerTeachersDayEvent();
                return;
            }
            // éšæœºäº‹ä»¶
            const events = [
                showRandomEvent1, showRandomEvent2, showRandomEvent3, showRandomEvent4,
                showRandomEvent5, showRandomEvent6, showRandomEvent7, showRandomEvent8,
                showRandomEvent9, showRandomEvent10, showRandomEvent12, showRandomEvent13
            ];
            if (gameState.social >= 6) events.push(showRandomEvent11);
            rand(events)();
        }

        function triggerScholarshipEvent() {
            const req = { 2: 1, 3: 3, 4: 6, 5: 9 }[gameState.year] || 9;
            const reward = { 2: 5, 3: 5, 4: 10, 5: 10 }[gameState.year] || 10;
            if (gameState.totalScore >= req) {
                gameState.gold += reward;
                showModal('ğŸ“ å¥–å­¦é‡‘', `<p>æ­å–œï¼ä½ çš„ç§‘ç ”åˆ†è¾¾åˆ°${gameState.totalScore}åˆ†ï¼Œæ»¡è¶³æœ¬å¹´åº¦å¥–å­¦é‡‘è¦æ±‚ï¼ˆâ‰¥${req}åˆ†ï¼‰ï¼Œè·å¾—å¥–å­¦é‡‘${reward}é‡‘å¸ï¼</p>`,
                    [{ text: 'å¤ªæ£’äº†ï¼', class: 'btn-primary', action: () => {
                        addLog('å¥–å­¦é‡‘', `ç¬¬${gameState.year}å¹´å¥–å­¦é‡‘`, `ç§‘ç ”åˆ†${gameState.totalScore}â‰¥${req}ï¼Œé‡‘é’±+${reward}`);
                        closeModal(); updateAllUI();
                    }}]);
            } else {
                showModal('ğŸ“ å¥–å­¦é‡‘', `<p>é—æ†¾è½é€‰ï¼æœ¬å¹´åº¦å¥–å­¦é‡‘è¦æ±‚ç§‘ç ”åˆ†â‰¥${req}ï¼Œä½ ç›®å‰${gameState.totalScore}åˆ†ã€‚</p>`,
                    [{ text: 'ç»§ç»­åŠªåŠ›', class: 'btn-info', action: () => {
                        addLog('å¥–å­¦é‡‘', `ç¬¬${gameState.year}å¹´å¥–å­¦é‡‘`, `ç§‘ç ”åˆ†${gameState.totalScore}<${req}ï¼Œé—æ†¾è½é€‰`);
                        closeModal();
                    }}]);
            }
        }

        function triggerTeachersDayEvent() {
            showModal('ğŸ æ•™å¸ˆèŠ‚', '<p>æ•™å¸ˆèŠ‚åˆ°äº†ï¼Œä½ å‡†å¤‡é€å¯¼å¸ˆä»€ä¹ˆç¤¼ç‰©ï¼Ÿ</p>', [
                { text: 'ä»€ä¹ˆä¹Ÿä¸é€', class: 'btn-info', action: () => {
                    gameState.favor = Math.max(-20, gameState.favor - 1);
                    addLog('æ•™å¸ˆèŠ‚', 'ä»€ä¹ˆä¹Ÿä¸é€', 'å¯¼å¸ˆå¯¹ä½ ç•¥æœ‰ä¸æ»¡ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦-1');
                    closeModal(); updateAllUI(); checkGameOver();
                }},
                { text: 'ğŸµ èµ é€èŒ¶å¶ï¼ˆ1é‡‘ï¼‰', class: 'btn-primary', action: () => {
                    if (gameState.gold < 1) { showModal('æç¤º', '<p>é‡‘å¸ä¸è¶³ï¼</p>', [{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]); return; }
                    gameState.gold -= 1; gameState.favor = Math.min(20, gameState.favor + 1);
                    addLog('æ•™å¸ˆèŠ‚', 'èµ é€èŒ¶å¶', 'é‡‘é’±-1ï¼Œå¯¼å¸ˆå¼€å¿ƒæ”¶ä¸‹èŒ¶å¶ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦+1');
                    closeModal(); updateAllUI();
                }},
                { text: 'ğŸ“® èµ é€é‚®ç¥¨ï¼ˆ3é‡‘ï¼‰', class: 'btn-warning', action: () => {
                    if (gameState.gold < 3) { showModal('æç¤º', '<p>é‡‘å¸ä¸è¶³ï¼</p>', [{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]); return; }
                    gameState.gold -= 3; gameState.favor = Math.min(20, gameState.favor + 2);
                    addLog('æ•™å¸ˆèŠ‚', 'èµ é€é‚®ç¥¨', 'é‡‘é’±-3ï¼Œå¯¼å¸ˆå¼€å¿ƒæ”¶ä¸‹é‚®ç¥¨å¹¶ç‚¹äº†ç‚¹å¤´ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦+2');
                    closeModal(); updateAllUI();
                }}
            ]);
        }

        function showRandomEvent1() {
            showModal('ğŸ“š éšæœºäº‹ä»¶', '<p>å¯¼å¸ˆæ´¾ä½ æŒ‡å¯¼æœ¬ç§‘ç”Ÿæ¯•è®¾ã€‚</p>', [
                { text: 'æ®‹å¿æ‹’ç»', class: 'btn-danger', action: () => {
                    gameState.favor = Math.max(-20, gameState.favor - 1);
                    addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæ´¾ä½ æŒ‡å¯¼æœ¬ç§‘ç”Ÿæ¯•è®¾ - æ®‹å¿æ‹’ç»', 'å¯¼å¸ˆå¯¹ä½ ç•¥æœ‰ä¸æ»¡ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦-1');
                    closeModal(); updateAllUI(); checkGameOver();
                }},
                { text: 'äº²åŠ›äº²ä¸º', class: 'btn-primary', action: () => {
                    gameState.san -= 3;
                    if (Math.random() < 0.5) {
                        gameState.research = Math.min(20, gameState.research + 1);
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæ´¾ä½ æŒ‡å¯¼æœ¬ç§‘ç”Ÿæ¯•è®¾ - äº²åŠ›äº²ä¸º', 'æœ¬ç§‘ç”Ÿé¡ºåˆ©æ¯•ä¸šï¼Œåæˆä¸ºä½ çš„å¸ˆå¼Ÿå¸ˆå¦¹å¸®åŠ©ä½ ç§‘ç ”æ‰“ä¸‹æ‰‹ï¼ŒSANå€¼-3ï¼Œç§‘ç ”èƒ½åŠ›+1');
                        checkResearchUnlock();
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæ´¾ä½ æŒ‡å¯¼æœ¬ç§‘ç”Ÿæ¯•è®¾ - äº²åŠ›äº²ä¸º', 'æœ¬ç§‘ç”Ÿé¡ºåˆ©æ¯•ä¸šï¼ŒSANå€¼-3');
                    }
                    closeModal(); updateAllUI(); checkGameOver();
                }},
                { text: 'è®©å¸ˆå¼Ÿå¸ˆå¦¹å»æŒ‡å¯¼', class: 'btn-info', action: () => {
                    if (gameState.social < 6) {
                        gameState.social = Math.max(0, gameState.social - 1);
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæ´¾ä½ æŒ‡å¯¼æœ¬ç§‘ç”Ÿæ¯•è®¾ - è®©å¸ˆå¼Ÿå¸ˆå¦¹å»æŒ‡å¯¼', 'å¸ˆå¼Ÿå¸ˆå¦¹å¯¹ä½ é¢‡æœ‰å¾®è¯ï¼Œç¤¾äº¤èƒ½åŠ›-1');
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæ´¾ä½ æŒ‡å¯¼æœ¬ç§‘ç”Ÿæ¯•è®¾ - è®©å¸ˆå¼Ÿå¸ˆå¦¹å»æŒ‡å¯¼', 'å¸ˆå¼Ÿå¸ˆå¦¹æˆåŠŸä¸ºä½ åˆ†å¿§');
                    }
                    closeModal(); updateAllUI(); checkGameOver();
                }}
            ]);
        }

        function showRandomEvent2() {
            showModal('ğŸ“ éšæœºäº‹ä»¶', '<p>å¯¼å¸ˆè®©ä½ å¸®ä»–å®¡ç¨¿ã€‚</p>', [
                { text: 'ä»¥æ²¡æ—¶é—´ä¸ºç”±æ‹’ç»', class: 'btn-danger', action: () => {
                    gameState.favor = Math.max(-20, gameState.favor - 1);
                    addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆè®©ä½ å¸®ä»–å®¡ç¨¿ - ä»¥æ²¡æ—¶é—´ä¸ºç”±æ‹’ç»', 'å¯¼å¸ˆå¯¹ä½ ç•¥æœ‰ä¸æ»¡ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦-1');
                    closeModal(); updateAllUI(); checkGameOver();
                }},
                { text: 'è®¤çœŸå®¡ç¨¿', class: 'btn-primary', action: () => {
                    gameState.san -= 2;
                    if (Math.random() < 0.5) {
                        gameState.buffs.temporary.push({ type: 'idea_bonus', name: 'ä¸‹æ¬¡æƒ³ideaåˆ†æ•°+4', value: 4, permanent: false });
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆè®©ä½ å¸®ä»–å®¡ç¨¿ - è®¤çœŸå®¡ç¨¿', 'å¾—åˆ°äº†å¯å‘ï¼ŒSANå€¼-2ï¼Œä¸´æ—¶buff-ä¸‹æ¬¡æƒ³ideaåˆ†æ•°+4');
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆè®©ä½ å¸®ä»–å®¡ç¨¿ - è®¤çœŸå®¡ç¨¿', 'æ— äº‹å‘ç”Ÿï¼ŒSANå€¼-2');
                    }
                    closeModal(); updateAllUI(); updateBuffs(); checkGameOver();
                }},
                { text: 'äº¤ç»™å¸ˆå¼Ÿå¸ˆå¦¹', class: 'btn-info', action: () => {
                    if (gameState.social < 6) {
                        gameState.social = Math.max(0, gameState.social - 1);
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆè®©ä½ å¸®ä»–å®¡ç¨¿ - äº¤ç»™å¸ˆå¼Ÿå¸ˆå¦¹', 'å¸ˆå¼Ÿå¸ˆå¦¹å¯¹ä½ é¢‡æœ‰å¾®è¯ï¼Œç¤¾äº¤èƒ½åŠ›-1');
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆè®©ä½ å¸®ä»–å®¡ç¨¿ - äº¤ç»™å¸ˆå¼Ÿå¸ˆå¦¹', 'å¸ˆå¼Ÿå¸ˆå¦¹æˆåŠŸä¸ºä½ åˆ†å¿§');
                    }
                    closeModal(); updateAllUI(); checkGameOver();
                }}
            ]);
        }

        function showRandomEvent3() {
            showModal('ğŸ¤§ éšæœºäº‹ä»¶', '<p>çªç„¶æ„Ÿå†’äº†ã€‚</p>', [
                { text: 'å¼ºæ’‘', class: 'btn-danger', action: () => {
                    if (Math.random() < 0.5) {
                        gameState.san -= 8;
                        addLog('éšæœºäº‹ä»¶', 'çªç„¶æ„Ÿå†’äº† - å¼ºæ’‘', 'èº«ä½“é€æ”¯äº†ï¼ŒSANå€¼-8');
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'çªç„¶æ„Ÿå†’äº† - å¼ºæ’‘', 'æ’‘è¿‡å»äº†ï¼Œå¹´è½»äººèº«ä½“å¥½');
                    }
                    closeModal(); updateAllUI(); checkGameOver();
                }},
                { text: 'è‡ªå·±ä¹°æ„Ÿå†’è¯', class: 'btn-primary', action: () => {
                    gameState.gold -= 2;
                    addLog('éšæœºäº‹ä»¶', 'çªç„¶æ„Ÿå†’äº† - è‡ªå·±ä¹°æ„Ÿå†’è¯', 'å–999æ„Ÿå†’çµå¥½äº†ï¼Œé‡‘é’±-2');
                    closeModal(); updateAllUI(); checkGameOver();
                }},
                { text: 'å»åŒ»é™¢çœ‹ç—…', class: 'btn-info', action: () => {
                    gameState.gold -= 4;
                    gameState.san = Math.min(gameState.sanMax, gameState.san + 2);
                    addLog('éšæœºäº‹ä»¶', 'çªç„¶æ„Ÿå†’äº† - å»åŒ»é™¢çœ‹ç—…', 'åŒ»ç”Ÿå¦™æ‰‹å›æ˜¥ï¼Œä½ æ¯”ç”Ÿç—…å‰è¿˜ç²¾ç¥ï¼ŒSANå€¼+2ï¼Œé‡‘é’±-4');
                    closeModal(); updateAllUI(); checkGameOver();
                }}
            ]);
        }

        function showRandomEvent4() {
            showModal('ğŸ’¼ éšæœºäº‹ä»¶', '<p>å¯¼å¸ˆå®‰æ’ä½ åšé¡¹ç›®ã€‚</p>', [
                { text: 'æ¨ªå‘é¡¹ç›®', class: 'btn-warning', action: () => {
                    gameState.san -= 7; gameState.favor = Math.min(20, gameState.favor + 1); gameState.gold += 5;
                    addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆå®‰æ’ä½ åšé¡¹ç›® - æ¨ªå‘é¡¹ç›®', 'æˆåŠŸç»“é¡¹ï¼ŒSANå€¼-7ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦+1ï¼Œé‡‘é’±+5');
                    closeModal(); updateAllUI(); checkGameOver();
                }},
                { text: 'çºµå‘é¡¹ç›®', class: 'btn-primary', action: () => {
                    gameState.san -= 5; gameState.favor = Math.min(20, gameState.favor + 1); gameState.research = Math.min(20, gameState.research + 1);
                    addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆå®‰æ’ä½ åšé¡¹ç›® - çºµå‘é¡¹ç›®', 'æˆåŠŸç»“é¡¹ï¼ŒSANå€¼-5ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦+1ï¼Œç§‘ç ”èƒ½åŠ›+1');
                    closeModal(); updateAllUI(); checkResearchUnlock(); checkGameOver();
                }},
                { text: 'æ‹’ç»é¡¹ç›®', class: 'btn-danger', action: () => {
                    if (gameState.research < 6) {
                        gameState.favor = Math.max(-20, gameState.favor - 2);
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆå®‰æ’ä½ åšé¡¹ç›® - æ‹’ç»é¡¹ç›®', 'å¯¼å¸ˆå¯¹ä½ æ¯”è¾ƒä¸æ»¡ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦-2');
                    } else if (gameState.research < 12) {
                        gameState.favor = Math.max(-20, gameState.favor - 1);
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆå®‰æ’ä½ åšé¡¹ç›® - æ‹’ç»é¡¹ç›®', 'å¯¼å¸ˆå¯¹ä½ ç•¥ä¸ºä¸æ»¡ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦-1');
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆå®‰æ’ä½ åšé¡¹ç›® - æ‹’ç»é¡¹ç›®', 'å¯¼å¸ˆè®©ä½ ä»¥ç§‘ç ”ä¸ºé‡');
                    }
                    closeModal(); updateAllUI(); checkGameOver();
                }},
                { text: 'è®©å¸ˆå¼Ÿå¸ˆå¦¹åˆ†æ‹…ä¸€éƒ¨åˆ†', class: 'btn-info', action: () => {
                    if (gameState.social < 6) {
                        gameState.san -= 2; gameState.social = Math.max(0, gameState.social - 1);
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆå®‰æ’ä½ åšé¡¹ç›® - è®©å¸ˆå¼Ÿå¸ˆå¦¹åˆ†æ‹…ä¸€éƒ¨åˆ†', 'å¸ˆå¼Ÿå¸ˆå¦¹å¯¹ä½ é¢‡æœ‰å¾®è¯ï¼ŒSANå€¼-2ï¼Œç¤¾äº¤èƒ½åŠ›-1');
                    } else if (gameState.social < 12) {
                        gameState.san -= 2;
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆå®‰æ’ä½ åšé¡¹ç›® - è®©å¸ˆå¼Ÿå¸ˆå¦¹åˆ†æ‹…ä¸€éƒ¨åˆ†', 'å¸ˆå¼Ÿå¸ˆå¦¹æˆåŠŸä¸ºä½ åˆ†å¿§ï¼ŒSANå€¼-2');
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆå®‰æ’ä½ åšé¡¹ç›® - è®©å¸ˆå¼Ÿå¸ˆå¦¹åˆ†æ‹…ä¸€éƒ¨åˆ†', 'å¸ˆå¼Ÿå¸ˆå¦¹ä¸»åŠ¨å…¨åŒ…äº†');
                    }
                    closeModal(); updateAllUI(); checkGameOver();
                }}
            ]);
        }

        function showRandomEvent5() {
            showModal('ğŸ’¬ éšæœºäº‹ä»¶', '<p>å¯¼å¸ˆæ‰¾ä½ è°ˆè¯ã€‚</p>', [
                { text: 'è®¤çœŸå‡†å¤‡ç§‘ç ”è¿›å±•', class: 'btn-primary', action: () => {
                    if (Math.random() < 0.5) {
                        gameState.buffs.temporary.push({ type: 'idea_bonus', name: 'ä¸‹æ¬¡æƒ³ideaåˆ†æ•°+5', value: 5, permanent: false });
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæ‰¾ä½ è°ˆè¯ - è®¤çœŸå‡†å¤‡ç§‘ç ”è¿›å±•', 'å¯¼å¸ˆæŒ‡å‡ºä½ å…³é”®é”™è¯¯ï¼Œä¸´æ—¶buff-ä¸‹æ¬¡æƒ³ideaåˆ†æ•°+5');
                        updateBuffs();
                    } else {
                        gameState.favor = Math.max(-20, gameState.favor - 1);
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæ‰¾ä½ è°ˆè¯ - è®¤çœŸå‡†å¤‡ç§‘ç ”è¿›å±•', 'å¯¼å¸ˆå‘ç°ä½ åœ¨æ‘¸é±¼ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦-1');
                    }
                    closeModal(); updateAllUI(); checkGameOver();
                }},
                { text: 'å‘å¯¼å¸ˆè¯¢é—®å¦‚ä½•ç§‘ç ”', class: 'btn-info', action: () => {
                    if (gameState.favor < 6) {
                        gameState.favor = Math.max(-20, gameState.favor - 1);
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæ‰¾ä½ è°ˆè¯ - å‘å¯¼å¸ˆè¯¢é—®å¦‚ä½•ç§‘ç ”', 'å¯¼å¸ˆè§‰å¾—ä½ å¤©èµ„æ„šç¬¨ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦-1');
                    } else {
                        gameState.research = Math.min(20, gameState.research + 1);
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæ‰¾ä½ è°ˆè¯ - å‘å¯¼å¸ˆè¯¢é—®å¦‚ä½•ç§‘ç ”', 'å¯¼å¸ˆä¼ æˆä½ ç§‘ç ”ç§˜è¯€ï¼Œç§‘ç ”èƒ½åŠ›+1');
                        checkResearchUnlock();
                    }
                    closeModal(); updateAllUI(); checkGameOver();
                }},
                { text: 'å‘Šè¯‰å¯¼å¸ˆæƒ³è¦å»å®ä¹ ', class: 'btn-warning', action: () => {
                    if (gameState.favor >= 6) {
                        gameState.san -= 6; gameState.gold += 5;
                        gameState.buffs.temporary.push({ type: 'exp_bonus', name: 'ä¸‹æ¬¡åšå®éªŒåˆ†æ•°+5', value: 5, permanent: false });
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæ‰¾ä½ è°ˆè¯ - å‘Šè¯‰å¯¼å¸ˆæƒ³è¦å»å®ä¹ ', 'å¯¼å¸ˆå±…ç„¶åŒæ„äº†ä½†è¦å…¼é¡¾ç§‘ç ”ï¼ŒSANå€¼-6ï¼Œä¸´æ—¶buff-ä¸‹æ¬¡åšå®éªŒåˆ†æ•°+5ï¼Œé‡‘é’±+5');
                        updateBuffs();
                    } else {
                        gameState.favor = Math.max(-20, gameState.favor - 1);
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæ‰¾ä½ è°ˆè¯ - å‘Šè¯‰å¯¼å¸ˆæƒ³è¦å»å®ä¹ ', 'å¯¼å¸ˆæœç„¶æ‹’ç»äº†ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦-1');
                    }
                    closeModal(); updateAllUI(); checkGameOver();
                }}
            ]);
        }

        function showRandomEvent6() {
            showModal('ğŸ“Š éšæœºäº‹ä»¶', '<p>å®éªŒå®¤å¬å¼€ç»„ä¼šã€‚</p>', [
                { text: 'è®²è§£ä¸€ç¯‡æ·±å¥¥è®ºæ–‡', class: 'btn-primary', action: () => {
                    if (gameState.research < 6) {
                        gameState.favor = Math.max(-20, gameState.favor - 1);
                        addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤å¬å¼€ç»„ä¼š - è®²è§£ä¸€ç¯‡æ·±å¥¥è®ºæ–‡', 'å¯¼å¸ˆå‘ç°ä½ ä¸æ‡‚è£…æ‡‚ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦-1');
                    } else {
                        gameState.favor = Math.min(20, gameState.favor + 1);
                        addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤å¬å¼€ç»„ä¼š - è®²è§£ä¸€ç¯‡æ·±å¥¥è®ºæ–‡', 'å¯¼å¸ˆå¤¸èµäº†ä½ çš„è§è§£ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦+1');
                    }
                    closeModal(); updateAllUI(); checkGameOver();
                }},
                { text: 'è®²è§£ç³»åˆ—è®ºæ–‡', class: 'btn-warning', action: () => {
                    gameState.san -= 3;
                    if (Math.random() < 0.5) {
                        gameState.favor = Math.min(20, gameState.favor + 2);
                        addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤å¬å¼€ç»„ä¼š - è®²è§£ç³»åˆ—è®ºæ–‡', 'è™½ç„¶å¾ˆè¾›è‹¦ä½†å¯¼å¸ˆå¤§åŠ›å¤¸èµäº†ä½ çš„è§è§£ï¼ŒSANå€¼-3ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦+2');
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤å¬å¼€ç»„ä¼š - è®²è§£ç³»åˆ—è®ºæ–‡', 'è™½ç„¶å¾ˆè¾›è‹¦ä½†å¯¼å¸ˆæ²¡æ¥å‚ä¼šï¼ŒSANå€¼-3');
                    }
                    closeModal(); updateAllUI(); checkGameOver();
                }},
                { text: 'å·å·æ°´è¿‡å»', class: 'btn-info', action: () => {
                    if (Math.random() < 0.5) {
                        gameState.favor = Math.max(-20, gameState.favor - 1);
                        addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤å¬å¼€ç»„ä¼š - å·å·æ°´è¿‡å»', 'å¯¼å¸ˆå¯¹ä½ ç•¥æœ‰ä¸æ»¡ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦-1');
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤å¬å¼€ç»„ä¼š - å·å·æ°´è¿‡å»', 'å¯¼å¸ˆæ°å¥½æ²¡æ¥');
                    }
                    closeModal(); updateAllUI(); checkGameOver();
                }}
            ]);
        }

        function showRandomEvent7() {
            showModal('ğŸ‰ éšæœºäº‹ä»¶', '<p>å®éªŒå®¤ç»„ç»‡å›¢å»ºã€‚</p>', [
                { text: 'ğŸ¸ æ‰“ç¾½æ¯›çƒ', class: 'btn-primary', action: () => {
                    gameState.san = Math.min(gameState.sanMax, gameState.san + 2);
                    addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤ç»„ç»‡å›¢å»º - æ‰“ç¾½æ¯›çƒ', 'è„–å­å’Œæ‰‹è‡‚å¾—åˆ°äº†å¼ºåŒ–ï¼ŒSANå€¼+2');
                    closeModal(); updateAllUI();
                }},
                { text: 'ğŸƒ æ‰“å¾·å·æ‰‘å…‹', class: 'btn-warning', action: () => {
                    if (Math.random() < 0.5) {
                        gameState.gold -= 5;
                        addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤ç»„ç»‡å›¢å»º - æ‰“å¾·å·æ‰‘å…‹', 'è¾“äº†ï¼Œé‡‘é’±-5');
                    } else {
                        gameState.gold += 5;
                        addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤ç»„ç»‡å›¢å»º - æ‰“å¾·å·æ‰‘å…‹', 'èµ¢äº†ï¼Œé‡‘é’±+5');
                    }
                    closeModal(); updateAllUI(); checkGameOver();
                }},
                { text: 'ğŸ¤ KTVå”±æ­Œ', class: 'btn-accent', action: () => {
                    gameState.social = Math.min(20, gameState.social + 1);
                    addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤ç»„ç»‡å›¢å»º - KTVå”±æ­Œ', 'å”±äº†çŒªçŒªä¾ ä¸»é¢˜æ›²ï¼Œèªæ˜å‹‡æ•¢æœ‰åŠ›æ°”ï¼Œç¤¾äº¤èƒ½åŠ›+1');
                    closeModal(); updateAllUI();
                }},
                { text: 'ğŸœ èšé¤', class: 'btn-info', action: () => {
                    if (Math.random() < 0.5) {
                        gameState.gold -= 3; gameState.san = Math.min(gameState.sanMax, gameState.san + 5);
                        addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤ç»„ç»‡å›¢å»º - èšé¤', 'åƒé¥±äº†ï¼Œé‡‘é’±-3ï¼ŒSANå€¼+5');
                    } else {
                        gameState.san = Math.min(gameState.sanMax, gameState.san + 5);
                        addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤ç»„ç»‡å›¢å»º - èšé¤', 'å¯¼å¸ˆè¯·å®¢ï¼ŒSANå€¼+5');
                    }
                    closeModal(); updateAllUI(); checkGameOver();
                }}
            ]);
        }

        function showRandomEvent8() {
            showModal('ğŸ’° éšæœºäº‹ä»¶', '<p>å¯¼å¸ˆç§‘ç ”ç»è´¹å……è¶³ï¼Œä½ å»ºè®®ã€‚</p>', [
                { text: 'ğŸ–¥ï¸ è´­ä¹°é«˜æ€§èƒ½GPUæœåŠ¡å™¨', class: 'btn-primary', action: () => {
                    if (Math.random() < 0.5) {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆç§‘ç ”ç»è´¹å……è¶³ - è´­ä¹°é«˜æ€§èƒ½GPUæœåŠ¡å™¨', 'å¯¼å¸ˆå¹¶ä¸æƒ³ä¹°');
                    } else {
                        gameState.buffs.permanent.push({ type: 'exp_times', name: 'æ¯æ¬¡åšå®éªŒå¤šåšä¸€æ¬¡', value: 1, permanent: true });
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆç§‘ç ”ç»è´¹å……è¶³ - è´­ä¹°é«˜æ€§èƒ½GPUæœåŠ¡å™¨', 'ä½ åªåˆ†åˆ°äº†ä¸€å¼ æ˜¾å¡ï¼Œä½†æ€»æ¯”æ²¡æœ‰å¥½ï¼Œæ°¸ä¹…buff-æ¯æ¬¡åšå®éªŒå¤šåšä¸€æ¬¡');
                        updateBuffs();
                    }
                    closeModal(); updateAllUI();
                }},
                { text: 'ğŸ’µ å¤šå‘åŠ³åŠ¡è´¹', class: 'btn-warning', action: () => {
                    const amount = gameState.favor < 6 ? 2 : gameState.favor < 12 ? 4 : 8;
                    const desc = gameState.favor < 6 ? 'å¯¼å¸ˆåªå‘äº†ä¸€ç‚¹ç‚¹' : gameState.favor < 12 ? 'å¯¼å¸ˆå‘äº†å¾ˆå¤š' : 'å¯¼å¸ˆå…¨ç»™ä½ äº†';
                    gameState.gold += amount;
                    addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆç§‘ç ”ç»è´¹å……è¶³ - å¤šå‘åŠ³åŠ¡è´¹', `${desc}ï¼Œé‡‘é’±+${amount}`);
                    closeModal(); updateAllUI();
                }},
                { text: 'ğŸª‘ è£…ä¿®å­¦ç”Ÿå·¥ä½', class: 'btn-info', action: () => {
                    gameState.buffs.permanent.push(
                        { type: 'idea_bonus', name: 'æ¯æ¬¡æƒ³ideaåˆ†æ•°+1', value: 1, permanent: true },
                        { type: 'write_bonus', name: 'æ¯æ¬¡å†™è®ºæ–‡åˆ†æ•°+1', value: 1, permanent: true }
                    );
                    addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆç§‘ç ”ç»è´¹å……è¶³ - è£…ä¿®å­¦ç”Ÿå·¥ä½', 'éå¸¸èˆ’é€‚ï¼Œæ°¸ä¹…buff-æ¯æ¬¡æƒ³ideaåˆ†æ•°+1ï¼Œæ°¸ä¹…buff-æ¯æ¬¡å†™è®ºæ–‡åˆ†æ•°+1');
                    closeModal(); updateAllUI(); updateBuffs();
                }}
            ]);
        }

        function showRandomEvent9() {
            showModal('ğŸ“– éšæœºäº‹ä»¶', '<p>ä½ æ‰“ç®—å­¦ç‚¹æ–°çŸ¥è¯†ï¼Œä½ ä¼šé€‰æ‹©ã€‚</p>', [
                { text: 'ğŸ“š åŸºç¡€çŸ¥è¯†', class: 'btn-primary', action: () => {
                    if (gameState.research < 4) {
                        gameState.research = Math.min(20, gameState.research + 1);
                        addLog('éšæœºäº‹ä»¶', 'å­¦ä¹ æ–°çŸ¥è¯† - åŸºç¡€çŸ¥è¯†', 'æ‰“å¥½äº†åŸºç¡€ï¼Œç§‘ç ”èƒ½åŠ›+1');
                        checkResearchUnlock();
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'å­¦ä¹ æ–°çŸ¥è¯† - åŸºç¡€çŸ¥è¯†', 'å¯¹ä½ æ²¡æœ‰ä»€ä¹ˆå¸®åŠ©');
                    }
                    closeModal(); updateAllUI();
                }},
                { text: 'ğŸ’» ä»£ç çŸ¥è¯†', class: 'btn-info', action: () => {
                    gameState.buffs.permanent.push({ type: 'exp_bonus', name: 'æ¯æ¬¡åšå®éªŒåˆ†æ•°+1', value: 1, permanent: true });
                    addLog('éšæœºäº‹ä»¶', 'å­¦ä¹ æ–°çŸ¥è¯† - ä»£ç çŸ¥è¯†', 'æ°¸ä¹…buff-æ¯æ¬¡åšå®éªŒåˆ†æ•°+1');
                    closeModal(); updateAllUI(); updateBuffs();
                }},
                { text: 'ğŸš€ æœ€æ–°æŠ€æœ¯', class: 'btn-warning', action: () => {
                    gameState.buffs.permanent.push({ type: 'idea_bonus', name: 'æ¯æ¬¡æƒ³ideaåˆ†æ•°+1', value: 1, permanent: true });
                    addLog('éšæœºäº‹ä»¶', 'å­¦ä¹ æ–°çŸ¥è¯† - æœ€æ–°æŠ€æœ¯', 'æ°¸ä¹…buff-æ¯æ¬¡æƒ³ideaåˆ†æ•°+1');
                    closeModal(); updateAllUI(); updateBuffs();
                }},
                { text: 'ğŸ”® çœ‹èµ·æ¥å¾ˆæ·±å¥¥çš„çŸ¥è¯†', class: 'btn-accent', action: () => {
                    gameState.buffs.permanent.push({ type: 'write_bonus', name: 'æ¯æ¬¡å†™è®ºæ–‡åˆ†æ•°+1', value: 1, permanent: true });
                    addLog('éšæœºäº‹ä»¶', 'å­¦ä¹ æ–°çŸ¥è¯† - çœ‹èµ·æ¥å¾ˆæ·±å¥¥çš„çŸ¥è¯†', 'æ°¸ä¹…buff-æ¯æ¬¡å†™è®ºæ–‡åˆ†æ•°+1');
                    closeModal(); updateAllUI(); updateBuffs();
                }}
            ]);
        }

        function showRandomEvent10() {
            showModal('ğŸ¤ éšæœºäº‹ä»¶', '<p>åŒé—¨æ‰¾ä½ åˆä½œè®ºæ–‡ï¼Œä½ ä¼šé€‰æ‹©ã€‚</p>', [
                { text: 'å­¦æœ¯äº¤æµ', class: 'btn-primary', action: () => {
                    if (Math.random() < 0.5) {
                        gameState.buffs.temporary.push({ type: 'idea_bonus', name: 'ä¸‹æ¬¡æƒ³ideaåˆ†æ•°Ã—0.5', value: 0.5, multiply: true, permanent: false });
                        addLog('éšæœºäº‹ä»¶', 'åŒé—¨æ‰¾ä½ åˆä½œè®ºæ–‡ - å­¦æœ¯äº¤æµ', 'è¢«åŒé—¨å·èµ°ideaï¼Œä¸´æ—¶buff-ä¸‹æ¬¡æƒ³ideaåˆ†æ•°Ã—0.5');
                    } else {
                        gameState.buffs.temporary.push({ type: 'idea_bonus', name: 'ä¸‹æ¬¡æƒ³ideaåˆ†æ•°+5', value: 5, permanent: false });
                        addLog('éšæœºäº‹ä»¶', 'åŒé—¨æ‰¾ä½ åˆä½œè®ºæ–‡ - å­¦æœ¯äº¤æµ', 'å…±åŒè¿›æ­¥ï¼Œä¸´æ—¶buff-ä¸‹æ¬¡æƒ³ideaåˆ†æ•°+5');
                    }
                    closeModal(); updateAllUI(); updateBuffs();
                }},
                { text: 'çº¦å®šäº’æŒ‚è®ºæ–‡', class: 'btn-warning', action: () => {
                    if (Math.random() < 0.5) {
                        gameState.buffs.temporary.push({ type: 'citation_multiply', name: 'ä¸‹ä¸€ç¯‡ä¸­ç¨¿è®ºæ–‡å¼•ç”¨æ•°Ã—2', value: 2, permanent: false });
                        addLog('éšæœºäº‹ä»¶', 'åŒé—¨æ‰¾ä½ åˆä½œè®ºæ–‡ - çº¦å®šäº’æŒ‚è®ºæ–‡', 'ä½ ä»¬ä¸€èµ·ä¸­äº†è®ºæ–‡ï¼Œ1å˜æˆ2ï¼Œä¸´æ—¶buff-ä¸‹ä¸€ç¯‡ä¸­ç¨¿çš„è®ºæ–‡å¼•ç”¨æ•°Ã—2');
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'åŒé—¨æ‰¾ä½ åˆä½œè®ºæ–‡ - çº¦å®šäº’æŒ‚è®ºæ–‡', 'åŒé—¨å¤ªèœäº†ï¼Œä¸€ç›´æ²¡ä¸­è®ºæ–‡');
                    }
                    closeModal(); updateAllUI(); updateBuffs();
                }},
                { text: 'å©‰æ‹’åˆä½œ', class: 'btn-info', action: () => {
                    addLog('éšæœºäº‹ä»¶', 'åŒé—¨æ‰¾ä½ åˆä½œè®ºæ–‡ - å©‰æ‹’åˆä½œ', 'æ— äº‹å‘ç”Ÿ');
                    closeModal();
                }},
                { text: 'å¼€å±•å…¨é¢åˆä½œ', class: 'btn-success', action: () => {
                    if (gameState.social < 6) {
                        addLog('éšæœºäº‹ä»¶', 'åŒé—¨æ‰¾ä½ åˆä½œè®ºæ–‡ - å¼€å±•å…¨é¢åˆä½œ', 'åˆä½œå¤±è´¥');
                    } else if (gameState.social < 12) {
                        gameState.buffs.temporary.push({ type: 'idea_times', name: 'ä¸‹æ¬¡æƒ³ideaå¤šæƒ³1æ¬¡', value: 1, permanent: false });
                        addLog('éšæœºäº‹ä»¶', 'åŒé—¨æ‰¾ä½ åˆä½œè®ºæ–‡ - å¼€å±•å…¨é¢åˆä½œ', 'æˆåŠŸåˆä½œï¼Œä¸´æ—¶buff-ä¸‹æ¬¡æƒ³ideaå¤šæƒ³1æ¬¡');
                    } else {
                        gameState.buffs.temporary.push(
                            { type: 'idea_times', name: 'ä¸‹æ¬¡æƒ³ideaå¤šæƒ³1æ¬¡', value: 1, permanent: false },
                            { type: 'write_times', name: 'ä¸‹æ¬¡å†™è®ºæ–‡å¤šå†™1æ¬¡', value: 1, permanent: false }
                        );
                        addLog('éšæœºäº‹ä»¶', 'åŒé—¨æ‰¾ä½ åˆä½œè®ºæ–‡ - å¼€å±•å…¨é¢åˆä½œ', 'æ·±å…¥åˆä½œï¼Œä¸´æ—¶buff-ä¸‹æ¬¡æƒ³ideaå¤šæƒ³1æ¬¡ï¼Œä¸´æ—¶buff-ä¸‹æ¬¡å†™è®ºæ–‡å¤šå†™1æ¬¡');
                    }
                    closeModal(); updateAllUI(); updateBuffs();
                }}
            ]);
        }

        function showRandomEvent11() {
            showModal('ğŸ‘¨â€ğŸ“ éšæœºäº‹ä»¶', '<p>å¸ˆå…„å¸ˆå§æ‰¾ä½ åˆä½œè®ºæ–‡ï¼Œä½ ä¼šé€‰æ‹©ã€‚</p>', [
                { text: 'è§‚æœ›ä¸€ä¸‹', class: 'btn-info', action: () => {
                    addLog('éšæœºäº‹ä»¶', 'å¸ˆå…„å¸ˆå§æ‰¾ä½ åˆä½œè®ºæ–‡ - è§‚æœ›ä¸€ä¸‹', 'å¸ˆå…„å¸ˆå§å…ˆæ‰¾äº†åŒé—¨åˆä½œ');
                    closeModal();
                }},
                { text: 'æµ…æµ…åˆä½œ', class: 'btn-primary', action: () => {
                    gameState.buffs.temporary.push({ type: 'idea_bonus', name: 'ä¸‹æ¬¡æƒ³ideaåˆ†æ•°+10', value: 10, permanent: false });
                    addLog('éšæœºäº‹ä»¶', 'å¸ˆå…„å¸ˆå§æ‰¾ä½ åˆä½œè®ºæ–‡ - æµ…æµ…åˆä½œ', 'å¸ˆå…„å¸ˆå§ç»™äº†ä½ ä¸€ä¸ªideaï¼Œä¸´æ—¶buff-ä¸‹æ¬¡æƒ³ideaåˆ†æ•°+10');
                    closeModal(); updateAllUI(); updateBuffs();
                }},
                { text: 'æ·±å…¥åˆä½œ', class: 'btn-warning', action: () => {
                    gameState.research = Math.min(20, gameState.research + 1);
                    addLog('éšæœºäº‹ä»¶', 'å¸ˆå…„å¸ˆå§æ‰¾ä½ åˆä½œè®ºæ–‡ - æ·±å…¥åˆä½œ', 'é‡åˆ°é è°±çš„å¸ˆå…„å¸ˆå§ï¼Œç§‘ç ”èƒ½åŠ›+1');
                    closeModal(); updateAllUI(); checkResearchUnlock();
                }},
                { text: 'æ‹œå…¥é—¨ä¸‹', class: 'btn-success', action: () => {
                    gameState.research = Math.min(20, gameState.research + 1);
                    gameState.buffs.permanent.push({ type: 'write_bonus', name: 'æ¯æ¬¡å†™è®ºæ–‡åˆ†æ•°+3', value: 3, permanent: true });
                    addLog('éšæœºäº‹ä»¶', 'å¸ˆå…„å¸ˆå§æ‰¾ä½ åˆä½œè®ºæ–‡ - æ‹œå…¥é—¨ä¸‹', 'ä½ æ”¶è·äº†ç¬¬äºŒå¯¼å¸ˆï¼Œç§‘ç ”èƒ½åŠ›+1ï¼Œæ°¸ä¹…buff-æ¯æ¬¡å†™è®ºæ–‡åˆ†æ•°+3');
                    closeModal(); updateAllUI(); updateBuffs(); checkResearchUnlock();
                }}
            ]);
        }

        function showRandomEvent12() {
            showModal('âš ï¸ éšæœºäº‹ä»¶', '<p>å¯¼å¸ˆæƒ³è¦æŠ¢ä½ è®ºæ–‡çš„ä¸€ä½œã€‚</p>', [
                { text: 'å‘å¯¼å¸ˆè¯‰è‹¦', class: 'btn-primary', action: () => {
                    addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæƒ³è¦æŠ¢ä½ è®ºæ–‡çš„ä¸€ä½œ - å‘å¯¼å¸ˆè¯‰è‹¦', 'å¯¼å¸ˆå¿ƒè½¯äº†');
                    closeModal();
                }},
                { text: 'åŠè¯´å¯¼å¸ˆæŠ¢å¸ˆå¼Ÿå¸ˆå¦¹ä¸€ä½œ', class: 'btn-warning', action: () => {
                    gameState.social = Math.max(0, gameState.social - 1);
                    addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæƒ³è¦æŠ¢ä½ è®ºæ–‡çš„ä¸€ä½œ - åŠè¯´å¯¼å¸ˆæŠ¢å¸ˆå¼Ÿå¸ˆå¦¹ä¸€ä½œ', 'å¸ˆå¼Ÿå¸ˆå¦¹å¯¹ä½ ç•¥æœ‰ä¸æ»¡ï¼Œç¤¾äº¤èƒ½åŠ›-1');
                    closeModal(); updateAllUI();
                }},
                { text: 'æ®ç†åŠ›äº‰', class: 'btn-info', action: () => {
                    addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæƒ³è¦æŠ¢ä½ è®ºæ–‡çš„ä¸€ä½œ - æ®ç†åŠ›äº‰', 'å¯¼å¸ˆè§‰å¾—ä½ è¯´å¾—æœ‰é“ç†');
                    closeModal();
                }},
                { text: 'ä»¥æ­»ç›¸é€¼', class: 'btn-danger', action: () => {
                    gameState.favor = Math.max(-20, gameState.favor - 1);
                    addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæƒ³è¦æŠ¢ä½ è®ºæ–‡çš„ä¸€ä½œ - ä»¥æ­»ç›¸é€¼', 'å¯¼å¸ˆå¯¹ä½ ç•¥æœ‰ä¸æ»¡ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦-1');
                    closeModal(); updateAllUI(); checkGameOver();
                }}
            ]);
        }

        function showRandomEvent13() {
            showModal('ğŸ’» éšæœºäº‹ä»¶', '<p>å®éªŒå®¤æœåŠ¡å™¨çªç„¶åäº†ã€‚</p>', [
                { text: 'å‚¬å¯¼å¸ˆå¿«ä¿®', class: 'btn-primary', action: () => {
                    gameState.buffs.permanent.push({ type: 'exp_bonus', name: 'æ¯æ¬¡åšå®éªŒåˆ†æ•°-2', value: -2, permanent: true });
                    addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤æœåŠ¡å™¨çªç„¶åäº† - å‚¬å¯¼å¸ˆå¿«ä¿®', 'å¯¼å¸ˆæ¯æ¬¡åäº†å°±å¸®ä½ é‡å¯ï¼Œæ°¸ä¹…buff-æ¯æ¬¡åšå®éªŒåˆ†æ•°-2');
                    closeModal(); updateAllUI(); updateBuffs();
                }},
                { text: 'ä¸¾æŠ¥åŒé—¨ç”¨æœåŠ¡å™¨æŒ–çŸ¿', class: 'btn-warning', action: () => {
                    gameState.social = Math.max(0, gameState.social - 2);
                    addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤æœåŠ¡å™¨çªç„¶åäº† - ä¸¾æŠ¥åŒé—¨ç”¨æœåŠ¡å™¨æŒ–çŸ¿', 'åŒé—¨è´Ÿè´£ä¿®å¥½äº†ï¼Œç¤¾äº¤èƒ½åŠ›-2');
                    closeModal(); updateAllUI();
                }},
                { text: 'è‡ªå·±å°è¯•é‡è£…ç³»ç»Ÿ', class: 'btn-info', action: () => {
                    gameState.san -= 3;
                    if (Math.random() < 0.5) {
                        addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤æœåŠ¡å™¨çªç„¶åäº† - è‡ªå·±å°è¯•é‡è£…ç³»ç»Ÿ', 'è´¹åŠ²å‘¨æŠ˜ä¿®å¥½äº†ï¼ŒSANå€¼-3');
                    } else {
                        gameState.social = Math.max(0, gameState.social - 1);
                        gameState.buffs.temporary.push({ type: 'exp_bonus', name: 'ä¸‹æ¬¡å®éªŒåˆ†æ•°Ã—0', value: 0, multiply: true, permanent: false });
                        addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤æœåŠ¡å™¨çªç„¶åäº† - è‡ªå·±å°è¯•é‡è£…ç³»ç»Ÿ', 'æœåŠ¡å™¨æ•°æ®å¿˜äº†å¤‡ä»½äº†ï¼Œä¸´æ—¶buff-ä¸‹æ¬¡å®éªŒåˆ†æ•°Ã—0ï¼Œç¤¾äº¤èƒ½åŠ›-1ï¼ŒSANå€¼-3');
                    }
                    closeModal(); updateAllUI(); updateBuffs(); checkGameOver();
                }},
                { text: 'æ·˜å®æ‰¾äººä¿®ç†', class: 'btn-danger', action: () => {
                    if (Math.random() < 0.5) {
                        gameState.gold -= 2;
                        addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤æœåŠ¡å™¨çªç„¶åäº† - æ·˜å®æ‰¾äººä¿®ç†', 'é‡åˆ°é«˜æ‰‹ä¿®å¥½äº†ï¼Œé‡‘å¸-2');
                    } else {
                        gameState.gold -= 4; gameState.san -= 2;
                        addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤æœåŠ¡å™¨çªç„¶åäº† - æ·˜å®æ‰¾äººä¿®ç†', 'é‡åˆ°æ— è‰¯å•†å®¶ä¿®äº†å¾ˆä¹…ï¼Œé‡‘å¸-4ï¼ŒSANå€¼-2');
                    }
                    closeModal(); updateAllUI(); checkGameOver();
                }}
            ]);
        }

        // ==================== æ¯•ä¸šæ£€æŸ¥ ====================
        function checkGraduation() {
            if (gameState.degree === 'master') {
                if ((gameState.year === 2 && gameState.month === 12 && gameState.totalScore >= 2) ||
                    (gameState.year === 3 && gameState.month === 12 && gameState.totalScore >= 3)) {
                    showPhDOptionModal();
                    return;
                }
            }
            const maxMonths = gameState.maxYears * 12;
            if (gameState.totalMonths >= maxMonths) {
                if (gameState.degree === 'master' && gameState.totalScore >= 1) triggerEnding('master');
                else if (gameState.degree === 'phd' && gameState.totalScore >= 7) triggerEnding('phd');
                else triggerEnding('delay');
            }
        }

        function showPhDOptionModal() {
            showModal('ğŸ“ è½¬åšé€‰æ‹©',
                `<p>æ­å–œï¼ä½ çš„ç§‘ç ”æˆç»©ä¼˜å¼‚ï¼ˆç§‘ç ”åˆ†${gameState.totalScore}ï¼‰ï¼Œè·å¾—äº†è½¬åšèµ„æ ¼ï¼</p>
                 <p>æ˜¯å¦é€‰æ‹©ç»§ç»­æ”»è¯»åšå£«å­¦ä½ï¼Ÿ</p>
                 <p style="color:var(--text-secondary);font-size:0.9rem;">åšå£«æ¯•ä¸šè¦æ±‚ï¼šç§‘ç ”åˆ†â‰¥7ï¼Œå­¦ä¹ å¹´é™5å¹´</p>`,
                [
                    { text: 'ç¡•å£«æ¯•ä¸š', class: 'btn-info', action: () => { closeModal(); triggerEnding('master'); }},
                    { text: 'ğŸ“š è½¬ä¸ºåšå£«', class: 'btn-primary', action: () => {
                        gameState.degree = 'phd';
                        gameState.maxYears = 5;
                        addLog('è½¬åš', 'é€‰æ‹©ç»§ç»­æ”»è¯»åšå£«å­¦ä½', 'æ¯•ä¸šè¦æ±‚æ›´æ–°ä¸ºç§‘ç ”åˆ†â‰¥7');
                        closeModal(); updateAllUI();
                    }}
                ]
            );
        }

        // ==================== æ¸¸æˆç»“å±€ ====================
        function checkGameOver() {
            if (gameState.san < 0) triggerEnding('burnout');
            else if (gameState.favor < 0) triggerEnding('expelled');
            else if (gameState.gold < 0) triggerEnding('poor');
        }

        function triggerEnding(type) {
            let title, desc, emoji;
            switch (type) {
                case 'burnout': title = 'ä¸å ªé‡è´Ÿ'; desc = 'ç¹é‡çš„ç§‘ç ”å‹åŠ›å‹å®äº†ä½ ï¼Œä½ æœ€ç»ˆé€‰æ‹©äº†ç¦»å¼€...'; emoji = 'ğŸ˜¢'; break;
                case 'expelled': title = 'è¢«é€€å­¦'; desc = 'å¯¼å¸ˆå¯¹ä½ å½»åº•å¤±æœ›ï¼Œä½ è¢«åŠé€€äº†...'; emoji = 'ğŸ˜­'; break;
                case 'poor': title = 'ç©·å›°æ½¦å€’'; desc = 'ä½ è¿é¥­éƒ½åƒä¸èµ·äº†ï¼Œåªèƒ½å«æ¨ç¦»å¼€...'; emoji = 'ğŸ’¸'; break;
                case 'delay': title = 'å»¶æ¯•'; desc = 'ä½ æ²¡èƒ½åœ¨è§„å®šæ—¶é—´å†…å®Œæˆæ¯•ä¸šè¦æ±‚ï¼Œåªèƒ½å»¶æœŸæ¯•ä¸š...'; emoji = 'â°'; break;
                case 'master':
                    if (gameState.totalScore >= 4) { title = 'ä¼˜ç§€ç¡•å£«æ¯•ä¸š'; desc = 'æ­å–œï¼ä½ ä»¥ä¼˜å¼‚çš„æˆç»©å®Œæˆäº†ç¡•å£«å­¦ä¸šï¼Œæœªæ¥å¯æœŸï¼'; emoji = 'ğŸŒŸ'; }
                    else { title = 'ç¡•å£«æ¯•ä¸š'; desc = 'æ­å–œï¼ä½ é¡ºåˆ©å®Œæˆäº†ç¡•å£«å­¦ä¸šï¼'; emoji = 'ğŸ“'; }
                    break;
                case 'phd':
                    const e = getPhDEndingType();
                    title = e.title; desc = e.desc; emoji = e.emoji;
                    break;
            }
            showEndingModal(title, desc, emoji);
        }

        function getPhDEndingType() {
            const { paperA, totalCitations, bigBullCooperation } = gameState;
            if (paperA >= 5 && totalCitations > 2000 && bigBullCooperation) return { title: 'æœªæ¥é™¢å£«', desc: 'ä½ çš„å­¦æœ¯æˆå°±ä»¤äººç©ç›®ï¼ŒæˆåŠŸå»å¤§ç‰›ç»„å½“å‰¯æ•™æˆï¼', emoji: 'ğŸ‘‘' };
            if (paperA >= 5 && totalCitations > 1000 && bigBullCooperation) return { title: 'å­¦æœ¯ä¹‹æ˜Ÿ', desc: 'ä½ çš„æ‰åè¢«å¤§ç‰›èµè¯†ï¼ŒæˆåŠŸå»å¤§ç‰›ç»„é£å‡ç–¾èµ°ï¼', emoji: 'â­' };
            if (paperA >= 5 && totalCitations > 1000) return { title: 'æˆ‘å°±æ˜¯å¯¼å¸ˆ', desc: 'æ­å–œï¼ä½ æˆåŠŸç•™æ ¡æˆä¸ºå‰¯æ•™æˆï¼', emoji: 'ğŸ‘¨â€ğŸ«' };
            if (paperA >= 4 && totalCitations > 500) return { title: 'é’æ¤’', desc: 'æ­å–œï¼ä½ æˆåŠŸç•™æ ¡é£å‡ç–¾èµ°ï¼', emoji: 'ğŸŒ¶ï¸' };
            if (paperA >= 3) return { title: 'ä¼˜ç§€åšå£«æ¯•ä¸š', desc: 'æ­å–œï¼ä½ ä»¥ä¼˜å¼‚çš„æˆç»©å®Œæˆäº†åšå£«å­¦ä¸šï¼', emoji: 'ğŸ†' };
            return { title: 'åšå£«æ¯•ä¸š', desc: 'æ­å–œï¼ä½ é¡ºåˆ©å®Œæˆäº†åšå£«å­¦ä¸šï¼', emoji: 'ğŸ“' };
        }

        function collectAchievements() {
            const a = [];
            if (gameState.hasLover) a.push('ğŸ’• å–œç»“è‰¯ç¼˜');
            if (gameState.gold > 20) a.push('ğŸ’° å®¶è´¢ä¸‡è´¯');
            if (gameState.research > 10 && gameState.social > 10 && gameState.favor > 10 && gameState.gold > 10) a.push('â¬¡ å…­è¾¹å½¢æˆ˜å£«');
            if (gameState.research >= 20) a.push('ğŸ† è¯ºå¥–é€‰æ‰‹');
            if (gameState.social >= 20) a.push('ğŸŒ¸ äº¤é™…èŠ±');
            if (gameState.favor >= 20) a.push('ğŸ¤ é“æ†å¸ˆç”Ÿ');
            if (gameState.san >= 20) a.push('âš¡ ç²¾åŠ›æ»¡æ»¡');
            if (gameState.rejectedCount === 0 && gameState.publishedPapers.length > 0) a.push('ğŸ¯ ç™¾å‘ç™¾ä¸­');
            if (gameState.teaBreakCount >= 3) a.push('â˜• æˆ‘çˆ±èŒ¶æ­‡');
            if (gameState.tourCount >= 3) a.push('ğŸ–ï¸ å…¬è´¹æ—…æ¸¸');
            if (gameState.publishedPapers.length >= 10) a.push('ğŸ¤– è®ºæ–‡æœºå™¨');
            return a;
        }

        function showEndingModal(title, desc, emoji) {
            const achievements = collectAchievements();
            const allAchievements = ['ğŸ’• å–œç»“è‰¯ç¼˜', 'ğŸ’° å®¶è´¢ä¸‡è´¯', 'â¬¡ å…­è¾¹å½¢æˆ˜å£«', 'ğŸ† è¯ºå¥–é€‰æ‰‹', 'ğŸŒ¸ äº¤é™…èŠ±', 'ğŸ¤ é“æ†å¸ˆç”Ÿ', 'âš¡ ç²¾åŠ›æ»¡æ»¡', 'ğŸ¯ ç™¾å‘ç™¾ä¸­', 'â˜• æˆ‘çˆ±èŒ¶æ­‡', 'ğŸ–ï¸ å…¬è´¹æ—…æ¸¸', 'ğŸ¤– è®ºæ–‡æœºå™¨'];
            const locked = allAchievements.filter(x => !achievements.includes(x));

            let html = `<div style="text-align:center;margin-bottom:20px;">
                <div style="font-size:4rem;margin-bottom:15px;">${emoji}</div>
                <div style="font-size:1.5rem;font-weight:700;color:var(--primary-color);margin-bottom:10px;">${title}</div>
                <div style="color:var(--text-secondary);line-height:1.6;">${desc}</div>
            </div>
            <div style="background:var(--light-bg);border-radius:15px;padding:20px;margin-bottom:20px;">
                <div style="font-weight:600;margin-bottom:15px;color:var(--primary-color);"><i class="fas fa-scroll"></i> ç”Ÿæ¶¯æ€»ç»“</div>
                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;font-size:0.9rem;">
                    <div>ğŸ‘¤ è§’è‰²ï¼š${gameState.characterName}</div>
                    <div>ğŸ“… å†æ—¶ï¼š${gameState.totalMonths}ä¸ªæœˆ</div>
                    <div>ğŸ“Š ç§‘ç ”åˆ†ï¼š${gameState.totalScore}</div>
                    <div>ğŸ“ è®ºæ–‡æ€»æ•°ï¼š${gameState.publishedPapers.length}</div>
                    <div>ğŸ…°ï¸ Aç±»è®ºæ–‡ï¼š${gameState.paperA}</div>
                    <div>ğŸ…±ï¸ Bç±»è®ºæ–‡ï¼š${gameState.paperB}</div>
                    <div>Â©ï¸ Cç±»è®ºæ–‡ï¼š${gameState.paperC}</div>
                    <div>ğŸ“ˆ æ€»å¼•ç”¨ï¼š${gameState.totalCitations}</div>
                    <div>ğŸ§  ç§‘ç ”èƒ½åŠ›ï¼š${gameState.research}</div>
                    <div>ğŸ‘¥ ç¤¾äº¤èƒ½åŠ›ï¼š${gameState.social}</div>
                    <div>â¤ï¸ å¯¼å¸ˆå¥½æ„Ÿï¼š${gameState.favor}</div>
                    <div>ğŸ’° é‡‘å¸ï¼š${gameState.gold}</div>
                </div>
            </div>`;

            if (achievements.length > 0) {
                html += `<div style="background:linear-gradient(135deg,rgba(253,203,110,0.2),rgba(255,234,167,0.2));border-radius:15px;padding:20px;margin-bottom:20px;">
                    <div style="font-weight:600;margin-bottom:15px;color:#d68910;"><i class="fas fa-trophy"></i> è¾¾æˆæˆå°± (${achievements.length})</div>
                    <div style="display:flex;flex-wrap:wrap;gap:10px;">
                        ${achievements.map(a => `<span style="padding:6px 12px;background:white;border-radius:20px;font-size:0.9rem;box-shadow:0 2px 5px rgba(0,0,0,0.1);">${a}</span>`).join('')}
                    </div>
                </div>`;
            }

            if (locked.length > 0) {
                html += `<div style="background:var(--light-bg);border-radius:15px;padding:20px;margin-bottom:20px;">
                    <div style="font-weight:600;margin-bottom:15px;color:var(--text-secondary);"><i class="fas fa-lock"></i> æœªè§£é”æˆå°±</div>
                    <div style="display:flex;flex-wrap:wrap;gap:10px;">
                        ${locked.map(a => `<span style="padding:6px 12px;background:#ddd;border-radius:20px;font-size:0.9rem;color:#999;">${a}</span>`).join('')}
                    </div>
                </div>`;
            }

            showModal('ğŸ® æ¸¸æˆç»“æŸ', html, [{ text: 'ğŸ”„ æˆ‘è¦é‡å¼€', class: 'btn-primary', action: restartGame }]);
        }

        function restartGame() {
            closeModal();
            selectedCharacter = null;
            document.querySelectorAll('.character-card').forEach(c => c.classList.remove('selected'));
            document.getElementById('start-btn').disabled = true;
            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('start-screen').classList.remove('hidden');
        }

        // ==================== å¼¹çª—ç³»ç»Ÿ ====================
        let modalCallbacks = [];

        function showModal(title, content, buttons) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-content').innerHTML = content;
            modalCallbacks = buttons.map(b => b.action);
            document.getElementById('modal-buttons').innerHTML = buttons.map((b, i) =>
                `<button class="btn ${b.class}" onclick="modalCallbacks[${i}]()">${b.text}</button>`
            ).join('');
            document.getElementById('modal-overlay').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('active');
        }

        function showPaperSelectModal(action, papers, callback) {
            let html = `<p>è¯·é€‰æ‹©è¦è¿›è¡Œ"${action}"çš„è®ºæ–‡ï¼š</p><div style="display:flex;flex-direction:column;gap:10px;margin-top:15px;">`;
            papers.forEach(({ paper, index }) => {
                const total = paper.ideaScore + paper.expScore + paper.writeScore;
                html += `<div style="padding:15px;background:var(--light-bg);border-radius:12px;cursor:pointer;border:2px solid transparent;transition:all 0.3s;"
                    onmouseover="this.style.borderColor='var(--primary-color)'"
                    onmouseout="this.style.borderColor='transparent'"
                    onclick="paperSelectCallback(${index})">
                    <div style="font-weight:600;margin-bottom:8px;">${paper.title.substring(0, 35)}${paper.title.length > 35 ? '...' : ''}</div>
                    <div style="display:flex;gap:15px;font-size:0.85rem;color:var(--text-secondary);">
                        <span>ğŸ’¡ Idea: ${paper.ideaScore}</span>
                        <span>ğŸ”¬ å®éªŒ: ${paper.expScore}</span>
                        <span>âœï¸ å†™ä½œ: ${paper.writeScore}</span>
                        <span style="color:var(--primary-color);font-weight:600;">æ€»åˆ†: ${total}</span>
                    </div>
                </div>`;
            });
            html += '</div>';
            window.paperSelectCallback = (idx) => { closeModal(); callback(idx); };
            showModal(`ğŸ“ é€‰æ‹©è®ºæ–‡ - ${action}`, html, [{ text: 'å–æ¶ˆ', class: 'btn-info', action: closeModal }]);
        }

        // ==================== æ—¥å¿—ç³»ç»Ÿ ====================
        function addLog(event, detail, result = '') {
            const logContent = document.getElementById('log-content');
            const dateStr = `ç¬¬${gameState.year}å¹´${gameState.month}æœˆ`;
            const isNegative = result && (result.includes('-') || result.includes('æ‹’ç¨¿') || result.includes('ä¸æ»¡') || result.includes('å¤±è´¥'));
            const entry = document.createElement('div');
            entry.className = `log-entry ${isNegative ? 'negative' : ''}`;
            entry.innerHTML = `<div class="date">[${dateStr}] ${event}</div><div class="event">${detail}</div>${result ? `<div class="result">â†’ ${result}</div>` : ''}`;
            logContent.insertBefore(entry, logContent.firstChild);
            while (logContent.children.length > 100) logContent.removeChild(logContent.lastChild);
        }

        // ==================== å·¥å…·å‡½æ•° ====================
        function rand(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffle(arr) {
            const a = [...arr];
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }

        // ==================== å¯åŠ¨æ¸¸æˆ ====================
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>