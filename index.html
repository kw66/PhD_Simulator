<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç ”ç©¶ç”Ÿæ¨¡æ‹Ÿå™¨</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-color: #6c5ce7;
            --secondary-color: #a29bfe;
            --accent-color: #fd79a8;
            --success-color: #00b894;
            --warning-color: #fdcb6e;
            --danger-color: #e17055;
            --info-color: #74b9ff;
            --love-color: #ff6b9d;
            --light-bg: #f8f9fa;
            --card-bg: #ffffff;
            --text-primary: #2d3436;
            --text-secondary: #636e72;
            --border-color: #dfe6e9;
            --shadow: 0 4px 15px rgba(0,0,0,0.1);
            --shadow-hover: 0 8px 25px rgba(0,0,0,0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: var(--text-primary);
        }

        /* é€†ä½æš—è‰²ä¸»é¢˜ */
		body.reversed-theme {
			--primary-color: #9b59b6;
			--secondary-color: #8e44ad;
			--accent-color: #c0392b;
			--success-color: #27ae60;
			--warning-color: #f39c12;
			--danger-color: #e74c3c;
			--light-bg: #2c2c2c;
			--card-bg: #1a1a2e;
			--text-primary: #e0e0e0;
			--text-secondary: #a0a0a0;
			--border-color: #444;
			--achievement-text: #ffffff;
			--achievement-bg: #5b2c6f;
			--achievement-border: #d7bde2;
			--achievement-shadow: 0 2px 10px rgba(155, 89, 182, 0.5);
		}

        body.reversed-theme #start-screen {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
        }

        body.reversed-theme .start-container {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 1px solid #9b59b6;
            box-shadow: 0 0 30px rgba(155, 89, 182, 0.3);
        }

        body.reversed-theme .game-title {
            background: linear-gradient(135deg, #9b59b6, #e74c3c);
            -webkit-background-clip: text;
            background-clip: text;
        }

        body.reversed-theme .character-card {
            background: #16213e;
            border-color: #444;
        }

        body.reversed-theme .character-card:hover {
            border-color: #9b59b6;
            box-shadow: 0 0 15px rgba(155, 89, 182, 0.4);
        }

        body.reversed-theme .character-card.selected {
            border-color: #e74c3c;
            background: linear-gradient(135deg, rgba(155,89,182,0.2), rgba(231,76,60,0.2));
            box-shadow: 0 0 20px rgba(231, 76, 60, 0.4);
        }

        body.reversed-theme .game-intro {
            background: #16213e;
            border: 1px solid #444;
        }

        body.reversed-theme .panel {
            background: #1a1a2e;
            border: 1px solid #333;
        }

        body.reversed-theme .log-content,
        body.reversed-theme .shop-item,
        body.reversed-theme .research-stat,
        body.reversed-theme .paper-slot,
        body.reversed-theme .score-box {
            background: #16213e;
        }

        body.reversed-theme .log-entry {
            background: #0f0f23;
            border-left-color: #9b59b6;
        }

        body.reversed-theme .modal {
            background: #1a1a2e;
            border: 1px solid #9b59b6;
        }

        body.reversed-theme #global-stats-panel {
            background: #16213e;
        }

        body.reversed-theme .mode-toggle-container {
            background: #333;
        }

        body.reversed-theme .mode-toggle-btn.active {
            background: var(--card-bg);
        }

        body.reversed-theme .mode-description {
            background: #16213e;
        }
        
        /* è§’è‰²æ˜¾ç¤º */
        .character-display {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: var(--light-bg);
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .character-display:hover {
            background: var(--border-color);
        }

        .character-display .char-icon {
            font-size: 1.4rem;
        }

        .character-display .char-name {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-primary);
        }

        .character-display .char-mode {
            margin-left: auto;
            font-size: 0.65rem;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .character-display .char-mode.normal-mode {
            background: rgba(108, 92, 231, 0.15);
            color: #6c5ce7;
        }

        .character-display .char-mode.reversed-mode {
            background: rgba(155, 89, 182, 0.2);
            color: #9b59b6;
        }

        body.reversed-theme .character-display {
            background: #2d2d44;
        }

        body.reversed-theme .character-display:hover {
            background: #3d3d54;
        }

        /* é€†ä½æ¨¡å¼é…è‰²ä¼˜åŒ– */
        body.reversed-theme .graduation-info-compact .remaining-badge {
            background: linear-gradient(135deg, #7d6608, #9a7d0a);
            color: #ffeaa7;
        }

        body.reversed-theme .graduation-info-compact .date-badge {
            background: linear-gradient(135deg, #6c3483, #8e44ad);
            color: #e8daef;
        }

        body.reversed-theme .graduation-info-compact .target-badge {
            background: #2d2d44;
            color: #bb8fce;
            border: 1px solid #444;
        }

        body.reversed-theme .action-btn {
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        body.reversed-theme .action-btn:hover:not(:disabled) {
            border-color: rgba(255, 255, 255, 0.3);
        }

        body.reversed-theme .btn-primary {
            background: linear-gradient(135deg, #5b2c6f, #7d3c98);
            color: #e8daef;
        }

        body.reversed-theme .btn-success {
            background: linear-gradient(135deg, #145a32, #1e8449);
            color: #d5f5e3;
        }

        body.reversed-theme .btn-danger {
            background: linear-gradient(135deg, #8e44ad, #9b59b6);
            color: white;
            box-shadow: 0 2px 8px rgba(142, 68, 173, 0.4);
        }

        body.reversed-theme .btn-warning {
            background: linear-gradient(135deg, #9a7d0a, #b7950b);
            color: #1a1a2e;
            font-weight: 600;
        }

        body.reversed-theme .btn-info {
            background: linear-gradient(135deg, #1a5276, #2874a6);
            color: #d4e6f1;
        }

        body.reversed-theme .btn-accent {
            background: linear-gradient(135deg, #922b21, #b03a2e);
            color: #fadbd8;
        }

        body.reversed-theme .progress-fill.san {
            background: linear-gradient(90deg, #e74c3c, #f39c12);
        }

        body.reversed-theme .quick-btn.next-month-btn {
            background: linear-gradient(135deg, #8e44ad, #9b59b6);
        }

        body.reversed-theme .quick-btn.next-month-btn i {
            color: white;
        }

        body.reversed-theme .quick-btn {
            background: #2d2d44;
            color: #e0e0e0;
            border: 1px solid #444;
        }

        body.reversed-theme .quick-btn i {
            color: #bb8fce;
        }

        body.reversed-theme .gold-display {
            background: linear-gradient(135deg, #7d6608, #9a7d0a);
            color: #ffeaa7;
        }

        body.reversed-theme .gold-display .gold-info {
            color: #ffeaa7;
        }

        body.reversed-theme .gold-display .gold-info i {
            color: #f1c40f;
        }

        body.reversed-theme .reviewing-badge {
            background: #7d6608;
            color: #ffeaa7;
        }

        body.reversed-theme .reviewing-badge.grade-A {
            background: linear-gradient(135deg, #922b21, #c0392b);
            color: white;
        }

        body.reversed-theme .reviewing-badge.grade-B {
            background: linear-gradient(135deg, #7d6608, #9a7d0a);
            color: #ffeaa7;
        }

        body.reversed-theme .reviewing-badge.grade-C {
            background: linear-gradient(135deg, #1e8449, #27ae60);
            color: white;
        }

        body.reversed-theme .shop-item-price {
            color: #f1c40f;
        }

        body.reversed-theme .difficulty-badge {
            border: 1px solid rgba(255,255,255,0.2);
        }

        body.reversed-theme .difficulty-badge.legendary { 
            background: rgba(155,89,182,0.4); 
            color: #d7bde2; 
        }

        body.reversed-theme .difficulty-badge.nightmare { 
            background: rgba(231,76,60,0.4); 
            color: #f5b7b1; 
        }

        body.reversed-theme .difficulty-badge.expert { 
            background: rgba(230,126,34,0.4); 
            color: #fad7a0; 
        }

        body.reversed-theme .difficulty-badge.hard { 
            background: rgba(241,196,15,0.4); 
            color: #f9e79f; 
        }

        body.reversed-theme .difficulty-badge.normal { 
            background: rgba(52,152,219,0.4); 
            color: #aed6f1; 
        }

        body.reversed-theme .difficulty-badge.easy { 
            background: rgba(46,204,113,0.4); 
            color: #abebc6; 
        }

        body.reversed-theme .progress-bar {
            background: #333;
        }

        body.reversed-theme .attribute-label .value {
            color: #bb8fce;
        }

        body.reversed-theme .paper-promotions .btn[disabled] {
            background: #444 !important;
            color: #888 !important;
            border: none;
        }
		
		/* åŸºç¡€æˆå°±æ ·å¼ */
		.achievement-item {
			padding: 6px 12px;
			border-radius: 16px;
			font-size: 0.8rem;
			margin: 4px;
			display: inline-block;
			cursor: pointer;  /* â˜… æ–°å¢ï¼šæ‰‹å‹æŒ‡é’ˆ */
			transition: all 0.3s ease;  /* â˜… æ–°å¢ï¼šè¿‡æ¸¡åŠ¨ç”» */
		}

		/* æ­£ä½æ¨¡å¼æ ·å¼ */
		body:not(.reversed-theme) .achievement-item {
			background: linear-gradient(135deg, #fdcb6e33, #ffeaa733);
			color: #2d3436;
			border: 1px solid #fdcb6e;
		}

		/* â˜… æ–°å¢ï¼šæ­£ä½æ¨¡å¼æ‚¬åœæ•ˆæœ */
		body:not(.reversed-theme) .achievement-item:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(253, 203, 110, 0.5);
		}

		/* é€†ä½æ¨¡å¼æ ·å¼ */
		body.reversed-theme .achievement-item {
			background: linear-gradient(135deg, #6c3483, #4a235a);
			color: #ffffff;
			border: 1px solid #d7bde2;
			box-shadow: 0 2px 10px rgba(155, 89, 182, 0.5);
			font-weight: 500;
			text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
		}

		/* é€†ä½æ¨¡å¼æ‚¬åœæ•ˆæœ */
		body.reversed-theme .achievement-item:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(155, 89, 182, 0.5);
		}

		/* æœªè§£é”æˆå°± */
		body.reversed-theme .locked-achievement {
			background: #1e1525;
			color: #a0a0a0;
			border: 1px dashed #6c3483;
			opacity: 0.7;
		}	
		
		body.reversed-theme .achievement-item {
			transition: all 0.3s ease;
		}

		body.reversed-theme .achievement-item:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(155, 89, 182, 0.5);
		}

		body.reversed-theme .locked-achievement:hover {
			color: #c0c0c0 !important;
			border-style: solid;
		}

		/* å…¨çƒç»Ÿè®¡é¢æ¿ä¸­çš„æˆå°±/ç»“å±€æ ‡ç­¾ */
		.stats-tag {
			padding: 4px 8px;
			background: white;
			border-radius: 6px;
			font-size: 0.65rem;
			border: 1px solid var(--border-color);
		}

		.stats-tag strong {
			color: var(--success-color);
		}

		.stats-tag.ending-tag strong {
			color: var(--primary-color);
		}

		body.reversed-theme .stats-tag {
			background: #2d2d44;
			color: #e0e0e0;
			border-color: #555;
		}

		body.reversed-theme .stats-tag strong {
			color: #58d68d;
		}

		body.reversed-theme .stats-tag.ending-tag strong {
			color: #bb8fce;
		}

		/* æœªè§£é”æˆå°±æ ·å¼ */
		.locked-achievement-tag {
			padding: 4px 8px;
			background: #e0e0e0;
			border-radius: 15px;
			font-size: 0.75rem;
			color: #999;
			cursor: pointer;
			transition: all 0.3s ease;
		}

		.locked-achievement-tag:hover {
			background: #d0d0d0;
			color: #666;
		}

		body.reversed-theme .locked-achievement-tag {
			background: #3d3d5c;
			color: #a0a0a0;
			border: 1px dashed #6c3483;
		}

		body.reversed-theme .locked-achievement-tag:hover {
			background: #4d4d6c;
			color: #c0c0c0;
			border-color: #8e44ad;
		}

		/* å¼¹çª—å†…çš„ç»Ÿè®¡æ ‡ç­¾ */
		.modal-stats-tag {
			padding: 4px 8px;
			background: var(--light-bg);
			border-radius: 6px;
			font-size: 0.7rem;
			cursor: pointer;
			transition: all 0.3s ease;
		}

		.modal-stats-tag:hover {
			transform: translateY(-1px);
		}

		.modal-stats-tag strong {
			color: var(--success-color);
		}

		body.reversed-theme .modal-stats-tag {
			background: #2d2d44;
			color: #e0e0e0;
			border: 1px solid #444;
		}

		body.reversed-theme .modal-stats-tag strong {
			color: #58d68d;
		}		
		
		body.reversed-theme .meta-records {
			background: #2d2d44 !important;
		}

		body.reversed-theme .meta-records div[style*="border-bottom"] {
			border-color: #444 !important;
		}

        /* å¼¹çª—æ ·å¼ */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active { opacity: 1; visibility: visible; }

        .modal {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 25px;
            max-width: 550px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: var(--shadow-hover);
            transform: scale(0.8);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal { transform: scale(1); }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 15px;
            text-align: center;
        }

        .modal-content { margin-bottom: 15px; line-height: 1.7; font-size: 0.95rem; }

        .modal-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-family: inherit;
        }

        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow); }
        .btn:active:not(:disabled) { transform: translateY(0); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }

        .btn-primary { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; }
        .btn-success { background: linear-gradient(135deg, var(--success-color), #55efc4); color: white; }
        .btn-danger { background: linear-gradient(135deg, var(--danger-color), #fab1a0); color: white; }
        .btn-warning { background: linear-gradient(135deg, var(--warning-color), #ffeaa7); color: var(--text-primary); }
        .btn-info { background: linear-gradient(135deg, var(--info-color), #a0d2ff); color: white; }
        .btn-accent { background: linear-gradient(135deg, var(--accent-color), #ffb8d0); color: white; }

        /* å¼€å§‹ç•Œé¢ */
        #start-screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: background 0.5s ease;
        }

        .start-container {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px 30px;
            max-width: 850px;
            width: 100%;
            box-shadow: var(--shadow-hover);
            text-align: center;
            transition: all 0.5s ease;
        }

        .game-title {
            font-size: 2.2rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }

        .game-author {
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        /* æ¨¡å¼åˆ‡æ¢æŒ‰é’® */
        .mode-toggle-container {
            display: flex;
            justify-content: center;
            gap: 0;
            margin: 15px auto;
            background: var(--border-color);
            border-radius: 25px;
            padding: 4px;
            max-width: 280px;
        }

        .mode-toggle-btn {
            flex: 1;
            padding: 10px 25px;
            border: none;
            border-radius: 20px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            background: transparent;
            color: var(--text-secondary);
        }

        .mode-toggle-btn:hover {
            color: var(--text-primary);
        }

        .mode-toggle-btn.active {
            background: var(--card-bg);
            color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .mode-toggle-btn.active.reversed-active {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            box-shadow: 0 2px 15px rgba(155, 89, 182, 0.4);
        }

        .mode-description {
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 15px;
            padding: 8px 20px;
            background: var(--light-bg);
            border-radius: 20px;
            transition: all 0.3s ease;
        }

        .game-intro {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 20px;
            padding: 12px 15px;
            background: var(--light-bg);
            border-radius: 12px;
            text-align: left;
        }

        .game-intro p { margin-bottom: 3px; }

        .character-selection h3 {
            font-size: 1.1rem;
            color: var(--primary-color);
            margin-bottom: 12px;
        }

        .character-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        @media (max-width: 700px) {
            .character-grid { grid-template-columns: repeat(2, 1fr); }
        }

        .character-card {
            background: var(--light-bg);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
			position: relative; /* æ–°å¢ï¼Œç”¨äºè¦†ç›–å±‚å®šä½ */
        }

        .character-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
            border-color: var(--secondary-color);
        }

        .character-card.selected {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, rgba(108,92,231,0.1), rgba(162,155,254,0.1));
        }

        .character-card .icon { font-size: 1.8rem; margin-bottom: 5px; }
        .character-card .name { font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 3px; }
        .character-card .desc { font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 6px; line-height: 1.3; }
        .character-card .bonus {
            padding: 5px 8px;
            background: rgba(0,184,148,0.15);
            border-radius: 6px;
            font-size: 0.7rem;
            color: var(--success-color);
            font-weight: 500;
        }

        /* éš¾åº¦æ˜Ÿçº§æ ·å¼ */
        .difficulty-container {
            margin-top: 8px;
            padding: 6px 8px;
            background: rgba(241, 196, 15, 0.1);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .difficulty-stars {
            display: flex;
            align-items: center;
            gap: 1px;
        }

        .difficulty-stars i {
            font-size: 0.7rem;
            color: #f1c40f;
        }

        .difficulty-stars i.far {
            opacity: 0.6;
        }

        .difficulty-label {
            font-size: 0.65rem;
            color: var(--text-secondary);
        }

        .difficulty-badge {
            font-size: 0.6rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 8px;
        }

        .difficulty-badge.legendary { background: rgba(155,89,182,0.2); color: #9b59b6; }
        .difficulty-badge.nightmare { background: rgba(231,76,60,0.2); color: #e74c3c; }
        .difficulty-badge.expert { background: rgba(230,126,34,0.2); color: #e67e22; }
        .difficulty-badge.hard { background: rgba(241,196,15,0.2); color: #f39c12; }
        .difficulty-badge.normal { background: rgba(52,152,219,0.2); color: #3498db; }
        .difficulty-badge.easy { background: rgba(46,204,113,0.2); color: #27ae60; }
        .difficulty-badge.unknown { background: rgba(149,165,166,0.2); color: #95a5a6; }

        .start-btn { font-size: 1.1rem; padding: 12px 40px; }

        /* æ¸¸æˆä¸»ç•Œé¢ */
        #game-screen { display: none; min-height: 100vh; padding: 10px; }

        .game-container {
            display: grid;
            grid-template-columns: 260px 1fr 280px;
            gap: 10px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .panel {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 12px;
            box-shadow: var(--shadow);
        }

        .panel-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border-color);
        }

        .left-column { display: flex; flex-direction: column; gap: 10px; }
        .middle-column { display: flex; flex-direction: column; gap: 10px; }
        .right-column { display: flex; flex-direction: column; gap: 10px; }

        /* å±æ€§æ  */
        .attribute-bar { margin-bottom: 8px; }

        .attribute-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
            font-size: 0.8rem;
        }

        .attribute-label .name { 
            display: flex; 
            align-items: center; 
            gap: 4px; 
            cursor: help;
        }
        .attribute-label .value { font-weight: 600; color: var(--primary-color); }

        .progress-bar {
            height: 10px;
            background: var(--border-color);
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        .progress-fill.san { background: linear-gradient(90deg, #e17055, #fdcb6e); }
        .progress-fill.research { background: linear-gradient(90deg, #6c5ce7, #a29bfe); }
        .progress-fill.social { background: linear-gradient(90deg, #00b894, #55efc4); }
        .progress-fill.favor { background: linear-gradient(90deg, #fd79a8, #ffb8d0); }

        .gold-display {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
            border-radius: 8px;
            margin-top: 5px;
        }

        .gold-display .gold-info {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .gold-display .gold-info i { color: #d68910; font-size: 1rem; }

        /* Buffæ  */
        .buff-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            max-height: 80px;
            overflow-y: auto;
        }

        .buff-tag {
            padding: 3px 7px;
            border-radius: 12px;
            font-size: 0.65rem;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .buff-tag.permanent {
            background: linear-gradient(135deg, rgba(0,184,148,0.2), rgba(85,239,196,0.2));
            color: #00a878;
            border: 1px solid var(--success-color);
        }

        .buff-tag.temporary {
            background: linear-gradient(135deg, rgba(116,185,255,0.2), rgba(162,155,254,0.2));
            color: #4a90d9;
            border: 1px solid var(--info-color);
        }

        .buff-tag.debuff {
            background: linear-gradient(135deg, rgba(225,112,85,0.2), rgba(250,177,160,0.2));
            color: #d63031;
            border: 1px solid var(--danger-color);
        }

        .buff-tag.love {
            background: linear-gradient(135deg, rgba(255,107,157,0.2), rgba(255,182,193,0.3));
            color: var(--love-color);
            border: 1px solid var(--love-color);
        }

        /* ç§‘ç ”æˆæœæ  */
        .research-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-bottom: 8px;
        }

        .research-stat {
            padding: 5px;
            background: var(--light-bg);
            border-radius: 6px;
            text-align: center;
        }

        .research-stat .label { font-size: 0.65rem; color: var(--text-secondary); }
        .research-stat .value { font-size: 0.95rem; font-weight: 700; color: var(--primary-color); }

        .paper-list { max-height: 150px; overflow-y: auto; }

        .paper-item {
            padding: 8px;
            background: var(--light-bg);
            border-radius: 6px;
            margin-bottom: 6px;
            border-left: 3px solid var(--primary-color);
        }

        .paper-item.grade-A { border-left-color: #e17055; }
        .paper-item.grade-B { border-left-color: #fdcb6e; }
        .paper-item.grade-C { border-left-color: #00b894; }

        .paper-item .title { font-size: 0.75rem; font-weight: 500; margin-bottom: 3px; }
        .paper-item .meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        /* æ¯•ä¸šä¿¡æ¯æ  */
        .graduation-info-compact {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            flex-wrap: wrap;
        }

        .graduation-info-compact .date-time {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
        }

        .graduation-info-compact .date-badge {
            padding: 4px 10px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 6px;
            font-weight: 600;
        }

        .graduation-info-compact .remaining-badge {
            padding: 4px 10px;
            background: linear-gradient(135deg, var(--warning-color), #ffeaa7);
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.8rem;
        }

        .graduation-info-compact .target-badge {
            padding: 4px 10px;
            background: var(--light-bg);
            border-radius: 6px;
            font-size: 0.8rem;
            color: var(--primary-color);
            font-weight: 500;
        }

        /* æ¸¸æˆæ—¥å¿—æ  */
        .log-content {
            height: 320px;
            overflow-y: auto;
            padding: 8px;
            background: var(--light-bg);
            border-radius: 10px;
        }

        .log-entry {
            padding: 7px 9px;
            margin-bottom: 5px;
            border-radius: 6px;
            background: white;
            border-left: 3px solid var(--primary-color);
            font-size: 0.8rem;
        }

        .log-entry .date { font-weight: 600; color: var(--primary-color); font-size: 0.75rem; }
        .log-entry .event { color: var(--text-primary); margin: 2px 0; }
        .log-entry .result { color: var(--success-color); font-weight: 500; font-size: 0.75rem; }
        .log-entry.negative .result { color: var(--danger-color); }

        /* æ“ä½œæ  */
        .action-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }

        .action-btn {
            padding: 8px 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            font-size: 0.8rem;
        }

        .action-btn i { font-size: 1.1rem; }
        .action-btn span { line-height: 1.2; }

        .action-cost {
            font-size: 0.6rem;
            opacity: 0.9;
            margin-top: 1px;
        }

        /* è®ºæ–‡å·¥ä½œç«™ */
        .paper-slots { display: flex; flex-direction: column; gap: 10px; }

        .paper-slot {
            padding: 10px;
            background: var(--light-bg);
            border-radius: 10px;
            border: 2px dashed var(--border-color);
        }

        .paper-slot.active { border-style: solid; border-color: var(--primary-color); }
        .paper-slot.locked { opacity: 0.5; }

        .paper-slot .slot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .paper-slot .slot-title { font-weight: 600; color: var(--primary-color); font-size: 0.85rem; }
        .paper-slot .paper-title { font-size: 0.75rem; font-weight: 500; margin-bottom: 6px; word-break: break-word; }

        .paper-scores {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-bottom: 6px;
        }

        .score-box {
            text-align: center;
            padding: 5px;
            background: white;
            border-radius: 5px;
        }

        .score-box .label { font-size: 0.6rem; color: var(--text-secondary); }
        .score-box .value { font-size: 0.9rem; font-weight: 700; color: var(--primary-color); }

        .paper-total {
            text-align: center;
            padding: 5px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 5px;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .paper-actions { display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; }
        .paper-actions .btn { padding: 5px; font-size: 0.7rem; justify-content: center; }

        .new-paper-btn {
            width: 100%;
            padding: 15px;
            border: 2px dashed var(--primary-color);
            background: transparent;
            color: var(--primary-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            font-family: inherit;
        }

        .new-paper-btn:hover { background: rgba(108,92,231,0.1); }

        .reviewing-badge {
            display: inline-block;
            padding: 2px 6px;
            background: var(--warning-color);
            color: var(--text-primary);
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 500;
        }

        .reviewing-badge.grade-A {
            background: linear-gradient(135deg, #e17055, #fab1a0);
            color: white;
        }

        .reviewing-badge.grade-B {
            background: linear-gradient(135deg, #fdcb6e, #ffeaa7);
            color: var(--text-primary);
        }

        .reviewing-badge.grade-C {
            background: linear-gradient(135deg, #00b894, #55efc4);
            color: white;
        }

        /* å•†åº—æ ·å¼ */
        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            background: var(--light-bg);
            border-radius: 8px;
            margin-bottom: 6px;
        }

        .shop-item.disabled { opacity: 0.5; }

        .shop-item-info { flex: 1; }
        .shop-item-name { font-weight: 600; font-size: 0.85rem; }
        .shop-item-desc { font-size: 0.7rem; color: var(--text-secondary); }

        .shop-item-action {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .shop-item-price {
            color: #d68910;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .shop-item-action .btn {
            padding: 4px 10px;
            font-size: 0.75rem;
        }

        /* ç»Ÿè®¡é¢æ¿åˆ†éš” */
        .stats-section {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px dashed var(--border-color);
        }

        .stats-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        /* æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: var(--light-bg); border-radius: 2px; }
        ::-webkit-scrollbar-thumb { background: var(--secondary-color); border-radius: 2px; }

        @media (max-width: 1100px) { .game-container { grid-template-columns: 1fr; } }

        .hidden { display: none !important; }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .left-column { display: flex; flex-direction: column; }
            #graduation-panel { order: 1; }
            #attributes-panel { order: 3; }
            #research-panel { order: 2; }

            .middle-column { display: flex; flex-direction: column; }
            #action-panel { order: 1; }
            #buff-panel { order: 3; }
            #log-panel { order: 2; }

            .start-container { padding: 15px; margin: 10px; width: calc(100% - 20px); }
            .game-title { font-size: 1.6rem; }
            .game-intro { font-size: 0.8rem; padding: 10px; }
            .character-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; }
            .character-card { padding: 10px; }
            .character-card .icon { font-size: 1.5rem; }
            .character-card .name { font-size: 0.9rem; }
            .character-card .desc { font-size: 0.7rem; }
            .character-card .bonus { font-size: 0.65rem; padding: 4px 6px; }

            #game-screen { padding: 5px; }
            .game-container { grid-template-columns: 1fr; gap: 8px; }
            .panel { padding: 10px; border-radius: 12px; }
            .panel-title { font-size: 0.85rem; padding-bottom: 6px; margin-bottom: 8px; }

            .log-content { height: 200px; padding: 6px; }
            .action-grid { grid-template-columns: repeat(3, 1fr); gap: 5px; }
            .action-btn { padding: 12px 8px; font-size: 0.75rem; min-height: 60px; }

            .modal { max-width: 95%; max-height: 90vh; padding: 15px; }
            .modal-title { font-size: 1.1rem; }
            .modal-content { font-size: 0.85rem; }
        }

        @media (max-width: 400px) {
            .character-grid { grid-template-columns: 1fr; }
            .action-grid { grid-template-columns: repeat(2, 1fr); }
        }

        /* ç§»åŠ¨ç«¯åº•éƒ¨å¿«æ·æ  */
        .mobile-quick-bar {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            padding: 8px 5px;
            z-index: 100;
            justify-content: space-around;
        }

        .quick-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 8px 12px;
            border: none;
            background: var(--light-bg);
            border-radius: 8px;
            font-size: 0.7rem;
            color: var(--text-primary);
            cursor: pointer;
            font-family: inherit;
        }

        .quick-btn i { font-size: 1.1rem; color: var(--primary-color); }
        .quick-btn.next-month-btn { background: linear-gradient(135deg, var(--danger-color), #fab1a0); color: white; }
        .quick-btn.next-month-btn i { color: white; }

        @media (max-width: 768px) {
            .mobile-quick-bar.game-active { display: flex; }
            #game-screen { padding-bottom: 70px; }
        }
		
		/* ==================== æŠ˜å åŠŸèƒ½CSSæ ·å¼ï¼ˆå¢å¼ºç‰ˆï¼‰==================== */

		/* å¯æŠ˜å é¢æ¿æ ‡é¢˜ */
		.panel-title.collapsible {
			cursor: pointer;
			user-select: none;
			transition: all 0.3s ease;
			display: flex;
			align-items: center;
		}

		.panel-title.collapsible:hover {
			color: var(--accent-color);
		}

		.panel-title .collapse-icon {
			font-size: 0.75rem;
			color: var(--text-secondary);
			transition: transform 0.3s ease;
			flex-shrink: 0;
		}

		.panel-title .collapse-icon.rotated {
			transform: rotate(-90deg);
		}

		/* æŠ˜å å†…å®¹åŒºåŸŸ */
		.collapsible-content {
			overflow: hidden;
			transition: max-height 0.35s ease, opacity 0.25s ease, padding 0.35s ease;
			max-height: 2000px;
			opacity: 1;
		}

		.collapsible-content.collapsed {
			max-height: 0 !important;
			opacity: 0;
			padding-top: 0 !important;
			padding-bottom: 0 !important;
			margin-top: 0 !important;
			margin-bottom: 0 !important;
		}

		/* æŠ˜å çŠ¶æ€çš„é¢æ¿ */
		.panel.panel-collapsed {
			padding-bottom: 12px;
		}

		.panel.panel-collapsed .panel-title {
			margin-bottom: 0;
			padding-bottom: 0;
			border-bottom: none;
		}

		/* æŠ˜å æç¤ºå¾½ç«  */
		.collapse-hint {
			font-size: 0.6rem;
			padding: 2px 6px;
			background: var(--light-bg);
			border-radius: 8px;
			color: var(--text-secondary);
			margin-left: 8px;
		}

		/* å¼€å§‹é¡µé¢æŠ˜å åŒºå— */
		.collapsible-section {
			margin-bottom: 15px;
		}

		.collapsible-header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 12px 15px;
			background: var(--light-bg);
			border-radius: 10px;
			cursor: pointer;
			user-select: none;
			transition: all 0.3s ease;
		}

		.collapsible-header:hover {
			background: var(--border-color);
		}

		.collapsible-header h3,
		.collapsible-header h4 {
			margin: 0;
			font-size: 1rem;
			color: var(--primary-color);
			display: flex;
			align-items: center;
			gap: 8px;
		}

		.collapsible-header .collapse-toggle {
			font-size: 0.85rem;
			color: var(--text-secondary);
			transition: transform 0.3s ease;
		}

		.collapsible-header.collapsed .collapse-toggle {
			transform: rotate(-90deg);
		}

		.collapsible-body {
			overflow: hidden;
			transition: max-height 0.4s ease, opacity 0.3s ease, padding 0.3s ease;
			max-height: 3000px;
			opacity: 1;
		}

		.collapsible-body.collapsed {
			max-height: 0;
			opacity: 0;
			padding-top: 0 !important;
		}

		/* é€†ä½ä¸»é¢˜ä¸‹çš„æŠ˜å æ ·å¼ */
		body.reversed-theme .collapsible-header {
			background: #2d2d44;
		}

		body.reversed-theme .collapsible-header:hover {
			background: #3d3d54;
		}

		body.reversed-theme .panel-title.collapsible:hover {
			color: #bb8fce;
		}

		body.reversed-theme .collapse-hint {
			background: #2d2d44;
		}

		/* å¿«é€Ÿå±•å¼€/æ”¶èµ·æ‰€æœ‰æŒ‰é’® */
		.collapse-all-btn {
			position: fixed;
			bottom: 80px;
			right: 15px;
			z-index: 99;
			padding: 8px 12px;
			background: var(--card-bg);
			border: 1px solid var(--border-color);
			border-radius: 20px;
			font-size: 0.75rem;
			cursor: pointer;
			box-shadow: var(--shadow);
			display: none;
		}

		@media (max-width: 768px) {
			.collapse-all-btn {
				display: flex;
				align-items: center;
				gap: 5px;
			}
		}

		body.reversed-theme .collapse-all-btn {
			background: #1a1a2e;
			border-color: #444;
			color: #e0e0e0;
		}

		/* ==================== è§’è‰²å¡ç‰‡æŠ˜å åŠŸèƒ½ ==================== */

		.character-card {
			position: relative;
		}

		.character-card .card-header {
			display: flex;
			align-items: center;
			gap: 8px;
			cursor: pointer;
			padding-bottom: 8px;
			margin-bottom: 8px;
			border-bottom: 1px dashed var(--border-color);
			transition: all 0.3s ease;
		}

		.character-card .card-header:hover {
			color: var(--primary-color);
		}

		.character-card .card-header .header-left {
			display: flex;
			align-items: center;
			gap: 8px;
			flex: 1;
		}

		.character-card .card-header .collapse-icon {
			font-size: 0.7rem;
			color: var(--text-secondary);
			transition: transform 0.3s ease;
		}

		.character-card .card-header .collapse-icon.rotated {
			transform: rotate(-90deg);
		}

		.character-card .card-body {
			overflow: hidden;
			transition: max-height 0.35s ease, opacity 0.25s ease;
			max-height: 1000px;
			opacity: 1;
		}

		.character-card .card-body.collapsed {
			max-height: 0 !important;
			opacity: 0;
		}

		.character-card.card-collapsed {
			padding-bottom: 12px;
		}

		.character-card.card-collapsed .card-header {
			border-bottom: none;
			padding-bottom: 0;
			margin-bottom: 0;
		}

		/* æŠ˜å çŠ¶æ€ä¸‹çš„è¿·ä½ éš¾åº¦æ˜¾ç¤º */
		.character-card .mini-difficulty {
			display: none;
			align-items: center;
			gap: 6px;
			margin-left: auto;
			margin-right: 8px;
		}

		.character-card.card-collapsed .mini-difficulty {
			display: flex;
		}

		/* é€†ä½ä¸»é¢˜ä¸‹çš„å¡ç‰‡æŠ˜å æ ·å¼ */
		body.reversed-theme .character-card .card-header {
			border-bottom-color: #444;
		}

		body.reversed-theme .character-card .card-header:hover {
			color: #bb8fce;
		}

		/* ==================== ç•™è¨€æ¿æ ·å¼ ==================== */
		.message-input-area {
			background: var(--card-bg);
			padding: 15px;
			border-radius: 10px;
			border: 1px solid var(--border-color);
		}

		.message-input-area input:focus,
		.message-input-area textarea:focus {
			outline: none;
			border-color: var(--primary-color);
			box-shadow: 0 0 0 2px rgba(108, 92, 231, 0.1);
		}

		.message-item {
			background: var(--card-bg);
			border-radius: 10px;
			padding: 12px 15px;
			margin-bottom: 10px;
			border: 1px solid var(--border-color);
			transition: all 0.3s ease;
		}

		.message-item:hover {
			border-color: var(--secondary-color);
			box-shadow: 0 2px 8px rgba(0,0,0,0.05);
		}

		.message-item.reply {
			margin-left: 30px;
			border-left: 3px solid var(--secondary-color);
			background: linear-gradient(135deg, rgba(162,155,254,0.05), rgba(108,92,231,0.05));
		}

		.message-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 8px;
		}

		.message-nickname {
			font-weight: 600;
			color: var(--primary-color);
			font-size: 0.9rem;
		}

		.message-time {
			font-size: 0.7rem;
			color: var(--text-secondary);
		}

		.message-content {
			font-size: 0.85rem;
			line-height: 1.6;
			color: var(--text-primary);
			word-break: break-word;
		}

		.message-reply-to {
			font-size: 0.75rem;
			color: var(--text-secondary);
			margin-bottom: 5px;
			padding: 4px 8px;
			background: var(--light-bg);
			border-radius: 4px;
			display: inline-block;
		}

		.message-actions {
			margin-top: 8px;
			display: flex;
			gap: 10px;
		}

		.message-actions button {
			background: none;
			border: none;
			color: var(--text-secondary);
			font-size: 0.75rem;
			cursor: pointer;
			padding: 4px 8px;
			border-radius: 4px;
			transition: all 0.2s ease;
			font-family: inherit;
		}

		.message-actions button:hover {
			background: var(--light-bg);
			color: var(--primary-color);
		}

		.reply-count {
			color: var(--info-color);
			font-size: 0.75rem;
			margin-left: 5px;
		}

		.message-replies {
			margin-top: 10px;
			padding-top: 10px;
			border-top: 1px dashed var(--border-color);
		}

		.no-messages {
			text-align: center;
			padding: 30px;
			color: var(--text-secondary);
		}

		.no-messages i {
			font-size: 2rem;
			margin-bottom: 10px;
			opacity: 0.5;
		}

		/* é€†ä½ä¸»é¢˜ç•™è¨€æ¿æ ·å¼ */
		body.reversed-theme .message-input-area {
			background: #16213e;
			border-color: #444;
		}

		body.reversed-theme .message-input-area input,
		body.reversed-theme .message-input-area textarea {
			background: #1a1a2e;
			border-color: #444;
			color: #e0e0e0;
		}

		body.reversed-theme .message-input-area input::placeholder,
		body.reversed-theme .message-input-area textarea::placeholder {
			color: #666;
		}

		body.reversed-theme .message-item {
			background: #16213e;
			border-color: #333;
		}

		body.reversed-theme .message-item:hover {
			border-color: #9b59b6;
		}

		body.reversed-theme .message-item.reply {
			border-left-color: #9b59b6;
			background: linear-gradient(135deg, rgba(155,89,182,0.1), rgba(142,68,173,0.1));
		}

		body.reversed-theme .message-nickname {
			color: #bb8fce;
		}

		body.reversed-theme .message-reply-to {
			background: #2d2d44;
		}

		body.reversed-theme .message-actions button:hover {
			background: #2d2d44;
			color: #bb8fce;
		}

		body.reversed-theme #reply-indicator {
			background: rgba(155, 89, 182, 0.15);
		}

		body.reversed-theme #reply-indicator span:first-child {
			color: #bb8fce;
		}

		/* æ¸¸æˆè¯´æ˜æŒ‰é’®åŒºåŸŸæ ·å¼å¢å¼º */
		#guide-section .collapsible-header {
			background: linear-gradient(135deg, rgba(108,92,231,0.1), rgba(253,121,168,0.1));
		}

		#guide-section .collapsible-header:hover {
			background: linear-gradient(135deg, rgba(108,92,231,0.2), rgba(253,121,168,0.2));
		}

		body.reversed-theme #guide-section .collapsible-header {
			background: linear-gradient(135deg, rgba(155,89,182,0.2), rgba(231,76,60,0.2));
		}

		/* è¯´æ˜å¼¹çª—å†…çš„è¡¨æ ¼æ ·å¼ */
		.modal table {
			background: var(--card-bg);
		}

		.modal code {
			word-break: break-word;
		}

		/* å“åº”å¼è°ƒæ•´ */
		@media (max-width: 600px) {
			#guide-section .btn {
				font-size: 0.7rem !important;
				padding: 8px 4px !important;
			}
			
			#guide-section .btn i {
				display: block;
				margin-bottom: 2px;
			}
		}

    </style>
</head>


<body>
    <!-- å¼€å§‹ç•Œé¢ -->
    <div id="start-screen">
        <div class="start-container">
			<h1 class="game-title">ğŸ“ ç ”ç©¶ç”Ÿæ¨¡æ‹Ÿå™¨-æ­£å¼ç‰ˆ</h1>
			<p class="game-author">
				ä½œè€…ï¼š<a href="https://xhslink.com/m/A2DFslJF4mb" target="_blank" style="color:var(--primary-color);text-decoration:none;">è½æ˜Ÿå³¦</a>
				&nbsp;|&nbsp;
				é¡¹ç›®ï¼š<a href="https://github.com/kw66/PhD_Simulator" target="_blank" style="color:var(--primary-color);text-decoration:none;">GitHub</a>
				&nbsp;|&nbsp;
				æµ‹è¯•ï¼šé›æ –æ¹–
				&nbsp;|&nbsp;
				<a href="http://xhslink.com/o/8czcPQfNziK" target="_blank" style="color:var(--accent-color);text-decoration:none;">ğŸ¨ ç§‘ç ”ç»˜å›¾</a>
				&nbsp;|&nbsp;
				<a href="http://xhslink.com/o/AC6pvxkgOhv" target="_blank" style="color:var(--success-color);text-decoration:none;">ğŸ¢ å®ä¹ </a>
			</p>

			<!-- è®¿é—®ç»Ÿè®¡ -->
			<div id="visitor-stats" style="text-align:center;font-size:0.75rem;color:var(--text-secondary);margin-bottom:15px;">
				<!-- ç¬¬ä¸€è¡Œï¼šå®æ—¶æ•°æ® -->
				<div style="margin-bottom:5px;">
					<span style="display:inline;">
						ğŸŸ¢ å†å²åœ¨çº¿ <span id="max-online-value" style="color:var(--accent-color);font-weight:600;">-</span>
					</span>
					&nbsp;|&nbsp; 
					<span id="busuanzi_container_site_pv" style="display:inline;">
						ğŸ“Š æ€»è®¿é—® <span id="busuanzi_value_site_pv" style="color:var(--primary-color);font-weight:600;">-</span>
					</span> 
					&nbsp;|&nbsp; 
					<span id="busuanzi_container_site_uv" style="display:inline;">
						ğŸ‘¥ æ€»è®¿å®¢ <span id="busuanzi_value_site_uv" style="color:var(--primary-color);font-weight:600;">-</span>
					</span>
					&nbsp;|&nbsp; 
					<span id="total-games-container" style="display:inline;">
						ğŸ® æ€»æ¸¸ç© <span id="total-games-value" style="color:var(--primary-color);font-weight:600;">-</span>
					</span>
				</div>
				<!-- ç¬¬äºŒè¡Œï¼šä»Šæ—¥æ•°æ® -->
				<div>
					<span style="display:inline;">
						ğŸŸ¢ å½“å‰åœ¨çº¿ <span id="online-count-value" style="color:var(--success-color);font-weight:600;">-</span>
					</span>
					&nbsp;|&nbsp; 
					<span style="display:inline;">
						â˜€ï¸ ä»Šæ—¥è®¿é—® <span id="today-pv-value" style="color:var(--warning-color);font-weight:600;">-</span>
					</span>
					&nbsp;|&nbsp; 
					<span style="display:inline;">
						ğŸ‘¤ ä»Šæ—¥è®¿å®¢ <span id="today-uv-value" style="color:var(--warning-color);font-weight:600;">-</span>
					</span>
					&nbsp;|&nbsp; 
					<span style="display:inline;">
						ğŸ¯ ä»Šæ—¥æ¸¸ç© <span id="today-games-value" style="color:var(--warning-color);font-weight:600;">-</span>
					</span>
				</div>
			</div>
            
            <!-- æ¨¡å¼åˆ‡æ¢æŒ‰é’® -->
            <div class="mode-toggle-container">
                <button class="mode-toggle-btn active" id="normal-mode-btn" onclick="switchMode(false)">
                    â˜€ï¸ æ­£ä½
                </button>
                <button class="mode-toggle-btn" id="reversed-mode-btn" onclick="switchMode(true)">
                    ğŸŒ‘ é€†ä½
                </button>
            </div>
            
            <div class="mode-description" id="mode-description">
                ğŸ“š ç»å…¸æ¨¡å¼ï¼Œä½“éªŒæ ‡å‡†çš„ç ”ç©¶ç”Ÿç”Ÿæ¶¯
            </div>
            
            <div class="game-intro" id="game-intro">
                <p>ğŸ“š <strong>æ¬¢è¿æ¥åˆ°ç ”ç©¶ç”Ÿæ¨¡æ‹Ÿå™¨ï¼</strong>ä½“éªŒç ”ç©¶ç”Ÿç”Ÿæ¶¯ï¼Œå¹³è¡¡ç§‘ç ”ã€ç”Ÿæ´»å’Œäººé™…å…³ç³»ï¼ŒåŠªåŠ›å‘è¡¨è®ºæ–‡ï¼Œæœ€ç»ˆé¡ºåˆ©æ¯•ä¸šã€‚</p>
                <p>ğŸ¯ <strong>æ¸¸æˆç›®æ ‡</strong>ï¼šç¡•å£«æ¯•ä¸šç§‘ç ”åˆ†â‰¥1ï¼ˆ3å¹´ï¼‰ï¼Œåšå£«æ¯•ä¸šç§‘ç ”åˆ†â‰¥7ï¼ˆ5å¹´ï¼‰</p>
                <p>ğŸ“ <strong>è®ºæ–‡ç§‘ç ”åˆ†</strong>ï¼šAç±»=4åˆ†ï¼ŒBç±»=2åˆ†ï¼ŒCç±»=1åˆ†</p>
                <p>ğŸ’¡ <strong>å±æ€§å½±å“</strong>ï¼šç§‘ç ”èƒ½åŠ›å½±å“è®ºæ–‡åˆ†æ•°ï¼›ç¤¾äº¤èƒ½åŠ›å’Œå¯¼å¸ˆå¥½æ„Ÿåº¦å½±å“äº‹ä»¶é€‰é¡¹å’Œç»“æœã€‚<strong>å»ºè®®ä¼˜å…ˆå°†å±æ€§æå‡è‡³6ä»¥è§£é”æ›´å¤šé€‰é¡¹ï¼</strong></p>
                <p>âš ï¸ <strong>æ³¨æ„</strong>ï¼šä¿æŒSANå€¼ã€å¯¼å¸ˆå¥½æ„Ÿåº¦å’Œé‡‘é’±ä¸ºæ­£æ•°ï¼Œå¦åˆ™å°†è§¦å‘ä¸è‰¯ç»“å±€ï¼</p>
            </div>
			
			<!-- ==================== 5. ä¿®æ”¹å¼€å§‹é¡µé¢HTMLç»“æ„ ==================== -->

			<!-- è§’è‰²é€‰æ‹©åŒºå—ï¼ˆå¯æŠ˜å ï¼‰ -->
			<div class="collapsible-section" id="character-section">
				<div class="collapsible-header" onclick="toggleStartSection('character')">
					<h3 id="selection-title"><i class="fas fa-users"></i> é€‰æ‹©ä½ çš„è§’è‰²</h3>
					<div style="display:flex;align-items:center;gap:8px;">
						<!-- â˜…â˜…â˜… æ–°å¢ï¼šå¡ç‰‡å…¨éƒ¨å±•å¼€/æ”¶èµ·æŒ‰é’® â˜…â˜…â˜… -->
						<button class="btn" style="padding:3px 8px;font-size:0.65rem;background:var(--light-bg);color:var(--text-secondary);border:1px solid var(--border-color);" 
								onclick="event.stopPropagation();toggleAllCharacterCards(true)">
							<i class="fas fa-compress-alt"></i> æ”¶èµ·å¡ç‰‡
						</button>
						<button class="btn" style="padding:3px 8px;font-size:0.65rem;background:var(--light-bg);color:var(--text-secondary);border:1px solid var(--border-color);" 
								onclick="event.stopPropagation();toggleAllCharacterCards(false)">
							<i class="fas fa-expand-alt"></i> å±•å¼€å¡ç‰‡
						</button>
						<i class="fas fa-chevron-down collapse-toggle" id="character-collapse-icon"></i>
					</div>
				</div>
				<div class="collapsible-body" id="character-body">
					<!-- çœŸÂ·å¤§å¤šæ•°è§£é”è¿›åº¦å®¹å™¨ -->
					<div id="true-normal-progress" style="margin-top:15px;"></div>
					<div class="character-grid" id="character-grid" style="margin-top:10px;"></div>
				</div>
			</div>
            <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
                <button class="btn btn-primary start-btn" id="start-btn" disabled>
                    <i class="fas fa-play"></i> å¼€å§‹æ–°çš„ç”Ÿæ¶¯
                </button>
                <button class="btn btn-warning start-btn" onclick="openLoadModalFromStart()">
                    <i class="fas fa-folder-open"></i> è¯»å–å­˜æ¡£
                </button>
            </div>
						
			<!-- ==================== æ¸¸æˆè¯´æ˜æŒ‰é’®åŒºåŸŸ ==================== -->
			<div class="collapsible-section" id="guide-section" style="margin-top:20px;">
				<div class="collapsible-header" onclick="toggleStartSection('guide')">
					<h3 style="margin:0;font-size:0.95rem;color:var(--primary-color);display:flex;align-items:center;gap:6px;">
						<i class="fas fa-book"></i> æ¸¸æˆè¯´æ˜ä¸æ”»ç•¥
					</h3>
					<i class="fas fa-chevron-down collapse-toggle" id="guide-collapse-icon"></i>
				</div>
				<div class="collapsible-body" id="guide-body">
					<div style="padding:15px;background:var(--light-bg);border-radius:0 0 10px 10px;">
						<div style="display:grid;grid-template-columns:repeat(4, 1fr);gap:8px;">
							<button class="btn btn-info" style="padding:10px 8px;font-size:0.8rem;" onclick="showGuide('basics')">
								<i class="fas fa-gamepad"></i><br>åŸºç¡€ç©æ³•ä¸å±æ€§
							</button>
							<button class="btn btn-success" style="padding:10px 8px;font-size:0.8rem;" onclick="showGuide('paperScore')">
								<i class="fas fa-calculator"></i><br>è®ºæ–‡åˆ†æ•°è®¡ç®—
							</button>
							<button class="btn btn-warning" style="padding:10px 8px;font-size:0.8rem;" onclick="showGuide('review')">
								<i class="fas fa-user-edit"></i><br>å®¡ç¨¿æœºåˆ¶è¯¦è§£
							</button>
							<button class="btn btn-accent" style="padding:10px 8px;font-size:0.8rem;" onclick="showGuide('citation')">
								<i class="fas fa-chart-line"></i><br>å¼•ç”¨å¢é•¿å…¬å¼
							</button>
							<button class="btn btn-primary" style="padding:10px 8px;font-size:0.8rem;" onclick="showGuide('events')">
								<i class="fas fa-dice"></i><br>äº‹ä»¶ç³»ç»Ÿ
							</button>
							<button class="btn btn-danger" style="padding:10px 8px;font-size:0.8rem;" onclick="showGuide('buffs')">
								<i class="fas fa-magic"></i><br>Buffä¸Debuff
							</button>
							<button class="btn btn-info" style="padding:10px 8px;font-size:0.8rem;" onclick="showGuide('characters')">
								<i class="fas fa-users"></i><br>è§’è‰²ä¸è§‰é†’ç³»ç»Ÿ
							</button>
							<button class="btn btn-success" style="padding:10px 8px;font-size:0.8rem;" onclick="showGuide('strategy')">
								<i class="fas fa-chess"></i><br>è¿›é˜¶ç­–ç•¥æ”»ç•¥
							</button>
						</div>
						<div style="margin-top:10px;text-align:center;font-size:0.75rem;color:var(--text-secondary);">
							<i class="fas fa-info-circle"></i> ç‚¹å‡»æŒ‰é’®æŸ¥çœ‹è¯¦ç»†çš„æ¸¸æˆæœºåˆ¶è¯´æ˜å’Œå…¬å¼
						</div>
					</div>
				</div>
			</div>
			<!-- ==================== æ¸¸æˆè¯´æ˜æŒ‰é’®åŒºåŸŸç»“æŸ ==================== -->
			
			
			<!-- å…¨çƒç»Ÿè®¡é¢æ¿ï¼ˆå¯æŠ˜å ï¼‰-->
			<div class="collapsible-section" id="stats-section" style="margin-top:20px;display:none;">
				<div class="collapsible-header" onclick="toggleStartSection('stats')">
					<h3 style="margin:0;font-size:0.95rem;color:var(--primary-color);display:flex;align-items:center;gap:6px;">
						<i class="fas fa-chart-pie"></i> å…¨çƒç»Ÿè®¡ï¼ˆæœ€è¿‘10000å±€ï¼‰
					</h3>
					<i class="fas fa-chevron-down collapse-toggle" id="stats-collapse-icon"></i>
				</div>
				<div class="collapsible-body" id="stats-body">
					<div id="global-stats-content" style="padding:15px;background:var(--light-bg);border-radius:0 0 10px 10px;">
						<div id="stats-loading" style="text-align:center;color:var(--text-secondary);font-size:0.85rem;">
							<i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...
						</div>
						<div id="stats-content" style="display:none;">
							<!-- æ­£ä½ç»Ÿè®¡ -->
							<div id="normal-stats-section" class="stats-section">
								<div id="normal-ending-stats" style="margin-bottom:10px;"></div>
								<div id="normal-achievement-stats"></div>
							</div>
							
							<!-- é€†ä½ç»Ÿè®¡ -->
							<div id="reversed-stats-section" class="stats-section" style="display:none;">
								<div id="reversed-ending-stats" style="margin-bottom:10px;"></div>
								<div id="reversed-achievement-stats"></div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- ç•™è¨€æ¿ï¼ˆå¯æŠ˜å ï¼‰-->
			<div class="collapsible-section" id="message-section" style="margin-top:20px;">
				<div class="collapsible-header" onclick="toggleStartSection('message')">
					<h3 style="margin:0;font-size:0.95rem;color:var(--primary-color);display:flex;align-items:center;gap:6px;">
						<i class="fas fa-comments"></i> ç•™è¨€æ¿
					</h3>
					<i class="fas fa-chevron-down collapse-toggle" id="message-collapse-icon"></i>
				</div>
				<div class="collapsible-body" id="message-body">
					<div id="message-board" style="padding:15px;background:var(--light-bg);border-radius:0 0 10px 10px;">
						<!-- å‘è¡¨ç•™è¨€åŒº -->
						<div class="message-input-area">
							<div style="display:flex;gap:10px;margin-bottom:10px;">
								<input type="text" id="msg-nickname" placeholder="æ˜µç§°ï¼ˆå¿…å¡«ï¼‰" maxlength="20" 
									   style="flex:1;padding:8px 12px;border:1px solid var(--border-color);border-radius:8px;font-size:0.85rem;font-family:inherit;background:var(--card-bg);color:var(--text-primary);">
								<button class="btn btn-primary" onclick="postMessage()" style="padding:8px 16px;font-size:0.85rem;">
									<i class="fas fa-paper-plane"></i> å‘é€
								</button>
							</div>
							<textarea id="msg-content" placeholder="è¯´ç‚¹ä»€ä¹ˆå§...ï¼ˆæ”¯æŒå›å¤å…¶ä»–äººçš„ç•™è¨€ï¼‰" maxlength="500" rows="3"
									  style="width:100%;padding:10px 12px;border:1px solid var(--border-color);border-radius:8px;font-size:0.85rem;font-family:inherit;resize:vertical;background:var(--card-bg);color:var(--text-primary);"></textarea>
							<div id="reply-indicator" style="display:none;margin-top:8px;padding:8px 12px;background:rgba(108,92,231,0.1);border-radius:6px;font-size:0.8rem;">
								<span style="color:var(--primary-color);">å›å¤ <strong id="reply-to-name"></strong>ï¼š</span>
								<span id="reply-preview" style="color:var(--text-secondary);"></span>
								<button onclick="cancelReply()" style="float:right;background:none;border:none;color:var(--danger-color);cursor:pointer;font-size:0.8rem;">
									<i class="fas fa-times"></i> å–æ¶ˆ
								</button>
							</div>
						</div>
						
						<!-- ç•™è¨€åˆ—è¡¨ -->
						<div id="message-list" style="margin-top:15px;">
							<div style="text-align:center;color:var(--text-secondary);font-size:0.85rem;padding:20px;">
								<i class="fas fa-spinner fa-spin"></i> åŠ è½½ç•™è¨€ä¸­...
							</div>
						</div>
						
						<!-- åˆ†é¡µæ§åˆ¶ -->
						<div id="message-pagination" style="display:none;margin-top:15px;text-align:center;">
							<button class="btn btn-info" id="prev-page-btn" onclick="changeMessagePage(-1)" style="padding:6px 12px;font-size:0.8rem;" disabled>
								<i class="fas fa-chevron-left"></i> ä¸Šä¸€é¡µ
							</button>
							<span id="page-info" style="margin:0 15px;font-size:0.85rem;color:var(--text-secondary);">ç¬¬ 1 é¡µ</span>
							<button class="btn btn-info" id="next-page-btn" onclick="changeMessagePage(1)" style="padding:6px 12px;font-size:0.8rem;">
								ä¸‹ä¸€é¡µ <i class="fas fa-chevron-right"></i>
							</button>
						</div>
					</div>
				</div>
			</div>
        </div>
    </div>




	<!-- æ¸¸æˆä¸»ç•Œé¢ -->
	<div id="game-screen">
		<div class="game-container">
			<!-- å·¦ä¾§æ  -->
			<div class="left-column">
				<!-- æ¯•ä¸šä¿¡æ¯æ  -->
				<div class="panel" id="graduation-panel">
					<div class="panel-title collapsible" onclick="toggleCollapse('graduation-panel')">
						<i class="fas fa-graduation-cap"></i> æ¯•ä¸šä¿¡æ¯
						<div style="margin-left:auto;display:flex;gap:5px;align-items:center;">
							<button class="btn btn-info" style="padding:3px 8px;font-size:0.7rem;" onclick="event.stopPropagation();openSaveModal()"><i class="fas fa-save"></i> å­˜æ¡£</button>
							<button class="btn btn-warning" style="padding:3px 8px;font-size:0.7rem;" onclick="event.stopPropagation();openLoadModal()"><i class="fas fa-folder-open"></i> è¯»æ¡£</button>
							<i class="fas fa-chevron-down collapse-icon" id="graduation-panel-collapse-icon"></i>
						</div>
					</div>
					<div class="collapsible-content" id="graduation-panel-content">
						<div class="graduation-info-compact">
							<div class="date-time">
								<span class="date-badge">ç¬¬<span id="current-year">1</span>å¹´ç¬¬<span id="current-month">1</span>æœˆ</span>
								<span class="remaining-badge"><i class="fas fa-hourglass-half"></i> å‰©ä½™<span id="remaining-time">36</span>æœˆ</span>
							</div>
							<span class="target-badge" id="graduation-target">ğŸ¯ ç¡•å£«ï¼šç§‘ç ”åˆ†â‰¥1</span>
							<button class="btn btn-danger" style="padding:3px 10px;font-size:0.7rem;" onclick="confirmRestart()"><i class="fas fa-redo"></i> é‡å¼€</button>
						</div>
					</div>
				</div>

				<!-- å±æ€§æ  -->
				<div class="panel" id="attributes-panel">
					<div class="panel-title collapsible" onclick="toggleCollapse('attributes-panel')">
						<i class="fas fa-chart-bar"></i> ä¸ªäººå±æ€§
						<i class="fas fa-chevron-down collapse-icon" id="attributes-panel-collapse-icon"></i>
					</div>
					<div class="collapsible-content" id="attributes-panel-content">
						<div class="character-display" id="character-display" onclick="event.stopPropagation();showCharacterDetail()" style="cursor:pointer;">
							<span class="char-icon" id="char-icon">ğŸ‘¤</span>
							<span class="char-name" id="char-name">-</span>
							<span class="char-mode" id="char-mode"></span>
							<i class="fas fa-info-circle" style="margin-left:auto;color:var(--text-secondary);font-size:0.75rem;"></i>
						</div>
						
						<div class="attribute-bar">
							<div class="attribute-label">
								<span class="name" title="ç²¾ç¥çŠ¶æ€ï¼Œé™ä¸ºè´Ÿæ•°åˆ™ä¸å ªé‡è´Ÿ"><i class="fas fa-brain"></i> SANå€¼</span>
								<span class="value"><span id="san-value">20</span>/<span id="san-max">20</span></span>
							</div>
							<div class="progress-bar"><div class="progress-fill san" id="san-bar"></div></div>
						</div>
						<div class="attribute-bar">
							<div class="attribute-label">
								<span class="name" title="å½±å“è®ºæ–‡åˆ†æ•°ç”Ÿæˆï¼Œè¾¾åˆ°6/12/18è§£é”æ–°è®ºæ–‡æ§½"><i class="fas fa-flask"></i> ç§‘ç ”èƒ½åŠ›</span>
								<span class="value"><span id="research-value">1</span>/<span id="research-max">20</span></span>
							</div>
							<div class="progress-bar"><div class="progress-fill research" id="research-bar"></div></div>
						</div>
						<div class="attribute-bar">
							<div class="attribute-label">
								<span class="name" title="å½±å“äº‹ä»¶é€‰é¡¹å’Œç»“æœï¼Œè¾¾åˆ°6/12è§£é”æ›´å¤šé€‰é¡¹"><i class="fas fa-users"></i> ç¤¾äº¤èƒ½åŠ›</span>
								<span class="value"><span id="social-value">1</span>/20</span>
							</div>
							<div class="progress-bar"><div class="progress-fill social" id="social-bar"></div></div>
						</div>
						<div class="attribute-bar">
							<div class="attribute-label">
								<span class="name" title="å½±å“äº‹ä»¶é€‰é¡¹å’Œç»“æœï¼Œé™ä¸ºè´Ÿæ•°åˆ™è¢«é€€å­¦"><i class="fas fa-heart"></i> å¯¼å¸ˆå¥½æ„Ÿåº¦</span>
								<span class="value"><span id="favor-value">1</span>/20</span>
							</div>
							<div class="progress-bar"><div class="progress-fill favor" id="favor-bar"></div></div>
						</div>
						<div class="gold-display">
							<div class="gold-info"><i class="fas fa-coins"></i><span><span id="gold-value">1</span> é‡‘å¸</span></div>
							<button class="btn btn-warning" style="padding:5px 10px;font-size:0.75rem;" onclick="openShop()"><i class="fas fa-store"></i> å•†åº—</button>
						</div>
					</div>
				</div>

				<!-- ç§‘ç ”æˆæœæ  -->
				<div class="panel" id="research-panel">
					<div class="panel-title collapsible" onclick="toggleCollapse('research-panel')">
						<i class="fas fa-award"></i> ç§‘ç ”æˆæœ
						<i class="fas fa-chevron-down collapse-icon" id="research-panel-collapse-icon"></i>
					</div>
					<div class="collapsible-content" id="research-panel-content">
						<div class="research-summary">
							<div class="research-stat"><div class="label">Aç±»</div><div class="value" id="paper-a-count">0</div></div>
							<div class="research-stat"><div class="label">Bç±»</div><div class="value" id="paper-b-count">0</div></div>
							<div class="research-stat"><div class="label">Cç±»</div><div class="value" id="paper-c-count">0</div></div>
							<div class="research-stat"><div class="label">ç§‘ç ”åˆ†</div><div class="value" id="total-score">0</div></div>
							<div class="research-stat"><div class="label">æ€»å¼•ç”¨</div><div class="value" id="total-citations">0</div></div>
							<div class="research-stat"><div class="label">è®ºæ–‡æ•°</div><div class="value" id="paper-total-count">0</div></div>
						</div>
						<div style="font-size:0.65rem;color:var(--text-secondary);margin-bottom:6px;text-align:center;">Aç±»=4åˆ† Bç±»=2åˆ† Cç±»=1åˆ†</div>
						<div class="paper-list" id="published-papers">
							<p style="color:var(--text-secondary);font-size:0.75rem;text-align:center;">æš‚æ— å·²å‘è¡¨è®ºæ–‡</p>
						</div>
					</div>
				</div>
			</div>

			<!-- ä¸­é—´æ  -->
			<div class="middle-column">
				<!-- æ¸¸æˆæ—¥å¿—æ  -->
				<div class="panel" id="log-panel" style="flex:1;">
					<div class="panel-title collapsible" onclick="toggleCollapse('log-panel')">
						<i class="fas fa-scroll"></i> æ¸¸æˆæ—¥å¿—
						<span id="event-preview" style="margin-left:8px;font-size:0.7rem;font-weight:400;color:var(--text-secondary);"></span>
						<i class="fas fa-chevron-down collapse-icon" id="log-panel-collapse-icon" style="margin-left:auto;"></i>
					</div>
					<div class="collapsible-content" id="log-panel-content">
						<div class="log-content" id="log-content"></div>
					</div>
				</div>

				<!-- å¢ç›Š/å‡ç›Šæ•ˆæœæ  -->
				<div class="panel" id="buff-panel">
					<div class="panel-title collapsible" onclick="toggleCollapse('buff-panel')">
						<i class="fas fa-magic"></i> å¢ç›Š/å‡ç›Šæ•ˆæœ
						<i class="fas fa-chevron-down collapse-icon" id="buff-panel-collapse-icon"></i>
					</div>
					<div class="collapsible-content" id="buff-panel-content">
						<div class="buff-list" id="buff-list"><span style="color:var(--text-secondary);font-size:0.8rem;">æš‚æ— æ•ˆæœ</span></div>
					</div>
				</div>

				<!-- æ“ä½œæ  -->
				<div class="panel" id="action-panel">
					<div class="panel-title collapsible" onclick="toggleCollapse('action-panel')">
						<i class="fas fa-gamepad"></i> æ“ä½œ
						<i class="fas fa-chevron-down collapse-icon" id="action-panel-collapse-icon"></i>
					</div>
					<div class="collapsible-content" id="action-panel-content">
						<div class="action-grid">
							<button class="btn btn-info action-btn" id="btn-read" onclick="readPaper()"><i class="fas fa-book-open"></i><span>çœ‹è®ºæ–‡</span></button>
							<button class="btn btn-warning action-btn" id="btn-work" onclick="partTimeJob()"><i class="fas fa-briefcase"></i><span>æ‰“å·¥</span></button>
							<button class="btn btn-accent action-btn" id="btn-idea" onclick="thinkIdea()"><i class="fas fa-lightbulb"></i><span>æƒ³idea</span></button>
							<button class="btn btn-primary action-btn" id="btn-experiment" onclick="doExperiment()"><i class="fas fa-vial"></i><span>åšå®éªŒ</span></button>
							<button class="btn btn-success action-btn" id="btn-write" onclick="writePaper()"><i class="fas fa-pen-fancy"></i><span>å†™è®ºæ–‡</span></button>
							<button class="btn btn-danger action-btn" id="btn-next" onclick="nextMonth()"><i class="fas fa-forward"></i><span>ä¸‹ä¸€æœˆ</span></button>
						</div>
					</div>
				</div>
			</div>

			<!-- å³ä¾§æ  -->
			<div class="right-column">
				<div class="panel" id="workstation-panel">
					<div class="panel-title collapsible" onclick="toggleCollapse('workstation-panel')">
						<i class="fas fa-file-alt"></i> è®ºæ–‡å·¥ä½œç«™ï¼ˆOverleafï¼‰
						<i class="fas fa-chevron-down collapse-icon" id="workstation-panel-collapse-icon"></i>
					</div>
					<div class="collapsible-content" id="workstation-panel-content">
						<div class="paper-slots" id="paper-slots"></div>
					</div>
				</div>
			</div>
		</div>
	</div>

    <!-- å¼¹çª— -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal" id="modal">
            <h3 class="modal-title" id="modal-title">æ ‡é¢˜</h3>
            <div class="modal-content" id="modal-content">å†…å®¹</div>
            <div class="modal-buttons" id="modal-buttons"></div>
        </div>
    </div>

    <!-- ç§»åŠ¨ç«¯åº•éƒ¨å¿«æ·æ  -->
    <div class="mobile-quick-bar" id="mobile-quick-bar">
        <button class="quick-btn" onclick="scrollToPanel('action-panel')">
            <i class="fas fa-gamepad"></i>
            <span>æ“ä½œ</span>
        </button>
        <button class="quick-btn" onclick="scrollToPanel('workstation-panel')">
            <i class="fas fa-file-alt"></i>
            <span>è®ºæ–‡</span>
        </button>
        <button class="quick-btn" onclick="scrollToPanel('attributes-panel')">
            <i class="fas fa-chart-bar"></i>
            <span>å±æ€§</span>
        </button>
        <button class="quick-btn" onclick="openShop()">
            <i class="fas fa-store"></i>
            <span>å•†åº—</span>
        </button>
        <button class="quick-btn next-month-btn" onclick="nextMonth()">
            <i class="fas fa-forward"></i>
            <span>ä¸‹æœˆ</span>
        </button>
    </div>
	<!-- å¿«é€ŸæŠ˜å /å±•å¼€æŒ‰é’®ï¼ˆç§»åŠ¨ç«¯ï¼‰ -->
	<button class="collapse-all-btn" id="collapse-all-btn" onclick="toggleAllPanels()">
		<i class="fas fa-compress-alt" id="collapse-all-btn-icon"></i>
		<span id="collapse-all-btn-text">æ”¶èµ·å…¨éƒ¨</span>
	</button>
    <script>

		// ==================== é¢æ¿æŠ˜å åŠŸèƒ½ï¼ˆå®Œæ•´ç‰ˆï¼‰====================

		// æŠ˜å çŠ¶æ€å­˜å‚¨
		const collapseStates = {};

		// åˆå§‹åŒ–æŠ˜å çŠ¶æ€ï¼ˆä»localStorageè¯»å–ï¼‰
		function initCollapseStates() {
			const saved = localStorage.getItem('graduateSimulator_collapseStates');
			if (saved) {
				try {
					Object.assign(collapseStates, JSON.parse(saved));
				} catch (e) {
					console.warn('è¯»å–æŠ˜å çŠ¶æ€å¤±è´¥:', e);
				}
			}
		}

		// ä¿å­˜æŠ˜å çŠ¶æ€
		function saveCollapseStates() {
			localStorage.setItem('graduateSimulator_collapseStates', JSON.stringify(collapseStates));
		}

		// åˆ‡æ¢æŠ˜å çŠ¶æ€
		function toggleCollapse(panelId) {
			const content = document.getElementById(`${panelId}-content`);
			const icon = document.getElementById(`${panelId}-collapse-icon`);
			const panel = document.getElementById(panelId);
			
			if (!content) {
				console.warn(`æ‰¾ä¸åˆ°é¢æ¿å†…å®¹: ${panelId}-content`);
				return;
			}
			
			const isCollapsed = content.classList.toggle('collapsed');
			collapseStates[panelId] = isCollapsed;
			
			// æ›´æ–°å›¾æ ‡
			if (icon) {
				icon.classList.toggle('rotated', isCollapsed);
			}
			
			// æ›´æ–°é¢æ¿æ ·å¼
			if (panel) {
				panel.classList.toggle('panel-collapsed', isCollapsed);
			}
			
			saveCollapseStates();
		}

		// åº”ç”¨ä¿å­˜çš„æŠ˜å çŠ¶æ€
		function applyCollapseStates() {
			for (const [panelId, isCollapsed] of Object.entries(collapseStates)) {
				const content = document.getElementById(`${panelId}-content`);
				const icon = document.getElementById(`${panelId}-collapse-icon`);
				const panel = document.getElementById(panelId);
				
				if (content && isCollapsed) {
					content.classList.add('collapsed');
					if (icon) {
						icon.classList.add('rotated');
					}
					if (panel) {
						panel.classList.add('panel-collapsed');
					}
				}
			}
		}

		// å±•å¼€æ‰€æœ‰é¢æ¿
		function expandAllPanels() {
			const panelIds = ['graduation-panel', 'attributes-panel', 'research-panel', 
							  'log-panel', 'buff-panel', 'action-panel', 'workstation-panel'];
			
			panelIds.forEach(panelId => {
				const content = document.getElementById(`${panelId}-content`);
				const icon = document.getElementById(`${panelId}-collapse-icon`);
				const panel = document.getElementById(panelId);
				
				if (content) {
					content.classList.remove('collapsed');
					collapseStates[panelId] = false;
				}
				if (icon) {
					icon.classList.remove('rotated');
				}
				if (panel) {
					panel.classList.remove('panel-collapsed');
				}
			});
			
			saveCollapseStates();
		}

		// æ”¶èµ·æ‰€æœ‰é¢æ¿
		function collapseAllPanels() {
			const panelIds = ['graduation-panel', 'attributes-panel', 'research-panel', 
							  'log-panel', 'buff-panel', 'action-panel', 'workstation-panel'];
			
			panelIds.forEach(panelId => {
				const content = document.getElementById(`${panelId}-content`);
				const icon = document.getElementById(`${panelId}-collapse-icon`);
				const panel = document.getElementById(panelId);
				
				if (content) {
					content.classList.add('collapsed');
					collapseStates[panelId] = true;
				}
				if (icon) {
					icon.classList.add('rotated');
				}
				if (panel) {
					panel.classList.add('panel-collapsed');
				}
			});
			
			saveCollapseStates();
		}

		// åˆ‡æ¢å…¨éƒ¨å±•å¼€/æ”¶èµ·
		let allCollapsed = false;
		function toggleAllPanels() {
			if (allCollapsed) {
				expandAllPanels();
				allCollapsed = false;
				document.getElementById('collapse-all-btn-text').textContent = 'æ”¶èµ·å…¨éƒ¨';
				document.getElementById('collapse-all-btn-icon').className = 'fas fa-compress-alt';
			} else {
				collapseAllPanels();
				allCollapsed = true;
				document.getElementById('collapse-all-btn-text').textContent = 'å±•å¼€å…¨éƒ¨';
				document.getElementById('collapse-all-btn-icon').className = 'fas fa-expand-alt';
			}
		}

		// ==================== å¼€å§‹é¡µé¢æŠ˜å åŠŸèƒ½ ====================

		// å¼€å§‹é¡µé¢åŒºå—æŠ˜å çŠ¶æ€
		const startSectionStates = {};

		function initStartSectionStates() {
			const saved = localStorage.getItem('graduateSimulator_startSections');
			if (saved) {
				try {
					Object.assign(startSectionStates, JSON.parse(saved));
				} catch (e) {
					console.warn('è¯»å–å¼€å§‹é¡µé¢æŠ˜å çŠ¶æ€å¤±è´¥:', e);
				}
			}
		}

		function saveStartSectionStates() {
			localStorage.setItem('graduateSimulator_startSections', JSON.stringify(startSectionStates));
		}

		function toggleStartSection(sectionId) {
			const body = document.getElementById(`${sectionId}-body`);
			const icon = document.getElementById(`${sectionId}-collapse-icon`);
			const header = body?.previousElementSibling;
			
			if (!body) {
				console.warn(`æ‰¾ä¸åˆ°åŒºå—: ${sectionId}-body`);
				return;
			}
			
			const isCollapsed = body.classList.toggle('collapsed');
			startSectionStates[sectionId] = isCollapsed;
			
			if (header) {
				header.classList.toggle('collapsed', isCollapsed);
			}
			
			if (icon) {
				icon.style.transform = isCollapsed ? 'rotate(-90deg)' : 'rotate(0deg)';
			}
			
			saveStartSectionStates();
		}

		function applyStartSectionStates() {
			for (const [sectionId, isCollapsed] of Object.entries(startSectionStates)) {
				const body = document.getElementById(`${sectionId}-body`);
				const icon = document.getElementById(`${sectionId}-collapse-icon`);
				const header = body?.previousElementSibling;
				
				if (body && isCollapsed) {
					body.classList.add('collapsed');
					if (header) header.classList.add('collapsed');
					if (icon) icon.style.transform = 'rotate(-90deg)';
				}
			}
		}
	
        // ==================== æ¸¸æˆæ•°æ® ====================
		 const characters = [
		{ 
			id: 'normal', 
			name: 'å¤§å¤šæ•°', 
			icon: 'ğŸ‘¤', 
			awakenIcon: 'ğŸ”¥',
			desc: 'èŠ¸èŠ¸ä¼—ç”Ÿä¸­çš„æ™®é€šä¸€å‘˜', 
			bonus: 'æ— ç‰¹æ®Šèƒ½åŠ›', 
			awakenName: 'æˆ‘å‘½ç”±æˆ‘ä¸ç”±å¤©',
			awakenDesc: 'è½¬åšæ—¶æ‰€æœ‰å±æ€§Ã—2', 
			// éšè—è§‰é†’
			hiddenAwakenName: 'å‹¤èƒ½è¡¥æ‹™',
			hiddenAwakenIcon: 'ğŸ’ª',
			hiddenAwakenDesc: 'æ¯ä¸ªæœˆè¡ŒåŠ¨æ¬¡æ•°+1ï¼ˆçœ‹è®ºæ–‡ã€å†™è®ºæ–‡ã€æƒ³ideaã€æ‰“å·¥ã€åšå®éªŒå¯ä»¥åš2æ¬¡ï¼‰',
			hiddenAwakenCondition: (gs) => gs.research <= 3 && gs.favor <= 3 && gs.social <= 3,
			stats: { research: 0, social: 0, favor: 0, gold: 0 },
			reversed: {
				name: 'æ€ æƒ°ä¹‹ã€Šå¤§å¤šæ•°ã€‹',
				icon: 'ğŸ˜´',
				awakenIcon: 'ğŸ’€',
				desc: 'æ‡’æƒ°æ˜¯åŸç½ªï¼Œä¹Ÿæ˜¯æŠ¤ç›¾',
				bonus: 'SANå‡å°‘ç¿»å€ï¼Œåˆå§‹å±æ€§å…¨5ï¼Œæ¯æœˆSAN+3',
				awakenName: 'æè‡´æ€ æƒ°',
				awakenDesc: 'è½¬åšæ—¶å±æ€§ç¿»å€ã€‚SANå‡å°‘3å€ï¼Œæ¯æœˆSAN+4',
				stats: { research: 4, social: 4, favor: 4, gold: 4 }
			}
		},
		{ 
			id: 'genius', 
			name: 'é™¢å£«è½¬ä¸–', 
			icon: 'ğŸ”¬', 
			awakenIcon: 'ğŸ§¬',
			desc: 'å¤©ç”Ÿå°±æ˜¯åšç§‘ç ”çš„æ–™', 
			bonus: 'ç§‘ç ”èƒ½åŠ›åˆå§‹+5', 
			awakenName: 'å­¦æœ¯å¤©èµ‹è§‰é†’',
			awakenDesc: 'è½¬åšæ—¶æ¯æœ‰1ç¯‡Aç±»è®ºæ–‡ï¼Œç§‘ç ”+2',
			// éšè—è§‰é†’
			hiddenAwakenName: 'é¢„è§æœªæ¥çƒ­ç‚¹',
			hiddenAwakenIcon: 'ğŸ”®',
			hiddenAwakenDesc: 'è®ºæ–‡çš„ideaå’Œå®éªŒåˆ†æ•°æ¯æœˆä¸å†è¡°å‡',
			hiddenAwakenCondition: (gs) => gs.paperA === 0 && gs.paperB === 0,
			stats: { research: 5 },
			reversed: {
				name: 'æ„šé’ä¹‹ã€Šé™¢å£«è½¬ä¸–ã€‹',
				icon: 'ğŸ¤¡',
				awakenIcon: 'ğŸ­',
				desc: 'ç§‘ç ”æ˜¯ä»€ä¹ˆï¼Ÿèƒ½åƒå—ï¼Ÿ',
				bonus: 'ç§‘ç ”å›ºå®š0ï¼Œå…¨è®ºæ–‡æ§½ï¼Œç§‘ç ”æå‡â†’é‡‘+4,SAN+4,ç¤¾äº¤+1,å¥½æ„Ÿ+1',
				awakenName: 'å¤§æ™ºè‹¥æ„š',
				awakenDesc: 'ç§‘ç ”æå‡â†’é‡‘+8,SAN+8,ç¤¾äº¤+2,å¥½æ„Ÿ+2',
				stats: {}
			}
		},
		{ 
			id: 'social', 
			name: 'ç¤¾äº¤è¾¾äºº', 
			icon: 'ğŸ¤', 
			awakenIcon: 'ğŸŒ',
			desc: 'å…«é¢ç²ç‘çš„ç¤¾äº¤é«˜æ‰‹', 
			bonus: 'ç¤¾äº¤èƒ½åŠ›åˆå§‹+5', 
			awakenName: 'äººè„‰ç½‘ç»œæ¿€æ´»',
			awakenDesc: 'è½¬åšæ—¶æ ¹æ®ç¤¾äº¤èƒ½åŠ›æ”¹å˜å®¡ç¨¿äººåˆ†å¸ƒ',
			// éšè—è§‰é†’
			hiddenAwakenName: 'å¸ˆå…„å¸ˆå§æ•‘æˆ‘',
			hiddenAwakenIcon: 'ğŸ†˜',
			hiddenAwakenDesc: 'è·å¾—ä¸»åŠ¨æŠ€èƒ½ï¼ˆé™ç”¨1æ¬¡ï¼‰ï¼šä¸‹æ¬¡æƒ³ideaæ—¶ï¼Œç§‘ç ”èƒ½åŠ›è§†ä¸ºç§‘ç ”+ç¤¾äº¤',
			hiddenAwakenCondition: (gs) => gs.social <= 6,
			stats: { social: 5 },
			reversed: {
				name: 'å«‰å¦’ä¹‹ã€Šç¤¾äº¤è¾¾äººã€‹',
				icon: 'ğŸ',
				awakenIcon: 'ğŸ‘ï¸',
				desc: 'è§ä¸å¾—åˆ«äººå¥½ï¼Œä¹Ÿè§ä¸å¾—è‡ªå·±å·®',
				bonus: 'ç¤¾äº¤åˆå§‹5ï¼Œç¤¾äº¤-1â†’ç§‘ç ”+1,å¥½æ„Ÿ+1 | ç¤¾äº¤+1â†’SAN+1,é‡‘+1',
				awakenName: 'å«‰å¦’é‡ç½®',
				awakenDesc: 'è½¬åšæ—¶ç¤¾äº¤èƒ½åŠ›å˜ä¸º5',
				stats: { social: 4 }
			}
		},
		{ 
			id: 'rich', 
			name: 'å¯Œå¯æ•Œå›½', 
			icon: 'ğŸ’°', 
			awakenIcon: 'ğŸ’',
			desc: 'å®¶å¢ƒæ®·å®æ— å¿§æ— è™‘', 
			bonus: 'é‡‘å¸å€¼åˆå§‹+5', 
			awakenName: 'è´¢å¯Œå€å¢æœ¯',
			awakenDesc: 'è½¬åšæ—¶é‡‘å¸Ã—3',
			// éšè—è§‰é†’
			hiddenAwakenName: 'ä¸æ±‚æš´å¯Œä½†æ±‚ç¨³å®š',
			hiddenAwakenIcon: 'ğŸ¦',
			hiddenAwakenDesc: 'æ¯æœˆå·¥èµ„+1',
			hiddenAwakenCondition: (gs) => gs.gold <= 2,
			stats: { gold: 5 },
			reversed: {
				name: 'è´ªæ±‚ä¹‹ã€Šå¯Œå¯æ•Œå›½ã€‹',
				icon: 'ğŸ´â€â˜ ï¸',
				awakenIcon: 'ğŸ’¸',
				desc: 'é™¤äº†é’±ä¸€æ— æ‰€æœ‰',
				bonus: 'æ¯æœˆSAN/ç§‘ç ”/ç¤¾äº¤/å¥½æ„Ÿé‡ç½®ä¸º1ï¼Œæ¯æœˆé‡‘é’±+3',
				awakenName: 'é‡‘é’±çš„åŠ›é‡',
				awakenDesc: 'åŠå¹´é‡ç½®ä¸€æ¬¡ï¼Œæ¯èŠ±è´¹4é‡‘å¸å±æ€§å„+1ï¼Œæ¯æœˆé‡‘é’±+3',
				stats: {}
			}
		},
		{ 
			id: 'teacher-child', 
			name: 'å¯¼å¸ˆå­å¥³', 
			icon: 'ğŸ‘¨â€ğŸ‘§', 
			awakenIcon: 'ğŸ‘‘',
			desc: 'è¿‘æ°´æ¥¼å°å…ˆå¾—æœˆ', 
			bonus: 'å¯¼å¸ˆå¥½æ„Ÿåº¦åˆå§‹+5', 
			awakenName: 'è¡€è„‰å…±é¸£',
			awakenDesc: 'è½¬åšæ—¶å¥½æ„Ÿåº¦è¶…12çš„éƒ¨åˆ†è½¬åŒ–ä¸ºç§‘ç ”å’Œé‡‘å¸',
			// éšè—è§‰é†’
			hiddenAwakenName: 'å¯¼å¸ˆæ•‘æˆ‘',
			hiddenAwakenIcon: 'ğŸ›¡ï¸',
			hiddenAwakenDesc: 'è·å¾—ä¸»åŠ¨æŠ€èƒ½ï¼ˆé™ç”¨1æ¬¡ï¼‰ï¼šä¸‹æ¬¡æƒ³ideaæ—¶ï¼Œç§‘ç ”èƒ½åŠ›è§†ä¸ºç§‘ç ”+å¥½æ„Ÿåº¦',
			hiddenAwakenCondition: (gs) => gs.favor <= 6,
			stats: { favor: 5 },
			reversed: {
				name: 'ç©ä¸–ä¹‹ã€Šå¯¼å¸ˆå­å¥³ã€‹',
				icon: 'ğŸª',
				awakenIcon: 'ğŸƒ',
				desc: 'å›é€†æ˜¯æˆ‘çš„ä»£åè¯',
				bonus: 'å¥½æ„Ÿä¸ä¼šä½äº0ï¼Œå¥½æ„Ÿå½’0â†’é‡ç½®ä¸º4ï¼Œç¤¾äº¤+1ï¼Œç§‘ç ”+1ï¼Œé‡‘+2',
				awakenName: 'å˜æœ¬åŠ å‰',
				awakenDesc: 'å¥½æ„Ÿå½’0â†’é‡ç½®ä¸º2ï¼Œç¤¾äº¤+1ï¼Œç§‘ç ”+1ï¼Œé‡‘+2',
				stats: { favor: 0 }
			}
		},
		{ 
			id: 'chosen', 
			name: 'å¤©é€‰ä¹‹äºº', 
			icon: 'â­', 
			awakenIcon: 'âœ¨',
			desc: 'å‘½è¿çš„å® å„¿å…¨é¢å‘å±•', 
			bonus: 'ç§‘ç ”+2 ç¤¾äº¤+2 å¥½æ„Ÿ+2 é‡‘å¸+2', 
			awakenName: 'æŸ¥ç¼ºè¡¥æ¼',
			awakenDesc: 'è½¬åšæ—¶è¡¥é½æ‰€æœ‰çŸ­æ¿',
			// éšè—è§‰é†’
			hiddenAwakenName: 'å­¤æ³¨ä¸€æ·',
			hiddenAwakenIcon: 'ğŸ¯',
			hiddenAwakenDesc: 'é€‰æ‹©ä¸€é¡¹å±æ€§ï¼Œå…¶ä»–ä¸¤é¡¹å˜ä¸º1å¹¶å°†å€¼è½¬åŒ–åˆ°è¯¥å±æ€§',
			hiddenAwakenCondition: (gs) => gs.research === gs.social && gs.social === gs.favor,
			stats: { research: 2, social: 2, favor: 2, gold: 2 },
			reversed: {
				name: 'ç©ºæƒ³ä¹‹ã€Šå¤©é€‰ä¹‹äººã€‹',
				icon: 'ğŸŒ€',
				awakenIcon: 'ğŸ²',
				desc: 'å‘½è¿æ˜¯ä¸€åœºè½®ç›˜èµŒ',
				bonus: 'æ¯æœˆ:ç§‘ç ”/ç¤¾äº¤/å¥½æ„Ÿéšæœºäº¤æ¢ï¼ŒSAN/é‡‘éšæœºäº¤æ¢ï¼Œå¯çªç ´å±æ€§ä¸Šé™',
				awakenName: 'å‘½è¿è½®ç›˜',
				awakenDesc: 'æ¯æœˆ:ç§‘ç ”/ç¤¾äº¤/å¥½æ„Ÿ/SAN/é‡‘å…¨éƒ¨éšæœºäº¤æ¢ï¼Œå¯çªç ´å±æ€§ä¸Šé™',
				stats: {}
			}
		}
	];

        const paperTitleWords = {
            adjectives: ['Deep', 'Neural', 'Efficient', 'Scalable', 'Robust', 'Adaptive', 'Dynamic', 'Multi-modal', 'Self-supervised', 'Federated', 'Attention-based', 'Graph-based', 'Hierarchical', 'Contrastive', 'Progressive', 'Unified'],
            nouns: ['Learning', 'Networks', 'Transformers', 'Models', 'Representations', 'Framework', 'Architecture', 'Approach', 'Method', 'System', 'Embeddings', 'Reasoning', 'Generation', 'Recognition'],
            verbs: ['Understanding', 'Generating', 'Predicting', 'Detecting', 'Recognizing', 'Synthesizing', 'Optimizing', 'Training', 'Enhancing', 'Improving'],
            domains: ['Vision', 'Language', 'Speech', 'Text', 'Images', 'Videos', 'Knowledge', 'Data', 'Graphs', 'Medical', '3D', 'Autonomous']
        };

        const ALL_BUFF_TYPES = [
            'monthly_san', 'exp_times', 'write_san_reduce', 'read_san_reduce',
            'idea_bonus', 'exp_bonus', 'write_bonus', 'idea_times', 'write_times', 'citation_multiply'
        ];

		const ALL_ACHIEVEMENTS = [
			'ğŸ’• å–œç»“è‰¯ç¼˜', 'ğŸ’° å®¶è´¢ä¸‡è´¯', 'â¬¡ å…­è¾¹å½¢æˆ˜å£«', 'ğŸ† è¯ºå¥–é€‰æ‰‹', 
			'ğŸŒ¸ äº¤é™…èŠ±', 'ğŸ¤ é“æ†å¸ˆç”Ÿ', 'âš¡ ç²¾åŠ›æ»¡æ»¡', 'ğŸ¯ ç™¾å‘ç™¾ä¸­', 
			'â˜• æˆ‘çˆ±èŒ¶æ­‡', 'ğŸ–ï¸ å…¬è´¹æ—…æ¸¸', 'ğŸ¤– è®ºæ–‡æœºå™¨',
			'ğŸ“š åƒå¼•å¤§ä½¬', 'â˜• å’–å•¡çˆ±å¥½è€…', 'âœ¨ Buffä¹‹ç¥',
			'ğŸ“œ é«˜åˆ†è®ºæ–‡', 'ğŸ€ å¹¸è¿å„¿', 'ğŸ˜­ å€’éœ‰è›‹',
			'ğŸ» æ›²é«˜å’Œå¯¡', 'ğŸ’ª å…¨åŠ›ä»¥èµ´', 'ğŸ† å…¨æ”¶é›†',
			'ğŸ‘Š è¶Šæˆ˜è¶Šå‹‡', 'ğŸ§  äººé—´æ¸…é†’', 'ğŸ”¥ ç«åŠ›å…¨å¼€',
			'ğŸš é£Ÿä¹‹æ— å‘³', 'ğŸ¤– æœºæ¢°é£å‡', 'ğŸ›‹ï¸ å…¨å¥—å®¶å…·',
			'ğŸ§’ å¤©æ‰å°‘å¹´',
			'ğŸ’ æ— æ³•åŸ‹æ²¡', 'ğŸ”” ä¸é¸£åˆ™å·²', 'ğŸ“Š ä¸¥é‡åç§‘', 'ğŸ’¼ æ‰“å·¥ç‹‚äºº', 'ğŸ“– çˆ±çœ‹è®ºæ–‡', 'ğŸ¹ ä¸€ç®­åŒé›•',
		];

        // ç»“å±€åç§°æ˜ å°„
		const ENDING_NAMES = {
			'quit': 'ğŸšª ä¸»åŠ¨é€€å­¦',
			'burnout': 'ğŸ˜¢ ä¸å ªé‡è´Ÿ',
			'expelled': 'ğŸ˜­ é€å‡ºå¸ˆé—¨',
			'poor': 'ğŸ’¸ ç©·å›°æ½¦å€’',
			'delay': 'â° å»¶æ¯•',
			'isolated': 'ğŸ˜” è¢«å­¤ç«‹', 
			'master': 'ğŸ“ ç¡•å£«æ¯•ä¸š',
			'excellent_master': 'ğŸŒŸ ä¼˜ç§€ç¡•å£«',
			'phd': 'ğŸ“ åšå£«æ¯•ä¸š',
			'excellent_phd': 'ğŸ† ä¼˜ç§€åšå£«',
			'green_pepper': 'ğŸŒ¶ï¸ é’æ¤’',
			'become_advisor': 'ğŸ‘¨â€ğŸ« æˆ‘å°±æ˜¯å¯¼å¸ˆ',
			'academic_star': 'â­ å­¦æœ¯ä¹‹æ˜Ÿ',
			'future_academician': 'ğŸ‘‘ æœªæ¥é™¢å£«',
			// çœŸå®ç»“å±€
			'true_phd': 'ğŸŒŸ çœŸÂ·åšå£«æ¯•ä¸š',  
			'true_devotion': 'ğŸ’« çœŸÂ·æŠ•èº«å­¦æœ¯', 
			'true_life': 'ğŸŒˆ çœŸÂ·æ„Ÿå—ç”Ÿæ´»',
		};

        // å›°éš¾ç»“å±€ï¼ˆåšå£«æ¯•ä¸šåŠä»¥ä¸Šï¼‰
		const HARD_ENDINGS = ['phd', 'excellent_phd', 'green_pepper', 'become_advisor', 'academic_star', 'future_academician', 'true_phd', 'true_devotion', 'true_life'];

        // ç»“å±€è¾¾æˆè¦æ±‚æ•°æ®
		const ENDING_REQUIREMENTS = {
			// ... ä¿ç•™åŸæœ‰å†…å®¹ ...
			'quit': 'ä¸»åŠ¨é€‰æ‹©é‡å¼€å¹¶ç¡®è®¤é€€å­¦',
			'burnout': 'SANå€¼é™ä¸ºè´Ÿæ•°',
			'expelled': 'å¯¼å¸ˆå¥½æ„Ÿåº¦é™ä¸ºè´Ÿæ•°',
			'poor': 'é‡‘å¸é™ä¸ºè´Ÿæ•°',
			'delay': 'æ¯•ä¸šæ—¶é—´åˆ°ä½†ç§‘ç ”åˆ†ä¸è¶³ï¼ˆç¡•å£«<1æˆ–åšå£«<7ï¼‰',
			'isolated': 'ç¤¾äº¤èƒ½åŠ›é™ä¸ºè´Ÿæ•°',
			'master': 'ç¡•å£«3å¹´å†…ç§‘ç ”åˆ†â‰¥1',
			'excellent_master': 'ç¡•å£«3å¹´å†…ç§‘ç ”åˆ†â‰¥4',
			'phd': 'åšå£«5å¹´å†…ç§‘ç ”åˆ†â‰¥7',
			'excellent_phd': 'åšå£«æ¯•ä¸šä¸”Aç±»è®ºæ–‡â‰¥3',
			'green_pepper': 'åšå£«æ¯•ä¸šä¸”Aç±»â‰¥4ã€å¼•ç”¨>500',
			'become_advisor': 'åšå£«æ¯•ä¸šä¸”Aç±»â‰¥5ã€å¼•ç”¨>1000',
			'academic_star': 'åšå£«æ¯•ä¸šä¸”Aç±»â‰¥5ã€å¼•ç”¨>1000ã€å¤§ç‰›è”åˆåŸ¹å…»',
			'future_academician': 'åšå£«æ¯•ä¸šä¸”Aç±»â‰¥5ã€å¼•ç”¨>2000ã€å¤§ç‰›è”åˆåŸ¹å…»',
			// çœŸå®ç»“å±€
			'true_phd': 'ä½¿ç”¨çœŸÂ·å¤§å¤šæ•°è§’è‰²ï¼Œåšå£«æ¯•ä¸šä¸”å‘è¡¨â‰¥3ç¯‡è®ºæ–‡',
			'true_devotion': 'ä½¿ç”¨çœŸÂ·å¤§å¤šæ•°è§’è‰²ï¼Œåšå£«æ¯•ä¸šä¸”æ€»å¼•ç”¨â‰¥1000',
			'true_life': 'ä½¿ç”¨çœŸÂ·å¤§å¤šæ•°è§’è‰²ï¼Œé¡ºåˆ©æ¯•ä¸šï¼ˆç¡•å£«æˆ–åšå£«ï¼‰ä¸”è¾¾æˆâ‰¥10ä¸ªæˆå°±ä¸”æ€»å¼•ç”¨<1000'
		};

        // æˆå°±è¾¾æˆè¦æ±‚æ•°æ®
		const ACHIEVEMENT_REQUIREMENTS = {
			'ğŸ’• å–œç»“è‰¯ç¼˜': 'é¡ºåˆ©æ¯•ä¸šä¸”ä¸å¼‚æ€§å­¦è€…å‘å±•ä¸ºæ‹äººå…³ç³»ï¼ˆç¤¾äº¤â‰¥12ååœ¨å¼€ä¼šæ—¶å¤šæ¬¡äº¤æµåŒä¸€äººï¼‰',
			'ğŸ’° å®¶è´¢ä¸‡è´¯': 'é¡ºåˆ©æ¯•ä¸šä¸”ç»“å±€æ—¶é‡‘å¸â‰¥30',
			'â¬¡ å…­è¾¹å½¢æˆ˜å£«': 'é¡ºåˆ©æ¯•ä¸šä¸”ç»“å±€æ—¶ç§‘ç ”ã€ç¤¾äº¤ã€å¥½æ„Ÿã€é‡‘å¸å‡>15',
			'ğŸ† è¯ºå¥–é€‰æ‰‹': 'é¡ºåˆ©æ¯•ä¸šä¸”ç§‘ç ”èƒ½åŠ›è¾¾åˆ°20',
			'ğŸŒ¸ äº¤é™…èŠ±': 'é¡ºåˆ©æ¯•ä¸šä¸”ç¤¾äº¤èƒ½åŠ›è¾¾åˆ°20',
			'ğŸ¤ é“æ†å¸ˆç”Ÿ': 'é¡ºåˆ©æ¯•ä¸šä¸”å¯¼å¸ˆå¥½æ„Ÿåº¦è¾¾åˆ°20',
			'âš¡ ç²¾åŠ›æ»¡æ»¡': 'é¡ºåˆ©æ¯•ä¸šä¸”ç»“å±€æ—¶SANå€¼â‰¥20',
			'ğŸ¯ ç™¾å‘ç™¾ä¸­': 'é¡ºåˆ©æ¯•ä¸šä¸”è®ºæ–‡ä»æœªè¢«æ‹’ç¨¿',
			'â˜• æˆ‘çˆ±èŒ¶æ­‡': 'é¡ºåˆ©æ¯•ä¸šä¸”åœ¨å¼€ä¼šäº‹ä»¶ä¸­é€‰æ‹©èŒ¶æ­‡+æ™šå®´â‰¥3æ¬¡',
			'ğŸ–ï¸ å…¬è´¹æ—…æ¸¸': 'é¡ºåˆ©æ¯•ä¸šä¸”åœ¨å¼€ä¼šäº‹ä»¶ä¸­é€‰æ‹©é¡ºä¾¿æ—…æ¸¸â‰¥3æ¬¡',
			'ğŸ¤– è®ºæ–‡æœºå™¨': 'é¡ºåˆ©æ¯•ä¸šä¸”å‘è¡¨è®ºæ–‡æ€»æ•°â‰¥10',
			'ğŸ“š åƒå¼•å¤§ä½¬': 'é¡ºåˆ©æ¯•ä¸šä¸”æ€»å¼•ç”¨æ•°â‰¥1000',
			'â˜• å’–å•¡çˆ±å¥½è€…': 'é¡ºåˆ©æ¯•ä¸šä¸”æ¯æœˆéƒ½è´­ä¹°å†°ç¾å¼',
			'âœ¨ Buffä¹‹ç¥': 'é¡ºåˆ©æ¯•ä¸šä¸”è§¦å‘è¿‡æ‰€æœ‰ç±»å‹çš„Buffæ•ˆæœ',
			'ğŸ“œ é«˜åˆ†è®ºæ–‡': 'é¡ºåˆ©æ¯•ä¸šä¸”è®ºæ–‡ä¸­ç¨¿å(å¯èƒ½çš„æ”¹è¿›å)åˆ†æ•°è¾¾åˆ°125',
			'ğŸ€ å¹¸è¿å„¿': 'é¡ºåˆ©æ¯•ä¸šä¸”è®ºæ–‡æ”¶åˆ°ä¸‰ä½å¤§ç‰›å®¡ç¨¿äººçš„ä¸€è‡´æ”¹è¿›',
			'ğŸ˜­ å€’éœ‰è›‹': 'é¡ºåˆ©æ¯•ä¸šä¸”ä¸‰ä¸ªå®¡ç¨¿äººéƒ½æ˜¯åå®¡ç¨¿äºº(æ¶æ„å°åŒè¡Œæˆ–è€…39ä¸ªé—®é¢˜å®¡ç¨¿äºº)',
			'ğŸ» æ›²é«˜å’Œå¯¡': 'é¡ºåˆ©æ¯•ä¸šä¸”åªä¸­è¿‡Aç±»è®ºæ–‡ï¼Œæ²¡æœ‰Bå’ŒC',
			'ğŸ’ª å…¨åŠ›ä»¥èµ´': 'é¡ºåˆ©æ¯•ä¸šä¸”æ¯•ä¸šæ—¶SANå’Œé‡‘é’±éƒ½ä¸º0',
			'ğŸ† å…¨æ”¶é›†': 'é¡ºåˆ©æ¯•ä¸šä¸”æ¯•ä¸šæ—¶ä¸­ç¨¿A,B,Cçš„posterï¼Œoralï¼Œbest paperå…±9ç±»è®ºæ–‡',
			'ğŸ‘Š è¶Šæˆ˜è¶Šå‹‡': 'é¡ºåˆ©æ¯•ä¸šä¸”æ¯•ä¸šæ—¶è‡³å°‘è¢«æ‹’ç¨¿5æ¬¡',
			'ğŸ§  äººé—´æ¸…é†’': 'é¡ºåˆ©æ¯•ä¸šä¸”æ‹¥æœ‰ä¸¤æ¬¡è½¬åšæœºä¼šéƒ½æ‹’ç»äº†',
			'ğŸ”¥ ç«åŠ›å…¨å¼€': 'é¡ºåˆ©æ¯•ä¸šä¸”è®ºæ–‡æ§½ä½åŒæ—¶æœ‰4ç¯‡è®ºæ–‡åœ¨å®¡',
			'ğŸš é£Ÿä¹‹æ— å‘³': 'é¡ºåˆ©æ¯•ä¸šä¸”ä¸€ç¯‡è®ºæ–‡è¢«è¿ç»­æ‹’ç¨¿3æ¬¡',
			'ğŸ¤– æœºæ¢°é£å‡': 'é¡ºåˆ©æ¯•ä¸šä¸”å•†åº—è´­ä¹°5å°GPUæœåŠ¡å™¨',
			'ğŸ›‹ï¸ å…¨å¥—å®¶å…·': 'é¡ºåˆ©æ¯•ä¸šä¸”è´­ä¹°å·¥å­¦æ¤…+æ˜¾ç¤ºå™¨+é”®ç›˜',
			'ğŸ§’ å¤©æ‰å°‘å¹´': 'é¡ºåˆ©æ¯•ä¸šä¸”è½¬åšæ—¶å°±è¾¾åˆ°åšå£«æ¯•ä¸šè¦æ±‚',
			'ğŸ’ æ— æ³•åŸ‹æ²¡': 'é¡ºåˆ©æ¯•ä¸šä¸”å•ç¯‡Cç±»è®ºæ–‡å¼•ç”¨è¶…è¿‡100',
			'ğŸ”” ä¸é¸£åˆ™å·²': 'é¡ºåˆ©æ¯•ä¸šä¸”ç¬¬ä¸€ç¯‡è®ºæ–‡å¼•ç”¨è¶…è¿‡200',
			'ğŸ“Š ä¸¥é‡åç§‘': 'é¡ºåˆ©æ¯•ä¸šä¸”æ¯•ä¸šæ—¶ç§‘ç ”èƒ½åŠ›ã€å¯¼å¸ˆå¥½æ„Ÿåº¦ã€ç¤¾äº¤èƒ½åŠ›æœ€é«˜å’Œæœ€ä½çš„å·®è·è¶…è¿‡12',
			'ğŸ’¼ æ‰“å·¥ç‹‚äºº': 'é¡ºåˆ©æ¯•ä¸šä¸”æ¯•ä¸šæ—¶è‡³å°‘æ‰“å·¥10æ¬¡',
			'ğŸ“– çˆ±çœ‹è®ºæ–‡': 'é¡ºåˆ©æ¯•ä¸šä¸”æ¯•ä¸šæ—¶è‡³å°‘çœ‹20æ¬¡è®ºæ–‡',
			'ğŸ¹ ä¸€ç®­åŒé›•': 'é¡ºåˆ©æ¯•ä¸šä¸”æ›¾åœ¨ä¸€ä¸ªä¼šè®®åŒæ—¶ä¸­ç¨¿â‰¥2ç¯‡è®ºæ–‡',
		};

        // å•†åº—ç‰©å“
		const shopItems = [
			{ id: 'coffee', name: 'å†°ç¾å¼', desc: 'SANå€¼+3', price: 2, monthlyOnce: true, boughtThisMonth: false },
			{ id: 'gemini', name: 'Geminiè®¢é˜…', desc: 'æœ¬æœˆæƒ³ideaæ—¶SAN-1ï¼Œåˆ†æ•°+4', price: 2, monthlyOnce: true, boughtThisMonth: false },
			{ id: 'gpt', name: 'GPTè®¢é˜…', desc: 'æœ¬æœˆåšå®éªŒæ—¶SAN-1ï¼Œåˆ†æ•°+4', price: 4, monthlyOnce: true, boughtThisMonth: false },
			{ id: 'claude', name: 'Claudeè®¢é˜…', desc: 'æœ¬æœˆå†™è®ºæ–‡æ—¶SAN-1ï¼Œåˆ†æ•°+4', price: 3, monthlyOnce: true, boughtThisMonth: false },
			{ id: 'gpu_rent', name: 'ç§ŸGPUæœåŠ¡å™¨', desc: 'æœ¬æœˆåšå®éªŒå¤šåš1æ¬¡', price: 2, once: false },
			{ id: 'gpu_buy', name: 'è´­ä¹°GPUæœåŠ¡å™¨', desc: 'æ°¸ä¹…buff-æ¯æ¬¡åšå®éªŒå¤šåš1æ¬¡', price: 12, once: false },
			{ id: 'chair', name: 'äººä½“å·¥å­¦æ¤…', desc: 'æ°¸ä¹…buff-æ¯æœˆSANå€¼+1', price: 10, once: true, bought: false },
			{ id: 'keyboard', name: 'æœºæ¢°é”®ç›˜', desc: 'æ°¸ä¹…buff-å†™è®ºæ–‡å˜ä¸ºSAN-3', price: 8, once: true, bought: false },
			{ id: 'monitor', name: '4Kæ˜¾ç¤ºå™¨', desc: 'æ°¸ä¹…buff-è¯»è®ºæ–‡å˜ä¸ºSAN-1', price: 8, once: true, bought: false }
		];
		
		// ==================== ä¼šè®®é…ç½® ====================
		const CONFERENCES = {
			1: {  // ç°å®9æœˆ
				A: { name: 'ICLR', fullName: 'International Conference on Learning Representations', field: 'æ·±åº¦å­¦ä¹ ' },
				B: { name: 'ICRA', fullName: 'International Conference on Robotics and Automation', field: 'æœºå™¨äºº' },
				C: { name: 'WACV', fullName: 'Winter Conference on Applications of Computer Vision', field: 'è®¡ç®—æœºè§†è§‰' }
			},
			2: {  // ç°å®10æœˆ
				A: { name: 'WWW', fullName: 'The Web Conference', field: 'ä¸‡ç»´ç½‘' },
				B: { name: 'NAACL', fullName: 'North American Chapter of ACL', field: 'è‡ªç„¶è¯­è¨€å¤„ç†' },
				C: { name: 'MMAsia', fullName: 'ACM Multimedia Asia', field: 'å¤šåª’ä½“' }
			},
			3: {  // ç°å®11æœˆ
				A: { name: 'CVPR', fullName: 'Conference on Computer Vision and Pattern Recognition', field: 'è®¡ç®—æœºè§†è§‰' },
				B: { name: 'CIKM', fullName: 'Conference on Information and Knowledge Management', field: 'ä¿¡æ¯ç®¡ç†' },
				C: { name: 'ICDAR', fullName: 'International Conference on Document Analysis and Recognition', field: 'æ–‡æ¡£åˆ†æ' }
			},
			4: {  // ç°å®12æœˆ
				A: { name: 'ACL', fullName: 'Annual Meeting of the Association for Computational Linguistics', field: 'è‡ªç„¶è¯­è¨€å¤„ç†' },
				B: { name: 'ICONIP', fullName: 'International Conference on Neural Information Processing', field: 'ç¥ç»ç½‘ç»œ' },
				C: { name: 'ICPR', fullName: 'International Conference on Pattern Recognition', field: 'æ¨¡å¼è¯†åˆ«' }
			},
			5: {  // ç°å®1æœˆ
				A: { name: 'IJCAI', fullName: 'International Joint Conference on Artificial Intelligence', field: 'äººå·¥æ™ºèƒ½' },
				B: { name: 'ICME', fullName: 'IEEE International Conference on Multimedia and Expo', field: 'å¤šåª’ä½“' },
				C: { name: 'ICIP', fullName: 'IEEE International Conference on Image Processing', field: 'å›¾åƒå¤„ç†' }
			},
			6: {  // ç°å®2æœˆ
				A: { name: 'ICML', fullName: 'International Conference on Machine Learning', field: 'æœºå™¨å­¦ä¹ ' },
				B: { name: 'COLT', fullName: 'Conference on Learning Theory', field: 'å­¦ä¹ ç†è®º' },
				C: { name: 'IJCNN', fullName: 'International Joint Conference on Neural Networks', field: 'ç¥ç»ç½‘ç»œ' }
			},
			7: {  // ç°å®3æœˆ
				A: { 
					name: 'ICCV/ECCV',
					alternates: {
						odd: { name: 'ICCV', fullName: 'International Conference on Computer Vision' },
						even: { name: 'ECCV', fullName: 'European Conference on Computer Vision' }
					},
					field: 'è®¡ç®—æœºè§†è§‰'
				},
				B: { name: 'ISCA', fullName: 'Annual Conference of ISCA', field: 'è¯­éŸ³' },
				C: { name: 'IROS', fullName: 'IEEE/RSJ International Conference on Intelligent Robots and Systems', field: 'æœºå™¨äºº' }
			},
			8: {  // ç°å®4æœˆ
				A: { name: 'ACM MM', fullName: 'ACM International Conference on Multimedia', field: 'å¤šåª’ä½“' },
				B: { name: 'EACL', fullName: 'European Chapter of ACL', field: 'è‡ªç„¶è¯­è¨€å¤„ç†' },
				C: { name: 'IJCB', fullName: 'International Joint Conference on Biometrics', field: 'ç”Ÿç‰©è¯†åˆ«' }
			},
			9: {  // ç°å®5æœˆ
				A: { name: 'NeurIPS', fullName: 'Conference on Neural Information Processing Systems', field: 'æœºå™¨å­¦ä¹ ' },
				B: { name: 'ECAI', fullName: 'European Conference on Artificial Intelligence', field: 'äººå·¥æ™ºèƒ½' },
				C: { name: 'BMVC', fullName: 'British Machine Vision Conference', field: 'è®¡ç®—æœºè§†è§‰' }
			},
			10: {  // ç°å®6æœˆ
				A: { name: 'EMNLP', fullName: 'Conference on Empirical Methods in Natural Language Processing', field: 'è‡ªç„¶è¯­è¨€å¤„ç†' },
				B: { name: 'CoNLL', fullName: 'Conference on Computational Natural Language Learning', field: 'è‡ªç„¶è¯­è¨€' },
				C: { name: 'PRCV', fullName: 'Chinese Conference on Pattern Recognition and Computer Vision', field: 'æ¨¡å¼è¯†åˆ«' }
			},
			11: {  // ç°å®7æœˆ
				A: { name: 'COLING', fullName: 'International Conference on Computational Linguistics', field: 'è®¡ç®—è¯­è¨€å­¦' },
				B: { name: 'RSS', fullName: 'Robotics: Science and Systems', field: 'æœºå™¨äºº' },
				C: { name: 'ACCV', fullName: 'Asian Conference on Computer Vision', field: 'è®¡ç®—æœºè§†è§‰' }
			},
			12: {  // ç°å®8æœˆ
				A: { name: 'AAAI', fullName: 'AAAI Conference on Artificial Intelligence', field: 'äººå·¥æ™ºèƒ½' },
				B: { name: 'ICMR', fullName: 'ACM International Conference on Multimedia Retrieval', field: 'å¤šåª’ä½“æ£€ç´¢' },
				C: { name: '3DV', fullName: 'International Conference on 3D Vision', field: 'ä¸‰ç»´è§†è§‰' }
			}
		};

        const CONFERENCE_LOCATIONS = [
            // åŒ—ç¾
            { city: 'San Francisco', country: 'USA' },
            { city: 'Seattle', country: 'USA' },
            { city: 'New Orleans', country: 'USA' },
            { city: 'Vancouver', country: 'Canada' },
            { city: 'Montreal', country: 'Canada' },
            { city: 'New York', country: 'USA' },
            { city: 'Miami', country: 'USA' },
            { city: 'Honolulu', country: 'USA' },
            { city: 'San Diego', country: 'USA' },
            { city: 'Boston', country: 'USA' },
            { city: 'Los Angeles', country: 'USA' },
            { city: 'Toronto', country: 'Canada' },
            // æ¬§æ´²
            { city: 'Barcelona', country: 'Spain' },
            { city: 'Vienna', country: 'Austria' },
            { city: 'Amsterdam', country: 'Netherlands' },
            { city: 'Paris', country: 'France' },
            { city: 'Munich', country: 'Germany' },
            { city: 'London', country: 'UK' },
            { city: 'Florence', country: 'Italy' },
            { city: 'Dublin', country: 'Ireland' },
            { city: 'Stockholm', country: 'Sweden' },
            { city: 'Zurich', country: 'Switzerland' },
            { city: 'Edinburgh', country: 'UK' },
            { city: 'Milan', country: 'Italy' },
            // äºšå¤ª
            { city: 'Singapore', country: 'Singapore' },
            { city: 'Tokyo', country: 'Japan' },
            { city: 'Seoul', country: 'South Korea' },
            { city: 'Hong Kong', country: 'China' },
            { city: 'Beijing', country: 'China' },
            { city: 'Shanghai', country: 'China' },
            { city: 'Sydney', country: 'Australia' },
            { city: 'Melbourne', country: 'Australia' },
            { city: 'Taipei', country: 'Taiwan' },
            { city: 'Bangkok', country: 'Thailand' },
            { city: 'Kyoto', country: 'Japan' },
            { city: 'Shenzhen', country: 'China' }
        ];
	
		
        // ==================== æ¸¸æˆçŠ¶æ€ ====================
        let gameState = {};
        let selectedCharacter = null;
        let isReversedMode = false;
        let characterDifficultyData = {};
        let currentEndingData = null;
		
		let isTrueNormalMode = false;  // æ˜¯å¦é€‰æ‹©äº†çœŸÂ·å¤§å¤šæ•°æ¨¡å¼

		function getInitialState() {
			return {
				character: null,
				characterName: '',
				degree: 'master',
				year: 1,
				month: 1,
				totalMonths: 0,
				maxYears: 3,
				san: 20,
				sanMax: 20,
				research: 1,
				social: 1,
				favor: 1,
				gold: 1,
				paperA: 0,
				paperB: 0,
				paperC: 0,
				totalScore: 0,
				totalCitations: 0,
				publishedPapers: [],
				paperSlots: 1,
				papers: [null, null, null, null],
				buffs: { permanent: [], temporary: [] },
				actionUsed: false,
				readCount: 0,
				workCount: 0,
				firstPaperAccepted: false,
				firstAPaperAccepted: false,
				hasLover: false,
				loverType: null,
				bigBullCooperation: false,
				rejectedCount: 0,
				teaBreakCount: 0,
				tourCount: 0,
				metBigBull: false,
				metBeautiful: false,
				metSmart: false,
				bigBullDeepCount: 0,
				beautifulCount: 0,
				smartCount: 0,
				availableRandomEvents: [],
				usedRandomEvents: [],
				triggeredBuffTypes: [],
				coffeeBoughtCount: 0,
				isReversed: false,
				reversedAwakened: false,
				blockedResearchGains: 0,
				
				pendingPhDChoice: false,
				pendingConference: null,
				goldSpentTotal: 0,
				enterpriseCount: 0,
				ailabInternship: false,
				firstBestPaperAccepted: false,
				badmintonMonth: -1,
				
				lastResetMonth: 0,
				socialAwakened: false,
				reviewerDistribution: null,
				
				ideaClickCount: 0,
				expClickCount: 0,
				writeClickCount: 0,
				consecutiveAccepts: 0,
				
				rejectedPapers: {},
				maxConcurrentReviews: 0,
				phdOpportunitiesRejected: 0,
				gpuServersBought: 0,
				furnitureBought: {
					chair: false,
					monitor: false,
					keyboard: false
				},
				achievementConditions: {
					highScorePaper: false,
					unanimousImprovement: false,
					allBadReviewers: false,
					tripleRejected: false,
					bought5GPUs: false,
					fullFurnitureSet: false,
					phdRequirementMetEarly: false,
					rejectedPhdTwice: false
				},
				paperTypeCollection: new Set(),
				
				// â˜…â˜…â˜… æ–°å¢ï¼šéšè—è§‰é†’ç›¸å…³çŠ¶æ€ â˜…â˜…â˜…
				hiddenAwakened: false,           // æ˜¯å¦è§¦å‘äº†éšè—è§‰é†’
				hiddenAwakenType: null,          // éšè—è§‰é†’ç±»å‹
				actionLimit: 1,                  // æ¯æœˆè¡ŒåŠ¨æ¬¡æ•°é™åˆ¶ï¼ˆå‹¤èƒ½è¡¥æ‹™ä¸º2ï¼‰
				actionCount: 0,                  // æœ¬æœˆå·²ä½¿ç”¨è¡ŒåŠ¨æ¬¡æ•°
				noDecay: false,                  // æ˜¯å¦ç¦æ­¢è®ºæ–‡åˆ†æ•°è¡°å‡ï¼ˆé¢„è§æœªæ¥çƒ­ç‚¹ï¼‰
				hasSeniorHelpSkill: false,       // æ˜¯å¦æœ‰å¸ˆå…„å¸ˆå§æ•‘æˆ‘æŠ€èƒ½
				usedSeniorHelpSkill: false,      // æ˜¯å¦å·²ä½¿ç”¨å¸ˆå…„å¸ˆå§æ•‘æˆ‘
				hasTeacherHelpSkill: false,      // æ˜¯å¦æœ‰å¯¼å¸ˆæ•‘æˆ‘æŠ€èƒ½
				usedTeacherHelpSkill: false,     // æ˜¯å¦å·²ä½¿ç”¨å¯¼å¸ˆæ•‘æˆ‘
				monthlyWageBonus: 0,             // æ¯æœˆå·¥èµ„åŠ æˆï¼ˆä¸æ±‚æš´å¯Œä½†æ±‚ç¨³å®šï¼‰
				nextIdeaResearchBonus: 0,        // ä¸‹æ¬¡æƒ³ideaçš„ä¸´æ—¶ç§‘ç ”åŠ æˆï¼ˆä¸»åŠ¨æŠ€èƒ½ç”¨ï¼Œä¸ç®—buffï¼‰
				nextIdeaBonusSource: null,        // åŠ æˆæ¥æºï¼ˆ'senior' æˆ– 'teacher'ï¼‰
				isTrueNormal: false,  // æ˜¯å¦ä½¿ç”¨çœŸÂ·å¤§å¤šæ•°è§’è‰²
				researchMax: 20,
				socialMax: 20,  
				favorMax: 20, 
                
                // â˜…â˜…â˜… æ–°å¢ï¼šæŠ•ç¨¿ç»Ÿè®¡å’Œä¼šè®®ä¿¡æ¯ â˜…â˜…â˜…
                submissionStats: null,           // æŠ•ç¨¿ç»Ÿè®¡å¿«ç…§
                pendingConferenceInfo: null      // å¾…å¼€ä¼šè®®ä¿¡æ¯
			};
		}


        // ==================== Supabase ç»Ÿè®¡ç³»ç»Ÿ ====================
        const SUPABASE_URL = 'https://orzejzmyzugxtyrzfcse.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9yemVqem15enVneHR5cnpmY3NlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzMDYyMTUsImV4cCI6MjA4MDg4MjIxNX0.lx9W0v9KpRPmQR0kdxCSWVks_az5rLCr7D3JI2efeM4';

        let supabase = null;
        let statsInitialized = false;
        let statsCache = null;
        let statsCacheTime = 0;
        let visitStatsCache = null;
        let visitStatsCacheTime = 0;
        const CACHE_DURATION = 10 * 60 * 1000;

		// ==================== æŒä¹…åŒ–ç¼“å­˜ç³»ç»Ÿ ====================
		const CACHE_KEYS = {
			STATS: 'graduateSimulator_statsCache',
			VISIT: 'graduateSimulator_visitCache',
			GAMES: 'graduateSimulator_gamesCache',
			CHARACTER_RECORDS: 'graduateSimulator_charRecordsCache'
		};

		// ä»localStorageè·å–ç¼“å­˜ï¼ˆå¸¦è¿‡æœŸæ£€æŸ¥å’Œæœ‰æ•ˆæ€§éªŒè¯ï¼‰
		function getLocalCache(key) {
			try {
				const cached = localStorage.getItem(key);
				if (!cached) return null;
				
				const { data, timestamp } = JSON.parse(cached);
				
				// æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
				if (Date.now() - timestamp > CACHE_DURATION) {
					localStorage.removeItem(key);
					console.log(`ç¼“å­˜å·²è¿‡æœŸ: ${key}`);
					return null;
				}
				
				// â˜…â˜…â˜… æ£€æŸ¥æ•°æ®æœ‰æ•ˆæ€§ â˜…â˜…â˜…
				if (data === null || data === undefined) {
					localStorage.removeItem(key);
					console.log(`ç¼“å­˜æ•°æ®æ— æ•ˆ: ${key}`);
					return null;
				}
				
				// å¯¹äºç»Ÿè®¡æ•°æ®ï¼Œé¢å¤–æ£€æŸ¥ç»“æ„
				if (key === CACHE_KEYS.STATS) {
					if (!data.normal || !data.reversed) {
						localStorage.removeItem(key);
						console.log(`ç»Ÿè®¡ç¼“å­˜ç»“æ„æ— æ•ˆ: ${key}`);
						return null;
					}
				}
				
				return data;
			} catch (e) {
				console.warn('è¯»å–ç¼“å­˜å¤±è´¥:', e);
				// ç¼“å­˜æŸåæ—¶åˆ é™¤
				try { localStorage.removeItem(key); } catch(err) {}
				return null;
			}
		}

		// å­˜å‚¨ç¼“å­˜åˆ°localStorageï¼ˆåªå­˜å‚¨æœ‰æ•ˆæ•°æ®ï¼‰
		function setLocalCache(key, data) {
			// â˜…â˜…â˜… ä¸ç¼“å­˜æ— æ•ˆæ•°æ® â˜…â˜…â˜…
			if (data === null || data === undefined) {
				console.log(`è·³è¿‡ç¼“å­˜æ— æ•ˆæ•°æ®: ${key}`);
				return;
			}
			
			try {
				localStorage.setItem(key, JSON.stringify({
					data,
					timestamp: Date.now()
				}));
				console.log(`å·²ç¼“å­˜: ${key}`);
			} catch (e) {
				console.error('å­˜å‚¨ç¼“å­˜å¤±è´¥:', e);
			}
		}

		// â˜…â˜…â˜… æ–°å¢ï¼šæ¸…é™¤æŒ‡å®šç¼“å­˜ â˜…â˜…â˜…
		function clearLocalCache(key) {
			try {
				localStorage.removeItem(key);
				console.log(`å·²æ¸…é™¤ç¼“å­˜: ${key}`);
			} catch (e) {
				console.error('æ¸…é™¤ç¼“å­˜å¤±è´¥:', e);
			}
		}

		// â˜…â˜…â˜… æ–°å¢ï¼šæ¸…é™¤æ‰€æœ‰ç»Ÿè®¡ç¼“å­˜ï¼ˆç”¨äºå¼ºåˆ¶åˆ·æ–°ï¼‰â˜…â˜…â˜…
		function clearAllStatsCache() {
			Object.values(CACHE_KEYS).forEach(key => {
				try { localStorage.removeItem(key); } catch(e) {}
			});
			console.log('å·²æ¸…é™¤æ‰€æœ‰ç»Ÿè®¡ç¼“å­˜');
		}

		// ==================== çœŸå®ç»“å±€è§£é”ç³»ç»Ÿ ====================
		const PHD_UNLOCK_KEY = 'graduateSimulator_phdUnlocks';

		// è·å–å„è§’è‰²åšå£«é€šå…³è®°å½•
		function getCharacterPhdUnlocks() {
			try {
				const data = localStorage.getItem(PHD_UNLOCK_KEY);
				if (data) {
					return JSON.parse(data);
				}
			} catch (e) {
				console.warn('è¯»å–åšå£«é€šå…³è®°å½•å¤±è´¥:', e);
			}
			return {
				normal: {normal: false,  genius: false, social: false, rich: false, 'teacher-child': false, chosen: false, },
				reversed: {normal: false,  genius: false, social: false, rich: false, 'teacher-child': false, chosen: false, }
			};
		}

		// è®°å½•è§’è‰²åšå£«é€šå…³
		function recordCharacterPhdUnlock(characterId, isReversed) {
			const unlocks = getCharacterPhdUnlocks();
			const mode = isReversed ? 'reversed' : 'normal';
			unlocks[mode][characterId] = true;
			localStorage.setItem(PHD_UNLOCK_KEY, JSON.stringify(unlocks));
			console.log(`âœ… è®°å½•åšå£«é€šå…³: ${characterId} (${mode})`);
		}

		// æ£€æŸ¥æ˜¯å¦è§£é”çœŸÂ·å¤§å¤šæ•°ï¼ˆéœ€è¦6ä¸ªè§’è‰²çš„æ­£ä½å’Œé€†ä½éƒ½åšå£«æ¯•ä¸šï¼‰
		function isTrueNormalUnlocked() {
			const unlocks = getCharacterPhdUnlocks();
			const allCharacterIds = ['normal', 'genius', 'social', 'rich', 'teacher-child', 'chosen'];
			
			// æ£€æŸ¥æ¯ä¸ªè§’è‰²çš„æ­£ä½å’Œé€†ä½æ˜¯å¦éƒ½è¾¾åˆ°åšå£«æ¯•ä¸š
			for (const charId of allCharacterIds) {
				if (!unlocks.normal[charId] || !unlocks.reversed[charId]) {
					return false;
				}
			}
			return true;
		}

		// è·å–è§£é”è¿›åº¦ï¼ˆæ€»å…±12ä¸ªï¼š6è§’è‰²Ã—2æ¨¡å¼ï¼‰
		function getTrueNormalUnlockProgress() {
			const unlocks = getCharacterPhdUnlocks();
			const allCharacterIds = ['normal', 'genius', 'social', 'rich', 'teacher-child', 'chosen'];
			
			let unlockedCount = 0;
			const details = [];
			
			for (const charId of allCharacterIds) {
				const normalUnlocked = unlocks.normal[charId] || false;
				const reversedUnlocked = unlocks.reversed[charId] || false;
				
				if (normalUnlocked) unlockedCount++;
				if (reversedUnlocked) unlockedCount++;
				
				const char = characters.find(c => c.id === charId);
				details.push({
					id: charId,
					name: char ? char.name : charId,
					normalUnlocked,
					reversedUnlocked
				});
			}
			
			return {
				unlocked: unlockedCount,
				total: 12,
				isComplete: unlockedCount === 12,
				details
			};
		}

		// è·å–ç©å®¶æœ¬åœ°è¾¾æˆçš„ç»“å±€å’Œæˆå°±è®°å½•
		function getPlayerAchievements() {
			const recordKey = 'graduateSimulator_playerRecords';
			try {
				const records = localStorage.getItem(recordKey);
				if (records) {
					const parsed = JSON.parse(records);
					return {
						achievements: {
							normal: new Set(parsed.achievements?.normal || []),
							reversed: new Set(parsed.achievements?.reversed || [])
						},
						endings: {
							normal: new Set(parsed.endings?.normal || []),
							reversed: new Set(parsed.endings?.reversed || [])
						}
					};
				}
			} catch (e) {
				console.warn('è¯»å–ç©å®¶è®°å½•å¤±è´¥:', e);
			}
			
			return {
				achievements: { normal: new Set(), reversed: new Set() },
				endings: { normal: new Set(), reversed: new Set() }
			};
		}

		// ä¿å­˜ç©å®¶è¾¾æˆçš„ç»“å±€å’Œæˆå°±
		function savePlayerRecord(endingType, achievements, isReversed) {
			const recordKey = 'graduateSimulator_playerRecords';
			try {
				let records = { 
					achievements: { normal: [], reversed: [] }, 
					endings: { normal: [], reversed: [] } 
				};
				
				const existing = localStorage.getItem(recordKey);
				if (existing) {
					records = JSON.parse(existing);
					// ç¡®ä¿ç»“æ„å®Œæ•´
					if (!records.achievements) records.achievements = { normal: [], reversed: [] };
					if (!records.endings) records.endings = { normal: [], reversed: [] };
					if (!records.achievements.normal) records.achievements.normal = [];
					if (!records.achievements.reversed) records.achievements.reversed = [];
					if (!records.endings.normal) records.endings.normal = [];
					if (!records.endings.reversed) records.endings.reversed = [];
				}
				
				const mode = isReversed ? 'reversed' : 'normal';
				
				// æ·»åŠ ç»“å±€
				if (!records.endings[mode].includes(endingType)) {
					records.endings[mode].push(endingType);
				}
				
				// æ·»åŠ æˆå°±
				achievements.forEach(ach => {
					if (!records.achievements[mode].includes(ach)) {
						records.achievements[mode].push(ach);
					}
				});
				
				localStorage.setItem(recordKey, JSON.stringify(records));
			} catch (e) {
				console.error('ä¿å­˜ç©å®¶è®°å½•å¤±è´¥:', e);
			}
		}

		function initStats() {
			if (statsInitialized) return;
			
			try {
				if (typeof window.supabase === 'undefined' || !window.supabase.createClient) {
					console.warn('âš ï¸ Supabase SDK æœªåŠ è½½');
					return;
				}
				
				supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
				statsInitialized = true;
				console.log('âœ… Supabase åˆå§‹åŒ–æˆåŠŸ');
				recordVisit();
				startOnlineTracking();  // â˜… å¯åŠ¨
				
			} catch (e) {
				console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', e);
				supabase = null;
			}
		}

		async function recordVisit() {
			if (!supabase) return;
			try {
				// è®°å½• PVï¼ˆæ¯æ¬¡è®¿é—®éƒ½è®°å½•ï¼‰
				await supabase.from('site_visits').insert({ type: 'pv' });
				
				// â˜…â˜…â˜… ä¿®å¤ï¼šæ¯å¤©æ¯ä¸ªç”¨æˆ·åªè®°å½•ä¸€æ¬¡ UV â˜…â˜…â˜…
				const todayStr = getTodayDateString();
				const visitorKey = 'graduate_simulator_visitor';
				const lastUvDateKey = 'graduate_simulator_last_uv_date';
				
				const isNewVisitor = !localStorage.getItem(visitorKey);
				const lastUvDate = localStorage.getItem(lastUvDateKey);
				const isNewDay = lastUvDate !== todayStr;
				
				// æ–°è®¿å®¢ æˆ– æ–°çš„ä¸€å¤©ï¼ˆè€è®¿å®¢ä»Šå¤©ç¬¬ä¸€æ¬¡è®¿é—®ï¼‰éƒ½è®°å½• UV
				if (isNewVisitor || isNewDay) {
					await supabase.from('site_visits').insert({ type: 'uv' });
					localStorage.setItem(visitorKey, 'true');
					localStorage.setItem(lastUvDateKey, todayStr);
					console.log(isNewVisitor ? 'âœ… æ–°è®¿å®¢å·²è®°å½•' : 'âœ… ä»Šæ—¥è®¿å®¢å·²è®°å½•');
				}
			} catch (e) {
				console.error('è®°å½•è®¿é—®å¤±è´¥:', e);
			}
		}

		async function getVisitStats() {
			// å…ˆæ£€æŸ¥æœ¬åœ°ç¼“å­˜
			const cached = getLocalCache(CACHE_KEYS.VISIT);
			if (cached) {
				console.log('ä½¿ç”¨æœ¬åœ°ç¼“å­˜çš„è®¿é—®ç»Ÿè®¡');
				visitStatsCache = cached;
				visitStatsCacheTime = Date.now();
				return cached;
			}
			
			if (!supabase) return { pv: 0, uv: 0 };
			
			try {
				const { count: pvCount, error: pvError } = await supabase
					.from('site_visits')
					.select('*', { count: 'exact', head: true })
					.eq('type', 'pv');
				
				if (pvError) throw pvError;
				
				const { count: uvCount, error: uvError } = await supabase
					.from('site_visits')
					.select('*', { count: 'exact', head: true })
					.eq('type', 'uv');
					
				if (uvError) throw uvError;
				
				const result = { pv: pvCount || 0, uv: uvCount || 0 };
				
				// â˜…â˜…â˜… æˆåŠŸåæ‰ç¼“å­˜ â˜…â˜…â˜…
				visitStatsCache = result;
				visitStatsCacheTime = Date.now();
				setLocalCache(CACHE_KEYS.VISIT, result);
				
				return result;
			} catch (e) {
				console.error('è·å–è®¿é—®ç»Ÿè®¡å¤±è´¥:', e);
				// å¤±è´¥æ—¶è¿”å›å†…å­˜ç¼“å­˜æˆ–é»˜è®¤å€¼ï¼Œä¸å­˜å‚¨ç¼“å­˜
				return visitStatsCache || { pv: 0, uv: 0 };
			}
		}



		async function recordEnding(endingType, endingTitle) {
			// â˜…â˜…â˜… ç§»é™¤æ•°æ®éªŒè¯ï¼Œç›´æ¥ä¸Šä¼  â˜…â˜…â˜…
			
			// è®¡ç®—æˆå°±æ•°é‡
			const achievements = collectAchievements(endingType);
			const achievementCount = achievements.length;
			
			// æ›´æ–°æœ¬åœ°è®°å½•
			updateLocalMeta(
				gameState.character, 
				gameState.isReversed, 
				gameState.totalScore, 
				gameState.totalCitations, 
				achievementCount,
				endingType,  // â˜…â˜…â˜… æ–°å¢å‚æ•° â˜…â˜…â˜…
			);
			
			if (!supabase) return;
			
			try {
				const { error } = await supabase.from('game_endings').insert({
					ending_type: endingType,
					ending_title: endingTitle,
					character: gameState.character,
					is_reversed: gameState.isReversed,
					total_months: gameState.totalMonths,
					total_score: gameState.totalScore,
					paper_a: gameState.paperA,
					paper_b: gameState.paperB,
					paper_c: gameState.paperC,
					total_citations: gameState.totalCitations,
					achievements_count: achievementCount
				});
				
				if (error) throw error;
				console.log('âœ… ç»“å±€å·²è®°å½•:', endingTitle);
				
				// æ¸…é™¤ç¼“å­˜
				globalCharacterRecords = null;
			} catch (e) {
				console.error('âŒ è®°å½•ç»“å±€å¤±è´¥:', e);
			}
		}

        async function recordAchievements(achievements) {
            if (!supabase || achievements.length === 0) return;
            try {
                const records = achievements.map(ach => ({
                    achievement_name: ach,
                    character: gameState.character,
                    is_reversed: gameState.isReversed
                }));
                
                const { error } = await supabase.from('game_achievements').insert(records);
                
                if (error) throw error;
                console.log('âœ… æˆå°±å·²è®°å½•:', achievements);
            } catch (e) {
                console.error('âŒ è®°å½•æˆå°±å¤±è´¥:', e);
            }
        }


		async function fetchAllRows(tableName, selectColumns) {
			if (!supabase) return [];
			
			let allData = [];
			let from = 0;
			const pageSize = 1000;
			
			while (true) {
				const { data, error } = await supabase
					.from(tableName)
					.select(selectColumns)
					.range(from, from + pageSize - 1);
				
				if (error) {
					console.error(`è·å– ${tableName} æ•°æ®å¤±è´¥:`, error);
					throw error;
				}
				
				if (!data || data.length === 0) break;
				
				allData = allData.concat(data);
				console.log(`${tableName}: å·²è·å– ${allData.length} æ¡è®°å½•`);
				
				// å¦‚æœè¿”å›æ•°é‡å°äº pageSizeï¼Œè¯´æ˜å·²ç»æ˜¯æœ€åä¸€é¡µ
				if (data.length < pageSize) break;
				
				from += pageSize;
			}
			
			return allData;
		}



		// â˜…â˜…â˜… æ–°å¢ï¼šå¿«é€Ÿè·å–æ¸¸æˆæ€»æ•°ï¼ˆç”¨ count æŸ¥è¯¢ï¼‰â˜…â˜…â˜…
		async function getTotalGamesCount() {
			// å…ˆæ£€æŸ¥æœ¬åœ°ç¼“å­˜
			const cached = getLocalCache(CACHE_KEYS.GAMES);
			if (cached !== null && cached !== undefined) {
				console.log('ä½¿ç”¨æœ¬åœ°ç¼“å­˜çš„æ¸¸æˆæ€»æ•°');
				return cached;
			}
			
			if (!supabase) return 0;
			
			try {
				const { count, error } = await supabase
					.from('game_endings')
					.select('*', { count: 'exact', head: true });
				
				if (error) throw error;
				
				const result = count || 0;
				
				// â˜…â˜…â˜… æˆåŠŸåæ‰ç¼“å­˜ â˜…â˜…â˜…
				setLocalCache(CACHE_KEYS.GAMES, result);
				
				return result;
			} catch (e) {
				console.error('è·å–æ¸¸æˆæ€»æ•°å¤±è´¥:', e);
				// å¤±è´¥æ—¶ä¸ç¼“å­˜
				return 0;
			}
		}

		// â˜…â˜…â˜… åˆ†é¡µè·å–æ•°æ®ï¼ˆæœ€å¤šè·å–æŒ‡å®šæ•°é‡ï¼‰â˜…â˜…â˜…
		async function fetchRecentRows(tableName, selectColumns, maxRows = 10000) {
			if (!supabase) return [];
			
			let allData = [];
			let from = 0;
			const pageSize = 1000; // Supabase å•æ¬¡æœ€å¤§è¿”å›é‡
			
			while (allData.length < maxRows) {
				const remaining = maxRows - allData.length;
				const limit = Math.min(pageSize, remaining);
				
				const { data, error } = await supabase
					.from(tableName)
					.select(selectColumns)
					.order('created_at', { ascending: false })
					.range(from, from + limit - 1);
				
				if (error) {
					console.error(`è·å– ${tableName} æ•°æ®å¤±è´¥:`, error);
					throw error;
				}
				
				if (!data || data.length === 0) break;
				
				allData = allData.concat(data);
				console.log(`${tableName}: å·²è·å– ${allData.length} æ¡è®°å½•`);
				
				// å¦‚æœè¿”å›æ•°é‡å°äºè¯·æ±‚æ•°é‡ï¼Œè¯´æ˜å·²ç»æ²¡æœ‰æ›´å¤šæ•°æ®
				if (data.length < limit) break;
				
				from += limit;
			}
			
			return allData;
		}

		async function getGlobalStats() {
			// å…ˆæ£€æŸ¥æœ¬åœ°ç¼“å­˜
			const cached = getLocalCache(CACHE_KEYS.STATS);
			if (cached) {
				console.log('ä½¿ç”¨æœ¬åœ°ç¼“å­˜çš„å…¨çƒç»Ÿè®¡');
				statsCache = cached;
				statsCacheTime = Date.now();
				return cached;
			}
			
			if (!supabase) {
				console.warn('Supabaseæœªåˆå§‹åŒ–');
				return null;
			}
			
			try {
				const stats = {
					normal: { endings: {}, achievements: {}, totalGames: 0, characterEndings: {} },
					reversed: { endings: {}, achievements: {}, totalGames: 0, characterEndings: {} }
				};

				// â˜…â˜…â˜… ä½¿ç”¨åˆ†é¡µè·å–æœ€è¿‘10000æ¡ç»“å±€æ•°æ® â˜…â˜…â˜…
				const endingsData = await fetchRecentRows(
					'game_endings',
					'ending_type, is_reversed, character, total_score, total_months, paper_a, paper_b, paper_c, total_citations',
					10000
				);
				
				console.log(`ğŸ“Š è·å–ç»“å±€æ•°æ®æ€»æ•°: ${endingsData.length}`);
				
				// åœ¨10000æ¡å†…è¿‡æ»¤æœ‰æ•ˆæ•°æ®
				const validEndings = endingsData.filter(e => {
					if (!e.ending_type || !e.character || typeof e.is_reversed !== 'boolean') {
						return false;
					}
					// â˜…â˜…â˜… æ–°å¢ï¼šè¿‡æ»¤è¶…è¿‡20000å¼•ç”¨çš„å¼‚å¸¸æ•°æ® â˜…â˜…â˜…
					if ((e.total_citations || 0) > 20000) return false;
					const paperA = e.paper_a || 0;
					const paperB = e.paper_b || 0;
					const paperC = e.paper_c || 0;
					const totalScore = e.total_score || 0;
					const totalMonths = e.total_months || 0;
					const totalPapers = paperA + paperB + paperC;
					
					const expectedScore = paperA * 4 + paperB * 2 + paperC * 1;
					if (totalScore !== expectedScore) return false;
					
					const phdEndings = ['phd', 'excellent_phd', 'green_pepper', 'become_advisor', 'academic_star', 'future_academician', 'true_phd', 'true_devotion'];
					const isPhd = phdEndings.includes(e.ending_type);
					
					if (isPhd) {
						if (totalMonths > 61 || totalPapers >= 26) return false;
					} else {
						if (totalMonths > 36 || totalPapers >= 12) return false;
					}
					
					return true;
				});
				
				console.log(`ğŸ“Š æœ‰æ•ˆç»“å±€æ•°æ®: ${validEndings.length}/${endingsData.length}`);
				
				// ç»Ÿè®¡ç»“å±€
				validEndings.forEach(e => {
					const mode = e.is_reversed ? 'reversed' : 'normal';
					const type = e.ending_type;
					const character = e.character;
					
					stats[mode].endings[type] = (stats[mode].endings[type] || 0) + 1;
					stats[mode].totalGames++;
					
					if (!stats[mode].characterEndings[character]) {
						stats[mode].characterEndings[character] = { total: 0, hard: 0 };
					}
					stats[mode].characterEndings[character].total++;
					if (HARD_ENDINGS.includes(type)) {
						stats[mode].characterEndings[character].hard++;
					}
				});

				// â˜…â˜…â˜… ä½¿ç”¨åˆ†é¡µè·å–æœ€è¿‘10000æ¡æˆå°±æ•°æ® â˜…â˜…â˜…
				const achievementsData = await fetchRecentRows(
					'game_achievements',
					'achievement_name, is_reversed',
					10000
				);
				
				console.log(`ğŸ“Š è·å–æˆå°±æ•°æ®æ€»æ•°: ${achievementsData.length}`);
				
				achievementsData.forEach(a => {
					if (!a.achievement_name || typeof a.is_reversed !== 'boolean') return;
					
					const mode = a.is_reversed ? 'reversed' : 'normal';
					stats[mode].achievements[a.achievement_name] = (stats[mode].achievements[a.achievement_name] || 0) + 1;
				});

				// æˆåŠŸåæ‰ç¼“å­˜
				statsCache = stats;
				statsCacheTime = Date.now();
				setLocalCache(CACHE_KEYS.STATS, stats);
				
				return stats;
			} catch (e) {
				console.error('è·å–ç»Ÿè®¡å¤±è´¥:', e);
				return statsCache || null;
			}
		}

		function renderModeStats(mode, modeStats, endingContainer, achievementContainer) {
			if (!endingContainer || !achievementContainer) {
				console.warn('ç»Ÿè®¡å®¹å™¨ä¸å­˜åœ¨');
				return;
			}
			
			const playerRecords = getPlayerAchievements();
			const playerEndingsSet = playerRecords.endings[mode] || new Set();
			const playerAchievementsSet = playerRecords.achievements[mode] || new Set();
			
			const totalGames = modeStats.totalGames || 0;
			
			// ==================== æ¸²æŸ“ç»“å±€ç»Ÿè®¡ï¼ˆæŒ‰å®Œæˆç‡æ’åºï¼‰====================
			// â˜…â˜…â˜… æ–°å¢ï¼šé€†ä½æ¨¡å¼ä¸‹è¿‡æ»¤æ‰çœŸÂ·å¤§å¤šæ•°ç›¸å…³ç»“å±€ï¼ˆé€†ä½æ— æ³•é€‰æ‹©çœŸÂ·å¤§å¤šæ•°ï¼‰â˜…â˜…â˜…
			const trueNormalEndings = ['true_phd', 'true_devotion', 'true_life'];
			const endingsToShow = mode === 'reversed' 
				? Object.entries(ENDING_NAMES).filter(([type]) => !trueNormalEndings.includes(type))
				: Object.entries(ENDING_NAMES);
			
			// æ„å»ºç»“å±€æ•°æ®æ•°ç»„
			const endingEntries = endingsToShow.map(([type, name]) => {
				const count = modeStats.endings[type] || 0;
				const percent = totalGames > 0 ? (count / totalGames) * 100 : 0;
				const isAchieved = playerEndingsSet instanceof Set 
					? playerEndingsSet.has(type) 
					: (Array.isArray(playerEndingsSet) && playerEndingsSet.includes(type));
				return { type, name, count, percent, isAchieved };
			});
			
			// æŒ‰ç™¾åˆ†æ¯”ä»é«˜åˆ°ä½æ’åº
			endingEntries.sort((a, b) => b.percent - a.percent);
			
			// åˆ†ç¦»å·²è¾¾æˆå’Œæœªè¾¾æˆ
			const achievedEndingsSorted = endingEntries.filter(e => e.isAchieved);
			const unachievedEndingsSorted = endingEntries.filter(e => !e.isAchieved);
			
			let achievedEndingsHtml = achievedEndingsSorted.map(e => {
				// çœŸå®ç»“å±€é¢å¤–æ˜¾ç¤ºæ•°é‡
				const isTrueEnding = e.type === 'true_phd' || e.type === 'true_devotion' || e.type === 'true_life';
				const displayText = isTrueEnding 
					? `${e.name} <strong>${e.percent.toFixed(1)}% (${e.count}äºº)</strong>`
					: `${e.name} <strong>${e.percent.toFixed(1)}%</strong>`;
				return `
					<span class="stats-tag ending-tag" 
						  onclick="showSingleEndingRequirement('${e.type}')" 
						  style="cursor:pointer;">
						${displayText}
					</span>
				`;
			}).join('');
			
			let unachievedEndingsHtml = unachievedEndingsSorted.map(e => {
				const isTrueEnding = e.type === 'true_phd' || e.type === 'true_devotion' || e.type === 'true_life';
				const displayText = isTrueEnding 
					? `${e.name} <strong>${e.percent.toFixed(1)}% (${e.count}äºº)</strong>`
					: `${e.name} <strong>${e.percent.toFixed(1)}%</strong>`;
				return `
					<span class="stats-tag ending-tag" 
						  onclick="showSingleEndingRequirement('${e.type}')" 
						  style="cursor:pointer;opacity:0.5;">
						${displayText}
					</span>
				`;
			}).join('');
			
			let endingHtml = '';
			if (achievedEndingsHtml) {
				endingHtml += `
					<div style="margin-bottom:8px;">
						<div style="font-size:0.7rem;color:var(--success-color);margin-bottom:4px;">âœ“ ç©å®¶å·²è¾¾æˆç»“å±€ï¼ˆå…¨çƒç»“å±€æ¯”ç‡ï¼‰</div>
						<div style="display:flex;flex-wrap:wrap;gap:4px;">${achievedEndingsHtml}</div>
					</div>`;
			}
			if (unachievedEndingsHtml) {
				endingHtml += `
					<div>
						<div style="font-size:0.7rem;color:var(--text-secondary);margin-bottom:4px;">â—‹ ç©å®¶æœªè¾¾æˆç»“å±€ï¼ˆå…¨çƒç»“å±€æ¯”ç‡ï¼‰</div>
						<div style="display:flex;flex-wrap:wrap;gap:4px;">${unachievedEndingsHtml}</div>
					</div>`;
			}
			if (!endingHtml) {
				endingHtml = '<span style="color:var(--text-secondary);font-size:0.75rem;">æš‚æ— æ•°æ®</span>';
			}
			endingContainer.innerHTML = endingHtml;
			
			// ==================== æ¸²æŸ“æˆå°±ç»Ÿè®¡ï¼ˆæŒ‰å®Œæˆç‡æ’åºï¼‰====================
			const achievementEntries = ALL_ACHIEVEMENTS.map(ach => {
				const count = modeStats.achievements[ach] || 0;
				const percent = totalGames > 0 ? (count / totalGames) * 100 : 0;
				const isAchieved = playerAchievementsSet instanceof Set 
					? playerAchievementsSet.has(ach) 
					: (Array.isArray(playerAchievementsSet) && playerAchievementsSet.includes(ach));
				return { ach, count, percent, isAchieved };
			});
			
			// æŒ‰ç™¾åˆ†æ¯”ä»é«˜åˆ°ä½æ’åº
			achievementEntries.sort((a, b) => b.percent - a.percent);
			
			const achievedAchSorted = achievementEntries.filter(a => a.isAchieved);
			const unachievedAchSorted = achievementEntries.filter(a => !a.isAchieved);
			
			let achievedAchHtml = achievedAchSorted.map(a => `
				<span class="stats-tag" 
					  onclick="showSingleAchievementRequirement('${a.ach}')" 
					  style="cursor:pointer;">
					${a.ach} <strong>${a.percent.toFixed(1)}%</strong>
				</span>
			`).join('');
			
			let unachievedAchHtml = unachievedAchSorted.map(a => `
				<span class="stats-tag" 
					  onclick="showSingleAchievementRequirement('${a.ach}')" 
					  style="cursor:pointer;opacity:0.5;">
					${a.ach} <strong>${a.percent.toFixed(1)}%</strong>
				</span>
			`).join('');
			
			let achievementHtml = '';
			if (achievedAchHtml) {
				achievementHtml += `
					<div style="margin-bottom:8px;">
						<div style="font-size:0.7rem;color:var(--success-color);margin-bottom:4px;">âœ“ ç©å®¶å·²è¾¾æˆæˆå°±ï¼ˆå…¨çƒç©å®¶è¾¾æˆç‡ï¼‰</div>
						<div style="display:flex;flex-wrap:wrap;gap:4px;">${achievedAchHtml}</div>
					</div>`;
			}
			if (unachievedAchHtml) {
				achievementHtml += `
					<div>
						<div style="font-size:0.7rem;color:var(--text-secondary);margin-bottom:4px;">â—‹ ç©å®¶æœªè¾¾æˆæˆå°±ï¼ˆå…¨çƒç©å®¶è¾¾æˆç‡ï¼‰</div>
						<div style="display:flex;flex-wrap:wrap;gap:4px;">${unachievedAchHtml}</div>
					</div>`;
			}
			if (!achievementHtml) {
				achievementHtml = '<span style="color:var(--text-secondary);font-size:0.75rem;">æš‚æ— æ•°æ®</span>';
			}
			achievementContainer.innerHTML = achievementHtml;
		}

		// ==================== 1. ä¿®æ”¹éš¾åº¦è®¡ç®—å‡½æ•° ====================

		function calculateCharacterDifficulty(stats) {
			const difficultyData = {};
			const allCharacterRates = [];

			// â˜…â˜…â˜… çœŸÂ·å¤§å¤šæ•°ä¸å‚ä¸æ’åº â˜…â˜…â˜…
			const allCharIds = characters.map(c => c.id);

			allCharIds.forEach(charId => {
				// æ­£ä½æ•°æ®
				const normalData = stats.normal.characterEndings[charId] || { total: 0, hard: 0 };
				const normalRate = normalData.total >= 5 ? normalData.hard / normalData.total : null;
				allCharacterRates.push({
					id: charId,
					isReversed: false,
					rate: normalRate,
					total: normalData.total,
					hard: normalData.hard
				});

				// é€†ä½æ•°æ®
				const reversedData = stats.reversed.characterEndings[charId] || { total: 0, hard: 0 };
				const reversedRate = reversedData.total >= 5 ? reversedData.hard / reversedData.total : null;
				allCharacterRates.push({
					id: charId,
					isReversed: true,
					rate: reversedRate,
					total: reversedData.total,
					hard: reversedData.hard
				});
			});

			const validRates = allCharacterRates.filter(c => c.rate !== null);
			validRates.sort((a, b) => b.rate - a.rate);

			validRates.forEach((char, index) => {
				const rank = index + 1;
				const difficulty = Math.ceil(rank * 12 / validRates.length);
				const key = `${char.id}_${char.isReversed ? 'reversed' : 'normal'}`;
				difficultyData[key] = {
					stars: Math.min(12, Math.max(1, difficulty)),
					rate: char.rate,
					total: char.total,
					hard: char.hard,
					rank: rank,
					totalRanked: validRates.length
				};
			});

			allCharacterRates.forEach(char => {
				const key = `${char.id}_${char.isReversed ? 'reversed' : 'normal'}`;
				if (!difficultyData[key]) {
					difficultyData[key] = {
						stars: null,
						rate: null,
						total: char.total,
						hard: char.hard,
						rank: null,
						totalRanked: validRates.length
					};
				}
			});

			// â˜…â˜…â˜… çœŸÂ·å¤§å¤šæ•°å›ºå®šä¸ºæœ€é«˜éš¾åº¦ï¼ˆ12æ˜Ÿï¼‰ â˜…â˜…â˜…
			const trueNormalData = stats.normal.characterEndings['true-normal'] || { total: 0, hard: 0 };
			const trueNormalRate = trueNormalData.total >= 5 ? trueNormalData.hard / trueNormalData.total : null;
			difficultyData['true-normal_normal'] = {
				stars: 12,  // å›ºå®š12æ˜Ÿæœ€é«˜éš¾åº¦
				rate: trueNormalRate,
				total: trueNormalData.total,
				hard: trueNormalData.hard,
				rank: 0,  // ç‰¹æ®Šæ’å
				totalRanked: validRates.length,
				isFixed: true  // æ ‡è®°ä¸ºå›ºå®šéš¾åº¦
			};

			return difficultyData;
		}

        function renderDifficultyStars(stars) {
            if (stars === null) {
                return '<span class="no-data">æ•°æ®ä¸è¶³</span>';
            }

            let html = '';
            const fullStars = Math.floor(stars / 2);
            const halfStar = stars % 2 === 1;
            const emptyStars = 6 - fullStars - (halfStar ? 1 : 0);

            for (let i = 0; i < fullStars; i++) {
                html += '<i class="fas fa-star"></i>';
            }
            if (halfStar) {
                html += '<i class="far fa-star"></i>';
            }
            for (let i = 0; i < emptyStars; i++) {
                html += '<i class="far fa-star" style="opacity:0.3;"></i>';
            }

            return html;
        }

        function getDifficultyBadge(stars) {
            if (stars === null) return '<span class="difficulty-badge unknown">?</span>';
            if (stars >= 11) return '<span class="difficulty-badge legendary">ä¼ è¯´</span>';
            if (stars >= 9) return '<span class="difficulty-badge nightmare">å™©æ¢¦</span>';
            if (stars >= 7) return '<span class="difficulty-badge expert">ä¸“å®¶</span>';
            if (stars >= 5) return '<span class="difficulty-badge hard">å›°éš¾</span>';
            if (stars >= 3) return '<span class="difficulty-badge normal">æ™®é€š</span>';
            return '<span class="difficulty-badge easy">ç®€å•</span>';
        }

		async function loadGlobalStatsDisplay() {
			const section = document.getElementById('stats-section');
			const loading = document.getElementById('stats-loading');
			const content = document.getElementById('stats-content');
			
			section.style.display = 'block';
			loading.style.display = 'block';
			content.style.display = 'none';
			
			// ç¬¬1æ­¥ï¼šå¿«é€ŸåŠ è½½æ€»æ•°
			Promise.all([
				getVisitStats(),
				getTotalGamesCount()
			]).then(([visitStats, totalGames]) => {
				const pvEl = document.getElementById('busuanzi_value_site_pv');
				const uvEl = document.getElementById('busuanzi_value_site_uv');
				const gamesEl = document.getElementById('total-games-value');
				
				if (pvEl) pvEl.textContent = visitStats.pv || 0;
				if (uvEl) uvEl.textContent = visitStats.uv || 0;
				if (gamesEl) gamesEl.textContent = totalGames;
			}).catch(e => {
				console.error('åŠ è½½è®¿é—®ç»Ÿè®¡å¤±è´¥:', e);
			});
			
			// ç¬¬2æ­¥ï¼šåŠ è½½è¯¦ç»†ç»Ÿè®¡
			setTimeout(async () => {
				try {
					if (!supabase) {
						loading.innerHTML = `
							<span style="color:var(--text-secondary);font-size:0.8rem;">ğŸ“Š ç»Ÿè®¡æœåŠ¡æš‚ä¸å¯ç”¨</span>
							<button class="btn btn-info" style="margin-left:10px;padding:3px 8px;font-size:0.7rem;" onclick="retryLoadStats()">
								<i class="fas fa-redo"></i> é‡è¯•
							</button>
						`;
						return;
					}
					
					loading.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨åŠ è½½è¯¦ç»†ç»Ÿè®¡...';
					
					const stats = await getGlobalStats();
					
					if (!stats) {
						// â˜…â˜…â˜… åŠ è½½å¤±è´¥æ—¶æ˜¾ç¤ºé‡è¯•æŒ‰é’® â˜…â˜…â˜…
						loading.innerHTML = `
							<span style="color:var(--warning-color);font-size:0.8rem;">âš ï¸ ç»Ÿè®¡åŠ è½½å¤±è´¥</span>
							<button class="btn btn-info" style="margin-left:10px;padding:3px 8px;font-size:0.7rem;" onclick="retryLoadStats()">
								<i class="fas fa-redo"></i> é‡è¯•
							</button>
						`;
						return;
					}
					
					characterDifficultyData = calculateCharacterDifficulty(stats);
					
					loading.style.display = 'none';
					content.style.display = 'block';
					
					// æ¸²æŸ“ç»Ÿè®¡ï¼ˆä½¿ç”¨åŸæœ‰çš„combinedå®¹å™¨æˆ–æ–°çš„åˆ†ç¦»å®¹å™¨ï¼‰
					const normalEndingEl = document.getElementById('normal-ending-stats');
					const normalAchEl = document.getElementById('normal-achievement-stats');
					const reversedEndingEl = document.getElementById('reversed-ending-stats');
					const reversedAchEl = document.getElementById('reversed-achievement-stats');
					
					// å¦‚æœæœ‰åˆ†ç¦»çš„å®¹å™¨ï¼Œä½¿ç”¨åˆ†ç¦»æ˜¾ç¤º
					if (normalEndingEl && reversedEndingEl) {
						renderModeStats('normal', stats.normal, normalEndingEl, normalAchEl);
						renderModeStats('reversed', stats.reversed, reversedEndingEl, reversedAchEl);
						
						// æ ¹æ®å½“å‰æ¨¡å¼æ˜¾ç¤ºå¯¹åº”ç»Ÿè®¡
						const normalSection = document.getElementById('normal-stats-section');
						const reversedSection = document.getElementById('reversed-stats-section');
						if (normalSection && reversedSection) {
							normalSection.style.display = isReversedMode ? 'none' : 'block';
							reversedSection.style.display = isReversedMode ? 'block' : 'none';
						}
					} else {
						// å…¼å®¹æ—§çš„combinedå®¹å™¨
						const combinedEndingEl = document.getElementById('combined-ending-stats');
						const combinedAchEl = document.getElementById('combined-achievement-stats');
						if (combinedEndingEl && combinedAchEl) {
							const currentMode = isReversedMode ? 'reversed' : 'normal';
							renderModeStats(currentMode, stats[currentMode], combinedEndingEl, combinedAchEl);
						}
					}
					
					renderCharacterGrid();
					
					// è§’è‰²è®°å½•å¼‚æ­¥åŠ è½½
					getGlobalCharacterRecords().then(() => {
						renderCharacterGrid();
						console.log('âœ… å…¨éƒ¨åŠ è½½å®Œæˆ');
					}).catch(e => {
						console.error('åŠ è½½è§’è‰²è®°å½•å¤±è´¥:', e);
					});
					
				} catch (e) {
					console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', e);
					loading.innerHTML = `
						<span style="color:var(--warning-color);font-size:0.8rem;">âš ï¸ åŠ è½½å¤±è´¥: ${e.message || 'æœªçŸ¥é”™è¯¯'}</span>
						<button class="btn btn-info" style="margin-left:10px;padding:3px 8px;font-size:0.7rem;" onclick="retryLoadStats()">
							<i class="fas fa-redo"></i> é‡è¯•
						</button>
					`;
				}
			}, 100);
		}

		// â˜…â˜…â˜… æ–°å¢ï¼šé‡è¯•åŠ è½½ç»Ÿè®¡ï¼ˆæ¸…é™¤ç¼“å­˜åé‡æ–°åŠ è½½ï¼‰â˜…â˜…â˜…
		function retryLoadStats() {
			console.log('æ‰‹åŠ¨é‡è¯•åŠ è½½ç»Ÿè®¡...');
			// æ¸…é™¤æ‰€æœ‰ç»Ÿè®¡ç¼“å­˜
			clearAllStatsCache();
			// é‡ç½®å†…å­˜ç¼“å­˜
			statsCache = null;
			statsCacheTime = 0;
			visitStatsCache = null;
			visitStatsCacheTime = 0;
			globalCharacterRecords = null;
			globalCharacterRecordsTime = 0;
			// é‡æ–°åŠ è½½
			loadGlobalStatsDisplay();
		}


        // ==================== æ¨¡å¼åˆ‡æ¢ ====================
		function switchMode(reversed) {
			isReversedMode = reversed;
			isTrueNormalMode = false;  // â˜…â˜…â˜… åˆ‡æ¢æ¨¡å¼æ—¶é‡ç½®çœŸÂ·å¤§å¤šæ•°çŠ¶æ€ â˜…â˜…â˜…
            
            const normalBtn = document.getElementById('normal-mode-btn');
            const reversedBtn = document.getElementById('reversed-mode-btn');
            const modeDesc = document.getElementById('mode-description');
            const gameIntro = document.getElementById('game-intro');
            const selectionTitle = document.getElementById('selection-title');
            
            normalBtn.classList.toggle('active', !reversed);
            reversedBtn.classList.toggle('active', reversed);
            reversedBtn.classList.toggle('reversed-active', reversed);
            
            document.body.classList.toggle('reversed-theme', reversed);
            document.querySelectorAll('.character-card').forEach(card => card.classList.remove('selected'));
            
            if (reversed) {
                modeDesc.innerHTML = 'ğŸ’€ é€†ä½æ¨¡å¼ï¼Œå¾ªè§„è¹ˆçŸ©ï¼Ÿä¸å…å¤ªè¿‡æ— è¶£ï¼';
                selectionTitle.innerHTML = '<i class="fas fa-moon"></i> é€‰æ‹©ä½ çš„é€†ä½è§’è‰²';
                gameIntro.innerHTML = `
                    <p>ğŸŒ‘ <strong>é€†ä½æ¨¡å¼å·²å¼€å¯ï¼</strong>æ¯ä¸ªè§’è‰²éƒ½æœ‰ç‹¬ç‰¹çš„é€†ä½æ•ˆæœï¼Œè§„åˆ™å°†è¢«é¢ è¦†ã€‚</p>
                    <p>âš ï¸ <strong>æ³¨æ„</strong>ï¼šé€†ä½è§’è‰²ç©æ³•æ›´ç‹¬ç‰¹ï¼Œå±æ€§å˜åŒ–è§„åˆ™å¯èƒ½å®Œå…¨ä¸åŒï¼</p>
                    <p>ğŸ¯ <strong>æ¸¸æˆç›®æ ‡</strong>ï¼šç¡•å£«æ¯•ä¸šç§‘ç ”åˆ†â‰¥1ï¼ˆ3å¹´ï¼‰ï¼Œåšå£«æ¯•ä¸šç§‘ç ”åˆ†â‰¥7ï¼ˆ5å¹´ï¼‰</p>
                    <p>ğŸ“ <strong>è®ºæ–‡ç§‘ç ”åˆ†</strong>ï¼šAç±»=4åˆ†ï¼ŒBç±»=2åˆ†ï¼ŒCç±»=1åˆ†</p>
                    <p>ğŸ’€ <strong>æŒ‘æˆ˜è‡ªæˆ‘</strong>ï¼šé€†ä½è§’è‰²çš„è½¬åšè§‰é†’æ•ˆæœä¹Ÿå®Œå…¨ä¸åŒï¼</p>
                `;
            } else {
                modeDesc.innerHTML = 'ğŸ“š ç»å…¸æ¨¡å¼ï¼Œä½“éªŒæ ‡å‡†çš„ç ”ç©¶ç”Ÿç”Ÿæ¶¯';
                selectionTitle.innerHTML = '<i class="fas fa-users"></i> é€‰æ‹©ä½ çš„è§’è‰²';
                gameIntro.innerHTML = `
                    <p>ğŸ“š <strong>æ¬¢è¿æ¥åˆ°ç ”ç©¶ç”Ÿæ¨¡æ‹Ÿå™¨ï¼</strong>ä½“éªŒç ”ç©¶ç”Ÿç”Ÿæ¶¯ï¼Œå¹³è¡¡ç§‘ç ”ã€ç”Ÿæ´»å’Œäººé™…å…³ç³»ï¼ŒåŠªåŠ›å‘è¡¨è®ºæ–‡ï¼Œæœ€ç»ˆé¡ºåˆ©æ¯•ä¸šã€‚</p>
                    <p>ğŸ¯ <strong>æ¸¸æˆç›®æ ‡</strong>ï¼šç¡•å£«æ¯•ä¸šç§‘ç ”åˆ†â‰¥1ï¼ˆ3å¹´ï¼‰ï¼Œåšå£«æ¯•ä¸šç§‘ç ”åˆ†â‰¥7ï¼ˆ5å¹´ï¼‰</p>
                    <p>ğŸ“ <strong>è®ºæ–‡ç§‘ç ”åˆ†</strong>ï¼šAç±»=4åˆ†ï¼ŒBç±»=2åˆ†ï¼ŒCç±»=1åˆ†</p>
                    <p>ğŸ’¡ <strong>å±æ€§å½±å“</strong>ï¼šç§‘ç ”èƒ½åŠ›å½±å“è®ºæ–‡åˆ†æ•°ï¼›ç¤¾äº¤èƒ½åŠ›å’Œå¯¼å¸ˆå¥½æ„Ÿåº¦å½±å“äº‹ä»¶é€‰é¡¹å’Œç»“æœã€‚<strong>å»ºè®®ä¼˜å…ˆå°†å±æ€§æå‡è‡³6ä»¥è§£é”æ›´å¤šé€‰é¡¹ï¼</strong></p>
                    <p>âš ï¸ <strong>æ³¨æ„</strong>ï¼šä¿æŒSANå€¼ã€å¯¼å¸ˆå¥½æ„Ÿåº¦å’Œé‡‘é’±ä¸ºæ­£æ•°ï¼Œå¦åˆ™å°†è§¦å‘ä¸è‰¯ç»“å±€ï¼</p>
                `;
            }
            
            selectedCharacter = null;
            document.getElementById('start-btn').disabled = true;
			// â˜…â˜…â˜… åˆ‡æ¢ç»Ÿè®¡é¢æ¿æ˜¾ç¤º â˜…â˜…â˜…
			const normalSection = document.getElementById('normal-stats-section');
			const reversedSection = document.getElementById('reversed-stats-section');
			if (normalSection && reversedSection) {
				normalSection.style.display = reversed ? 'none' : 'block';
				reversedSection.style.display = reversed ? 'block' : 'none';
			}
            
            renderCharacterGrid();
        }

        // ==================== åˆå§‹åŒ– ====================
		function init() {
			// åˆå§‹åŒ–æŠ˜å çŠ¶æ€
			initCollapseStates();
			initStartSectionStates();
			
			renderCharacterGrid();
			document.getElementById('start-btn').addEventListener('click', startGame);
			
			initStats();
			loadGlobalStatsDisplay();
			
			setTimeout(() => {
				const messageSection = document.getElementById('message-section');
				if (messageSection) {
					messageSection.style.display = 'block';
					initMessageBoard();
				}
			}, 500);
			
			// åº”ç”¨ä¿å­˜çš„å¼€å§‹é¡µé¢æŠ˜å çŠ¶æ€
			applyStartSectionStates();
		}
				




		// ==================== 3. ä¿®æ”¹renderCharacterGridæ·»åŠ æŠ˜å åŠŸèƒ½ ====================

		function renderCharacterGrid() {
			const grid = document.getElementById('character-grid');
			const globalRecords = globalCharacterRecords;
			
			// æ£€æŸ¥çœŸÂ·å¤§å¤šæ•°è§£é”çŠ¶æ€
			const trueNormalUnlocked = isTrueNormalUnlocked();
			const unlockProgress = getTrueNormalUnlockProgress();
			
			// è·å–å…¨çƒåšå£«é€šå…³ç»Ÿè®¡
			const globalPhdStats = {};
			let trueNormalUnlockedCount = 0;
			
			if (statsCache) {
				const allCharIds = ['genius', 'social', 'rich', 'teacher-child', 'chosen', 'normal'];
				allCharIds.forEach(charId => {
					const normalData = statsCache.normal?.characterEndings?.[charId];
					globalPhdStats[`${charId}_normal`] = normalData?.hard || 0;
					
					const reversedData = statsCache.reversed?.characterEndings?.[charId];
					globalPhdStats[`${charId}_reversed`] = reversedData?.hard || 0;
				});
				
				const trueNormalData = statsCache.normal?.characterEndings?.['true-normal'];
				trueNormalUnlockedCount = trueNormalData?.hard || 0;
			}

			// â˜…â˜…â˜… è·å–è§’è‰²å¡ç‰‡æŠ˜å çŠ¶æ€ â˜…â˜…â˜…
			const cardCollapseStates = getCharacterCardCollapseStates();

			// è§£é”è¿›åº¦æ 
			const progressContainer = document.getElementById('true-normal-progress');
			if (progressContainer) {
				if (!isReversedMode) {
					
					if (trueNormalUnlocked) {
						progressContainer.innerHTML = `
							<div style="margin-top:15px;padding:20px;background:linear-gradient(135deg,#fffef5 0%,#fff9e6 50%,#fff4d6 100%);border-radius:16px;border:2px solid #f0c14b;box-shadow:0 4px 20px rgba(240,193,75,0.2);position:relative;overflow:hidden;">
								
								<div style="position:absolute;top:0;right:0;width:150px;height:150px;background:radial-gradient(circle,rgba(255,200,50,0.15) 0%,transparent 70%);pointer-events:none;"></div>
								<div style="position:absolute;bottom:0;left:0;width:100px;height:100px;background:radial-gradient(circle,rgba(255,180,50,0.1) 0%,transparent 70%);pointer-events:none;"></div>
								
								<div style="text-align:center;margin-bottom:15px;position:relative;">
									<div style="font-size:1.2rem;font-weight:700;color:#b8860b;">
										âœ¨ çœŸÂ·å¤§å¤šæ•° å·²è§£é” âœ¨
									</div>
									<div style="font-size:0.75rem;color:#996515;margin-top:4px;">
										å…¨éƒ¨12é¡¹æŒ‘æˆ˜å·²å®Œæˆ Â· å…¨çƒ <strong style="color:#d4851c;">${trueNormalUnlockedCount}</strong> äººå·²è§£é”
									</div>
								</div>
								
								<div style="display:flex;flex-wrap:wrap;justify-content:center;gap:6px;margin-bottom:15px;">
									${unlockProgress.details.map(d => `
										<div style="display:flex;align-items:center;gap:4px;padding:5px 12px;background:white;border-radius:20px;border:1px solid #e8d5a3;box-shadow:0 2px 4px rgba(0,0,0,0.05);">
											<span style="font-size:0.75rem;color:#5d4e37;font-weight:500;">${d.name}</span>
											<span style="color:#22c55e;font-size:0.7rem;font-weight:600;">âœ“âœ“</span>
										</div>
									`).join('')}
								</div>
								
								<div style="height:1px;background:linear-gradient(90deg,transparent,#e8d5a3,transparent);margin:15px 0;"></div>
								
								<div style="text-align:center;">
									<button class="btn" 
											style="padding:12px 35px;font-size:0.95rem;font-weight:600;
												   background:${isTrueNormalMode 
													   ? 'linear-gradient(135deg,#ef4444,#dc2626)' 
													   : 'linear-gradient(135deg,#f59e0b,#d97706)'};
												   color:white;
												   border:none;border-radius:25px;
												   box-shadow:0 4px 15px ${isTrueNormalMode 
													   ? 'rgba(239,68,68,0.35)' 
													   : 'rgba(245,158,11,0.35)'};
												   transition:all 0.3s ease;cursor:pointer;"
											onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 20px ${isTrueNormalMode ? 'rgba(239,68,68,0.45)' : 'rgba(245,158,11,0.45)'}'"
											onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 15px ${isTrueNormalMode ? 'rgba(239,68,68,0.35)' : 'rgba(245,158,11,0.35)'}'"
											onclick="toggleTrueNormalMode()">
										${isTrueNormalMode 
											? 'ğŸ”™ åˆ‡æ¢å›æ™®é€šå¤§å¤šæ•°' 
											: 'ğŸŒŸ é€‰æ‹©çœŸÂ·å¤§å¤šæ•°æŒ‘æˆ˜'}
									</button>
									${isTrueNormalMode ? `
										<div style="margin-top:12px;padding:10px 15px;background:linear-gradient(135deg,#fef2f2,#fee2e2);border-radius:10px;border:1px solid #fecaca;">
											<span style="color:#dc2626;font-size:0.8rem;font-weight:500;">
												ğŸ”¥ å·²é€‰æ‹©çœŸÂ·å¤§å¤šæ•°
											</span>
										</div>
									` : `
										<div style="margin-top:10px;font-size:0.75rem;color:#92785a;">
											âš”ï¸ æ— ç‰¹æ®Šèƒ½åŠ› Â· æ— è½¬åšè§‰é†’ Â· ä¸€åˆ‡é è‡ªå·±
										</div>
									`}
								</div>
							</div>
						`;
					} else {
						const progressPercent = (unlockProgress.unlocked / unlockProgress.total * 100).toFixed(0);
						
						progressContainer.innerHTML = `
							<div style="margin-top:15px;padding:15px 18px;background:linear-gradient(135deg,#f8f9ff,#f0f4ff);border-radius:12px;border:1px dashed #c5cae9;">
								
								<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
									<div style="display:flex;align-items:center;gap:10px;">
										<div style="width:40px;height:40px;background:linear-gradient(135deg,#e8eaf6,#c5cae9);border-radius:10px;display:flex;align-items:center;justify-content:center;">
											<span style="font-size:1.2rem;">ğŸ”’</span>
										</div>
										<div>
											<div style="font-size:0.95rem;font-weight:600;color:#3f51b5;">çœŸÂ·å¤§å¤šæ•°</div>
											<div style="font-size:0.7rem;color:#7986cb;">è§£é”ç»ˆææŒ‘æˆ˜æ¨¡å¼</div>
										</div>
									</div>
									<div style="text-align:right;">
										<div style="font-size:1.2rem;font-weight:700;color:#3f51b5;">${unlockProgress.unlocked}<span style="font-size:0.85rem;color:#9fa8da;">/${unlockProgress.total}</span></div>
										<div style="font-size:0.65rem;color:#9fa8da;">å…¨çƒ ${trueNormalUnlockedCount} äºº</div>
									</div>
								</div>
								
								<div style="height:8px;background:#e8eaf6;border-radius:4px;margin-bottom:14px;overflow:hidden;">
									<div style="width:${progressPercent}%;height:100%;background:linear-gradient(90deg,#7c4dff,#536dfe);border-radius:4px;transition:width 0.5s ease;"></div>
								</div>
								
								<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;">
									${unlockProgress.details.map(d => {
										const normalCount = globalPhdStats[`${d.id}_normal`] || 0;
										const reversedCount = globalPhdStats[`${d.id}_reversed`] || 0;
										const bothDone = d.normalUnlocked && d.reversedUnlocked;
										
										return `
										<div style="padding:8px 10px;background:${bothDone ? 'linear-gradient(135deg,#e8f5e9,#c8e6c9)' : 'white'};border-radius:8px;border:1px solid ${bothDone ? '#a5d6a7' : '#e8eaf6'};">
											<div style="font-size:0.75rem;font-weight:600;color:${bothDone ? '#2e7d32' : '#5c6bc0'};margin-bottom:5px;display:flex;align-items:center;gap:4px;">
												${bothDone ? 'âœ“' : ''} ${d.name}
											</div>
											<div style="display:flex;gap:4px;">
												<span style="flex:1;text-align:center;padding:3px 0;border-radius:4px;font-size:0.6rem;
													${d.normalUnlocked 
														? 'background:#e8f5e9;color:#2e7d32;' 
														: 'background:#f5f5f5;color:#bdbdbd;'}">
													â˜€ï¸ ${d.normalUnlocked ? 'âœ“' : '-'}
												</span>
												<span style="flex:1;text-align:center;padding:3px 0;border-radius:4px;font-size:0.6rem;
													${d.reversedUnlocked 
														? 'background:#f3e5f5;color:#7b1fa2;' 
														: 'background:#f5f5f5;color:#bdbdbd;'}">
													ğŸŒ‘ ${d.reversedUnlocked ? 'âœ“' : '-'}
												</span>
											</div>
										</div>
									`}).join('')}
								</div>
								
								<div style="margin-top:12px;text-align:center;font-size:0.7rem;color:#9fa8da;">
									ğŸ’¡ æ¯ä¸ªè§’è‰²éœ€æ­£ä½+é€†ä½éƒ½åšå£«æ¯•ä¸šæ‰èƒ½è§£é”
								</div>
							</div>
						`;
					}
					progressContainer.style.display = 'block';
				} else {
					progressContainer.style.display = 'none';
				}
			}
			
			// æ¸²æŸ“è§’è‰²å¡ç‰‡
			grid.innerHTML = characters.map(char => {
				const isTrueNormalAvailable = char.id === 'normal' && !isReversedMode && trueNormalUnlocked;
				
				let data, displayIcon, displayName, displayDesc, displayBonus, displayAwaken;
				let statsCharId = char.id;
				let statsIsReversed = isReversedMode;
				
				if (isTrueNormalAvailable && isTrueNormalMode) {
					displayIcon = 'ğŸŒ';  
					displayName = 'çœŸÂ·å¤§å¤šæ•°';  
					displayDesc = 'ç»å†è¿‡æ‰€æœ‰è§’è‰²çš„æ´—ç¤¼ï¼Œå›å½’æœ¬çœŸ';
					displayBonus = 'æ— ç‰¹æ®Šèƒ½åŠ›ï¼Œä¸€åˆ‡é è‡ªå·±';
					displayAwaken = {
						icon: 'âŒ',
						name: 'æ— ',
						desc: 'è½¬åšæ—¶æ²¡æœ‰ä»»ä½•è§‰é†’æ•ˆæœ'
					};
					data = char;
					statsCharId = 'true-normal';
					statsIsReversed = false;
				} else if (isReversedMode && char.reversed) {
					data = char.reversed;
					displayIcon = data.icon;
					displayName = data.name;
					displayDesc = data.desc;
					displayBonus = data.bonus;
					displayAwaken = {
						icon: data.awakenIcon,
						name: data.awakenName,
						desc: data.awakenDesc
					};
				} else {
					data = char;
					displayIcon = char.icon;
					displayName = char.name;
					displayDesc = char.desc;
					displayBonus = char.bonus;
					displayAwaken = {
						icon: char.awakenIcon,
						name: char.awakenName,
						desc: char.awakenDesc
					};
				}
				
				const diffKey = `${statsCharId}_${statsIsReversed ? 'reversed' : 'normal'}`;
				const diffData = characterDifficultyData[diffKey] || { stars: null, rate: null, total: 0 };
				
				// è·å–æœ¬åœ°æœ€é«˜è®°å½•
				const localRecord = getCharacterLocalRecord(statsCharId, statsIsReversed);
				const hasLocalRecord = localRecord.maxScore > 0;
				
				// è·å–å…¨çƒè®°å½•
				const mode = statsIsReversed ? 'reversed' : 'normal';
				const globalRecord = globalRecords?.[mode]?.[statsCharId] || {
					today: { maxScore: 0, maxCitations: 0, maxAchievements: 0 },
					history: { maxScore: 0, maxCitations: 0, maxAchievements: 0 }
				};
				const hasGlobalRecord = globalRecord.history.maxScore > 0;
				
				// éš¾åº¦æ˜¾ç¤º
				let starsHtml, badgeHtml, rateText, totalGames;
				if (statsCharId === 'true-normal') {
					starsHtml = renderDifficultyStars(12);
					badgeHtml = '<span class="difficulty-badge legendary">ä¼ è¯´</span>';
					rateText = diffData.rate !== null ? `${(diffData.rate * 100).toFixed(1)}%` : '?';
					totalGames = diffData.total || 0;
				} else {
					starsHtml = renderDifficultyStars(diffData.stars);
					badgeHtml = getDifficultyBadge(diffData.stars);
					rateText = diffData.rate !== null ? `${(diffData.rate * 100).toFixed(1)}%` : '?';
					totalGames = diffData.total || 0;
				}
				
				const cardClass = isReversedMode ? 'character-card reversed-card' : 'character-card';
				const bonusClass = isReversedMode ? 'background:rgba(231,76,60,0.15);color:#e74c3c;' : '';
				
				const trueNormalStyle = (isTrueNormalAvailable && isTrueNormalMode) 
					? 'background:linear-gradient(135deg,rgba(255,215,0,0.15),rgba(255,140,0,0.15));border-color:rgba(255,140,0,0.5);' 
					: '';
				const trueNormalBonusStyle = (isTrueNormalAvailable && isTrueNormalMode)
					? 'background:linear-gradient(135deg,rgba(255,215,0,0.2),rgba(255,140,0,0.2));color:#d68910;'
					: bonusClass;
				
				const awakenBg = isReversedMode 
					? 'background:linear-gradient(135deg,rgba(155,89,182,0.15),rgba(231,76,60,0.15));border-color:rgba(231,76,60,0.4);' 
					: (isTrueNormalAvailable && isTrueNormalMode)
						? 'background:linear-gradient(135deg,rgba(149,165,166,0.15),rgba(127,140,141,0.15));border-color:rgba(127,140,141,0.4);'
						: 'background:linear-gradient(135deg,rgba(102,126,234,0.1),rgba(118,75,162,0.1));border-color:rgba(102,126,234,0.3);';
				const awakenColor = isReversedMode ? '#e74c3c' : (isTrueNormalAvailable && isTrueNormalMode) ? '#7f8c8d' : 'var(--primary-color)';

				let hiddenAwakenHint = '';
				if (!isReversedMode && char.hiddenAwakenName && !(isTrueNormalAvailable && isTrueNormalMode)) {
					hiddenAwakenHint = `
						<div style="margin-top:6px;padding:4px 8px;background:linear-gradient(135deg,rgba(253,203,110,0.15),rgba(243,156,18,0.15));border-radius:6px;border:1px dashed rgba(243,156,18,0.4);">
							<div style="font-size:0.6rem;color:#d68910;display:flex;align-items:center;gap:4px;">
								<span>âš™ï¸</span>
								<span>éšè—è§‰é†’ï¼šæ¸¸æˆä¸­ç‰¹å®šæ¡ä»¶è§¦å‘</span>
							</div>
						</div>
					`;
				}

				const metaRecordHtml = `
					<div class="meta-records" style="margin-top:8px;padding:8px;background:var(--light-bg);border-radius:8px;font-size:0.6rem;">
						<div style="margin-bottom:6px;padding-bottom:6px;border-bottom:1px dashed var(--border-color);">
							<div style="font-weight:600;color:var(--success-color);margin-bottom:4px;">ğŸ‘¤ æˆ‘çš„æœ€é«˜</div>
							${hasLocalRecord ? `
								<div style="display:flex;justify-content:space-between;color:var(--text-secondary);">
									<span>ğŸ¯${localRecord.maxScore}åˆ†</span>
									<span style="color:var(--border-color);">|</span>
									<span>ğŸ“š${localRecord.maxCitations}å¼•</span>
									<span style="color:var(--border-color);">|</span>
									<span>ğŸ†${localRecord.maxAchievements}æˆå°±</span>
								</div>
							` : `<div style="color:var(--text-secondary);text-align:center;">æš‚æ— è®°å½•</div>`}
						</div>
						<div style="margin-bottom:6px;padding-bottom:6px;border-bottom:1px dashed var(--border-color);">
							<div style="font-weight:600;color:var(--warning-color);margin-bottom:4px;">â˜€ï¸ ä»Šæ—¥å…¨çƒ</div>
							${globalRecord.today.maxScore > 0 ? `
								<div style="display:flex;justify-content:space-between;color:var(--text-secondary);">
									<span>ğŸ¯${globalRecord.today.maxScore}åˆ†</span>
									<span style="color:var(--border-color);">|</span>
									<span>ğŸ“š${globalRecord.today.maxCitations}å¼•</span>
									<span style="color:var(--border-color);">|</span>
									<span>ğŸ†${globalRecord.today.maxAchievements}æˆå°±</span>
								</div>
							` : `<div style="color:var(--text-secondary);text-align:center;">ä»Šæ—¥æš‚æ— </div>`}
						</div>
						<div>
							<div style="font-weight:600;color:var(--accent-color);margin-bottom:4px;">ğŸ‘‘ å†å²å…¨çƒ</div>
							${hasGlobalRecord ? `
								<div style="display:flex;justify-content:space-between;color:var(--text-secondary);">
									<span>ğŸ¯${globalRecord.history.maxScore}åˆ†</span>
									<span style="color:var(--border-color);">|</span>
									<span>ğŸ“š${globalRecord.history.maxCitations}å¼•</span>
									<span style="color:var(--border-color);">|</span>
									<span>ğŸ†${globalRecord.history.maxAchievements}æˆå°±</span>
								</div>
							` : `<div style="color:var(--text-secondary);text-align:center;">æš‚æ— è®°å½•</div>`}
						</div>
					</div>
				`;

				const difficultyNote = (statsCharId === 'true-normal') 
					? '<div style="font-size:0.5rem;color:#9b59b6;margin-top:2px;">âš ï¸ å›ºå®šæœ€é«˜éš¾åº¦</div>' 
					: '';

				// â˜…â˜…â˜… æ£€æŸ¥è¯¥å¡ç‰‡æ˜¯å¦æŠ˜å  â˜…â˜…â˜…
				const cardKey = `${char.id}_${isReversedMode ? 'reversed' : 'normal'}`;
				const isCollapsed = cardCollapseStates[cardKey] || false;
				const collapsedClass = isCollapsed ? 'card-collapsed' : '';
				const bodyCollapsedClass = isCollapsed ? 'collapsed' : '';
				const iconRotatedClass = isCollapsed ? 'rotated' : '';

				return `
				<div class="${cardClass} ${collapsedClass}" data-id="${char.id}" style="${trueNormalStyle}">
					<!-- å¡ç‰‡å¤´éƒ¨ï¼ˆå¯ç‚¹å‡»æŠ˜å ï¼‰-->
					<div class="card-header" onclick="toggleCharacterCard('${char.id}', event)">
						<div class="header-left">
							<span style="font-size:1.5rem;">${displayIcon}</span>
							<span style="font-weight:600;font-size:1rem;">${displayName}</span>
						</div>
						<div class="mini-difficulty">
							<span style="font-size:0.6rem;color:var(--text-secondary);">${diffData.stars !== null ? diffData.stars + 'â˜…' : '?'}</span>
							${badgeHtml}
						</div>
						<i class="fas fa-chevron-down collapse-icon ${iconRotatedClass}"></i>
					</div>
					
					<!-- å¡ç‰‡å†…å®¹ï¼ˆå¯æŠ˜å ï¼‰-->
					<div class="card-body ${bodyCollapsedClass}">
						<div class="desc">${displayDesc}</div>
						<div class="bonus" style="${trueNormalBonusStyle}">${displayBonus}</div>
						<div class="awaken-info" style="margin-top:8px;padding:6px 8px;${awakenBg}border-radius:6px;border:1px dashed;">
							<div style="font-size:0.65rem;color:${awakenColor};font-weight:600;margin-bottom:2px;">
								<span style="margin-right:3px;">âš¡</span>è½¬åšè§‰é†’: ${displayAwaken.icon} ${displayAwaken.name}
							</div>
							<div style="font-size:0.6rem;color:var(--text-secondary);">${displayAwaken.desc}</div>
							${hiddenAwakenHint}
						</div>
						${metaRecordHtml}
						<div class="difficulty-container">
							<div>
								<span class="difficulty-label">éš¾åº¦</span>
								<div class="difficulty-stars">${starsHtml}</div>
								${difficultyNote}
							</div>
							<div style="text-align:right;">
								${badgeHtml}
								<div style="font-size:0.55rem;color:var(--text-secondary);margin-top:2px;">
									åšå£«ç‡:${rateText} (${totalGames}å±€)
								</div>
							</div>
						</div>
					</div>
				</div>
			`}).join('');
			
			// â˜…â˜…â˜… ä¸ºå¡ç‰‡æ·»åŠ ç‚¹å‡»é€‰æ‹©åŠŸèƒ½ï¼ˆæ’é™¤æŠ˜å æŒ‰é’®åŒºåŸŸï¼‰â˜…â˜…â˜…
			document.querySelectorAll('.character-card').forEach(card => {
				card.addEventListener('click', function(e) {
					// å¦‚æœç‚¹å‡»çš„æ˜¯æŠ˜å æŒ‰é’®åŒºåŸŸï¼Œä¸è§¦å‘é€‰æ‹©
					if (e.target.closest('.card-header')) return;
					selectCharacter(this.dataset.id);
				});
			});
		}

		// ==================== è§’è‰²å¡ç‰‡æŠ˜å çŠ¶æ€ ====================

		function getCharacterCardCollapseStates() {
			try {
				const saved = localStorage.getItem('graduateSimulator_cardCollapseStates');
				return saved ? JSON.parse(saved) : {};
			} catch (e) {
				return {};
			}
		}

		function saveCharacterCardCollapseStates(states) {
			try {
				localStorage.setItem('graduateSimulator_cardCollapseStates', JSON.stringify(states));
			} catch (e) {
				console.warn('ä¿å­˜å¡ç‰‡æŠ˜å çŠ¶æ€å¤±è´¥:', e);
			}
		}

		function toggleCharacterCard(charId, event) {
			event.stopPropagation(); // é˜»æ­¢å†’æ³¡ï¼Œé¿å…è§¦å‘é€‰æ‹©
			
			const cardKey = `${charId}_${isReversedMode ? 'reversed' : 'normal'}`;
			const states = getCharacterCardCollapseStates();
			
			states[cardKey] = !states[cardKey];
			saveCharacterCardCollapseStates(states);
			
			// æ‰¾åˆ°å¯¹åº”å¡ç‰‡å¹¶åˆ‡æ¢çŠ¶æ€
			const card = document.querySelector(`.character-card[data-id="${charId}"]`);
			if (card) {
				const body = card.querySelector('.card-body');
				const icon = card.querySelector('.card-header .collapse-icon');
				
				if (states[cardKey]) {
					card.classList.add('card-collapsed');
					body.classList.add('collapsed');
					icon.classList.add('rotated');
				} else {
					card.classList.remove('card-collapsed');
					body.classList.remove('collapsed');
					icon.classList.remove('rotated');
				}
			}
		}

		// å…¨éƒ¨å±•å¼€/æ”¶èµ·è§’è‰²å¡ç‰‡
		function toggleAllCharacterCards(collapse) {
			const states = getCharacterCardCollapseStates();
			const mode = isReversedMode ? 'reversed' : 'normal';
			
			characters.forEach(char => {
				const cardKey = `${char.id}_${mode}`;
				states[cardKey] = collapse;
			});
			
			saveCharacterCardCollapseStates(states);
			renderCharacterGrid();
		}

		// åˆ‡æ¢çœŸÂ·å¤§å¤šæ•°æ¨¡å¼
		function toggleTrueNormalMode() {
			isTrueNormalMode = !isTrueNormalMode;
			renderCharacterGrid();
			
			if (isTrueNormalMode) {
				// â˜…â˜…â˜… ä¿®å¤ï¼šå¼€å¯çœŸÂ·å¤§å¤šæ•°æ¨¡å¼æ—¶ï¼Œè‡ªåŠ¨é€‰ä¸­ normal è§’è‰² â˜…â˜…â˜…
				setTimeout(() => selectCharacter('normal'), 50);
			} else {
				// å…³é—­çœŸÂ·å¤§å¤šæ•°æ¨¡å¼æ—¶ï¼Œå¦‚æœä¹‹å‰é€‰ä¸­çš„æ˜¯ normalï¼Œé‡æ–°é€‰ä¸­ä»¥æ›´æ–°æ ·å¼
				if (selectedCharacter && selectedCharacter.id === 'normal') {
					setTimeout(() => selectCharacter('normal'), 50);
				}
			}
		}

		function selectCharacter(id) {
			selectedCharacter = characters.find(c => c.id === id);
			
			// â˜…â˜…â˜… ä¿®å¤ï¼šå¦‚æœåœ¨çœŸÂ·å¤§å¤šæ•°æ¨¡å¼ä¸‹é€‰æ‹©äº†å…¶ä»–è§’è‰²ï¼Œå…³é—­çœŸÂ·å¤§å¤šæ•°æ¨¡å¼ â˜…â˜…â˜…
			if (isTrueNormalMode && id !== 'normal') {
				isTrueNormalMode = false;
				renderCharacterGrid();  // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°çœŸÂ·å¤§å¤šæ•°é¢æ¿çŠ¶æ€
			}
			
			document.querySelectorAll('.character-card').forEach(card => {
				card.classList.toggle('selected', card.dataset.id === id);
			});
			document.getElementById('start-btn').disabled = false;
		}

		async function startGame() {
			if (!selectedCharacter) return;

			gameState = getInitialState();
			
			// â˜…â˜…â˜… ä¿®å¤ï¼šçœŸÂ·å¤§å¤šæ•°ä½¿ç”¨ç‹¬ç«‹çš„è§’è‰²ID â˜…â˜…â˜…
			gameState.isTrueNormal = (selectedCharacter.id === 'normal' && !isReversedMode && isTrueNormalMode);
			gameState.character = gameState.isTrueNormal ? 'true-normal' : selectedCharacter.id;
			gameState.isReversed = isReversedMode;

			// çœŸÂ·å¤§å¤šæ•°æ²¡æœ‰åˆå§‹åŠ æˆ
			if (!gameState.isTrueNormal) {
				const charData = isReversedMode && selectedCharacter.reversed 
					? selectedCharacter.reversed 
					: selectedCharacter;
				
				gameState.characterName = charData.name;

				if (charData.stats.research) gameState.research += charData.stats.research;
				if (charData.stats.social) gameState.social += charData.stats.social;
				if (charData.stats.favor) gameState.favor += charData.stats.favor;
				if (charData.stats.gold) gameState.gold += charData.stats.gold;

				if (isReversedMode) {
					initReversedCharacter();
				}
			} else {
				gameState.characterName = 'çœŸÂ·å¤§å¤šæ•°';
			}

			shopItems.forEach(item => {
				if (item.once) item.bought = false;
				if (item.monthlyOnce) item.boughtThisMonth = false;
			});

			resetRandomEventPool();
			
			if(gameState.publishedPapers.length === 0) {
				gameState.availableRandomEvents = gameState.availableRandomEvents.filter(e => e !== 14);
			}

			// â˜…â˜…â˜… ä¿®æ”¹ï¼šå…ˆä½¿ç”¨é»˜è®¤å€¼ï¼Œç«‹å³æ˜¾ç¤ºæ¸¸æˆç•Œé¢ â˜…â˜…â˜…
			gameState.submissionStats = getDefaultSubmissionStats();

			// â˜…â˜…â˜… å…ˆåˆ‡æ¢ç•Œé¢ï¼Œä¸è¦ç­‰å¾…æ•°æ®åŠ è½½ â˜…â˜…â˜…
			document.getElementById('start-screen').classList.add('hidden');
			document.getElementById('game-screen').style.display = 'block';
			document.getElementById('mobile-quick-bar').classList.add('game-active');

			document.getElementById('log-content').innerHTML = '';
			checkResearchUnlock(true);
			updateAllUI();
			renderPaperSlots();

			addLog('æ¸¸æˆå¼€å§‹', `æ¬¢è¿æ¥åˆ°ç ”ç©¶ç”Ÿæ¨¡æ‹Ÿå™¨ï¼ä½ é€‰æ‹©äº†ã€${gameState.characterName}ã€‘`);
			
			if (isReversedMode) {
				addLog('âš ï¸ é€†ä½æ¨¡å¼', 'å‘½è¿çš„é˜´æš—é¢å·²å¼€å¯ï¼Œè§„åˆ™å°†æœ‰æ‰€ä¸åŒ...');
			}
			
			addLog('æ¸¸æˆç›®æ ‡', 'ç¡•å£«æ¯•ä¸šéœ€è¦ç§‘ç ”åˆ†â‰¥1ï¼Œåšå£«æ¯•ä¸šéœ€è¦ç§‘ç ”åˆ†â‰¥7');
			addLog('æ¸¸æˆæç¤º', 'è®ºæ–‡ç§‘ç ”åˆ†ï¼šAç±»=4åˆ†ï¼ŒBç±»=2åˆ†ï¼ŒCç±»=1åˆ†');
			addLog('æ“ä½œæç¤º', 'æ¯æœˆå¯æ‰§è¡Œä¸€æ¬¡æŒç»­æ“ä½œï¼ˆçœ‹è®ºæ–‡/æ‰“å·¥/æƒ³idea/åšå®éªŒ/å†™è®ºæ–‡ï¼‰');
			addLog('å±æ€§æç¤º', 'ç§‘ç ”èƒ½åŠ›å½±å“è®ºæ–‡åˆ†æ•°ï¼Œç¤¾äº¤èƒ½åŠ›å’Œå¯¼å¸ˆå¥½æ„Ÿåº¦å½±å“äº‹ä»¶èµ°å‘ï¼Œå»ºè®®ä¼˜å…ˆæå‡è‡³6');
			
			setTimeout(() => {
				applyCollapseStates();
			}, 100);

			// â˜…â˜…â˜… ä¿®æ”¹ï¼šåå°å¼‚æ­¥åŠ è½½æŠ•ç¨¿ç»Ÿè®¡ï¼Œå¸¦è¶…æ—¶æœºåˆ¶ â˜…â˜…â˜…
			loadSubmissionStatsAsync();
		}

		// â˜…â˜…â˜… æ–°å¢ï¼šå¼‚æ­¥åŠ è½½æŠ•ç¨¿ç»Ÿè®¡ï¼ˆå¸¦è¶…æ—¶å’Œé‡è¯•ï¼‰ â˜…â˜…â˜…
		async function loadSubmissionStatsAsync(retryCount = 0) {
			const maxRetries = 3;
			const timeout = 8000 + retryCount * 2000; // æ¯æ¬¡é‡è¯•å¢åŠ è¶…æ—¶æ—¶é—´
			
			try {
				// è®¾ç½®è¶…æ—¶
				const timeoutPromise = new Promise((_, reject) => {
					setTimeout(() => reject(new Error('åŠ è½½è¶…æ—¶')), timeout);
				});
				
				const loadPromise = loadSubmissionStats();
				
				const stats = await Promise.race([loadPromise, timeoutPromise]);
				
				if (stats && Object.keys(stats).length > 0) {
					gameState.submissionStats = stats;
					console.log('âœ… æŠ•ç¨¿ç»Ÿè®¡å·²åå°åŠ è½½å®Œæˆ');
					// åˆ·æ–°è®ºæ–‡æ§½æ˜¾ç¤ºï¼ˆæ›´æ–°å½•ç”¨ç‡ç­‰ä¿¡æ¯ï¼‰
					renderPaperSlots();
					updateResearchResults();
				} else {
					throw new Error('è¿”å›æ•°æ®ä¸ºç©º');
				}
			} catch (e) {
				console.warn(`åå°åŠ è½½æŠ•ç¨¿ç»Ÿè®¡å¤±è´¥(ç¬¬${retryCount + 1}æ¬¡):`, e.message);
				
				// â˜…â˜…â˜… é‡è¯•æœºåˆ¶ â˜…â˜…â˜…
				if (retryCount < maxRetries) {
					console.log(`å°†åœ¨3ç§’åé‡è¯•...`);
					setTimeout(() => {
						loadSubmissionStatsAsync(retryCount + 1);
					}, 3000);
				} else {
					console.warn('æŠ•ç¨¿ç»Ÿè®¡åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼');
					// ç¡®ä¿ä½¿ç”¨æœ‰æ•ˆçš„é»˜è®¤å€¼
					if (!gameState.submissionStats) {
						gameState.submissionStats = getDefaultSubmissionStats();
					}
					renderPaperSlots();
				}
			}
		}

        // â˜…â˜…â˜… å…³é”®ä¿®æ”¹ï¼šé€†ä½è§’è‰²åˆå§‹åŒ– â˜…â˜…â˜…
        function initReversedCharacter() {
            switch (gameState.character) {
                case 'genius':
                    gameState.research = 0;
                    gameState.paperSlots = 4;
                    addLog('é€†ä½æ•ˆæœ', 'æ„šé’ä¹‹ã€Šé™¢å£«è½¬ä¸–ã€‹', 'ç§‘ç ”èƒ½åŠ›å›ºå®šä¸º0ï¼Œå…¨éƒ¨è®ºæ–‡æ§½å·²è§£é”');
                    break;
                    
				case 'rich':
					// â˜…â˜…â˜… ä¿®æ”¹ï¼šé‡ç½®ä¸º1è€Œä¸æ˜¯0 â˜…â˜…â˜…
					gameState.san = 1;
					gameState.research = 1;
					gameState.social = 1;
					gameState.favor = 1;
					gameState.goldSpentTotal = 0;
					gameState.lastResetMonth = 0;
					addLog('é€†ä½æ•ˆæœ', 'è´ªæ±‚ä¹‹ã€Šå¯Œå¯æ•Œå›½ã€‹', 
						 'é™¤äº†é’±ä¸€æ— æ‰€æœ‰ï¼Œæ¯æœˆå±æ€§é‡ç½®ä¸º1ï¼Œé‡‘é’±+3');
					break;
                    
				case 'teacher-child':
					// â˜…â˜…â˜… æ–°èƒ½åŠ›ï¼šå¥½æ„Ÿä¸ä¼šä½äº0ï¼Œå½’é›¶æ—¶é‡ç½® â˜…â˜…â˜…
					// åˆå§‹å¥½æ„Ÿåº¦å·²åœ¨è§’è‰²statsä¸­è®¾ç½®ä¸º9ï¼ˆ+åŸºç¡€1=10ï¼‰
					addLog('é€†ä½æ•ˆæœ', 'ç©ä¸–ä¹‹ã€Šå¯¼å¸ˆå­å¥³ã€‹', 
						 'å¥½æ„Ÿåº¦ä¸ä¼šä½äº0ï¼Œå½’é›¶æ—¶é‡ç½®ä¸º4å¹¶è·å¾—å¥–åŠ±');
					break;
                    
                case 'social':
                    // ä¿æŒåŸæœ‰æ•ˆæœ
                    break;
                    
                case 'chosen':
                    // ä¿æŒåŸæœ‰æ•ˆæœ
                    break;
                    
                case 'normal':
                    // ä¿æŒåŸæœ‰æ•ˆæœ
                    break;
            }
        }

        function resetRandomEventPool() {
            gameState.availableRandomEvents = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 12, 13, 15];
            if(gameState.publishedPapers.length > 0) {
                gameState.availableRandomEvents.push(14);
            }
            gameState.usedRandomEvents = [];
        }

        // ==================== é€šç”¨å±æ€§ä¿®æ”¹å‡½æ•°ï¼ˆæ”¯æŒé€†ä½ï¼‰====================
        // è®¡ç®—å®é™…SANå˜åŒ–å€¼ï¼ˆè€ƒè™‘æ€ æƒ°ä¹‹å¤§å¤šæ•°çš„ç¿»å€æ•ˆæœï¼‰
        function getActualSanChange(delta) {
            if (gameState.isReversed && gameState.character === 'normal' && delta < 0) {
                const multiplier = gameState.reversedAwakened ? 3 : 2;
                return delta * multiplier;
            }
            return delta;
        }
        
        function changeSan(delta) {
            if (gameState.isReversed && gameState.character === 'normal' && delta < 0) {
                const multiplier = gameState.reversedAwakened ? 3 : 2;
                delta = delta * multiplier;
            }
            
            if (delta > 0) {
                gameState.san = Math.min(gameState.sanMax, gameState.san + delta);
            } else {
                gameState.san += delta;
            }
            updateAllUI();
            if (gameState.san < 0) {
                triggerEnding('burnout');
                return false;
            }
            return true;
        }

        // â˜…â˜…â˜… å…³é”®ä¿®æ”¹ï¼šchangeGoldå‡½æ•° â˜…â˜…â˜…
		function changeGold(delta) {
			// â˜…â˜…â˜… ä¿®æ”¹ï¼šè´ªæ±‚ä¹‹å¯Œå¯æ•Œå›½è§‰é†’åæ¯èŠ±è´¹4é‡‘å¸å±æ€§å„+1 â˜…â˜…â˜…
			if (gameState.isReversed && gameState.character === 'rich' && gameState.reversedAwakened && delta < 0) {
				const spent = Math.abs(delta);
				gameState.goldSpentTotal = (gameState.goldSpentTotal || 0) + spent;
				
				// â˜…â˜…â˜… ä¿®æ”¹ï¼šæ¯æ¶ˆè´¹4é‡‘å¸ï¼ŒSAN/ç§‘ç ”/ç¤¾äº¤/å¥½æ„Ÿå„+1 â˜…â˜…â˜…
				const attributeGains = Math.floor(gameState.goldSpentTotal / 4);
				const previousGains = Math.floor((gameState.goldSpentTotal - spent) / 4);
				const newGains = attributeGains - previousGains;
				
				if (newGains > 0) {
					gameState.san = Math.min(gameState.sanMax, gameState.san + newGains);
					gameState.research = Math.min(20, gameState.research + newGains);
					gameState.social = Math.min(20, gameState.social + newGains);
					gameState.favor = Math.min(20, gameState.favor + newGains);
					addLog('é€†ä½æ•ˆæœ', 'é‡‘é’±è§‰é†’', `ç´¯è®¡æ¶ˆè´¹${gameState.goldSpentTotal}é‡‘ â†’ SAN+${newGains}, ç§‘ç ”+${newGains}, ç¤¾äº¤+${newGains}, å¥½æ„Ÿ+${newGains}`);
				}
			}
			
			gameState.gold += delta;
			updateAllUI();
			if (gameState.gold < 0) {
				triggerEnding('poor');
				return false;
			}
			return true;
		}

		function changeFavor(delta) {
			const favorMax = gameState.favorMax || 20;
			
			// â˜…â˜…â˜… ç©ä¸–ä¹‹å¯¼å¸ˆå­å¥³ï¼šå…¨æ–°èƒ½åŠ› - å¥½æ„Ÿä¸ä¼šä½äº0ï¼Œå½’é›¶æ—¶é‡ç½® â˜…â˜…â˜…
			if (gameState.isReversed && gameState.character === 'teacher-child') {
				// æ­£å¸¸åº”ç”¨å¥½æ„Ÿåº¦å˜åŒ–ï¼ˆä¸åè½¬ï¼‰
				if (delta > 0) {
					gameState.favor = Math.min(favorMax, gameState.favor + delta);
				} else {
					gameState.favor += delta;
				}
				
				// å¥½æ„Ÿåº¦å½’é›¶æ£€æµ‹
				if (gameState.favor <= 0) {
					if (gameState.reversedAwakened) {
						// è§‰é†’åï¼šé‡ç½®ä¸º2ï¼Œç¤¾äº¤+1ï¼Œç§‘ç ”+1ï¼Œé‡‘å¸+2
						gameState.favor = 2;
						gameState.social = Math.min(gameState.socialMax || 20, gameState.social + 1);
						gameState.research = Math.min(gameState.researchMax || 20, gameState.research + 1);
						gameState.gold += 2;
						addLog('é€†ä½æ•ˆæœ', 'å˜æœ¬åŠ å‰ï¼ˆè§‰é†’ï¼‰', `å¥½æ„Ÿåº¦å½’é›¶ï¼Œé‡ç½®ä¸º2 â†’ ç¤¾äº¤+1, ç§‘ç ”+1, é‡‘å¸+2`);
					} else {
						// æœªè§‰é†’ï¼šé‡ç½®ä¸º4ï¼Œç¤¾äº¤+1ï¼Œç§‘ç ”+1ï¼Œé‡‘å¸+2
						gameState.favor = 4;
						gameState.social = Math.min(gameState.socialMax || 20, gameState.social + 1);
						gameState.research = Math.min(gameState.researchMax || 20, gameState.research + 1);
						gameState.gold += 2;
						addLog('é€†ä½æ•ˆæœ', 'å˜æœ¬åŠ å‰', `å¥½æ„Ÿåº¦å½’é›¶ï¼Œé‡ç½®ä¸º4 â†’ ç¤¾äº¤+1, ç§‘ç ”+1, é‡‘å¸+2`);
					}
				}
				
				updateAllUI();
				// ç©ä¸–ä¹‹å¯¼å¸ˆå­å¥³ä¸ä¼šå› å¥½æ„Ÿåº¦è§¦å‘é€€å­¦
				return true;
			}
			
			// éå¯¼å¸ˆå­å¥³çš„åŸæœ‰é€»è¾‘
			if (delta > 0) {
				gameState.favor = Math.min(favorMax, gameState.favor + delta);
			} else {
				gameState.favor += delta;
			}
			
			updateAllUI();
			if (gameState.favor < 0) {
				triggerEnding('expelled');
				return false;
			}
			return true;
		}

		function changeResearch(delta) {
			// æ„šé’ä¹‹é™¢å£«è½¬ä¸–ï¼šç§‘ç ”èƒ½åŠ›å›ºå®šä¸º0
			if (gameState.isReversed && gameState.character === 'genius') {
				if (delta > 0) {
					gameState.blockedResearchGains += delta;
					if (gameState.reversedAwakened) {
						// â˜…â˜…â˜… ä¿®æ”¹ï¼šè§‰é†’åé‡‘+8ï¼ŒSAN+8ï¼Œç¤¾äº¤+2ï¼Œå¥½æ„Ÿ+2 â˜…â˜…â˜…
						const sanGain = delta * 8;
						const goldGain = delta * 8;
						const favorGain = delta * 2;
						const socialGain = delta * 2;
						gameState.san = Math.min(gameState.sanMax, gameState.san + sanGain);
						gameState.gold += goldGain;
						gameState.favor = Math.min(20, gameState.favor + favorGain);
						gameState.social = Math.min(20, gameState.social + socialGain);
						addLog('é€†ä½æ•ˆæœ', 'å¤§æ™ºè‹¥æ„š', `ç§‘ç ”æå‡è¢«è½¬åŒ– â†’ SAN+${sanGain}, é‡‘+${goldGain}, å¥½æ„Ÿ+${favorGain}, ç¤¾äº¤+${socialGain}`);
					} else {
						// â˜…â˜…â˜… ä¿®æ”¹ï¼šæœªè§‰é†’æ—¶é‡‘+4ï¼ŒSAN+4ï¼Œç¤¾äº¤+1ï¼Œå¥½æ„Ÿ+1 â˜…â˜…â˜…
						const sanGain = delta * 4;
						const goldGain = delta * 4;
						const socialGain = delta * 1;
						const favorGain = delta * 1;
						gameState.san = Math.min(gameState.sanMax, gameState.san + sanGain);
						gameState.gold += goldGain;
						gameState.social = Math.min(20, gameState.social + socialGain);
						gameState.favor = Math.min(20, gameState.favor + favorGain);
						addLog('é€†ä½æ•ˆæœ', 'æ„šé’è½¬åŒ–', `ç§‘ç ”æå‡è¢«è½¬åŒ– â†’ SAN+${sanGain}, é‡‘+${goldGain}, ç¤¾äº¤+${socialGain}, å¥½æ„Ÿ+${favorGain}`);
					}
				}
				gameState.research = 0;
				updateAllUI();
				return true;
			}
            
			if (delta > 0) {
				// â˜…â˜…â˜… ä¿®æ”¹ï¼šä½¿ç”¨åŠ¨æ€ä¸Šé™ â˜…â˜…â˜…
				const maxResearch = gameState.researchMax || 20;
				gameState.research = Math.min(maxResearch, gameState.research + delta);
				checkResearchUnlock();
			} else {
				gameState.research = Math.max(0, gameState.research + delta);
			}
			updateAllUI();
			return true;
		}

		function changeSocial(delta) {
			const oldSocial = gameState.social;
			const socialMax = gameState.socialMax || 20;

			if (delta > 0) {
				gameState.social = Math.min(socialMax, gameState.social + delta);
			} else {
				gameState.social += delta;
			}

			// æ£€æŸ¥ç¤¾äº¤èƒ½åŠ›æ˜¯å¦ä¸ºè´Ÿæ•°
			if (gameState.social < 0) {
				triggerEnding('isolated'); // è§¦å‘â€œè¢«å­¤ç«‹â€ç»“å±€
				return false;
			}

			// å…¶ä»–é€»è¾‘ï¼ˆå¦‚é€†ä½è§’è‰²çš„æ•ˆæœï¼‰
			if (gameState.isReversed && gameState.character === 'social') {
				const change = gameState.social - oldSocial;
				if (change < 0) {
					const amount = Math.abs(change);
					changeResearch(amount);
					gameState.favor = Math.min(gameState.favorMax || 20, gameState.favor + amount);
					addLog('é€†ä½æ•ˆæœ', 'å«‰å¦’è½¬åŒ–', `ç¤¾äº¤-${amount} â†’ ç§‘ç ”+${amount}, å¥½æ„Ÿ+${amount}`);
				} else if (change > 0) {
					gameState.san = Math.min(gameState.sanMax, gameState.san + change);
					gameState.gold += change;
					addLog('é€†ä½æ•ˆæœ', 'å«‰å¦’åé¦ˆ', `ç¤¾äº¤+${change} â†’ SAN+${change}, é‡‘é’±+${change}`);
				}
			}

			updateAllUI();
			return true;
		}


        // â˜…â˜…â˜… å…³é”®ä¿®æ”¹ï¼šchangeStatså‡½æ•° â˜…â˜…â˜…
        function changeStats(changes) {
            let gameOver = false;
            
            if (changes.sanMax) gameState.sanMax += changes.sanMax;
            
            if (changes.san) {
                let sanDelta = changes.san;
                if (gameState.isReversed && gameState.character === 'normal' && sanDelta < 0) {
                    const multiplier = gameState.reversedAwakened ? 3 : 2;
                    sanDelta = sanDelta * multiplier;
                }
                
                if (sanDelta > 0) {
                    gameState.san = Math.min(gameState.sanMax, gameState.san + sanDelta);
                } else {
                    gameState.san += sanDelta;
                }
                if (gameState.san < 0) gameOver = 'burnout';
            }
            
			if (changes.gold) {
				// â˜…â˜…â˜… ä¿®æ”¹ï¼šè´ªæ±‚ä¹‹å¯Œå¯æ•Œå›½è§‰é†’åæ¯èŠ±è´¹4é‡‘å¸å±æ€§å„+1 â˜…â˜…â˜…
				if (gameState.isReversed && gameState.character === 'rich' && gameState.reversedAwakened && changes.gold < 0) {
					const spent = Math.abs(changes.gold);
					gameState.goldSpentTotal = (gameState.goldSpentTotal || 0) + spent;
					
					// â˜…â˜…â˜… ä¿®æ”¹ï¼š6æ”¹ä¸º4 â˜…â˜…â˜…
					const attributeGains = Math.floor(gameState.goldSpentTotal / 4);
					const previousGains = Math.floor((gameState.goldSpentTotal - spent) / 4);
					const newGains = attributeGains - previousGains;
					
					if (newGains > 0) {
						gameState.san = Math.min(gameState.sanMax, gameState.san + newGains);
						gameState.research = Math.min(20, gameState.research + newGains);
						gameState.social = Math.min(20, gameState.social + newGains);
						gameState.favor = Math.min(20, gameState.favor + newGains);
						addLog('é€†ä½æ•ˆæœ', 'é‡‘é’±è§‰é†’', `ç´¯è®¡æ¶ˆè´¹${gameState.goldSpentTotal}é‡‘ â†’ SAN+${newGains}, ç§‘ç ”+${newGains}, ç¤¾äº¤+${newGains}, å¥½æ„Ÿ+${newGains}`);
					}
				}
				gameState.gold += changes.gold;
				if (gameState.gold < 0 && !gameOver) gameOver = 'poor';
			}
            
			if (changes.favor) {
				const favorMax = gameState.favorMax || 20;
				
				// â˜…â˜…â˜… ç©ä¸–ä¹‹å¯¼å¸ˆå­å¥³ï¼šå…¨æ–°èƒ½åŠ› â˜…â˜…â˜…
				if (gameState.isReversed && gameState.character === 'teacher-child') {
					if (changes.favor > 0) {
						gameState.favor = Math.min(favorMax, gameState.favor + changes.favor);
					} else {
						gameState.favor += changes.favor;
					}
					
					// âœ… æ·»åŠ å½’é›¶æ¡ä»¶åˆ¤æ–­
					if (gameState.favor <= 0) {
						if (gameState.reversedAwakened) {
							gameState.favor = 2;
							gameState.social = Math.min(gameState.socialMax || 20, gameState.social + 1);
							gameState.research = Math.min(gameState.researchMax || 20, gameState.research + 1);
							gameState.gold += 2;
							addLog('é€†ä½æ•ˆæœ', 'å˜æœ¬åŠ å‰ï¼ˆè§‰é†’ï¼‰', `å¥½æ„Ÿåº¦å½’é›¶ï¼Œé‡ç½®ä¸º2 â†’ ç¤¾äº¤+1, ç§‘ç ”+1, é‡‘å¸+2`);
						} else {
							gameState.favor = 4;
							gameState.social = Math.min(gameState.socialMax || 20, gameState.social + 1);
							gameState.research = Math.min(gameState.researchMax || 20, gameState.research + 1);
							gameState.gold += 2;
							addLog('é€†ä½æ•ˆæœ', 'å˜æœ¬åŠ å‰', `å¥½æ„Ÿåº¦å½’é›¶ï¼Œé‡ç½®ä¸º4 â†’ ç¤¾äº¤+1, ç§‘ç ”+1, é‡‘å¸+2`);
						}
					}
					// ç©ä¸–ä¹‹å¯¼å¸ˆå­å¥³ä¸ä¼šå› å¥½æ„Ÿåº¦è§¦å‘é€€å­¦
				} else {
					// éå¯¼å¸ˆå­å¥³çš„åŸæœ‰é€»è¾‘
					if (changes.favor > 0) {
						gameState.favor = Math.min(favorMax, gameState.favor + changes.favor);
					} else {
						gameState.favor += changes.favor;
					}
					if (gameState.favor < 0 && !gameOver) gameOver = 'expelled';
				}
			}
            
			if (changes.research) {
				if (gameState.isReversed && gameState.character === 'genius') {
					if (changes.research > 0) {
						gameState.blockedResearchGains += changes.research;
						// â˜…â˜…â˜… ä¿®æ”¹ï¼šè§‰é†’å8å€ï¼Œæœªè§‰é†’4å€ â˜…â˜…â˜…
						const sanGain = changes.research * (gameState.reversedAwakened ? 8 : 4);
						const goldGain = changes.research * (gameState.reversedAwakened ? 8 : 4);
						gameState.san = Math.min(gameState.sanMax, gameState.san + sanGain);
						gameState.gold += goldGain;
						// â˜…â˜…â˜… ä¿®æ”¹ï¼šæœªè§‰é†’ä¹Ÿæœ‰ç¤¾äº¤å’Œå¥½æ„ŸåŠ æˆ â˜…â˜…â˜…
						if (gameState.reversedAwakened) {
							gameState.favor = Math.min(20, gameState.favor + changes.research * 2);
							gameState.social = Math.min(20, gameState.social + changes.research * 2);
						} else {
							gameState.favor = Math.min(20, gameState.favor + changes.research * 1);
							gameState.social = Math.min(20, gameState.social + changes.research * 1);
						}
					}
					gameState.research = 0;
				} else {
                    if (changes.research > 0) {
                        gameState.research = Math.min(20, gameState.research + changes.research);
                        checkResearchUnlock();
                    } else {
                        gameState.research = Math.max(0, gameState.research + changes.research);
                    }
                }
            }
            
			if (changes.social) {
				const oldSocial = gameState.social;
				const socialMax = gameState.socialMax || 20;  // â˜…â˜…â˜… æ–°å¢ â˜…â˜…â˜…
				if (changes.social > 0) {
					gameState.social = Math.min(socialMax, gameState.social + changes.social);  // â˜…â˜…â˜… ä¿®æ”¹ â˜…â˜…â˜…
				} else {
					gameState.social = Math.max(0, gameState.social + changes.social);
				}
				
				// å«‰å¦’ä¹‹ç¤¾äº¤è¾¾äºº
				if (gameState.isReversed && gameState.character === 'social') {
					const change = gameState.social - oldSocial;
					if (change < 0) {
						const amount = Math.abs(change);
						changeResearch(amount);
						gameState.favor = Math.min(gameState.favorMax || 20, gameState.favor + amount);  // â˜…â˜…â˜… ä¿®æ”¹ â˜…â˜…â˜…
						addLog('é€†ä½æ•ˆæœ', 'å«‰å¦’è½¬åŒ–', `ç¤¾äº¤-${amount} â†’ ç§‘ç ”+${amount}, å¥½æ„Ÿ+${amount}`);
					} else if (change > 0) {
						gameState.san = Math.min(gameState.sanMax, gameState.san + change);
						gameState.gold += change;
						addLog('é€†ä½æ•ˆæœ', 'å«‰å¦’åé¦ˆ', `ç¤¾äº¤+${change} â†’ SAN+${change}, é‡‘é’±+${change}`);
					}
				}
			}
            
            updateAllUI();
            
            if (gameOver) {
                triggerEnding(gameOver);
                return false;
            }
            return true;
        }
		
        // ==================== UIæ›´æ–° ====================
        function updateAllUI() {
            updateAttributes();
            updateGraduation();
            updateBuffs();
            updateResearchResults();
            updateActionButtons();
            updateEventPreview();
        }

		function updateAttributes() {
			document.getElementById('san-value').textContent = gameState.san;
			document.getElementById('san-max').textContent = gameState.sanMax;
			document.getElementById('san-bar').style.width = `${Math.max(0, (gameState.san / gameState.sanMax) * 100)}%`;

			const researchMax = gameState.researchMax || 20;
			document.getElementById('research-value').textContent = gameState.research;
			document.getElementById('research-max').textContent = researchMax;
			document.getElementById('research-bar').style.width = `${(gameState.research / researchMax) * 100}%`;

			// â˜…â˜…â˜… ä¿®æ”¹ï¼šæ”¯æŒåŠ¨æ€ç¤¾äº¤ä¸Šé™ â˜…â˜…â˜…
			const socialMax = gameState.socialMax || 20;
			document.getElementById('social-value').textContent = gameState.social;
			// éœ€è¦åœ¨HTMLä¸­æ·»åŠ social-maxå…ƒç´ ï¼Œæˆ–è€…ä¿®æ”¹æ˜¾ç¤ºæ–¹å¼
			const socialValueEl = document.querySelector('#attributes-panel .attribute-bar:nth-child(4) .value');
			if (socialValueEl) {
				socialValueEl.innerHTML = `<span id="social-value">${gameState.social}</span>/${socialMax}`;
			}
			document.getElementById('social-bar').style.width = `${(gameState.social / socialMax) * 100}%`;

			// â˜…â˜…â˜… ä¿®æ”¹ï¼šæ”¯æŒåŠ¨æ€å¥½æ„Ÿä¸Šé™ â˜…â˜…â˜…
			const favorMax = gameState.favorMax || 20;
			document.getElementById('favor-value').textContent = gameState.favor;
			const favorValueEl = document.querySelector('#attributes-panel .attribute-bar:nth-child(5) .value');
			if (favorValueEl) {
				favorValueEl.innerHTML = `<span id="favor-value">${gameState.favor}</span>/${favorMax}`;
			}
			document.getElementById('favor-bar').style.width = `${Math.max(0, (gameState.favor / favorMax) * 100)}%`;

			document.getElementById('gold-value').textContent = gameState.gold;
			updateCharacterDisplay();
		}

		function updateCharacterDisplay() {
			// â˜…â˜…â˜… ä¿®å¤ï¼šå…ˆæ£€æŸ¥çœŸÂ·å¤§å¤šæ•° â˜…â˜…â˜…
			if (gameState.isTrueNormal) {
				document.getElementById('char-icon').textContent = 'ğŸŒ';
				document.getElementById('char-name').textContent = 'çœŸÂ·å¤§å¤šæ•°';
				
				const modeEl = document.getElementById('char-mode');
				modeEl.textContent = 'âœ¨ çœŸå®';
				modeEl.className = 'char-mode normal-mode';
				modeEl.style.background = 'linear-gradient(135deg,rgba(255,215,0,0.3),rgba(255,140,0,0.3))';
				modeEl.style.color = '#d68910';
				return;
			}
			
			// ç„¶åå†æŸ¥æ‰¾æ™®é€šè§’è‰²
			const charData = characters.find(c => c.id === gameState.character);
			if (!charData) return;
			
			const displayData = gameState.isReversed && charData.reversed ? charData.reversed : charData;
			const isAwakened = gameState.reversedAwakened || (gameState.degree === 'phd' && !gameState.isReversed);
			
			const icon = isAwakened
				? (gameState.isReversed ? displayData.awakenIcon : charData.awakenIcon)
				: displayData.icon;
			
			document.getElementById('char-icon').textContent = icon;
			document.getElementById('char-name').textContent = displayData.name;
			
			const modeEl = document.getElementById('char-mode');
			modeEl.style.background = '';  // é‡ç½®æ ·å¼
			modeEl.style.color = '';
			if (gameState.isReversed) {
				modeEl.textContent = 'ğŸŒ‘ é€†ä½';
				modeEl.className = 'char-mode reversed-mode';
			} else {
				modeEl.textContent = 'â˜€ï¸ æ­£ä½';
				modeEl.className = 'char-mode normal-mode';
			}
		}

		function showCharacterDetail() {
			// â˜…â˜…â˜… ä¿®å¤ï¼šçœŸÂ·å¤§å¤šæ•°ç‰¹æ®Šå¤„ç† â˜…â˜…â˜…
			if (gameState.character === 'true-normal' || gameState.isTrueNormal) {
				const html = `
					<div style="text-align:center;margin-bottom:15px;">
						<div style="font-size:3rem;margin-bottom:8px;">ğŸŒ</div>
						<div style="font-size:1.2rem;font-weight:700;color:#d68910;">çœŸÂ·å¤§å¤šæ•°</div>
						<div style="font-size:0.8rem;color:var(--text-secondary);margin-top:4px;">âœ¨ çœŸå®æ¨¡å¼</div>
					</div>
					
					<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:10px;">
						<div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:5px;">ğŸ“œ è§’è‰²æè¿°</div>
						<div style="font-size:0.85rem;">ç»å†è¿‡æ‰€æœ‰è§’è‰²çš„æ´—ç¤¼ï¼Œå›å½’æœ¬çœŸ</div>
					</div>
					
					<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:10px;">
						<div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:5px;">âœ¨ åˆå§‹æ•ˆæœ</div>
						<div style="font-size:0.85rem;color:var(--text-secondary);font-weight:500;">æ— ç‰¹æ®Šèƒ½åŠ›ï¼Œä¸€åˆ‡é è‡ªå·±</div>
					</div>
					
					<div style="background:rgba(149,165,166,0.15);border-radius:10px;padding:12px;border:1px dashed #7f8c8d;">
						<div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:5px;">âš¡ è½¬åšè§‰é†’</div>
						<div style="display:flex;align-items:center;gap:8px;margin-bottom:5px;">
							<span style="font-size:1.2rem;">âŒ</span>
							<span style="font-size:0.9rem;font-weight:600;color:#7f8c8d;">æ— è§‰é†’æ•ˆæœ</span>
						</div>
						<div style="font-size:0.85rem;">è½¬åšæ—¶æ²¡æœ‰ä»»ä½•ç‰¹æ®Šæ•ˆæœï¼Œè¿™å°±æ˜¯æœ€çœŸå®çš„ç ”ç©¶ç”Ÿç”Ÿæ´»</div>
						<div style="margin-top:6px;font-size:0.7rem;color:var(--text-secondary);">æœªæ¿€æ´» - è½¬åšæ—¶è§¦å‘ï¼ˆæ— æ•ˆæœï¼‰</div>
					</div>
				`;
				
				showModal('ğŸ‘¤ è§’è‰²è¯¦æƒ…', html, [{ text: 'å…³é—­', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			const charData = characters.find(c => c.id === gameState.character);
			if (!charData) {
				console.error('æ— æ³•æ‰¾åˆ°è§’è‰²æ•°æ®:', gameState.character);
				showModal('âŒ é”™è¯¯', '<p>è§’è‰²æ•°æ®åŠ è½½å¤±è´¥</p>', 
					[{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			const isReversed = gameState.isReversed;
			const displayData = isReversed && charData.reversed ? charData.reversed : charData;
			
			// â˜…â˜…â˜… æ–°å¢ï¼šåˆ¤æ–­æ˜¯å¦è§¦å‘äº†éšè—è§‰é†’ â˜…â˜…â˜…
			const hasHiddenAwaken = gameState.hiddenAwakened && !isReversed;
			const isAwakened = gameState.reversedAwakened || (gameState.degree === 'phd' && !isReversed) || hasHiddenAwaken;
			
			// â˜…â˜…â˜… ä¿®æ”¹ï¼šæ ¹æ®è§‰é†’ç±»å‹æ˜¾ç¤ºä¸åŒå›¾æ ‡ â˜…â˜…â˜…
			let currentIcon;
			if (hasHiddenAwaken) {
				currentIcon = charData.hiddenAwakenIcon;
			} else if (isAwakened) {
				currentIcon = isReversed ? displayData.awakenIcon : charData.awakenIcon;
			} else {
				currentIcon = displayData.icon;
			}
			
			const modeColor = isReversed ? '#9b59b6' : '#6c5ce7';
			const modeText = isReversed ? 'ğŸŒ‘ é€†ä½æ¨¡å¼' : 'â˜€ï¸ æ­£ä½æ¨¡å¼';
			
			// â˜…â˜…â˜… æ–°å¢ï¼šæ ¹æ®è§‰é†’ç±»å‹æ˜¾ç¤ºä¸åŒçš„è§‰é†’ä¿¡æ¯ â˜…â˜…â˜…
			let awakenIcon, awakenName, awakenDesc, awakenActivated;
			if (hasHiddenAwaken) {
				awakenIcon = charData.hiddenAwakenIcon;
				awakenName = charData.hiddenAwakenName;
				awakenDesc = charData.hiddenAwakenDesc;
				awakenActivated = true;
			} else {
				awakenIcon = isReversed ? displayData.awakenIcon : charData.awakenIcon;
				awakenName = isReversed ? displayData.awakenName : charData.awakenName;
				awakenDesc = isReversed ? displayData.awakenDesc : charData.awakenDesc;
				awakenActivated = gameState.reversedAwakened || (gameState.degree === 'phd' && !isReversed);
			}
			
			let html = `
				<div style="text-align:center;margin-bottom:15px;">
					<div style="font-size:3rem;margin-bottom:8px;">${currentIcon}</div>
					<div style="font-size:1.2rem;font-weight:700;color:${modeColor};">${displayData.name}</div>
					<div style="font-size:0.8rem;color:var(--text-secondary);margin-top:4px;">${modeText}</div>
					${isAwakened ? `<div style="margin-top:6px;"><span style="padding:3px 10px;background:linear-gradient(135deg,${hasHiddenAwaken ? '#f39c12,#e67e22' : '#f39c12,#e74c3c'});color:white;border-radius:12px;font-size:0.75rem;">âš¡ ${hasHiddenAwaken ? 'éšè—è§‰é†’' : 'å·²è§‰é†’'}</span></div>` : ''}
				</div>
				
				<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:10px;">
					<div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:5px;">ğŸ“œ è§’è‰²æè¿°</div>
					<div style="font-size:0.85rem;">${displayData.desc}</div>
				</div>
				
				<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:10px;">
					<div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:5px;">âœ¨ åˆå§‹æ•ˆæœ</div>
					<div style="font-size:0.85rem;color:var(--success-color);font-weight:500;">${displayData.bonus}</div>
				</div>
				
				<div style="background:${hasHiddenAwaken ? 'linear-gradient(135deg,rgba(243,156,18,0.15),rgba(230,126,34,0.15))' : (isReversed ? 'rgba(155,89,182,0.1)' : 'rgba(102,126,234,0.1)')};border-radius:10px;padding:12px;border:1px dashed ${hasHiddenAwaken ? '#f39c12' : modeColor};">
					<div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:5px;">âš¡ ${hasHiddenAwaken ? 'éšè—è§‰é†’' : 'è½¬åšè§‰é†’'}: ${awakenName}</div>
					<div style="display:flex;align-items:center;gap:8px;margin-bottom:5px;">
						<span style="font-size:1.2rem;">${awakenIcon}</span>
						<span style="font-size:0.9rem;font-weight:600;color:${hasHiddenAwaken ? '#f39c12' : modeColor};">${awakenName}</span>
					</div>
					<div style="font-size:0.85rem;">${awakenDesc}</div>
					${awakenActivated ? '<div style="margin-top:6px;font-size:0.7rem;color:var(--success-color);">âœ“ å·²æ¿€æ´»</div>' : '<div style="margin-top:6px;font-size:0.7rem;color:var(--text-secondary);">æœªæ¿€æ´» - è½¬åšæ—¶è§¦å‘</div>'}
				</div>
			`;
			
			showModal('ğŸ‘¤ è§’è‰²è¯¦æƒ…', html, [{ text: 'å…³é—­', class: 'btn-primary', action: closeModal }]);
		}

        function updateGraduation() {
            document.getElementById('current-year').textContent = gameState.year;
            document.getElementById('current-month').textContent = gameState.month;
            const remaining = (gameState.maxYears * 12) - gameState.totalMonths;
            document.getElementById('remaining-time').textContent = remaining;
            document.getElementById('graduation-target').textContent = 
                gameState.degree === 'master' ? 'ğŸ¯ ç¡•å£«ï¼šç§‘ç ”åˆ†â‰¥1' : 'ğŸ¯ åšå£«ï¼šç§‘ç ”åˆ†â‰¥7';
        }

		function updateBuffs() {
			const list = document.getElementById('buff-list');
			const allBuffs = [...gameState.buffs.permanent, ...gameState.buffs.temporary];
			
			if (!gameState.triggeredBuffTypes) {
				gameState.triggeredBuffTypes = [];
			}
			allBuffs.forEach(buff => {
				if (buff.type && !gameState.triggeredBuffTypes.includes(buff.type)) {
					gameState.triggeredBuffTypes.push(buff.type);
				}
			});
			
			if (gameState.hasLover) {
				const loverBuffName = gameState.loverType === 'beautiful' 
					? 'ğŸ’•æ‹äºº(SAN+3,é‡‘-1)' 
					: 'ğŸ’•èªæ…§æ‹äºº(é‡‘-1)';
				allBuffs.push({ type: 'lover', name: loverBuffName, permanent: true, isLove: true });
			}
			
			if (gameState.ailabInternship) {
				const sanCost = gameState.isReversed && gameState.character === 'normal' 
					? (gameState.reversedAwakened ? 9 : 6) 
					: 3;
				allBuffs.push({ 
					type: 'internship', 
					name: `ğŸ¢AILabå®ä¹ (é‡‘+2,SAN-${sanCost})`, 
					permanent: true, 
					isInternship: true 
				});
			}
			
			if (allBuffs.length === 0) {
				list.innerHTML = '<span style="color:var(--text-secondary);font-size:0.8rem;">æš‚æ— æ•ˆæœ</span>';
				return;
			}
			
			// â˜…â˜…â˜… å®šä¹‰è´Ÿé¢debuffç±»å‹ï¼ˆéœ€è¦å•ç‹¬æ˜¾ç¤ºï¼Œä¸åˆå¹¶ï¼‰â˜…â˜…â˜…
			const negativeDebuffTypes = [
				'idea_exhaustion',      // çµæ„Ÿæ¯ç«­
				'exp_overheat',         // ä¸»æœºå‘çƒ«
				'write_block',          // æ— ä»ä¸‹ç¬”
				'slack_debuff',         // æ¾æ‡ˆ
				'idea_stolen'           // è¢«å·idea
			];
			
			// â˜…â˜…â˜… å®šä¹‰æ­£é¢è®¢é˜…buffç±»å‹ï¼ˆéœ€è¦å•ç‹¬æ˜¾ç¤ºï¼Œä¸åˆå¹¶ï¼‰â˜…â˜…â˜…
			const subscriptionBuffTypes = [
				'idea_san_reduce',      // Geminiè®¢é˜…
				'exp_san_reduce',       // GPTè®¢é˜…
				'write_san_reduce_temp' // Claudeè®¢é˜…
			];
			
			// â˜…â˜…â˜… å®šä¹‰debuffç±»å‹çš„æ˜¾ç¤ºåç§° â˜…â˜…â˜…
			const specialBuffNames = {
				// è´Ÿé¢debuff
				'idea_exhaustion': 'ğŸ’« çµæ„Ÿæ¯ç«­ï¼šä¸‹æ¬¡æƒ³ideaæ€»åˆ†Ã·2',
				'exp_overheat': 'ğŸ”¥ ä¸»æœºå‘çƒ«ï¼šä¸‹æ¬¡åšå®éªŒæ€»åˆ†Ã·2',
				'write_block': 'âœï¸ æ— ä»ä¸‹ç¬”ï¼šä¸‹æ¬¡å†™è®ºæ–‡æ€»åˆ†Ã·2',
				'slack_debuff': 'ğŸ˜´ æ¾æ‡ˆï¼šä¸‹æœˆæ‰€æœ‰æ“ä½œæ€»åˆ†Ã·2',
				'idea_stolen': 'ğŸ˜ˆ è¢«å·ideaï¼šä¸‹æ¬¡æƒ³ideaæ€»åˆ†Ã·2',
				// æ­£é¢è®¢é˜…buff
				'idea_san_reduce': 'ğŸ¤– Geminiï¼šæœ¬æœˆæƒ³idea SAN-1,åˆ†+4',
				'exp_san_reduce': 'ğŸ¤– GPTï¼šæœ¬æœˆåšå®éªŒ SAN-1,åˆ†+4',
				'write_san_reduce_temp': 'ğŸ¤– Claudeï¼šæœ¬æœˆå†™è®ºæ–‡ SAN-1,åˆ†+4'
			};
			
			const mergedMap = {};
			const specialBuffs = [];  // å•ç‹¬å­˜æ”¾ç‰¹æ®Šbuff/debuff
			
			allBuffs.forEach(buff => {
				if (buff.isLove) {
					mergedMap['lover'] = buff;
					return;
				}
				if (buff.isInternship) {
					mergedMap['internship'] = buff;
					return;
				}
				if (buff.type === 'mentorship') {
					mergedMap['mentorship'] = buff;
					return;
				}
				
				// â˜…â˜…â˜… è´Ÿé¢debuffå•ç‹¬å¤„ç† â˜…â˜…â˜…
				if (negativeDebuffTypes.includes(buff.type)) {
					specialBuffs.push({
						name: specialBuffNames[buff.type] || buff.name,
						permanent: false,
						isLove: false,
						isDebuff: true,
						isSpecialDebuff: true
					});
					return;
				}
				
				// â˜…â˜…â˜… è®¢é˜…buffå•ç‹¬å¤„ç†ï¼ˆæ­£é¢æ•ˆæœï¼‰â˜…â˜…â˜…
				if (subscriptionBuffTypes.includes(buff.type)) {
					// æ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ è¿‡ï¼ˆé¿å…é‡å¤æ˜¾ç¤ºï¼‰
					const alreadyAdded = specialBuffs.some(b => b.subscriptionType === buff.type);
					if (!alreadyAdded) {
						specialBuffs.push({
							name: specialBuffNames[buff.type] || buff.name,
							permanent: false,
							isLove: false,
							isDebuff: false,
							isSubscription: true,  // â˜…â˜…â˜… æ ‡è®°ä¸ºè®¢é˜…buff â˜…â˜…â˜…
							subscriptionType: buff.type
						});
					}
					return;
				}
				
				const key = `${buff.type}_${buff.multiply ? 'mul' : 'add'}_${buff.permanent ? 'perm' : 'temp'}`;
				
				if (mergedMap[key]) {
					if (buff.multiply) {
						mergedMap[key].value += (buff.value - 1);
					} else {
						mergedMap[key].value += buff.value;
					}
				} else {
					mergedMap[key] = { ...buff };
				}
				
				if (buff.multiply && mergedMap[key].value < 0) {
					mergedMap[key].value = 0;
				}
			});
			
			const merged = Object.values(mergedMap).map(buff => {
				if (buff.isLove) {
					return { name: buff.name, permanent: true, isLove: true, isDebuff: false };
				}
				if (buff.isInternship) {
					return { name: buff.name, permanent: true, isInternship: true, isDebuff: false };
				}
				if (buff.type === 'mentorship') {
					return { 
						name: buff.name, 
						desc: buff.desc,
						permanent: true, 
						isLove: false, 
						isDebuff: false,
						isMentorship: true 
					};
				}
				
				let name = '';
				const prefix = buff.permanent ? 'æ¯æ¬¡' : 'ä¸‹æ¬¡';
				const typeNames = {
					'idea_bonus': 'æƒ³ideaåˆ†æ•°',
					'exp_bonus': 'åšå®éªŒåˆ†æ•°',
					'write_bonus': 'å†™è®ºæ–‡åˆ†æ•°',
					'idea_times': 'æƒ³idea',
					'exp_times': 'åšå®éªŒ',
					'write_times': 'å†™è®ºæ–‡',
					'monthly_san': 'æ¯æœˆSAN',
					'read_san_reduce': 'è¯»è®ºæ–‡SAN',
					'write_san_reduce': 'å†™è®ºæ–‡SAN',
					'citation_multiply': 'ä¸­ç¨¿å¼•ç”¨'
				};
				
				const typeName = typeNames[buff.type] || buff.type;
				let isDebuff = false;
				
				if (buff.type.includes('_times')) {
					name = `${prefix}${typeName}+${buff.value}æ¬¡`;
				} else if (buff.type === 'monthly_san') {
					name = `æ¯æœˆSAN+${buff.value}`;
				} else if (buff.type === 'read_san_reduce') {
					name = `è¯»è®ºæ–‡SAN-1`;
				} else if (buff.type === 'write_san_reduce') {
					name = `å†™è®ºæ–‡SAN-3`;
				} else if (buff.type === 'citation_multiply') {
					name = `ä¸‹ç¯‡ä¸­ç¨¿å¼•ç”¨Ã—${buff.value}`;
				} else if (buff.multiply) {
					if (buff.value < 1) isDebuff = true;
					name = `${prefix}${typeName}Ã—${buff.value}`;
				} else {
					if (buff.value < 0) isDebuff = true;
					const sign = buff.value >= 0 ? '+' : '';
					name = `${prefix}${typeName}${sign}${buff.value}`;
				}
				
				return { name, permanent: buff.permanent, isLove: false, isDebuff };
			});
			
			// â˜…â˜…â˜… åˆå¹¶æ™®é€šbuffå’Œç‰¹æ®Šbuff â˜…â˜…â˜…
			const allDisplayBuffs = [...merged, ...specialBuffs];
			
			list.innerHTML = allDisplayBuffs.map(buff => {
				let tagClass = 'buff-tag ';
				if (buff.isLove) tagClass += 'love';
				else if (buff.isInternship) tagClass += 'temporary';
				else if (buff.isSubscription) tagClass += 'temporary';  // â˜…â˜…â˜… è®¢é˜…buffç”¨è“è‰² â˜…â˜…â˜…
				else if (buff.isSpecialDebuff) tagClass += 'debuff';
				else if (buff.isMentorship) tagClass += 'permanent';
				else if (buff.isDebuff) tagClass += 'debuff';
				else if (buff.permanent) tagClass += 'permanent';
				else tagClass += 'temporary';
				
				let icon = 'fa-clock';
				if (buff.isLove) icon = 'fa-heart';
				else if (buff.isInternship) icon = 'fa-building';
				else if (buff.isSubscription) icon = 'fa-robot';  // â˜…â˜…â˜… è®¢é˜…buffç”¨æœºå™¨äººå›¾æ ‡ â˜…â˜…â˜…
				else if (buff.isSpecialDebuff) icon = 'fa-exclamation-triangle';
				else if (buff.isMentorship) icon = 'fa-user-graduate';
				else if (buff.isDebuff) icon = 'fa-arrow-down';
				else if (buff.permanent) icon = 'fa-infinity';
				
				const descText = buff.isMentorship && buff.desc ? ` (${buff.desc})` : '';
				
				return `<span class="${tagClass}">
					<i class="fas ${icon}"></i>
					${buff.name}${descText}
				</span>`;
			}).join('');
			const buffListEl = document.getElementById('buff-list');
			
			// å¸ˆå…„å¸ˆå§æ•‘æˆ‘æŠ€èƒ½
			if (gameState.hasSeniorHelpSkill && !gameState.usedSeniorHelpSkill) {
				const skillHtml = `<span class="buff-tag permanent" style="cursor:pointer;background:linear-gradient(135deg,rgba(243,156,18,0.3),rgba(230,126,34,0.3));border-color:#f39c12;" onclick="useSeniorHelpSkill()">
					<i class="fas fa-hands-helping"></i>
					ğŸ†˜ å¸ˆå…„å¸ˆå§æ•‘æˆ‘ï¼ˆç‚¹å‡»ä½¿ç”¨ï¼‰
				</span>`;
				buffListEl.innerHTML += skillHtml;
			}
			
			// å¯¼å¸ˆæ•‘æˆ‘æŠ€èƒ½
			if (gameState.hasTeacherHelpSkill && !gameState.usedTeacherHelpSkill) {
				const skillHtml = `<span class="buff-tag permanent" style="cursor:pointer;background:linear-gradient(135deg,rgba(253,121,168,0.3),rgba(232,67,147,0.3));border-color:#fd79a8;" onclick="useTeacherHelpSkill()">
					<i class="fas fa-user-shield"></i>
					ğŸ›¡ï¸ å¯¼å¸ˆæ•‘æˆ‘ï¼ˆç‚¹å‡»ä½¿ç”¨ï¼‰
				</span>`;
				buffListEl.innerHTML += skillHtml;
			}
		}			

		// â˜…â˜…â˜… æ–°å¢ï¼šå¸ˆå…„å¸ˆå§æ•‘æˆ‘æŠ€èƒ½ â˜…â˜…â˜…
		function useSeniorHelpSkill() {
			if (!gameState.hasSeniorHelpSkill || gameState.usedSeniorHelpSkill) {
				showModal('âŒ æ— æ³•ä½¿ç”¨', '<p>æŠ€èƒ½ä¸å¯ç”¨æˆ–å·²ä½¿ç”¨è¿‡ã€‚</p>', 
					[{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			const bonusValue = gameState.social;
			
			showModal('ğŸ†˜ å¸ˆå…„å¸ˆå§æ•‘æˆ‘', 
				`<div style="text-align:center;margin-bottom:15px;">
					<div style="font-size:2.5rem;margin-bottom:10px;">ğŸ†˜</div>
					<div style="font-size:1.1rem;font-weight:600;color:#f39c12;">å¸ˆå…„å¸ˆå§æ•‘æˆ‘</div>
				</div>
				<p>ä½¿ç”¨æ­¤æŠ€èƒ½åï¼Œ<strong>ä¸‹æ¬¡æƒ³ideaæ—¶</strong>ï¼Œä½ çš„ç§‘ç ”èƒ½åŠ›å°†è§†ä¸ºï¼š</p>
				<div style="text-align:center;padding:15px;background:var(--light-bg);border-radius:10px;margin:15px 0;">
					<span style="font-size:1.2rem;color:var(--primary-color);font-weight:600;">
						ç§‘ç ”(${gameState.research}) + ç¤¾äº¤(${bonusValue}) = ${gameState.research + bonusValue}
					</span>
				</div>
				<p style="color:var(--danger-color);font-size:0.85rem;"><i class="fas fa-exclamation-triangle"></i> æ³¨æ„ï¼šæ­¤æŠ€èƒ½ä»…å¯ä½¿ç”¨ä¸€æ¬¡ï¼</p>`,
				[
					{ text: 'å–æ¶ˆ', class: 'btn-info', action: closeModal },
					{ text: 'âœ¨ ä½¿ç”¨æŠ€èƒ½', class: 'btn-warning', action: () => {
						gameState.usedSeniorHelpSkill = true;
						gameState.nextIdeaResearchBonus = gameState.social;
						gameState.nextIdeaBonusSource = 'senior';
						addLog('ä¸»åŠ¨æŠ€èƒ½', 'å¸ˆå…„å¸ˆå§æ•‘æˆ‘', `ä¸‹æ¬¡æƒ³ideaæ—¶ç§‘ç ”èƒ½åŠ›+${gameState.social}ï¼ˆç¤¾äº¤å€¼ï¼‰`);
						closeModal();
						updateBuffs();
						updateAllUI();
					}}
				]
			);
		}

		// â˜…â˜…â˜… æ–°å¢ï¼šå¯¼å¸ˆæ•‘æˆ‘æŠ€èƒ½ â˜…â˜…â˜…
		function useTeacherHelpSkill() {
			if (!gameState.hasTeacherHelpSkill || gameState.usedTeacherHelpSkill) {
				showModal('âŒ æ— æ³•ä½¿ç”¨', '<p>æŠ€èƒ½ä¸å¯ç”¨æˆ–å·²ä½¿ç”¨è¿‡ã€‚</p>', 
					[{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			const bonusValue = gameState.favor;
			
			showModal('ğŸ›¡ï¸ å¯¼å¸ˆæ•‘æˆ‘', 
				`<div style="text-align:center;margin-bottom:15px;">
					<div style="font-size:2.5rem;margin-bottom:10px;">ğŸ›¡ï¸</div>
					<div style="font-size:1.1rem;font-weight:600;color:#fd79a8;">å¯¼å¸ˆæ•‘æˆ‘</div>
				</div>
				<p>ä½¿ç”¨æ­¤æŠ€èƒ½åï¼Œ<strong>ä¸‹æ¬¡æƒ³ideaæ—¶</strong>ï¼Œä½ çš„ç§‘ç ”èƒ½åŠ›å°†è§†ä¸ºï¼š</p>
				<div style="text-align:center;padding:15px;background:var(--light-bg);border-radius:10px;margin:15px 0;">
					<span style="font-size:1.2rem;color:var(--primary-color);font-weight:600;">
						ç§‘ç ”(${gameState.research}) + å¥½æ„Ÿåº¦(${bonusValue}) = ${gameState.research + bonusValue}
					</span>
				</div>
				<p style="color:var(--danger-color);font-size:0.85rem;"><i class="fas fa-exclamation-triangle"></i> æ³¨æ„ï¼šæ­¤æŠ€èƒ½ä»…å¯ä½¿ç”¨ä¸€æ¬¡ï¼</p>`,
				[
					{ text: 'å–æ¶ˆ', class: 'btn-info', action: closeModal },
					{ text: 'âœ¨ ä½¿ç”¨æŠ€èƒ½', class: 'btn-accent', action: () => {
						gameState.usedTeacherHelpSkill = true;
						gameState.nextIdeaResearchBonus = gameState.favor;
						gameState.nextIdeaBonusSource = 'teacher';
						addLog('ä¸»åŠ¨æŠ€èƒ½', 'å¯¼å¸ˆæ•‘æˆ‘', `ä¸‹æ¬¡æƒ³ideaæ—¶ç§‘ç ”èƒ½åŠ›+${gameState.favor}ï¼ˆå¥½æ„Ÿåº¦å€¼ï¼‰`);
						closeModal();
						updateBuffs();
						updateAllUI();
					}}
				]
			);
		}

		function updateResearchResults() {
			document.getElementById('paper-a-count').textContent = gameState.paperA;
			document.getElementById('paper-b-count').textContent = gameState.paperB;
			document.getElementById('paper-c-count').textContent = gameState.paperC;
			document.getElementById('total-score').textContent = gameState.totalScore;
			document.getElementById('total-citations').textContent = gameState.totalCitations;
			document.getElementById('paper-total-count').textContent = gameState.publishedPapers.length;

			const paperList = document.getElementById('published-papers');
			if (gameState.publishedPapers.length === 0) {
				paperList.innerHTML = '<p style="color:var(--text-secondary);font-size:0.75rem;text-align:center;">æš‚æ— å·²å‘è¡¨è®ºæ–‡</p>';
			} else {
				paperList.innerHTML = gameState.publishedPapers.map((p, index) => {
					// â˜…â˜…â˜… è·å–ä¼šè®®åç§° â˜…â˜…â˜…
					const confName = p.conferenceInfo 
						? `${p.conferenceInfo.name} ${p.conferenceInfo.year} (${p.grade}ç±»)` 
						: `${p.grade}ç±»`;
					
					// â˜…â˜…â˜… æ–°å¢ï¼šè®¡ç®—å¹¶æ˜¾ç¤ºå½±å“å› å­å’Œå½•ç”¨ç‡ â˜…â˜…â˜…
					let statsInfo = '';
					if (p.conferenceInfo && gameState.submissionStats) {
						const month = p.conferenceInfo.month || 1;
						const statsKey = `${month}_${p.grade}_${gameState.isReversed}`;
						const stats = gameState.submissionStats[statsKey];
						
						if (stats && stats.submissions >= 10) {
							const impactFactor = getConferenceImpactFactor(p.conferenceInfo, p.grade);
							const acceptRate = (stats.acceptRate * 100).toFixed(1);
							statsInfo = `
								<div style="font-size:0.6rem;color:var(--text-secondary);margin-top:2px;">
									ğŸ“Š IF:${impactFactor.toFixed(2)} | å½•ç”¨ç‡:${acceptRate}%
								</div>
							`;
						}
					}
					
					// â˜…â˜…â˜… æ–°å¢ï¼šå¼•ç”¨å¢é€Ÿæ˜¾ç¤º â˜…â˜…â˜…
					const citationMultiplierText = p.citationMultiplier > 1 
						? ` <span style="color:var(--success-color);">(Ã—${p.citationMultiplier.toFixed(2)})</span>` 
						: '';
					
					return `
					<div class="paper-item grade-${p.grade}">
						<div class="title">${p.title}</div>
						<div class="meta">
							<span>${confName}|${p.acceptType}</span>
							<span>åˆ†:${p.score} å¼•:${p.citations}${citationMultiplierText}</span>
						</div>
						${statsInfo}
						<div class="paper-promotions" style="margin-top:6px;display:flex;flex-wrap:wrap;gap:3px;">
							<button class="btn ${p.promotions?.arxiv ? '' : 'btn-info'}" 
								style="padding:2px 5px;font-size:0.6rem;${p.promotions?.arxiv ? 'opacity:0.5;background:#ccc;color:#666;cursor:default;' : ''}" 
								onclick="promotePaper(${index}, 'arxiv')" 
								${p.promotions?.arxiv ? 'disabled' : ''}>
								${p.promotions?.arxiv ? 'âœ“arxiv' : 'æŒ‚arxiv'}
							</button>
							<button class="btn ${p.promotions?.github ? '' : 'btn-success'}" 
								style="padding:2px 5px;font-size:0.6rem;${p.promotions?.github ? 'opacity:0.5;background:#ccc;color:#666;cursor:default;' : ''}" 
								onclick="promotePaper(${index}, 'github')" 
								${p.promotions?.github ? 'disabled' : ''}>
								${p.promotions?.github ? 'âœ“å¼€æº' : 'githubå¼€æº'}
							</button>
							<button class="btn ${p.promotions?.xiaohongshu ? '' : 'btn-accent'}" 
								style="padding:2px 5px;font-size:0.6rem;${p.promotions?.xiaohongshu ? 'opacity:0.5;background:#ccc;color:#666;cursor:default;' : ''}" 
								onclick="promotePaper(${index}, 'xiaohongshu')" 
								${p.promotions?.xiaohongshu ? 'disabled' : ''}>
								${p.promotions?.xiaohongshu ? 'âœ“å°çº¢ä¹¦' : 'å°çº¢ä¹¦å®£ä¼ '}
							</button>
							<button class="btn ${p.promotions?.quantumbit ? '' : (p.grade === 'A' ? 'btn-warning' : '')}" 
								style="padding:2px 5px;font-size:0.6rem;${p.promotions?.quantumbit || p.grade !== 'A' ? 'opacity:0.5;background:#ccc;color:#666;cursor:default;' : ''}" 
								onclick="promotePaper(${index}, 'quantumbit')" 
								${p.promotions?.quantumbit || p.grade !== 'A' ? 'disabled' : ''}
								title="${p.grade !== 'A' ? 'ä»…Aç±»è®ºæ–‡å¯ç”¨' : ''}">
								${p.promotions?.quantumbit ? 'âœ“é‡å­ä½' : (p.grade !== 'A' ? 'é‡å­ä½(ä»…Aç±»)' : 'é‡å­ä½å°é¢')}
							</button>
						</div>
					</div>
				`}).join('');
			}
		}

        function getActionCosts() {
            const has4K = gameState.buffs.permanent.some(b => b.type === 'read_san_reduce');
            const hasKeyboard = gameState.buffs.permanent.some(b => b.type === 'write_san_reduce');
            
            return {
                read: { san: has4K ? -1 : -2 },
                work: { san: -5, gold: 2 },
                idea: { san: -2 },
                experiment: { san: -3 },
                write: { san: hasKeyboard ? -3 : -4 }
            };
        }

        function formatCost(cost) {
            const parts = [];
            if (cost.san) parts.push(`<span style="color:${cost.san > 0 ? 'var(--success-color)' : 'var(--danger-color)'}">SAN${cost.san > 0 ? '+' : ''}${cost.san}</span>`);
            if (cost.gold) parts.push(`<span style="color:${cost.gold > 0 ? 'var(--success-color)' : 'var(--danger-color)'}">ğŸ’°${cost.gold > 0 ? '+' : ''}${cost.gold}</span>`);
            return parts.join(' ');
        }

		function updateActionButtons() {
			const btns = ['btn-read', 'btn-work', 'btn-idea', 'btn-experiment', 'btn-write'];
			
			// â˜…â˜…â˜… ä¿®æ”¹ï¼šåŸºäºè¡ŒåŠ¨æ¬¡æ•°åˆ¤æ–­ â˜…â˜…â˜…
			const actionsRemaining = gameState.actionLimit - gameState.actionCount;
			const allUsed = actionsRemaining <= 0;
			
			btns.forEach(id => {
				const btn = document.getElementById(id);
				btn.disabled = allUsed;
				btn.style.opacity = allUsed ? '0.5' : '1';
			});
			
			const costs = getActionCosts();
			
			// â˜…â˜…â˜… æ–°å¢ï¼šæ˜¾ç¤ºå‰©ä½™è¡ŒåŠ¨æ¬¡æ•° â˜…â˜…â˜…
			const actionCountDisplay = gameState.actionLimit > 1 
				? `<span style="font-size:0.6rem;color:var(--warning-color);">(${actionsRemaining}/${gameState.actionLimit})</span>` 
				: '';
			
			document.getElementById('btn-read').innerHTML = `<i class="fas fa-book-open"></i><span>çœ‹è®ºæ–‡${actionCountDisplay}</span><span class="action-cost">${formatCost(costs.read)}</span>`;
			document.getElementById('btn-work').innerHTML = `<i class="fas fa-briefcase"></i><span>æ‰“å·¥${actionCountDisplay}</span><span class="action-cost">${formatCost(costs.work)}</span>`;
			document.getElementById('btn-idea').innerHTML = `<i class="fas fa-lightbulb"></i><span>æƒ³idea${actionCountDisplay}</span><span class="action-cost">${formatCost(costs.idea)}</span>`;
			document.getElementById('btn-experiment').innerHTML = `<i class="fas fa-vial"></i><span>åšå®éªŒ${actionCountDisplay}</span><span class="action-cost">${formatCost(costs.experiment)}</span>`;
			document.getElementById('btn-write').innerHTML = `<i class="fas fa-pen-fancy"></i><span>å†™è®ºæ–‡${actionCountDisplay}</span><span class="action-cost">${formatCost(costs.write)}</span>`;
		}

        // ==================== äº‹ä»¶é¢„å‘Šç³»ç»Ÿ ====================
		function getUpcomingEvents() {
			const events = [];
			
			for (let i = 1; i <= 2; i++) {
				let checkMonth = gameState.month + i;
				let checkYear = gameState.year;
				
				if (checkMonth > 12) {
					checkMonth -= 12;
					checkYear++;
				}
				
				const checkTotalMonths = gameState.totalMonths + i;
				const maxMonths = gameState.maxYears * 12;
				if (checkTotalMonths > maxMonths) continue;
				
				let monthEvents = [];  // ä¸€ä¸ªæœˆå¯èƒ½æœ‰å¤šä¸ªäº‹ä»¶
				
				// â˜…â˜…â˜… æ–°å¢ï¼šæ£€æŸ¥å®¡ç¨¿ç»“æœ â˜…â˜…â˜…
				let reviewCount = 0;
				gameState.papers.forEach((paper, idx) => {
					if (paper && paper.reviewing) {
						const remainingMonths = paper.reviewMonths - i;
						if (remainingMonths <= 0) {
							reviewCount++;
						}
					}
				});
				if (reviewCount > 0) {
					monthEvents.push({
						name: reviewCount > 1 ? `${reviewCount}ç¯‡å®¡ç¨¿ç»“æœ` : 'å®¡ç¨¿ç»“æœ',
						icon: 'ğŸ“¬'
					});
				}
				
				// åŸæœ‰äº‹ä»¶æ£€æµ‹
				if (checkMonth === 5) {
					monthEvents.push({ name: 'å¯’å‡', icon: 'â„ï¸' });
				} else if (checkMonth === 11) {
					monthEvents.push({ name: 'æš‘å‡', icon: 'â˜€ï¸' });
				} else if (checkMonth === 1 && checkYear >= 2) {
					monthEvents.push({ name: 'å¥–å­¦é‡‘', icon: 'ğŸ“' });
				} else if (checkMonth === 2) {
					monthEvents.push({ name: 'æ•™å¸ˆèŠ‚', icon: 'ğŸ' });
				} else if (checkMonth === 12) {
					monthEvents.push({ name: 'å­¦å¹´æ€»ç»“', icon: 'ğŸ“…' });
				} else if (checkMonth % 2 === 0 && monthEvents.length === 0) {
					// åªæœ‰æ²¡æœ‰å…¶ä»–äº‹ä»¶æ—¶æ‰æ˜¾ç¤ºéšæœºäº‹ä»¶
					monthEvents.push({ name: 'éšæœºäº‹ä»¶', icon: 'ğŸ²' });
				}
				
				// æ·»åŠ åˆ°äº‹ä»¶åˆ—è¡¨
				monthEvents.forEach(evt => {
					events.push({
						month: i,
						name: evt.name,
						icon: evt.icon,
						label: i === 1 ? 'ä¸‹æœˆ' : '2æœˆå'
					});
				});
			}
			
			return events;
		}

        function updateEventPreview() {
            const previewEl = document.getElementById('event-preview');
            if (!previewEl) return;
            
            const events = getUpcomingEvents();
            
            if (events.length === 0) {
                previewEl.innerHTML = '';
                return;
            }
            
            const previewHtml = events.map(e => 
                `<span style="margin-left:6px;padding:2px 6px;background:${getEventColor(e.name)};border-radius:10px;font-size:0.6rem;white-space:nowrap;">${e.icon} ${e.label}:${e.name}</span>`
            ).join('');
            
            previewEl.innerHTML = `ğŸ“…${previewHtml}`;
        }

		function getEventColor(eventName) {
			const colors = {
				'å¯’å‡': 'rgba(116,185,255,0.25)',
				'æš‘å‡': 'rgba(253,203,110,0.25)',
				'å¥–å­¦é‡‘': 'rgba(108,92,231,0.25)',
				'æ•™å¸ˆèŠ‚': 'rgba(253,121,168,0.25)',
				'éšæœºäº‹ä»¶': 'rgba(0,184,148,0.2)',
				'å­¦å¹´æ€»ç»“': 'rgba(162,155,254,0.25)'  // â˜…â˜…â˜… æ–°å¢ â˜…â˜…â˜…
			};
			return colors[eventName] || 'rgba(99,110,114,0.15)';
		}

        // ==================== ä¸‹ä¸€ä¸ªæœˆ ====================
		function nextMonth() {
			// â˜…â˜…â˜… æ–°å¢ï¼šé‡ç½®è¡ŒåŠ¨æ¬¡æ•° â˜…â˜…â˜…
			gameState.actionCount = 0;
			gameState.actionUsed = false;
			
			gameState.month++;
			gameState.totalMonths++;
			
			// â˜…â˜…â˜… ç©ºæƒ³ä¹‹å¤©é€‰ä¹‹äººï¼šæœˆåˆæœ€å…ˆæ‰§è¡Œå±æ€§äº¤æ¢ â˜…â˜…â˜…
			if (gameState.isReversed && gameState.character === 'chosen') {
				processChosenSwap();
			}
			
			// â˜…â˜…â˜… æ£€æŸ¥å¹¶å¤„ç†æ¾æ‡ˆdebuff â˜…â˜…â˜…
			const hadSlackBuff = gameState.buffs.temporary.some(b => b.type === 'slack_debuff');
			if (hadSlackBuff) {
				gameState.buffs.temporary = gameState.buffs.temporary.filter(b => b.type !== 'slack_debuff');
				addLog('çŠ¶æ€æ¢å¤', 'æ¾æ‡ˆdebuffæ¶ˆé™¤', 'ç»è¿‡ä¼‘æ•´ï¼ŒçŠ¶æ€æ¢å¤æ­£å¸¸');
			}
			
			// â˜…â˜…â˜… æ¸…é™¤æœ¬æœˆé™å®šçš„buff â˜…â˜…â˜…
			gameState.buffs.temporary = gameState.buffs.temporary.filter(b => !b.thisMonthOnly);
			
			// â˜…â˜…â˜… è´ªæ±‚ä¹‹å¯Œå¯æ•Œå›½ï¼šåœ¨æœˆåˆæœ€å…ˆæ‰§è¡Œé‡ç½® â˜…â˜…â˜…
			if (gameState.isReversed && gameState.character === 'rich') {
				let shouldReset = false;
				if (gameState.reversedAwakened) {
					// è§‰é†’åï¼šåŠå¹´ï¼ˆ6ä¸ªæœˆï¼‰é‡ç½®ä¸€æ¬¡
					if (gameState.totalMonths - gameState.lastResetMonth >= 6) {
						shouldReset = true;
						gameState.lastResetMonth = gameState.totalMonths;
					}
				} else {
					// è§‰é†’å‰ï¼šæ¯æœˆé‡ç½®
					shouldReset = true;
				}
				
				if (shouldReset) {
					const oldSan = gameState.san;
					const oldResearch = gameState.research;
					const oldSocial = gameState.social;
					const oldFavor = gameState.favor;
					
					// â˜…â˜…â˜… ä¿®æ”¹ï¼šé‡ç½®ä¸º1è€Œä¸æ˜¯0 â˜…â˜…â˜…
					gameState.san = 1;
					gameState.research = 1;
					gameState.social = 1;
					gameState.favor = 1;
					
					const resetType = gameState.reversedAwakened ? 'åŠå¹´é‡ç½®' : 'æ¯æœˆé‡ç½®';
					addLog('é€†ä½æ•ˆæœ', `è´ªæ±‚ä¹‹${resetType}`, 
						`SAN ${oldSan}â†’1, ç§‘ç ” ${oldResearch}â†’1, ç¤¾äº¤ ${oldSocial}â†’1, å¥½æ„Ÿ ${oldFavor}â†’1`);
				}
			}
			
			if (gameState.month > 12) {
				gameState.month = 1;
				gameState.year++;
			}

			// â˜…â˜…â˜… ä¿®æ”¹ï¼šå·¥èµ„è®¡ç®—ï¼ˆåŠ å…¥æœˆåº¦å·¥èµ„åŠ æˆï¼‰â˜…â˜…â˜…
			const baseSalary = gameState.degree === 'master' ? 1 : 3;
			const salary = baseSalary + (gameState.monthlyWageBonus || 0);  // ä¸æ±‚æš´å¯Œä½†æ±‚ç¨³å®šåŠ æˆ
			
			// â˜…â˜…â˜… è´ªæ±‚ä¹‹å¯Œå¯æ•Œå›½ï¼šåªä¿ç•™æ¯æœˆ+3é‡‘ â˜…â˜…â˜…
			let extraGold = 0;
			if (gameState.isReversed && gameState.character === 'rich') {
				extraGold = 3;
			}
			
			gameState.gold += salary - 1 + extraGold;

			let sanRecovery = 1;
			if (gameState.isReversed && gameState.character === 'normal') {
				// â˜…â˜…â˜… ä¿®æ”¹ï¼šè½¬åšåå›å¤4è€Œä¸æ˜¯5 â˜…â˜…â˜…
				sanRecovery = gameState.reversedAwakened ? 4 : 3;
			}
			gameState.san = Math.min(gameState.sanMax, gameState.san + sanRecovery);

			if (gameState.hasLover) {
				if (gameState.loverType === 'beautiful') {
					gameState.san = Math.min(gameState.sanMax, gameState.san + 3);
				}
				
				gameState.gold -= 1;
				
				// å¯Œå¯æ•Œå›½è§‰é†’ï¼šæ‹çˆ±å¼€é”€ä¹Ÿç®—æ¶ˆè´¹
				if (gameState.isReversed && gameState.character === 'rich' && gameState.reversedAwakened) {
					gameState.goldSpentTotal = (gameState.goldSpentTotal || 0) + 1;
					
					const attributeGains = Math.floor(gameState.goldSpentTotal / 6);
					const previousGains = Math.floor((gameState.goldSpentTotal - 1) / 6);
					const newGains = attributeGains - previousGains;
					
					if (newGains > 0) {
						gameState.san = Math.min(gameState.sanMax, gameState.san + newGains);
						gameState.research = Math.min(20, gameState.research + newGains);
						gameState.social = Math.min(20, gameState.social + newGains);
						gameState.favor = Math.min(20, gameState.favor + newGains);
						addLog('é€†ä½æ•ˆæœ', 'é‡‘é’±è§‰é†’', `ç´¯è®¡æ¶ˆè´¹${gameState.goldSpentTotal}é‡‘ â†’ SAN+${newGains}, ç§‘ç ”+${newGains}, ç¤¾äº¤+${newGains}, å¥½æ„Ÿ+${newGains}`);
					}
				}
				
				if (gameState.gold < 0) {
					triggerEnding('poor');
					return;
				}
			}

			// â˜…â˜…â˜… AILab å®ä¹ æ•ˆæœ â˜…â˜…â˜…
			if (gameState.ailabInternship) {
				gameState.gold += 2;
				
				const baseSanCost = 3;
				const actualSanCost = Math.abs(getActualSanChange(-baseSanCost));
				gameState.san -= actualSanCost;
				
				if (gameState.san < 0) {
					triggerEnding('burnout');
					return;
				}
			}

			// â˜…â˜…â˜… äººä½“å·¥å­¦æ¤…æ•ˆæœ â˜…â˜…â˜…
			if (gameState.buffs.permanent.some(b => b.type === 'monthly_san')) {
				gameState.san = Math.min(gameState.sanMax, gameState.san + 1);
			}
			
			const mentorshipBuff = gameState.buffs.permanent.find(b => b.type === 'mentorship');
			if(mentorshipBuff) {
				const baseSanCost = 1;
				const actualSanCost = Math.abs(getActualSanChange(-baseSanCost));
				
				changeSan(-baseSanCost);
				
				const researchBonus = gameState.research;
				gameState.totalCitations += researchBonus;
				gameState.publishedPapers.forEach(paper => {
					paper.citations += Math.floor(researchBonus / gameState.publishedPapers.length);
				});
				
				let sanText = `SAN-${actualSanCost}`;
				if (actualSanCost !== baseSanCost) {
					sanText += `ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰`;
				}
				addLog('é•¿æœŸåˆä½œ', 'æŒ‡å¯¼å¸ˆå¼Ÿå¸ˆå¦¹çš„æˆæœ', `${sanText}ï¼Œæ€»å¼•ç”¨+${researchBonus}`);
			}
			

			// â˜…â˜…â˜… ä¿®æ”¹ï¼šè®ºæ–‡åˆ†æ•°è¡°å‡ï¼ˆæ”¯æŒé¢„è§æœªæ¥çƒ­ç‚¹ï¼‰â˜…â˜…â˜…
			let decayLogs = [];
			gameState.papers.forEach((paper, idx) => {
				if (paper && !paper.reviewing) {
					// â˜…â˜…â˜… æ–°å¢ï¼šå¦‚æœæœ‰noDecayæ ‡å¿—ï¼Œè·³è¿‡è¡°å‡ â˜…â˜…â˜…
					if (gameState.noDecay) {
						// ä¸è¡°å‡ï¼Œä»€ä¹ˆéƒ½ä¸åš
					} else {
						let decayInfo = [];
						if (paper.ideaScore > 1) {
							paper.ideaScore--;
							decayInfo.push(`idea-1`);
						}
						if (paper.expScore > 1) {
							paper.expScore--;
							decayInfo.push(`å®éªŒ-1`);
						}
						if (decayInfo.length > 0) {
							decayLogs.push(`æ§½${idx + 1}:${decayInfo.join('ï¼Œ')}`);
						}
					}
				}
			});

			// å®¡ç¨¿è¿›åº¦
			let pendingReviewSlots = [];
			gameState.papers.forEach((paper, idx) => {
				if (paper && paper.reviewing) {
					paper.reviewMonths--;
					if (paper.reviewMonths <= 0) {
						paper.reviewMonths = 0;
						pendingReviewSlots.push(idx);  // æŒ‰æ§½ä½é¡ºåºæ”¶é›†
					}
				}
			});

			// æ›´æ–°å¼•ç”¨
			updateCitations();

			// é‡ç½®æœˆåº¦å•†å“
			shopItems.forEach(item => {
				if (item.monthlyOnce) item.boughtThisMonth = false;
			});

			let logResult = `å·¥èµ„+${salary}`;
			// â˜…â˜…â˜… æ–°å¢ï¼šæ˜¾ç¤ºå·¥èµ„åŠ æˆæ¥æº â˜…â˜…â˜…
			if (gameState.monthlyWageBonus > 0) {
				logResult += `ï¼ˆå«ç¨³å®šåŠ æˆ+${gameState.monthlyWageBonus}ï¼‰`;
			}
			logResult += `ï¼Œå¼€é”€-1`;
			if (extraGold > 0) logResult += `ï¼Œé€†ä½é¢å¤–+${extraGold}é‡‘`;
			logResult += `ï¼Œä¼‘æ¯SAN+${sanRecovery}`;
			if (gameState.hasLover) {
				if (gameState.loverType === 'beautiful') {
					logResult += 'ï¼Œæ‹äººSAN+3';
				}
				logResult += 'ï¼Œçº¦ä¼š-1é‡‘';
			}
			if (gameState.ailabInternship) {
				const actualSanCost = Math.abs(getActualSanChange(-3));
				logResult += `ï¼Œå®ä¹ +2é‡‘ï¼Œå®ä¹ SAN-${actualSanCost}`;
			}
			
			if (gameState.buffs.permanent.some(b => b.type === 'monthly_san')) {
				logResult += 'ï¼Œå·¥å­¦æ¤…SAN+1';
			}
			addLog('è¿›å…¥ä¸‹ä¸€æœˆ', `ç¬¬${gameState.year}å¹´ç¬¬${gameState.month}æœˆ`, logResult);

			// â˜…â˜…â˜… ä¿®æ”¹ï¼šè¡°å‡æ—¥å¿—ï¼ˆé¢„è§æœªæ¥çƒ­ç‚¹æ—¶æ˜¾ç¤ºä¸åŒä¿¡æ¯ï¼‰â˜…â˜…â˜…
			if (gameState.noDecay) {
				// æ¯5ä¸ªæœˆæç¤ºä¸€æ¬¡ï¼Œé¿å…æ—¥å¿—åˆ·å±
				if (gameState.totalMonths % 5 === 0) {
					addLog('é¢„è§çƒ­ç‚¹', 'è®ºæ–‡åˆ†æ•°ä¿æŒç¨³å®š', 'ideaå’Œå®éªŒåˆ†æ•°ä¸è¡°å‡');
				}
			} else if (decayLogs.length > 0) {
				addLog('æ—¶æ•ˆæ€§é™ä½', 'è®ºæ–‡åˆ†æ•°è‡ªç„¶è¡°å‡', decayLogs.join('ï¼›'));
			}

			// â˜…â˜…â˜… å…³é”®ä¿®æ”¹ï¼šå®¡ç¨¿äº‹ä»¶ä¼˜å…ˆå¤„ç† â˜…â˜…â˜…
			// å¦‚æœæœ‰å¾…å¤„ç†çš„å®¡ç¨¿ç»“æœï¼Œå…ˆå¤„ç†å®¡ç¨¿ï¼Œå®Œæˆåå†è§¦å‘æœˆæœ«äº‹ä»¶
			if (pendingReviewSlots.length > 0) {
				// å®šä¹‰æœˆæœ«äº‹ä»¶å›è°ƒ
				const triggerMonthlyEvents = () => {
					// 12æœˆç‰¹æ®Šå¤„ç†ï¼šè½¬åšæˆ–å­¦å¹´æ€»ç»“
					if (gameState.month === 12) {
						const canPhD = gameState.degree === 'master' && (
							(gameState.year === 2 && gameState.totalScore >= 2) ||
							(gameState.year === 3 && gameState.totalScore >= 3)
						);
						
						if (canPhD) {
							checkGraduation();
						} else {
							triggerYearEndSummaryEvent();
						}
					} else if (gameState.month === 5) {
						triggerWinterVacationEvent();
					} else if (gameState.month === 11) {
						triggerSummerVacationEvent();
					} else if (gameState.month === 1 && gameState.year >= 2) {
						triggerScholarshipEvent();
					} else if (gameState.month === 2) {
						triggerTeachersDayEvent();
					} else if (gameState.month % 2 === 0) {
						triggerOtherRandomEvent();
					}
					
					// æ£€æŸ¥æ¯•ä¸š
					checkGraduation();
					updateAllUI();
					renderPaperSlots();
				};
				
				// å¼€å§‹å®¡ç¨¿äº‹ä»¶å¤„ç†æµç¨‹ï¼Œå®Œæˆåè§¦å‘æœˆæœ«äº‹ä»¶
				startReviewProcessing(pendingReviewSlots, triggerMonthlyEvents);
				
				updateAllUI();
				renderPaperSlots();
				return;  // â˜…â˜…â˜… æå‰è¿”å›ï¼Œç­‰å¾…å®¡ç¨¿æµç¨‹å®Œæˆ â˜…â˜…â˜…
			}

			// æ²¡æœ‰å®¡ç¨¿ç»“æœæ—¶ï¼Œæ­£å¸¸è§¦å‘æœˆæœ«äº‹ä»¶
			if (gameState.month === 12) {
				const canPhD = gameState.degree === 'master' && (
					(gameState.year === 2 && gameState.totalScore >= 2) ||
					(gameState.year === 3 && gameState.totalScore >= 3)
				);
				
				if (canPhD) {
					checkGraduation();
					updateAllUI();
					renderPaperSlots();
					return;
				} else {
					triggerYearEndSummaryEvent();
				}
			} else if (gameState.month === 5) {
				triggerWinterVacationEvent();
			} else if (gameState.month === 11) {
				triggerSummerVacationEvent();
			} else if (gameState.month === 1 && gameState.year >= 2) {
				triggerScholarshipEvent();
			} else if (gameState.month === 2) {
				triggerTeachersDayEvent();
			} else if (gameState.month % 2 === 0) {
				triggerOtherRandomEvent();
			}

			checkGraduation();
			updateAllUI();
			renderPaperSlots();
		}

        // ç©ºæƒ³ä¹‹å¤©é€‰ä¹‹äººï¼šå±æ€§éšæœºäº¤æ¢
		function processChosenSwap() {
			// è·å–å½“å‰ä¸Šé™
			const researchMax = gameState.researchMax || 20;
			const socialMax = gameState.socialMax || 20;
			const favorMax = gameState.favorMax || 20;
			
			if (gameState.reversedAwakened) {
				const values = [gameState.research, gameState.social, gameState.favor, gameState.san, gameState.gold];
				const shuffled = shuffle([...values]);
				
				const oldStats = `ç§‘ç ”${gameState.research}/${researchMax} ç¤¾äº¤${gameState.social}/${socialMax} å¥½æ„Ÿ${gameState.favor}/${favorMax} SAN${gameState.san}/${gameState.sanMax} é‡‘${gameState.gold}`;
				
				// â˜…â˜…â˜… æ–°é€»è¾‘ï¼šå¦‚æœäº¤æ¢åçš„å€¼è¶…è¿‡ä¸Šé™ï¼Œåˆ™æå‡ä¸Šé™ â˜…â˜…â˜…
				const newResearch = Math.max(0, shuffled[0]);
				const newSocial = Math.max(0, shuffled[1]);
				const newFavor = Math.max(0, shuffled[2]);
				const newSan = Math.max(0, shuffled[3]);
				const newGold = shuffled[4];
				
				// æ›´æ–°ä¸Šé™ï¼ˆå¦‚æœæ–°å€¼è¶…è¿‡å½“å‰ä¸Šé™ï¼‰
				if (newResearch > researchMax) gameState.researchMax = newResearch;
				if (newSocial > socialMax) gameState.socialMax = newSocial;
				if (newFavor > favorMax) gameState.favorMax = newFavor;
				if (newSan > gameState.sanMax) gameState.sanMax = newSan;
				
				// è®¾ç½®æ–°å€¼
				gameState.research = newResearch;
				gameState.social = newSocial;
				gameState.favor = newFavor;
				gameState.san = newSan;
				gameState.gold = newGold;
				
				const newResearchMax = gameState.researchMax;
				const newSocialMax = gameState.socialMax;
				const newFavorMax = gameState.favorMax;
				
				const newStats = `ç§‘ç ”${gameState.research}/${newResearchMax} ç¤¾äº¤${gameState.social}/${newSocialMax} å¥½æ„Ÿ${gameState.favor}/${newFavorMax} SAN${gameState.san}/${gameState.sanMax} é‡‘${gameState.gold}`;
				
				// æ£€æŸ¥æ˜¯å¦æœ‰ä¸Šé™çªç ´
				const breakthroughs = [];
				if (newResearchMax > researchMax) breakthroughs.push(`ç§‘ç ”ä¸Šé™${researchMax}â†’${newResearchMax}`);
				if (newSocialMax > socialMax) breakthroughs.push(`ç¤¾äº¤ä¸Šé™${socialMax}â†’${newSocialMax}`);
				if (newFavorMax > favorMax) breakthroughs.push(`å¥½æ„Ÿä¸Šé™${favorMax}â†’${newFavorMax}`);
				if (gameState.sanMax > (gameState.sanMax - (newSan > gameState.sanMax - (newSan - shuffled[3]) ? newSan - shuffled[3] : 0))) {
					// è¿™ä¸ªåˆ¤æ–­æ¯”è¾ƒå¤æ‚ï¼Œç®€åŒ–å¤„ç†
				}
				
				const breakthroughText = breakthroughs.length > 0 ? `ï¼Œä¸Šé™çªç ´ï¼š${breakthroughs.join('ï¼Œ')}` : '';
				addLog('å‘½è¿è½®ç›˜', 'å…¨å±æ€§éšæœºäº¤æ¢', `${oldStats} â†’ ${newStats}${breakthroughText}`);
			} else {
				const stats1 = [gameState.research, gameState.social, gameState.favor];
				const shuffled1 = shuffle([...stats1]);
				
				const stats2 = [gameState.san, gameState.gold];
				const shuffled2 = shuffle([...stats2]);
				
				const oldStats = `ç§‘ç ”${gameState.research}/${researchMax} ç¤¾äº¤${gameState.social}/${socialMax} å¥½æ„Ÿ${gameState.favor}/${favorMax} | SAN${gameState.san}/${gameState.sanMax} é‡‘${gameState.gold}`;
				
				// â˜…â˜…â˜… æ–°é€»è¾‘ï¼šå¦‚æœäº¤æ¢åçš„å€¼è¶…è¿‡ä¸Šé™ï¼Œåˆ™æå‡ä¸Šé™ â˜…â˜…â˜…
				const newResearch = Math.max(0, shuffled1[0]);
				const newSocial = Math.max(0, shuffled1[1]);
				const newFavor = Math.max(0, shuffled1[2]);
				const newSan = Math.max(0, shuffled2[0]);
				const newGold = shuffled2[1];
				
				// æ›´æ–°ä¸Šé™
				if (newResearch > researchMax) gameState.researchMax = newResearch;
				if (newSocial > socialMax) gameState.socialMax = newSocial;
				if (newFavor > favorMax) gameState.favorMax = newFavor;
				if (newSan > gameState.sanMax) gameState.sanMax = newSan;
				
				// è®¾ç½®æ–°å€¼
				gameState.research = newResearch;
				gameState.social = newSocial;
				gameState.favor = newFavor;
				gameState.san = newSan;
				gameState.gold = newGold;
				
				const newResearchMax = gameState.researchMax;
				const newSocialMax = gameState.socialMax;
				const newFavorMax = gameState.favorMax;
				
				const newStats = `ç§‘ç ”${gameState.research}/${newResearchMax} ç¤¾äº¤${gameState.social}/${newSocialMax} å¥½æ„Ÿ${gameState.favor}/${newFavorMax} | SAN${gameState.san}/${gameState.sanMax} é‡‘${gameState.gold}`;
				
				// æ£€æŸ¥æ˜¯å¦æœ‰ä¸Šé™çªç ´
				const breakthroughs = [];
				if (newResearchMax > researchMax) breakthroughs.push(`ç§‘ç ”ä¸Šé™â†’${newResearchMax}`);
				if (newSocialMax > socialMax) breakthroughs.push(`ç¤¾äº¤ä¸Šé™â†’${newSocialMax}`);
				if (newFavorMax > favorMax) breakthroughs.push(`å¥½æ„Ÿä¸Šé™â†’${newFavorMax}`);
				
				const breakthroughText = breakthroughs.length > 0 ? `ï¼Œâœ¨ä¸Šé™çªç ´ï¼š${breakthroughs.join('ï¼Œ')}` : '';
				addLog('å‘½è¿è½®ç›˜', 'å±æ€§éšæœºäº¤æ¢', `${oldStats} â†’ ${newStats}${breakthroughText}`);
			}
			
			checkResearchUnlock();
		}

		// â˜…â˜…â˜… æ–°å¢ï¼šè®¡ç®—ä¼šè®®å½±å“å› å­ â˜…â˜…â˜…
		function getConferenceImpactFactor(conferenceInfo, grade) {
			// å¦‚æœæ²¡æœ‰ç»Ÿè®¡æ•°æ®ï¼Œè¿”å›åŸºç¡€å› å­1.0
			if (!gameState.submissionStats || !conferenceInfo) {
				return 1.0;
			}
			
			const currentMonth = conferenceInfo.month || gameState.month || 1;
			const isReversed = gameState.isReversed;
			
			// è·å–è¯¥ä¼šè®®çš„ç»Ÿè®¡
			const currentKey = `${currentMonth}_${grade}_${isReversed}`;
			const currentStats = gameState.submissionStats[currentKey];
			
			if (!currentStats || currentStats.submissions < 10) {
				return 1.0;
			}
			
			// â˜…â˜…â˜… è®¡ç®—è¯¥ä¼šè®®çš„ä¸­ç¨¿å‡åˆ† â˜…â˜…â˜…
			const currentAcceptedScores = [];
			if (currentStats.avgScorePoster > 0) currentAcceptedScores.push({ score: currentStats.avgScorePoster, count: currentStats.poster || 0 });
			if (currentStats.avgScoreOral > 0) currentAcceptedScores.push({ score: currentStats.avgScoreOral, count: currentStats.oral || 0 });
			if (currentStats.avgScoreBestPaper > 0) currentAcceptedScores.push({ score: currentStats.avgScoreBestPaper, count: currentStats.bestPaper || 0 });
			
			let currentAvgAcceptedScore = 0;
			let currentTotalAccepted = 0;
			currentAcceptedScores.forEach(item => {
				currentAvgAcceptedScore += item.score * item.count;
				currentTotalAccepted += item.count;
			});
			currentAvgAcceptedScore = currentTotalAccepted > 0 ? currentAvgAcceptedScore / currentTotalAccepted : 0;
			
			// â˜…â˜…â˜… è®¡ç®—åŒçº§åˆ«æ‰€æœ‰ä¼šè®®çš„å¹³å‡æŠ•ç¨¿æ•°é‡ â˜…â˜…â˜…
			let sameLevelTotalSubmissions = 0;
			let sameLevelConferenceCount = 0;
			
			for (let month = 1; month <= 12; month++) {
				const key = `${month}_${grade}_${isReversed}`;
				const stats = gameState.submissionStats[key];
				
				if (stats && stats.submissions >= 10) {
					sameLevelTotalSubmissions += stats.submissions;
					sameLevelConferenceCount++;
				}
			}
			
			// åŒçº§åˆ«å¹³å‡æŠ•ç¨¿æ•°
			const sameLevelAvgSubmissions = sameLevelConferenceCount > 0 
				? sameLevelTotalSubmissions / sameLevelConferenceCount 
				: currentStats.submissions;
			
			// â˜…â˜…â˜… è®¡ç®—å…¨ä½“è®ºæ–‡ï¼ˆæ‰€æœ‰ç­‰çº§A/B/Cï¼‰çš„å¹³å‡ä¸­ç¨¿å‡åˆ† â˜…â˜…â˜…
			let allGradesTotalScore = 0;
			let allGradesCount = 0;
			
			for (const g of ['A', 'B', 'C']) {
				for (let month = 1; month <= 12; month++) {
					const key = `${month}_${g}_${isReversed}`;
					const stats = gameState.submissionStats[key];
					
					if (stats && stats.submissions >= 10) {
						// è®¡ç®—è¯¥ä¼šè®®çš„ä¸­ç¨¿å‡åˆ†
						const acceptedScores = [];
						if (stats.avgScorePoster > 0) acceptedScores.push({ score: stats.avgScorePoster, count: stats.poster || 0 });
						if (stats.avgScoreOral > 0) acceptedScores.push({ score: stats.avgScoreOral, count: stats.oral || 0 });
						if (stats.avgScoreBestPaper > 0) acceptedScores.push({ score: stats.avgScoreBestPaper, count: stats.bestPaper || 0 });
						
						let avgScore = 0;
						let totalAccepted = 0;
						acceptedScores.forEach(item => {
							avgScore += item.score * item.count;
							totalAccepted += item.count;
						});
						avgScore = totalAccepted > 0 ? avgScore / totalAccepted : 0;
						
						if (avgScore > 0) {
							allGradesTotalScore += avgScore;
							allGradesCount++;
						}
					}
				}
			}
			
			// å…¨ä½“è®ºæ–‡å¹³å‡åˆ†
			const allGradesAvgScore = allGradesCount > 0 ? allGradesTotalScore / allGradesCount : currentAvgAcceptedScore;
			
			// å¦‚æœæ²¡æœ‰æœ‰æ•ˆæ•°æ®ï¼Œè¿”å›åŸºç¡€å› å­
			if (sameLevelAvgSubmissions === 0 || allGradesAvgScore === 0 || currentAvgAcceptedScore === 0) {
				return 1.0;
			}
			
			// â˜…â˜…â˜… æ–°å…¬å¼ï¼šå½±å“å› å­ = (è®ºæ–‡æŠ•ç¨¿æ•°/åŒçº§åˆ«è®ºæ–‡å¹³å‡æŠ•ç¨¿æ•°) * (è®ºæ–‡å¹³å‡åˆ†/å…¨ä½“è®ºæ–‡å¹³å‡åˆ†) â˜…â˜…â˜…
			const submissionRatio = currentStats.submissions / sameLevelAvgSubmissions;
			const scoreRatio = currentAvgAcceptedScore / allGradesAvgScore;
			
			let impactFactor = submissionRatio * scoreRatio;
			
			// é™åˆ¶èŒƒå›´ï¼Œé¿å…æç«¯å€¼ï¼ˆ0.2 ~ 4.0ï¼‰
			impactFactor = Math.max(0.2, Math.min(4.0, impactFactor));
			
			return impactFactor;
		}

		function updateCitations() {
			gameState.publishedPapers.forEach(paper => {
				paper.monthsSincePublish = (paper.monthsSincePublish || 0) + 1;
				
				// åˆå§‹åŒ–å°æ•°ç´¯ç§¯å­—æ®µ
				if (paper.pendingCitationFraction === undefined) {
					paper.pendingCitationFraction = 0;
				}
				
				// â˜…â˜…â˜… æ–°è®¡ç®—æ–¹å¼ â˜…â˜…â˜…
				// åŸºç¡€å¢é€Ÿ = è®ºæ–‡ä¸­ç¨¿åˆ†æ•°ï¼ˆä¼šéšæ—¶é—´è¡°å‡ï¼‰* 0.1
				const baseScore = Math.max(0, paper.score - 2 * paper.monthsSincePublish);
				let baseGrowth = baseScore * 0.1;
				
				// â˜…â˜…â˜… ä¼šè®®å½±å“å› å­ â˜…â˜…â˜…
				const impactFactor = getConferenceImpactFactor(paper.conferenceInfo, paper.grade);
				
				// â˜…â˜…â˜… æ¨å¹¿å€ç‡ï¼ˆåŠ æ³•æ•ˆæœï¼‰â˜…â˜…â˜…
				let promotionRate = 0;  // é¢å¤–å€ç‡ï¼ˆä»0å¼€å§‹ç´¯åŠ ï¼‰
				
				// æ¥æ”¶ç±»å‹åŠ æˆ
				if (paper.acceptType === 'Oral') {
					promotionRate += 0.5;  // oralæä¾›50%å€ç‡
				} else if (paper.acceptType === 'Best Paper') {
					promotionRate += 4.0;  // best paperæä¾›400%å€ç‡
				}
				
				// æ¨å¹¿åŠ æˆï¼ˆåŸæœ¬æ˜¯ä¹˜æ³•ï¼Œç°åœ¨æ”¹ä¸ºåŠ æ³•ï¼‰
				if (paper.promotions?.arxiv) promotionRate += 0.25;
				if (paper.promotions?.github) promotionRate += 0.5;
				if (paper.promotions?.xiaohongshu) promotionRate += 0.25;
				
				// åŒé—¨åˆä½œåŠ æˆï¼ˆåŸæœ¬citationMultiplieræ˜¯ä¹˜æ•°ï¼Œç°åœ¨è½¬ä¸ºåŠ æˆï¼‰
				// citationMultiplier=2 è¡¨ç¤ºÃ—2ï¼Œè½¬æ¢ä¸º+100%å€ç‡
				const fellowBonus = ((paper.citationMultiplier || 1) - 1) * 100 / 100;  // è½¬ä¸ºç™¾åˆ†æ¯”
				promotionRate += fellowBonus;
				
				// æœ€ç»ˆæ¨å¹¿å€ç‡ = 1 + ç´¯åŠ çš„æ‰€æœ‰åŠ æˆ
				const promotionMultiplier = 1 + promotionRate;
				
				// æœ€ç»ˆå¢é€Ÿ = åŸºç¡€å¢é€Ÿ Ã— ä¼šè®®å½±å“å› å­ Ã— æ¨å¹¿å€ç‡
				const finalGrowth = baseGrowth * impactFactor * promotionMultiplier;
				
				// åŠ ä¸Šä¹‹å‰ç´¯ç§¯çš„å°æ•°éƒ¨åˆ†
				const totalGrowth = finalGrowth + paper.pendingCitationFraction;
				
				// ä¸‹å–æ•´å¾—åˆ°æœ¬æœˆå®é™…å¢åŠ çš„å¼•ç”¨
				const actualGain = Math.floor(totalGrowth);
				
				// ä¿å­˜å°æ•°éƒ¨åˆ†åˆ°ä¸‹ä¸ªæœˆ
				paper.pendingCitationFraction = totalGrowth - actualGain;
				
				// å¢åŠ å¼•ç”¨
				if (actualGain > 0) {
					paper.citations += actualGain;
					gameState.totalCitations += actualGain;
				}
			});
		}
		
        // ==================== æ¯•ä¸šæ£€æŸ¥ ====================
        function checkGraduation() {
            if (gameState.pendingPhDChoice) {
                return;
            }
            
            const maxMonths = gameState.maxYears * 12;
            
            if (gameState.degree === 'master') {
                if ((gameState.year === 2 && gameState.month === 12 && gameState.totalScore >= 2) ||
                    (gameState.year === 3 && gameState.month === 12 && gameState.totalScore >= 3)) {
                    showPhDOptionModal();
                    return;
                }
            }
            
            if (gameState.totalMonths >= maxMonths) {
                if (gameState.degree === 'master') {
                    if (gameState.totalScore >= 1) {
                        triggerEnding('master');
                    } else {
                        triggerEnding('delay');
                    }
                } else if (gameState.degree === 'phd') {
                    if (gameState.totalScore >= 7) {
                        triggerEnding('phd');
                    } else {
                        triggerEnding('delay');
                    }
                }
                return;
            }
        }
			
		function showPhDOptionModal() {
			if (gameState.totalScore >= 7) {
				gameState.achievementConditions = gameState.achievementConditions || {};
				gameState.achievementConditions.phdRequirementMetEarly = true;
			}
			
			gameState.pendingPhDChoice = true;
			
			const isSecondYear = gameState.year === 2;
			const notPhDText = isSecondYear ? 'ç»§ç»­è¯»ç¡•å£«' : 'ç¡•å£«æ¯•ä¸š';
			const requirementText = isSecondYear ? 'â‰¥2åˆ†' : 'â‰¥3åˆ†';
			const notPhDDesc = isSecondYear 
				? '<p style="color:var(--text-secondary);font-size:0.85rem;">é€‰æ‹©ç»§ç»­è¯»ç¡•å£«ï¼Œæ˜å¹´è¿˜æœ‰ä¸€æ¬¡è½¬åšæœºä¼šï¼Œä½†ç«äº‰æ›´æ¿€çƒˆï¼Œéœ€è¦ç§‘ç ”åˆ†â‰¥3åˆ†</p>'
				: '';
			
			showModal('ğŸ“ è½¬åšé€‰æ‹©',
				`<p>æ­å–œï¼ä½ çš„ç§‘ç ”æˆç»©ä¼˜å¼‚ï¼ˆ${requirementText}ï¼‰ï¼Œè·å¾—äº†è½¬åšèµ„æ ¼ï¼</p>
				 <p>æ˜¯å¦é€‰æ‹©ç»§ç»­æ”»è¯»åšå£«å­¦ä½ï¼Ÿ</p>
				 <p style="color:var(--text-secondary);font-size:0.85rem;">åšå£«æ¯•ä¸šè¦æ±‚ï¼šç§‘ç ”åˆ†â‰¥7ï¼Œå­¦ä¹ å¹´é™5å¹´</p>
				 ${notPhDDesc}
				 <div style="margin-top:12px;padding:10px;background:linear-gradient(135deg,rgba(253,203,110,0.15),rgba(0,184,148,0.15));border-radius:8px;border-left:3px solid var(--success-color);">
					 <p style="font-size:0.85rem;color:var(--text-secondary);margin:0;">
						 ğŸ’¡ <strong>ç¥ç§˜è€äººï¼š</strong>å¦‚æœä½ å–å¾—äº†æ¯ä¸€å¹´çš„å¥–å­¦é‡‘ã€æ‹¥æœ‰ä¸€ç¯‡Aç±»è®ºæ–‡ï¼Œé‚£ä¹ˆç¥è´ºä½ ï¼Œä½ çš„å‰æœŸæ˜¯æ¯”è¾ƒæˆåŠŸçš„ï¼
					 </p>
				 </div>`,
				[
					{ text: notPhDText, class: 'btn-info', action: () => { 
						gameState.pendingPhDChoice = false;
						gameState.phdOpportunitiesRejected = (gameState.phdOpportunitiesRejected || 0) + 1;
						if (gameState.phdOpportunitiesRejected >= 2) {
							gameState.achievementConditions = gameState.achievementConditions || {};
							gameState.achievementConditions.rejectedPhdTwice = true;
						}
						closeModal();
						
						if (isSecondYear) {
							addLog('è½¬åšé€‰æ‹©', 'é€‰æ‹©ç»§ç»­è¯»ç¡•å£«', 'æ˜å¹´è¿˜æœ‰ä¸€æ¬¡è½¬åšæœºä¼š');
							updateAllUI();
							
							// â˜…â˜…â˜… è¡¥ä¸Š12æœˆçš„å­¦å¹´æ€»ç»“äº‹ä»¶ â˜…â˜…â˜…
							if (gameState.month === 12) {
								setTimeout(() => triggerYearEndSummaryEvent(), 300);
							}
							
							if (gameState.pendingConference) {
								const grade = gameState.pendingConference;
								gameState.pendingConference = null;
								setTimeout(() => showConferenceModal(grade), 300);
							}
						} else {
							// â˜…â˜…â˜… ç¬¬3å¹´é€‰æ‹©ç¡•å£«æ¯•ä¸šæ—¶ï¼Œä¹Ÿè¡¥ä¸Šå­¦å¹´æ€»ç»“ â˜…â˜…â˜…
							addLog('è½¬åšé€‰æ‹©', 'é€‰æ‹©ç¡•å£«æ¯•ä¸š', 'å‡†å¤‡æ¯•ä¸š');
							if (gameState.month === 12) {
								setTimeout(() => {
									triggerYearEndSummaryEvent();
									// å­¦å¹´æ€»ç»“å®Œæˆåå†è§¦å‘æ¯•ä¸š
									// ä½†ä¸ºäº†ç®€åŒ–ï¼Œç›´æ¥æ¯•ä¸š
								}, 100);
							}
							setTimeout(() => triggerEnding('master'), 500);
						}
					}},
					{ text: 'ğŸ“š è½¬ä¸ºåšå£«', class: 'btn-primary', action: () => {
						gameState.pendingPhDChoice = false;
						gameState.degree = 'phd';
						gameState.maxYears = 5;
						closeModal();
						setTimeout(() => showPhDTribulationModal(), 200);
					}}
				]
			);
		}

        // â˜…â˜…â˜… å…³é”®ä¿®æ”¹ï¼šè½¬åšè§‰é†’å‡½æ•° â˜…â˜…â˜…

		function showPhDTribulationModal() {
			const character = gameState.character;
			
			// â˜…â˜…â˜… ä¿®å¤ï¼šé˜²å¾¡æ€§æ£€æŸ¥ï¼Œä¼˜å…ˆå¤„ç†çœŸÂ·å¤§å¤šæ•° â˜…â˜…â˜…
			if (character === 'true-normal' || gameState.isTrueNormal) {
				// ç¡®ä¿çŠ¶æ€ä¸€è‡´
				gameState.isTrueNormal = true;
				
				const html = `
					<div style="text-align:center;">
						<div style="font-size:4rem;margin-bottom:15px;">ğŸŒ</div>
						<div style="font-size:1.5rem;font-weight:700;background:linear-gradient(135deg,#ffd700,#ff8c00);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:10px;">
							è½¬åšæˆåŠŸ
						</div>
						<div style="font-size:0.95rem;color:var(--text-secondary);margin-bottom:20px;">
							ä½œä¸ºçœŸÂ·å¤§å¤šæ•°ï¼Œä½ æ²¡æœ‰ä»»ä½•è§‰é†’æŠ€èƒ½
						</div>
					</div>
					
					<div style="background:linear-gradient(135deg,rgba(255,215,0,0.15),rgba(255,140,0,0.15));border-radius:12px;padding:15px;margin-bottom:15px;border:2px solid rgba(255,140,0,0.3);">
						<div style="text-align:center;margin-bottom:12px;">
							<div style="font-size:1.3rem;font-weight:700;color:#d68910;margin-bottom:5px;">âŒ æ— è§‰é†’</div>
							<div style="font-size:0.85rem;color:var(--text-secondary);font-style:italic;">ä¸€åˆ‡éƒ½è¦é è‡ªå·±</div>
						</div>
						<div style="background:white;border-radius:8px;padding:12px;text-align:center;">
							<div style="font-size:0.9rem;color:var(--text-secondary);">
								æ²¡æœ‰ä»»ä½•å±æ€§åŠ æˆ<br>
								æ²¡æœ‰ä»»ä½•ç‰¹æ®Šèƒ½åŠ›<br>
								è¿™å°±æ˜¯æœ€çœŸå®çš„ç ”ç©¶ç”Ÿç”Ÿæ´»
							</div>
						</div>
					</div>
					
					<div style="text-align:center;padding:10px;background:var(--light-bg);border-radius:8px;font-size:0.85rem;">
						<div style="color:#d68910;font-weight:600;margin-bottom:5px;">ğŸ“œ çœŸå®çš„åšå£«ä¹‹è·¯</div>
						<div style="color:var(--text-secondary);">åšå£«æ¯•ä¸šè¦æ±‚ï¼šç§‘ç ”åˆ† â‰¥ 7</div>
					</div>
				`;
				
				showModal('ğŸ“ çœŸÂ·è½¬åš', html, [
					{ text: 'âŒ é è‡ªå·±ï¼', class: 'btn-warning', action: () => {
						addLog('çœŸÂ·è½¬åš', 'è½¬åšæˆåŠŸï¼Œæ²¡æœ‰ä»»ä½•è§‰é†’æ•ˆæœ', 'ä¸€åˆ‡éƒ½è¦é è‡ªå·±');
						closeModal();
						updateAllUI();
						renderPaperSlots();
						
						if (gameState.pendingConference) {
							const grade = gameState.pendingConference;
							gameState.pendingConference = null;
							setTimeout(() => showConferenceModal(grade), 300);
						}
					}}
				]);
				
				return;
			}
			
			const charData = characters.find(c => c.id === character);
			
			// â˜…â˜…â˜… æ–°å¢ï¼šè§’è‰²æ•°æ®ä¸å­˜åœ¨æ—¶çš„é”™è¯¯å¤„ç† â˜…â˜…â˜…
			if (!charData) {
				console.error('æ— æ³•æ‰¾åˆ°è§’è‰²æ•°æ®:', character);
				showModal('âš ï¸ é”™è¯¯', '<p>è§’è‰²æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·é‡æ–°å¼€å§‹æ¸¸æˆã€‚</p>', 
					[{ text: 'ç¡®å®š', class: 'btn-primary', action: () => {
						closeModal();
						restartGame();
					}}]);
				return;
			}
			
			// â˜…â˜…â˜… é€†ä½è§’è‰²è§‰é†’ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ä¸å˜ï¼‰â˜…â˜…â˜…
			if (gameState.isReversed) {
				gameState.reversedAwakened = true;
				
				let effectName = '';
				let effectDesc = '';
				let bonusDetails = [];
				
				switch (character) {
					case 'normal': // æ€ æƒ°ä¹‹å¤§å¤šæ•°
						effectName = 'ğŸ’€ æè‡´æ€ æƒ°';
						effectDesc = 'æ‡’æƒ°çš„æè‡´å°±æ˜¯ä¸€åˆ‡éƒ½ç¿»å€...åŒ…æ‹¬ç—›è‹¦';
						const oldR1 = gameState.research, oldS1 = gameState.social, oldF1 = gameState.favor, oldG1 = gameState.gold;
						gameState.research = Math.min(20, gameState.research * 2);
						gameState.social = Math.min(20, gameState.social * 2);
						gameState.favor = Math.min(20, gameState.favor * 2);
						gameState.gold = gameState.gold * 2;
						bonusDetails.push(`ç§‘ç ” ${oldR1} â†’ ${gameState.research}`);
						bonusDetails.push(`ç¤¾äº¤ ${oldS1} â†’ ${gameState.social}`);
						bonusDetails.push(`å¥½æ„Ÿ ${oldF1} â†’ ${gameState.favor}`);
						bonusDetails.push(`é‡‘å¸ ${oldG1} â†’ ${gameState.gold}`);
						bonusDetails.push('âš ï¸ SANå‡å°‘å˜ä¸º3å€');
						bonusDetails.push('âœ¨ æ¯æœˆSANå›å¤å˜ä¸º5');
						
						const mentorshipBuff = gameState.buffs.permanent.find(b => b.type === 'mentorship');
						if (mentorshipBuff) {
							mentorshipBuff.desc = 'æ¯æœˆSAN-3ï¼ˆæ€ æƒ°Ã—3ï¼‰ï¼Œæ€»å¼•ç”¨+ç§‘ç ”èƒ½åŠ›å€¼';
						}
						break;
						
					case 'genius': // æ„šé’ä¹‹é™¢å£«è½¬ä¸–
						effectName = 'ğŸ­ å¤§æ™ºè‹¥æ„š';
						effectDesc = 'çœŸæ­£çš„æ™ºæ…§ä¸åœ¨äºç§‘ç ”æ•°å€¼';
						bonusDetails.push('ç§‘ç ”æå‡è½¬åŒ–æ•ˆæœå‡çº§');
						bonusDetails.push('æ¯1ç‚¹ç§‘ç ”æå‡ â†’ å¥½æ„Ÿ+2, SAN+6, ç¤¾äº¤+2, é‡‘+6');
						break;
						
					case 'social': // å«‰å¦’ä¹‹ç¤¾äº¤è¾¾äºº
						effectName = 'ğŸ‘ï¸ å«‰å¦’é‡ç½®';
						effectDesc = 'ç¤¾äº¤èƒ½åŠ›é‡ç½®ï¼Œè§¦å‘è¿å¸¦æ•ˆæœ';
						const oldSocialVal = gameState.social;
						if (oldSocialVal > 5) {
							const decrease = oldSocialVal - 5;
							gameState.research = Math.min(20, gameState.research + decrease);
							gameState.favor = Math.min(20, gameState.favor + decrease);
							bonusDetails.push(`ç¤¾äº¤ ${oldSocialVal} â†’ 5`);
							bonusDetails.push(`è§¦å‘å«‰å¦’è½¬åŒ–ï¼šç§‘ç ”+${decrease}, å¥½æ„Ÿ+${decrease}`);
						} else if (oldSocialVal < 5) {
							const increase = 5 - oldSocialVal;
							gameState.san = Math.min(gameState.sanMax, gameState.san + increase);
							gameState.gold += increase;
							bonusDetails.push(`ç¤¾äº¤ ${oldSocialVal} â†’ 5`);
							bonusDetails.push(`è§¦å‘å«‰å¦’åé¦ˆï¼šSAN+${increase}, é‡‘é’±+${increase}`);
						} else {
							bonusDetails.push('ç¤¾äº¤å·²ç»æ˜¯5ï¼Œæ— å˜åŒ–');
						}
						gameState.social = 5;
						break;
						
					case 'rich':
						effectName = 'ğŸ’¸ é‡‘é’±çš„åŠ›é‡';
						effectDesc = 'åŠå¹´é‡ç½®ä¸€æ¬¡ï¼Œæ¶ˆè´¹é‡‘å¸å¯æå‡å±æ€§';
						gameState.goldSpentTotal = 0;
						gameState.lastResetMonth = gameState.totalMonths;
						bonusDetails.push('âœ¨ å±æ€§é‡ç½®å‘¨æœŸï¼šæ¯æœˆ â†’ æ¯åŠå¹´');
						bonusDetails.push('âœ¨ æ¯èŠ±è´¹6é‡‘å¸ â†’ SAN+1, ç§‘ç ”+1, ç¤¾äº¤+1, å¥½æ„Ÿ+1');
						bonusDetails.push('ğŸ’° å¿«å»èŠ±é’±æå‡å±æ€§å§ï¼');
						break;
						
					case 'teacher-child': // ç©ä¸–ä¹‹å¯¼å¸ˆå­å¥³
						effectName = 'ğŸƒ å˜æœ¬åŠ å‰';
						effectDesc = 'å›é€†åˆ°åº•ï¼Œä½†æ”¶ç›Šä¾æ—§';
						bonusDetails.push('å¥½æ„Ÿå½’é›¶æ—¶é‡ç½®ä¸º2ï¼ˆåŸä¸º4ï¼‰');
						bonusDetails.push('é‡ç½®æ—¶ä»è·å¾—ï¼šç¤¾äº¤+1ï¼Œç§‘ç ”+1ï¼Œé‡‘å¸+2');
						break;
						
					case 'chosen': // ç©ºæƒ³ä¹‹å¤©é€‰ä¹‹äºº
						effectName = 'ğŸ² å‘½è¿è½®ç›˜';
						effectDesc = 'äº”å±æ€§å…¨éƒ¨åŠ å…¥è½®ç›˜èµŒå±€';
						bonusDetails.push('æ¯æœˆéšæœºäº¤æ¢å‡çº§');
						bonusDetails.push('ç§‘ç ”/ç¤¾äº¤/å¥½æ„Ÿ/SAN/é‡‘ å…¨éƒ¨å‚ä¸äº¤æ¢');
						break;
				}
				
				checkResearchUnlock(true);
				
				const html = `
					<div style="text-align:center;">
						<div style="font-size:4rem;margin-bottom:15px;animation:pulse 1s infinite;">ğŸŒ‘</div>
						<div style="font-size:1.5rem;font-weight:700;background:linear-gradient(135deg,#9b59b6,#e74c3c);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:10px;">
							é€†ä½è§‰é†’ï¼
						</div>
						<div style="font-size:0.95rem;color:var(--text-secondary);margin-bottom:20px;">
							é»‘æš—ä¸­è•´å«çš„åŠ›é‡å·²è¢«æ¿€æ´»...
						</div>
					</div>
					
					<div style="background:linear-gradient(135deg,rgba(155,89,182,0.2),rgba(231,76,60,0.2));border-radius:12px;padding:15px;margin-bottom:15px;border:2px solid rgba(231,76,60,0.5);">
						<div style="text-align:center;margin-bottom:12px;">
							<div style="font-size:1.3rem;font-weight:700;color:#e74c3c;margin-bottom:5px;">${effectName}</div>
							<div style="font-size:0.85rem;color:var(--text-secondary);font-style:italic;">${effectDesc}</div>
						</div>
						<div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:12px;">
							<div style="font-size:0.8rem;color:#a0a0a0;margin-bottom:8px;text-align:center;">ğŸŒ™ è§‰é†’æ•ˆæœ ğŸŒ™</div>
							<div style="display:flex;flex-direction:column;gap:6px;">
								${bonusDetails.map(detail => `
									<div style="display:flex;align-items:center;justify-content:center;gap:8px;padding:6px 12px;background:linear-gradient(135deg,rgba(155,89,182,0.2),rgba(231,76,60,0.2));border-radius:6px;font-size:0.85rem;font-weight:500;color:#e74c3c;">
										${detail.startsWith('âš ï¸') || detail.startsWith('âœ¨') || detail.startsWith('ğŸ’°') ? '' : '<i class="fas fa-moon"></i>'} ${detail}
									</div>
								`).join('')}
							</div>
						</div>
					</div>
					
					<div style="text-align:center;padding:10px;background:rgba(0,0,0,0.1);border-radius:8px;font-size:0.85rem;">
						<div style="color:#9b59b6;font-weight:600;margin-bottom:5px;">ğŸ“œ ç»§ç»­ä½ çš„é»‘æš—æ—…ç¨‹</div>
						<div style="color:var(--text-secondary);">åšå£«æ¯•ä¸šè¦æ±‚ï¼šç§‘ç ”åˆ† â‰¥ 7</div>
					</div>
				`;
				
				showModal('ğŸŒ‘ é€†ä½è§‰é†’', html, [
					{ text: 'ğŸŒ™ æ‹¥æŠ±é»‘æš—', class: 'btn-danger', action: () => {
						addLog('é€†ä½è§‰é†’', `è§¦å‘ã€${effectName}ã€‘`, bonusDetails.join('ï¼Œ'));
						closeModal();
						updateAllUI();
						renderPaperSlots();
						
						if (gameState.pendingConference) {
							const grade = gameState.pendingConference;
							gameState.pendingConference = null;
							setTimeout(() => showConferenceModal(grade), 300);
						}
					}}
				]);
				
				return;
			}
			
			// â˜…â˜…â˜… æ­£ä½è§’è‰²ï¼šæ£€æŸ¥æ˜¯å¦æ»¡è¶³éšè—è§‰é†’æ¡ä»¶ â˜…â˜…â˜…
			const hasHiddenAwaken = charData.hiddenAwakenCondition && charData.hiddenAwakenCondition(gameState);
			
			if (hasHiddenAwaken) {
				// æ˜¾ç¤ºäºŒé€‰ä¸€å¼¹çª—
				showAwakenChoiceModal(charData);
			} else {
				// ç›´æ¥è§¦å‘æ™®é€šè§‰é†’
				applyNormalAwaken(charData);
			}
		}

		// â˜…â˜…â˜… æ–°å¢ï¼šæ˜¾ç¤ºè§‰é†’äºŒé€‰ä¸€å¼¹çª— â˜…â˜…â˜…
		function showAwakenChoiceModal(charData) {
			const character = gameState.character;
			
			const html = `
				<div style="text-align:center;">
					<div style="font-size:3rem;margin-bottom:15px;animation:pulse 1s infinite;">âš¡</div>
					<div style="font-size:1.3rem;font-weight:700;background:linear-gradient(135deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:10px;">
						æ¸¡åŠ«æˆåŠŸï¼è§‰é†’åˆ†æ”¯å‡ºç°ï¼
					</div>
					<div style="font-size:0.9rem;color:var(--text-secondary);margin-bottom:20px;">
						ä½ æ»¡è¶³äº†éšè—è§‰é†’çš„è§¦å‘æ¡ä»¶ï¼Œè¯·é€‰æ‹©ä½ çš„è§‰é†’è·¯çº¿ï¼š
					</div>
				</div>
				
				<div style="display:flex;flex-direction:column;gap:15px;margin-bottom:20px;">
					<!-- æ™®é€šè§‰é†’é€‰é¡¹ -->
					<div style="background:linear-gradient(135deg,rgba(102,126,234,0.15),rgba(118,75,162,0.15));border-radius:12px;padding:15px;border:2px solid rgba(102,126,234,0.3);cursor:pointer;transition:all 0.3s;" 
						 onmouseover="this.style.borderColor='rgba(102,126,234,0.8)';this.style.transform='translateY(-2px)'"
						 onmouseout="this.style.borderColor='rgba(102,126,234,0.3)';this.style.transform='translateY(0)'"
						 onclick="selectAwaken('normal')">
						<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
							<span style="font-size:1.5rem;">${charData.awakenIcon}</span>
							<span style="font-size:1.1rem;font-weight:700;color:#667eea;">${charData.awakenName}</span>
						</div>
						<div style="font-size:0.85rem;color:var(--text-secondary);">${charData.awakenDesc}</div>
					</div>
					
					<!-- éšè—è§‰é†’é€‰é¡¹ -->
					<div style="background:linear-gradient(135deg,rgba(253,203,110,0.2),rgba(243,156,18,0.2));border-radius:12px;padding:15px;border:2px dashed rgba(243,156,18,0.5);cursor:pointer;transition:all 0.3s;position:relative;" 
						 onmouseover="this.style.borderColor='rgba(243,156,18,1)';this.style.transform='translateY(-2px)'"
						 onmouseout="this.style.borderColor='rgba(243,156,18,0.5)';this.style.transform='translateY(0)'"
						 onclick="selectAwaken('hidden')">
						<div style="position:absolute;top:-8px;right:10px;background:linear-gradient(135deg,#f39c12,#e74c3c);color:white;padding:2px 8px;border-radius:10px;font-size:0.65rem;font-weight:600;">âš™ï¸ éšè—è§‰é†’</div>
						<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
							<span style="font-size:1.5rem;">${charData.hiddenAwakenIcon}</span>
							<span style="font-size:1.1rem;font-weight:700;color:#f39c12;">${charData.hiddenAwakenName}</span>
						</div>
						<div style="font-size:0.85rem;color:var(--text-secondary);">${charData.hiddenAwakenDesc}</div>
					</div>
				</div>
				
				<div style="text-align:center;padding:10px;background:var(--light-bg);border-radius:8px;font-size:0.8rem;color:var(--text-secondary);">
					<i class="fas fa-info-circle"></i> é€‰æ‹©åæ— æ³•æ›´æ”¹ï¼Œè¯·è°¨æ…å†³å®šï¼
				</div>
			`;
			
			// å®šä¹‰å…¨å±€é€‰æ‹©å‡½æ•°
			window.selectAwaken = function(type) {
				closeModal();
				if (type === 'hidden') {
					applyHiddenAwaken(charData);
				} else {
					applyNormalAwaken(charData);
				}
			};
			
			showModal('âš¡ è§‰é†’é€‰æ‹©', html, []);
		}

		// â˜…â˜…â˜… æ–°å¢ï¼šåº”ç”¨éšè—è§‰é†’æ•ˆæœ â˜…â˜…â˜…
		function applyHiddenAwaken(charData) {
			const character = gameState.character;
			gameState.hiddenAwakened = true;
			gameState.hiddenAwakenType = character;
			
			let effectName = charData.hiddenAwakenIcon + ' ' + charData.hiddenAwakenName;
			let effectDesc = charData.hiddenAwakenDesc;
			let bonusDetails = [];
			
			switch (character) {
				case 'normal': // å‹¤èƒ½è¡¥æ‹™
					gameState.actionLimit = 2;
					bonusDetails.push('æ¯æœˆè¡ŒåŠ¨æ¬¡æ•°ï¼š1 â†’ 2');
					bonusDetails.push('çœ‹è®ºæ–‡/æ‰“å·¥/æƒ³idea/åšå®éªŒ/å†™è®ºæ–‡æ¯æœˆå¯æ‰§è¡Œ2æ¬¡');
					break;
					
				case 'genius': // é¢„è§æœªæ¥çƒ­ç‚¹
					gameState.noDecay = true;
					bonusDetails.push('è®ºæ–‡ideaåˆ†æ•°ä¸å†æ¯æœˆè¡°å‡');
					bonusDetails.push('è®ºæ–‡å®éªŒåˆ†æ•°ä¸å†æ¯æœˆè¡°å‡');
					bonusDetails.push('âœ¨ è®ºæ–‡è´¨é‡å°†æ›´åŠ ç¨³å®šï¼');
					break;
					
				case 'social': // å¸ˆå…„å¸ˆå§æ•‘æˆ‘
					gameState.hasSeniorHelpSkill = true;
					bonusDetails.push('è·å¾—ä¸»åŠ¨æŠ€èƒ½ã€å¸ˆå…„å¸ˆå§æ•‘æˆ‘ã€‘');
					bonusDetails.push('ä½¿ç”¨åï¼šä¸‹æ¬¡æƒ³ideaæ—¶ç§‘ç ”èƒ½åŠ›è§†ä¸º ç§‘ç ”+ç¤¾äº¤');
					bonusDetails.push('âš ï¸ æ­¤æŠ€èƒ½ä»…å¯ä½¿ç”¨1æ¬¡');
					break;
					
				case 'rich': // ä¸æ±‚æš´å¯Œä½†æ±‚ç¨³å®š
					gameState.monthlyWageBonus = 1;
					bonusDetails.push('æ¯æœˆå·¥èµ„é¢å¤–+1');
					bonusDetails.push('âœ¨ ç¨³å®šçš„æ”¶å…¥è®©ç”Ÿæ´»æ›´ä»å®¹');
					break;
					
				case 'teacher-child': // å¯¼å¸ˆæ•‘æˆ‘
					gameState.hasTeacherHelpSkill = true;
					bonusDetails.push('è·å¾—ä¸»åŠ¨æŠ€èƒ½ã€å¯¼å¸ˆæ•‘æˆ‘ã€‘');
					bonusDetails.push('ä½¿ç”¨åï¼šä¸‹æ¬¡æƒ³ideaæ—¶ç§‘ç ”èƒ½åŠ›è§†ä¸º ç§‘ç ”+å¥½æ„Ÿåº¦');
					bonusDetails.push('âš ï¸ æ­¤æŠ€èƒ½ä»…å¯ä½¿ç”¨1æ¬¡');
					break;
					
				case 'chosen': // å­¤æ³¨ä¸€æ·
					// éœ€è¦è®©ç©å®¶é€‰æ‹©ä¿ç•™å“ªä¸ªå±æ€§
					showAllInChoiceModal();
					return; // æå‰è¿”å›ï¼Œç”±é€‰æ‹©å¼¹çª—å¤„ç†åç»­
			}
			
			checkResearchUnlock(true);
			showHiddenAwakenResultModal(effectName, effectDesc, bonusDetails);
		}

		// â˜…â˜…â˜… æ–°å¢ï¼šå­¤æ³¨ä¸€æ·å±æ€§é€‰æ‹©å¼¹çª— â˜…â˜…â˜…
		function showAllInChoiceModal() {
			const currentVal = gameState.research; // ä¸‰é¡¹ç›¸ç­‰
			const transferVal = (currentVal - 1) * 2; // ä¸¤é¡¹å˜1åè½¬ç§»çš„å€¼
			
			const html = `
				<div style="text-align:center;margin-bottom:15px;">
					<div style="font-size:2.5rem;margin-bottom:10px;">ğŸ¯</div>
					<div style="font-size:1.1rem;font-weight:600;color:#f39c12;margin-bottom:5px;">å­¤æ³¨ä¸€æ·</div>
					<div style="font-size:0.85rem;color:var(--text-secondary);">é€‰æ‹©ä½ è¦å¼ºåŒ–çš„å±æ€§ï¼Œå…¶ä»–ä¸¤é¡¹å°†å˜ä¸º1</div>
				</div>
				
				<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:15px;text-align:center;">
					<div style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:5px;">å½“å‰å±æ€§å‡ä¸º ${currentVal}</div>
					<div style="font-size:0.85rem;">é€‰æ‹©åï¼šä¸»å±æ€§ +${transferVal}ï¼Œå…¶ä»–ä¸¤é¡¹å˜ä¸º1</div>
				</div>
				
				<div style="display:flex;flex-direction:column;gap:10px;">
					<button class="btn btn-primary" style="width:100%;padding:12px;" onclick="applyAllIn('research')">
						<i class="fas fa-flask"></i> å¼ºåŒ–ç§‘ç ”èƒ½åŠ› â†’ ${currentVal + transferVal}
					</button>
					<button class="btn btn-success" style="width:100%;padding:12px;" onclick="applyAllIn('social')">
						<i class="fas fa-users"></i> å¼ºåŒ–ç¤¾äº¤èƒ½åŠ› â†’ ${currentVal + transferVal}
					</button>
					<button class="btn btn-accent" style="width:100%;padding:12px;" onclick="applyAllIn('favor')">
						<i class="fas fa-heart"></i> å¼ºåŒ–å¯¼å¸ˆå¥½æ„Ÿåº¦ â†’ ${currentVal + transferVal}
					</button>
				</div>
			`;
			
			window.applyAllIn = function(targetStat) {
				const oldVal = gameState.research; // ä¸‰é¡¹ç›¸ç­‰
				const transferVal = (oldVal - 1) * 2;
				const newVal = Math.min(20, oldVal + transferVal);
				
				const bonusDetails = [];
				
				if (targetStat === 'research') {
					gameState.research = newVal;
					gameState.social = 1;
					gameState.favor = 1;
					bonusDetails.push(`ç§‘ç ”èƒ½åŠ› ${oldVal} â†’ ${newVal}`);
					bonusDetails.push(`ç¤¾äº¤èƒ½åŠ› ${oldVal} â†’ 1`);
					bonusDetails.push(`å¯¼å¸ˆå¥½æ„Ÿåº¦ ${oldVal} â†’ 1`);
				} else if (targetStat === 'social') {
					gameState.research = 1;
					gameState.social = newVal;
					gameState.favor = 1;
					bonusDetails.push(`ç§‘ç ”èƒ½åŠ› ${oldVal} â†’ 1`);
					bonusDetails.push(`ç¤¾äº¤èƒ½åŠ› ${oldVal} â†’ ${newVal}`);
					bonusDetails.push(`å¯¼å¸ˆå¥½æ„Ÿåº¦ ${oldVal} â†’ 1`);
				} else {
					gameState.research = 1;
					gameState.social = 1;
					gameState.favor = newVal;
					bonusDetails.push(`ç§‘ç ”èƒ½åŠ› ${oldVal} â†’ 1`);
					bonusDetails.push(`ç¤¾äº¤èƒ½åŠ› ${oldVal} â†’ 1`);
					bonusDetails.push(`å¯¼å¸ˆå¥½æ„Ÿåº¦ ${oldVal} â†’ ${newVal}`);
				}
				
				gameState.hiddenAwakened = true;
				gameState.hiddenAwakenType = 'chosen';
				
				closeModal();
				checkResearchUnlock(true);
				showHiddenAwakenResultModal('ğŸ¯ å­¤æ³¨ä¸€æ·', 'å°†å…¨éƒ¨åŠ›é‡é›†ä¸­åˆ°ä¸€ç‚¹ï¼', bonusDetails);
			};
			
			showModal('ğŸ¯ å­¤æ³¨ä¸€æ· - é€‰æ‹©å¼ºåŒ–å±æ€§', html, []);
		}

		// â˜…â˜…â˜… æ–°å¢ï¼šæ˜¾ç¤ºéšè—è§‰é†’ç»“æœå¼¹çª— â˜…â˜…â˜…
		function showHiddenAwakenResultModal(effectName, effectDesc, bonusDetails) {
			const html = `
				<div style="text-align:center;">
					<div style="font-size:4rem;margin-bottom:15px;animation:pulse 1s infinite;">âš™ï¸</div>
					<div style="font-size:1.5rem;font-weight:700;background:linear-gradient(135deg,#f39c12,#e74c3c);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:10px;">
						éšè—è§‰é†’è§¦å‘ï¼
					</div>
					<div style="font-size:0.95rem;color:var(--text-secondary);margin-bottom:20px;">
						ä½ å‘ç°äº†ä¸åŒå¯»å¸¸çš„é“è·¯...
					</div>
				</div>
				
				<div style="background:linear-gradient(135deg,rgba(253,203,110,0.2),rgba(243,156,18,0.2));border-radius:12px;padding:15px;margin-bottom:15px;border:2px solid rgba(243,156,18,0.5);">
					<div style="text-align:center;margin-bottom:12px;">
						<div style="font-size:1.3rem;font-weight:700;color:#f39c12;margin-bottom:5px;">${effectName}</div>
						<div style="font-size:0.85rem;color:var(--text-secondary);font-style:italic;">${effectDesc}</div>
					</div>
					<div style="background:white;border-radius:8px;padding:12px;">
						<div style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:8px;text-align:center;">âš™ï¸ è§‰é†’æ•ˆæœ âš™ï¸</div>
						<div style="display:flex;flex-direction:column;gap:6px;">
							${bonusDetails.map(detail => `
								<div style="display:flex;align-items:center;justify-content:center;gap:8px;padding:6px 12px;background:linear-gradient(135deg,rgba(253,203,110,0.15),rgba(243,156,18,0.15));border-radius:6px;font-size:0.85rem;font-weight:500;color:#d68910;">
									${detail.startsWith('âš ï¸') || detail.startsWith('âœ¨') ? '' : '<i class="fas fa-star"></i>'} ${detail}
								</div>
							`).join('')}
						</div>
					</div>
				</div>
				
				<div style="text-align:center;padding:10px;background:var(--light-bg);border-radius:8px;font-size:0.85rem;">
					<div style="color:var(--primary-color);font-weight:600;margin-bottom:5px;">ğŸ“œ å¼€å¯åšå£«ä¿®ç‚¼ä¹‹è·¯</div>
					<div style="color:var(--text-secondary);">åšå£«æ¯•ä¸šè¦æ±‚ï¼šç§‘ç ”åˆ† â‰¥ 7</div>
				</div>
			`;
			
			showModal('âš™ï¸ éšè—è§‰é†’', html, [
				{ text: 'ğŸ¯ è¸ä¸Šç‹¬ç‰¹ä¹‹è·¯', class: 'btn-warning', action: () => {
					addLog('éšè—è§‰é†’', `è§¦å‘ã€${effectName}ã€‘`, bonusDetails.join('ï¼Œ'));
					closeModal();
					updateAllUI();
					renderPaperSlots();
					
					if (gameState.pendingConference) {
						const grade = gameState.pendingConference;
						gameState.pendingConference = null;
						setTimeout(() => showConferenceModal(grade), 300);
					}
				}}
			]);
		}

		// â˜…â˜…â˜… æ–°å¢ï¼šåº”ç”¨æ™®é€šè§‰é†’æ•ˆæœï¼ˆåŸæœ‰é€»è¾‘æå–ï¼‰ â˜…â˜…â˜…
		function applyNormalAwaken(charData) {
			const character = gameState.character;
			let effectName = '';
			let effectDesc = '';
			let bonusDetails = [];
			
			switch (character) {
				case 'genius':
					effectName = 'ğŸ§¬ å­¦æœ¯å¤©èµ‹è§‰é†’';
					effectDesc = 'é™¢å£«è½¬ä¸–çš„è¡€è„‰å¼€å§‹æ²¸è…¾ï¼Œè¿‡å¾€æˆå°±åŒ–ä¸ºå®åŠ›ï¼';
					const aCount = gameState.paperA || 0;
					if (aCount > 0) {
						// â˜…â˜…â˜… ä¿®æ”¹ï¼šæ¯ç¯‡Aç±»è®ºæ–‡ç§‘ç ”+1ï¼Œä¸Šé™+2 â˜…â˜…â˜…
						const researchGain = aCount * 1;
						const maxGain = aCount * 2;
						gameState.researchMax = (gameState.researchMax || 20) + maxGain;
						gameState.research = Math.min(gameState.researchMax, gameState.research + researchGain);
						bonusDetails.push(`Aç±»è®ºæ–‡ ${aCount} ç¯‡`);
						bonusDetails.push(`ç§‘ç ”èƒ½åŠ› +${researchGain}`);
						bonusDetails.push(`ç§‘ç ”èƒ½åŠ›ä¸Šé™ +${maxGain}ï¼ˆç°ä¸º${gameState.researchMax}ï¼‰`);
					} else {
						bonusDetails.push('æš‚æ— Aç±»è®ºæ–‡ï¼Œç»§ç»­åŠªåŠ›ï¼');
					}
					break;
					
				case 'social':
					effectName = 'ğŸŒ äººè„‰ç½‘ç»œæ¿€æ´»';
					effectDesc = 'ç¤¾äº¤è¾¾äººçš„äººè„‰å…¨é¢ç»½æ”¾ï¼Œå†¥å†¥ä¹‹ä¸­å½±å“äº†å®¡ç¨¿äººåˆ†å¸ƒï¼';
					gameState.socialAwakened = true;
					
					const socialVal = gameState.social;
					let normalP = Math.max(0, 0.40 - socialVal * 0.01);
					let kindP = 0.10 + socialVal * 0.005;
					let expertP = 0.10 + socialVal * 0.01;
					let hostileP = Math.max(0, 0.10 - socialVal * 0.005);
					let gptP = Math.max(0, 0.20 - socialVal * 0.005);
					let questionsP = Math.max(0, 0.10 - socialVal * 0.005);
					
					const totalP = normalP + kindP + expertP + hostileP + gptP + questionsP;
					normalP /= totalP;
					kindP /= totalP;
					expertP /= totalP;
					hostileP /= totalP;
					gptP /= totalP;
					questionsP /= totalP;
					
					gameState.reviewerDistribution = {
						normal: normalP,
						kind: kindP,
						expert: expertP,
						hostile: hostileP,
						gpt: gptP,
						questions: questionsP
					};
					
					bonusDetails.push(`è½¬åšæ—¶ç¤¾äº¤: ${socialVal}`);
					bonusDetails.push(`å®¡ç¨¿äººåˆ†å¸ƒå·²æ°¸ä¹…æ”¹å˜`);
					break;
					
				case 'rich':
					effectName = 'ğŸ’ è´¢å¯Œå€å¢æœ¯';
					effectDesc = 'å¯Œå¯æ•Œå›½çš„åº•è•´æ˜¾ç°ï¼Œé‡‘å¸å‚¨å¤‡ç¬é—´ç¿»ä¸‰å€ï¼';
					const oldGold = gameState.gold;
					gameState.gold = gameState.gold * 3;
					bonusDetails.push(`é‡‘å¸ ${oldGold} â†’ ${gameState.gold} (Ã—3)`);
					break;
					
				case 'teacher-child':
					effectName = 'ğŸ‘‘ è¡€è„‰å…±é¸£';
					effectDesc = 'å¯¼å¸ˆå­å¥³çš„èº«ä»½ä¼˜åŠ¿å‡¸æ˜¾ï¼Œå°†äººè„‰è½¬åŒ–ä¸ºå®é™…èµ„æºï¼';
					const oldFavorTC = gameState.favor;
					if (oldFavorTC > 12) {
						const overflow = oldFavorTC - 12;
						gameState.favor = 12;
						gameState.research = Math.min(20, gameState.research + overflow);
						gameState.gold += overflow;
						bonusDetails.push(`å¯¼å¸ˆå¥½æ„Ÿåº¦ ${oldFavorTC} â†’ 12`);
						bonusDetails.push(`ç§‘ç ”èƒ½åŠ› +${overflow}`);
						bonusDetails.push(`é‡‘å¸ +${overflow}`);
					} else {
						bonusDetails.push(`å¯¼å¸ˆå¥½æ„Ÿåº¦æœªè¶…è¿‡12ï¼Œæš‚æ— è½¬åŒ–`);
					}
					break;
					
				case 'chosen':
					effectName = 'âœ¨ æŸ¥ç¼ºè¡¥æ¼';
					effectDesc = 'å¤©é€‰ä¹‹äººçš„å‘½è¿é½¿è½®è½¬åŠ¨ï¼ŒçŸ­æ¿ç¬é—´è¡¥é½ï¼';
					const maxStat = Math.max(gameState.research, gameState.social, gameState.favor);
					const oldStats = { research: gameState.research, social: gameState.social, favor: gameState.favor };
					gameState.research = Math.min(20, maxStat);
					gameState.social = Math.min(20, maxStat);
					gameState.favor = Math.min(20, maxStat);
					if (oldStats.research !== maxStat) bonusDetails.push(`ç§‘ç ”èƒ½åŠ› ${oldStats.research} â†’ ${gameState.research}`);
					if (oldStats.social !== maxStat) bonusDetails.push(`ç¤¾äº¤èƒ½åŠ› ${oldStats.social} â†’ ${gameState.social}`);
					if (oldStats.favor !== maxStat) bonusDetails.push(`å¯¼å¸ˆå¥½æ„Ÿåº¦ ${oldStats.favor} â†’ ${gameState.favor}`);
					if (bonusDetails.length === 0) bonusDetails.push('å±æ€§å·²è¾¾æœ€ä¼˜ï¼Œæ— éœ€è¡¥é½');
					break;
					
				case 'normal':
				default:
					effectName = 'ğŸ”¥ æˆ‘å‘½ç”±æˆ‘ä¸ç”±å¤©';
					effectDesc = 'å¹³å‡¡ä¹‹äººçˆ†å‘å‡ºæƒŠäººæ½œåŠ›ï¼Œå…¨é¢çªç ´è‡ªæˆ‘æé™ï¼';
					const oldR = gameState.research, oldS = gameState.social, oldF = gameState.favor, oldG = gameState.gold;
					gameState.research = Math.min(20, gameState.research * 2);
					gameState.social = Math.min(20, gameState.social * 2);
					gameState.favor = Math.min(20, gameState.favor * 2);
					gameState.gold = gameState.gold * 2;
					bonusDetails.push(`ç§‘ç ”èƒ½åŠ› ${oldR} â†’ ${gameState.research} (Ã—2)`);
					bonusDetails.push(`ç¤¾äº¤èƒ½åŠ› ${oldS} â†’ ${gameState.social} (Ã—2)`);
					bonusDetails.push(`å¯¼å¸ˆå¥½æ„Ÿåº¦ ${oldF} â†’ ${gameState.favor} (Ã—2)`);
					bonusDetails.push(`é‡‘å¸ ${oldG} â†’ ${gameState.gold} (Ã—2)`);
					break;
			}
			
			checkResearchUnlock(true);
			
			const html = `
				<div style="text-align:center;">
					<div style="font-size:4rem;margin-bottom:15px;animation:pulse 1s infinite;">âš¡</div>
					<div style="font-size:1.5rem;font-weight:700;background:linear-gradient(135deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:10px;">
						æ¸¡åŠ«æˆåŠŸï¼
					</div>
					<div style="font-size:0.95rem;color:var(--text-secondary);margin-bottom:20px;">
						æ­å–œçªç ´ç¡•å£«å¢ƒç•Œï¼Œæ™‹å‡åšå£«ä¿®ç‚¼è€…ï¼
					</div>
				</div>
				
				<div style="background:linear-gradient(135deg,rgba(102,126,234,0.15),rgba(118,75,162,0.15));border-radius:12px;padding:15px;margin-bottom:15px;border:2px solid rgba(102,126,234,0.3);">
					<div style="text-align:center;margin-bottom:12px;">
						<div style="font-size:1.3rem;font-weight:700;color:#667eea;margin-bottom:5px;">${effectName}</div>
						<div style="font-size:0.85rem;color:var(--text-secondary);font-style:italic;">${effectDesc}</div>
					</div>
					<div style="background:white;border-radius:8px;padding:12px;">
						<div style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:8px;text-align:center;">âœ¨ è·å¾—åŠ æˆ âœ¨</div>
						<div style="display:flex;flex-direction:column;gap:6px;">
							${bonusDetails.map(detail => `
								<div style="display:flex;align-items:center;justify-content:center;gap:8px;padding:6px 12px;background:linear-gradient(135deg,rgba(0,184,148,0.1),rgba(85,239,196,0.1));border-radius:6px;font-size:0.9rem;font-weight:500;color:var(--success-color);">
									<i class="fas fa-arrow-up"></i> ${detail}
								</div>
							`).join('')}
						</div>
					</div>
				</div>
				
				<div style="text-align:center;padding:10px;background:var(--light-bg);border-radius:8px;font-size:0.85rem;">
					<div style="color:var(--primary-color);font-weight:600;margin-bottom:5px;">ğŸ“œ æ–°çš„ä¿®ç‚¼ç›®æ ‡</div>
					<div style="color:var(--text-secondary);">åšå£«æ¯•ä¸šè¦æ±‚ï¼šç§‘ç ”åˆ† â‰¥ 7</div>
					<div style="color:var(--text-secondary);">ä¿®ç‚¼å¹´é™ï¼š5å¹´</div>
				</div>
			`;
			
			if (!document.getElementById('tribulation-style')) {
				const style = document.createElement('style');
				style.id = 'tribulation-style';
				style.textContent = `
					@keyframes pulse {
						0%, 100% { transform: scale(1); opacity: 1; }
						50% { transform: scale(1.1); opacity: 0.8; }
					}
				`;
				document.head.appendChild(style);
			}
			
			showModal('âš¡ è½¬åšæ¸¡åŠ«', html, [
				{ text: 'ğŸ¯ å¼€å¯åšå£«ä¿®ç‚¼ä¹‹è·¯', class: 'btn-primary', action: () => {
					addLog('è½¬åšæ¸¡åŠ«', `è§¦å‘ã€${effectName}ã€‘`, bonusDetails.join('ï¼Œ'));
					closeModal();
					updateAllUI();
					renderPaperSlots();
					
					if (gameState.pendingConference) {
						const grade = gameState.pendingConference;
						gameState.pendingConference = null;
						setTimeout(() => showConferenceModal(grade), 300);
					}
				}}
			]);
		}
		
        // ==================== è®ºæ–‡æ¨å¹¿åŠŸèƒ½ ====================
		function promotePaper(index, type) {
			const paper = gameState.publishedPapers[index];
			if (!paper) return;

			if (!paper.promotions) {
				paper.promotions = { arxiv: false, github: false, xiaohongshu: false, quantumbit: false };
			}
			if (!paper.citationMultiplier) paper.citationMultiplier = 1;

			if (paper.promotions[type]) return;

			const typeNames = {
				arxiv: 'æŒ‚arxiv',
				github: 'githubå¼€æº',
				xiaohongshu: 'å°çº¢ä¹¦å®£ä¼ ',
				quantumbit: 'é‡å­ä½å°é¢'
			};

			let result = '';
			let canProceed = true;
			
			switch(type) {
				case 'arxiv': {
					const baseSanCost = 3;
					const actualSanCost = Math.abs(getActualSanChange(-baseSanCost));
					
					if (gameState.san < actualSanCost) {
						const tipText = actualSanCost !== baseSanCost 
							? `<p>SANå€¼ä¸è¶³ï¼åŸºç¡€æ¶ˆè€—${baseSanCost}ç‚¹ï¼Œæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}åéœ€è¦${actualSanCost}ç‚¹SANå€¼ã€‚</p>` 
							: `<p>SANå€¼ä¸è¶³ï¼éœ€è¦è‡³å°‘${baseSanCost}ç‚¹SANå€¼ã€‚</p>`;
						showModal('âŒ æ“ä½œå¤±è´¥', tipText, 
							[{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
						return;
					}
					paper.promotions.arxiv = true;
					// â˜…â˜…â˜… æ”¹ä¸ºåŠ æ³•ï¼š+0.25 â˜…â˜…â˜…
					paper.citationMultiplier += 0.25;
					const sanText = actualSanCost !== baseSanCost 
						? `SANå€¼-${actualSanCost}ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰` 
						: `SANå€¼-${baseSanCost}`;
					result = `${sanText}ï¼Œè®ºæ–‡å¼•ç”¨é€Ÿåº¦+25%`;
					canProceed = changeSan(-baseSanCost);
					break;
				}
				case 'github': {
					const baseSanCost = 6;
					const actualSanCost = Math.abs(getActualSanChange(-baseSanCost));
					
					if (gameState.san < actualSanCost) {
						const tipText = actualSanCost !== baseSanCost 
							? `<p>SANå€¼ä¸è¶³ï¼åŸºç¡€æ¶ˆè€—${baseSanCost}ç‚¹ï¼Œæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}åéœ€è¦${actualSanCost}ç‚¹SANå€¼ã€‚</p>` 
							: `<p>SANå€¼ä¸è¶³ï¼éœ€è¦è‡³å°‘${baseSanCost}ç‚¹SANå€¼ã€‚</p>`;
						showModal('âŒ æ“ä½œå¤±è´¥', tipText, 
							[{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
						return;
					}
					paper.promotions.github = true;
					// â˜…â˜…â˜… æ”¹ä¸ºåŠ æ³•ï¼š+0.5 â˜…â˜…â˜…
					paper.citationMultiplier += 0.5;
					const sanText = actualSanCost !== baseSanCost 
						? `SANå€¼-${actualSanCost}ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰` 
						: `SANå€¼-${baseSanCost}`;
					result = `${sanText}ï¼Œè®ºæ–‡å¼•ç”¨é€Ÿåº¦+50%`;
					canProceed = changeSan(-baseSanCost);
					break;
				}
				case 'xiaohongshu': {
					const baseSanCost = 3;
					const actualSanCost = Math.abs(getActualSanChange(-baseSanCost));
					
					if (gameState.san < actualSanCost) {
						const tipText = actualSanCost !== baseSanCost 
							? `<p>SANå€¼ä¸è¶³ï¼åŸºç¡€æ¶ˆè€—${baseSanCost}ç‚¹ï¼Œæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}åéœ€è¦${actualSanCost}ç‚¹SANå€¼ã€‚</p>` 
							: `<p>SANå€¼ä¸è¶³ï¼éœ€è¦è‡³å°‘${baseSanCost}ç‚¹SANå€¼ã€‚</p>`;
						showModal('âŒ æ“ä½œå¤±è´¥', tipText, 
							[{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
						return;
					}
					paper.promotions.xiaohongshu = true;
					// â˜…â˜…â˜… æ”¹ä¸ºåŠ æ³•ï¼š+0.25 â˜…â˜…â˜…
					paper.citationMultiplier += 0.25;
					const sanText = actualSanCost !== baseSanCost 
						? `SANå€¼-${actualSanCost}ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰` 
						: `SANå€¼-${baseSanCost}`;
					result = `${sanText}ï¼Œè®ºæ–‡å¼•ç”¨é€Ÿåº¦+25%`;
					canProceed = changeSan(-baseSanCost);
					break;
				}
				case 'quantumbit':
					// â˜…â˜…â˜… é‡å­ä½ä¿æŒä¸å˜ï¼Œç›´æ¥+100å¼•ç”¨ â˜…â˜…â˜…
					if (paper.grade !== 'A') {
						showModal('âŒ æ“ä½œå¤±è´¥', '<p>åªæœ‰Aç±»è®ºæ–‡æ‰èƒ½ä¸Šé‡å­ä½å°é¢ï¼</p>', 
							[{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
						return;
					}
					if (gameState.gold < 10) {
						showModal('âŒ æ“ä½œå¤±è´¥', '<p>é‡‘é’±ä¸è¶³ï¼éœ€è¦è‡³å°‘10é‡‘å¸ã€‚</p>', 
							[{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
						return;
					}
					paper.promotions.quantumbit = true;
					paper.citations += 100;
					gameState.totalCitations += 100;
					result = 'é‡‘é’±-10ï¼Œè®ºæ–‡å¼•ç”¨+100';
					canProceed = changeGold(-10);
					break;
			}

			if (canProceed) {
				addLog('è®ºæ–‡æ¨å¹¿', `"${paper.title.substring(0, 15)}..." ${typeNames[type]}`, result);
				updateAllUI();
			}
		}

		// ==================== è·å–ä¼šè®®ç»Ÿè®¡ä¿¡æ¯ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰====================

		/*** è·å–ä¼šè®®çš„ç»Ÿè®¡æ‘˜è¦ä¿¡æ¯*/
		function getConferenceStatsForDisplay(month, grade, isReversed) {
			const stats = getMonthStats(month, grade, isReversed);
			const confInfo = getConferenceInfo(month, grade, gameState.year);
			
			// è®¡ç®—å½±å“å› å­
			const impactFactor = getConferenceImpactFactor({ month: month }, grade);
			
			// è®¡ç®—ä¸­ç¨¿å‡åˆ†
			let avgAcceptedScore = '-';
			if (stats && stats.submissions >= 10) {
				const totalAccepted = (stats.poster || 0) + (stats.oral || 0) + (stats.bestPaper || 0);
				if (totalAccepted > 0 && stats.avgScorePoster) {
					const weightedSum = (stats.avgScorePoster * (stats.poster || 0)) + 
									  (stats.avgScoreOral * (stats.oral || 0)) + 
									  (stats.avgScoreBestPaper * (stats.bestPaper || 0));
					avgAcceptedScore = Math.round(weightedSum / totalAccepted);
				}
			}
			
			return {
				name: confInfo.name,
				fullName: confInfo.fullName,
				year: confInfo.year,
				submissions: stats?.submissions || 0,
				acceptRate: stats?.acceptRate || 0,
				avgAcceptedScore: avgAcceptedScore,
				impactFactor: impactFactor,
				hasEnoughData: stats && stats.submissions >= 10
			};
		}

		/**
		 * ç”Ÿæˆä¼šè®®tooltipæ–‡æœ¬
		 */
		function generateConferenceTooltip(month, grade, isReversed) {
			const info = getConferenceStatsForDisplay(month, grade, isReversed);
			
			let tooltip = `${info.fullName} ${info.year}`;
			
			if (info.hasEnoughData) {
				tooltip += `\nâ”â”â”â”â”â”â”â”â”â”â”â”`;
				tooltip += `\nğŸ“Š æŠ•ç¨¿æ•°: ${info.submissions}`;
				tooltip += `\nâœ… å½•ç”¨ç‡: ${(info.acceptRate * 100).toFixed(1)}%`;
				tooltip += `\nğŸ“ˆ å½±å“å› å­: ${info.impactFactor.toFixed(2)}`;
				tooltip += `\nğŸ¯ ä¸­ç¨¿å‡åˆ†: ${info.avgAcceptedScore}`;
			} else {
				tooltip += `\n(æ•°æ®ä¸è¶³ï¼Œæš‚æ— ç»Ÿè®¡)`;
			}
			
			return tooltip;
		}

        // ==================== è®ºæ–‡å·¥ä½œç«™ ====================
		
		
		
		function renderPaperSlots() {
			const container = document.getElementById('paper-slots');
			let html = '';
			
			// é¢„å…ˆè·å–å½“å‰æœˆä»½çš„ä¼šè®®ä¿¡æ¯
			const confA = getConferenceInfo(gameState.month, 'A', gameState.year);
			const confB = getConferenceInfo(gameState.month, 'B', gameState.year);
			const confC = getConferenceInfo(gameState.month, 'C', gameState.year);
			
			// â˜…â˜…â˜… æ–°å¢ï¼šè·å–tooltipä¿¡æ¯ â˜…â˜…â˜…
			const tooltipA = generateConferenceTooltip(gameState.month, 'A', gameState.isReversed);
			const tooltipB = generateConferenceTooltip(gameState.month, 'B', gameState.isReversed);
			const tooltipC = generateConferenceTooltip(gameState.month, 'C', gameState.isReversed);
			
			// â˜…â˜…â˜… æ–°å¢ï¼šè·å–ç®€è¦ç»Ÿè®¡ç”¨äºæŒ‰é’®æ˜¾ç¤º â˜…â˜…â˜…
			const statsA = getConferenceStatsForDisplay(gameState.month, 'A', gameState.isReversed);
			const statsB = getConferenceStatsForDisplay(gameState.month, 'B', gameState.isReversed);
			const statsC = getConferenceStatsForDisplay(gameState.month, 'C', gameState.isReversed);
			
			for (let i = 0; i < 4; i++) {
				const unlocked = i < gameState.paperSlots;
				const paper = gameState.papers[i];
				
				if (!unlocked) {
					const req = [0, 6, 12, 18][i];
					html += `<div class="paper-slot locked">
						<div class="slot-header">
							<span class="slot-title">è®ºæ–‡æ§½${i + 1}</span>
							<span class="reviewing-badge"><i class="fas fa-lock"></i> ç§‘ç ”${req}è§£é”</span>
						</div>
					</div>`;
				} else if (!paper) {
					// â˜…â˜…â˜… ä¿®æ”¹ï¼šæ˜¾ç¤ºä¼šè®®ç»Ÿè®¡ä¿¡æ¯ â˜…â˜…â˜…
					html += `<div class="paper-slot">
						<div class="slot-header">
							<span class="slot-title">è®ºæ–‡æ§½${i + 1}</span>
							<span style="color:var(--text-secondary);font-size:0.75rem;">ç©ºé—²</span>
						</div>
						<button class="new-paper-btn" onclick="createNewPaper(${i})">
							<i class="fas fa-plus"></i> å¼€å¯æ–°è®ºæ–‡
						</button>
						<div style="margin-top:8px;font-size:0.6rem;color:var(--text-secondary);text-align:center;">
							æœ¬æœˆä¼šè®®ï¼šA-${confA.name} | B-${confB.name} | C-${confC.name}
						</div>
						<div style="margin-top:4px;font-size:0.55rem;color:var(--text-secondary);text-align:center;">
							${statsA.hasEnoughData 
								? `å½•ç”¨ç‡: A-${(statsA.acceptRate*100).toFixed(0)}% B-${(statsB.acceptRate*100).toFixed(0)}% C-${(statsC.acceptRate*100).toFixed(0)}%${statsA.submissions === 100 ? ' (é»˜è®¤å€¼)' : ''}` 
								: '(ç»Ÿè®¡æ•°æ®åŠ è½½ä¸­...)'}
						</div>
					</div>`;
				} else {
					const total = paper.ideaScore + paper.expScore + paper.writeScore;
					const canSubmit = paper.ideaScore > 0 && paper.expScore > 0 && paper.writeScore > 0 && !paper.reviewing;
					const reviewingBadgeClass = paper.reviewing ? `reviewing-badge grade-${paper.submittedGrade}` : '';
					
					let reviewingInfo = '';
					if (paper.reviewing) {
						const confName = paper.conferenceInfo ? paper.conferenceInfo.name : paper.submittedGrade + 'ç±»';
						reviewingInfo = `<span class="${reviewingBadgeClass}"><i class="fas fa-hourglass-half"></i> ${confName} å‰©ä½™${Math.max(0, paper.reviewMonths)}æœˆ</span>`;
					}
					
					// â˜…â˜…â˜… ä¿®æ”¹ï¼šå¢å¼ºæŠ•ç¨¿æŒ‰é’®çš„tooltip â˜…â˜…â˜…
					html += `<div class="paper-slot active">
						<div class="slot-header">
							<span class="slot-title">è®ºæ–‡æ§½${i + 1}</span>
							${reviewingInfo}
						</div>
						<div class="paper-title">${paper.title}</div>
						<div class="paper-scores">
							<div class="score-box"><div class="label">Idea</div><div class="value">${paper.ideaScore}</div></div>
							<div class="score-box"><div class="label">å®éªŒ</div><div class="value">${paper.expScore}</div></div>
							<div class="score-box"><div class="label">å†™ä½œ</div><div class="value">${paper.writeScore}</div></div>
						</div>
						<div class="paper-total">æ€»åˆ†: ${total}</div>
						<div class="paper-actions">
							<button class="btn btn-danger" onclick="submitPaper(${i},'A')" ${!canSubmit?'disabled':''} 
									title="${tooltipA.replace(/"/g, '&quot;')}">
								<i class="fas fa-star"></i> A-${confA.name}
								${statsA.hasEnoughData ? `<span style="font-size:0.6rem;opacity:0.8;">(${(statsA.acceptRate*100).toFixed(0)}%)</span>` : ''}
							</button>
							<button class="btn btn-warning" onclick="submitPaper(${i},'B')" ${!canSubmit?'disabled':''} 
									title="${tooltipB.replace(/"/g, '&quot;')}">
								<i class="fas fa-certificate"></i> B-${confB.name}
								${statsB.hasEnoughData ? `<span style="font-size:0.6rem;opacity:0.8;">(${(statsB.acceptRate*100).toFixed(0)}%)</span>` : ''}
							</button>
							<button class="btn btn-success" onclick="submitPaper(${i},'C')" ${!canSubmit?'disabled':''} 
									title="${tooltipC.replace(/"/g, '&quot;')}">
								<i class="fas fa-check"></i> C-${confC.name}
								${statsC.hasEnoughData ? `<span style="font-size:0.6rem;opacity:0.8;">(${(statsC.acceptRate*100).toFixed(0)}%)</span>` : ''}
							</button>
							<button class="btn btn-info" onclick="abandonPaper(${i})" ${paper.reviewing?'disabled':''}>
								<i class="fas fa-trash"></i> æ”¾å¼ƒ
							</button>
						</div>
					</div>`;
				}
			}
			container.innerHTML = html;
		}

        function generatePaperTitle() {
            const w = paperTitleWords;
            const templates = [
                () => `${rand(w.adjectives)} ${rand(w.nouns)} for ${rand(w.domains)} ${rand(w.verbs)}`,
                () => `${rand(w.verbs)} ${rand(w.domains)} with ${rand(w.adjectives)} ${rand(w.nouns)}`,
                () => `${rand(w.adjectives)} ${rand(w.adjectives)} ${rand(w.nouns)}`,
                () => `Towards ${rand(w.adjectives)} ${rand(w.domains)} ${rand(w.nouns)}`,
                () => `${rand(w.domains)} ${rand(w.verbs)} via ${rand(w.adjectives)} ${rand(w.nouns)}`
            ];
            return rand(templates)();
        }

        function createNewPaper(slot) {
            const title = generatePaperTitle();
            gameState.papers[slot] = {
                title: title,
                ideaScore: 0,
                expScore: 0,
                writeScore: 0,
                reviewing: false,
                reviewMonths: 0,
                submittedGrade: null,
                submittedScore: 0
            };
            addLog('æ–°è®ºæ–‡', `åœ¨è®ºæ–‡æ§½${slot + 1}å¼€å¯ï¼š${title}`);
            renderPaperSlots();
        }

        function checkResearchUnlock(silent = false) {
            // æ„šé’ä¹‹é™¢å£«è½¬ä¸–ï¼šå·²å…¨éƒ¨è§£é”
            if (gameState.isReversed && gameState.character === 'genius') {
                gameState.paperSlots = 4;
                return;
            }
            
            const thresholds = [0, 6, 12, 18];
            let newUnlock = false;
            for (let i = 1; i < 4; i++) {
                if (gameState.research >= thresholds[i] && gameState.paperSlots <= i) {
                    gameState.paperSlots = i + 1;
                    newUnlock = true;
                }
            }
            if (newUnlock && !silent) {
                showModal('ğŸ‰ æ–°è®ºæ–‡æ§½è§£é”ï¼', 
                    `<p>æ­å–œï¼ç§‘ç ”èƒ½åŠ›è¾¾åˆ°${gameState.research}ï¼Œè§£é”è®ºæ–‡æ§½${gameState.paperSlots}ï¼</p>`,
                    [{ text: 'å¤ªæ£’äº†ï¼', class: 'btn-primary', action: closeModal }]);
                renderPaperSlots();
            }
        }
		
        // ==================== æ“ä½œåŠŸèƒ½ ====================
		function readPaper() {
			// â˜…â˜…â˜… ä¿®æ”¹ï¼šæ£€æŸ¥è¡ŒåŠ¨æ¬¡æ•°è€Œéå•æ¬¡æ ‡å¿— â˜…â˜…â˜…
			if (gameState.actionCount >= gameState.actionLimit) {
				showModal('âŒ æ“ä½œå¤±è´¥', `<p>æœ¬æœˆè¡ŒåŠ¨æ¬¡æ•°å·²ç”¨å®Œï¼ï¼ˆ${gameState.actionCount}/${gameState.actionLimit}ï¼‰</p>`, 
					[{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			const has4K = gameState.buffs.permanent.some(b => b.type === 'read_san_reduce');
			const baseSanCost = has4K ? 1 : 2;
			const actualSanCost = Math.abs(getActualSanChange(-baseSanCost));
			
			if (gameState.san < actualSanCost) {
				const tipText = actualSanCost !== baseSanCost 
					? `<p>SANå€¼ä¸è¶³ï¼åŸºç¡€æ¶ˆè€—${baseSanCost}ç‚¹ï¼Œæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}åéœ€è¦${actualSanCost}ç‚¹SANå€¼ã€‚</p>` 
					: `<p>SANå€¼ä¸è¶³ï¼éœ€è¦è‡³å°‘${baseSanCost}ç‚¹SANå€¼ã€‚</p>`;
				showModal('âŒ æ“ä½œå¤±è´¥', tipText, 
					[{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			// â˜…â˜…â˜… ä¿®æ”¹ï¼šå¢åŠ è¡ŒåŠ¨è®¡æ•° â˜…â˜…â˜…
			gameState.actionCount++;
			gameState.actionUsed = gameState.actionCount >= gameState.actionLimit;
			
			gameState.buffs.temporary.push({ type: 'idea_bonus', name: 'ä¸‹æ¬¡æƒ³ideaåˆ†æ•°+1', value: 1, permanent: false });
			gameState.readCount++;

			let result = `SANå€¼-${actualSanCost}`;
			if (has4K) result += 'ï¼ˆ4Kæ˜¾ç¤ºå™¨ç”Ÿæ•ˆï¼‰';
			if (actualSanCost !== baseSanCost) {
				result += `ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰`;
			}
			result += 'ï¼Œè·å¾—ä¸´æ—¶buffï¼šä¸‹æ¬¡æƒ³ideaåˆ†æ•°+1';
			
			// â˜…â˜…â˜… æ–°å¢ï¼šæ˜¾ç¤ºè¡ŒåŠ¨æ¬¡æ•° â˜…â˜…â˜…
			if (gameState.actionLimit > 1) {
				result += `ï¼ˆè¡ŒåŠ¨${gameState.actionCount}/${gameState.actionLimit}ï¼‰`;
			}

			if (gameState.readCount % 5 === 0) {
				changeResearch(1);
				result += `ï¼Œé˜…è¯»è®ºæ–‡è¾¾åˆ°${gameState.readCount}æ¬¡ï¼Œç§‘ç ”èƒ½åŠ›+1`;
			}

			addLog('çœ‹è®ºæ–‡', 'è®¤çœŸé˜…è¯»äº†å­¦æœ¯è®ºæ–‡', result);
			updateBuffs();
			changeSan(-baseSanCost);
		}

		function partTimeJob() {
			// â˜…â˜…â˜… ä¿®æ”¹ï¼šæ£€æŸ¥è¡ŒåŠ¨æ¬¡æ•° â˜…â˜…â˜…
			if (gameState.actionCount >= gameState.actionLimit) {
				showModal('âŒ æ“ä½œå¤±è´¥', `<p>æœ¬æœˆè¡ŒåŠ¨æ¬¡æ•°å·²ç”¨å®Œï¼ï¼ˆ${gameState.actionCount}/${gameState.actionLimit}ï¼‰</p>`, 
					[{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			const baseSanCost = 5;
			const actualSanCost = Math.abs(getActualSanChange(-baseSanCost));
			
			if (gameState.san < actualSanCost) {
				const tipText = actualSanCost !== baseSanCost 
					? `<p>SANå€¼ä¸è¶³ï¼åŸºç¡€æ¶ˆè€—${baseSanCost}ç‚¹ï¼Œæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}åéœ€è¦${actualSanCost}ç‚¹SANå€¼ã€‚</p>` 
					: `<p>SANå€¼ä¸è¶³ï¼éœ€è¦è‡³å°‘${baseSanCost}ç‚¹SANå€¼ã€‚</p>`;
				showModal('âŒ æ“ä½œå¤±è´¥', tipText, 
					[{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			// â˜…â˜…â˜… ä¿®æ”¹ï¼šå¢åŠ è¡ŒåŠ¨è®¡æ•° â˜…â˜…â˜…
			gameState.actionCount++;
			gameState.actionUsed = gameState.actionCount >= gameState.actionLimit;
			gameState.workCount = (gameState.workCount || 0) + 1;
			
			let result = `SANå€¼-${actualSanCost}`;
			if (actualSanCost !== baseSanCost) {
				result += `ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰`;
			}
			result += 'ï¼Œé‡‘é’±+2';
			
			// â˜…â˜…â˜… æ–°å¢ï¼šæ˜¾ç¤ºè¡ŒåŠ¨æ¬¡æ•° â˜…â˜…â˜…
			if (gameState.actionLimit > 1) {
				result += `ï¼ˆè¡ŒåŠ¨${gameState.actionCount}/${gameState.actionLimit}ï¼‰`;
			}
			
			addLog('æ‰“å·¥', 'è¾›è‹¦å·¥ä½œèµšå–ç”Ÿæ´»è´¹', result);
			changeStats({ san: -baseSanCost, gold: 2 });
		}


		function thinkIdea() {
			// â˜…â˜…â˜… ä¿®æ”¹ï¼šæ£€æŸ¥è¡ŒåŠ¨æ¬¡æ•° â˜…â˜…â˜…
			if (gameState.actionCount >= gameState.actionLimit) {
				showModal('âŒ æ“ä½œå¤±è´¥', `<p>æœ¬æœˆè¡ŒåŠ¨æ¬¡æ•°å·²ç”¨å®Œï¼ï¼ˆ${gameState.actionCount}/${gameState.actionLimit}ï¼‰</p>`, 
					[{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			// æ£€æŸ¥debuffå­˜åœ¨æ€§ï¼ˆåªåœ¨ç¬¬ä¸€æ¬¡ç”Ÿæ•ˆï¼‰
			const hasExhaustion = gameState.buffs.temporary.some(b => b.type === 'idea_exhaustion');
			const hasStolen = gameState.buffs.temporary.some(b => b.type === 'idea_stolen');
			const hasSlack = gameState.buffs.temporary.some(b => b.type === 'slack_debuff');
			
			// è®¢é˜…buffï¼ˆæ¯æ¬¡éƒ½ç”Ÿæ•ˆï¼‰
			const geminiSub = gameState.buffs.temporary.find(b => b.type === 'idea_san_reduce');
			const hasGeminiSub = !!geminiSub;
			
			// SANæ¶ˆè€—è®¡ç®—
			let baseSanCost = 2;
			if (hasGeminiSub) {
				baseSanCost = Math.max(1, baseSanCost - 1);
			}
			
			const actualSanCost = Math.abs(getActualSanChange(-baseSanCost));
			
			if (gameState.san < actualSanCost) {
				const tipText = actualSanCost !== baseSanCost 
					? `<p>SANå€¼ä¸è¶³ï¼åŸºç¡€æ¶ˆè€—${baseSanCost}ç‚¹ï¼Œæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}åéœ€è¦${actualSanCost}ç‚¹SANå€¼ã€‚</p>` 
					: `<p>SANå€¼ä¸è¶³ï¼éœ€è¦è‡³å°‘${baseSanCost}ç‚¹SANå€¼ã€‚</p>`;
				showModal('âŒ æ“ä½œå¤±è´¥', tipText, 
					[{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			const available = gameState.papers.map((p, i) => ({ paper: p, index: i }))
				.filter(({ paper }) => paper && !paper.reviewing);
			if (available.length === 0) {
				showModal('æ— æ³•æ“ä½œ', '<p>æ²¡æœ‰å¯ç”¨çš„è®ºæ–‡ï¼è¯·å…ˆå¼€å¯ä¸€ç¯‡æ–°è®ºæ–‡ã€‚</p>', 
					[{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			showPaperSelectModal('æƒ³idea', available, (index) => {
				gameState.actionCount++;
				gameState.actionUsed = gameState.actionCount >= gameState.actionLimit;
				gameState.ideaClickCount = (gameState.ideaClickCount || 0) + 1;
				
				const paper = gameState.papers[index];
				const oldScore = paper.ideaScore;
				
				let times = 1 + countBuff('idea_times');
				
				// ä¸»åŠ¨æŠ€èƒ½åŠ æˆ
				let effectiveResearch = gameState.research;
				let skillUsed = false;
				let skillSource = '';
				
				if (gameState.nextIdeaResearchBonus > 0) {
					effectiveResearch += gameState.nextIdeaResearchBonus;
					skillUsed = true;
					skillSource = gameState.nextIdeaBonusSource === 'senior' ? 'å¸ˆå…„å¸ˆå§æ•‘æˆ‘' : 'å¯¼å¸ˆæ•‘æˆ‘';
					gameState.nextIdeaResearchBonus = 0;
					gameState.nextIdeaBonusSource = null;
				}
				
				// â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šæ–°çš„å¾ªç¯é€»è¾‘ â˜…â˜…â˜…
				let currentScore = oldScore;
				let scoreChanges = [];  // è®°å½•æ¯æ¬¡çš„åˆ†æ•°å˜åŒ–
				
				for (let i = 0; i < times; i++) {
					// â˜…â˜…â˜… ç¬¬ä¸€æ¬¡ä½¿ç”¨æ‰€æœ‰buffï¼Œåç»­åªä½¿ç”¨æ°¸ä¹…buff â˜…â˜…â˜…
					const permanentOnly = (i > 0);
					let gen = calculateScoreWithResearch('idea', effectiveResearch, permanentOnly);
					
					// â˜…â˜…â˜… è®¢é˜…åŠ æˆï¼šæ¯æ¬¡éƒ½ç”Ÿæ•ˆ â˜…â˜…â˜…
					if (hasGeminiSub && geminiSub.bonusScore) {
						gen += geminiSub.bonusScore;
					}
					
					// â˜…â˜…â˜… debuffï¼šåªæœ‰ç¬¬ä¸€æ¬¡ç”Ÿæ•ˆ â˜…â˜…â˜…
					if (i === 0) {
						if (hasExhaustion) {
							gen = Math.floor(gen / 2);
						}
						if (hasStolen) {
							gen = Math.floor(gen / 2);
						}
						if (hasSlack) {
							gen = Math.floor(gen / 2);
						}
					}
					
					// â˜…â˜…â˜… æ¯æ¬¡å¾ªç¯éƒ½è§¦å‘ä¿åº•æœºåˆ¶ â˜…â˜…â˜…
					const newScore = Math.max(gen, currentScore + 1);
					scoreChanges.push({ generated: gen, result: newScore, wasGuaranteed: gen < currentScore + 1 });
					currentScore = newScore;
				}
				
				paper.ideaScore = currentScore;
				
				// æ¸…é™¤å·²ç”Ÿæ•ˆçš„debuff
				if (hasExhaustion) {
					gameState.buffs.temporary = gameState.buffs.temporary.filter(b => b.type !== 'idea_exhaustion');
				}
				if (hasStolen) {
					gameState.buffs.temporary = gameState.buffs.temporary.filter(b => b.type !== 'idea_stolen');
				}
				
				// ç–²åŠ³ç´¯ç§¯æ£€æµ‹
				if (gameState.ideaClickCount % 5 === 0) {
					gameState.buffs.temporary.push({ 
						type: 'idea_exhaustion', 
						name: 'çµæ„Ÿæ¯ç«­ï¼šä¸‹æ¬¡æƒ³ideaæ€»åˆ†Ã·2', 
						value: 0.5, 
						multiply: true, 
						permanent: false 
					});
					addLog('âš ï¸ ç–²åŠ³ç´¯ç§¯', 'çµæ„Ÿæ¯ç«­', 'è¿ç»­æƒ³idea5æ¬¡ï¼Œä¸‹æ¬¡æƒ³ideaæ€»åˆ†é™¤ä»¥2');
				}
				
				// æ¶ˆè€—ä¸´æ—¶buff
				consumeTempBuff('idea_times');
				consumeTempBuff('idea_bonus');
				
				// æ„å»ºæ—¥å¿—
				let result = `SANå€¼-${actualSanCost}`;
				if (actualSanCost !== baseSanCost) {
					result += `ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰`;
				}
				if (skillUsed) {
					result += `ï¼ˆ${skillSource}ç”Ÿæ•ˆï¼ï¼‰`;
				}
				if (hasGeminiSub) result += 'ï¼ˆGemini: æ¯æ¬¡+4ï¼‰';
				if (hasExhaustion) result += 'ï¼ˆé¦–æ¬¡çµæ„Ÿæ¯ç«­Ã·2ï¼‰';
				if (hasStolen) result += 'ï¼ˆé¦–æ¬¡è¢«å·ideaÃ·2ï¼‰';
				if (hasSlack) result += 'ï¼ˆé¦–æ¬¡æ¾æ‡ˆÃ·2ï¼‰';
				if (times > 1) result += `ï¼ˆæƒ³${times}æ¬¡ï¼‰`;
				
				if (gameState.actionLimit > 1) {
					result += `ï¼ˆè¡ŒåŠ¨${gameState.actionCount}/${gameState.actionLimit}ï¼‰`;
				}
				
				// â˜…â˜…â˜… æ˜¾ç¤ºè¯¦ç»†çš„åˆ†æ•°å˜åŒ–è¿‡ç¨‹ â˜…â˜…â˜…
				const guaranteedCount = scoreChanges.filter(c => c.wasGuaranteed).length;
				result += `ï¼Œideaåˆ† ${oldScore} â†’ ${currentScore}`;
				if (guaranteedCount > 0) {
					result += `ï¼ˆ${guaranteedCount}æ¬¡ä¿åº•ç”Ÿæ•ˆï¼‰`;
				}
				
				addLog('æƒ³idea', `ä¸º"${paper.title.substring(0, 15)}..."æ€è€ƒidea`, result);
				renderPaperSlots();
				changeSan(-baseSanCost);
				updateBuffs();
			});
		}

		function doExperiment() {
			if (gameState.actionCount >= gameState.actionLimit) {
				showModal('âŒ æ“ä½œå¤±è´¥', `<p>æœ¬æœˆè¡ŒåŠ¨æ¬¡æ•°å·²ç”¨å®Œï¼ï¼ˆ${gameState.actionCount}/${gameState.actionLimit}ï¼‰</p>`, 
					[{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			// æ£€æŸ¥debuffï¼ˆåªåœ¨ç¬¬ä¸€æ¬¡ç”Ÿæ•ˆï¼‰
			const hasOverheat = gameState.buffs.temporary.some(b => b.type === 'exp_overheat');
			const hasSlack = gameState.buffs.temporary.some(b => b.type === 'slack_debuff');
			
			// è®¢é˜…buffï¼ˆæ¯æ¬¡éƒ½ç”Ÿæ•ˆï¼‰
			const gptSub = gameState.buffs.temporary.find(b => b.type === 'exp_san_reduce');
			const hasGptSub = !!gptSub;
			
			let baseSanCost = 3;
			if (hasGptSub) {
				baseSanCost = Math.max(1, baseSanCost - 1);
			}
			
			const actualSanCost = Math.abs(getActualSanChange(-baseSanCost));
			
			if (gameState.san < actualSanCost) {
				const tipText = actualSanCost !== baseSanCost 
					? `<p>SANå€¼ä¸è¶³ï¼åŸºç¡€æ¶ˆè€—${baseSanCost}ç‚¹ï¼Œæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}åéœ€è¦${actualSanCost}ç‚¹SANå€¼ã€‚</p>` 
					: `<p>SANå€¼ä¸è¶³ï¼éœ€è¦è‡³å°‘${baseSanCost}ç‚¹SANå€¼ã€‚</p>`;
				showModal('âŒ æ“ä½œå¤±è´¥', tipText, 
					[{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			const available = gameState.papers.map((p, i) => ({ paper: p, index: i }))
				.filter(({ paper }) => paper && !paper.reviewing && paper.ideaScore > 0);
			if (available.length === 0) {
				showModal('æ— æ³•æ“ä½œ', '<p>æ²¡æœ‰å¯ç”¨çš„è®ºæ–‡ï¼éœ€è¦å…ˆæœ‰ideaåˆ†å¤§äº0çš„è®ºæ–‡ã€‚</p>', 
					[{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			showPaperSelectModal('åšå®éªŒ', available, (index) => {
				gameState.actionCount++;
				gameState.actionUsed = gameState.actionCount >= gameState.actionLimit;
				gameState.expClickCount = (gameState.expClickCount || 0) + 1;
				
				const paper = gameState.papers[index];
				const oldScore = paper.expScore;
				
				let times = 1 + countBuff('exp_times');
				
				// â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šæ–°çš„å¾ªç¯é€»è¾‘ â˜…â˜…â˜…
				let currentScore = oldScore;
				let scoreChanges = [];
				
				for (let i = 0; i < times; i++) {
					// â˜…â˜…â˜… ç¬¬ä¸€æ¬¡ä½¿ç”¨æ‰€æœ‰buffï¼Œåç»­åªä½¿ç”¨æ°¸ä¹…buff â˜…â˜…â˜…
					const permanentOnly = (i > 0);
					let gen = calculateScore('exp', permanentOnly);
					
					// â˜…â˜…â˜… è®¢é˜…åŠ æˆï¼šæ¯æ¬¡éƒ½ç”Ÿæ•ˆ â˜…â˜…â˜…
					if (hasGptSub && gptSub.bonusScore) {
						gen += gptSub.bonusScore;
					}
					
					// â˜…â˜…â˜… debuffï¼šåªæœ‰ç¬¬ä¸€æ¬¡ç”Ÿæ•ˆ â˜…â˜…â˜…
					if (i === 0) {
						if (hasOverheat) {
							gen = Math.floor(gen / 2);
						}
						if (hasSlack) {
							gen = Math.floor(gen / 2);
						}
					}
					
					// â˜…â˜…â˜… æ¯æ¬¡å¾ªç¯éƒ½è§¦å‘ä¿åº•æœºåˆ¶ â˜…â˜…â˜…
					const newScore = Math.max(gen, currentScore + 1);
					scoreChanges.push({ generated: gen, result: newScore, wasGuaranteed: gen < currentScore + 1 });
					currentScore = newScore;
				}
				
				paper.expScore = currentScore;
				
				// æ¸…é™¤å·²ç”Ÿæ•ˆçš„debuff
				if (hasOverheat) {
					gameState.buffs.temporary = gameState.buffs.temporary.filter(b => b.type !== 'exp_overheat');
				}
				
				// ç–²åŠ³ç´¯ç§¯
				if (gameState.expClickCount % 5 === 0) {
					gameState.buffs.temporary.push({ 
						type: 'exp_overheat', 
						name: 'ä¸»æœºå‘çƒ«ï¼šä¸‹æ¬¡åšå®éªŒæ€»åˆ†Ã·2', 
						value: 0.5, 
						multiply: true, 
						permanent: false 
					});
					addLog('âš ï¸ ç–²åŠ³ç´¯ç§¯', 'ä¸»æœºå‘çƒ«', 'è¿ç»­åšå®éªŒ5æ¬¡ï¼Œä¸‹æ¬¡åšå®éªŒæ€»åˆ†é™¤ä»¥2');
				}
				
				consumeTempBuff('exp_times');
				consumeTempBuff('exp_bonus');
				
				// æ„å»ºæ—¥å¿—
				let result = `SANå€¼-${actualSanCost}`;
				if (actualSanCost !== baseSanCost) {
					result += `ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰`;
				}
				if (hasGptSub) result += 'ï¼ˆGPT: æ¯æ¬¡+4ï¼‰';
				if (hasOverheat) result += 'ï¼ˆé¦–æ¬¡ä¸»æœºå‘çƒ«Ã·2ï¼‰';
				if (hasSlack) result += 'ï¼ˆé¦–æ¬¡æ¾æ‡ˆÃ·2ï¼‰';
				if (times > 1) result += `ï¼ˆåš${times}æ¬¡ï¼‰`;
				
				if (gameState.actionLimit > 1) {
					result += `ï¼ˆè¡ŒåŠ¨${gameState.actionCount}/${gameState.actionLimit}ï¼‰`;
				}
				
				const guaranteedCount = scoreChanges.filter(c => c.wasGuaranteed).length;
				result += `ï¼Œå®éªŒåˆ† ${oldScore} â†’ ${currentScore}`;
				if (guaranteedCount > 0) {
					result += `ï¼ˆ${guaranteedCount}æ¬¡ä¿åº•ç”Ÿæ•ˆï¼‰`;
				}
				
				addLog('åšå®éªŒ', `ä¸º"${paper.title.substring(0, 15)}..."åšå®éªŒ`, result);
				renderPaperSlots();
				changeSan(-baseSanCost);
				updateBuffs();
			});
		}

		function writePaper() {
			if (gameState.actionCount >= gameState.actionLimit) {
				showModal('âŒ æ“ä½œå¤±è´¥', `<p>æœ¬æœˆè¡ŒåŠ¨æ¬¡æ•°å·²ç”¨å®Œï¼ï¼ˆ${gameState.actionCount}/${gameState.actionLimit}ï¼‰</p>`, 
					[{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			// æ£€æŸ¥debuffï¼ˆåªåœ¨ç¬¬ä¸€æ¬¡ç”Ÿæ•ˆï¼‰
			const hasWritersBlock = gameState.buffs.temporary.some(b => b.type === 'write_block');
			const hasSlack = gameState.buffs.temporary.some(b => b.type === 'slack_debuff');
			
			// è®¢é˜…buffï¼ˆæ¯æ¬¡éƒ½ç”Ÿæ•ˆï¼‰
			const claudeSub = gameState.buffs.temporary.find(b => b.type === 'write_san_reduce_temp');
			const hasClaudeSub = !!claudeSub;
			
			const hasKeyboard = gameState.buffs.permanent.some(b => b.type === 'write_san_reduce');
			let baseSanCost = hasKeyboard ? 3 : 4;
			
			if (hasClaudeSub) {
				baseSanCost = Math.max(1, baseSanCost - 1);
			}
			
			const actualSanCost = Math.abs(getActualSanChange(-baseSanCost));
			
			if (gameState.san < actualSanCost) {
				const tipText = actualSanCost !== baseSanCost 
					? `<p>SANå€¼ä¸è¶³ï¼åŸºç¡€æ¶ˆè€—${baseSanCost}ç‚¹ï¼Œæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}åéœ€è¦${actualSanCost}ç‚¹SANå€¼ã€‚</p>` 
					: `<p>SANå€¼ä¸è¶³ï¼éœ€è¦è‡³å°‘${baseSanCost}ç‚¹SANå€¼ã€‚</p>`;
				showModal('âŒ æ“ä½œå¤±è´¥', tipText, 
					[{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			const available = gameState.papers.map((p, i) => ({ paper: p, index: i }))
				.filter(({ paper }) => paper && !paper.reviewing && paper.expScore > 0);
			if (available.length === 0) {
				showModal('æ— æ³•æ“ä½œ', '<p>æ²¡æœ‰å¯ç”¨çš„è®ºæ–‡ï¼éœ€è¦å…ˆæœ‰å®éªŒåˆ†å¤§äº0çš„è®ºæ–‡ã€‚</p>', 
					[{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			showPaperSelectModal('å†™è®ºæ–‡', available, (index) => {
				gameState.actionCount++;
				gameState.actionUsed = gameState.actionCount >= gameState.actionLimit;
				gameState.writeClickCount = (gameState.writeClickCount || 0) + 1;
				
				const paper = gameState.papers[index];
				const oldScore = paper.writeScore;
				
				let times = 1 + countBuff('write_times');
				
				// â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šæ–°çš„å¾ªç¯é€»è¾‘ â˜…â˜…â˜…
				let currentScore = oldScore;
				let scoreChanges = [];
				
				for (let i = 0; i < times; i++) {
					// â˜…â˜…â˜… ç¬¬ä¸€æ¬¡ä½¿ç”¨æ‰€æœ‰buffï¼Œåç»­åªä½¿ç”¨æ°¸ä¹…buff â˜…â˜…â˜…
					const permanentOnly = (i > 0);
					let gen = calculateScore('write', permanentOnly);
					
					// â˜…â˜…â˜… è®¢é˜…åŠ æˆï¼šæ¯æ¬¡éƒ½ç”Ÿæ•ˆ â˜…â˜…â˜…
					if (hasClaudeSub && claudeSub.bonusScore) {
						gen += claudeSub.bonusScore;
					}
					
					// â˜…â˜…â˜… debuffï¼šåªæœ‰ç¬¬ä¸€æ¬¡ç”Ÿæ•ˆ â˜…â˜…â˜…
					if (i === 0) {
						if (hasWritersBlock) {
							gen = Math.floor(gen / 2);
						}
						if (hasSlack) {
							gen = Math.floor(gen / 2);
						}
					}
					
					// â˜…â˜…â˜… æ¯æ¬¡å¾ªç¯éƒ½è§¦å‘ä¿åº•æœºåˆ¶ â˜…â˜…â˜…
					const newScore = Math.max(gen, currentScore + 1);
					scoreChanges.push({ generated: gen, result: newScore, wasGuaranteed: gen < currentScore + 1 });
					currentScore = newScore;
				}
				
				paper.writeScore = currentScore;
				
				// æ¸…é™¤å·²ç”Ÿæ•ˆçš„debuff
				if (hasWritersBlock) {
					gameState.buffs.temporary = gameState.buffs.temporary.filter(b => b.type !== 'write_block');
				}
				
				// ç–²åŠ³ç´¯ç§¯
				if (gameState.writeClickCount % 5 === 0) {
					gameState.buffs.temporary.push({ 
						type: 'write_block', 
						name: 'æ— ä»ä¸‹ç¬”ï¼šä¸‹æ¬¡å†™è®ºæ–‡æ€»åˆ†Ã·2', 
						value: 0.5, 
						multiply: true, 
						permanent: false 
					});
					addLog('âš ï¸ ç–²åŠ³ç´¯ç§¯', 'æ— ä»ä¸‹ç¬”', 'è¿ç»­å†™è®ºæ–‡5æ¬¡ï¼Œä¸‹æ¬¡å†™è®ºæ–‡æ€»åˆ†é™¤ä»¥2');
				}
				
				consumeTempBuff('write_times');
				consumeTempBuff('write_bonus');
				
				// æ„å»ºæ—¥å¿—
				let result = `SANå€¼-${actualSanCost}`;
				if (hasKeyboard) result += 'ï¼ˆæœºæ¢°é”®ç›˜ç”Ÿæ•ˆï¼‰';
				if (hasClaudeSub) result += 'ï¼ˆClaude: æ¯æ¬¡+4ï¼‰';
				if (hasWritersBlock) result += 'ï¼ˆé¦–æ¬¡æ— ä»ä¸‹ç¬”Ã·2ï¼‰';
				if (hasSlack) result += 'ï¼ˆé¦–æ¬¡æ¾æ‡ˆÃ·2ï¼‰';
				if (times > 1) result += `ï¼ˆå†™${times}æ¬¡ï¼‰`;
				
				if (gameState.actionLimit > 1) {
					result += `ï¼ˆè¡ŒåŠ¨${gameState.actionCount}/${gameState.actionLimit}ï¼‰`;
				}
				
				const guaranteedCount = scoreChanges.filter(c => c.wasGuaranteed).length;
				result += `ï¼Œå†™ä½œåˆ† ${oldScore} â†’ ${currentScore}`;
				if (guaranteedCount > 0) {
					result += `ï¼ˆ${guaranteedCount}æ¬¡ä¿åº•ç”Ÿæ•ˆï¼‰`;
				}
				
				addLog('å†™è®ºæ–‡', `ä¸º"${paper.title.substring(0, 15)}..."å†™ä½œ`, result);
				renderPaperSlots();
				changeSan(-baseSanCost);
				updateBuffs();
			});
		}

		// â˜…â˜…â˜… ä¿®æ”¹ï¼šæ”¯æŒè‡ªå®šä¹‰ç§‘ç ”å€¼ + permanentOnly â˜…â˜…â˜…
		function calculateScoreWithResearch(type, customResearch, permanentOnly = false) {
			const base = customResearch * (0.5 + Math.random());
			const randomBonus = Math.floor(Math.random() * 6);
			let score = Math.round(base + randomBonus);

			let bonus = 0, multiplier = 1;
			const buffType = type + '_bonus';
			
			const buffsToCheck = permanentOnly 
				? gameState.buffs.permanent 
				: [...gameState.buffs.permanent, ...gameState.buffs.temporary];
			
			buffsToCheck.forEach(b => {
				if (b.type === buffType) {
					if (b.multiply) {
						multiplier += (b.value - 1);
					} else {
						bonus += b.value;
					}
				}
			});
			
			multiplier = Math.max(0, multiplier);
			return Math.max(0, Math.round(score * multiplier + bonus));
		}

		// â˜…â˜…â˜… ä¿®æ”¹ï¼šå¢åŠ  permanentOnly å‚æ•° â˜…â˜…â˜…
		function calculateScore(type, permanentOnly = false) {
			const base = gameState.research * (0.5 + Math.random());
			const randomBonus = Math.floor(Math.random() * 6);
			let score = Math.round(base + randomBonus);

			let bonus = 0, multiplier = 1;
			const buffType = type + '_bonus';
			
			// â˜…â˜…â˜… æ ¹æ®å‚æ•°å†³å®šä½¿ç”¨å“ªäº›buff â˜…â˜…â˜…
			const buffsToCheck = permanentOnly 
				? gameState.buffs.permanent 
				: [...gameState.buffs.permanent, ...gameState.buffs.temporary];
			
			buffsToCheck.forEach(b => {
				if (b.type === buffType) {
					if (b.multiply) {
						multiplier += (b.value - 1);
					} else {
						bonus += b.value;
					}
				}
			});
			
			multiplier = Math.max(0, multiplier);
			return Math.max(0, Math.round(score * multiplier + bonus));
		}

        function countBuff(type) {
            let count = 0;
            [...gameState.buffs.permanent, ...gameState.buffs.temporary].forEach(b => {
                if (b.type === type) count += b.value;
            });
            return count;
        }

        function consumeTempBuff(type) {
            gameState.buffs.temporary = gameState.buffs.temporary.filter(b => b.type !== type);
        }
		
        
		// ==================== æ–°å¢ï¼šç»Ÿä¸€å®¡ç¨¿äº‹ä»¶é˜Ÿåˆ—ç³»ç»Ÿ ====================

		/**
		 * å¼€å§‹å¤„ç†æœ¬æœˆçš„å®¡ç¨¿ç»“æœ
		 * @param {Array} slots - å¾…å¤„ç†çš„å®¡ç¨¿æ§½ä½ç´¢å¼•æ•°ç»„ï¼ˆå·²æŒ‰é¡ºåºï¼‰
		 * @param {Function} onComplete - æ‰€æœ‰å®¡ç¨¿å’Œå¼€ä¼šå¤„ç†å®Œæˆåçš„å›è°ƒ
		 */
		function startReviewProcessing(slots, onComplete) {
			if (!slots || slots.length === 0) {
				if (onComplete) onComplete();
				return;
			}
			
			// åˆå§‹åŒ–å¤„ç†çŠ¶æ€
			gameState._reviewProcessing = {
				pendingSlots: [...slots],        // å¾…å¤„ç†çš„å®¡ç¨¿æ§½ä½ï¼ˆæŒ‰é¡ºåºï¼‰
				acceptedByConference: {},        // æŒ‰ä¼šè®®åˆ†ç»„çš„ä¸­ç¨¿è®ºæ–‡ { confKey: { confInfo, confLocation, papers: [] } }
				pendingConferences: [],          // å¾…å¤„ç†çš„å¼€ä¼šäº‹ä»¶
				onComplete: onComplete           // å®Œæˆå›è°ƒ
			};
			
			// å¼€å§‹å¤„ç†ç¬¬ä¸€ä¸ªå®¡ç¨¿ç»“æœ
			processNextReviewInQueue();
		}

		/**
		 * å¤„ç†é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªå®¡ç¨¿ç»“æœ
		 */
		function processNextReviewInQueue() {
			const state = gameState._reviewProcessing;
			if (!state) return;
			
			if (state.pendingSlots.length === 0) {
				// æ‰€æœ‰å®¡ç¨¿ç»“æœå·²å¤„ç†ï¼Œå¼€å§‹å¤„ç†å¼€ä¼šäº‹ä»¶
				prepareConferencesInQueue();
				return;
			}
			
			const slotIdx = state.pendingSlots.shift();
			const paper = gameState.papers[slotIdx];
			
			if (paper && paper.reviewing) {
				processPaperResult(slotIdx);
			} else {
				// æ§½ä½å·²ä¸åœ¨å®¡ç¨¿çŠ¶æ€ï¼Œè·³è¿‡å¤„ç†ä¸‹ä¸€ä¸ª
				processNextReviewInQueue();
			}
		}

		/**
		 * è®°å½•ä¸­ç¨¿è®ºæ–‡çš„ä¼šè®®ä¿¡æ¯ï¼ˆåœ¨handlePaperAcceptedä¸­è°ƒç”¨ï¼‰
		 */
		function recordAcceptedPaperConference(paper, grade, acceptType) {
			const state = gameState._reviewProcessing;
			if (!state) return;
			
			const confInfo = paper.conferenceInfo || getConferenceInfo(paper.submittedMonth || gameState.month, grade, gameState.year);
			const confLocation = paper.conferenceLocation || getConferenceLocation(paper.title);
			
			// ç”Ÿæˆä¼šè®®å”¯ä¸€æ ‡è¯†
			const confKey = `${confInfo.name}_${confInfo.year}`;
			
			if (!state.acceptedByConference[confKey]) {
				state.acceptedByConference[confKey] = {
					confInfo: confInfo,
					confLocation: confLocation,
					grade: grade,
					papers: []
				};
			}
			
			state.acceptedByConference[confKey].papers.push({
				title: paper.title,
				grade: grade,
				acceptType: acceptType
			});
		}

		/**
		 * å‡†å¤‡å¼€ä¼šäº‹ä»¶é˜Ÿåˆ—
		 */
		function prepareConferencesInQueue() {
			const state = gameState._reviewProcessing;
			if (!state) return;
			
			const conferences = Object.values(state.acceptedByConference);
			
			// æ£€æŸ¥ä¸€ç®­åŒé›•æˆå°±
			conferences.forEach(conf => {
				if (conf.papers.length >= 2) {
					if (!gameState.achievementConditions) {
						gameState.achievementConditions = {};
					}
					gameState.achievementConditions.twoInOneConference = true;
				}
			});
			
			// å­˜å‚¨å¾…å¤„ç†çš„ä¼šè®®
			state.pendingConferences = conferences;
			
			// å¼€å§‹å¤„ç†å¼€ä¼šäº‹ä»¶
			processNextConferenceInQueue();
		}

		/**
		 * å¤„ç†é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªå¼€ä¼šäº‹ä»¶
		 */
		function processNextConferenceInQueue() {
			const state = gameState._reviewProcessing;
			if (!state) return;
			
			if (!state.pendingConferences || state.pendingConferences.length === 0) {
				// æ‰€æœ‰å¼€ä¼šäº‹ä»¶å·²å¤„ç†ï¼Œå®Œæˆå®¡ç¨¿æµç¨‹
				finishReviewProcessing();
				return;
			}
			
			const conf = state.pendingConferences.shift();
			// æ˜¾ç¤ºåˆå¹¶åçš„å¼€ä¼šé€‰æ‹©å¼¹çª—
			showConferenceModalMerged(conf);
		}

		/**
		 * å®Œæˆå®¡ç¨¿å¤„ç†æµç¨‹
		 */
		function finishReviewProcessing() {
			const state = gameState._reviewProcessing;
			const onComplete = state ? state.onComplete : null;
			
			// æ¸…ç†å¤„ç†çŠ¶æ€
			delete gameState._reviewProcessing;
			
			// æ‰§è¡Œå®Œæˆå›è°ƒï¼ˆè§¦å‘æœˆæœ«äº‹ä»¶ï¼‰
			if (onComplete) {
				setTimeout(onComplete, 100);
			}
		}

		/**
		 * æ˜¾ç¤ºåˆå¹¶åçš„å¼€ä¼šé€‰æ‹©å¼¹çª—ï¼ˆæ”¯æŒåŒä¸€ä¼šè®®å¤šç¯‡è®ºæ–‡ï¼‰
		 */
		function showConferenceModalMerged(confData) {
			const { confInfo, confLocation, papers, grade } = confData;
			const paperCount = papers.length;
			const isMultiple = paperCount >= 2;
			
			const favorCost = gameState.favor >= 6 ? 1 : 2;
			const proxyCost = gameState.social >= 6 ? 0 : 1;

			const favorText = gameState.favor >= 6 
				? 'ğŸ‘¨â€ğŸ« å¯¼å¸ˆæŠ¥é”€ï¼ˆå¥½æ„Ÿåº¦-1ï¼‰' 
				: 'ğŸ‘¨â€ğŸ« å¯¼å¸ˆæŠ¥é”€ï¼ˆå¥½æ„Ÿåº¦-2ï¼‰';
			const proxyText = gameState.social >= 6 
				? 'ğŸ‘¥ è¯·åŒå­¦ä»£å‚åŠ ï¼ˆå…è´¹ï¼‰' 
				: 'ğŸ‘¥ è¯·äººä»£å‚åŠ ï¼ˆé‡‘é’±-1ï¼‰';

			// æ„å»ºè®ºæ–‡åˆ—è¡¨æ˜¾ç¤º
			let papersListHtml = '';
			if (isMultiple) {
				papersListHtml = `
				<div style="margin:12px 0;padding:10px;background:linear-gradient(135deg,rgba(253,203,110,0.2),rgba(0,184,148,0.2));border-radius:8px;border:1px solid rgba(253,203,110,0.4);">
					<div style="font-size:0.85rem;font-weight:600;color:#d68910;margin-bottom:8px;">
						ğŸ¹ ä¸€ç®­åŒé›•ï¼åŒä¸€ä¼šè®®ä¸­äº†${paperCount}ç¯‡è®ºæ–‡
					</div>
					<div style="font-size:0.8rem;color:var(--text-secondary);">
						${papers.map((p, i) => `${i + 1}. ${p.title.substring(0, 25)}... (${p.grade}ç±»-${p.acceptType})`).join('<br>')}
					</div>
				</div>`;
			}

			showModal('ğŸ“ å¼€ä¼šé€‰æ‹©', 
				`<p>æ­å–œï¼${isMultiple ? `${paperCount}ç¯‡` : ''}è®ºæ–‡è¢«æ¥æ”¶ï¼éœ€è¦å‚åŠ å­¦æœ¯ä¼šè®®è¿›è¡Œå±•ç¤ºã€‚</p>
				 <div style="margin:15px 0;padding:12px;background:linear-gradient(135deg,rgba(108,92,231,0.1),rgba(162,155,254,0.1));border-radius:10px;border:1px solid rgba(108,92,231,0.2);">
					 <div style="font-size:0.9rem;font-weight:600;color:var(--primary-color);margin-bottom:5px;">ğŸ“ ä¼šè®®ä¿¡æ¯</div>
					 <div style="font-size:1rem;font-weight:700;">${confInfo.name} ${confInfo.year}</div>
					 <div style="font-size:0.85rem;color:var(--text-secondary);">${confInfo.fullName}</div>
					 <div style="font-size:0.85rem;margin-top:5px;">ğŸ“Œ ${confLocation.city}, ${confLocation.country}</div>
				 </div>
				 ${papersListHtml}
				 <p>è¯·é€‰æ‹©å‚ä¼šæ–¹å¼ï¼š</p>`, 
				[
				{ text: 'ğŸ’° è‡ªå·±å‡ºé’±ï¼ˆé‡‘é’±-4ï¼‰', class: 'btn-warning', action: () => {
					addLog('å¼€ä¼š', `è‡ªè´¹å‚åŠ  ${confInfo.name} ${confInfo.year} @ ${confLocation.city}`, `é‡‘é’±-4${isMultiple ? `ï¼Œå±•ç¤º${paperCount}ç¯‡è®ºæ–‡` : ''}`);
					closeModal();
					if (changeGold(-4)) {
						setTimeout(() => showConferenceEventModalMerged(confInfo, confLocation, papers), 200);
					} else {
						// é‡‘é’±ä¸è¶³å¯¼è‡´æ¸¸æˆç»“æŸ
						processNextConferenceInQueue();
					}
				}},
				{ text: favorText, class: 'btn-info', action: () => {
					const result = gameState.favor >= 6 
						? 'å¯¼å¸ˆçˆ½å¿«æŠ¥é”€ï¼Œå¥½æ„Ÿåº¦-1' 
						: 'å¯¼å¸ˆå¥½æ„Ÿåº¦-2';
					addLog('å¼€ä¼š', `å¯¼å¸ˆæŠ¥é”€å‚åŠ  ${confInfo.name} ${confInfo.year} @ ${confLocation.city}`, `${result}${isMultiple ? `ï¼Œå±•ç¤º${paperCount}ç¯‡è®ºæ–‡` : ''}`);
					closeModal();
					if (changeFavor(-favorCost)) {
						setTimeout(() => showConferenceEventModalMerged(confInfo, confLocation, papers), 200);
					} else {
						// å¥½æ„Ÿåº¦ä¸è¶³å¯¼è‡´æ¸¸æˆç»“æŸ
						processNextConferenceInQueue();
					}
				}},
				{ text: proxyText, class: 'btn-primary', action: () => {
					if (gameState.social >= 6) {
						addLog('å¼€ä¼š', `è¯·åŒå­¦ä»£ä¸ºå‚åŠ  ${confInfo.name} ${confInfo.year}`, 'åŒå­¦ä¹‰æ°”å¸®å¿™ï¼Œå…è´¹');
					} else {
						addLog('å¼€ä¼š', `è¯·äººä»£ä¸ºå‚åŠ  ${confInfo.name} ${confInfo.year}`, 'é‡‘é’±-1');
						changeGold(-proxyCost);
					}
					closeModal();
					// ä»£å‚åŠ ä¸è§¦å‘å¼€ä¼šäº‹ä»¶ï¼Œç›´æ¥å¤„ç†ä¸‹ä¸€ä¸ª
					processNextConferenceInQueue();
				}}
			]);
		}

		/**
		 * æ˜¾ç¤ºåˆå¹¶åçš„å¼€ä¼šäº‹ä»¶å¼¹çª—
		 */
		function showConferenceEventModalMerged(confInfo, confLocation, papers) {
			const isMultiple = papers.length >= 2;
			const confString = `${confInfo.name} ${confInfo.year} @ ${confLocation.city}, ${confLocation.country}`;
			
			// åŸæœ‰çš„å¼€ä¼šé€‰é¡¹é€»è¾‘ä¿æŒä¸å˜
			let options = [
				{ text: 'ğŸ–ï¸ é¡ºä¾¿æ—…æ¸¸', fn: () => { 
					gameState.tourCount++;
					addLog('å¼€ä¼šäº‹ä»¶', `åœ¨${confLocation.city}é¡ºä¾¿æ—…æ¸¸`, 'SANå€¼+6');
					return changeSan(6);
				}},
				{ text: 'â˜• èŒ¶æ­‡+æ™šå®´', fn: () => { 
					gameState.teaBreakCount++;
					addLog('å¼€ä¼šäº‹ä»¶', 'èŒ¶æ­‡+æ™šå®´', 'SANå€¼+1ï¼Œç¤¾äº¤èƒ½åŠ›+1');
					return changeStats({ san: 1, social: 1 });
				}},
				{ text: 'ğŸ”¬ åŒè¡Œäº¤æµ', fn: () => { 
					gameState.buffs.temporary.push({ type: 'exp_times', name: 'ä¸‹æ¬¡åšå®éªŒå¤šåš3æ¬¡', value: 3, permanent: false }); 
					addLog('å¼€ä¼šäº‹ä»¶', 'åŒè¡Œäº¤æµ', 'ä¸´æ—¶buff-ä¸‹æ¬¡åšå®éªŒå¤šåš3æ¬¡');
					updateBuffs();
					return true;
				}},
				{ text: 'ğŸ’¡ å¹¿æ³›äº¤æµ', fn: () => { 
					gameState.buffs.temporary.push({ type: 'idea_times', name: 'ä¸‹æ¬¡æƒ³ideaå¤šæƒ³3æ¬¡', value: 3, permanent: false }); 
					addLog('å¼€ä¼šäº‹ä»¶', 'å¹¿æ³›äº¤æµ', 'ä¸´æ—¶buff-ä¸‹æ¬¡æƒ³ideaå¤šæƒ³3æ¬¡');
					updateBuffs();
					return true;
				}},
				{ text: 'ğŸŒŸ æ‰¾å¤§ç‰›äº¤æµ', fn: () => { 
					gameState.buffs.temporary.push({ type: 'idea_bonus', name: 'ä¸‹æ¬¡æƒ³ideaåˆ†æ•°Ã—1.25', value: 1.25, multiply: true, permanent: false }); 
					gameState.metBigBull = true;
					addLog('å¼€ä¼šäº‹ä»¶', 'æ‰¾å¤§ç‰›äº¤æµ', 'ä¸´æ—¶buff-ä¸‹æ¬¡æƒ³ideaåˆ†æ•°Ã—1.25');
					updateBuffs();
					return true;
				}},
				{ text: 'ğŸ¢ æ‰¾ä¼ä¸šäº¤æµ', fn: () => { 
					gameState.enterpriseCount = (gameState.enterpriseCount || 0) + 1;
					gameState.buffs.temporary.push({ type: 'exp_bonus', name: 'ä¸‹æ¬¡åšå®éªŒåˆ†æ•°Ã—1.25', value: 1.25, multiply: true, permanent: false }); 
					addLog('å¼€ä¼šäº‹ä»¶', 'æ‰¾ä¼ä¸šäº¤æµ', `ä¸´æ—¶buff-ä¸‹æ¬¡åšå®éªŒåˆ†æ•°Ã—1.25ï¼ˆç¬¬${gameState.enterpriseCount}æ¬¡ï¼‰`);
					updateBuffs();
					
					if (gameState.enterpriseCount === 3 && !gameState.ailabInternship) {
						setTimeout(() => showAILabInternshipModal(), 300);
					}
					return true;
				}},
				{ text: 'ğŸ¤ æ‰¾åŒå­¦åˆä½œ', fn: () => { 
					gameState.buffs.temporary.push({ type: 'exp_bonus', name: 'ä¸‹æ¬¡åšå®éªŒåˆ†æ•°+5', value: 5, permanent: false }); 
					addLog('å¼€ä¼šäº‹ä»¶', 'æ‰¾åŒå­¦åˆä½œ', 'ä¸´æ—¶buff-ä¸‹æ¬¡åšå®éªŒåˆ†æ•°+5');
					updateBuffs();
					return true;
				}}
			];

			// ç¤¾äº¤>=6è§£é”æ›´å¤šé€‰é¡¹
			if (gameState.social >= 6) {
				options.push(
					{ text: 'ğŸ“ æ‰¾å¤§ç‰›åˆä½œ', fn: () => { 
						gameState.buffs.temporary.push({ type: 'write_bonus', name: 'ä¸‹æ¬¡å†™è®ºæ–‡åˆ†æ•°+8', value: 8, permanent: false }); 
						gameState.metBigBull = true;
						addLog('å¼€ä¼šäº‹ä»¶', 'æ‰¾å¤§ç‰›åˆä½œ', 'ä¸´æ—¶buff-ä¸‹æ¬¡å†™è®ºæ–‡åˆ†æ•°+8ï¼Œç¤¾äº¤èƒ½åŠ›+1');
						updateBuffs();
						return changeSocial(1);
					}},
					{ text: 'ğŸ’• å’Œæ´»æ³¼çš„å¼‚æ€§å­¦è€…äº¤æµ', fn: () => { 
						gameState.metBeautiful = true;
						gameState.beautifulCount++;
						addLog('å¼€ä¼šäº‹ä»¶', 'å’Œæ´»æ³¼çš„å¼‚æ€§å­¦è€…äº¤æµ', 'SANå€¼+5ï¼Œç¤¾äº¤èƒ½åŠ›+1');
						return changeStats({ san: 5, social: 1 });
					}},
					{ text: 'ğŸ§  å’Œèªæ…§çš„å¼‚æ€§å­¦è€…äº¤æµ', fn: () => { 
						gameState.buffs.temporary.push({ type: 'idea_times', name: 'ä¸‹æ¬¡æƒ³ideaå¤šæƒ³2æ¬¡', value: 2, permanent: false });
						gameState.metSmart = true;
						gameState.smartCount++;
						addLog('å¼€ä¼šäº‹ä»¶', 'å’Œèªæ…§çš„å¼‚æ€§å­¦è€…äº¤æµ', 'SANå€¼+1ï¼Œç¤¾äº¤èƒ½åŠ›+1ï¼Œä¸´æ—¶buff-ä¸‹æ¬¡æƒ³ideaå¤šæƒ³2æ¬¡');
						updateBuffs();
						return changeStats({ san: 1, social: 1 });
					}}
				);
			}

			// ç»§ç»­äº¤æµé€‰é¡¹ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼‰
			if (gameState.metBigBull && !gameState.bigBullCooperation) {
				options.push({ text: 'ğŸŒŸ å’Œä¸Šæ¬¡é‚£ä¸ªå¤§ç‰›æ·±å…¥åˆä½œ', fn: () => {
					gameState.buffs.temporary.push({ type: 'write_bonus', name: 'ä¸‹æ¬¡å†™è®ºæ–‡åˆ†æ•°+8', value: 8, permanent: false });
					gameState.bigBullDeepCount++;
					addLog('å¼€ä¼šäº‹ä»¶', 'å’Œä¸Šæ¬¡é‚£ä¸ªå¤§ç‰›æ·±å…¥åˆä½œ', 'ä¸´æ—¶buff-ä¸‹æ¬¡å†™è®ºæ–‡åˆ†æ•°+8');
					updateBuffs();
					if (gameState.research >= 12 && gameState.bigBullDeepCount >= 2) {
						setTimeout(showBigBullCoopModal, 300);
					}
					return true;
				}});
			}

			if (gameState.metBeautiful && !gameState.hasLover) {
				options.push({ text: 'ğŸ’• å’Œä¸Šæ¬¡é‚£ä¸ªæ´»æ³¼çš„å¼‚æ€§å­¦è€…äº¤æµ', fn: () => {
					gameState.beautifulCount++;
					addLog('å¼€ä¼šäº‹ä»¶', 'å’Œä¸Šæ¬¡é‚£ä¸ªæ´»æ³¼çš„å¼‚æ€§å­¦è€…äº¤æµ', 'SANå€¼+8ï¼ŒSANå€¼ä¸Šé™+3');
					gameState.sanMax += 3;
					changeSan(8);
					if (gameState.social >= 12 && gameState.beautifulCount >= 2) {
						setTimeout(() => showLoverModal('beautiful'), 300);
					}
					return true;
				}});
			}

			if (gameState.metSmart && !gameState.hasLover) {
				options.push({ text: 'ğŸ§  å’Œä¸Šæ¬¡é‚£ä¸ªèªæ…§çš„å¼‚æ€§å­¦è€…äº¤æµ', fn: () => {
					gameState.smartCount++;
					addLog('å¼€ä¼šäº‹ä»¶', 'å’Œä¸Šæ¬¡é‚£ä¸ªèªæ…§çš„å¼‚æ€§å­¦è€…äº¤æµ', 'SANå€¼+1ï¼Œç§‘ç ”èƒ½åŠ›+1');
					changeSan(1);
					changeResearch(1);
					if (gameState.social >= 12 && gameState.smartCount >= 2) {
						setTimeout(() => showLoverModal('smart'), 300);
					}
					return true;
				}});
			}

			const selected = shuffle(options).slice(0, 3);
			
			// æ˜¾ç¤ºå¼¹çª—ï¼Œé€‰æ‹©åå¤„ç†ä¸‹ä¸€ä¸ªå¼€ä¼šäº‹ä»¶
			showModal(`ğŸ‰ ${confString}`, 
				`<div style="margin-bottom:15px;">
					<p>ä½ æ¥åˆ°äº†<strong>${confLocation.city}</strong>å‚åŠ <strong>${confInfo.name}</strong>${isMultiple ? `ï¼Œå±•ç¤ºäº†${papers.length}ç¯‡è®ºæ–‡` : ''}ï¼Œåœ¨å­¦æœ¯ä¼šè®®ä¸Šï¼Œä½ å¯ä»¥é€‰æ‹©ï¼š</p>
				</div>`, 
				selected.map(opt => ({
					text: opt.text, class: 'btn-primary', action: () => {
						closeModal();
						opt.fn();
						// å¤„ç†ä¸‹ä¸€ä¸ªå¼€ä¼šäº‹ä»¶
						setTimeout(() => processNextConferenceInQueue(), 100);
					}
				}))
			);
		}		
		
		// ==================== è®ºæ–‡æŠ•ç¨¿ä¸å®¡ç¨¿ ====================
		function submitPaper(slot, grade) {
			const paper = gameState.papers[slot];
			if (!paper || paper.reviewing) return;
			if (paper.ideaScore <= 0 || paper.expScore <= 0 || paper.writeScore <= 0) return;

			const confInfo = getConferenceInfo(gameState.month, grade, gameState.year);
			const location = getConferenceLocation(paper.title);
			
			paper.reviewing = true;
			paper.reviewMonths = 4;
			paper.submittedGrade = grade;
			paper.submittedScore = paper.ideaScore + paper.expScore + paper.writeScore;
			paper.submittedMonth = gameState.month;
			paper.conferenceInfo = confInfo;
			paper.conferenceLocation = location;
			
			// âœ… æ–°å¢ï¼šä¿å­˜æŠ•ç¨¿æ—¶çš„åˆ†æ•°å¿«ç…§
			paper.submittedIdeaScore = paper.ideaScore;
			paper.submittedExpScore = paper.expScore;
			paper.submittedWriteScore = paper.writeScore;

            const currentReviews = gameState.papers.filter(p => p?.reviewing).length;
            gameState.maxConcurrentReviews = Math.max(gameState.maxConcurrentReviews || 0, currentReviews);

            // â˜…â˜…â˜… ä¿®æ”¹æ—¥å¿—ï¼Œæ˜¾ç¤ºä¼šè®®åç§° â˜…â˜…â˜…
            addLog('æŠ•ç¨¿', `å°†"${paper.title.substring(0, 15)}..."æŠ•è‡³${confInfo.name} ${confInfo.year}ï¼ˆ${grade}ç±»ï¼‰`, `æ€»åˆ†${paper.submittedScore}ï¼Œè¿›å…¥4ä¸ªæœˆå®¡ç¨¿æœŸ`);
            renderPaperSlots();
        }

        function abandonPaper(slot) {
            const paper = gameState.papers[slot];
            if (!paper || paper.reviewing) return;
            
            showModal('ç¡®è®¤æ”¾å¼ƒ', '<p>ç¡®å®šè¦æ”¾å¼ƒè¿™ç¯‡è®ºæ–‡å—ï¼Ÿæ‰€æœ‰è¿›åº¦å°†ä¸¢å¤±ï¼</p>', [
                { text: 'å–æ¶ˆ', class: 'btn-info', action: closeModal },
                { text: 'ç¡®å®šæ”¾å¼ƒ', class: 'btn-danger', action: () => {
                    addLog('æ”¾å¼ƒè®ºæ–‡', `æ”¾å¼ƒäº†"${paper.title.substring(0, 15)}..."`, 'è®ºæ–‡æ§½å·²æ¸…ç©º');
                    gameState.papers[slot] = null;
                    closeModal();
                    renderPaperSlots();
                }}
            ]);
        }
		
		function generateReviewer() {
			// â˜…â˜…â˜… ç¤¾äº¤è¾¾äººè§‰é†’åä½¿ç”¨å›ºå®šçš„æ¦‚ç‡åˆ†å¸ƒ â˜…â˜…â˜…
			if (gameState.socialAwakened && gameState.reviewerDistribution) {
				const dist = gameState.reviewerDistribution;
				
				const r = Math.random();
				let cumulative = 0;
				
				cumulative += dist.normal;
				if (r < cumulative) return { type: 'normal', name: 'æ™®é€šå®¡ç¨¿äºº' };
				
				cumulative += dist.kind;
				if (r < cumulative) return { type: 'kind', name: 'å¿ƒè½¯å®¡ç¨¿äºº' };
				
				cumulative += dist.expert;
				if (r < cumulative) return { type: 'expert', name: 'èµ„æ·±å¤§ç‰›' };
				
				cumulative += dist.hostile;
				if (r < cumulative) return { type: 'hostile', name: 'æ¶æ„å°åŒè¡Œ' };
				
				cumulative += dist.gpt;
				if (r < cumulative) return { type: 'gpt', name: 'GPTå®¡ç¨¿äºº' };
				
				return { type: 'questions', name: '39ä¸ªé—®é¢˜å®¡ç¨¿äºº' };
			}
			
			// é»˜è®¤åˆ†å¸ƒ
			const r = Math.random();
			if (r < 0.40) return { type: 'normal', name: 'æ™®é€šå®¡ç¨¿äºº' };
			if (r < 0.50) return { type: 'kind', name: 'å¿ƒè½¯å®¡ç¨¿äºº' };
			if (r < 0.60) return { type: 'expert', name: 'èµ„æ·±å¤§ç‰›' };
			if (r < 0.70) return { type: 'hostile', name: 'æ¶æ„å°åŒè¡Œ' };
			if (r < 0.90) return { type: 'gpt', name: 'GPTå®¡ç¨¿äºº' };
			return { type: 'questions', name: '39ä¸ªé—®é¢˜å®¡ç¨¿äºº' };
		}


		function handlePaperAccepted(paper, grade, acceptType, slot, extraInfo) {
			// â˜…â˜…â˜… æ–°å¢ï¼šæ£€æŸ¥å¹¶åº”ç”¨å¼•ç”¨å€å¢buff â˜…â˜…â˜…
			let citationBuff = 1;
			const citationMultiplyBuff = gameState.buffs.temporary.find(b => b.type === 'citation_multiply');
			if (citationMultiplyBuff) {
				citationBuff = citationMultiplyBuff.value;
				gameState.buffs.temporary = gameState.buffs.temporary.filter(b => b.type !== 'citation_multiply');
				addLog('Buffç”Ÿæ•ˆ', 'åŒé—¨åˆä½œ', `æœ¬ç¯‡è®ºæ–‡å¼•ç”¨é€Ÿåº¦+${(citationBuff-1)*100}%ï¼ˆä¸æ¨å¹¿åŠ æˆå åŠ ï¼‰`);
			}
			
			const scoreMap = { 'A': 4, 'B': 2, 'C': 1 };
			const sanGain = { 
				'A': { 'Poster': 6, 'Oral': 8, 'Best Paper': 12 }, 
				'B': { 'Poster': 3, 'Oral': 4, 'Best Paper': 5 }, 
				'C': { 'Poster': 2, 'Oral': 2, 'Best Paper': 3 } 
			};
			const favorGain = { 
				'A': { 'Poster': 2, 'Oral': 3, 'Best Paper': 4 }, 
				'B': { 'Poster': 1, 'Oral': 1, 'Best Paper': 2 }, 
				'C': { 'Poster': 0, 'Oral': 0, 'Best Paper': 1 } 
			};

			const paperRankMap = {
				'A-Best Paper': 9,
				'A-Oral': 8,
				'A-Poster': 7,
				'B-Best Paper': 6,
				'B-Oral': 5,
				'B-Poster': 4,
				'C-Best Paper': 3,
				'C-Oral': 2,
				'C-Poster': 1
			};
			
			const currentRank = paperRankMap[`${grade}-${acceptType}`];
			
			const higherOrEqualCount = gameState.publishedPapers.filter(p => {
				const pRank = paperRankMap[`${p.grade}-${p.acceptType}`];
				return pRank >= currentRank;
			}).length;
			
			const baseSan = sanGain[grade][acceptType];
			const baseFavor = favorGain[grade][acceptType];
			
			const actualSanGain = Math.max(1, baseSan - higherOrEqualCount);
			const favorReduction = Math.floor(higherOrEqualCount / 2);
			const actualFavorGain = baseFavor > 0 ? Math.max(0, baseFavor - favorReduction) : 0;
			
			const hasDecay = actualSanGain < baseSan || actualFavorGain < baseFavor;
			
			gameState.san = Math.min(gameState.sanMax, gameState.san + actualSanGain);
			gameState.favor = Math.min(20, gameState.favor + actualFavorGain);
			gameState.totalScore += scoreMap[grade];

			if (grade === 'A') gameState.paperA++;
			else if (grade === 'B') gameState.paperB++;
			else gameState.paperC++;

			let bonusResearch = 0;
			if (!gameState.firstPaperAccepted) {
				gameState.firstPaperAccepted = true;
				bonusResearch++;
				addLog('é¦–æ¬¡å‘è¡¨è®ºæ–‡', 'ç§‘ç ”èƒ½åŠ›+1', 'é¦–æ¬¡å‘è¡¨è®ºæ–‡å¥–åŠ±');
			}
			if (grade === 'A' && !gameState.firstAPaperAccepted) {
				gameState.firstAPaperAccepted = true;
				bonusResearch++;
				addLog('é¦–æ¬¡å‘è¡¨Aç±»è®ºæ–‡', 'ç§‘ç ”èƒ½åŠ›+1', 'é¦–æ¬¡å‘è¡¨Aç±»è®ºæ–‡å¥–åŠ±');
			}
			if (acceptType === 'Best Paper' && !gameState.firstBestPaperAccepted) {
				gameState.firstBestPaperAccepted = true;
				bonusResearch++;
				addLog('é¦–æ¬¡å‘è¡¨Best Paper', 'ç§‘ç ”èƒ½åŠ›+1', 'é¦–æ¬¡å‘è¡¨Best Paperå¥–åŠ±');
			}
			if (bonusResearch > 0) {
				changeResearch(bonusResearch);
			}

			gameState.consecutiveAccepts = (gameState.consecutiveAccepts || 0) + 1;
			
			if (gameState.consecutiveAccepts >= 3) {
				gameState.buffs.temporary.push({ 
					type: 'slack_debuff', 
					name: 'æ¾æ‡ˆï¼šä¸‹æœˆæ‰€æœ‰æ“ä½œæ€»åˆ†Ã·2', 
					value: 0.5, 
					multiply: true, 
					permanent: false,
					expiresOnRest: true
				});
				addLog('âš ï¸ å¿—å¾—æ„æ»¡', 'è¿ç»­ä¸­ç¨¿3ç¯‡', 'è·å¾—æ¾æ‡ˆdebuffï¼Œä¸‹æœˆæƒ³idea/åšå®éªŒ/å†™è®ºæ–‡æ€»åˆ†Ã·2ï¼ˆä¼‘æ¯ä¸€ä¸ªæœˆå¯æ¶ˆé™¤ï¼‰');
				gameState.consecutiveAccepts = 0;
			}

			const finalScore = paper.submittedScore || (paper.ideaScore + paper.expScore + paper.writeScore);

			// â˜…â˜…â˜… è®°å½•å½•å–æ•°æ® â˜…â˜…â˜…
			const resultStr = acceptType.toLowerCase().replace(/\s+/g, '_');
			recordSubmission(
				extraInfo?.submittedMonth || gameState.month,
				grade,
				paper.submittedScore,
				resultStr,
				gameState.isReversed
			);
			
			gameState.publishedPapers.push({
				title: paper.title,
				grade,
				acceptType,
				score: finalScore,
				citations: 0,
				monthsSincePublish: 0,
				promotions: { arxiv: false, github: false, xiaohongshu: false, quantumbit: false },
				citationMultiplier: citationBuff,
				pendingCitationFraction: 0,
				conferenceInfo: paper.conferenceInfo ? {
					...paper.conferenceInfo,
					month: paper.submittedMonth || gameState.month
				} : {
					name: grade + 'ç±»ä¼šè®®',
					year: getRealYear(gameState.year, gameState.month),
					month: paper.submittedMonth || gameState.month
				},
				conferenceLocation: paper.conferenceLocation
			});

			if (gameState.publishedPapers.length === 1 && !gameState.availableRandomEvents.includes(14)) {
				gameState.availableRandomEvents.push(14);
				addLog('ç³»ç»Ÿ', 'æ–°äº‹ä»¶è§£é”', 'æŒ‡å¯¼å¸ˆå¼Ÿå¸ˆå¦¹äº‹ä»¶å·²è§£é”');
			}

			gameState.paperTypeCollection = gameState.paperTypeCollection || new Set();
			gameState.paperTypeCollection.add(`${grade}-${acceptType}`);

			// â˜…â˜…â˜… ä¿®æ”¹æ—¥å¿—ï¼Œæ˜¾ç¤ºä¼šè®®åç§° â˜…â˜…â˜…
			const confInfo = paper.conferenceInfo || getConferenceInfo(gameState.month, grade, gameState.year);
			let result = `SAN+${actualSanGain}ï¼Œå¥½æ„Ÿ+${actualFavorGain}ï¼Œç§‘ç ”åˆ†+${scoreMap[grade]}`;
			if (bonusResearch > 0) result += `ï¼Œç§‘ç ”èƒ½åŠ›+${bonusResearch}`;
			
			if (hasDecay) {
				result += `ï¼ˆå·²å‘${higherOrEqualCount}ç¯‡åŒçº§æˆ–æ›´é«˜ï¼Œè¾¹é™…æ•ˆç›Šé€’å‡ï¼‰`;
			}
			
			if (gameState.consecutiveAccepts > 0) {
				result += `ï¼ˆè¿ç»­ä¸­ç¨¿${gameState.consecutiveAccepts}/3ï¼‰`;
			}
			
			addLog('ğŸ‰ è®ºæ–‡ä¸­ç¨¿', `${confInfo.name} ${confInfo.year} æ¥æ”¶ä¸º${acceptType}`, result);

			// â˜…â˜…â˜… å…³é”®ä¿®æ”¹ï¼šæ ¹æ®æ˜¯å¦åœ¨é˜Ÿåˆ—æ¨¡å¼ä¸‹å†³å®šåç»­å¤„ç† â˜…â˜…â˜…
			if (gameState._reviewProcessing) {
				// åœ¨é˜Ÿåˆ—æ¨¡å¼ä¸‹ï¼Œè®°å½•ä¼šè®®ä¿¡æ¯ï¼Œç¨åç»Ÿä¸€å¤„ç†å¼€ä¼šäº‹ä»¶
				recordAcceptedPaperConference(paper, grade, acceptType);
				
				// æ¸…ç©ºè®ºæ–‡æ§½
				gameState.papers[slot] = null;
				
				// ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªå®¡ç¨¿ç»“æœ
				setTimeout(() => processNextReviewInQueue(), 100);
				
				updateBuffs();
				renderPaperSlots();
				updateAllUI();
				return;  // ä¸è§¦å‘å¼€ä¼šå¼¹çª—ï¼Œç¨åç»Ÿä¸€å¤„ç†
			}
			
			// â˜…â˜…â˜… éé˜Ÿåˆ—æ¨¡å¼ï¼ˆå…¼å®¹æ—§é€»è¾‘ï¼Œå¦‚è¯»æ¡£åè§¦å‘ï¼‰â˜…â˜…â˜…
			gameState.pendingConferenceInfo = {
				info: paper.conferenceInfo,
				location: paper.conferenceLocation,
				grade: grade
			};

			gameState.papers[slot] = null;

			// æ£€æŸ¥è½¬åšæ¡ä»¶
			const canPhD = gameState.degree === 'master' && (
				(gameState.year === 2 && gameState.month === 12 && gameState.totalScore >= 2) ||
				(gameState.year === 3 && gameState.month === 12 && gameState.totalScore >= 3)
			);

			if (canPhD) {
				gameState.pendingConference = grade;
				setTimeout(() => showPhDOptionModal(), 300);
			} else {
				setTimeout(() => showConferenceModal(grade), 300);
			}
			
			updateBuffs();
		}
		
        // ==================== å¼€ä¼šç³»ç»Ÿ ====================
        function showConferenceModal(grade) {
            const favorCost = gameState.favor >= 6 ? 1 : 2;
            const proxyCost = gameState.social >= 6 ? 0 : 1;

            const favorText = gameState.favor >= 6 
                ? 'ğŸ‘¨â€ğŸ« å¯¼å¸ˆæŠ¥é”€ï¼ˆå¥½æ„Ÿåº¦-1ï¼‰' 
                : 'ğŸ‘¨â€ğŸ« å¯¼å¸ˆæŠ¥é”€ï¼ˆå¥½æ„Ÿåº¦-2ï¼‰';
            const proxyText = gameState.social >= 6 
                ? 'ğŸ‘¥ è¯·åŒå­¦ä»£å‚åŠ ï¼ˆå…è´¹ï¼‰' 
                : 'ğŸ‘¥ è¯·äººä»£å‚åŠ ï¼ˆé‡‘é’±-1ï¼‰';

            // â˜…â˜…â˜… è·å–ä¼šè®®ä¿¡æ¯ â˜…â˜…â˜…
            let confInfo, confLocation;
            if (gameState.pendingConferenceInfo) {
                confInfo = gameState.pendingConferenceInfo.info;
                confLocation = gameState.pendingConferenceInfo.location;
            } else {
                confInfo = getConferenceInfo(gameState.month, grade, gameState.year);
                confLocation = CONFERENCE_LOCATIONS[Math.floor(Math.random() * CONFERENCE_LOCATIONS.length)];
            }
            
            const confString = formatConferenceString(confInfo, confLocation);

            showModal('ğŸ“ å¼€ä¼šé€‰æ‹©', 
                `<p>æ­å–œè®ºæ–‡è¢«æ¥æ”¶ï¼éœ€è¦å‚åŠ å­¦æœ¯ä¼šè®®è¿›è¡Œå±•ç¤ºã€‚</p>
                 <div style="margin:15px 0;padding:12px;background:linear-gradient(135deg,rgba(108,92,231,0.1),rgba(162,155,254,0.1));border-radius:10px;border:1px solid rgba(108,92,231,0.2);">
                     <div style="font-size:0.9rem;font-weight:600;color:var(--primary-color);margin-bottom:5px;">ğŸ“ ä¼šè®®ä¿¡æ¯</div>
                     <div style="font-size:1rem;font-weight:700;">${confInfo.name} ${confInfo.year}</div>
                     <div style="font-size:0.85rem;color:var(--text-secondary);">${confInfo.fullName}</div>
                     <div style="font-size:0.85rem;margin-top:5px;">ğŸ“Œ ${confLocation.city}, ${confLocation.country}</div>
                 </div>
                 <p>è¯·é€‰æ‹©å‚ä¼šæ–¹å¼ï¼š</p>`, 
                [
                { text: 'ğŸ’° è‡ªå·±å‡ºé’±ï¼ˆé‡‘é’±-4ï¼‰', class: 'btn-warning', action: () => {
                    addLog('å¼€ä¼š', `è‡ªè´¹å‚åŠ  ${confInfo.name} ${confInfo.year} @ ${confLocation.city}`, 'é‡‘é’±-4');
                    closeModal();
                    if (changeGold(-4)) {
                        setTimeout(() => showConferenceEventModal(confInfo, confLocation), 200);
                    }
                }},
                { text: favorText, class: 'btn-info', action: () => {
                    const result = gameState.favor >= 6 
                        ? 'å¯¼å¸ˆçˆ½å¿«æŠ¥é”€ï¼Œå¥½æ„Ÿåº¦-1' 
                        : 'å¯¼å¸ˆå¥½æ„Ÿåº¦-2';
                    addLog('å¼€ä¼š', `å¯¼å¸ˆæŠ¥é”€å‚åŠ  ${confInfo.name} ${confInfo.year} @ ${confLocation.city}`, result);
                    closeModal();
                    if (changeFavor(-favorCost)) {
                        setTimeout(() => showConferenceEventModal(confInfo, confLocation), 200);
                    }
                }},
                { text: proxyText, class: 'btn-primary', action: () => {
                    if (gameState.social >= 6) {
                        addLog('å¼€ä¼š', `è¯·åŒå­¦ä»£ä¸ºå‚åŠ  ${confInfo.name} ${confInfo.year}`, 'åŒå­¦ä¹‰æ°”å¸®å¿™ï¼Œå…è´¹');
                        closeModal();
                        // æ¸…é™¤ä¼šè®®ä¿¡æ¯
                        gameState.pendingConferenceInfo = null;
                    } else {
                        addLog('å¼€ä¼š', `è¯·äººä»£ä¸ºå‚åŠ  ${confInfo.name} ${confInfo.year}`, 'é‡‘é’±-1');
                        closeModal();
                        changeGold(-proxyCost);
                        // æ¸…é™¤ä¼šè®®ä¿¡æ¯
                        gameState.pendingConferenceInfo = null;
                    }
                }}
            ]);
        }

        function showConferenceEventModal(confInfo, confLocation) {
            // æ¸…é™¤ä¼šè®®ä¿¡æ¯
            gameState.pendingConferenceInfo = null;
            
            // å¦‚æœæ²¡æœ‰ä¼ å…¥ä¼šè®®ä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤å€¼
            if (!confInfo) {
                confInfo = { name: 'å­¦æœ¯ä¼šè®®', year: getRealYear(gameState.year, gameState.month), fullName: 'Academic Conference' };
            }
            if (!confLocation) {
                confLocation = CONFERENCE_LOCATIONS[Math.floor(Math.random() * CONFERENCE_LOCATIONS.length)];
            }
            
            const confString = `${confInfo.name} ${confInfo.year} @ ${confLocation.city}, ${confLocation.country}`;
            
            let options = [
                { text: 'ğŸ–ï¸ é¡ºä¾¿æ—…æ¸¸', fn: () => { 
                    gameState.tourCount++;
                    addLog('å¼€ä¼šäº‹ä»¶', `åœ¨${confLocation.city}é¡ºä¾¿æ—…æ¸¸`, 'SANå€¼+6');
                    return changeSan(6);
                }},
                { text: 'â˜• èŒ¶æ­‡+æ™šå®´', fn: () => { 
                    gameState.teaBreakCount++;
                    addLog('å¼€ä¼šäº‹ä»¶', 'èŒ¶æ­‡+æ™šå®´', 'SANå€¼+1ï¼Œç¤¾äº¤èƒ½åŠ›+1');
                    return changeStats({ san: 1, social: 1 });
                }},
                { text: 'ğŸ”¬ åŒè¡Œäº¤æµ', fn: () => { 
                    gameState.buffs.temporary.push({ type: 'exp_times', name: 'ä¸‹æ¬¡åšå®éªŒå¤šåš3æ¬¡', value: 3, permanent: false }); 
                    addLog('å¼€ä¼šäº‹ä»¶', 'åŒè¡Œäº¤æµ', 'ä¸´æ—¶buff-ä¸‹æ¬¡åšå®éªŒå¤šåš3æ¬¡');
                    updateBuffs();
                    return true;
                }},
                { text: 'ğŸ’¡ å¹¿æ³›äº¤æµ', fn: () => { 
                    gameState.buffs.temporary.push({ type: 'idea_times', name: 'ä¸‹æ¬¡æƒ³ideaå¤šæƒ³3æ¬¡', value: 3, permanent: false }); 
                    addLog('å¼€ä¼šäº‹ä»¶', 'å¹¿æ³›äº¤æµ', 'ä¸´æ—¶buff-ä¸‹æ¬¡æƒ³ideaå¤šæƒ³3æ¬¡');
                    updateBuffs();
                    return true;
                }},
                { text: 'ğŸŒŸ æ‰¾å¤§ç‰›äº¤æµ', fn: () => { 
                    gameState.buffs.temporary.push({ type: 'idea_bonus', name: 'ä¸‹æ¬¡æƒ³ideaåˆ†æ•°Ã—1.25', value: 1.25, multiply: true, permanent: false }); 
                    gameState.metBigBull = true;
                    addLog('å¼€ä¼šäº‹ä»¶', 'æ‰¾å¤§ç‰›äº¤æµ', 'ä¸´æ—¶buff-ä¸‹æ¬¡æƒ³ideaåˆ†æ•°Ã—1.25');
                    updateBuffs();
                    return true;
                }},
                { text: 'ğŸ¢ æ‰¾ä¼ä¸šäº¤æµ', fn: () => { 
                    gameState.enterpriseCount = (gameState.enterpriseCount || 0) + 1;
                    gameState.buffs.temporary.push({ type: 'exp_bonus', name: 'ä¸‹æ¬¡åšå®éªŒåˆ†æ•°Ã—1.25', value: 1.25, multiply: true, permanent: false }); 
                    addLog('å¼€ä¼šäº‹ä»¶', 'æ‰¾ä¼ä¸šäº¤æµ', `ä¸´æ—¶buff-ä¸‹æ¬¡åšå®éªŒåˆ†æ•°Ã—1.25ï¼ˆç¬¬${gameState.enterpriseCount}æ¬¡ï¼‰`);
                    updateBuffs();
                    
                    if (gameState.enterpriseCount === 3 && !gameState.ailabInternship) {
                        setTimeout(() => showAILabInternshipModal(), 300);
                    }
                    return true;
                }},
                { text: 'ğŸ¤ æ‰¾åŒå­¦åˆä½œ', fn: () => { 
                    gameState.buffs.temporary.push({ type: 'exp_bonus', name: 'ä¸‹æ¬¡åšå®éªŒåˆ†æ•°+5', value: 5, permanent: false }); 
                    addLog('å¼€ä¼šäº‹ä»¶', 'æ‰¾åŒå­¦åˆä½œ', 'ä¸´æ—¶buff-ä¸‹æ¬¡åšå®éªŒåˆ†æ•°+5');
                    updateBuffs();
                    return true;
                }}
            ];

            if (gameState.social >= 6) {
                options.push(
                    { text: 'ğŸ“ æ‰¾å¤§ç‰›åˆä½œ', fn: () => { 
                        gameState.buffs.temporary.push({ type: 'write_bonus', name: 'ä¸‹æ¬¡å†™è®ºæ–‡åˆ†æ•°+8', value: 8, permanent: false }); 
                        gameState.metBigBull = true;
                        addLog('å¼€ä¼šäº‹ä»¶', 'æ‰¾å¤§ç‰›åˆä½œ', 'ä¸´æ—¶buff-ä¸‹æ¬¡å†™è®ºæ–‡åˆ†æ•°+8ï¼Œç¤¾äº¤èƒ½åŠ›+1');
                        updateBuffs();
                        return changeSocial(1);
                    }},
                    { text: 'ğŸ’• å’Œæ´»æ³¼çš„å¼‚æ€§å­¦è€…äº¤æµ', fn: () => { 
                        gameState.metBeautiful = true;
                        gameState.beautifulCount++;
                        addLog('å¼€ä¼šäº‹ä»¶', 'å’Œæ´»æ³¼çš„å¼‚æ€§å­¦è€…äº¤æµ', 'SANå€¼+5ï¼Œç¤¾äº¤èƒ½åŠ›+1');
                        return changeStats({ san: 5, social: 1 });
                    }},
                    { text: 'ğŸ§  å’Œèªæ…§çš„å¼‚æ€§å­¦è€…äº¤æµ', fn: () => { 
                        gameState.buffs.temporary.push({ type: 'idea_times', name: 'ä¸‹æ¬¡æƒ³ideaå¤šæƒ³2æ¬¡', value: 2, permanent: false });
                        gameState.metSmart = true;
                        gameState.smartCount++;
                        addLog('å¼€ä¼šäº‹ä»¶', 'å’Œèªæ…§çš„å¼‚æ€§å­¦è€…äº¤æµ', 'SANå€¼+1ï¼Œç¤¾äº¤èƒ½åŠ›+1ï¼Œä¸´æ—¶buff-ä¸‹æ¬¡æƒ³ideaå¤šæƒ³2æ¬¡');
                        updateBuffs();
                        return changeStats({ san: 1, social: 1 });
                    }}
                );
            }

            if (gameState.metBigBull && !gameState.bigBullCooperation) {
                options.push({ text: 'ğŸŒŸ å’Œä¸Šæ¬¡é‚£ä¸ªå¤§ç‰›æ·±å…¥åˆä½œ', fn: () => {
                    gameState.buffs.temporary.push({ type: 'write_bonus', name: 'ä¸‹æ¬¡å†™è®ºæ–‡åˆ†æ•°+8', value: 8, permanent: false });
                    gameState.bigBullDeepCount++;
                    addLog('å¼€ä¼šäº‹ä»¶', 'å’Œä¸Šæ¬¡é‚£ä¸ªå¤§ç‰›æ·±å…¥åˆä½œ', 'ä¸´æ—¶buff-ä¸‹æ¬¡å†™è®ºæ–‡åˆ†æ•°+8');
                    updateBuffs();
                    if (gameState.research >= 12 && gameState.bigBullDeepCount >= 2) {
                        setTimeout(showBigBullCoopModal, 300);
                    }
                    return true;
                }});
            }

            if (gameState.metBeautiful && !gameState.hasLover) {
                options.push({ text: 'ğŸ’• å’Œä¸Šæ¬¡é‚£ä¸ªæ´»æ³¼çš„å¼‚æ€§å­¦è€…äº¤æµ', fn: () => {
                    gameState.beautifulCount++;
                    addLog('å¼€ä¼šäº‹ä»¶', 'å’Œä¸Šæ¬¡é‚£ä¸ªæ´»æ³¼çš„å¼‚æ€§å­¦è€…äº¤æµ', 'SANå€¼+8ï¼ŒSANå€¼ä¸Šé™+3');
                    gameState.sanMax += 3;
                    changeSan(8);
                    if (gameState.social >= 12 && gameState.beautifulCount >= 2) {
                        setTimeout(() => showLoverModal('beautiful'), 300);
                    }
                    return true;
                }});
            }

            if (gameState.metSmart && !gameState.hasLover) {
                options.push({ text: 'ğŸ§  å’Œä¸Šæ¬¡é‚£ä¸ªèªæ…§çš„å¼‚æ€§å­¦è€…äº¤æµ', fn: () => {
                    gameState.smartCount++;
                    addLog('å¼€ä¼šäº‹ä»¶', 'å’Œä¸Šæ¬¡é‚£ä¸ªèªæ…§çš„å¼‚æ€§å­¦è€…äº¤æµ', 'SANå€¼+1ï¼Œç§‘ç ”èƒ½åŠ›+1');
                    changeSan(1);
                    changeResearch(1);
                    if (gameState.social >= 12 && gameState.smartCount >= 2) {
                        setTimeout(() => showLoverModal('smart'), 300);
                    }
                    return true;
                }});
            }

            const selected = shuffle(options).slice(0, 3);
            
            // â˜…â˜…â˜… ä¿®æ”¹å¼¹çª—æ ‡é¢˜ï¼Œæ˜¾ç¤ºä¼šè®®åç§°å’Œåœ°ç‚¹ â˜…â˜…â˜…
            showModal(`ğŸ‰ ${confString}`, 
                `<div style="margin-bottom:15px;">
                    <p>ä½ æ¥åˆ°äº†<strong>${confLocation.city}</strong>å‚åŠ <strong>${confInfo.name}</strong>ï¼Œåœ¨å­¦æœ¯ä¼šè®®ä¸Šï¼Œä½ å¯ä»¥é€‰æ‹©ï¼š</p>
                </div>`, 
                selected.map(opt => ({
                    text: opt.text, class: 'btn-primary', action: () => {
                        closeModal();
                        opt.fn();
                    }
                }))
            );
        }

        function showLoverModal(type) {
            const desc = type === 'beautiful' 
                ? 'ä½ å’Œé‚£ä¸ªæ´»æ³¼çš„å¼‚æ€§å­¦è€…è¶Šæ¥è¶Šç†Ÿæ‚‰äº†' 
                : 'ä½ å’Œé‚£ä¸ªèªæ…§çš„å¼‚æ€§å­¦è€…è¶Šæ¥è¶Šé»˜å¥‘äº†';
            
            const bonusDesc = type === 'beautiful'
                ? '<div style="margin-top:10px;padding:8px;background:rgba(253,121,168,0.1);border-radius:8px;font-size:0.8rem;"><strong>æ‹äººæ•ˆæœï¼š</strong><br>âœ¨ SANå€¼ç«‹å³å›æ»¡<br>âœ¨ SANä¸Šé™+4<br>âœ¨ æ¯æœˆSAN+3<br>ğŸ’¸ æ¯æœˆé‡‘é’±-1ï¼ˆçº¦ä¼šå¼€é”€ï¼‰</div>'
                : '<div style="margin-top:10px;padding:8px;background:rgba(116,185,255,0.1);border-radius:8px;font-size:0.8rem;"><strong>æ‹äººæ•ˆæœï¼š</strong><br>âœ¨ SAN+1ï¼Œç§‘ç ”èƒ½åŠ›+1<br>âœ¨ æ¯æ¬¡æƒ³idea/åšå®éªŒ/å†™è®ºæ–‡å¤šä¸€æ¬¡<br>ğŸ’¸ æ¯æœˆé‡‘é’±-1ï¼ˆçº¦ä¼šå¼€é”€ï¼‰</div>';
            
            showModal('ğŸ’• å‘å±•å…³ç³»', `<p>${desc}ï¼Œæ˜¯å¦æˆä¸ºæ‹äººï¼Ÿ</p>${bonusDesc}`, [
                { text: 'è¿˜æ˜¯ç®—äº†', class: 'btn-info', action: closeModal },
                { text: 'â¤ï¸ æˆä¸ºæ‹äºº', class: 'btn-accent', action: () => {
                    gameState.hasLover = true;
                    gameState.loverType = type;
                    if (type === 'beautiful') {
                        gameState.san = gameState.sanMax;
                        gameState.sanMax += 4;
                        addLog('ğŸ’• æ‹çˆ±', 'å’Œæ´»æ³¼çš„å¼‚æ€§å­¦è€…æˆä¸ºæ‹äºº', 'SANå€¼å›æ»¡ï¼ŒSANä¸Šé™+4ï¼Œæ¯æœˆSAN+3ï¼Œæ¯æœˆé‡‘é’±-1');
                    } else {
                        changeResearch(1);
                        gameState.buffs.permanent.push(
                            { type: 'idea_times', name: 'æ¯æ¬¡æƒ³ideaå¤šæƒ³1æ¬¡', value: 1, permanent: true },
                            { type: 'exp_times', name: 'æ¯æ¬¡åšå®éªŒå¤šåš1æ¬¡', value: 1, permanent: true },
                            { type: 'write_times', name: 'æ¯æ¬¡å†™è®ºæ–‡å¤šå†™1æ¬¡', value: 1, permanent: true }
                        );
                        addLog('ğŸ’• æ‹çˆ±', 'å’Œèªæ…§çš„å¼‚æ€§å­¦è€…æˆä¸ºæ‹äºº', 'SAN+1ï¼Œç§‘ç ”èƒ½åŠ›+1ï¼Œæ°¸ä¹…buff-æ¯æ¬¡æƒ³idea/åšå®éªŒ/å†™è®ºæ–‡å¤šä¸€æ¬¡ï¼Œæ¯æœˆé‡‘é’±-1');
                        changeSan(1);
                    }
                    closeModal();
                    updateAllUI();
                    updateBuffs();
                }}
            ]);
        }

        function showAILabInternshipModal() {
            const sanCost = gameState.isReversed && gameState.character === 'normal' 
                ? (gameState.reversedAwakened ? 9 : 6) 
                : 3;
            
            showModal('ğŸ¢ å®ä¹ é‚€è¯·', 
                `<div style="text-align:center;margin-bottom:15px;">
                    <div style="font-size:2.5rem;margin-bottom:10px;">ğŸ¤–</div>
                    <div style="font-size:1.1rem;font-weight:600;color:var(--primary-color);">ä¸Šæµ·AI Lab è¿œç¨‹å®ä¹ é‚€è¯·</div>
                </div>
                <p>ä½ åœ¨ä¼ä¸šäº¤æµä¸­è¡¨ç°å‡ºè‰²ï¼ŒAI Lab çš„Lç ”ç©¶å‘˜å¯¹ä½ å°è±¡æ·±åˆ»ï¼Œå‘ä½ å‘å‡ºäº†è¿œç¨‹å®ä¹ é‚€è¯·ï¼</p>
                
                <div style="background:var(--light-bg);border-radius:10px;padding:12px;margin:15px 0;">
                    <div style="font-size:0.85rem;font-weight:600;margin-bottom:8px;">ğŸ“‹ å®ä¹ å¾…é‡ï¼š</div>
                    <div style="display:flex;flex-direction:column;gap:6px;font-size:0.85rem;">
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span style="color:var(--success-color);">âœ“</span>
                            <span>æ°¸ä¹…buffï¼šåšå®éªŒåˆ†æ•° Ã—1.25</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span style="color:var(--success-color);">âœ“</span>
                            <span>æ¯æœˆé‡‘é’± +2ï¼ˆå®ä¹ å·¥èµ„ï¼‰</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span style="color:var(--danger-color);">âœ—</span>
                            <span>æ¯æœˆSAN -${sanCost}ï¼ˆå·¥ä½œå‹åŠ›ï¼‰${sanCost !== 3 ? 'ï¼ˆæ€ æƒ°æ•ˆæœï¼‰' : ''}</span>
                        </div>
                    </div>
                </div>
                
                <p style="font-size:0.8rem;color:var(--text-secondary);text-align:center;">
                    è¿œç¨‹å®ä¹ å¯ä»¥å…¼é¡¾å­¦ä¸šï¼Œä½†éœ€è¦æ‰¿æ‹…é¢å¤–çš„å·¥ä½œå‹åŠ›
                </p>`,
                [
                    { text: 'å©‰æ‹’é‚€è¯·', class: 'btn-info', action: () => {
                        addLog('å®ä¹ é‚€è¯·', 'å©‰æ‹’äº†AI Labçš„å®ä¹ é‚€è¯·', 'ä¸“å¿ƒå®Œæˆå­¦ä¸š');
                        closeModal();
                    }},
                    { text: 'ğŸš€ æ¥å—å®ä¹ ', class: 'btn-primary', action: () => {
                        gameState.ailabInternship = true;
                        gameState.buffs.permanent.push({ 
                            type: 'exp_bonus', 
                            name: 'å®ä¹ åŠ æˆï¼šåšå®éªŒåˆ†æ•°Ã—1.25', 
                            value: 1.25, 
                            multiply: true, 
                            permanent: true 
                        });
                        addLog('å®ä¹ é‚€è¯·', 'æ¥å—äº†AI Labçš„è¿œç¨‹å®ä¹ ', 'æ°¸ä¹…buff-åšå®éªŒåˆ†æ•°Ã—1.25ï¼Œæ¯æœˆé‡‘é’±+2ï¼Œæ¯æœˆSAN-3');
                        closeModal();
                        updateBuffs();
                        updateAllUI();
                    }}
                ]
            );
        }

        function showBigBullCoopModal() {
            showModal('ğŸŒŸ è”åˆåŸ¹å…»', '<p>å¤§ç‰›å¯¹ä½ çš„ç§‘ç ”èƒ½åŠ›å°è±¡æ·±åˆ»ï¼Œæè®®ä¸ä½ çš„å¯¼å¸ˆè”åˆåŸ¹å…»ä½ ï¼Œæ˜¯å¦æ¥å—ï¼Ÿ</p>', [
                { text: 'å©‰æ‹’', class: 'btn-info', action: closeModal },
                { text: 'âœ¨ æ¥å—è”åˆåŸ¹å…»', class: 'btn-primary', action: () => {
                    gameState.bigBullCooperation = true;
                    gameState.buffs.permanent.push({ type: 'write_bonus', name: 'æ¯æ¬¡å†™è®ºæ–‡åˆ†æ•°+8', value: 8, permanent: true });
                    addLog('è”åˆåŸ¹å…»', 'å¯¼å¸ˆä¸å¤§ç‰›è”åˆåŸ¹å…»', 'æ°¸ä¹…buff-æ¯æ¬¡å†™è®ºæ–‡åˆ†æ•°+8');
                    closeModal();
                    updateBuffs();
                }}
            ]);
        }
		
        // ==================== å•†åº—ç³»ç»Ÿ ====================
		function openShop() {
			let html = '<div>';
			shopItems.forEach(item => {
				const canBuy = gameState.gold >= item.price && !(item.once && item.bought) && !(item.monthlyOnce && item.boughtThisMonth);
				const reason = gameState.gold < item.price ? 'é‡‘å¸ä¸è¶³' : (item.once && item.bought) ? 'å·²è´­ä¹°' : (item.monthlyOnce && item.boughtThisMonth) ? 'æœ¬æœˆå·²è´­' : '';
				
				// â˜…â˜…â˜… æ–°å¢ï¼šå†°ç¾å¼åŠ¨æ€æè¿° â˜…â˜…â˜…
				let itemDesc = item.desc;
				if (item.id === 'coffee') {
					const count = gameState.coffeeBoughtCount || 0;
					const currentBonus = 3 + Math.floor(count / 15);
					const nextMilestone = (Math.floor(count / 15) + 1) * 15;
					const nextBonus = currentBonus + 1;
					
					itemDesc = `SANå€¼+${currentBonus}`;
					itemDesc += ` (${count}/${nextMilestone}æ¯æ—¶+${nextBonus})`;
				}
				
				html += `<div class="shop-item ${!canBuy ? 'disabled' : ''}">
					<div class="shop-item-info">
						<div class="shop-item-name">${item.name}</div>
						<div class="shop-item-desc">${itemDesc}</div>
					</div>
					<div class="shop-item-action">
						<span class="shop-item-price">ğŸ’°${item.price}</span>
						<button class="btn btn-primary" onclick="buyItem('${item.id}')" ${!canBuy ? 'disabled' : ''}>${reason || 'è´­ä¹°'}</button>
					</div>
				</div>`;
			});
			html += '</div>';
			showModal('ğŸ›’ å•†åº—', html, [{ text: 'å…³é—­', class: 'btn-info', action: closeModal }]);
		}

        function buyItem(id) {
            const item = shopItems.find(i => i.id === id);
            if (!item) return;
            
            if (gameState.gold < item.price) {
                showModal('âŒ è´­ä¹°å¤±è´¥', `<p>é‡‘é’±ä¸è¶³ï¼è´­ä¹°${item.name}éœ€è¦${item.price}é‡‘å¸ï¼Œå½“å‰åªæœ‰${gameState.gold}é‡‘å¸ã€‚</p>`, 
                    [{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
                return;
            }
            
            let result = `é‡‘é’±-${item.price}`;
            
            // å¯Œå¯æ•Œå›½è§‰é†’ï¼šé€šè¿‡æ¶ˆè´¹å¢åŠ å±æ€§
            if (gameState.isReversed && gameState.character === 'rich' && gameState.reversedAwakened) {
                const spent = item.price;
                gameState.goldSpentTotal = (gameState.goldSpentTotal || 0) + spent;
                
                const attributeGains = Math.floor(gameState.goldSpentTotal / 6);
                const previousGains = Math.floor((gameState.goldSpentTotal - spent) / 6);
                const newGains = attributeGains - previousGains;
                
                if (newGains > 0) {
                    gameState.san = Math.min(gameState.sanMax, gameState.san + newGains);
                    gameState.research = Math.min(20, gameState.research + newGains);
                    gameState.social = Math.min(20, gameState.social + newGains);
                    gameState.favor = Math.min(20, gameState.favor + newGains);
                    result += `ï¼Œé‡‘é’±è§‰é†’(ç´¯è®¡${gameState.goldSpentTotal}é‡‘)ï¼šSAN+${newGains}, ç§‘ç ”+${newGains}, ç¤¾äº¤+${newGains}, å¥½æ„Ÿ+${newGains}`;
                }
            }
            
            gameState.gold -= item.price;
            
            switch(id) {
                case 'gpu_buy':
                    gameState.gpuServersBought = (gameState.gpuServersBought || 0) + 1;
                    if (gameState.gpuServersBought >= 5) {
                        gameState.achievementConditions = gameState.achievementConditions || {};
                        gameState.achievementConditions.bought5GPUs = true;
                    }
                    break;
                    
                case 'chair':
                    gameState.furnitureBought = gameState.furnitureBought || {};
                    gameState.furnitureBought.chair = true;
                    break;
                case 'monitor':
                    gameState.furnitureBought = gameState.furnitureBought || {};
                    gameState.furnitureBought.monitor = true;
                    break;
                case 'keyboard':
                    gameState.furnitureBought = gameState.furnitureBought || {};
                    gameState.furnitureBought.keyboard = true;
                    break;
            }
            
            // æ£€æŸ¥å…¨å¥—å®¶å…·æˆå°±
            if (gameState.furnitureBought && 
                gameState.furnitureBought.chair && 
                gameState.furnitureBought.monitor && 
                gameState.furnitureBought.keyboard) {
                gameState.achievementConditions = gameState.achievementConditions || {};
                gameState.achievementConditions.fullFurnitureSet = true;
            }
            
            switch (id) {
                case 'chair':
                    item.bought = true;
                    gameState.buffs.permanent.push({ type: 'monthly_san', name: 'æ¯æœˆSANå€¼+1', value: 1, permanent: true });
                    result += 'ï¼Œè·å¾—æ°¸ä¹…buff-æ¯æœˆSANå€¼+1';
                    break;
                case 'gpu_buy':
                    gameState.buffs.permanent.push({ type: 'exp_times', name: 'æ¯æ¬¡åšå®éªŒå¤šåš1æ¬¡', value: 1, permanent: true });
                    result += 'ï¼Œè·å¾—æ°¸ä¹…buff-æ¯æ¬¡åšå®éªŒå¤šåš1æ¬¡';
                    break;
                case 'keyboard':
                    item.bought = true;
                    gameState.buffs.permanent.push({ type: 'write_san_reduce', name: 'å†™è®ºæ–‡SAN-3', value: 1, permanent: true });
                    result += 'ï¼Œè·å¾—æ°¸ä¹…buff-æ¯æ¬¡å†™è®ºæ–‡å˜ä¸ºSANå€¼-3';
                    break;
                case 'monitor':
                    item.bought = true;
                    gameState.buffs.permanent.push({ type: 'read_san_reduce', name: 'è¯»è®ºæ–‡SAN-1', value: 1, permanent: true });
                    result += 'ï¼Œè·å¾—æ°¸ä¹…buff-è¯»è®ºæ–‡å˜ä¸ºSANå€¼-1';
                    break;
				case 'coffee':
					item.boughtThisMonth = true;
					gameState.coffeeBoughtCount = (gameState.coffeeBoughtCount || 0) + 1;
					const coffeeBonus = 3 + Math.floor(gameState.coffeeBoughtCount / 15);
					gameState.san = Math.min(gameState.sanMax, gameState.san + coffeeBonus);
					result += `ï¼ŒSANå€¼+${coffeeBonus}`;
					break;
					
				case 'gemini':
					item.boughtThisMonth = true;
					// â˜…â˜…â˜… åªæ·»åŠ ä¸€ä¸ªç»¼åˆbuffï¼Œä¸å†å•ç‹¬æ·»åŠ åˆ†æ•°buff â˜…â˜…â˜…
					gameState.buffs.temporary.push({ 
						type: 'idea_san_reduce', 
						name: 'Geminiè®¢é˜…', 
						value: 1, 
						permanent: false,
						thisMonthOnly: true,
						bonusScore: 4  // â˜…â˜…â˜… åœ¨buffä¸­è®°å½•åˆ†æ•°åŠ æˆ â˜…â˜…â˜…
					});
					result += 'ï¼Œè·å¾—æœ¬æœˆbuff-æƒ³ideaæ—¶SANæ¶ˆè€—-1ï¼Œåˆ†æ•°+4';
					break;
					
				case 'gpt':
					item.boughtThisMonth = true;
					gameState.buffs.temporary.push({ 
						type: 'exp_san_reduce', 
						name: 'GPTè®¢é˜…', 
						value: 1, 
						permanent: false,
						thisMonthOnly: true,
						bonusScore: 4
					});
					result += 'ï¼Œè·å¾—æœ¬æœˆbuff-åšå®éªŒæ—¶SANæ¶ˆè€—-1ï¼Œåˆ†æ•°+4';
					break;
					
				case 'claude':
					item.boughtThisMonth = true;
					gameState.buffs.temporary.push({ 
						type: 'write_san_reduce_temp', 
						name: 'Claudeè®¢é˜…', 
						value: 1, 
						permanent: false,
						thisMonthOnly: true,
						bonusScore: 4
					});
					result += 'ï¼Œè·å¾—æœ¬æœˆbuff-å†™è®ºæ–‡æ—¶SANæ¶ˆè€—-1ï¼Œåˆ†æ•°+4';
					break;
					
				case 'gpu_rent':
					// æ”¹ä¸ºæœ¬æœˆbuffè€Œä¸æ˜¯ä¸‹æ¬¡
					gameState.buffs.temporary.push({ 
						type: 'exp_times', 
						name: 'æœ¬æœˆåšå®éªŒå¤šåš1æ¬¡', 
						value: 1, 
						permanent: false,
						thisMonthOnly: true
					});
					result += 'ï¼Œè·å¾—æœ¬æœˆbuff-åšå®éªŒå¤šåš1æ¬¡';
					break;
            }
            
            addLog('è´­ä¹°', `è´­ä¹°äº†${item.name}`, result);
            closeModal();
            openShop();
            updateAllUI();
            updateBuffs();
        }
        // ==================== å¯’å‡æš‘å‡äº‹ä»¶ ====================
        function triggerWinterVacationEvent() {
            showModal('â„ï¸ å¯’å‡', 
                `<p>å¯’å‡åˆ°äº†ï¼å›å®¶è¿‡å¹´ï¼Œæ”¶åˆ°äº†é•¿è¾ˆçš„å‹å²é’±ï¼Œå¥½å¥½ä¼‘æ¯ä¸€ä¸‹å§ï½</p>
                 <div style="text-align:center;font-size:2rem;margin:15px 0;">ğŸ§§ğŸ ğŸ†</div>`,
                [{ 
                    text: 'ğŸŠ æ–°å¹´å¿«ä¹ï¼', 
                    class: 'btn-accent', 
					action: () => {
						gameState.gold += 1;
						gameState.san = Math.min(gameState.sanMax, gameState.san + 2);
						addLog('â„ï¸ å¯’å‡', 'å›å®¶è¿‡å¹´', 'å‹å²é’±+1ï¼ŒSANå€¼+2');
						closeModal();
						updateAllUI();
					}
                }]
            );
        }

        function triggerSummerVacationEvent() {
            showModal('â˜€ï¸ æš‘å‡', 
                `<p>æš‘å‡æ¥å•¦ï¼è™½ç„¶ç§‘ç ”ä¸èƒ½åœï¼Œä½†å¯ä»¥ç¨å¾®æ”¾æ¾ä¸€ä¸‹ï¼Œè°ƒæ•´çŠ¶æ€ï½</p>
                 <div style="text-align:center;font-size:2rem;margin:15px 0;">ğŸ–ï¸ğŸ‰ğŸŒ´</div>`,
                [{ 
                    text: 'ğŸ˜ å¥½å¥½ä¼‘æ¯ï¼', 
                    class: 'btn-success', 
					action: () => {
						gameState.san = Math.min(gameState.sanMax, gameState.san + 3);
						addLog('â˜€ï¸ æš‘å‡', 'æš‘å‡ä¼‘æ¯', 'SANå€¼+3');
						closeModal();
						updateAllUI();
					}
                }]
            );
        }
        
        // ==================== éšæœºäº‹ä»¶ç³»ç»Ÿ ====================
		function triggerScholarshipEvent() {
			const req = { 2: 1, 3: 3, 4: 6, 5: 9 }[gameState.year] || 9;
			// â˜…â˜…â˜… ä¿®æ”¹ï¼š10å…ƒæ”¹ä¸º8å…ƒ â˜…â˜…â˜…
			const reward = { 2: 5, 3: 5, 4: 8, 5: 8 }[gameState.year] || 8;
			
			if (gameState.totalScore >= req) {
				gameState.gold += reward;
				showModal('ğŸ“ å¥–å­¦é‡‘', `<p>æ­å–œï¼ä½ çš„ç§‘ç ”åˆ†è¾¾åˆ°${gameState.totalScore}åˆ†ï¼Œæ»¡è¶³æœ¬å¹´åº¦å¥–å­¦é‡‘è¦æ±‚ï¼ˆâ‰¥${req}åˆ†ï¼‰ï¼Œè·å¾—å¥–å­¦é‡‘${reward}é‡‘å¸ï¼</p>`,
					[{ text: 'å¤ªæ£’äº†ï¼', class: 'btn-primary', action: () => {
						addLog('å¥–å­¦é‡‘', `ç¬¬${gameState.year}å¹´å¥–å­¦é‡‘`, `ç§‘ç ”åˆ†${gameState.totalScore}â‰¥${req}ï¼Œé‡‘é’±+${reward}`);
						closeModal(); updateAllUI();
					}}]);
			} else {
				showModal('ğŸ“ å¥–å­¦é‡‘', `<p>é—æ†¾è½é€‰ï¼æœ¬å¹´åº¦å¥–å­¦é‡‘è¦æ±‚ç§‘ç ”åˆ†â‰¥${req}ï¼Œä½ ç›®å‰${gameState.totalScore}åˆ†ã€‚</p>`,
					[{ text: 'ç»§ç»­åŠªåŠ›', class: 'btn-info', action: () => {
						addLog('å¥–å­¦é‡‘', `ç¬¬${gameState.year}å¹´å¥–å­¦é‡‘`, `ç§‘ç ”åˆ†${gameState.totalScore}<${req}ï¼Œé—æ†¾è½é€‰`);
						closeModal();
					}}]);
			}
		}

        function triggerTeachersDayEvent() {
            showModal('ğŸ æ•™å¸ˆèŠ‚', '<p>æ•™å¸ˆèŠ‚åˆ°äº†ï¼Œä½ å‡†å¤‡é€å¯¼å¸ˆä»€ä¹ˆç¤¼ç‰©ï¼Ÿ</p>', [
                { text: 'ä»€ä¹ˆä¹Ÿä¸é€', class: 'btn-info', action: () => {
                    closeModal();
                    if (gameState.favor >= 6) {
                        addLog('æ•™å¸ˆèŠ‚', 'ä»€ä¹ˆä¹Ÿä¸é€', 'æ— äº‹å‘ç”Ÿ');
                        updateAllUI();
                    } else {
                        addLog('æ•™å¸ˆèŠ‚', 'ä»€ä¹ˆä¹Ÿä¸é€', 'å¯¼å¸ˆå¯¹ä½ ç•¥æœ‰ä¸æ»¡ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦-1');
                        changeFavor(-1);
                    }
                }},
                { text: 'ğŸµ èµ é€èŒ¶å¶ï¼ˆ1é‡‘ï¼‰', class: 'btn-primary', action: () => {
                    addLog('æ•™å¸ˆèŠ‚', 'èµ é€èŒ¶å¶', 'é‡‘é’±-1ï¼Œå¯¼å¸ˆå¼€å¿ƒæ”¶ä¸‹èŒ¶å¶ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦+1');
                    closeModal();
                    gameState.favor = Math.min(20, gameState.favor + 1);
                    changeGold(-1);
                }},
                { text: 'ğŸ“® èµ é€é‚®ç¥¨ï¼ˆ3é‡‘ï¼‰', class: 'btn-warning', action: () => {
                    addLog('æ•™å¸ˆèŠ‚', 'èµ é€é‚®ç¥¨', 'é‡‘é’±-3ï¼Œå¯¼å¸ˆå¼€å¿ƒæ”¶ä¸‹é‚®ç¥¨å¹¶ç‚¹äº†ç‚¹å¤´ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦+2');
                    closeModal();
                    gameState.favor = Math.min(20, gameState.favor + 2);
                    changeGold(-3);
                }}
            ]);
        }

		// â˜…â˜…â˜… æ–°å¢ï¼šå­¦å¹´æ€»ç»“äº‹ä»¶ â˜…â˜…â˜…
		function triggerYearEndSummaryEvent() {
			showModal('ğŸ“… å­¦å¹´æ€»ç»“', 
				`<div style="text-align:center;margin-bottom:15px;">
					<div style="font-size:2.5rem;margin-bottom:10px;">ğŸ“</div>
					<div style="font-size:1.1rem;font-weight:600;color:var(--primary-color);">ç¬¬${gameState.year}å¹´å­¦å¹´æ€»ç»“</div>
					<div style="font-size:0.85rem;color:var(--text-secondary);margin-top:5px;">é™¤äº†ç§‘ç ”ï¼Œä½ ä»Šå¹´éƒ½å¹²äº†ä»€ä¹ˆï¼Ÿ</div>
				</div>
				<p style="text-align:center;color:var(--text-secondary);font-size:0.85rem;">é€‰æ‹©ä¸€é¡¹ä½œä¸ºä½ ä»Šå¹´çš„ä¸»è¦æ´»åŠ¨ï¼š</p>`,
				[
					{ text: 'ğŸ˜´ éƒ½åœ¨ç¡å¤§è§‰', class: 'btn-info', action: () => {
						addLog('å­¦å¹´æ€»ç»“', 'ä»Šå¹´é™¤äº†ç§‘ç ”éƒ½åœ¨ç¡å¤§è§‰', 'SAN+5');
						closeModal();
						changeSan(5);
					}},
					{ text: 'ğŸ‰ å’ŒåŒå­¦ç©è€', class: 'btn-success', action: () => {
						addLog('å­¦å¹´æ€»ç»“', 'ä»Šå¹´ä¸»è¦åœ¨å’ŒåŒå­¦ç©è€', 'ç¤¾äº¤èƒ½åŠ›+1');
						closeModal();
						changeSocial(1);
					}},
					{ text: 'ğŸ‘¨â€ğŸ« å¸®å¯¼å¸ˆå¹²æ´»', class: 'btn-accent', action: () => {
						addLog('å­¦å¹´æ€»ç»“', 'ä»Šå¹´ä¸»è¦åœ¨å¸®å¯¼å¸ˆå¹²æ´»', 'å¯¼å¸ˆå¥½æ„Ÿåº¦+1');
						closeModal();
						changeFavor(1);
					}},
					{ text: 'ğŸ’¼ å·å·å®ä¹ ', class: 'btn-warning', action: () => {
						addLog('å­¦å¹´æ€»ç»“', 'ä»Šå¹´å·å·åœ¨å¤–é¢å®ä¹ ', 'é‡‘é’±+2');
						closeModal();
						changeGold(2);
					}}
				]
			);
		}

        function triggerOtherRandomEvent() {
            let availableEvents = [...gameState.availableRandomEvents];
            
            if (gameState.social >= 6 && !availableEvents.includes(11) && !gameState.usedRandomEvents.includes(11)) {
                availableEvents.push(11);
            }
            
            if (availableEvents.length === 0) {
                resetRandomEventPool();
                availableEvents = [...gameState.availableRandomEvents];
                if (gameState.social >= 6) {
                    availableEvents.push(11);
                }
                addLog('äº‹ä»¶è½®æ¢', 'æ–°ä¸€è½®éšæœºäº‹ä»¶å¼€å§‹', 'æ‰€æœ‰äº‹ä»¶é‡æ–°å¯ç”¨');
            }
            
            const eventIndex = Math.floor(Math.random() * availableEvents.length);
            const eventId = availableEvents[eventIndex];
            // â˜…â˜…â˜… æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦æŠµæŠ—æ„Ÿå†’ â˜…â˜…â˜…
			if (eventId === 3 && gameState.totalMonths === gameState.badmintonMonth + 1) {
				// ä»å¯ç”¨æ± ä¸­ç§»é™¤æ„Ÿå†’äº‹ä»¶
				gameState.availableRandomEvents = gameState.availableRandomEvents.filter(e => e !== 3);
				if (!gameState.usedRandomEvents.includes(3)) {
					gameState.usedRandomEvents.push(3);
				}
				
				// æ˜¾ç¤ºæŠµæŠ—æ„Ÿå†’çš„æç¤º
				showModal('ğŸ’ª éšæœºäº‹ä»¶', 
					`<p>æœ¬æ¥ä½ è¦æ„Ÿå†’äº†...</p>
					 <div style="text-align:center;font-size:2rem;margin:15px 0;">ğŸ¸â¡ï¸ğŸ›¡ï¸</div>
					 <p>ä½†æ˜¯ä¸Šä¸ªæœˆæ‰“ç¾½æ¯›çƒå¼ºåŒ–äº†èº«ä½“ï¼ŒæˆåŠŸæŠµæŠ—äº†æ„Ÿå†’ï¼</p>`,
					[{ 
						text: 'èº«ä½“å€å„¿æ£’ï¼', 
						class: 'btn-success', 
						action: () => {
							addLog('éšæœºäº‹ä»¶', 'æ„Ÿå†’æ¥è¢­', 'ä¸Šä¸ªæœˆæ‰“ç¾½æ¯›çƒå¼ºåŒ–äº†èº«ä½“ï¼ŒæˆåŠŸæŠµæŠ—ï¼');
							closeModal();
							updateAllUI();
						}
					}]
				);
				return;
			}
			
			gameState.availableRandomEvents = gameState.availableRandomEvents.filter(e => e !== eventId);
			if (!gameState.usedRandomEvents.includes(eventId)) {
				gameState.usedRandomEvents.push(eventId);
			}
			
			const eventMap = {
				1: showRandomEvent1,
				2: showRandomEvent2,
				3: showRandomEvent3,
				4: showRandomEvent4,
				5: showRandomEvent5,
				6: showRandomEvent6,
				7: showRandomEvent7,
				8: showRandomEvent8,
				9: showRandomEvent9,
				10: showRandomEvent10,
				11: showRandomEvent11,
				12: showRandomEvent12,
				13: showRandomEvent13,
				14: showRandomEvent14,
				15: showRandomEvent15,
			};
			
			if (eventMap[eventId]) {
				eventMap[eventId]();
			}
		}

        function showRandomEvent1() {
            showModal('ğŸ“š éšæœºäº‹ä»¶', '<p>å¯¼å¸ˆæ´¾ä½ æŒ‡å¯¼æœ¬ç§‘ç”Ÿæ¯•è®¾ã€‚</p>', [
                { text: 'æ®‹å¿æ‹’ç»', class: 'btn-danger', action: () => {
                    addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæ´¾ä½ æŒ‡å¯¼æœ¬ç§‘ç”Ÿæ¯•è®¾ - æ®‹å¿æ‹’ç»', 'å¯¼å¸ˆå¯¹ä½ ç•¥æœ‰ä¸æ»¡ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦-1');
                    closeModal();
                    changeFavor(-1);
                }},
                { text: 'äº²åŠ›äº²ä¸º', class: 'btn-primary', action: () => {
                    closeModal();
                    const baseSanCost = -3;
                    const actualSanCost = getActualSanChange(baseSanCost);
                    const sanText = actualSanCost !== baseSanCost ? `SANå€¼${actualSanCost}ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰` : `SANå€¼${actualSanCost}`;
                    
                    if (Math.random() < 0.5) {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæ´¾ä½ æŒ‡å¯¼æœ¬ç§‘ç”Ÿæ¯•è®¾ - äº²åŠ›äº²ä¸º', `æœ¬ç§‘ç”Ÿé¡ºåˆ©æ¯•ä¸šï¼Œåæˆä¸ºä½ çš„å¸ˆå¼Ÿå¸ˆå¦¹å¸®åŠ©ä½ ç§‘ç ”æ‰“ä¸‹æ‰‹ï¼Œ${sanText}ï¼Œç§‘ç ”èƒ½åŠ›+1`);
                        changeResearch(1);
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæ´¾ä½ æŒ‡å¯¼æœ¬ç§‘ç”Ÿæ¯•è®¾ - äº²åŠ›äº²ä¸º', `æœ¬ç§‘ç”Ÿé¡ºåˆ©æ¯•ä¸šï¼Œ${sanText}`);
                    }
                    changeSan(baseSanCost);
                }},
                { text: 'è®©å¸ˆå¼Ÿå¸ˆå¦¹å»æŒ‡å¯¼', class: 'btn-info', action: () => {
                    closeModal();
                    if (gameState.social < 6) {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæ´¾ä½ æŒ‡å¯¼æœ¬ç§‘ç”Ÿæ¯•è®¾ - è®©å¸ˆå¼Ÿå¸ˆå¦¹å»æŒ‡å¯¼', 'å¸ˆå¼Ÿå¸ˆå¦¹å¯¹ä½ é¢‡æœ‰å¾®è¯ï¼Œç¤¾äº¤èƒ½åŠ›-1');
                        changeSocial(-1);
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæ´¾ä½ æŒ‡å¯¼æœ¬ç§‘ç”Ÿæ¯•è®¾ - è®©å¸ˆå¼Ÿå¸ˆå¦¹å»æŒ‡å¯¼', 'å¸ˆå¼Ÿå¸ˆå¦¹æˆåŠŸä¸ºä½ åˆ†å¿§');
                        updateAllUI();
                    }
                }}
            ]);
        }

        function showRandomEvent2() {
            showModal('ğŸ“ éšæœºäº‹ä»¶', '<p>å¯¼å¸ˆè®©ä½ å¸®ä»–å®¡ç¨¿ã€‚</p>', [
                { text: 'ä»¥æ²¡æ—¶é—´ä¸ºç”±æ‹’ç»', class: 'btn-danger', action: () => {
                    addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆè®©ä½ å¸®ä»–å®¡ç¨¿ - ä»¥æ²¡æ—¶é—´ä¸ºç”±æ‹’ç»', 'å¯¼å¸ˆå¯¹ä½ ç•¥æœ‰ä¸æ»¡ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦-1');
                    closeModal();
                    changeFavor(-1);
                }},
                { text: 'è®¤çœŸå®¡ç¨¿', class: 'btn-primary', action: () => {
                    closeModal();
                    const baseSanCost = -2;
                    const actualSanCost = getActualSanChange(baseSanCost);
                    const sanText = actualSanCost !== baseSanCost ? `SANå€¼${actualSanCost}ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰` : `SANå€¼${actualSanCost}`;
                    
                    if (Math.random() < 0.5) {
                        gameState.buffs.temporary.push({ type: 'idea_bonus', name: 'ä¸‹æ¬¡æƒ³ideaåˆ†æ•°+4', value: 4, permanent: false });
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆè®©ä½ å¸®ä»–å®¡ç¨¿ - è®¤çœŸå®¡ç¨¿', `å¾—åˆ°äº†å¯å‘ï¼Œ${sanText}ï¼Œä¸´æ—¶buff-ä¸‹æ¬¡æƒ³ideaåˆ†æ•°+4`);
                        updateBuffs();
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆè®©ä½ å¸®ä»–å®¡ç¨¿ - è®¤çœŸå®¡ç¨¿', `æ— äº‹å‘ç”Ÿï¼Œ${sanText}`);
                    }
                    changeSan(baseSanCost);
                }},
                { text: 'äº¤ç»™å¸ˆå¼Ÿå¸ˆå¦¹', class: 'btn-info', action: () => {
                    closeModal();
                    if (gameState.social < 6) {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆè®©ä½ å¸®ä»–å®¡ç¨¿ - äº¤ç»™å¸ˆå¼Ÿå¸ˆå¦¹', 'å¸ˆå¼Ÿå¸ˆå¦¹å¯¹ä½ é¢‡æœ‰å¾®è¯ï¼Œç¤¾äº¤èƒ½åŠ›-1');
                        changeSocial(-1);
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆè®©ä½ å¸®ä»–å®¡ç¨¿ - äº¤ç»™å¸ˆå¼Ÿå¸ˆå¦¹', 'å¸ˆå¼Ÿå¸ˆå¦¹æˆåŠŸä¸ºä½ åˆ†å¿§');
                        updateAllUI();
                    }
                }}
            ]);
        }

		function showRandomEvent3() {
			showModal('ğŸ¤§ éšæœºäº‹ä»¶', '<p>çªç„¶æ„Ÿå†’äº†ã€‚</p>', [
				{ text: 'å¼ºæ’‘', class: 'btn-danger', action: () => {
					closeModal();
					if (Math.random() < 0.5) {
						const baseSanCost = -8;
						const actualSanCost = getActualSanChange(baseSanCost);
						const sanText = actualSanCost !== baseSanCost 
							? `SANå€¼${actualSanCost}ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰` 
							: `SANå€¼${actualSanCost}`;
						addLog('éšæœºäº‹ä»¶', 'çªç„¶æ„Ÿå†’äº† - å¼ºæ’‘', `èº«ä½“é€æ”¯äº†ï¼Œ${sanText}`);
						changeSan(baseSanCost);
					} else {
						// â˜…â˜…â˜… ä¿®æ”¹ï¼šå¹´è½»äººèº«ä½“å¥½çš„ç»“æœ â˜…â˜…â˜…
						gameState.sanMax -= 2;
						// â˜…â˜…â˜… æ–°å¢ï¼šå¦‚æœå½“å‰SANé«˜äºæ–°ä¸Šé™ï¼Œåˆ™åŒæ­¥é™ä½ â˜…â˜…â˜…
						if (gameState.san > gameState.sanMax) {
							const sanReduced = gameState.san - gameState.sanMax;
							gameState.san = gameState.sanMax;
							addLog('éšæœºäº‹ä»¶', 'çªç„¶æ„Ÿå†’äº† - å¼ºæ’‘', `è¿™æ¬¡æ²¡äº‹ä½†ç•™ä¸‹äº†ç—…æ ¹ï¼ŒSANä¸Šé™-2ï¼ŒSANå€¼-${sanReduced}`);
						} else {
							addLog('éšæœºäº‹ä»¶', 'çªç„¶æ„Ÿå†’äº† - å¼ºæ’‘', 'è¿™æ¬¡æ²¡äº‹ä½†ç•™ä¸‹äº†ç—…æ ¹ï¼ŒSANä¸Šé™-2');
						}
						updateAllUI();
					}
				}},
				{ text: 'è‡ªå·±ä¹°æ„Ÿå†’è¯', class: 'btn-primary', action: () => {
					addLog('éšæœºäº‹ä»¶', 'çªç„¶æ„Ÿå†’äº† - è‡ªå·±ä¹°æ„Ÿå†’è¯', 'å–999æ„Ÿå†’çµå¥½äº†ï¼Œé‡‘é’±-2');
					closeModal();
					changeGold(-2);
				}},
				{ text: 'å»åŒ»é™¢çœ‹ç—…', class: 'btn-info', action: () => {
					addLog('éšæœºäº‹ä»¶', 'çªç„¶æ„Ÿå†’äº† - å»åŒ»é™¢çœ‹ç—…', 'åŒ»ç”Ÿå¦™æ‰‹å›æ˜¥ï¼Œä½ æ¯”ç”Ÿç—…å‰è¿˜ç²¾ç¥ï¼ŒSANå€¼+2ï¼Œé‡‘é’±-4');
					gameState.san = Math.min(gameState.sanMax, gameState.san + 2);
					closeModal();
					changeGold(-4);
				}}
			]);
		}

        function showRandomEvent4() {
            showModal('ğŸ’¼ éšæœºäº‹ä»¶', '<p>å¯¼å¸ˆå®‰æ’ä½ åšé¡¹ç›®ã€‚</p>', [
                { text: 'æ¨ªå‘é¡¹ç›®', class: 'btn-warning', action: () => {
                    const baseSanCost = -7;
                    const actualSanCost = getActualSanChange(baseSanCost);
                    const sanText = actualSanCost !== baseSanCost ? `SANå€¼${actualSanCost}ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰` : `SANå€¼${actualSanCost}`;
                    addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆå®‰æ’ä½ åšé¡¹ç›® - æ¨ªå‘é¡¹ç›®', `æˆåŠŸç»“é¡¹ï¼Œ${sanText}ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦+1ï¼Œé‡‘é’±+5`);
                    closeModal();
                    gameState.favor = Math.min(20, gameState.favor + 1);
                    gameState.gold += 5;
                    changeSan(baseSanCost);
                }},
                { text: 'çºµå‘é¡¹ç›®', class: 'btn-primary', action: () => {
                    const baseSanCost = -5;
                    const actualSanCost = getActualSanChange(baseSanCost);
                    const sanText = actualSanCost !== baseSanCost ? `SANå€¼${actualSanCost}ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰` : `SANå€¼${actualSanCost}`;
                    addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆå®‰æ’ä½ åšé¡¹ç›® - çºµå‘é¡¹ç›®', `æˆåŠŸç»“é¡¹ï¼Œ${sanText}ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦+1ï¼Œç§‘ç ”èƒ½åŠ›+1`);
                    closeModal();
                    gameState.favor = Math.min(20, gameState.favor + 1);
                    changeResearch(1);
                    changeSan(baseSanCost);
                }},
                { text: 'æ‹’ç»é¡¹ç›®', class: 'btn-danger', action: () => {
                    closeModal();
                    if (gameState.research < 6) {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆå®‰æ’ä½ åšé¡¹ç›® - æ‹’ç»é¡¹ç›®', 'å¯¼å¸ˆå¯¹ä½ æ¯”è¾ƒä¸æ»¡ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦-2');
                        changeFavor(-2);
                    } else if (gameState.research < 12) {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆå®‰æ’ä½ åšé¡¹ç›® - æ‹’ç»é¡¹ç›®', 'å¯¼å¸ˆå¯¹ä½ ç•¥ä¸ºä¸æ»¡ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦-1');
                        changeFavor(-1);
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆå®‰æ’ä½ åšé¡¹ç›® - æ‹’ç»é¡¹ç›®', 'å¯¼å¸ˆè®©ä½ ä»¥ç§‘ç ”ä¸ºé‡');
                        updateAllUI();
                    }
                }},
                { text: 'è®©å¸ˆå¼Ÿå¸ˆå¦¹åˆ†æ‹…', class: 'btn-info', action: () => {
                    closeModal();
                    if (gameState.social < 6) {
                        const baseSanCost = -2;
                        const actualSanCost = getActualSanChange(baseSanCost);
                        const sanText = actualSanCost !== baseSanCost ? `SANå€¼${actualSanCost}ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰` : `SANå€¼${actualSanCost}`;
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆå®‰æ’ä½ åšé¡¹ç›® - è®©å¸ˆå¼Ÿå¸ˆå¦¹åˆ†æ‹…ä¸€éƒ¨åˆ†', `å¸ˆå¼Ÿå¸ˆå¦¹å¯¹ä½ é¢‡æœ‰å¾®è¯ï¼Œ${sanText}ï¼Œç¤¾äº¤èƒ½åŠ›-1`);
                        changeSocial(-1);
                        changeSan(baseSanCost);
                    } else if (gameState.social < 12) {
                        const baseSanCost = -2;
                        const actualSanCost = getActualSanChange(baseSanCost);
                        const sanText = actualSanCost !== baseSanCost ? `SANå€¼${actualSanCost}ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰` : `SANå€¼${actualSanCost}`;
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆå®‰æ’ä½ åšé¡¹ç›® - è®©å¸ˆå¼Ÿå¸ˆå¦¹åˆ†æ‹…ä¸€éƒ¨åˆ†', `å¸ˆå¼Ÿå¸ˆå¦¹æˆåŠŸä¸ºä½ åˆ†å¿§ï¼Œ${sanText}`);
                        changeSan(baseSanCost);
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆå®‰æ’ä½ åšé¡¹ç›® - è®©å¸ˆå¼Ÿå¸ˆå¦¹åˆ†æ‹…ä¸€éƒ¨åˆ†', 'å¸ˆå¼Ÿå¸ˆå¦¹ä¸»åŠ¨å…¨åŒ…äº†');
                        updateAllUI();
                    }
                }}
            ]);
        }

        function showRandomEvent5() {
            showModal('ğŸ’¬ éšæœºäº‹ä»¶', '<p>å¯¼å¸ˆæ‰¾ä½ è°ˆè¯ã€‚</p>', [
                { text: 'è®¤çœŸå‡†å¤‡ç§‘ç ”è¿›å±•', class: 'btn-primary', action: () => {
                    closeModal();
                    if (Math.random() < 0.5) {
                        gameState.buffs.temporary.push({ type: 'idea_bonus', name: 'ä¸‹æ¬¡æƒ³ideaåˆ†æ•°+5', value: 5, permanent: false });
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæ‰¾ä½ è°ˆè¯ - è®¤çœŸå‡†å¤‡ç§‘ç ”è¿›å±•', 'å¯¼å¸ˆæŒ‡å‡ºä½ å…³é”®é”™è¯¯ï¼Œä¸´æ—¶buff-ä¸‹æ¬¡æƒ³ideaåˆ†æ•°+5');
                        updateBuffs();
                        updateAllUI();
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæ‰¾ä½ è°ˆè¯ - è®¤çœŸå‡†å¤‡ç§‘ç ”è¿›å±•', 'å¯¼å¸ˆå‘ç°ä½ åœ¨æ‘¸é±¼ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦-1');
                        changeFavor(-1);
                    }
                }},
                { text: 'å‘å¯¼å¸ˆè¯¢é—®å¦‚ä½•ç§‘ç ”', class: 'btn-info', action: () => {
                    closeModal();
                    if (gameState.favor < 6) {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæ‰¾ä½ è°ˆè¯ - å‘å¯¼å¸ˆè¯¢é—®å¦‚ä½•ç§‘ç ”', 'å¯¼å¸ˆè§‰å¾—ä½ å¤©èµ„æ„šç¬¨ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦-1');
                        changeFavor(-1);
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæ‰¾ä½ è°ˆè¯ - å‘å¯¼å¸ˆè¯¢é—®å¦‚ä½•ç§‘ç ”', 'å¯¼å¸ˆä¼ æˆä½ ç§‘ç ”ç§˜è¯€ï¼Œç§‘ç ”èƒ½åŠ›+1');
                        changeResearch(1);
                    }
                }},
                { text: 'å‘Šè¯‰å¯¼å¸ˆæƒ³è¦å»å®ä¹ ', class: 'btn-warning', action: () => {
                    closeModal();
                    if (gameState.favor >= 6) {
                        const baseSanCost = -6;
                        const actualSanCost = getActualSanChange(baseSanCost);
                        const sanText = actualSanCost !== baseSanCost ? `SANå€¼${actualSanCost}ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰` : `SANå€¼${actualSanCost}`;
                        gameState.buffs.temporary.push({ type: 'exp_bonus', name: 'ä¸‹æ¬¡åšå®éªŒåˆ†æ•°+5', value: 5, permanent: false });
                        gameState.gold += 5;
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæ‰¾ä½ è°ˆè¯ - å‘Šè¯‰å¯¼å¸ˆæƒ³è¦å»å®ä¹ ', `å¯¼å¸ˆå±…ç„¶åŒæ„äº†ä½†è¦å…¼é¡¾ç§‘ç ”ï¼Œ${sanText}ï¼Œä¸´æ—¶buff-ä¸‹æ¬¡åšå®éªŒåˆ†æ•°+5ï¼Œé‡‘é’±+5`);
                        updateBuffs();
                        changeSan(baseSanCost);
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæ‰¾ä½ è°ˆè¯ - å‘Šè¯‰å¯¼å¸ˆæƒ³è¦å»å®ä¹ ', 'å¯¼å¸ˆæœç„¶æ‹’ç»äº†ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦-1');
                        changeFavor(-1);
                    }
                }}
            ]);
        }

        function showRandomEvent6() {
            showModal('ğŸ“Š éšæœºäº‹ä»¶', '<p>å®éªŒå®¤å¬å¼€ç»„ä¼šã€‚</p>', [
                { text: 'è®²è§£ä¸€ç¯‡æ·±å¥¥è®ºæ–‡', class: 'btn-primary', action: () => {
                    closeModal();
                    if (gameState.research < 6) {
                        addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤å¬å¼€ç»„ä¼š - è®²è§£ä¸€ç¯‡æ·±å¥¥è®ºæ–‡', 'å¯¼å¸ˆå‘ç°ä½ ä¸æ‡‚è£…æ‡‚ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦-1');
                        changeFavor(-1);
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤å¬å¼€ç»„ä¼š - è®²è§£ä¸€ç¯‡æ·±å¥¥è®ºæ–‡', 'å¯¼å¸ˆå¤¸èµäº†ä½ çš„è§è§£ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦+1');
                        changeFavor(1);
                    }
                }},
                { text: 'è®²è§£ç³»åˆ—è®ºæ–‡', class: 'btn-warning', action: () => {
                    closeModal();
                    const baseSanCost = -3;
                    const actualSanCost = getActualSanChange(baseSanCost);
                    const sanText = actualSanCost !== baseSanCost ? `SANå€¼${actualSanCost}ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰` : `SANå€¼${actualSanCost}`;
                    
                    if (Math.random() < 0.5) {
                        addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤å¬å¼€ç»„ä¼š - è®²è§£ç³»åˆ—è®ºæ–‡', `è™½ç„¶å¾ˆè¾›è‹¦ä½†å¯¼å¸ˆå¤§åŠ›å¤¸èµäº†ä½ çš„è§è§£ï¼Œ${sanText}ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦+2`);
                        gameState.favor = Math.min(20, gameState.favor + 2);
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤å¬å¼€ç»„ä¼š - è®²è§£ç³»åˆ—è®ºæ–‡', `è™½ç„¶å¾ˆè¾›è‹¦ä½†å¯¼å¸ˆæ²¡æ¥å‚ä¼šï¼Œ${sanText}`);
                    }
                    changeSan(baseSanCost);
                }},
                { text: 'å·å·æ°´è¿‡å»', class: 'btn-info', action: () => {
                    closeModal();
                    if (Math.random() < 0.5) {
                        addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤å¬å¼€ç»„ä¼š - å·å·æ°´è¿‡å»', 'å¯¼å¸ˆå¯¹ä½ ç•¥æœ‰ä¸æ»¡ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦-1');
                        changeFavor(-1);
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤å¬å¼€ç»„ä¼š - å·å·æ°´è¿‡å»', 'å¯¼å¸ˆæ°å¥½æ²¡æ¥');
                        updateAllUI();
                    }
                }}
            ]);
        }

        function showRandomEvent7() {
            showModal('ğŸ‰ éšæœºäº‹ä»¶', '<p>å®éªŒå®¤ç»„ç»‡å›¢å»ºã€‚</p>', [
                { text: 'ğŸ¸ æ‰“ç¾½æ¯›çƒ', class: 'btn-primary', action: () => {
					gameState.badmintonMonth = gameState.totalMonths;
                    addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤ç»„ç»‡å›¢å»º - æ‰“ç¾½æ¯›çƒ', 'è„–å­å’Œæ‰‹è‡‚å¾—åˆ°äº†å¼ºåŒ–ï¼Œæœ‰åŠ©äºæŠµæŠ—æ„Ÿå†’ï¼ŒSANå€¼+2');
                    closeModal();
                    changeSan(2);
                }},
                { text: 'ğŸƒ æ‰“å¾·å·æ‰‘å…‹', class: 'btn-warning', action: () => {
                    closeModal();
                    if (Math.random() < 0.5) {
                        addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤ç»„ç»‡å›¢å»º - æ‰“å¾·å·æ‰‘å…‹', 'è¾“äº†ï¼Œé‡‘é’±-5');
                        changeGold(-5);
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤ç»„ç»‡å›¢å»º - æ‰“å¾·å·æ‰‘å…‹', 'èµ¢äº†ï¼Œé‡‘é’±+5');
                        changeGold(5);
                    }
                }},
                { text: 'ğŸ¤ KTVå”±æ­Œ', class: 'btn-accent', action: () => {
                    addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤ç»„ç»‡å›¢å»º - KTVå”±æ­Œ', 'å”±äº†çŒªçŒªä¾ ä¸»é¢˜æ›²ï¼Œèªæ˜å‹‡æ•¢æœ‰åŠ›æ°”ï¼Œç¤¾äº¤èƒ½åŠ›+1');
                    closeModal();
                    changeSocial(1);
                }},
				{ text: 'ğŸœ èšé¤', class: 'btn-info', action: () => {
					closeModal();
					if (Math.random() < 0.5) {
						addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤ç»„ç»‡å›¢å»º - èšé¤', 'åƒé¥±äº†ï¼Œé‡‘é’±-3ï¼ŒSANå€¼+5');
						gameState.san = Math.min(gameState.sanMax, gameState.san + 5);
						changeGold(-3);
					} else {
						addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤ç»„ç»‡å›¢å»º - èšé¤', 'å¯¼å¸ˆè¯·å®¢ï¼ŒSANå€¼+5');
						changeSan(5);
					}
				}}
            ]);
        }

        function showRandomEvent8() {
            showModal('ğŸ’° éšæœºäº‹ä»¶', '<p>å¯¼å¸ˆç§‘ç ”ç»è´¹å……è¶³ï¼Œä½ å»ºè®®ã€‚</p>', [
                { text: 'ğŸ–¥ï¸ è´­ä¹°GPUæœåŠ¡å™¨', class: 'btn-primary', action: () => {
                    closeModal();
                    if (Math.random() < 0.5) {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆç§‘ç ”ç»è´¹å……è¶³ - è´­ä¹°é«˜æ€§èƒ½GPUæœåŠ¡å™¨', 'å¯¼å¸ˆå¹¶ä¸æƒ³ä¹°');
                    } else {
                        gameState.buffs.permanent.push({ type: 'exp_times', name: 'æ¯æ¬¡åšå®éªŒå¤šåšä¸€æ¬¡', value: 1, permanent: true });
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆç§‘ç ”ç»è´¹å……è¶³ - è´­ä¹°é«˜æ€§èƒ½GPUæœåŠ¡å™¨', 'ä½ åªåˆ†åˆ°äº†ä¸€å¼ æ˜¾å¡ï¼Œä½†æ€»æ¯”æ²¡æœ‰å¥½ï¼Œæ°¸ä¹…buff-æ¯æ¬¡åšå®éªŒå¤šåšä¸€æ¬¡');
                        updateBuffs();
                    }
                    updateAllUI();
                }},
                { text: 'ğŸ’µ å¤šå‘åŠ³åŠ¡è´¹', class: 'btn-warning', action: () => {
                    closeModal();
                    const amount = gameState.favor < 6 ? 2 : gameState.favor < 12 ? 4 : 8;
                    const desc = gameState.favor < 6 ? 'å¯¼å¸ˆåªå‘äº†ä¸€ç‚¹ç‚¹' : gameState.favor < 12 ? 'å¯¼å¸ˆå‘äº†å¾ˆå¤š' : 'å¯¼å¸ˆå…¨ç»™ä½ äº†';
                    gameState.gold += amount;
                    addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆç§‘ç ”ç»è´¹å……è¶³ - å¤šå‘åŠ³åŠ¡è´¹', `${desc}ï¼Œé‡‘é’±+${amount}`);
                    updateAllUI();
                }},
                { text: 'ğŸª‘ è£…ä¿®å­¦ç”Ÿå·¥ä½', class: 'btn-info', action: () => {
                    closeModal();
                    gameState.buffs.permanent.push(
                        { type: 'idea_bonus', name: 'æ¯æ¬¡æƒ³ideaåˆ†æ•°+1', value: 1, permanent: true },
                        { type: 'write_bonus', name: 'æ¯æ¬¡å†™è®ºæ–‡åˆ†æ•°+1', value: 1, permanent: true }
                    );
                    addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆç§‘ç ”ç»è´¹å……è¶³ - è£…ä¿®å­¦ç”Ÿå·¥ä½', 'éå¸¸èˆ’é€‚ï¼Œæ°¸ä¹…buff-æ¯æ¬¡æƒ³ideaåˆ†æ•°+1ï¼Œæ°¸ä¹…buff-æ¯æ¬¡å†™è®ºæ–‡åˆ†æ•°+1');
                    updateAllUI();
                    updateBuffs();
                }}
            ]);
        }

        function showRandomEvent9() {
            showModal('ğŸ“– éšæœºäº‹ä»¶', '<p>ä½ æ‰“ç®—å­¦ç‚¹æ–°çŸ¥è¯†ï¼Œä½ ä¼šé€‰æ‹©ã€‚</p>', [
                { text: 'ğŸ“š åŸºç¡€çŸ¥è¯†', class: 'btn-primary', action: () => {
                    closeModal();
                    if (gameState.research < 4) {
                        addLog('éšæœºäº‹ä»¶', 'å­¦ä¹ æ–°çŸ¥è¯† - åŸºç¡€çŸ¥è¯†', 'æ‰“å¥½äº†åŸºç¡€ï¼Œç§‘ç ”èƒ½åŠ›+1');
                        changeResearch(1);
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'å­¦ä¹ æ–°çŸ¥è¯† - åŸºç¡€çŸ¥è¯†', 'å¯¹ä½ æ²¡æœ‰ä»€ä¹ˆå¸®åŠ©');
                        updateAllUI();
                    }
                }},
                { text: 'ğŸ’» ä»£ç çŸ¥è¯†', class: 'btn-info', action: () => {
                    closeModal();
                    gameState.buffs.permanent.push({ type: 'exp_bonus', name: 'æ¯æ¬¡åšå®éªŒåˆ†æ•°+1', value: 1, permanent: true });
                    addLog('éšæœºäº‹ä»¶', 'å­¦ä¹ æ–°çŸ¥è¯† - ä»£ç çŸ¥è¯†', 'æ°¸ä¹…buff-æ¯æ¬¡åšå®éªŒåˆ†æ•°+1');
                    updateAllUI();
                    updateBuffs();
                }},
                { text: 'ğŸš€ æœ€æ–°æŠ€æœ¯', class: 'btn-warning', action: () => {
                    closeModal();
                    gameState.buffs.permanent.push({ type: 'idea_bonus', name: 'æ¯æ¬¡æƒ³ideaåˆ†æ•°+1', value: 1, permanent: true });
                    addLog('éšæœºäº‹ä»¶', 'å­¦ä¹ æ–°çŸ¥è¯† - æœ€æ–°æŠ€æœ¯', 'æ°¸ä¹…buff-æ¯æ¬¡æƒ³ideaåˆ†æ•°+1');
                    updateAllUI();
                    updateBuffs();
                }},
                { text: 'ğŸ”® æ·±å¥¥çš„çŸ¥è¯†', class: 'btn-accent', action: () => {
                    closeModal();
                    gameState.buffs.permanent.push({ type: 'write_bonus', name: 'æ¯æ¬¡å†™è®ºæ–‡åˆ†æ•°+1', value: 1, permanent: true });
                    addLog('éšæœºäº‹ä»¶', 'å­¦ä¹ æ–°çŸ¥è¯† - çœ‹èµ·æ¥å¾ˆæ·±å¥¥çš„çŸ¥è¯†', 'æ°¸ä¹…buff-æ¯æ¬¡å†™è®ºæ–‡åˆ†æ•°+1');
                    updateAllUI();
                    updateBuffs();
                }}
            ]);
        }

        function showRandomEvent10() {
            showModal('ğŸ¤ éšæœºäº‹ä»¶', '<p>åŒé—¨æ‰¾ä½ åˆä½œè®ºæ–‡ï¼Œä½ ä¼šé€‰æ‹©ã€‚</p>', [
                { text: 'å­¦æœ¯äº¤æµ', class: 'btn-primary', action: () => {
                    closeModal();
					if (Math.random() < 0.5) {
						gameState.buffs.temporary.push({ type: 'idea_stolen', name: 'ä¸‹æ¬¡æƒ³ideaæ€»åˆ†Ã·2', value: 0.5, multiply: true, permanent: false });  // â˜…â˜…â˜… æ”¹ä¸ºé™¤2 â˜…â˜…â˜…
						addLog('éšæœºäº‹ä»¶', 'åŒé—¨æ‰¾ä½ åˆä½œè®ºæ–‡ - å­¦æœ¯äº¤æµ', 'è¢«åŒé—¨å·èµ°ideaï¼Œä¸´æ—¶debuff-ä¸‹æ¬¡æƒ³ideaæ€»åˆ†Ã·2');
					} else {
                        gameState.buffs.temporary.push({ type: 'idea_bonus', name: 'ä¸‹æ¬¡æƒ³ideaåˆ†æ•°+5', value: 5, permanent: false });
                        addLog('éšæœºäº‹ä»¶', 'åŒé—¨æ‰¾ä½ åˆä½œè®ºæ–‡ - å­¦æœ¯äº¤æµ', 'å…±åŒè¿›æ­¥ï¼Œä¸´æ—¶buff-ä¸‹æ¬¡æƒ³ideaåˆ†æ•°+5');
                    }
                    updateAllUI();
                    updateBuffs();
                }},
				{ text: 'çº¦å®šäº’æŒ‚è®ºæ–‡', class: 'btn-warning', action: () => {
					closeModal();
					if (Math.random() < 0.5) {
						gameState.buffs.temporary.push({ type: 'citation_multiply', name: 'ä¸‹ä¸€ç¯‡ä¸­ç¨¿è®ºæ–‡å¼•ç”¨é€Ÿåº¦+100%', value: 2, permanent: false });
						addLog('éšæœºäº‹ä»¶', 'åŒé—¨æ‰¾ä½ åˆä½œè®ºæ–‡ - çº¦å®šäº’æŒ‚è®ºæ–‡', 'ä½ ä»¬ä¸€èµ·ä¸­äº†è®ºæ–‡ï¼Œä¸´æ—¶buff-ä¸‹ä¸€ç¯‡ä¸­ç¨¿çš„è®ºæ–‡å¼•ç”¨é€Ÿåº¦+100%ï¼ˆä¸å…¶ä»–æ¨å¹¿åŠ æˆå åŠ ï¼‰');
					} else {
                        addLog('éšæœºäº‹ä»¶', 'åŒé—¨æ‰¾ä½ åˆä½œè®ºæ–‡ - çº¦å®šäº’æŒ‚è®ºæ–‡', 'åŒé—¨å¤ªèœäº†ï¼Œä¸€ç›´æ²¡ä¸­è®ºæ–‡');
                    }
                    updateAllUI();
                    updateBuffs();
                }},
                { text: 'å©‰æ‹’åˆä½œ', class: 'btn-info', action: () => {
                    addLog('éšæœºäº‹ä»¶', 'åŒé—¨æ‰¾ä½ åˆä½œè®ºæ–‡ - å©‰æ‹’åˆä½œ', 'æ— äº‹å‘ç”Ÿ');
                    closeModal();
                }},
                { text: 'å¼€å±•å…¨é¢åˆä½œ', class: 'btn-success', action: () => {
                    closeModal();
                    if (gameState.social < 6) {
                        gameState.buffs.temporary.push({ type: 'idea_times', name: 'ä¸‹æ¬¡æƒ³ideaå¤šæƒ³1æ¬¡', value: 1, permanent: false });
                        addLog('éšæœºäº‹ä»¶', 'åŒé—¨æ‰¾ä½ åˆä½œè®ºæ–‡ - å¼€å±•å…¨é¢åˆä½œ', 'æˆåŠŸåˆä½œï¼Œä¸´æ—¶buff-ä¸‹æ¬¡æƒ³ideaå¤šæƒ³1æ¬¡');
                    } else {
                        gameState.buffs.temporary.push(
                            { type: 'idea_times', name: 'ä¸‹æ¬¡æƒ³ideaå¤šæƒ³1æ¬¡', value: 1, permanent: false },
                            { type: 'write_times', name: 'ä¸‹æ¬¡å†™è®ºæ–‡å¤šå†™1æ¬¡', value: 1, permanent: false }
                        );
                        addLog('éšæœºäº‹ä»¶', 'åŒé—¨æ‰¾ä½ åˆä½œè®ºæ–‡ - å¼€å±•å…¨é¢åˆä½œ', 'æ·±å…¥åˆä½œï¼Œä¸´æ—¶buff-ä¸‹æ¬¡æƒ³ideaå¤šæƒ³1æ¬¡ï¼Œä¸´æ—¶buff-ä¸‹æ¬¡å†™è®ºæ–‡å¤šå†™1æ¬¡');
                    }
                    updateAllUI();
                    updateBuffs();
                }}
            ]);
        }

        function showRandomEvent11() {
            showModal('ğŸ‘¨â€ğŸ“ éšæœºäº‹ä»¶', '<p>å¸ˆå…„å¸ˆå§æ‰¾ä½ åˆä½œè®ºæ–‡ï¼Œä½ ä¼šé€‰æ‹©ã€‚</p>', [
                { text: 'è§‚æœ›ä¸€ä¸‹', class: 'btn-info', action: () => {
                    addLog('éšæœºäº‹ä»¶', 'å¸ˆå…„å¸ˆå§æ‰¾ä½ åˆä½œè®ºæ–‡ - è§‚æœ›ä¸€ä¸‹', 'å¸ˆå…„å¸ˆå§å…ˆæ‰¾äº†åŒé—¨åˆä½œ');
                    closeModal();
                }},
                { text: 'æµ…æµ…åˆä½œ', class: 'btn-primary', action: () => {
                    closeModal();
                    gameState.buffs.temporary.push({ type: 'idea_bonus', name: 'ä¸‹æ¬¡æƒ³ideaåˆ†æ•°+10', value: 10, permanent: false });
                    addLog('éšæœºäº‹ä»¶', 'å¸ˆå…„å¸ˆå§æ‰¾ä½ åˆä½œè®ºæ–‡ - æµ…æµ…åˆä½œ', 'å¸ˆå…„å¸ˆå§ç»™äº†ä½ ä¸€ä¸ªideaï¼Œä¸´æ—¶buff-ä¸‹æ¬¡æƒ³ideaåˆ†æ•°+10');
                    updateAllUI();
                    updateBuffs();
                }},
                { text: 'æ·±å…¥åˆä½œ', class: 'btn-warning', action: () => {
                    addLog('éšæœºäº‹ä»¶', 'å¸ˆå…„å¸ˆå§æ‰¾ä½ åˆä½œè®ºæ–‡ - æ·±å…¥åˆä½œ', 'é‡åˆ°é è°±çš„å¸ˆå…„å¸ˆå§ï¼Œç§‘ç ”èƒ½åŠ›+1');
                    closeModal();
                    changeResearch(1);
                }},
                { text: 'æ‹œå…¥é—¨ä¸‹', class: 'btn-success', action: () => {
                    closeModal();
                    changeResearch(1);
                    gameState.buffs.permanent.push({ type: 'write_bonus', name: 'æ¯æ¬¡å†™è®ºæ–‡åˆ†æ•°+3', value: 3, permanent: true });
                    addLog('éšæœºäº‹ä»¶', 'å¸ˆå…„å¸ˆå§æ‰¾ä½ åˆä½œè®ºæ–‡ - æ‹œå…¥é—¨ä¸‹', 'ä½ æ”¶è·äº†ç¬¬äºŒå¯¼å¸ˆï¼Œç§‘ç ”èƒ½åŠ›+1ï¼Œæ°¸ä¹…buff-æ¯æ¬¡å†™è®ºæ–‡åˆ†æ•°+3');
                    updateAllUI();
                    updateBuffs();
                }}
            ]);
        }

		function showRandomEvent12() {
			// â˜…â˜…â˜… æ–°å¢ï¼šåˆ¤æ–­æ˜¯å¦ä¸ºå¯¼å¸ˆå­å¥³è§’è‰² â˜…â˜…â˜…
			const isTeacherChild = gameState.character === 'teacher-child';
			
			// â˜…â˜…â˜… æ–°å¢ï¼šæ ¹æ®è§’è‰²åŠ¨æ€ç”Ÿæˆé€‰é¡¹æ–‡æœ¬ â˜…â˜…â˜…
			const grabOptionText = isTeacherChild 
				? 'åŠè¯´å¯¼å¸ˆæŠ¢å¸ˆå¼Ÿå¸ˆå¦¹ä¸€ä½œ ğŸï¼ˆå¯¼å¸ˆå­å¥³ï¼šè·å¾—Cç±»è®ºæ–‡ï¼‰' 
				: 'åŠè¯´å¯¼å¸ˆæŠ¢å¸ˆå¼Ÿå¸ˆå¦¹ä¸€ä½œ';
			const grabOptionClass = isTeacherChild ? 'btn-success' : 'btn-warning';  // å¯¼å¸ˆå­å¥³ç”¨ç»¿è‰²æŒ‰é’®çªå‡ºæ˜¾ç¤º
			
			showModal('âš ï¸ éšæœºäº‹ä»¶', '<p>å¯¼å¸ˆæƒ³è¦æŠ¢ä½ è®ºæ–‡çš„ä¸€ä½œã€‚</p>', [
				{ text: 'å‘å¯¼å¸ˆè¯‰è‹¦', class: 'btn-primary', action: () => {
					closeModal();
					if (gameState.favor >= 6) {
						addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæƒ³è¦æŠ¢ä½ è®ºæ–‡çš„ä¸€ä½œ - å‘å¯¼å¸ˆè¯‰è‹¦', 'å¯¼å¸ˆå¿ƒè½¯äº†');
						updateAllUI();
					} else {
						gameState.buffs.temporary.push({ type: 'idea_bonus', name: 'ä¸‹æ¬¡æƒ³ideaåˆ†æ•°-5', value: -5, permanent: false });
						addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæƒ³è¦æŠ¢ä½ è®ºæ–‡çš„ä¸€ä½œ - å‘å¯¼å¸ˆè¯‰è‹¦', 'å¯¼å¸ˆä¸è¦ä¸€ä½œäº†ï¼Œä½†ä¹Ÿå‡å°‘äº†æŒ‡å¯¼ï¼Œä¸´æ—¶debuff-ä¸‹æ¬¡æƒ³ideaåˆ†æ•°-3');
						updateAllUI();
						updateBuffs();
					}
				}},
				{ text: grabOptionText, class: grabOptionClass, action: () => {  // â˜…â˜…â˜… ä½¿ç”¨åŠ¨æ€æ–‡æœ¬å’Œæ ·å¼ â˜…â˜…â˜…
					closeModal();
					if (gameState.character === 'teacher-child') {  // â˜…â˜…â˜… ç®€åŒ–åˆ¤æ–­æ¡ä»¶ â˜…â˜…â˜…
						const title = generatePaperTitle();
						gameState.publishedPapers.push({
							title: title,
							grade: 'C',
							acceptType: 'Poster',
							score: 15,
							citations: 0,
							monthsSincePublish: 0,
							promotions: { arxiv: false, github: false, xiaohongshu: false, quantumbit: false },
							citationMultiplier: 1
						});
						gameState.paperC++;
						gameState.totalScore += 1;
						addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæƒ³è¦æŠ¢ä½ è®ºæ–‡çš„ä¸€ä½œ - åŠè¯´å¯¼å¸ˆæŠ¢å¸ˆå¼Ÿå¸ˆå¦¹ä¸€ä½œ', 'å¯¼å¸ˆæŠ¢æ¥å¹¶ç»™äº†ä½ ä¸€ç¯‡Cç±»è®ºæ–‡');
					} else {
						addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæƒ³è¦æŠ¢ä½ è®ºæ–‡çš„ä¸€ä½œ - åŠè¯´å¯¼å¸ˆæŠ¢å¸ˆå¼Ÿå¸ˆå¦¹ä¸€ä½œ', 'å¸ˆå¼Ÿå¸ˆå¦¹å¯¹ä½ ç•¥æœ‰ä¸æ»¡ï¼Œç¤¾äº¤èƒ½åŠ›-1');
						changeSocial(-1);
					}
					updateAllUI();
				}},
				{ text: 'æ®ç†åŠ›äº‰', class: 'btn-info', action: () => {
					closeModal();
					if (gameState.favor >= 6) {
						addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæƒ³è¦æŠ¢ä½ è®ºæ–‡çš„ä¸€ä½œ - æ®ç†åŠ›äº‰', 'å¯¼å¸ˆè½»æ¾è¢«ä½ è¯´æœ');
						updateAllUI();
					} else {
						const baseSanCost = -2;
						const actualSanCost = getActualSanChange(baseSanCost);
						const sanText = actualSanCost !== baseSanCost ? `SANå€¼${actualSanCost}ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰` : `SANå€¼${actualSanCost}`;
						addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæƒ³è¦æŠ¢ä½ è®ºæ–‡çš„ä¸€ä½œ - æ®ç†åŠ›äº‰', `å¯¼å¸ˆè‰°éš¾è¢«ä½ è¯´æœï¼Œ${sanText}`);
						changeSan(baseSanCost);
					}
				}},
				{ text: 'ä»¥æ­»ç›¸é€¼', class: 'btn-danger', action: () => {
					addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæƒ³è¦æŠ¢ä½ è®ºæ–‡çš„ä¸€ä½œ - ä»¥æ­»ç›¸é€¼', 'å¯¼å¸ˆå¯¹ä½ ç•¥æœ‰ä¸æ»¡ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦-1');
					closeModal();
					changeFavor(-1);
				}}
			]);
		}

        function showRandomEvent13() {
            showModal('ğŸ’» éšæœºäº‹ä»¶', '<p>å®éªŒå®¤æœåŠ¡å™¨çªç„¶åäº†ã€‚</p>', [
                { text: 'å‚¬å¯¼å¸ˆå¿«ä¿®', class: 'btn-primary', action: () => {
                    closeModal();
                    gameState.buffs.permanent.push({ type: 'exp_bonus', name: 'æ¯æ¬¡åšå®éªŒåˆ†æ•°-2', value: -2, permanent: true });
                    addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤æœåŠ¡å™¨çªç„¶åäº† - å‚¬å¯¼å¸ˆå¿«ä¿®', 'å¯¼å¸ˆæ¯æ¬¡åäº†å°±å¸®ä½ é‡å¯ï¼Œæ°¸ä¹…debuff-æ¯æ¬¡åšå®éªŒåˆ†æ•°-2');
                    updateAllUI();
                    updateBuffs();
                }},
                { text: 'ä¸¾æŠ¥åŒé—¨æŒ–çŸ¿', class: 'btn-warning', action: () => {
                    addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤æœåŠ¡å™¨çªç„¶åäº† - ä¸¾æŠ¥åŒé—¨ç”¨æœåŠ¡å™¨æŒ–çŸ¿', 'åŒé—¨è´Ÿè´£ä¿®å¥½äº†ï¼Œç¤¾äº¤èƒ½åŠ›-2');
                    closeModal();
                    changeSocial(-2);
                }},
                { text: 'è‡ªå·±é‡è£…ç³»ç»Ÿ', class: 'btn-info', action: () => {
                    closeModal();
                    const baseSanCost = -3;
                    const actualSanCost = getActualSanChange(baseSanCost);
                    const sanText = actualSanCost !== baseSanCost ? `SANå€¼${actualSanCost}ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰` : `SANå€¼${actualSanCost}`;
                    
                    if (Math.random() < 0.5) {
                        addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤æœåŠ¡å™¨çªç„¶åäº† - è‡ªå·±å°è¯•é‡è£…ç³»ç»Ÿ', `è´¹åŠ²å‘¨æŠ˜ä¿®å¥½äº†ï¼Œ${sanText}`);
                    } else {
                        changeSocial(-1);
                        gameState.buffs.temporary.push({ type: 'exp_bonus', name: 'ä¸‹æ¬¡å®éªŒæ€»åˆ†Ã·2', value: 0.5, multiply: true, permanent: false });  // â˜…â˜…â˜… æ”¹ä¸ºé™¤2 â˜…â˜…â˜…
                        addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤æœåŠ¡å™¨çªç„¶åäº† - è‡ªå·±å°è¯•é‡è£…ç³»ç»Ÿ', `æœåŠ¡å™¨æ•°æ®å¿˜äº†å¤‡ä»½äº†ï¼Œä¸´æ—¶debuff-ä¸‹æ¬¡å®éªŒåˆ†æ•°Ã—0ï¼Œç¤¾äº¤èƒ½åŠ›-1ï¼Œ${sanText}`);
                        updateBuffs();
                    }
                    changeSan(baseSanCost);
                }},
                { text: 'æ·˜å®æ‰¾äººä¿®ç†', class: 'btn-danger', action: () => {
                    closeModal();
                    if (Math.random() < 0.5) {
                        addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤æœåŠ¡å™¨çªç„¶åäº† - æ·˜å®æ‰¾äººä¿®ç†', 'é‡åˆ°é«˜æ‰‹ä¿®å¥½äº†ï¼Œé‡‘å¸-2');
                        changeGold(-2);
                    } else {
                        const baseSanCost = -2;
                        const actualSanCost = getActualSanChange(baseSanCost);
                        const sanText = actualSanCost !== baseSanCost ? `SANå€¼${actualSanCost}ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰` : `SANå€¼${actualSanCost}`;
                        addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤æœåŠ¡å™¨çªç„¶åäº† - æ·˜å®æ‰¾äººä¿®ç†', `é‡åˆ°æ— è‰¯å•†å®¶ä¿®äº†å¾ˆä¹…ï¼Œé‡‘å¸-4ï¼Œ${sanText}`);
                        gameState.san += actualSanCost;
                        changeGold(-4);
                    }
                }}
            ]);
        }

        function showRandomEvent14() {
            const baseSanCost = 1;
            const actualSanCost = Math.abs(getActualSanChange(-baseSanCost));
            const sanDescText = actualSanCost !== baseSanCost 
                ? `æ¯æœˆSAN-${actualSanCost}ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰` 
                : `æ¯æœˆSAN-${baseSanCost}`;
            
            showModal('ğŸ‘¨â€ğŸ“ éšæœºäº‹ä»¶', '<p>ä½ å·²ç»åˆçª¥ç§‘ç ”é—¨é“äº†ï¼Œè€ƒè™‘æŒ‡å¯¼å¸ˆå¼Ÿå¸ˆå¦¹ï¼š</p>', [
                { text: 'ç²¾åŠ›æœ‰é™ç®—äº†', class: 'btn-info', action: () => {
                    addLog('éšæœºäº‹ä»¶', 'æŒ‡å¯¼å¸ˆå¼Ÿå¸ˆå¦¹ - ç²¾åŠ›æœ‰é™ç®—äº†', 'æ— äº‹å‘ç”Ÿ');
                    closeModal();
                }},
                { text: 'æœ€è¿‘æœ‰ä¸ªideaå¯ä»¥åˆä½œä¸€æ³¢', class: 'btn-primary', action: () => {
					const baseCost = 5;
					const actualCost = Math.abs(getActualSanChange(-baseCost));
					
					let sanText = `SAN-${actualCost}`;
					if (actualCost !== baseCost) {
						sanText += `ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰`;
					}
					addLog('éšæœºäº‹ä»¶', 'æŒ‡å¯¼å¸ˆå¼Ÿå¸ˆå¦¹ - åˆä½œä¸€ä¸ªidea', `${sanText}ï¼Œç¤¾äº¤+1`);
					closeModal();
					changeSocial(1);
					changeSan(-baseCost);  // ç›´æ¥æ‰£é™¤ï¼Œå¦‚æœå˜è´Ÿä¼šè‡ªåŠ¨è§¦å‘burnoutç»“å±€
				}},
                { text: 'å±•å¼€é•¿æœŸåˆä½œ', class: 'btn-success', action: () => {
                    gameState.buffs.permanent.push({
                        type: 'mentorship',
                        name: 'æŒ‡å¯¼å¸ˆå¼Ÿå¸ˆå¦¹',
                        desc: `${sanDescText}ï¼Œæ€»å¼•ç”¨+ç§‘ç ”èƒ½åŠ›å€¼`,
                        permanent: true
                    });
                    addLog('éšæœºäº‹ä»¶', 'æŒ‡å¯¼å¸ˆå¼Ÿå¸ˆå¦¹ - å±•å¼€é•¿æœŸåˆä½œ', `${sanDescText}ï¼Œæ€»å¼•ç”¨+ç§‘ç ”èƒ½åŠ›å€¼`);
                    closeModal();
                    updateBuffs();
                }}
            ]);
        }

		function showRandomEvent15() {
			showModal('ğŸ® éšæœºäº‹ä»¶', '<p>å­¦äº†ä¸€å¤©ä½ æ‰“ç®—ç©æ¸¸æˆæ”¾æ¾ä¸€ä¸‹ã€‚</p>', [
				{ text: 'ğŸŒ² ç©æ³°æ‹‰ç‘äºš', class: 'btn-success', action: () => {
					const baseSanCost = 4;
					const actualSanCost = Math.abs(getActualSanChange(-baseSanCost));
					const sanText = actualSanCost !== baseSanCost 
						? `SANå€¼-${actualSanCost}ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰` 
						: `SANå€¼-${baseSanCost}`;
					addLog('éšæœºäº‹ä»¶', 'ç©æ¸¸æˆæ”¾æ¾ - ç©æ³°æ‹‰ç‘äºš', `ä½ å’ŒåŒå­¦åºŸå¯å¿˜é£Ÿçš„è”æœºï¼Œ${sanText}ï¼Œç¤¾äº¤èƒ½åŠ›+1`);
					closeModal();
					changeSocial(1);
					changeSan(-baseSanCost);
				}},
				{ text: 'ğŸ—¼ ç©é­”å¡”50å±‚', class: 'btn-primary', action: () => {
					const baseSanCost = 6;
					const actualSanCost = Math.abs(getActualSanChange(-baseSanCost));
					const sanText = actualSanCost !== baseSanCost 
						? `SANå€¼-${actualSanCost}ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰` 
						: `SANå€¼-${baseSanCost}`;
					addLog('éšæœºäº‹ä»¶', 'ç©æ¸¸æˆæ”¾æ¾ - ç©é­”å¡”50å±‚', `ä½ ç»å°½è„‘æ±ç»ˆäºå‡»è´¥äº†éª‘å£«é˜Ÿé•¿ï¼Œ${sanText}ï¼Œç§‘ç ”èƒ½åŠ›+1`);
					closeModal();
					changeResearch(1);
					changeSan(-baseSanCost);
				}},
				{ text: 'ğŸ“ ç©ç ”ç©¶ç”Ÿæ¨¡æ‹Ÿå™¨', class: 'btn-info', action: () => {
					addLog('éšæœºäº‹ä»¶', 'ç©æ¸¸æˆæ”¾æ¾ - ç©ç ”ç©¶ç”Ÿæ¨¡æ‹Ÿå™¨', 'æ˜¯ä¸ªè½»æ¾æ„‰å¿«çš„å°æ¸¸æˆå‘¢ï¼ŒSANå€¼+2');
					closeModal();
					changeSan(2);
				}},
				{ text: 'ğŸ‘‘ ç©ç‹è€…è£è€€', class: 'btn-warning', action: () => {
					const baseSanCost = 5;
					const actualSanCost = Math.abs(getActualSanChange(-baseSanCost));
					const sanText = actualSanCost !== baseSanCost 
						? `SANå€¼-${actualSanCost}ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰` 
						: `SANå€¼-${baseSanCost}`;
					addLog('éšæœºäº‹ä»¶', 'ç©æ¸¸æˆæ”¾æ¾ - ç©ç‹è€…è£è€€', `æˆä¸ºå°ä»£ï¼Œ${sanText}ï¼Œé‡‘å¸+2`);  // âœ… æ”¹ä¸ºåå¼•å·
					closeModal();
					changeSan(-baseSanCost);  // âœ… æ‰£SAN
					changeGold(2);            // âœ… åŠ é‡‘å¸
				}}
			]);
		}

        // ==================== æ¸¸æˆç»“å±€ ====================
        function triggerEnding(type) {
            let title, desc, emoji;
            let endingType = type;
            
            switch (type) {
				case 'isolated':
				title = 'è¢«å­¤ç«‹';
				desc = 'ä½ çš„ç¤¾äº¤èƒ½åŠ›é™ä¸ºè´Ÿæ•°ï¼Œæœ€ç»ˆè¢«åŒå­¦å’Œå¯¼å¸ˆå­¤ç«‹ï¼Œæ— æ³•ç»§ç»­å­¦ä¸š...';
				emoji = 'ğŸ˜”';
				break;
                case 'burnout': title = 'ä¸å ªé‡è´Ÿ'; desc = 'ç¹é‡çš„ç§‘ç ”å‹åŠ›å‹å®äº†ä½ ï¼Œä½ æœ€ç»ˆé€‰æ‹©äº†ç¦»å¼€...'; emoji = 'ğŸ˜¢'; break;
                case 'expelled': title = 'é€å‡ºå¸ˆé—¨'; desc = 'å¯¼å¸ˆå¯¹ä½ å½»åº•å¤±æœ›ï¼Œä½ è¢«åŠé€€äº†...'; emoji = 'ğŸ˜­'; break;
                case 'poor': title = 'ç©·å›°æ½¦å€’'; desc = 'ä½ è¿é¥­éƒ½åƒä¸èµ·äº†ï¼Œåªèƒ½å«æ¨ç¦»å¼€...'; emoji = 'ğŸ’¸'; break;
                case 'delay': title = 'å»¶æ¯•'; desc = 'ä½ æ²¡èƒ½åœ¨è§„å®šæ—¶é—´å†…å®Œæˆæ¯•ä¸šè¦æ±‚ï¼Œåªèƒ½å»¶æœŸæ¯•ä¸š...'; emoji = 'â°'; break;
                case 'quit': title = 'ä¸»åŠ¨é€€å­¦'; desc = 'ä½ å†³å®šæ”¾å¼ƒå­¦ä¸šï¼Œå¼€å¯äººç”Ÿæ–°ç¯‡ç« ...ä¹Ÿè®¸è¿™ä¹Ÿæ˜¯ä¸€ç§å‹‡æ°”ã€‚'; emoji = 'ğŸšª'; break;
				case 'master':
					// â˜…â˜…â˜… æ–°å¢ï¼šçœŸÂ·å¤§å¤šæ•°ç¡•å£«æ¯•ä¸šæ—¶æ£€æŸ¥çœŸÂ·æ„Ÿå—ç”Ÿæ´» â˜…â˜…â˜…
					if (gameState.isTrueNormal) {
						const tempAchievements = collectAchievements('master');
						const achievementCount = tempAchievements.length;
						if (achievementCount >= 10 && gameState.totalCitations < 1000) {
							title = 'çœŸÂ·æ„Ÿå—ç”Ÿæ´»';
							desc = 'ç§‘ç ”ä¸æ˜¯å…¨éƒ¨ï¼Œä½ ä½“éªŒäº†ä¸°å¯Œå¤šå½©çš„ç ”ç©¶ç”Ÿç”Ÿæ´»ã€‚';
							emoji = 'ğŸŒˆ';
							endingType = 'true_life';
							break;
						}
					}
					
					if (gameState.totalScore >= 4) { 
						title = 'ä¼˜ç§€ç¡•å£«æ¯•ä¸š'; 
						desc = 'æ­å–œï¼ä½ ä»¥ä¼˜å¼‚çš„æˆç»©å®Œæˆäº†ç¡•å£«å­¦ä¸šï¼Œæœªæ¥å¯æœŸï¼'; 
						emoji = 'ğŸŒŸ'; 
						endingType = 'excellent_master';
					} else { 
						title = 'ç¡•å£«æ¯•ä¸š'; 
						desc = 'æ­å–œï¼ä½ é¡ºåˆ©å®Œæˆäº†ç¡•å£«å­¦ä¸šï¼'; 
						emoji = 'ğŸ“'; 
					}
					break;
                case 'phd':
                    const e = getPhDEndingType();
                    title = e.title; desc = e.desc; emoji = e.emoji;
                    endingType = e.type;
                    break;
            }
			// â˜…â˜…â˜… è®°å½•åšå£«é€šå…³ï¼ˆç”¨äºè§£é”çœŸÂ·å¤§å¤šæ•°ï¼‰â˜…â˜…â˜…
			if (HARD_ENDINGS.includes(endingType)) {
				recordCharacterPhdUnlock(gameState.character, gameState.isReversed);
			}
            
            recordEnding(endingType, title);
            
            const achievements = collectAchievements(endingType);
            recordAchievements(achievements);
            
            showEndingModal(title, desc, emoji, endingType);
        }

		function getPhDEndingType() {
			const { paperA, totalCitations, bigBullCooperation, publishedPapers, isTrueNormal } = gameState;
			const totalPapers = publishedPapers.length;
			
			// â˜…â˜…â˜… çœŸå®ç»“å±€åˆ¤å®šï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰â˜…â˜…â˜…
			if (isTrueNormal) {
				// è®¡ç®—å½“å‰æˆå°±æ•°é‡ï¼ˆç”¨äºçœŸÂ·æ„Ÿå—ç”Ÿæ´»åˆ¤å®šï¼‰
				const tempAchievements = collectAchievements('phd');
				const achievementCount = tempAchievements.length;
				
				// ä¼˜å…ˆçº§1ï¼šçœŸÂ·æŠ•èº«ç§‘ç ”ï¼ˆå¼•ç”¨â‰¥1000ï¼‰
				if (totalCitations >= 1000) {
					return { type: 'true_devotion', title: 'çœŸÂ·æŠ•èº«ç§‘ç ”', desc: 'ä½ ç”¨æœ€æœ´ç´ çš„æ–¹å¼ï¼Œè¾¾åˆ°äº†ç§‘ç ”çš„å·…å³°ã€‚', emoji: 'ğŸ’«' };
				}
				
				// ä¼˜å…ˆçº§2ï¼šçœŸÂ·æ„Ÿå—ç”Ÿæ´»ï¼ˆ10ä¸ªæˆå°± + å¼•ç”¨<1000ï¼‰
				if (achievementCount >= 10 && totalCitations < 1000) {
					return { type: 'true_life', title: 'çœŸÂ·æ„Ÿå—ç”Ÿæ´»', desc: 'ç§‘ç ”ä¸æ˜¯å…¨éƒ¨ï¼Œä½ ä½“éªŒäº†ä¸°å¯Œå¤šå½©çš„ç ”ç©¶ç”Ÿç”Ÿæ´»ã€‚', emoji: 'ğŸŒˆ' };
				}
				
				// ä¼˜å…ˆçº§3ï¼šçœŸÂ·åšå£«æ¯•ä¸šï¼ˆå‘è¡¨â‰¥3ç¯‡è®ºæ–‡ï¼‰
				if (totalPapers >= 3) {
					return { type: 'true_phd', title: 'çœŸÂ·åšå£«æ¯•ä¸š', desc: 'æ²¡æœ‰ä»»ä½•å¤–æŒ‚ï¼Œä½ å‡­å€Ÿè‡ªå·±çš„åŠªåŠ›å®Œæˆäº†åšå£«å­¦ä¸šã€‚', emoji: 'ğŸŒŸ' };
				}
				
				// çœŸÂ·å¤§å¤šæ•°ä½†æœªè¾¾æˆçœŸå®ç»“å±€æ¡ä»¶ï¼Œè¿”å›æ™®é€šåšå£«ç»“å±€
				return { type: 'phd', title: 'åšå£«æ¯•ä¸š', desc: 'æ­å–œï¼ä½ é¡ºåˆ©å®Œæˆäº†åšå£«å­¦ä¸šï¼', emoji: 'ğŸ“' };
			}
			
			// åŸæœ‰ç»“å±€åˆ¤å®š
			if (paperA >= 5 && totalCitations > 2000 && bigBullCooperation) 
				return { type: 'future_academician', title: 'æœªæ¥é™¢å£«', desc: 'ä½ çš„å­¦æœ¯æˆå°±ä»¤äººç©ç›®ï¼ŒæˆåŠŸå»å¤§ç‰›ç»„å½“å‰¯æ•™æˆï¼', emoji: 'ğŸ‘‘' };
			if (paperA >= 5 && totalCitations > 1000 && bigBullCooperation) 
				return { type: 'academic_star', title: 'å­¦æœ¯ä¹‹æ˜Ÿ', desc: 'ä½ çš„æ‰åè¢«å¤§ç‰›èµè¯†ï¼ŒæˆåŠŸå»å¤§ç‰›ç»„é£å‡ç–¾èµ°ï¼', emoji: 'â­' };
			if (paperA >= 5 && totalCitations > 1000) 
				return { type: 'become_advisor', title: 'æˆ‘å°±æ˜¯å¯¼å¸ˆ', desc: 'æ­å–œï¼ä½ æˆåŠŸç•™æ ¡æˆä¸ºå‰¯æ•™æˆï¼', emoji: 'ğŸ‘¨â€ğŸ«' };
			if (paperA >= 4 && totalCitations > 500) 
				return { type: 'green_pepper', title: 'é’æ¤’', desc: 'æ­å–œï¼ä½ æˆåŠŸç•™æ ¡é£å‡ç–¾èµ°ï¼', emoji: 'ğŸŒ¶ï¸' };
			if (paperA >= 3) 
				return { type: 'excellent_phd', title: 'ä¼˜ç§€åšå£«æ¯•ä¸š', desc: 'æ­å–œï¼ä½ ä»¥ä¼˜å¼‚çš„æˆç»©å®Œæˆäº†åšå£«å­¦ä¸šï¼', emoji: 'ğŸ†' };
			return { type: 'phd', title: 'åšå£«æ¯•ä¸š', desc: 'æ­å–œï¼ä½ é¡ºåˆ©å®Œæˆäº†åšå£«å­¦ä¸šï¼', emoji: 'ğŸ“' };
		}

		function collectAchievements(endingType) {
			const a = [];
			
			// å®šä¹‰é¡ºåˆ©æ¯•ä¸šçš„ç»“å±€ç±»å‹
			const graduationEndings = ['master', 'excellent_master', 'phd', 'excellent_phd', 'green_pepper', 'become_advisor', 'academic_star', 'future_academician', 'true_phd', 'true_devotion', 'true_life'];
			const isGraduated = graduationEndings.includes(endingType);
			
			// æ‰€æœ‰æˆå°±éƒ½éœ€è¦é¡ºåˆ©æ¯•ä¸šæ‰èƒ½å–å¾—
			if (!isGraduated) {
				return a;
			}
			
			if (gameState.hasLover) a.push('ğŸ’• å–œç»“è‰¯ç¼˜');
			if (gameState.gold >= 30) a.push('ğŸ’° å®¶è´¢ä¸‡è´¯');
			if (gameState.research > 15 && gameState.social > 15 && gameState.favor > 15 && gameState.gold > 15) a.push('â¬¡ å…­è¾¹å½¢æˆ˜å£«');
			if (gameState.research >= 20) a.push('ğŸ† è¯ºå¥–é€‰æ‰‹');
			if (gameState.social >= 20) a.push('ğŸŒ¸ äº¤é™…èŠ±');
			if (gameState.favor >= 20) a.push('ğŸ¤ é“æ†å¸ˆç”Ÿ');
			if (gameState.san >= 20) a.push('âš¡ ç²¾åŠ›æ»¡æ»¡');
			if (gameState.rejectedCount === 0 && gameState.publishedPapers.length > 0) a.push('ğŸ¯ ç™¾å‘ç™¾ä¸­');
			if (gameState.teaBreakCount >= 3) a.push('â˜• æˆ‘çˆ±èŒ¶æ­‡');
			if (gameState.tourCount >= 3) a.push('ğŸ–ï¸ å…¬è´¹æ—…æ¸¸');
			if (gameState.publishedPapers.length >= 10) a.push('ğŸ¤– è®ºæ–‡æœºå™¨');
			if (gameState.totalCitations >= 1000) a.push('ğŸ“š åƒå¼•å¤§ä½¬');
			if (gameState.coffeeBoughtCount >= gameState.totalMonths && gameState.totalMonths > 0) a.push('â˜• å’–å•¡çˆ±å¥½è€…');
			if (gameState.triggeredBuffTypes && ALL_BUFF_TYPES.every(type => gameState.triggeredBuffTypes.includes(type))) a.push('âœ¨ Buffä¹‹ç¥');
			if (gameState.achievementConditions && gameState.achievementConditions.highScorePaper) a.push('ğŸ“œ é«˜åˆ†è®ºæ–‡');
			if (gameState.achievementConditions && gameState.achievementConditions.unanimousImprovement) a.push('ğŸ€ å¹¸è¿å„¿');
			if (gameState.achievementConditions && gameState.achievementConditions.allBadReviewers) a.push('ğŸ˜­ å€’éœ‰è›‹');
			if (gameState.paperA > 0 && gameState.paperB === 0 && gameState.paperC === 0) a.push('ğŸ» æ›²é«˜å’Œå¯¡');
			if (gameState.san === 0 && gameState.gold === 0) a.push('ğŸ’ª å…¨åŠ›ä»¥èµ´');
			const requiredTypes = [
				'A-Poster', 'A-Oral', 'A-Best Paper',
				'B-Poster', 'B-Oral', 'B-Best Paper',
				'C-Poster', 'C-Oral', 'C-Best Paper'
			];
			if (gameState.paperTypeCollection && requiredTypes.every(type => gameState.paperTypeCollection.has(type))) a.push('ğŸ† å…¨æ”¶é›†');
			if (gameState.rejectedCount >= 5) a.push('ğŸ‘Š è¶Šæˆ˜è¶Šå‹‡');
			if (gameState.achievementConditions && gameState.achievementConditions.rejectedPhdTwice) a.push('ğŸ§  äººé—´æ¸…é†’');
			if (gameState.maxConcurrentReviews >= 4) a.push('ğŸ”¥ ç«åŠ›å…¨å¼€');
			if (gameState.achievementConditions && gameState.achievementConditions.tripleRejected) a.push('ğŸš é£Ÿä¹‹æ— å‘³');
			if (gameState.achievementConditions && gameState.achievementConditions.bought5GPUs) a.push('ğŸ¤– æœºæ¢°é£å‡');
			if (gameState.achievementConditions && gameState.achievementConditions.fullFurnitureSet) a.push('ğŸ›‹ï¸ å…¨å¥—å®¶å…·');
			if (gameState.achievementConditions && gameState.achievementConditions.phdRequirementMetEarly) a.push('ğŸ§’ å¤©æ‰å°‘å¹´');
			
			const hasCPaperOver100 = gameState.publishedPapers.some(p => p.grade === 'C' && p.citations > 100);
			if (hasCPaperOver100) a.push('ğŸ’ æ— æ³•åŸ‹æ²¡');
			if (gameState.publishedPapers.length > 0 && gameState.publishedPapers[0].citations > 200) a.push('ğŸ”” ä¸é¸£åˆ™å·²');
			const stats = [gameState.research, gameState.favor, gameState.social];
			const maxStat = Math.max(...stats);
			const minStat = Math.min(...stats);
			if (maxStat - minStat > 12) a.push('ğŸ“Š ä¸¥é‡åç§‘');
			if ((gameState.workCount || 0) >= 10) a.push('ğŸ’¼ æ‰“å·¥ç‹‚äºº');
			if ((gameState.readCount || 0) >= 20) a.push('ğŸ“– çˆ±çœ‹è®ºæ–‡');
			if (gameState.achievementConditions && gameState.achievementConditions.twoInOneConference) a.push('ğŸ¹ ä¸€ç®­åŒé›•');
			
			return a;
		}

		function showEndingModal(title, desc, emoji, endingType) {
			currentEndingData = { title, desc, emoji, endingType };

			const achievements = collectAchievements(endingType);
			// â˜…â˜…â˜… ä¿å­˜ç©å®¶æœ¬åœ°è¾¾æˆè®°å½• â˜…â˜…â˜…
			savePlayerRecord(endingType, achievements, gameState.isReversed);
			const locked = ALL_ACHIEVEMENTS.filter(x => !achievements.includes(x));
			
			let modeLabel;
			if (gameState.isTrueNormal) {
				modeLabel = '<span style="color:#d68910;font-size:0.8rem;background:linear-gradient(135deg,rgba(255,215,0,0.3),rgba(255,140,0,0.3));padding:2px 8px;border-radius:10px;">âœ¨ çœŸå®æ¨¡å¼</span>';
			} else if (gameState.isReversed) {
				modeLabel = '<span style="color:#9b59b6;font-size:0.8rem;">ğŸŒ‘ é€†ä½æ¨¡å¼</span>';
			} else {
				modeLabel = '<span style="color:#6c5ce7;font-size:0.8rem;">â˜€ï¸ æ­£ä½æ¨¡å¼</span>';
			}

			const failedEndings = ['quit', 'burnout', 'expelled', 'poor', 'delay'];
			const successEndings = ['master', 'excellent_master', 'phd', 'excellent_phd', 'green_pepper', 'become_advisor', 'academic_star', 'future_academician'];
			const isFailed = failedEndings.includes(endingType);
			const isSuccess = successEndings.includes(endingType);

			let html = `<div style="text-align:center;margin-bottom:15px;">
				<div style="font-size:3rem;margin-bottom:10px;">${emoji}</div>
				<div style="font-size:1.3rem;font-weight:700;color:var(--primary-color);margin-bottom:8px;">${title}</div>
				${modeLabel}
				<div style="color:var(--text-secondary);line-height:1.5;font-size:0.9rem;margin-top:8px;">${desc}</div>
			</div>`;
			
			if (isFailed) {
				html += `
				<div style="background:linear-gradient(135deg,rgba(253,121,168,0.15),rgba(108,92,231,0.15));border-radius:12px;padding:12px;margin-bottom:12px;text-align:center;">
					<div style="font-size:0.9rem;margin-bottom:8px;">ğŸ’ª ä¸è¦ç°å¿ƒï¼ç§‘ç ”ä¹‹è·¯æ¼«æ¼«ï¼Œæ¥æ—¥æ–¹é•¿~</div>
					<a href="http://xhslink.com/o/8czcPQfNziK" target="_blank" 
					   style="display:inline-block;padding:8px 16px;background:linear-gradient(135deg,var(--accent-color),var(--primary-color));color:white;text-decoration:none;border-radius:20px;font-size:0.85rem;font-weight:500;transition:all 0.3s ease;"
					   onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(253,121,168,0.4)'"
					   onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none'">
						<i class="fas fa-palette"></i> ä½œè€…å‘ä½ ä¼ æˆç§‘ç ”ç»˜å›¾å¿ƒå¾—
					</a>
				</div>`;
			}
			
			if (isSuccess) {
				html += `
				<div style="background:linear-gradient(135deg,rgba(0,184,148,0.15),rgba(108,92,231,0.15));border-radius:12px;padding:12px;margin-bottom:12px;text-align:center;">
					<div style="font-size:0.9rem;margin-bottom:8px;">ğŸ‰ æ­å–œæ¯•ä¸šï¼æ–°çš„å¾ç¨‹å³å°†å¼€å§‹~</div>
					  <a href="http://xhslink.com/o/AC6pvxkgOhv" target="_blank" 
						 style="display:inline-block;padding:8px 16px;background:linear-gradient(135deg,var(--success-color),var(--primary-color));color:white;text-decoration:none;border-radius:20px;font-size:0.85rem;font-weight:500;transition:all 0.3s ease;"
						 onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(0,184,148,0.4)'"
						 onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none'">
						<i class="fas fa-building"></i> ä½œè€…è¯šé‚€ä½ æ¥ä¸Šæµ·AI Labå®ä¹ 
					  </a>
				</div>`;
			}

			// â˜…â˜…â˜… çœŸå®ç»“å±€ç‰¹æ®Šå¯„è¯­ â˜…â˜…â˜…
			const isTrueEnding = endingType === 'true_phd' || endingType === 'true_devotion';
			if (isTrueEnding) {
				html += `
				<div style="background:linear-gradient(135deg,rgba(255,215,0,0.2),rgba(255,140,0,0.2));border-radius:12px;padding:15px;margin-bottom:12px;border:2px solid rgba(255,140,0,0.5);">
					<div style="text-align:center;margin-bottom:12px;">
						<div style="font-size:1.5rem;margin-bottom:8px;">ğŸŠ</div>
						<div style="font-size:1.1rem;font-weight:700;color:#d68910;">æ­å–œä½ è¾¾æˆäº†çœŸå®ç»“å±€ï¼</div>
					</div>
					
					<div style="background:white;border-radius:10px;padding:15px;font-size:0.85rem;line-height:1.8;">
						<div style="margin-bottom:12px;">
							<strong style="color:#d68910;">ğŸ“ ä½œè€…å¯„è¯­ï¼š</strong>
						</div>
						
						<div style="margin-bottom:10px;">
							<strong>å¦‚æœä½ æ˜¯åœ¨è¯»ç ”ç©¶ç”Ÿï¼š</strong><br>
							ç¥ä½ åœ¨è¯»ç ”è·¯ä¸Šä¸€å¸†é£é¡ºï¼Œä¸å¿˜åˆå¿ƒï¼Œèªæ˜å‹‡æ•¢æœ‰åŠ›æ°”ï¼ğŸ’ª
						</div>
						
						<div style="margin-bottom:10px;">
							<strong>å¦‚æœä½ è¿˜æ²¡å¼€å§‹è¯»ç ”/è¯»åšï¼š</strong><br>
							è¿™æ˜¯ä¸€ä¸ªåˆæ­¥ä½“ä¼šç ”ç©¶ç”Ÿç”Ÿæ´»çš„æ¸¸æˆï¼Œå¥½å¥½æƒ³æƒ³è‡ªå·±æƒ³è¦çš„æ˜¯ä»€ä¹ˆã€‚ğŸ¤”
						</div>
						
						<div>
							<strong>å¦‚æœä½ å·²ç»æ¯•ä¸šäº†ï¼š</strong><br>
							é‚£å°±æƒå½“é‡æ¸©é‚£æ®µé€å»çš„æ—¶å…‰å§ï¼Œåœ¨æ¸¸æˆé‡Œå¤§æ€å››æ–¹ï¼ğŸ®
						</div>
					</div>
					
					<div style="text-align:center;margin-top:12px;font-size:0.8rem;color:var(--text-secondary);">
						â€”â€” æ„Ÿè°¢æ¸¸ç©ã€Šç ”ç©¶ç”Ÿæ¨¡æ‹Ÿå™¨ã€‹â€”â€”
					</div>
				</div>`;
			}
			
			// â˜…â˜…â˜… æ–°å¢ï¼šé‡å¼€æŒ‰é’®æ”¾åœ¨ç”Ÿæ¶¯æ€»ç»“ä¸Šæ–¹ â˜…â˜…â˜…
			html += `
			<div style="text-align:center;margin-bottom:12px;">
				<button class="btn btn-primary" onclick="restartGame()" style="padding:10px 30px;font-size:1rem;">
					<i class="fas fa-redo"></i> ğŸ”„ æˆ‘è¦é‡å¼€
				</button>
			</div>`;
			
			html += `<div style="background:var(--light-bg);border-radius:12px;padding:15px;margin-bottom:12px;">
				<div style="font-weight:600;margin-bottom:10px;color:var(--primary-color);font-size:0.9rem;"><i class="fas fa-scroll"></i> ç”Ÿæ¶¯æ€»ç»“</div>
				<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:6px;font-size:0.8rem;">
					<div>ğŸ‘¤ è§’è‰²ï¼š${gameState.characterName}</div>
					<div>ğŸ“… å†æ—¶ï¼š${gameState.totalMonths}ä¸ªæœˆ</div>
					<div>ğŸ“Š ç§‘ç ”åˆ†ï¼š${gameState.totalScore}</div>
					<div>ğŸ“ è®ºæ–‡æ•°ï¼š${gameState.publishedPapers.length}</div>
					<div>ğŸ…°ï¸ Aç±»ï¼š${gameState.paperA} ğŸ…±ï¸ Bç±»ï¼š${gameState.paperB}</div>
					<div>Â©ï¸ Cç±»ï¼š${gameState.paperC} ğŸ“ˆ å¼•ç”¨ï¼š${gameState.totalCitations}</div>
					<div>ğŸ§  ç§‘ç ”ï¼š${gameState.research} ğŸ‘¥ ç¤¾äº¤ï¼š${gameState.social}</div>
					<div>â¤ï¸ å¥½æ„Ÿï¼š${gameState.favor} ğŸ’° é‡‘å¸ï¼š${gameState.gold}</div>
				</div>
			</div>`;

			if (achievements.length > 0) {
				html += `
					<div class="achievements-container" 
						 style="margin: 15px 0; background: ${gameState.isReversed ? 'rgba(93, 44, 111, 0.3)' : 'rgba(253, 203, 110, 0.1)'}; 
								border-radius: 12px; 
								padding: 12px;
								border: 1px solid ${gameState.isReversed ? '#8e44ad' : '#fdcb6e'};">
						<div style="font-weight: 600; 
								   margin-bottom: 8px; 
								   color: ${gameState.isReversed ? '#d7bde2' : '#d68910'};">
							<i class="fas fa-trophy"></i> è¾¾æˆæˆå°± (${achievements.length})
						</div>
						<div style="display: flex; flex-wrap: wrap; gap: 6px;">
							${achievements.map(a => `
								<span class="achievement-item" onclick="showSingleAchievementRequirement('${a}')">
									${a}
								</span>
							`).join('')}
						</div>
					</div>`;
			}

			if (locked.length > 0) {
				html += `
					<div style="background: var(--light-bg); border-radius: 12px; padding: 12px; margin-bottom: 10px;">
						<div style="font-weight: 600; margin-bottom: 8px; color: var(--text-secondary); font-size: 0.85rem; display: flex; align-items: center; justify-content: space-between;">
							<span><i class="fas fa-lock"></i> æœªè§£é”æˆå°±</span>
							<span style="font-size: 0.7rem; cursor: pointer;" onclick="showAchievementRequirements()">
								<i class="fas fa-question-circle"></i> æŸ¥çœ‹è¦æ±‚
							</span>
						</div>
						<div style="display: flex; flex-wrap: wrap; gap: 6px;">
							${locked.map(a => `
								<span class="locked-achievement-tag" onclick="showSingleAchievementRequirement('${a}')">
									${a}
								</span>
							`).join('')}
						</div>
					</div>`;
			}

			html += `<div style="background:linear-gradient(135deg,rgba(108,92,231,0.1),rgba(162,155,254,0.1));border-radius:12px;padding:12px;margin-bottom:10px;cursor:pointer;" onclick="showEndingStatistics()">
				<div style="font-weight:600;margin-bottom:8px;color:var(--primary-color);font-size:0.85rem;display:flex;align-items:center;justify-content:space-between;">
					<span><i class="fas fa-globe"></i> å…¨çƒç»Ÿè®¡</span>
					<span style="font-size:0.7rem;color:var(--text-secondary);">
						<i class="fas fa-chevron-right"></i> ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…
					</span>
				</div>
				<div style="font-size:0.8rem;color:var(--text-secondary);">
					æŸ¥çœ‹æ‰€æœ‰ç»“å±€å’Œæˆå°±çš„å…¨çƒè¾¾æˆç»Ÿè®¡
				</div>
			</div>`;

			// â˜…â˜…â˜… ä¿®æ”¹ï¼šåº•éƒ¨ä¸å†ä¼ å…¥æŒ‰é’®ï¼Œæ”¹ä¸ºç©ºæ•°ç»„ â˜…â˜…â˜…
			showModal('ğŸ® æ¸¸æˆç»“æŸ', html, []);
		}
        
		function showSingleAchievementRequirement(name) {
			const req = ACHIEVEMENT_REQUIREMENTS[name];
			if (!req) return;
			
			// âœ… ä¿®å¤ï¼šæ­£ç¡®åˆ¤æ–­æˆå°±æ˜¯å¦è¾¾æˆ
			const currentAchievements = currentEndingData 
				? collectAchievements(currentEndingData.endingType) 
				: [];
			const achieved = currentAchievements.includes(name);
            
            showModal('ğŸ† æˆå°±è¦æ±‚', `
                <div style="text-align:center;margin-bottom:15px;">
                    <div style="font-size:2rem;margin-bottom:10px;">${name.split(' ')[0]}</div>
                    <div style="font-size:1.1rem;font-weight:600;">${name}</div>
                    ${achieved ? '<div style="color:var(--success-color);margin-top:5px;">âœ“ å·²è¾¾æˆ</div>' : ''}
                </div>
                <div style="background:var(--light-bg);border-radius:10px;padding:15px;">
                    <div style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:5px;">è¾¾æˆæ¡ä»¶ï¼š</div>
                    <div style="font-size:0.9rem;">${req}</div>
                </div>
            `, [{ 
                text: currentEndingData ? 'è¿”å›ç»“å±€' : 'å…³é—­', 
                class: 'btn-primary', 
                action: () => {
                    closeModal();
                    if (currentEndingData) {
                        setTimeout(() => {
                            showEndingModal(currentEndingData.title, currentEndingData.desc, currentEndingData.emoji, currentEndingData.endingType);
                        }, 100);
                    }
                }
            }]);
        }

        async function showEndingStatistics() {
            showModal('ğŸ“Š å…¨çƒç»Ÿè®¡', '<div style="text-align:center;padding:20px;"><i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...</div>', []);
            
            const stats = await getGlobalStats();
            
            if (!stats) {
                showModal('ğŸ“Š å…¨çƒç»Ÿè®¡', '<p style="text-align:center;color:var(--text-secondary);">æš‚æ— ç»Ÿè®¡æ•°æ®</p>', 
                    [{ 
                        text: currentEndingData ? 'è¿”å›ç»“å±€' : 'å…³é—­', 
                        class: 'btn-primary', 
                        action: () => {
                            closeModal();
                            if (currentEndingData) {
                                setTimeout(() => {
                                    showEndingModal(currentEndingData.title, currentEndingData.desc, currentEndingData.emoji, currentEndingData.endingType);
                                }, 100);
                            }
                        }
                    }]);
                return;
            }
            
            const mode = gameState.isReversed ? 'reversed' : 'normal';
            const modeStats = stats[mode];
            const modeIcon = gameState.isReversed ? 'ğŸŒ‘' : 'â˜€ï¸';
            const modeName = gameState.isReversed ? 'é€†ä½' : 'æ­£ä½';
            
            let totalEndings = 0;
            for (const count of Object.values(modeStats.endings)) {
                totalEndings += count;
            }
            
            let html = `
                <div style="margin-bottom:15px;text-align:center;">
                    <span style="font-size:0.9rem;color:var(--primary-color);font-weight:600;">${modeIcon} ${modeName}æ¨¡å¼ç»Ÿè®¡</span>
                    <span style="font-size:0.75rem;color:var(--text-secondary);margin-left:10px;">å…± ${totalEndings} å±€æ¸¸æˆ</span>
                </div>
                
                <div style="margin-bottom:15px;">
                    <div style="font-weight:600;font-size:0.85rem;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
                        <span>ğŸ“œ ç»“å±€ç»Ÿè®¡</span>
                        <span style="font-size:0.7rem;color:var(--text-secondary);cursor:pointer;" onclick="showEndingRequirements()">
                            <i class="fas fa-question-circle"></i> æŸ¥çœ‹è¦æ±‚
                        </span>
                    </div>
                    <div style="display:flex;flex-direction:column;gap:6px;max-height:180px;overflow-y:auto;">
            `;
            
            for (const [type, name] of Object.entries(ENDING_NAMES)) {
                const count = modeStats.endings[type] || 0;
                const percent = totalEndings > 0 ? ((count / totalEndings) * 100).toFixed(1) : 0;
                const barWidth = totalEndings > 0 ? (count / totalEndings) * 100 : 0;
                
                html += `
                    <div style="padding:6px 8px;background:var(--light-bg);border-radius:6px;cursor:pointer;" onclick="showSingleEndingRequirement('${type}')">
                        <div style="display:flex;justify-content:space-between;font-size:0.8rem;margin-bottom:3px;">
                            <span>${name}</span>
                            <span style="color:var(--primary-color);font-weight:600;">${count} <span style="color:var(--text-secondary);font-weight:400;">(${percent}%)</span></span>
                        </div>
                        <div style="height:4px;background:var(--border-color);border-radius:2px;overflow:hidden;">
                            <div style="width:${barWidth}%;height:100%;background:var(--primary-color);border-radius:2px;"></div>
                        </div>
                    </div>
                `;
            }
            
            html += `</div></div>
                
                <div>
                    <div style="font-weight:600;font-size:0.85rem;margin-bottom:8px;">ğŸ† æˆå°±ç»Ÿè®¡</div>
                    <div style="display:flex;flex-wrap:wrap;gap:6px;max-height:120px;overflow-y:auto;">
            `;
            
            for (const ach of ALL_ACHIEVEMENTS) {
                const count = modeStats.achievements[ach] || 0;
                const opacity = count > 0 ? '1' : '0.5';
                html += `
                    <div style="padding:4px 8px;background:var(--light-bg);border-radius:6px;font-size:0.7rem;opacity:${opacity};cursor:pointer;" onclick="showSingleAchievementRequirement('${ach}')">
                        ${ach} <strong style="color:var(--success-color);">${count}</strong>
                    </div>
                `;
            }
            
            html += '</div></div>';
            
            showModal('ğŸ“Š å…¨çƒç»Ÿè®¡', html, [{ 
                text: currentEndingData ? 'è¿”å›ç»“å±€' : 'å…³é—­', 
                class: 'btn-primary', 
                action: () => {
                    closeModal();
                    if (currentEndingData) {
                        setTimeout(() => {
                            showEndingModal(currentEndingData.title, currentEndingData.desc, currentEndingData.emoji, currentEndingData.endingType);
                        }, 100);
                    }
                }
            }]);
        }

        function showEndingRequirements() {
            let html = '<div style="max-height:60vh;overflow-y:auto;">';
            
            for (const [type, name] of Object.entries(ENDING_NAMES)) {
                const req = ENDING_REQUIREMENTS[type] || 'æœªçŸ¥';
                html += `
                    <div style="padding:10px;background:var(--light-bg);border-radius:8px;margin-bottom:8px;">
                        <div style="font-weight:600;font-size:0.85rem;margin-bottom:4px;">${name}</div>
                        <div style="font-size:0.75rem;color:var(--text-secondary);">${req}</div>
                    </div>
                `;
            }
            html += '</div>';
            
            showModal('ğŸ“œ ç»“å±€è¾¾æˆè¦æ±‚', html, [{ 
                text: currentEndingData ? 'è¿”å›ç»“å±€' : 'å…³é—­', 
                class: 'btn-primary', 
                action: () => {
                    closeModal();
                    if (currentEndingData) {
                        setTimeout(() => {
                            showEndingModal(currentEndingData.title, currentEndingData.desc, currentEndingData.emoji, currentEndingData.endingType);
                        }, 100);
                    }
                }
            }]);
        }

        function showSingleEndingRequirement(type) {
            const name = ENDING_NAMES[type];
            const req = ENDING_REQUIREMENTS[type] || 'æœªçŸ¥';
            
            showModal('ğŸ“œ ç»“å±€è¦æ±‚', `
                <div style="text-align:center;margin-bottom:15px;">
                    <div style="font-size:1.1rem;font-weight:600;">${name}</div>
                </div>
                <div style="background:var(--light-bg);border-radius:10px;padding:15px;">
                    <div style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:5px;">è¾¾æˆæ¡ä»¶ï¼š</div>
                    <div style="font-size:0.9rem;">${req}</div>
                </div>
            `, [{ 
                text: currentEndingData ? 'è¿”å›ç»“å±€' : 'å…³é—­', 
                class: 'btn-primary', 
                action: () => {
                    closeModal();
                    if (currentEndingData) {
                        setTimeout(() => {
                            showEndingModal(currentEndingData.title, currentEndingData.desc, currentEndingData.emoji, currentEndingData.endingType);
                        }, 100);
                    }
                }
            }]);
        }
		
		function showAchievementRequirements() {
			let html = '<div style="max-height:60vh;overflow-y:auto;">';
			
			// âœ… ä¿®å¤ï¼šä½¿ç”¨å½“å‰ç»“å±€æ•°æ®åˆ¤æ–­æˆå°±
			const currentAchievements = currentEndingData 
				? collectAchievements(currentEndingData.endingType) 
				: [];
			
			for (const [name, req] of Object.entries(ACHIEVEMENT_REQUIREMENTS)) {
				const achieved = currentAchievements.includes(name);
				html += `
					<div style="padding:10px;background:var(--light-bg);border-radius:8px;margin-bottom:8px;${achieved ? 'border-left:3px solid var(--success-color);' : ''}">
						<div style="font-weight:600;font-size:0.85rem;margin-bottom:4px;">
							${name} ${achieved ? '<span style="color:var(--success-color);">âœ“</span>' : ''}
						</div>
						<div style="font-size:0.75rem;color:var(--text-secondary);">${req}</div>
					</div>
				`;
			}
			html += '</div>';
			
			showModal('ğŸ† æˆå°±è¾¾æˆè¦æ±‚', html, [{ 
				text: currentEndingData ? 'è¿”å›ç»“å±€' : 'å…³é—­', 
				class: 'btn-primary', 
				action: () => {
					closeModal();
					if (currentEndingData) {
						setTimeout(() => {
							showEndingModal(currentEndingData.title, currentEndingData.desc, 
										   currentEndingData.emoji, currentEndingData.endingType);
						}, 100);
					}
				}
			}]);
		}
        // ==================== é‡å¼€ç¡®è®¤ ====================
        function confirmRestart() {
            if (gameState.totalMonths > 0) {
                showModal('âš ï¸ ç¡®è®¤é‡å¼€', 
                    '<p>ç¡®å®šè¦æ”¾å¼ƒå½“å‰æ¸¸æˆå—ï¼Ÿ</p><p style="color:var(--danger-color);font-size:0.85rem;">è¿™å°†è§¦å‘"ä¸»åŠ¨é€€å­¦"ç»“å±€ï¼</p>', 
                    [
                        { text: 'ç»§ç»­æ¸¸æˆ', class: 'btn-info', action: closeModal },
                        { text: 'ğŸ˜¢ ä¸»åŠ¨é€€å­¦', class: 'btn-danger', action: () => {
                            closeModal();
                            triggerEnding('quit');
                        }}
                    ]
                );
            } else {
                restartGame();
            }
        }

        function restartGame() {
            closeModal();
            
            currentEndingData = null;
            
            document.getElementById('mobile-quick-bar').classList.remove('game-active');
            
            selectedCharacter = null;
            document.querySelectorAll('.character-card').forEach(c => c.classList.remove('selected'));
            
            document.getElementById('start-btn').disabled = true;
            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('start-screen').classList.remove('hidden');

            const wasReversed = gameState.isReversed;
            if (wasReversed) {
                document.getElementById('normal-mode-btn').classList.remove('active');
                document.getElementById('reversed-mode-btn').classList.add('active', 'reversed-active');
            } else {
                document.body.classList.remove('reversed-theme');
                isReversedMode = false;
                document.getElementById('normal-mode-btn').classList.add('active');
                document.getElementById('reversed-mode-btn').classList.remove('active', 'reversed-active');
            }

            renderCharacterGrid();
            loadGlobalStatsDisplay();
			// â˜… è¿”å›å¼€å§‹é¡µé¢æ—¶é‡æ–°æŸ¥è¯¢ç»Ÿè®¡
			updateAllStatsDisplay();
        }

		// ==================== Metaè¿›åº¦ç³»ç»Ÿ ====================
		const META_KEY = 'graduateSimulatorMeta';
		const GAME_START_DATE = '2025-12-15T00:00:00Z';

		function getLocalMeta() {
			const meta = localStorage.getItem(META_KEY);
			return meta ? JSON.parse(meta) : { normal: {}, reversed: {} };
		}

		function saveLocalMeta(meta) {
			localStorage.setItem(META_KEY, JSON.stringify(meta));
		}

		function getCharacterLocalRecord(characterId, isReversed) {
			const meta = getLocalMeta();
			const mode = isReversed ? 'reversed' : 'normal';
			return meta[mode]?.[characterId] || { maxScore: 0, maxCitations: 0, maxAchievements: 0 };
		}

		function updateLocalMeta(character, isReversed, score, citations, achievementCount, endingType) {
			// â˜…â˜…â˜… æ–°å¢ï¼šåªæœ‰å¥½ç»“å±€æ‰ç»Ÿè®¡ â˜…â˜…â˜…
			const goodEndings = ['master', 'excellent_master', 'phd', 'excellent_phd', 'green_pepper', 'become_advisor', 'academic_star', 'future_academician', 'true_phd', 'true_devotion', 'true_life'];
			if (!goodEndings.includes(endingType)) {
				console.log('éæ¯•ä¸šç»“å±€ï¼Œä¸æ›´æ–°æœ¬åœ°æœ€é«˜è®°å½•');
				return null;
			}
			
			const meta = getLocalMeta();
			const mode = isReversed ? 'reversed' : 'normal';
			
			if (!meta[mode]) meta[mode] = {};
			if (!meta[mode][character]) {
				meta[mode][character] = { maxScore: 0, maxCitations: 0, maxAchievements: 0 };
			}
			
			const record = meta[mode][character];
			if (score > record.maxScore) record.maxScore = score;
			if (citations > record.maxCitations) record.maxCitations = citations;
			if (achievementCount > record.maxAchievements) record.maxAchievements = achievementCount;
			
			saveLocalMeta(meta);
			return record;
		}

		// å…¨çƒè§’è‰²è®°å½•ç¼“å­˜
		let globalCharacterRecords = null;
		let globalCharacterRecordsTime = 0;

		async function getGlobalCharacterRecords() {
			// å…ˆæ£€æŸ¥æœ¬åœ°ç¼“å­˜
			const cached = getLocalCache(CACHE_KEYS.CHARACTER_RECORDS);
			if (cached) {
				console.log('ä½¿ç”¨æœ¬åœ°ç¼“å­˜çš„è§’è‰²è®°å½•');
				globalCharacterRecords = cached;
				globalCharacterRecordsTime = Date.now();
				return cached;
			}
			
			if (!supabase) return null;
			
			try {
				const records = {
					normal: {},
					reversed: {}
				};
				
				// â˜…â˜…â˜… ä¿®æ”¹ï¼šæ·»åŠ  true-normal çš„ç»Ÿè®¡ â˜…â˜…â˜…
				const allCharIds = [...characters.map(c => c.id), 'true-normal'];
				
				allCharIds.forEach(charId => {
					records.normal[charId] = {
						today: { maxScore: 0, maxCitations: 0, maxAchievements: 0 },
						history: { maxScore: 0, maxCitations: 0, maxAchievements: 0 }
					};
					// çœŸÂ·å¤§å¤šæ•°åªæœ‰æ­£ä½æ¨¡å¼
					if (charId !== 'true-normal') {
						records.reversed[charId] = {
							today: { maxScore: 0, maxCitations: 0, maxAchievements: 0 },
							history: { maxScore: 0, maxCitations: 0, maxAchievements: 0 }
						};
					}
				});
				
				characters.forEach(char => {
					records.normal[char.id] = {
						today: { maxScore: 0, maxCitations: 0, maxAchievements: 0 },
						history: { maxScore: 0, maxCitations: 0, maxAchievements: 0 }
					};
					records.reversed[char.id] = {
						today: { maxScore: 0, maxCitations: 0, maxAchievements: 0 },
						history: { maxScore: 0, maxCitations: 0, maxAchievements: 0 }
					};
				});
				
				// è®¡ç®—ä»Šæ—¥èµ·å§‹æ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´0ç‚¹ï¼‰
				const now = new Date();
				const beijingTime = new Date(now.getTime() + 8 * 60 * 60 * 1000);
				const year = beijingTime.getUTCFullYear();
				const month = beijingTime.getUTCMonth();
				const day = beijingTime.getUTCDate();
				const todayBeijingMidnightUTC = new Date(Date.UTC(year, month, day) - 8 * 60 * 60 * 1000);
				let todayStr = todayBeijingMidnightUTC.toISOString();
				
				if (todayStr < GAME_START_DATE) {
					todayStr = GAME_START_DATE;
				}
				
				// â˜…â˜…â˜… ä½¿ç”¨åˆ†é¡µè·å–æœ€è¿‘10000æ¡å†å²æ•°æ® â˜…â˜…â˜…
				const historyData = await fetchRecentRowsWithFilter(
					'game_endings',
					'character, is_reversed, total_score, total_citations, achievements_count, total_months, paper_a, paper_b, paper_c, ending_type',
					{ column: 'created_at', operator: 'gte', value: GAME_START_DATE },
					10000
				);
				
				// â˜…â˜…â˜… ä½¿ç”¨åˆ†é¡µè·å–ä»Šæ—¥æ•°æ® â˜…â˜…â˜…
				const todayData = await fetchRecentRowsWithFilter(
					'game_endings',
					'character, is_reversed, total_score, total_citations, achievements_count, total_months, paper_a, paper_b, paper_c, ending_type',
					{ column: 'created_at', operator: 'gte', value: todayStr },
					10000
				);
				
				// è¿‡æ»¤å‡½æ•°
				const filterValid = (row) => {
					if (!row.character || typeof row.is_reversed !== 'boolean') return false;
					
					// â˜…â˜…â˜… æ–°å¢ï¼šåªç»Ÿè®¡å¥½ç»“å±€ â˜…â˜…â˜…
					const goodEndings = ['master', 'excellent_master', 'phd', 'excellent_phd', 'green_pepper', 'become_advisor', 'academic_star', 'future_academician', 'true_phd', 'true_devotion', 'true_life'];
					if (!goodEndings.includes(row.ending_type)) return false;
					// â˜…â˜…â˜… æ–°å¢ï¼šè¿‡æ»¤è¶…è¿‡20000å¼•ç”¨çš„å¼‚å¸¸æ•°æ® â˜…â˜…â˜…
					if ((row.total_citations || 0) > 20000) return false;
					
					const paperA = row.paper_a || 0;
					const paperB = row.paper_b || 0;
					const paperC = row.paper_c || 0;
					const totalScore = row.total_score || 0;
					const totalMonths = row.total_months || 0;
					const totalPapers = paperA + paperB + paperC;
					
					const expectedScore = paperA * 4 + paperB * 2 + paperC * 1;
					if (totalScore !== expectedScore) return false;
					
					const phdEndings = ['phd', 'excellent_phd', 'green_pepper', 'become_advisor', 'academic_star', 'future_academician', 'true_phd', 'true_devotion'];
					const isPhd = phdEndings.includes(row.ending_type);
					
					if (isPhd) {
						if (totalMonths > 61 || totalPapers >= 22) return false;
					} else {
						if (totalMonths > 36 || totalPapers >= 12) return false;
					}
					
					return true;
				};
				
				const validHistoryData = historyData.filter(filterValid);
				const validTodayData = todayData.filter(filterValid);
				
				console.log(`ğŸ“Š å†å²æœ‰æ•ˆæ•°æ®: ${validHistoryData.length}/${historyData.length}`);
				console.log(`ğŸ“Š ä»Šæ—¥æœ‰æ•ˆæ•°æ®: ${validTodayData.length}/${todayData.length}`);
				
				// å¤„ç†å†å²æ•°æ®
				validHistoryData.forEach(row => {
					const mode = row.is_reversed ? 'reversed' : 'normal';
					const charId = row.character;
					
					if (!records[mode][charId]) return;
					
					const record = records[mode][charId].history;
					if ((row.total_score || 0) > record.maxScore) record.maxScore = row.total_score || 0;
					if ((row.total_citations || 0) > record.maxCitations) record.maxCitations = row.total_citations || 0;
					if ((row.achievements_count || 0) > record.maxAchievements) record.maxAchievements = row.achievements_count || 0;
				});
				
				// å¤„ç†ä»Šæ—¥æ•°æ®
				validTodayData.forEach(row => {
					const mode = row.is_reversed ? 'reversed' : 'normal';
					const charId = row.character;
					
					if (!records[mode][charId]) return;
					
					const record = records[mode][charId].today;
					if ((row.total_score || 0) > record.maxScore) record.maxScore = row.total_score || 0;
					if ((row.total_citations || 0) > record.maxCitations) record.maxCitations = row.total_citations || 0;
					if ((row.achievements_count || 0) > record.maxAchievements) record.maxAchievements = row.achievements_count || 0;
				});
				
				// æˆåŠŸåæ‰ç¼“å­˜
				globalCharacterRecords = records;
				globalCharacterRecordsTime = Date.now();
				setLocalCache(CACHE_KEYS.CHARACTER_RECORDS, records);
				
				console.log('âœ… å…¨çƒè§’è‰²è®°å½•åŠ è½½å®Œæˆ');
				
				return records;
			} catch (e) {
				console.error('è·å–å…¨çƒè§’è‰²è®°å½•å¤±è´¥:', e);
				return globalCharacterRecords || null;
			}
		}

		// â˜…â˜…â˜… å¸¦ç­›é€‰æ¡ä»¶çš„åˆ†é¡µè·å– â˜…â˜…â˜…
		async function fetchRecentRowsWithFilter(tableName, selectColumns, filter, maxRows = 10000) {
			if (!supabase) return [];
			
			let allData = [];
			let from = 0;
			const pageSize = 1000;
			
			while (allData.length < maxRows) {
				const remaining = maxRows - allData.length;
				const limit = Math.min(pageSize, remaining);
				
				let query = supabase
					.from(tableName)
					.select(selectColumns)
					.order('created_at', { ascending: false });
				
				// åº”ç”¨ç­›é€‰æ¡ä»¶
				if (filter) {
					if (filter.operator === 'gte') {
						query = query.gte(filter.column, filter.value);
					} else if (filter.operator === 'lte') {
						query = query.lte(filter.column, filter.value);
					} else if (filter.operator === 'eq') {
						query = query.eq(filter.column, filter.value);
					}
				}
				
				const { data, error } = await query.range(from, from + limit - 1);
				
				if (error) {
					console.error(`è·å– ${tableName} æ•°æ®å¤±è´¥:`, error);
					throw error;
				}
				
				if (!data || data.length === 0) break;
				
				allData = allData.concat(data);
				
				if (data.length < limit) break;
				
				from += limit;
			}
			
			return allData;
		}

        // ==================== å­˜æ¡£ç³»ç»Ÿ ====================
        const SAVE_KEY = 'graduateSimulatorSaves';
        const MAX_SAVES = 5;

        function getSaves() {
            const saves = localStorage.getItem(SAVE_KEY);
            return saves ? JSON.parse(saves) : [];
        }
		
		// æ£€æŸ¥å­˜æ¡£æ˜¯å¦åœ¨æœ‰æ•ˆæ—¶é—´èŒƒå›´å†…ï¼ˆåŒ—äº¬æ—¶é—´2025å¹´12æœˆ13æ—¥8ç‚¹ä¹‹åï¼‰
		function isValidSaveTime(saveTime) {
			if (!saveTime) return false;
			
			// æˆªæ­¢æ—¶é—´ï¼šåŒ—äº¬æ—¶é—´ 2025-12-13 08:00
			const cutoffTimeStr = '2025-12-15 08:00';
			
			// ç›´æ¥å­—ç¬¦ä¸²æ¯”è¾ƒï¼ˆå­˜æ¡£æ—¶é—´æ ¼å¼: "YYYY-MM-DD HH:mm"ï¼‰
			return saveTime >= cutoffTimeStr;
		}

		// è·å–æœ‰æ•ˆå­˜æ¡£ï¼ˆè¿‡æ»¤æ—§å­˜æ¡£ï¼‰
		function getValidSaves() {
			const saves = getSaves();
			return saves.map(save => {
				if (save && !isValidSaveTime(save.saveTime)) {
					return null; // æ—§å­˜æ¡£è§†ä¸ºç©º
				}
				return save;
			});
		}
		

        function saveSaves(saves) {
            localStorage.setItem(SAVE_KEY, JSON.stringify(saves));
        }

		function openSaveModal() {
			const saves = getSaves();
			let html = '<div style="margin-bottom:15px;color:var(--text-secondary);font-size:0.85rem;">é€‰æ‹©å­˜æ¡£æ§½ä½ï¼ˆæœ€å¤š5ä¸ªï¼‰ï¼š</div>';
			
			for (let i = 0; i < MAX_SAVES; i++) {
				const save = saves[i];
				const isOldSave = save && !isValidSaveTime(save.saveTime);
				
				if (save && !isOldSave) {
					// æœ‰æ•ˆå­˜æ¡£
					const modeIcon = save.isReversed ? 'ğŸŒ‘' : 'â˜€ï¸';
					html += `
						<div style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--light-bg);border-radius:8px;margin-bottom:8px;">
							<div style="flex:1;">
								<div style="font-weight:600;font-size:0.9rem;">${modeIcon} æ§½ä½ ${i + 1}: ${save.characterName}</div>
								<div style="font-size:0.75rem;color:var(--text-secondary);">
									${save.degree === 'master' ? 'ç¡•å£«' : 'åšå£«'} | ç¬¬${save.year}å¹´ç¬¬${save.month}æœˆ | ç§‘ç ”åˆ†:${save.totalScore}
								</div>
								<div style="font-size:0.7rem;color:var(--text-secondary);">
									ä¿å­˜äº: ${save.saveTime}
								</div>
							</div>
							<button class="btn btn-primary" style="padding:5px 12px;font-size:0.75rem;" onclick="saveGame(${i})">
								<i class="fas fa-save"></i> è¦†ç›–
							</button>
						</div>`;
				} else {
					// ç©ºæ§½ä½æˆ–æ—§å­˜æ¡£ï¼ˆæ˜¾ç¤ºä¸ºå¯æ–°å»ºï¼‰
					const oldSaveHint = isOldSave ? '<div style="font-size:0.65rem;color:var(--danger-color);">æ—§ç‰ˆå­˜æ¡£å·²å¤±æ•ˆ</div>' : '';
					html += `
						<div style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--light-bg);border-radius:8px;margin-bottom:8px;opacity:0.7;">
							<div style="flex:1;">
								<div style="font-weight:600;font-size:0.9rem;">æ§½ä½ ${i + 1}: ç©º</div>
								<div style="font-size:0.75rem;color:var(--text-secondary);">æš‚æ— å­˜æ¡£</div>
								${oldSaveHint}
							</div>
							<button class="btn btn-success" style="padding:5px 12px;font-size:0.75rem;" onclick="saveGame(${i})">
								<i class="fas fa-plus"></i> æ–°å»º
							</button>
						</div>`;
				}
			}
			
			showModal('ğŸ’¾ å­˜æ¡£', html, [{ text: 'å–æ¶ˆ', class: 'btn-info', action: closeModal }]);
		}

		function openLoadModal() {
			const saves = getValidSaves(); // ä½¿ç”¨è¿‡æ»¤åçš„å­˜æ¡£
			
			if (saves.filter(s => s).length === 0) {
				showModal('ğŸ“‚ è¯»æ¡£', '<p style="text-align:center;color:var(--text-secondary);">æš‚æ— æœ‰æ•ˆå­˜æ¡£</p><p style="text-align:center;font-size:0.8rem;color:var(--danger-color);">æ³¨ï¼š2025-12-15 08:00å‰çš„å­˜æ¡£å·²å¤±æ•ˆ</p>', 
					[{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			let html = '<div style="margin-bottom:15px;color:var(--text-secondary);font-size:0.85rem;">é€‰æ‹©è¦è¯»å–çš„å­˜æ¡£ï¼š</div>';
			
			for (let i = 0; i < MAX_SAVES; i++) {
				const save = saves[i];
				if (save) {
					const modeIcon = save.isReversed ? 'ğŸŒ‘' : 'â˜€ï¸';
					html += `
						<div style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--light-bg);border-radius:8px;margin-bottom:8px;">
							<div style="flex:1;">
								<div style="font-weight:600;font-size:0.9rem;">${modeIcon} æ§½ä½ ${i + 1}: ${save.characterName}</div>
								<div style="font-size:0.75rem;color:var(--text-secondary);">
									${save.degree === 'master' ? 'ç¡•å£«' : 'åšå£«'} | ç¬¬${save.year}å¹´ç¬¬${save.month}æœˆ | ç§‘ç ”åˆ†:${save.totalScore}
								</div>
								<div style="font-size:0.7rem;color:var(--text-secondary);">
									Aç±»:${save.paperA} Bç±»:${save.paperB} Cç±»:${save.paperC} | ä¿å­˜äº: ${save.saveTime}
								</div>
							</div>
							<button class="btn btn-primary" style="padding:5px 12px;font-size:0.75rem;" onclick="loadGame(${i})">
								<i class="fas fa-folder-open"></i> è¯»å–
							</button>
							<button class="btn btn-danger" style="padding:5px 12px;font-size:0.75rem;" onclick="deleteSave(${i})">
								<i class="fas fa-trash"></i>
							</button>
						</div>`;
				}
			}
			
			showModal('ğŸ“‚ è¯»æ¡£', html, [{ text: 'å–æ¶ˆ', class: 'btn-info', action: closeModal }]);
		}

		function openLoadModalFromStart() {
			const saves = getValidSaves(); // ä½¿ç”¨è¿‡æ»¤åçš„å­˜æ¡£
			
			if (saves.filter(s => s).length === 0) {
				showModal('ğŸ“‚ è¯»æ¡£', '<p style="text-align:center;color:var(--text-secondary);">æš‚æ— æœ‰æ•ˆå­˜æ¡£</p><p style="text-align:center;font-size:0.8rem;color:var(--danger-color);">æ³¨ï¼š2025-12-15 08:00å‰çš„å­˜æ¡£å·²å¤±æ•ˆ</p>', 
					[{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			let html = '<div style="margin-bottom:15px;color:var(--text-secondary);font-size:0.85rem;">é€‰æ‹©è¦è¯»å–çš„å­˜æ¡£ï¼š</div>';
			
			for (let i = 0; i < MAX_SAVES; i++) {
				const save = saves[i];
				if (save) {
					const modeIcon = save.isReversed ? 'ğŸŒ‘' : 'â˜€ï¸';
					html += `
						<div style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--light-bg);border-radius:8px;margin-bottom:8px;">
							<div style="flex:1;">
								<div style="font-weight:600;font-size:0.9rem;">${modeIcon} æ§½ä½ ${i + 1}: ${save.characterName}</div>
								<div style="font-size:0.75rem;color:var(--text-secondary);">
									${save.degree === 'master' ? 'ç¡•å£«' : 'åšå£«'} | ç¬¬${save.year}å¹´ç¬¬${save.month}æœˆ | ç§‘ç ”åˆ†:${save.totalScore}
								</div>
								<div style="font-size:0.7rem;color:var(--text-secondary);">
									Aç±»:${save.paperA} Bç±»:${save.paperB} Cç±»:${save.paperC} | ä¿å­˜äº: ${save.saveTime}
								</div>
							</div>
							<button class="btn btn-primary" style="padding:5px 12px;font-size:0.75rem;" onclick="loadGame(${i})">
								<i class="fas fa-folder-open"></i> è¯»å–
							</button>
						</div>`;
				}
			}
			
			showModal('ğŸ“‚ è¯»æ¡£', html, [{ text: 'å–æ¶ˆ', class: 'btn-info', action: closeModal }]);
		}

        function saveGame(slot) {
            const saves = getSaves();
            const now = new Date();
            const timeStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            
            const shopState = shopItems.map(item => ({
                id: item.id,
                bought: item.bought || false,
                boughtThisMonth: item.boughtThisMonth || false
            }));
            
            const papersCopy = gameState.papers.map(paper => {
                if (paper === null) return null;
                return {
                    title: paper.title,
                    ideaScore: paper.ideaScore,
                    expScore: paper.expScore,
                    writeScore: paper.writeScore,
                    reviewing: paper.reviewing || false,
                    reviewMonths: paper.reviewing ? Math.min(4, Math.max(0, paper.reviewMonths)) : 0,
                    submittedGrade: paper.submittedGrade || null,
                    submittedScore: paper.submittedScore || 0,
					submittedMonth: paper.submittedMonth || null,
					conferenceInfo: paper.conferenceInfo || null,
					conferenceLocation: paper.conferenceLocation || null,
					submittedIdeaScore: paper.submittedIdeaScore || null,
					submittedExpScore: paper.submittedExpScore || null,
					submittedWriteScore: paper.submittedWriteScore || null,
                };
            });
            
            const publishedPapersCopy = gameState.publishedPapers.map(paper => ({
                title: paper.title,
                grade: paper.grade,
                acceptType: paper.acceptType,
                score: paper.score,
                citations: paper.citations,
                monthsSincePublish: paper.monthsSincePublish || 0,
                promotions: paper.promotions ? { ...paper.promotions } : { arxiv: false, github: false, xiaohongshu: false, quantumbit: false },
                citationMultiplier: paper.citationMultiplier || 1,
				conferenceInfo: paper.conferenceInfo || null,
				conferenceLocation: paper.conferenceLocation || null,
				pendingCitationFraction: paper.pendingCitationFraction || 0
            }));
            
            const buffsCopy = {
                permanent: gameState.buffs.permanent.map(b => ({ ...b })),
                temporary: gameState.buffs.temporary.map(b => ({ ...b }))
            };
            
            const saveData = {
                character: gameState.character,
                characterName: gameState.characterName,
                degree: gameState.degree,
                year: gameState.year,
                month: gameState.month,
                totalMonths: gameState.totalMonths,
                maxYears: gameState.maxYears,
                san: gameState.san,
                sanMax: gameState.sanMax,
                research: gameState.research,
                social: gameState.social,
                favor: gameState.favor,
                gold: gameState.gold,
                
                paperA: gameState.paperA,
                paperB: gameState.paperB,
                paperC: gameState.paperC,
                totalScore: gameState.totalScore,
                totalCitations: gameState.totalCitations,
                publishedPapers: publishedPapersCopy,
                paperSlots: gameState.paperSlots,
                papers: papersCopy,
                
                buffs: buffsCopy,
                
                actionUsed: gameState.actionUsed,
                readCount: gameState.readCount,
				workCount: gameState.workCount || 0,
                firstPaperAccepted: gameState.firstPaperAccepted,
                firstAPaperAccepted: gameState.firstAPaperAccepted,
                hasLover: gameState.hasLover,
                loverType: gameState.loverType,
                bigBullCooperation: gameState.bigBullCooperation,
                rejectedCount: gameState.rejectedCount,
                teaBreakCount: gameState.teaBreakCount,
                tourCount: gameState.tourCount,
                metBigBull: gameState.metBigBull,
                metBeautiful: gameState.metBeautiful,
                metSmart: gameState.metSmart,
                bigBullDeepCount: gameState.bigBullDeepCount,
                beautifulCount: gameState.beautifulCount,
                smartCount: gameState.smartCount,
                
                availableRandomEvents: [...gameState.availableRandomEvents],
                usedRandomEvents: [...gameState.usedRandomEvents],
                triggeredBuffTypes: [...(gameState.triggeredBuffTypes || [])],
                coffeeBoughtCount: gameState.coffeeBoughtCount || 0,
                goldSpentTotal: gameState.goldSpentTotal || 0,
                
                isReversed: gameState.isReversed,
                reversedAwakened: gameState.reversedAwakened,
                blockedResearchGains: gameState.blockedResearchGains,
                goldLocked: gameState.goldLocked,
                statsLocked: gameState.statsLocked,
                
                pendingPhDChoice: gameState.pendingPhDChoice || false,
                pendingConference: gameState.pendingConference || null,
                enterpriseCount: gameState.enterpriseCount || 0,
                ailabInternship: gameState.ailabInternship || false,
                firstBestPaperAccepted: gameState.firstBestPaperAccepted || false,
                
                // â˜…â˜…â˜… æ–°å¢ï¼šé€†ä½å¯Œå¯æ•Œå›½çš„ä¿å­˜å­—æ®µ â˜…â˜…â˜…
                lastResetMonth: gameState.lastResetMonth || 0,
				socialAwakened: gameState.socialAwakened || false,
				reviewerDistribution: gameState.reviewerDistribution || null,
				badmintonMonth: gameState.badmintonMonth || -1,
				ideaClickCount: gameState.ideaClickCount || 0,
				expClickCount: gameState.expClickCount || 0,
				writeClickCount: gameState.writeClickCount || 0,
				consecutiveAccepts: gameState.consecutiveAccepts || 0,
				lastIdeaScore: gameState.lastIdeaScore || 0,
				lastExpScore: gameState.lastExpScore || 0,
				lastWriteScore: gameState.lastWriteScore || 0,
				// åœ¨ saveData å¯¹è±¡ä¸­æ·»åŠ ä»¥ä¸‹å­—æ®µ
				hiddenAwakened: gameState.hiddenAwakened || false,
				hiddenAwakenType: gameState.hiddenAwakenType || null,
				actionLimit: gameState.actionLimit || 1,
				actionCount: gameState.actionCount || 0,
				noDecay: gameState.noDecay || false,
				hasSeniorHelpSkill: gameState.hasSeniorHelpSkill || false,
				usedSeniorHelpSkill: gameState.usedSeniorHelpSkill || false,
				hasTeacherHelpSkill: gameState.hasTeacherHelpSkill || false,
				usedTeacherHelpSkill: gameState.usedTeacherHelpSkill || false,
				monthlyWageBonus: gameState.monthlyWageBonus || 0,
				nextIdeaResearchBonus: gameState.nextIdeaResearchBonus || 0,
				nextIdeaBonusSource: gameState.nextIdeaBonusSource || null,
				isTrueNormal: gameState.isTrueNormal || false,
				researchMax: gameState.researchMax || 20,
				socialMax: gameState.socialMax || 20,
				favorMax: gameState.favorMax || 20,

                
                rejectedPapers: {...(gameState.rejectedPapers || {})},
                maxConcurrentReviews: gameState.maxConcurrentReviews || 0,
                phdOpportunitiesRejected: gameState.phdOpportunitiesRejected || 0,
                gpuServersBought: gameState.gpuServersBought || 0,
                furnitureBought: {...(gameState.furnitureBought || {})},
                achievementConditions: {...(gameState.achievementConditions || {})},
                paperTypeCollection: gameState.paperTypeCollection ? [...gameState.paperTypeCollection] : [],
                
                // â˜…â˜…â˜… æ–°å¢ï¼šæŠ•ç¨¿ç»Ÿè®¡ç›¸å…³ â˜…â˜…â˜…
                submissionStats: gameState.submissionStats,
                pendingConferenceInfo: gameState.pendingConferenceInfo,                
                shopState: shopState,
                saveTime: timeStr
            };
            
            saves[slot] = saveData;
            saveSaves(saves);
            closeModal();
            
            showModal('âœ… å­˜æ¡£æˆåŠŸ', `<p style="text-align:center;">æ¸¸æˆå·²ä¿å­˜åˆ°æ§½ä½ ${slot + 1}</p>`, 
                [{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
            
            addLog('ç³»ç»Ÿ', 'æ¸¸æˆå·²å­˜æ¡£', `æ§½ä½ ${slot + 1}`);
        }

        function loadGame(slot) {
            const saves = getSaves();
            const save = saves[slot];
            
            if (!save) {
                showModal('âŒ è¯»æ¡£å¤±è´¥', '<p>è¯¥å­˜æ¡£ä¸å­˜åœ¨ï¼</p>', 
                    [{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
                return;
            }
            
            showModal('âš ï¸ ç¡®è®¤è¯»æ¡£', 
                `<p>ç¡®å®šè¦è¯»å–æ§½ä½ ${slot + 1} çš„å­˜æ¡£å—ï¼Ÿ</p><p style="color:var(--danger-color);font-size:0.85rem;">å½“å‰æ¸¸æˆè¿›åº¦å°†ä¸¢å¤±ï¼</p>`, 
                [
                    { text: 'å–æ¶ˆ', class: 'btn-info', action: closeModal },
                    { text: 'ç¡®å®šè¯»å–', class: 'btn-primary', action: () => {
                        if (save.shopState) {
                            save.shopState.forEach(savedItem => {
                                const item = shopItems.find(i => i.id === savedItem.id);
                                if (item) {
                                    item.bought = savedItem.bought;
                                    item.boughtThisMonth = savedItem.boughtThisMonth;
                                }
                            });
                        }
                        
                        gameState = {
                            character: save.character,
                            characterName: save.characterName,
                            degree: save.degree,
                            year: save.year,
                            month: save.month,
                            totalMonths: save.totalMonths,
                            maxYears: save.maxYears,
                            san: save.san,
                            sanMax: save.sanMax,
                            research: save.research,
                            social: save.social,
                            favor: save.favor,
                            gold: save.gold,
                            
                            paperA: save.paperA,
                            paperB: save.paperB,
                            paperC: save.paperC,
                            totalScore: save.totalScore,
                            totalCitations: save.totalCitations,
							publishedPapers: save.publishedPapers.map(p => ({ 
								...p, 
								promotions: p.promotions ? { ...p.promotions } : { arxiv: false, github: false, xiaohongshu: false, quantumbit: false },
								citationMultiplier: p.citationMultiplier || 1,
								monthsSincePublish: p.monthsSincePublish || 0,
								// â˜…â˜…â˜… æ–°å¢å­—æ®µ â˜…â˜…â˜…
								pendingCitationFraction: p.pendingCitationFraction || 0,
								conferenceInfo: p.conferenceInfo || null,
								conferenceLocation: p.conferenceLocation || null
							})),
                            paperSlots: save.paperSlots,
                            
							papers: save.papers.map(p => {
								if (p === null) return null;
								return {
									title: p.title,
									ideaScore: p.ideaScore,
									expScore: p.expScore,
									writeScore: p.writeScore,
									reviewing: p.reviewing || false,
									reviewMonths: p.reviewing ? Math.min(4, Math.max(0, p.reviewMonths || 0)) : 0,
									submittedGrade: p.submittedGrade || null,
									submittedScore: p.submittedScore || 0,
									// â˜…â˜…â˜… æ–°å¢å­—æ®µ â˜…â˜…â˜…
									submittedMonth: p.submittedMonth || null,
									conferenceInfo: p.conferenceInfo || null,
									conferenceLocation: p.conferenceLocation || null
								};
							}),
                            
                            buffs: {
                                permanent: save.buffs.permanent.map(b => ({ ...b })),
                                temporary: save.buffs.temporary.map(b => ({ ...b }))
                            },
                            
                            actionUsed: save.actionUsed,
                            readCount: save.readCount,
							workCount: save.workCount || 0,
                            firstPaperAccepted: save.firstPaperAccepted,
                            firstAPaperAccepted: save.firstAPaperAccepted,
                            hasLover: save.hasLover,
                            loverType: save.loverType,
                            bigBullCooperation: save.bigBullCooperation,
                            rejectedCount: save.rejectedCount,
                            teaBreakCount: save.teaBreakCount,
                            tourCount: save.tourCount,
                            metBigBull: save.metBigBull,
                            metBeautiful: save.metBeautiful,
                            metSmart: save.metSmart,
                            bigBullDeepCount: save.bigBullDeepCount,
                            beautifulCount: save.beautifulCount,
                            smartCount: save.smartCount,
                            enterpriseCount: save.enterpriseCount || 0,
                            ailabInternship: save.ailabInternship || false,
                            firstBestPaperAccepted: save.firstBestPaperAccepted || false,
                            goldSpentTotal: save.goldSpentTotal || 0,
                            
                            availableRandomEvents: save.availableRandomEvents ? [...save.availableRandomEvents] : [],
                            usedRandomEvents: save.usedRandomEvents ? [...save.usedRandomEvents] : [],
                            triggeredBuffTypes: save.triggeredBuffTypes ? [...save.triggeredBuffTypes] : [],
                            coffeeBoughtCount: save.coffeeBoughtCount || 0,
                            
                            pendingPhDChoice: save.pendingPhDChoice || false,
                            pendingConference: save.pendingConference || null,
                            
                            isReversed: save.isReversed || false,
                            reversedAwakened: save.reversedAwakened || false,
                            blockedResearchGains: save.blockedResearchGains || 0,
                            
                            
                            // â˜…â˜…â˜… æ–°å¢ï¼šé€†ä½å¯Œå¯æ•Œå›½çš„è¯»æ¡£å­—æ®µ â˜…â˜…â˜…
                            lastResetMonth: save.lastResetMonth || 0,
							socialAwakened: save.socialAwakened || false,
							reviewerDistribution: save.reviewerDistribution || null,
							badmintonMonth: save.badmintonMonth || -1,
							ideaClickCount: save.ideaClickCount || 0,
							expClickCount: save.expClickCount || 0,
							writeClickCount: save.writeClickCount || 0,
							consecutiveAccepts: save.consecutiveAccepts || 0,
							// åœ¨ gameState èµ‹å€¼ä¸­æ·»åŠ ä»¥ä¸‹å­—æ®µ
							hiddenAwakened: save.hiddenAwakened || false,
							hiddenAwakenType: save.hiddenAwakenType || null,
							actionLimit: save.actionLimit || 1,
							actionCount: save.actionCount || 0,
							noDecay: save.noDecay || false,
							hasSeniorHelpSkill: save.hasSeniorHelpSkill || false,
							usedSeniorHelpSkill: save.usedSeniorHelpSkill || false,
							hasTeacherHelpSkill: save.hasTeacherHelpSkill || false,
							usedTeacherHelpSkill: save.usedTeacherHelpSkill || false,
							monthlyWageBonus: save.monthlyWageBonus || 0,
							nextIdeaResearchBonus: save.nextIdeaResearchBonus || 0,
							nextIdeaBonusSource: save.nextIdeaBonusSource || null,
							isTrueNormal: save.isTrueNormal || false,
							researchMax: save.researchMax || 20,
							socialMax: save.socialMax || 20,
							favorMax: save.favorMax || 20,
				
                            
                            rejectedPapers: save.rejectedPapers ? {...save.rejectedPapers} : {},
                            furnitureBought: save.furnitureBought ? {...save.furnitureBought} : {
                                chair: false,
                                monitor: false,
                                keyboard: false
                            },
                            achievementConditions: save.achievementConditions ? {...save.achievementConditions} : {
                                highScorePaper: false,
                                unanimousImprovement: false,
                                allBadReviewers: false,
                                tripleRejected: false,
                                bought5GPUs: false,
                                fullFurnitureSet: false,
                                phdRequirementMetEarly: false,
                                rejectedPhdTwice: false
                            },
                            maxConcurrentReviews: save.maxConcurrentReviews || 0,
                            phdOpportunitiesRejected: save.phdOpportunitiesRejected || 0,
                            gpuServersBought: save.gpuServersBought || 0,
                            paperTypeCollection: new Set(save.paperTypeCollection || []),
                            // â˜…â˜…â˜… æ–°å¢ï¼šæŠ•ç¨¿ç»Ÿè®¡ç›¸å…³ â˜…â˜…â˜…
                            submissionStats: save.submissionStats || null,
                            pendingConferenceInfo: save.pendingConferenceInfo || null
                        };
                        
                        if (!gameState.availableRandomEvents || gameState.availableRandomEvents.length === 0) {
                            if (!gameState.usedRandomEvents || gameState.usedRandomEvents.length === 0) {
                                resetRandomEventPool();
                            }
                        }
                        
                        if (gameState.isReversed) {
                            document.body.classList.add('reversed-theme');
                            isReversedMode = true;
                        } else {
                            document.body.classList.remove('reversed-theme');
                            isReversedMode = false;
                        }
                        
                        document.getElementById('start-screen').classList.add('hidden');
                        document.getElementById('game-screen').style.display = 'block';
                        document.getElementById('mobile-quick-bar').classList.add('game-active');
                        
                        updateAllUI();
                        renderPaperSlots();
                        
                        closeModal();
                        addLog('ç³»ç»Ÿ', 'è¯»å–å­˜æ¡£æˆåŠŸ', `æ§½ä½ ${slot + 1}`);
                        
                        let pendingReviews = [];
                        gameState.papers.forEach((paper, idx) => {
                            if (paper && paper.reviewing && paper.reviewMonths <= 0) {
                                pendingReviews.push(idx);
                            }
                        });

                        if (pendingReviews.length > 0) {
                            pendingReviews.forEach((idx, i) => {
                                setTimeout(() => {
                                    if (gameState.papers[idx] && gameState.papers[idx].reviewing) {
                                        processPaperResult(idx);
                                    }
                                }, 500 + i * 300);
                            });
                        } else {
                            let reviewingInfo = '';
                            gameState.papers.forEach((paper, idx) => {
                                if (paper && paper.reviewing) {
                                    reviewingInfo += `<br>â€¢ æ§½ä½${idx + 1}: ${paper.submittedGrade}ç±»å®¡ç¨¿ä¸­ï¼Œå‰©ä½™${paper.reviewMonths}æœˆ`;
                                }
                            });
                            
                            const modeText = gameState.isReversed ? 'ï¼ˆé€†ä½æ¨¡å¼ï¼‰' : 'ï¼ˆæ­£ä½æ¨¡å¼ï¼‰';
                            showModal('âœ… è¯»æ¡£æˆåŠŸ', 
                                `<p style="text-align:center;">å·²è¯»å–æ§½ä½ ${slot + 1} çš„å­˜æ¡£ ${modeText}</p>
                                 <p style="font-size:0.85rem;color:var(--text-secondary);">
                                    å½“å‰è¿›åº¦ï¼šç¬¬${gameState.year}å¹´ç¬¬${gameState.month}æœˆ<br>
                                    ç§‘ç ”åˆ†ï¼š${gameState.totalScore}
                                    ${reviewingInfo ? '<br><strong>å®¡ç¨¿ä¸­çš„è®ºæ–‡ï¼š</strong>' + reviewingInfo : ''}
                                 </p>`, 
                                [{ text: 'ç»§ç»­æ¸¸æˆ', class: 'btn-primary', action: closeModal }]);
                        }
                    }}
                ]
            );
        }

        function deleteSave(slot) {
            showModal('âš ï¸ ç¡®è®¤åˆ é™¤', 
                `<p>ç¡®å®šè¦åˆ é™¤æ§½ä½ ${slot + 1} çš„å­˜æ¡£å—ï¼Ÿ</p><p style="color:var(--danger-color);font-size:0.85rem;">æ­¤æ“ä½œä¸å¯æ¢å¤ï¼</p>`, 
                [
                    { text: 'å–æ¶ˆ', class: 'btn-info', action: closeModal },
                    { text: 'ç¡®å®šåˆ é™¤', class: 'btn-danger', action: () => {
                        const saves = getSaves();
                        saves[slot] = null;
                        saveSaves(saves);
                        closeModal();
                        openLoadModal();
                    }}
                ]
            );
        }
		
        // ==================== å¼¹çª—ç³»ç»Ÿ ====================
        let modalCallbacks = [];

        function showModal(title, content, buttons) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-content').innerHTML = content;
            modalCallbacks = buttons.map(b => b.action);
            document.getElementById('modal-buttons').innerHTML = buttons.map((b, i) =>
                `<button class="btn ${b.class}" onclick="modalCallbacks[${i}]()">${b.text}</button>`
            ).join('');
            document.getElementById('modal-overlay').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('active');
        }

        function showPaperSelectModal(action, papers, callback) {
            let html = `<p style="font-size:0.9rem;">è¯·é€‰æ‹©è¦è¿›è¡Œ"${action}"çš„è®ºæ–‡ï¼š</p><div style="display:flex;flex-direction:column;gap:8px;margin-top:10px;">`;
            papers.forEach(({ paper, index }) => {
                const total = paper.ideaScore + paper.expScore + paper.writeScore;
                html += `<div style="padding:12px;background:var(--light-bg);border-radius:10px;cursor:pointer;border:2px solid transparent;transition:all 0.3s;"
                    onmouseover="this.style.borderColor='var(--primary-color)'"
                    onmouseout="this.style.borderColor='transparent'"
                    onclick="paperSelectCallback(${index})">
                    <div style="font-weight:600;margin-bottom:5px;font-size:0.85rem;">${paper.title.substring(0, 30)}${paper.title.length > 30 ? '...' : ''}</div>
                    <div style="display:flex;gap:10px;font-size:0.75rem;color:var(--text-secondary);">
                        <span>ğŸ’¡${paper.ideaScore}</span>
                        <span>ğŸ”¬${paper.expScore}</span>
                        <span>âœï¸${paper.writeScore}</span>
                        <span style="color:var(--primary-color);font-weight:600;">æ€»åˆ†:${total}</span>
                    </div>
                </div>`;
            });
            html += '</div>';
            window.paperSelectCallback = (idx) => { closeModal(); callback(idx); };
            showModal(`ğŸ“ é€‰æ‹©è®ºæ–‡ - ${action}`, html, [{ text: 'å–æ¶ˆ', class: 'btn-info', action: closeModal }]);
        }

        // ==================== æ—¥å¿—ç³»ç»Ÿ ====================
        function addLog(event, detail, result = '') {
            const logContent = document.getElementById('log-content');
            const dateStr = `ç¬¬${gameState.year}å¹´ç¬¬${gameState.month}æœˆ`;
            const isNegative = result && (result.includes('-') || result.includes('æ‹’ç¨¿') || result.includes('ä¸æ»¡') || result.includes('å¤±è´¥') || result.includes('è½é€‰'));
            const entry = document.createElement('div');
            entry.className = `log-entry ${isNegative ? 'negative' : ''}`;
            entry.innerHTML = `<div class="date">[${dateStr}] ${event}</div><div class="event">${detail}</div>${result ? `<div class="result">â†’ ${result}</div>` : ''}`;
            logContent.insertBefore(entry, logContent.firstChild);
            while (logContent.children.length > 100) logContent.removeChild(logContent.lastChild);
        }

        // ==================== å·¥å…·å‡½æ•° ====================
        function rand(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

        function shuffle(arr) {
            const a = [...arr];
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }

        function scrollToPanel(panelId) {
            const panel = document.getElementById(panelId);
            if (panel) {
                panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // ==================== ä¼šè®®ç›¸å…³å‡½æ•° ====================
        
        // è®¡ç®—çœŸå®å¹´ä»½ï¼šæ¸¸æˆç¬¬1å¹´ç¬¬1æœˆ = 2030å¹´9æœˆ
        function getRealYear(gameYear, gameMonth) {
            const baseYear = 2029;
            return baseYear + gameYear + (gameMonth >= 5 ? 1 : 0);
        }

        // è·å–ä¼šè®®ä¿¡æ¯
        function getConferenceInfo(gameMonth, grade, gameYear) {
            const conf = CONFERENCES[gameMonth][grade];
            const realYear = getRealYear(gameYear, gameMonth);
            
            // å¤„ç†ICCV/ECCVè½®æ¢
            if (conf.alternates) {
                const isOddYear = realYear % 2 === 1;
                const selected = isOddYear ? conf.alternates.odd : conf.alternates.even;
                return {
                    name: selected.name,
                    fullName: selected.fullName,
                    field: conf.field,
                    year: realYear,
					month: gameMonth,
                };
            }
            
            return {
                name: conf.name,
                fullName: conf.fullName,
                field: conf.field,
                year: realYear
            };
        }

        // è·å–ä¼šè®®åœ°ç‚¹ï¼ˆåŸºäºè®ºæ–‡æ ‡é¢˜hashï¼Œä¿è¯åŒä¸€è®ºæ–‡åœ°ç‚¹å›ºå®šï¼‰
        function getConferenceLocation(paperTitle) {
            const hash = paperTitle.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            return CONFERENCE_LOCATIONS[hash % CONFERENCE_LOCATIONS.length];
        }

        // æ ¼å¼åŒ–ä¼šè®®æ˜¾ç¤ºå­—ç¬¦ä¸²
        function formatConferenceString(confInfo, location) {
            return `${confInfo.name} ${confInfo.year} @ ${location.city}, ${location.country}`;
        }

        // ==================== æŠ•ç¨¿ç»Ÿè®¡ç³»ç»Ÿ ====================
        
        let submissionStatsCache = null;
        let submissionStatsCacheTime = 0;
        const SUBMISSION_CACHE_DURATION = 30 * 60 * 1000; // 30åˆ†é’Ÿ

        // åŠ è½½æŠ•ç¨¿ç»Ÿè®¡æ•°æ®
		async function loadSubmissionStats() {
			// æ£€æŸ¥å†…å­˜ç¼“å­˜
			if (submissionStatsCache && (Date.now() - submissionStatsCacheTime < SUBMISSION_CACHE_DURATION)) {
				console.log('ä½¿ç”¨å†…å­˜ç¼“å­˜çš„æŠ•ç¨¿ç»Ÿè®¡');
				return submissionStatsCache;
			}
			
			// æ£€æŸ¥localStorageç¼“å­˜
			const localCacheKey = 'graduateSimulator_submissionStats';
			const cached = getLocalCache(localCacheKey);
			if (cached) {
				console.log('ä½¿ç”¨æœ¬åœ°ç¼“å­˜çš„æŠ•ç¨¿ç»Ÿè®¡');
				submissionStatsCache = cached;
				submissionStatsCacheTime = Date.now();
				return cached;
			}
			
			// ä»æ•°æ®åº“åŠ è½½
			if (!supabase) {
				console.log('Supabaseæœªåˆå§‹åŒ–ï¼Œä½¿ç”¨é»˜è®¤ç»Ÿè®¡');
				const defaultStats = getDefaultSubmissionStats();
				// â˜…â˜…â˜… æ–°å¢ï¼šå³ä½¿æ˜¯é»˜è®¤å€¼ä¹Ÿç¼“å­˜ï¼Œé¿å…é‡å¤è°ƒç”¨ â˜…â˜…â˜…
				submissionStatsCache = defaultStats;
				submissionStatsCacheTime = Date.now();
				return defaultStats;
			}
			
			try {
				console.log('ä»æ•°æ®åº“åŠ è½½æŠ•ç¨¿ç»Ÿè®¡...');
				
				// â˜…â˜…â˜… ä¿®æ”¹ï¼šä½¿ç”¨åˆ†é¡µåŠ è½½ï¼Œé™åˆ¶æœ€å¤§æ•°é‡å’Œæ—¶é—´ â˜…â˜…â˜…
				const data = await fetchSubmissionsWithLimit(10000);
				
				if (!data || data.length === 0) {
					console.log('æ•°æ®åº“æ— è®°å½•ï¼Œä½¿ç”¨é»˜è®¤ç»Ÿè®¡');
					return getDefaultSubmissionStats();
				}
				
				// è®¡ç®—ç»Ÿè®¡æ•°æ®
				const stats = calculateSubmissionStats(data);
				
				// ç¼“å­˜
				submissionStatsCache = stats;
				submissionStatsCacheTime = Date.now();
				setLocalCache(localCacheKey, stats);
				
				console.log('âœ… æŠ•ç¨¿ç»Ÿè®¡åŠ è½½å®Œæˆï¼Œå…±', data.length, 'æ¡è®°å½•');
				return stats;
				
			} catch (e) {
				console.error('åŠ è½½æŠ•ç¨¿ç»Ÿè®¡å¤±è´¥:', e);
				return getDefaultSubmissionStats();
			}
		}

		// â˜…â˜…â˜… æ–°å¢ï¼šå¸¦é™åˆ¶çš„åˆ†é¡µè·å– â˜…â˜…â˜…
		async function fetchSubmissionsWithLimit(maxRows = 10000) {
			if (!supabase) return [];
			
			let allData = [];
			let from = 0;
			const pageSize = 1000;
			const maxPages = Math.ceil(maxRows / pageSize);  // æœ€å¤šè¯·æ±‚10é¡µ
			let pageCount = 0;
			
			while (allData.length < maxRows && pageCount < maxPages) {
				pageCount++;
				
				try {
					const { data, error } = await supabase
						.from('paper_submissions')
						.select('game_month, grade, is_reversed, submitted_score, result')
						.order('created_at', { ascending: false })
						.range(from, from + pageSize - 1);
					
					if (error) {
						console.error('è·å–æŠ•ç¨¿æ•°æ®å¤±è´¥:', error);
						break;  // å‡ºé”™æ—¶è¿”å›å·²è·å–çš„æ•°æ®
					}
					
					if (!data || data.length === 0) break;
					
					allData = allData.concat(data);
					console.log(`æŠ•ç¨¿ç»Ÿè®¡: å·²è·å– ${allData.length} æ¡è®°å½• (ç¬¬${pageCount}é¡µ)`);
					
					if (data.length < pageSize) break;
					
					from += pageSize;
				} catch (e) {
					console.error('åˆ†é¡µè¯·æ±‚å¤±è´¥:', e);
					break;
				}
			}
			
			return allData;
		}

        // è®¡ç®—ç»Ÿè®¡æ•°æ®
        function calculateSubmissionStats(data) {
            const stats = {};
            
            // åˆå§‹åŒ–æ‰€æœ‰æœˆä»½å’Œç­‰çº§çš„ç»Ÿè®¡
            for (let month = 1; month <= 12; month++) {
                for (const grade of ['A', 'B', 'C']) {
                    for (const reversed of [true, false]) {
                        const key = `${month}_${grade}_${reversed}`;
                        stats[key] = {
                            submissions: 0,
                            accepted: 0,
                            poster: 0,
                            oral: 0,
                            bestPaper: 0,
                            scores: {
                                rejected: [],
                                poster: [],
                                oral: [],
                                bestPaper: []
                            }
                        };
                    }
                }
            }
            
            // ç»Ÿè®¡æ•°æ®
            data.forEach(record => {
                const key = `${record.game_month}_${record.grade}_${record.is_reversed}`;
                if (!stats[key]) return;
				// â˜…â˜…â˜… æ–°å¢ï¼šè¿‡æ»¤è¶…è¿‡180åˆ†æ•°çš„å¼‚å¸¸æ•°æ® â˜…â˜…â˜…
				if ((record.submitted_score || 0) > 180) return;
                
                stats[key].submissions++;
                
                if (record.result !== 'rejected') {
                    stats[key].accepted++;
                    stats[key].scores[record.result]?.push(record.submitted_score);
                    
                    if (record.result === 'poster') stats[key].poster++;
                    else if (record.result === 'oral') stats[key].oral++;
                    else if (record.result === 'best_paper') stats[key].bestPaper++;
                } else {
                    stats[key].scores.rejected.push(record.submitted_score);
                }
            });
            
            // è®¡ç®—æ´¾ç”Ÿç»Ÿè®¡
            for (const key in stats) {
                const s = stats[key];
                
                // å½•å–ç‡
                s.acceptRate = s.submissions > 0 ? s.accepted / s.submissions : 0;
                
                // è®¡ç®—å„æ¡£å¹³å‡åˆ†
                s.avgScoreRejected = calcAvg(s.scores.rejected);
                s.avgScorePoster = calcAvg(s.scores.poster);
                s.avgScoreOral = calcAvg(s.scores.oral);
                s.avgScoreBestPaper = calcAvg(s.scores.bestPaper);
                
                // è®¡ç®—å½•å–è®ºæ–‡çš„åˆ†ä½æ•°
                const acceptedScores = [
                    ...s.scores.poster,
                    ...s.scores.oral,
                    ...s.scores.bestPaper
                ].sort((a, b) => a - b);
                
                if (acceptedScores.length > 0) {
                    const p90Index = Math.floor(acceptedScores.length * 0.9);
                    const p99Index = Math.floor(acceptedScores.length * 0.99);
                    s.p90AcceptedScore = acceptedScores[p90Index] || acceptedScores[acceptedScores.length - 1];
                    s.p99AcceptedScore = acceptedScores[p99Index] || acceptedScores[acceptedScores.length - 1];
                } else {
                    // é»˜è®¤å€¼
                    const grade = key.split('_')[1];
                    s.p90AcceptedScore = grade === 'A' ? 85 : grade === 'B' ? 55 : 35;
                    s.p99AcceptedScore = grade === 'A' ? 100 : grade === 'B' ? 70 : 45;
                }
                
                // æ¸…ç†åŸå§‹åˆ†æ•°æ•°ç»„ï¼ˆèŠ‚çœå†…å­˜ï¼‰
                delete s.scores;
            }
            
            return stats;
        }

        function calcAvg(arr) {
            if (!arr || arr.length === 0) return 0;
            return arr.reduce((a, b) => a + b, 0) / arr.length;
        }

		// è·å–é»˜è®¤ç»Ÿè®¡æ•°æ®
		function getDefaultSubmissionStats() {
			const stats = {};
			
			for (let month = 1; month <= 12; month++) {
				for (const grade of ['A', 'B', 'C']) {
					for (const reversed of [true, false]) {
						const key = `${month}_${grade}_${reversed}`;
						const target = TARGET_ACCEPTANCE_RATES[grade];
						
						stats[key] = {
							submissions: 100,  // â˜…â˜…â˜… å…³é”®ä¿®æ”¹ï¼šè®¾ä¸º100ä½¿hasEnoughDataä¸ºtrue â˜…â˜…â˜…
							accepted: Math.round(100 * target.target),  // â˜…â˜…â˜… æ–°å¢ï¼šè®¡ç®—å¯¹åº”çš„å½•ç”¨æ•° â˜…â˜…â˜…
							poster: Math.round(100 * target.target * 0.7),
							oral: Math.round(100 * target.target * 0.25),
							bestPaper: Math.round(100 * target.target * 0.05),
							acceptRate: target.target,
							avgScoreRejected: grade === 'A' ? 40 : grade === 'B' ? 25 : 15,
							avgScorePoster: grade === 'A' ? 70 : grade === 'B' ? 45 : 30,
							avgScoreOral: grade === 'A' ? 90 : grade === 'B' ? 60 : 40,
							avgScoreBestPaper: grade === 'A' ? 105 : grade === 'B' ? 75 : 50,
							p90AcceptedScore: grade === 'A' ? 85 : grade === 'B' ? 55 : 35,
							p99AcceptedScore: grade === 'A' ? 100 : grade === 'B' ? 70 : 45
						};
					}
				}
			}
			
			return stats;
		}

        // è·å–å½“å‰æœˆä»½çš„ç»Ÿè®¡
        function getMonthStats(gameMonth, grade, isReversed) {
            if (!gameState.submissionStats) {
                return getDefaultSubmissionStats()[`${gameMonth}_${grade}_${isReversed}`];
            }
            return gameState.submissionStats[`${gameMonth}_${grade}_${isReversed}`] || 
                   getDefaultSubmissionStats()[`${gameMonth}_${grade}_${isReversed}`];
        }

		// ==================== å®¡ç¨¿ç³»ç»Ÿ V3 ====================
		// ç‰¹æ€§ï¼š
		// 1. ä¼šè®®çƒ­åº¦åŸºäºåŒç­‰çº§å¹³å‡æŠ•ç¨¿é‡è®¡ç®—
		// 2. ç´¯è®¡æŠ•ç¨¿â‰¥1000æ—¶æ‰å¯ç”¨éå¯¹ç§°è°ƒæ•´
		// 3. åˆå§‹çŠ¶æ€ä¸‹BLå½•å–ç‡åŸºäºè®ºæ–‡åˆ†æ•°è®¡ç®—
		// 4. ä¸åŒå®¡ç¨¿äººç±»å‹æœ‰ä¸åŒçš„è°ƒæ•´æ•æ„Ÿåº¦

		// ==================== å¸¸é‡é…ç½® ====================

		// ç›®æ ‡å½•å–ç‡
		const TARGET_ACCEPTANCE_RATES = {
			A: { min: 0.20, max: 0.30, target: 0.25 },
			B: { min: 0.30, max: 0.45, target: 0.375 },
			C: { min: 0.40, max: 0.60, target: 0.50 }
		};

		// åŸºç¡€é˜ˆå€¼é…ç½®
		const BASE_THRESHOLDS = {
			A: {
				kind:      { reject: 40, borderline: 60 },
				normal:    { reject: 50, borderline: 80 },
				expert:    { reject: 50, borderline: 80 },
				gpt:       { reject: 40, borderline: 90 },
				hostile:   { reject: 70, borderline: 100 },
				questions: { reject: 70, borderline: 100 }
			},
			B: {
				kind:      { reject: 25, borderline: 40 },
				normal:    { reject: 30, borderline: 50 },
				expert:    { reject: 30, borderline: 50 },
				gpt:       { reject: 25, borderline: 60 },
				hostile:   { reject: 40, borderline: 60 },
				questions: { reject: 40, borderline: 60 }
			},
			C: {
				kind:      { reject: 10, borderline: 20 },
				normal:    { reject: 15, borderline: 30 },
				expert:    { reject: 15, borderline: 30 },
				gpt:       { reject: 15, borderline: 40 },
				hostile:   { reject: 20, borderline: 40 },
				questions: { reject: 20, borderline: 40 }
			}
		};

		// å®¡ç¨¿äººåˆ†ç»„åŠè°ƒæ•´æ•æ„Ÿåº¦
		const REVIEWER_GROUPS = {
			kind: 'lenient',
			normal: 'standard',
			expert: 'standard',
			gpt: 'standard',
			hostile: 'strict',
			questions: 'strict'
		};

		const ADJUSTMENT_SENSITIVITY = {
			lenient: 1.2,   // å®½æ¾å‹ï¼šè°ƒæ•´å¹…åº¦æ”¾å¤§
			standard: 1.0,  // æ ‡å‡†å‹ï¼šæ­£å¸¸è°ƒæ•´
			strict: 0.7     // ä¸¥æ ¼å‹ï¼šè°ƒæ•´å¹…åº¦ç¼©å°
		};

		// BorderlineåŸºç¡€æ¦‚ç‡é…ç½®
		const BORDERLINE_BASE_CONFIG = {
			A: { baseRate: 0.50, scoreBaseline: 65, scoreRange: 30 },
			B: { baseRate: 0.60, scoreBaseline: 45, scoreRange: 25 },
			C: { baseRate: 0.70, scoreBaseline: 28, scoreRange: 20 }
		};

		// å¯ç”¨è°ƒæ•´çš„æœ€å°æŠ•ç¨¿é‡é˜ˆå€¼
		const MIN_SUBMISSIONS_FOR_ADJUSTMENT = 100;

		// ==================== ä¼šè®®çƒ­åº¦è®¡ç®— ====================

		/**
		 * è®¡ç®—ä¼šè®®ç›¸å¯¹çƒ­åº¦ï¼ˆåŸºäºåŒç­‰çº§æ‰€æœ‰ä¼šè®®çš„å¹³å‡æŠ•ç¨¿é‡ï¼‰
		 * @param {number} submissions - å½“å‰ä¼šè®®æŠ•ç¨¿é‡
		 * @param {string} grade - ç­‰çº§ A/B/C
		 * @param {object} submissionStats - æ‰€æœ‰æœˆä»½çš„ç»Ÿè®¡æ•°æ®
		 * @param {boolean} isReversed - æ˜¯å¦é€†ä½æ¨¡å¼
		 * @returns {object} çƒ­åº¦ä¿¡æ¯
		 */
		function getConferencePopularity(submissions, grade, submissionStats, isReversed) {
			// è®¡ç®—åŒç­‰çº§æ‰€æœ‰ä¼šè®®çš„å¹³å‡æŠ•ç¨¿é‡
			let totalSubmissions = 0;
			let conferenceCount = 0;
			
			for (let month = 1; month <= 12; month++) {
				const key = `${month}_${grade}_${isReversed}`;
				const stats = submissionStats ? submissionStats[key] : null;
				if (stats && stats.submissions > 0) {
					totalSubmissions += stats.submissions;
					conferenceCount++;
				}
			}
			
			// å¹³å‡æŠ•ç¨¿é‡ï¼ˆå¦‚æœæ²¡æœ‰æ•°æ®åˆ™ä½¿ç”¨é»˜è®¤å€¼ï¼‰
			const defaultAvg = { A: 200, B: 150, C: 100 }[grade];
			const avgSubmissions = conferenceCount > 0 ? totalSubmissions / conferenceCount : defaultAvg;
			
			// ç›¸å¯¹çƒ­åº¦æ¯”å€¼
			const popularityRatio = submissions / avgSubmissions;
			
			// çƒ­åº¦åˆ†çº§
			let category;
			if (popularityRatio >= 1.5) category = 'very_hot';
			else if (popularityRatio >= 1.15) category = 'hot';
			else if (popularityRatio >= 0.85) category = 'normal';
			else if (popularityRatio >= 0.5) category = 'cold';
			else category = 'very_cold';
			
			// ç›®æ ‡å½•å–ç‡è°ƒæ•´ï¼ˆçƒ­é—¨ä¼šè®®ç›®æ ‡å½•å–ç‡ç•¥ä½ï¼‰
			// æ¯åç¦»å¹³å‡50%ï¼Œç›®æ ‡å½•å–ç‡è°ƒæ•´Â±3%ï¼Œä¸Šé™Â±5%
			const targetAdjustment = Math.max(-0.05, Math.min(0.05, (1 - popularityRatio) * 0.06));
			
			return {
				submissions,
				avgSubmissions: Math.round(avgSubmissions),
				ratio: popularityRatio,
				category,
				targetAdjustment
			};
		}

		/*** è·å–è°ƒæ•´åçš„ç›®æ ‡å½•å–ç‡*/
		function getAdjustedTargetRate(grade, monthStats, submissionStats, isReversed) {
			const baseTarget = TARGET_ACCEPTANCE_RATES[grade];
			
			if (!monthStats || monthStats.submissions < 50) {
				return {
					...baseTarget,
					popularity: null,
					adjusted: false
				};
			}
			
			const popularity = getConferencePopularity(
				monthStats.submissions,
				grade,
				submissionStats,
				isReversed
			);
			
			return {
				min: Math.max(0.10, baseTarget.min + popularity.targetAdjustment),
				max: Math.min(0.70, baseTarget.max + popularity.targetAdjustment),
				target: baseTarget.target + popularity.targetAdjustment,
				popularity,
				adjusted: true
			};
		}

		// ==================== æ ¸å¿ƒï¼šéå¯¹ç§°è°ƒæ•´ç³»ç»Ÿ ====================

		function calculateAsymmetricAdjustment(grade, monthStats, adjustedTarget) {
			// åˆå§‹åŒ–ç»“æœï¼šä½¿ç”¨åŸºç¡€é˜ˆå€¼ï¼Œä¸è°ƒæ•´
			const result = {
				thresholds: {},
				borderlineBaseRate: BORDERLINE_BASE_CONFIG[grade].baseRate,
				useScoreBasedBL: true,  // æ˜¯å¦ä½¿ç”¨åŸºäºåˆ†æ•°çš„BLæ¦‚ç‡
				adjustmentEnabled: false,
				adjustmentDetails: {
					rejectChange: 0,
					borderlineChange: 0,
					blRateChange: 0,
					reason: ''
				}
			};
			
			// å¤åˆ¶åŸºç¡€é˜ˆå€¼
			for (const reviewerType in BASE_THRESHOLDS[grade]) {
				result.thresholds[reviewerType] = { ...BASE_THRESHOLDS[grade][reviewerType] };
			}
			
			// ========== æ£€æŸ¥æ˜¯å¦å¯ç”¨è°ƒæ•´ ==========
			
			// æ¡ä»¶ï¼šç´¯è®¡æŠ•ç¨¿æœªè¾¾åˆ°100
			if (monthStats.submissions < MIN_SUBMISSIONS_FOR_ADJUSTMENT) {
				result.adjustmentDetails.reason = 
					`ç´¯è®¡æŠ•ç¨¿${monthStats.submissions}ç¯‡ï¼Œæœªè¾¾åˆ°${MIN_SUBMISSIONS_FOR_ADJUSTMENT}ç¯‡è°ƒæ•´é˜ˆå€¼`;
				return result;
			}
			
			// ========== å¯ç”¨è°ƒæ•´ ==========
			result.adjustmentEnabled = true;
			result.useScoreBasedBL = false;  // å¯ç”¨è°ƒæ•´åï¼ŒBLæ¦‚ç‡ç”±è°ƒæ•´ç³»ç»Ÿæ§åˆ¶
			
			const actualRate = monthStats.acceptRate;
			const targetRate = adjustedTarget.target;
			const deviation = actualRate - targetRate;
			
			// åœ¨ç›®æ ‡èŒƒå›´å†…ä¸è°ƒæ•´
			if (actualRate >= adjustedTarget.min && actualRate <= adjustedTarget.max) {
				result.adjustmentDetails.reason = 
					`å½•å–ç‡${(actualRate * 100).toFixed(1)}%åœ¨ç›®æ ‡èŒƒå›´[${(adjustedTarget.min * 100).toFixed(0)}%-${(adjustedTarget.max * 100).toFixed(0)}%]å†…`;
				return result;
			}
			
			// å½•å–ç‡è¿‡é«˜ï¼šéœ€è¦é™ä½
			if (deviation > 0) {
				return adjustForHighAcceptanceRate(grade, deviation, monthStats, result);
			}
			
			// å½•å–ç‡è¿‡ä½ï¼šéœ€è¦æé«˜
			if (deviation < 0) {
				return adjustForLowAcceptanceRate(grade, -deviation, monthStats, result);
			}
			
			return result;
		}

		/*** å½•å–ç‡è¿‡é«˜æ—¶çš„è°ƒæ•´ï¼Œç­–ç•¥ï¼š50%é€šè¿‡æé«˜Rejecté˜ˆå€¼ï¼Œ50%é€šè¿‡é™ä½BLæ¦‚ç‡*/
		function adjustForHighAcceptanceRate(grade, excess, monthStats, result) {
			const halfExcess = excess / 2;
			
			// === ä¼°ç®—å½“å‰BorderlineåŒºé—´æ¯”ä¾‹ ===
			const estimatedBLRatio = estimateBorderlineRatio(grade, monthStats);
			
			// === è®¡ç®—Rejecté˜ˆå€¼è°ƒæ•´ ===
			// ç»éªŒå…¬å¼ï¼šé˜ˆå€¼æé«˜X%ï¼ŒRejectæ¯”ä¾‹çº¦å¢åŠ X*0.5%
			const rejectAdjustPercent = Math.min(0.30, halfExcess * 2);
			
			// === è®¡ç®—Borderlineé˜ˆå€¼è°ƒæ•´ï¼ˆå°å¹…è·Ÿéšï¼Œçº¦ä¸ºRejectçš„30%ï¼‰===
			const borderlineAdjustPercent = rejectAdjustPercent * 0.3;
			
			// === è®¡ç®—BLå½•å–æ¦‚ç‡è°ƒæ•´ ===
			const baseBLRate = BORDERLINE_BASE_CONFIG[grade].baseRate;
			const blRateReduction = estimatedBLRatio > 0 ? halfExcess / estimatedBLRatio : halfExcess;
			result.borderlineBaseRate = Math.max(0.20, baseBLRate - blRateReduction);
			
			// === åº”ç”¨åˆ°å„å®¡ç¨¿äººï¼ˆè€ƒè™‘æ•æ„Ÿåº¦ï¼‰===
			applyThresholdAdjustments(grade, result, rejectAdjustPercent, borderlineAdjustPercent, 'increase');
			
			result.adjustmentDetails = {
				rejectChange: rejectAdjustPercent,
				borderlineChange: borderlineAdjustPercent,
				blRateChange: -(baseBLRate - result.borderlineBaseRate),
				reason: `å½•å–ç‡è¿‡é«˜(${(monthStats.acceptRate * 100).toFixed(1)}%â†’ç›®æ ‡${(monthStats.acceptRate * 100 - excess * 100).toFixed(1)}%)ï¼š` +
						`Rejecté˜ˆå€¼+${(rejectAdjustPercent * 100).toFixed(0)}%ï¼Œ` +
						`BLåŸºç¡€æ¦‚ç‡${(result.borderlineBaseRate * 100).toFixed(0)}%`
			};
			
			return result;
		}

		/*** å½•å–ç‡è¿‡ä½æ—¶çš„è°ƒæ•´ï¼Œç­–ç•¥ï¼šä¼˜å…ˆæé«˜BLæ¦‚ç‡ï¼ˆæœ€é«˜100%ï¼‰ï¼Œä¸å¤Ÿå†é™ä½Rejecté˜ˆå€¼*/
		function adjustForLowAcceptanceRate(grade, deficit, monthStats, result) {
			const estimatedBLRatio = estimateBorderlineRatio(grade, monthStats);
			const baseBLRate = BORDERLINE_BASE_CONFIG[grade].baseRate;
			
			// === è®¡ç®—BLæ¦‚ç‡æå‡èƒ½è´¡çŒ®å¤šå°‘ ===
			const blRateRoom = 1.0 - baseBLRate;
			const maxBLContribution = estimatedBLRatio * blRateRoom;
			
			if (deficit <= maxBLContribution) {
				// BLæ¦‚ç‡æå‡å³å¯æ»¡è¶³
				const blRateIncrease = estimatedBLRatio > 0 ? deficit / estimatedBLRatio : deficit;
				result.borderlineBaseRate = Math.min(1.0, baseBLRate + blRateIncrease);
				
				result.adjustmentDetails = {
					rejectChange: 0,
					borderlineChange: 0,
					blRateChange: result.borderlineBaseRate - baseBLRate,
					reason: `å½•å–ç‡åä½(${(monthStats.acceptRate * 100).toFixed(1)}%)ï¼š` +
							`BLåŸºç¡€æ¦‚ç‡æå‡è‡³${(result.borderlineBaseRate * 100).toFixed(0)}%`
				};
				
				return result;
			}
			
			// === BLå·²æ‹‰æ»¡ï¼Œéœ€è¦é™ä½Rejecté˜ˆå€¼ ===
			result.borderlineBaseRate = 1.0;
			
			const remaining = deficit - maxBLContribution;
			
			// é™ä½Rejecté˜ˆå€¼ï¼Œæ‰©å¤§BorderlineåŒºé—´
			const rejectAdjustPercent = Math.min(0.25, remaining * 2);
			
			// Borderlineé˜ˆå€¼å°å¹…é™ä½
			const borderlineAdjustPercent = rejectAdjustPercent * 0.15;
			
			// åº”ç”¨è°ƒæ•´
			applyThresholdAdjustments(grade, result, rejectAdjustPercent, borderlineAdjustPercent, 'decrease');
			
			result.adjustmentDetails = {
				rejectChange: -rejectAdjustPercent,
				borderlineChange: -borderlineAdjustPercent,
				blRateChange: 1.0 - baseBLRate,
				reason: `å½•å–ç‡è¿‡ä½(${(monthStats.acceptRate * 100).toFixed(1)}%)ï¼š` +
						`BLæ¦‚ç‡100%ï¼ŒRejecté˜ˆå€¼-${(rejectAdjustPercent * 100).toFixed(0)}%`
			};
			
			return result;
		}

		/*** åº”ç”¨é˜ˆå€¼è°ƒæ•´åˆ°å„å®¡ç¨¿äºº*/
		function applyThresholdAdjustments(grade, result, rejectPercent, borderlinePercent, direction) {
			const sign = direction === 'increase' ? 1 : -1;
			
			for (const reviewerType in result.thresholds) {
				const group = REVIEWER_GROUPS[reviewerType];
				const sensitivity = ADJUSTMENT_SENSITIVITY[group];
				const baseThreshold = BASE_THRESHOLDS[grade][reviewerType];
				
				// Rejecté˜ˆå€¼è°ƒæ•´
				const rejectMultiplier = 1 + sign * rejectPercent * sensitivity;
				result.thresholds[reviewerType].reject = Math.round(
					baseThreshold.reject * Math.max(0.70, Math.min(1.35, rejectMultiplier))
				);
				
				// Borderlineé˜ˆå€¼è°ƒæ•´
				const borderlineMultiplier = 1 + sign * borderlinePercent * sensitivity;
				result.thresholds[reviewerType].borderline = Math.round(
					baseThreshold.borderline * Math.max(0.85, Math.min(1.20, borderlineMultiplier))
				);
			}
		}

		/*** ä¼°ç®—BorderlineåŒºé—´æ¯”ä¾‹*/
		function estimateBorderlineRatio(grade, monthStats) {
			// å¦‚æœæœ‰è¯¦ç»†ç»Ÿè®¡
			if (monthStats.borderlineCount !== undefined && monthStats.submissions > 0) {
				return monthStats.borderlineCount / monthStats.submissions;
			}
			
			// åŸºäºå½•å–ç‡ä¼°ç®—
			const acceptRate = monthStats.acceptRate || TARGET_ACCEPTANCE_RATES[grade].target;
			// ç»éªŒä¼°ç®—ï¼šBorderlineåŒºé—´çº¦å  25%-35%
			return Math.min(0.40, Math.max(0.20, acceptRate * 0.8));
		}

		// ==================== Borderlineå½•å–æ¦‚ç‡è®¡ç®— ====================

		function calculateFinalBorderlineRate(paperScore, grade, reviewScore, adjustment) {
			const config = BORDERLINE_BASE_CONFIG[grade];
			
			// === åŸºç¡€æ¦‚ç‡ ===
			let baseProbability;
			
			if (adjustment.useScoreBasedBL) {
				// æœªå¯ç”¨è°ƒæ•´ï¼šå®Œå…¨åŸºäºè®ºæ–‡åˆ†æ•°è®¡ç®—
				baseProbability = calculateScoreBasedBLRate(paperScore, grade, reviewScore);
			} else {
				// å·²å¯ç”¨è°ƒæ•´ï¼šä½¿ç”¨è°ƒæ•´åçš„åŸºç¡€æ¦‚ç‡ï¼Œå†å åŠ åˆ†æ•°å½±å“
				baseProbability = adjustment.borderlineBaseRate;
				
				// æ ¹æ®å®¡ç¨¿æ€»åˆ†å¾®è°ƒ
				if (reviewScore === 1) {
					baseProbability = Math.min(0.95, baseProbability + 0.15);
				} else if (reviewScore === -1) {
					baseProbability = Math.max(0.15, baseProbability - 0.15);
				}
			}
			
			// === è®ºæ–‡åˆ†æ•°ä¿®æ­£ï¼ˆå§‹ç»ˆåº”ç”¨ï¼‰===
			const scoreModifier = calculateScoreModifier(paperScore, grade);
			
			// === æœ€ç»ˆæ¦‚ç‡ ===
			const finalRate = baseProbability + scoreModifier;
			
			return Math.max(0.10, Math.min(0.98, finalRate));
		}

		/*** åŸºäºåˆ†æ•°çš„BLå½•å–ç‡ï¼ˆç”¨äºæœªå¯ç”¨è°ƒæ•´æ—¶ï¼‰*/
		function calculateScoreBasedBLRate(paperScore, grade, reviewScore) {
			const config = BORDERLINE_BASE_CONFIG[grade];
			
			// åŸºç¡€æ¦‚ç‡æ ¹æ®å®¡ç¨¿æ€»åˆ†
			let baseProbability;
			switch (reviewScore) {
				case 1:  baseProbability = config.baseRate + 0.25; break;  // åæ­£é¢
				case 0:  baseProbability = config.baseRate; break;          // ä¸­ç«‹
				case -1: baseProbability = config.baseRate - 0.20; break;   // åè´Ÿé¢
				default: baseProbability = config.baseRate;
			}
			
			// åˆ†æ•°å½±å“ï¼ˆä½¿ç”¨sigmoidå¹³æ»‘ï¼‰
			const normalizedScore = (paperScore - config.scoreBaseline) / config.scoreRange;
			const scoreInfluence = (2 / (1 + Math.exp(-normalizedScore)) - 1) * 0.25;
			
			return Math.max(0.15, Math.min(0.90, baseProbability + scoreInfluence));
		}

		/*** è®¡ç®—åˆ†æ•°ä¿®æ­£ï¼ˆç”¨äºå åŠ åˆ°è°ƒæ•´åçš„åŸºç¡€æ¦‚ç‡ä¸Šï¼‰ */
		function calculateScoreModifier(paperScore, grade) {
			const config = BORDERLINE_BASE_CONFIG[grade];
			const normalizedScore = (paperScore - config.scoreBaseline) / config.scoreRange;
			
			// sigmoidæ˜ å°„ï¼Œæœ€å¤§Â±12%ä¿®æ­£
			return (2 / (1 + Math.exp(-normalizedScore)) - 1) * 0.12;
		}

		// ==================== å®¡ç¨¿äººè¯„å®¡ ====================

		/*** è®¡ç®—æœ‰æ•ˆåˆ†æ•°ï¼ˆæ ¹æ®å®¡ç¨¿äººæƒé‡ï¼‰*/
		function calculateEffectiveScore(reviewerType, ideaScore, expScore, writeScore) {
			const scores = [
				{ type: 'idea', value: ideaScore },
				{ type: 'exp', value: expScore },
				{ type: 'write', value: writeScore }
			];
			const sortedScores = [...scores].sort((a, b) => a.value - b.value);
			const minScore = sortedScores[0].value;
			const midScore = sortedScores[1].value;
			const maxScore = sortedScores[2].value;
			
			let effectiveScore;
			let weightInfo = '';
			
			switch (reviewerType) {
				case 'expert':
					effectiveScore = ideaScore * 2 + expScore * 0.5 + writeScore * 0.5;
					weightInfo = 'ideaÃ—2, expÃ—0.5, writeÃ—0.5';
					break;
				case 'kind':
					effectiveScore = maxScore * 1.5 + midScore * 1.5;
					weightInfo = 'æœ€é«˜ä¸¤é¡¹Ã—1.5';
					break;
				case 'hostile':
					effectiveScore = minScore * 1.5 + midScore * 1.5;
					weightInfo = 'æœ€ä½ä¸¤é¡¹Ã—1.5';
					break;
				case 'questions':
					effectiveScore = minScore * 3;
					weightInfo = 'æœ€ä½é¡¹Ã—3';
					break;
				case 'normal':
				case 'gpt':
				default:
					const r1 = Math.random() * 0.6;
					const r2 = Math.random() * (0.6 - r1);
					const r3 = 0.6 - r1 - r2;
					const extras = [r1, r2, r3].sort(() => Math.random() - 0.5);
					const w1 = 0.8 + extras[0];
					const w2 = 0.8 + extras[1];
					const w3 = 0.8 + extras[2];
					effectiveScore = ideaScore * w1 + expScore * w2 + writeScore * w3;
					weightInfo = `ideaÃ—${w1.toFixed(2)}, expÃ—${w2.toFixed(2)}, writeÃ—${w3.toFixed(2)}`;
					break;
			}
			
			return { effectiveScore: Math.round(effectiveScore), weightInfo };
		}

		/*** è·å–å•ä¸ªå®¡ç¨¿äººçš„è¯„å®¡ç»“æœ*/
		function getReviewResultV2(reviewer, grade, paperScore, ideaScore, expScore, writeScore, adjustment) {
			// è®¡ç®—æœ‰æ•ˆåˆ†
			const { effectiveScore, weightInfo } = calculateEffectiveScore(
				reviewer.type, ideaScore, expScore, writeScore
			);
			
			// è·å–é˜ˆå€¼ï¼ˆå¯èƒ½å·²è°ƒæ•´ï¼‰
			const threshold = adjustment.thresholds[reviewer.type];
			
			// åˆ¤å®šç»“æœ
			let decision, reviewScore;
			if (effectiveScore < threshold.reject) {
				decision = 'Reject';
				reviewScore = -1;
			} else if (effectiveScore < threshold.borderline) {
				decision = 'Borderline';
				reviewScore = 0;
			} else {
				decision = 'Accept';
				reviewScore = 1;
			}
			
			// ç”Ÿæˆè¯„è¯­
			const comment = generateReviewComment(decision, reviewer.type);
			
			// æ”¹è¿›å»ºè®®ï¼ˆä»…ç‰¹å®šå®¡ç¨¿äººæä¾›ï¼‰
			let improvement = 0, improvementType = '';
			if (reviewer.type === 'normal') {
				improvement = 3;
				improvementType = Math.random() < 0.5 ? 'idea' : 'exp';
			} else if (reviewer.type === 'expert') {
				improvement = 8;
				improvementType = Math.random() < 0.5 ? 'idea' : 'exp';
			}
			
			return {
				reviewer,
				decision,
				score: reviewScore,
				effectiveScore,
				weightInfo,
				thresholds: threshold,
				comment,
				improvement,
				improvementType,
				improvement2: 0,
				improvementType2: ''
			};
		}

		/*** ç”Ÿæˆè¯„è¯­*/
		function generateReviewComment(decision, type) {
			if (type === 'questions') return 'æˆ‘æœ‰39ä¸ªé—®é¢˜ã€‚';
			
			const positive = ['åˆ›æ–°æ€§å¼ºï¼Œå®éªŒå……åˆ†', 'å†™ä½œæ¸…æ™°ï¼Œè´¡çŒ®æ˜ç¡®', 'æ–¹æ³•æ–°é¢–ï¼Œç»“æœæœ‰è¯´æœåŠ›', 'å·¥ä½œæ‰å®ï¼Œæœ‰é‡è¦è´¡çŒ®'];
			const negative = ['ç¼ºä¹åˆ›æ–°', 'å†™ä½œä¸è¶³ï¼Œè¡¨è¾¾ä¸æ¸…', 'å®éªŒä¸è¶³ï¼Œç¼ºå°‘å¯¹æ¯”', 'è´¡çŒ®æœ‰é™ï¼Œå¢é‡å·¥ä½œ'];
			const neutral = ['æœ‰ä¸€å®šåˆ›æ–°ä½†å®éªŒå¯åŠ å¼º', 'æƒ³æ³•æœ‰è¶£ä½†å†™ä½œéœ€æ”¹è¿›', 'å·¥ä½œè¿˜å¯ä»¥ä½†ç¼ºå°‘æ·±å…¥åˆ†æ'];
			
			if (decision === 'Accept') return positive[Math.floor(Math.random() * positive.length)];
			if (decision === 'Reject') return negative[Math.floor(Math.random() * negative.length)];
			
			const all = [...positive, ...negative, ...neutral];
			return all[Math.floor(Math.random() * all.length)];
		}

		// ==================== å½•å–ç±»å‹åˆ¤å®š ====================

		/*** ç¡®å®šå½•å–ç±»å‹ï¼ˆPoster/Oral/Best Paperï¼‰*/
		function determineAcceptTypeV2(paperScore, grade, monthStats) {
			// è·å–åˆ†ä½æ•°é˜ˆå€¼
			let p90, p99;
			
			if (monthStats && monthStats.p90AcceptedScore) {
				p90 = monthStats.p90AcceptedScore;
				p99 = monthStats.p99AcceptedScore;
			} else {
				// é»˜è®¤å€¼
				p90 = { A: 85, B: 55, C: 35 }[grade];
				p99 = { A: 100, B: 70, C: 45 }[grade];
			}
			
			// Best Paperåˆ¤å®š
			if (paperScore >= p99) {
				const bpChance = Math.min(0.50, 0.10 + (paperScore - p99) * 0.05);
				if (Math.random() < bpChance) {
					return 'Best Paper';
				}
			}
			
			// Oralåˆ¤å®š
			if (paperScore >= p90) {
				const oralChance = Math.min(0.40, 0.15 + (paperScore - p90) * 0.03);
				if (Math.random() < oralChance) {
					return 'Oral';
				}
			}
			
			return 'Poster';
		}

		// ==================== ä¸»å¤„ç†å‡½æ•° ====================

		/*** å¤„ç†è®ºæ–‡å®¡ç¨¿ç»“æœï¼ˆä¸»å‡½æ•° - æ›¿æ¢åŸprocessPaperResultï¼‰*/
		function processPaperResult(slot) {
			const paper = gameState.papers[slot];
			if (!paper || !paper.reviewing) return;
			
			const grade = paper.submittedGrade;
			const submittedScore = paper.submittedScore;
			const submittedMonth = paper.submittedMonth || gameState.month;
			
			// â˜…â˜…â˜… ä¿®æ”¹ï¼šä½¿ç”¨æŠ•ç¨¿æ—¶çš„åˆ†æ•°å¿«ç…§ â˜…â˜…â˜…
			const submittedIdeaScore = paper.submittedIdeaScore || paper.ideaScore;
			const submittedExpScore = paper.submittedExpScore || paper.expScore;
			const submittedWriteScore = paper.submittedWriteScore || paper.writeScore;
    
			
			// è·å–ç»Ÿè®¡æ•°æ®
			const monthStats = getMonthStats(submittedMonth, grade, gameState.isReversed);
			
			// è®¡ç®—è°ƒæ•´åçš„ç›®æ ‡å½•å–ç‡
			const adjustedTarget = getAdjustedTargetRate(
				grade, 
				monthStats, 
				gameState.submissionStats, 
				gameState.isReversed
			);
			
			// è®¡ç®—éå¯¹ç§°è°ƒæ•´å‚æ•°
			const adjustment = calculateAsymmetricAdjustment(grade, monthStats, adjustedTarget);
			
			// è®°å½•å®¡ç¨¿æœŸé—´çš„åˆ†æ•°å˜åŒ–
			const reviewMonthsPassed = 4;
			const beforeScores = {
				idea: paper.ideaScore,
				exp: paper.expScore,
				write: paper.writeScore,
				total: paper.ideaScore + paper.expScore + paper.writeScore
			};
			
			// ç”Ÿæˆå®¡ç¨¿äººå¹¶è·å–è¯„å®¡ç»“æœ
			const reviewers = [generateReviewer(), generateReviewer(), generateReviewer()];
			const results = reviewers.map(reviewer => 
				getReviewResultV2(
					reviewer, grade, submittedScore,
					submittedIdeaScore,    // â˜… æ”¹ç”¨æŠ•ç¨¿æ—¶åˆ†æ•°
					submittedExpScore,     // â˜… æ”¹ç”¨æŠ•ç¨¿æ—¶åˆ†æ•°
					submittedWriteScore,   // â˜… æ”¹ç”¨æŠ•ç¨¿æ—¶åˆ†æ•°
					adjustment
				)
			);
			
			// æ±‡æ€»å®¡ç¨¿åˆ†æ•°
			const totalReviewScore = results.reduce((sum, r) => sum + r.score, 0);
			
			// PCå†³ç­–
			let accepted = false;
			let acceptType = null;
			let borderlineChance = null;
			
			if (totalReviewScore >= 1) {
				// å®¡ç¨¿äººä¸€è‡´è®¤å¯
				accepted = true;
			} else if (totalReviewScore === 0) {
				// Borderlineï¼šè®¡ç®—å½•å–æ¦‚ç‡
				borderlineChance = calculateFinalBorderlineRate(
					submittedScore, grade, totalReviewScore, adjustment
				);
				accepted = Math.random() < borderlineChance;
			} else if (totalReviewScore === -1) {
				// åè´Ÿé¢ä½†éå®Œå…¨æ‹’ç»ï¼šå°æ¦‚ç‡å½•å–
				borderlineChance = calculateFinalBorderlineRate(
					submittedScore, grade, totalReviewScore, adjustment
				);
				accepted = Math.random() < borderlineChance;
			} else {
				// å®Œå…¨æ‹’ç»
				accepted = false;
			}
			
			if (accepted) {
				acceptType = determineAcceptTypeV2(submittedScore, grade, monthStats);
			}
			
			// åº”ç”¨åˆ†æ•°è¡°å‡å’Œæ”¹è¿›
			let ideaDecay = reviewMonthsPassed;
			let expDecay = reviewMonthsPassed;
			
			if (gameState.noDecay) {
				ideaDecay = 0;
				expDecay = 0;
			} else {
				paper.ideaScore = Math.max(1, paper.ideaScore - ideaDecay);
				paper.expScore = Math.max(1, paper.expScore - expDecay);
			}
			
			// åº”ç”¨å®¡ç¨¿äººæ”¹è¿›å»ºè®®
			results.forEach(r => {
				if (r.improvement > 0) {
					if (r.improvementType === 'idea') paper.ideaScore += r.improvement;
					else if (r.improvementType === 'exp') paper.expScore += r.improvement;
					else if (r.improvementType === 'write') paper.writeScore += r.improvement;
				}
			});
			
			const afterScores = {
				idea: paper.ideaScore,
				exp: paper.expScore,
				write: paper.writeScore,
				total: paper.ideaScore + paper.expScore + paper.writeScore
			};
			
			checkReviewAchievements(results, afterScores);
			

			const extraInfo = {
				adjustment,
				adjustedTarget,
				borderlineChance,
				monthStats,
				submittedMonth,
				ideaDecay,
				expDecay,
				badReviewerCount: results.filter(r => 
					r.reviewer.type === 'hostile' || r.reviewer.type === 'questions'
				).length,
				hasExpert: results.some(r => r.reviewer.type === 'expert')
			};
			
			showReviewResultModalV2(
				paper, grade, results, totalReviewScore, 
				acceptType, accepted, slot, 
				beforeScores, afterScores, extraInfo
			);
		}

		/** * æˆå°±æ£€æµ‹*/
		function checkReviewAchievements(results, afterScores) {
			gameState.achievementConditions = gameState.achievementConditions || {};
			
			// é«˜åˆ†è®ºæ–‡
			if (afterScores.total >= 125) {
				gameState.achievementConditions.highScorePaper = true;
			}
			
			// å…¨éƒ¨æ”¹è¿›
			if (results.every(r => r.improvement > 0)) {
				gameState.achievementConditions.unanimousImprovement = true;
			}
			
			// å…¨éƒ¨åå®¡ç¨¿äºº
			if (results.every(r => r.reviewer.type === 'hostile' || r.reviewer.type === 'questions')) {
				gameState.achievementConditions.allBadReviewers = true;
			}
		}

		// ==================== å®¡ç¨¿ç»“æœå¼¹çª—ï¼ˆ3é¡µåˆ†é¡µç‰ˆï¼‰====================

		// å…¨å±€å˜é‡å­˜å‚¨å½“å‰å®¡ç¨¿ç»“æœæ•°æ®
		let currentReviewData = null;

		/*** æ˜¾ç¤ºå®¡ç¨¿ç»“æœå¼¹çª—ï¼ˆåˆ†é¡µç‰ˆï¼‰*/
		function showReviewResultModalV2(paper, grade, results, totalReviewScore, acceptType, accepted, slot, beforeScores, afterScores, extraInfo) {
			// å­˜å‚¨æ•°æ®ä¾›åˆ†é¡µä½¿ç”¨
			currentReviewData = {
				paper, grade, results, totalReviewScore, acceptType, accepted, slot,
				beforeScores, afterScores, extraInfo
			};
			
			// æ˜¾ç¤ºç¬¬ä¸€é¡µ
			showReviewResultPage(1);
		}

		/*** æ¸²æŸ“åˆ†é¡µæŒ‡ç¤ºå™¨ */
		function renderPageIndicator(currentPage, totalPages) {
			let dots = '';
			for (let i = 1; i <= totalPages; i++) {
				const isActive = i === currentPage;
				dots += `<span style="display:inline-block;width:10px;height:10px;background:${isActive ? 'var(--primary-color)' : 'var(--border-color)'};border-radius:50%;margin:0 3px;"></span>`;
			}
			return `<div style="text-align:center;padding:10px;color:var(--text-secondary);font-size:0.8rem;">${dots}</div>`;
		}

		/*** æ¸²æŸ“å¢å¼ºç‰ˆå…¨çƒç»Ÿè®¡*/
		function renderGlobalStatsEnhanced(confInfo, monthStats, grade) {
			if (!monthStats || monthStats.submissions < 20) {
				return `
				<div style="padding:12px;background:linear-gradient(135deg,rgba(116,185,255,0.1),rgba(162,155,254,0.1));border-radius:8px;margin-bottom:12px;font-size:0.8rem;border:1px solid rgba(116,185,255,0.3);">
					<div style="font-weight:600;color:var(--info-color);margin-bottom:8px;">
						<i class="fas fa-globe"></i> ${confInfo.name} å…¨çƒç»Ÿè®¡
					</div>
					<div style="text-align:center;color:var(--text-secondary);padding:10px;">
						æ•°æ®ä¸è¶³ï¼Œæš‚æ— ç»Ÿè®¡ä¿¡æ¯
					</div>
				</div>`;
			}
			
			const acceptRate = ((monthStats.acceptRate || 0) * 100).toFixed(1);
			const posterRate = monthStats.submissions > 0 ? ((monthStats.poster || 0) / monthStats.submissions * 100).toFixed(1) : '0';
			const oralRate = monthStats.submissions > 0 ? ((monthStats.oral || 0) / monthStats.submissions * 100).toFixed(1) : '0';
			const bpRate = monthStats.submissions > 0 ? ((monthStats.bestPaper || 0) / monthStats.submissions * 100).toFixed(1) : '0';
			
			// è®¡ç®—å„æ¡£ä½å‚è€ƒåˆ†æ•°
			const avgPoster = monthStats.avgScorePoster || (grade === 'A' ? 70 : grade === 'B' ? 45 : 30);
			const avgOral = monthStats.avgScoreOral || (grade === 'A' ? 90 : grade === 'B' ? 60 : 40);
			const avgBP = monthStats.avgScoreBestPaper || (grade === 'A' ? 105 : grade === 'B' ? 75 : 50);
			const avgRejected = monthStats.avgScoreRejected || (grade === 'A' ? 40 : grade === 'B' ? 25 : 15);
			
			// è®¡ç®—ä¸­ç¨¿è®ºæ–‡å¹³å‡åˆ†
			const totalAccepted = (monthStats.poster || 0) + (monthStats.oral || 0) + (monthStats.bestPaper || 0);
			let avgAcceptedScore = '-';
			if (totalAccepted > 0 && monthStats.avgScorePoster) {
				const weightedSum = (monthStats.avgScorePoster * (monthStats.poster || 0)) + 
								  (monthStats.avgScoreOral * (monthStats.oral || 0)) + 
								  (monthStats.avgScoreBestPaper * (monthStats.bestPaper || 0));
				avgAcceptedScore = Math.round(weightedSum / totalAccepted);
			}
			
			return `
			<div style="padding:12px;background:linear-gradient(135deg,rgba(116,185,255,0.1),rgba(162,155,254,0.1));border-radius:8px;margin-bottom:12px;font-size:0.8rem;border:1px solid rgba(116,185,255,0.3);">
				<div style="font-weight:600;color:var(--info-color);margin-bottom:10px;">
					<i class="fas fa-globe"></i> ${confInfo.name} ${confInfo.year} å…¨çƒç»Ÿè®¡
				</div>
				
				<!-- æŠ•ç¨¿æ¦‚å†µ -->
				<div style="background:var(--card-bg);border-radius:6px;padding:10px;margin-bottom:8px;border:1px solid var(--border-color);">
					<div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:6px;">ğŸ“Š æŠ•ç¨¿æ¦‚å†µ</div>
					<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;text-align:center;">
						<div>
							<div style="font-size:1.1rem;font-weight:700;color:var(--primary-color);">${monthStats.submissions}</div>
							<div style="font-size:0.65rem;color:var(--text-secondary);">æ€»æŠ•ç¨¿</div>
						</div>
						<div>
							<div style="font-size:1.1rem;font-weight:700;color:var(--success-color);">${monthStats.accepted || 0}</div>
							<div style="font-size:0.65rem;color:var(--text-secondary);">æ€»å½•ç”¨</div>
						</div>
						<div>
							<div style="font-size:1.1rem;font-weight:700;color:var(--warning-color);">${acceptRate}%</div>
							<div style="font-size:0.65rem;color:var(--text-secondary);">å½•ç”¨ç‡</div>
						</div>
					</div>
				</div>
				
				<!-- å½•ç”¨åˆ†å¸ƒ -->
				<div style="background:var(--card-bg);border-radius:6px;padding:10px;margin-bottom:8px;border:1px solid var(--border-color);">
					<div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:6px;">ğŸ† å½•ç”¨åˆ†å¸ƒ</div>
					<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;text-align:center;">
						<div style="padding:6px;background:rgba(116,185,255,0.1);border-radius:4px;">
							<div style="font-size:0.9rem;font-weight:600;color:#74b9ff;">${monthStats.poster || 0}</div>
							<div style="font-size:0.6rem;color:var(--text-secondary);">Poster (${posterRate}%)</div>
						</div>
						<div style="padding:6px;background:rgba(253,203,110,0.1);border-radius:4px;">
							<div style="font-size:0.9rem;font-weight:600;color:#fdcb6e;">${monthStats.oral || 0}</div>
							<div style="font-size:0.6rem;color:var(--text-secondary);">Oral (${oralRate}%)</div>
						</div>
						<div style="padding:6px;background:rgba(253,121,168,0.1);border-radius:4px;">
							<div style="font-size:0.9rem;font-weight:600;color:#fd79a8;">${monthStats.bestPaper || 0}</div>
							<div style="font-size:0.6rem;color:var(--text-secondary);">Best (${bpRate}%)</div>
						</div>
					</div>
				</div>
				
				<!-- åˆ†æ•°å‚è€ƒ -->
				<div style="background:var(--card-bg);border-radius:6px;padding:10px;border:1px solid var(--border-color);">
					<div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:6px;">ğŸ“ˆ åˆ†æ•°å‚è€ƒï¼ˆæŠ•ç¨¿æ—¶æ€»åˆ†ï¼‰</div>
					<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:6px;font-size:0.75rem;">
						<div style="display:flex;justify-content:space-between;padding:4px 8px;background:rgba(225,112,85,0.1);border-radius:4px;">
							<span>âŒ æ‹’ç¨¿å‡åˆ†</span>
							<strong style="color:var(--danger-color);">${Math.round(avgRejected)}</strong>
						</div>
						<div style="display:flex;justify-content:space-between;padding:4px 8px;background:rgba(0,184,148,0.1);border-radius:4px;">
							<span>âœ… ä¸­ç¨¿å‡åˆ†</span>
							<strong style="color:var(--success-color);">${avgAcceptedScore}</strong>
						</div>
						<div style="display:flex;justify-content:space-between;padding:4px 8px;background:rgba(116,185,255,0.1);border-radius:4px;">
							<span>ğŸ“„ Posterå‚è€ƒ</span>
							<strong style="color:#74b9ff;">â‰¥${Math.round(avgPoster)}</strong>
						</div>
						<div style="display:flex;justify-content:space-between;padding:4px 8px;background:rgba(253,203,110,0.1);border-radius:4px;">
							<span>ğŸ¤ Oralå‚è€ƒ</span>
							<strong style="color:#d68910;">â‰¥${Math.round(avgOral)}</strong>
						</div>
						<div style="display:flex;justify-content:space-between;padding:4px 8px;background:rgba(253,121,168,0.1);border-radius:4px;grid-column:span 2;">
							<span>ğŸ† Best Paperå‚è€ƒ</span>
							<strong style="color:#fd79a8;">â‰¥${Math.round(avgBP)}</strong>
						</div>
					</div>
					<div style="margin-top:6px;font-size:0.65rem;color:var(--text-secondary);text-align:center;">
						P90é˜ˆå€¼: ${monthStats.p90AcceptedScore || '-'} | P99é˜ˆå€¼: ${monthStats.p99AcceptedScore || '-'}
					</div>
				</div>
			</div>`;
		}

		/*** æ˜¾ç¤ºå®¡ç¨¿ç»“æœæŒ‡å®šé¡µ*/
		function showReviewResultPage(pageNum) {
			const { paper, grade, results, totalReviewScore, acceptType, accepted, slot, beforeScores, afterScores, extraInfo } = currentReviewData;
			const { adjustment, adjustedTarget, borderlineChance, monthStats, ideaDecay, expDecay } = extraInfo;
			
			// è·å–ä¼šè®®ä¿¡æ¯
			const confInfo = paper.conferenceInfo || getConferenceInfo(extraInfo.submittedMonth || gameState.month, grade, gameState.year);
			
			let html = '';
			let pageTitle = '';
			const totalPages = 3;
			
			if (pageNum === 1) {
				// ==================== ç¬¬ä¸€é¡µï¼šä¼šè®®ä¿¡æ¯ + å…¨çƒç»Ÿè®¡ ====================
				pageTitle = 'ğŸ“ å®¡ç¨¿ç»“æœ (1/3)';
				
				// ä¼šè®®å’Œè®ºæ–‡ä¿¡æ¯
				html += `<div style="padding:12px;background:linear-gradient(135deg,rgba(108,92,231,0.1),rgba(162,155,254,0.1));border-radius:10px;margin-bottom:12px;border:1px solid rgba(108,92,231,0.2);">
					<div style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:4px;">æŠ•ç¨¿ä¼šè®®</div>
					<div style="font-size:1.1rem;font-weight:700;color:var(--primary-color);margin-bottom:2px;">${confInfo.name} ${confInfo.year}</div>
					<div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:8px;">${confInfo.fullName} (${grade}ç±»)</div>
					<div style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:4px;">è®ºæ–‡æ ‡é¢˜</div>
					<div style="font-size:0.9rem;font-weight:500;word-break:break-word;">${paper.title}</div>
					<div style="margin-top:8px;font-size:0.8rem;color:var(--text-secondary);">
						æŠ•ç¨¿æ—¶æ€»åˆ†ï¼š<strong style="color:var(--primary-color);">${paper.submittedScore}</strong>
					</div>
				</div>`;
				
				// å¢å¼ºç‰ˆå…¨çƒç»Ÿè®¡
				html += renderGlobalStatsEnhanced(confInfo, monthStats, grade);
				
				// åˆ†é¡µæŒ‡ç¤º
				html += renderPageIndicator(1, totalPages);
				
				showModal(pageTitle, html, [
					{ text: 'æŸ¥çœ‹å®¡ç¨¿è¯¦æƒ… â†’', class: 'btn-primary', action: () => showReviewResultPage(2) }
				]);
				
			} else if (pageNum === 2) {
				// ==================== ç¬¬äºŒé¡µï¼šå®¡ç¨¿äººè¯„å®¡è¯¦æƒ… ====================
				pageTitle = 'ğŸ“ å®¡ç¨¿è¯¦æƒ… (2/3)';
				
				// è°ƒæ•´æœºåˆ¶å±•ç¤º
				html += renderAdjustmentInfo(adjustment, adjustedTarget, monthStats);
				
				// å®¡ç¨¿äººè¯„å®¡è¯¦æƒ…
				html += `<div style="font-weight:600;color:var(--primary-color);margin-bottom:8px;font-size:0.9rem;">
					<i class="fas fa-user-edit"></i> å®¡ç¨¿äººè¯„å®¡ (æ€»åˆ†: ${totalReviewScore >= 0 ? '+' : ''}${totalReviewScore})
				</div>`;
				
				results.forEach((r, idx) => {
					const color = r.decision === 'Accept' ? 'var(--success-color)' : 
								 r.decision === 'Reject' ? 'var(--danger-color)' : 'var(--warning-color)';
					
					const thresholdChanged = adjustment.adjustmentEnabled && 
						(adjustment.adjustmentDetails.rejectChange !== 0 || adjustment.adjustmentDetails.borderlineChange !== 0);
					
					const baseThreshold = BASE_THRESHOLDS[grade][r.reviewer.type];
					
					// æ”¹è¿›å»ºè®®æ˜¾ç¤º
					let improvementHtml = '';
					if (r.improvement > 0) {
						const typeName = r.improvementType === 'idea' ? 'Idea' : r.improvementType === 'exp' ? 'å®éªŒ' : 'å†™ä½œ';
						improvementHtml = `<div style="font-size:0.7rem;color:var(--success-color);margin-top:3px;">ğŸ’¡ æ”¹è¿›å»ºè®®ï¼š${typeName}+${r.improvement}</div>`;
					}
					
					html += `<div style="padding:8px;background:var(--light-bg);border-radius:6px;margin-bottom:6px;font-size:0.85rem;border-left:3px solid ${color};">
						<div style="display:flex;justify-content:space-between;margin-bottom:4px;">
							<strong>å®¡ç¨¿äºº${idx + 1}: ${r.reviewer.name}</strong>
							<span style="color:${color};font-weight:600;">${r.decision}(${r.score > 0 ? '+' : ''}${r.score})</span>
						</div>
						<div style="font-size:0.7rem;color:var(--text-secondary);margin-bottom:3px;">
							ğŸ“ æƒé‡: ${r.weightInfo} â†’ æœ‰æ•ˆåˆ†<strong>${r.effectiveScore}</strong>
						</div>
						<div style="font-size:0.65rem;color:var(--text-secondary);margin-bottom:3px;">
							ğŸ“Š é˜ˆå€¼: Reject&lt;${r.thresholds.reject}${thresholdChanged ? `<span style="color:var(--info-color);">(åŸ${baseThreshold.reject})</span>` : ''}, 
							BL&lt;${r.thresholds.borderline}${thresholdChanged ? `<span style="color:var(--info-color);">(åŸ${baseThreshold.borderline})</span>` : ''}
						</div>
						<div style="font-size:0.8rem;color:var(--text-secondary);font-style:italic;">"${r.comment}"</div>
						${improvementHtml}
					</div>`;
				});
				
				// åˆ†é¡µæŒ‡ç¤º
				html += renderPageIndicator(2, totalPages);
				
				showModal(pageTitle, html, [
					{ text: 'â† è¿”å›ç»“æœ', class: 'btn-info', action: () => showReviewResultPage(1) },
					{ text: 'æŸ¥çœ‹PCå†³å®š â†’', class: 'btn-primary', action: () => showReviewResultPage(3) }
				]);
				
			} else if (pageNum === 3) {
				// ==================== ç¬¬ä¸‰é¡µï¼šåˆ†æ•°å˜åŒ– + PCå†³å®š ====================
				pageTitle = 'ğŸ“ PCå†³å®š (3/3)';
				
				// åˆ†æ•°å˜åŒ–è¯´æ˜
				html += renderScoreChangeInfo(beforeScores, afterScores, results, ideaDecay, expDecay);
				
				// PC Meta Review
				html += renderPCMetaReview(totalReviewScore, accepted, acceptType, borderlineChance, adjustment, paper.submittedScore);
				
				// æœ€ç»ˆç»“æœ
				html += renderFinalResult(accepted, acceptType, confInfo, totalReviewScore, borderlineChance);
				
				// åˆ†é¡µæŒ‡ç¤º
				html += renderPageIndicator(3, totalPages);
				
				showModal(pageTitle, html, [
					{ text: 'â† è¿”å›è¯¦æƒ…', class: 'btn-info', action: () => showReviewResultPage(2) },
					{ text: 'âœ“ ç¡®å®š', class: 'btn-primary', action: () => {
						// æ¶æ„å®¡ç¨¿äººæƒ©ç½š
						if (extraInfo.badReviewerCount > 0) {
							const sanLoss = extraInfo.badReviewerCount;
							if (!changeSan(-sanLoss)) {
								currentReviewData = null;
								return;
							}
							addLog('å®¡ç¨¿å‹åŠ›', `${extraInfo.badReviewerCount}ä¸ªåˆéš¾å®¡ç¨¿äºº`, `SAN-${sanLoss}`);
						}
						
						if (accepted) {
							handlePaperAccepted(paper, grade, acceptType, slot, extraInfo);
						} else {
							// è®°å½•æ‹’ç¨¿æ•°æ®
							recordSubmission(
								extraInfo.submittedMonth || gameState.month,
								grade,
								paper.submittedScore,
								'rejected',
								gameState.isReversed
							);
							
							gameState.rejectedCount++;
							gameState.rejectedPapers[paper.title] = (gameState.rejectedPapers[paper.title] || 0) + 1;
							
							if (gameState.rejectedPapers[paper.title] >= 3) {
								gameState.achievementConditions.tripleRejected = true;
							}
							
							if (extraInfo.hasExpert) {
								const existingBuff = gameState.buffs.permanent.find(b => b.type === 'idea_bonus' && b.name === 'æŒ‡ç‚¹è¿·æ´¥ï¼šæ¯æ¬¡æƒ³ideaåˆ†æ•°+1');
								if (!existingBuff) {
									gameState.buffs.permanent.push({ 
										type: 'idea_bonus', 
										name: 'æŒ‡ç‚¹è¿·æ´¥ï¼šæ¯æ¬¡æƒ³ideaåˆ†æ•°+1', 
										value: 1, 
										permanent: true 
									});
									addLog('å› ç¥¸å¾—ç¦', 'èµ„æ·±å¤§ç‰›çš„æŒ‡ç‚¹è¿·æ´¥', 'æ°¸ä¹…buff-æ¯æ¬¡æƒ³ideaåˆ†æ•°+1');
								}
							}
							
							gameState.consecutiveAccepts = 0;
							
							paper.reviewing = false;
							paper.submittedGrade = null;
							paper.submittedScore = null;
							paper.reviewMonths = 0;
							paper.submittedMonth = null;
							paper.conferenceInfo = null;
							paper.conferenceLocation = null;
							
							// â˜…â˜…â˜… å…³é”®ä¿®æ”¹ï¼šæ‹’ç¨¿æ—¶ä¹Ÿè¦ç»§ç»­å¤„ç†é˜Ÿåˆ— â˜…â˜…â˜…
							if (gameState._reviewProcessing) {
								setTimeout(() => processNextReviewInQueue(), 100);
							}
						}
						
						currentReviewData = null;
						closeModal();
						renderPaperSlots();
						updateAllUI();
					}}
				]);
			}
		}

		/*** æ¸²æŸ“è°ƒæ•´æœºåˆ¶ä¿¡æ¯*/
		function renderAdjustmentInfo(adjustment, adjustedTarget, monthStats) {
			if (!monthStats || monthStats.submissions < 30) {
				return '';
			}
			
			const popularity = adjustedTarget.popularity;
			const popularityText = {
				'very_hot': 'ğŸ”¥ éå¸¸çƒ­é—¨',
				'hot': 'ğŸŒ¡ï¸ çƒ­é—¨',
				'normal': 'ğŸ“Š æ­£å¸¸',
				'cold': 'â„ï¸ å†·é—¨',
				'very_cold': 'ğŸ§Š éå¸¸å†·é—¨'
			}[popularity?.category] || 'ğŸ“Š æ­£å¸¸';
			
			const adjustmentStatus = adjustment.adjustmentEnabled 
				? `<span style="color:var(--success-color);">âœ“ å·²å¯ç”¨</span>` 
				: `<span style="color:var(--text-secondary);">â—‹ æœªå¯ç”¨(éœ€â‰¥${MIN_SUBMISSIONS_FOR_ADJUSTMENT}ç¯‡)</span>`;
			
			return `
			<div style="padding:10px;background:linear-gradient(135deg,rgba(253,203,110,0.1),rgba(243,156,18,0.1));border-radius:8px;margin-bottom:12px;font-size:0.8rem;">
				<div style="font-weight:600;color:#d68910;margin-bottom:6px;">
					<i class="fas fa-balance-scale"></i> å½•å–ç‡è°ƒæ•´æœºåˆ¶ ${adjustmentStatus}
				</div>
				<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
					<div>
						${popularityText}<br>
						<span style="font-size:0.7rem;color:var(--text-secondary);">
							æŠ•ç¨¿${monthStats.submissions}ç¯‡ / å¹³å‡${popularity?.avgSubmissions || '-'}ç¯‡
						</span>
					</div>
					<div>
						ç›®æ ‡å½•å–ç‡ï¼š${(adjustedTarget.target * 100).toFixed(1)}%<br>
						<span style="font-size:0.7rem;color:var(--text-secondary);">
							å®é™…ï¼š${((monthStats.acceptRate || 0) * 100).toFixed(1)}%
						</span>
					</div>
				</div>
				${adjustment.adjustmentEnabled ? `
				<div style="margin-top:6px;font-size:0.7rem;color:var(--text-secondary);border-top:1px dashed rgba(243,156,18,0.3);padding-top:6px;">
					${adjustment.adjustmentDetails.reason}
				</div>` : ''}
			</div>`;
		}

		/*** æ¸²æŸ“åˆ†æ•°å˜åŒ–ä¿¡æ¯*/
		function renderScoreChangeInfo(beforeScores, afterScores, results, ideaDecay, expDecay) {
			const improvements = results.filter(r => r.improvement > 0);
			const totalImprovement = improvements.reduce((sum, imp) => sum + imp.improvement, 0);
			const totalDecay = ideaDecay + expDecay;
			const netChange = afterScores.total - beforeScores.total;
			
			if (totalImprovement === 0 && totalDecay === 0) {
				return '';
			}
			
			const netColor = netChange > 0 ? 'var(--success-color)' : netChange < 0 ? 'var(--danger-color)' : 'var(--text-secondary)';
			
			let html = `<div style="padding:12px;background:linear-gradient(135deg,rgba(108,92,231,0.1),rgba(116,185,255,0.1));border-radius:8px;margin-bottom:12px;font-size:0.85rem;border:1px solid var(--border-color);">
				<div style="font-weight:600;color:var(--primary-color);margin-bottom:10px;">
					<i class="fas fa-chart-line"></i> å®¡ç¨¿æœŸé—´åˆ†æ•°å˜åŒ–
				</div>`;
			
			// è¡°å‡ä¿¡æ¯
			if (gameState.noDecay) {
				html += `<div style="margin-bottom:8px;padding:8px;background:rgba(0,184,148,0.1);border-radius:6px;border-left:3px solid var(--success-color);">
					<div style="font-size:0.8rem;color:var(--success-color);">ğŸ”® é¢„è§æœªæ¥çƒ­ç‚¹ç”Ÿæ•ˆï¼Œåˆ†æ•°ä¸è¡°å‡</div>
				</div>`;
			} else if (totalDecay > 0) {
				html += `<div style="margin-bottom:8px;padding:8px;background:rgba(225,112,85,0.1);border-radius:6px;border-left:3px solid var(--danger-color);">
					<div style="font-size:0.8rem;color:var(--danger-color);">â³ æ—¶æ•ˆæ€§é™ä½ï¼šIdea-${ideaDecay}, å®éªŒ-${expDecay}</div>
				</div>`;
			}
			
			// æ”¹è¿›ä¿¡æ¯
			if (improvements.length > 0) {
				html += `<div style="margin-bottom:8px;padding:8px;background:rgba(0,184,148,0.1);border-radius:6px;border-left:3px solid var(--success-color);">
					<div style="font-size:0.8rem;color:var(--success-color);">ğŸ’¡ å®¡ç¨¿äººå»ºè®®ï¼š`;
				improvements.forEach(imp => {
					const typeName = imp.improvementType === 'idea' ? 'Idea' : imp.improvementType === 'exp' ? 'å®éªŒ' : 'å†™ä½œ';
					html += `${imp.reviewer.name}(${typeName}+${imp.improvement}) `;
				});
				html += `</div></div>`;
			}
			
			// â˜…â˜…â˜… ä¿®æ”¹ï¼šwhite æ”¹ä¸º var(--card-bg) â˜…â˜…â˜…
			html += `<div style="text-align:center;padding:8px;background:var(--card-bg);border-radius:6px;border:1px solid var(--border-color);">
				æ€»åˆ†å˜åŒ–ï¼š${beforeScores.total} â†’ <span style="color:${netColor};font-weight:600;">${afterScores.total}</span>
				(å‡€å˜åŒ–ï¼š<span style="color:${netColor};">${netChange >= 0 ? '+' : ''}${netChange}</span>)
			</div>`;
			
			html += '</div>';
			return html;
		}

		/*** æ¸²æŸ“PC Meta Review*/
		function renderPCMetaReview(totalReviewScore, accepted, acceptType, borderlineChance, adjustment, paperScore) {
			let pcDecisionText, pcReasonText;
			
			if (totalReviewScore >= 1) {
				pcDecisionText = `<span style="color:var(--success-color);">å½•ç”¨ä¸º${acceptType}</span>`;
				pcReasonText = 'å®¡ç¨¿äººæ™®éè®¤å¯ï¼ŒPCå†³å®šå½•ç”¨ã€‚';
			} else if (totalReviewScore === 0) {
				if (accepted) {
					pcDecisionText = `<span style="color:var(--success-color);">å½•ç”¨ä¸º${acceptType}</span>`;
					pcReasonText = `å®¡ç¨¿äººæ„è§åˆ†æ­§ï¼ˆBorderlineï¼‰ï¼ŒPCç»¼åˆè¯„ä¼°åå†³å®šå½•ç”¨ã€‚`;
				} else {
					pcDecisionText = `<span style="color:var(--danger-color);">æ‹’ç¨¿</span>`;
					pcReasonText = `å®¡ç¨¿äººæ„è§åˆ†æ­§ï¼ˆBorderlineï¼‰ï¼ŒPCç»¼åˆè¯„ä¼°åå†³å®šæ‹’ç¨¿ã€‚`;
				}
			} else if (totalReviewScore === -1) {
				if (accepted) {
					pcDecisionText = `<span style="color:var(--success-color);">å½•ç”¨ä¸º${acceptType}</span>`;
					pcReasonText = `å®¡ç¨¿æ„è§åè´Ÿé¢ï¼Œä½†PCè®¤ä¸ºè®ºæ–‡æœ‰ä»·å€¼ï¼Œå†³å®šå½•ç”¨ã€‚`;
				} else {
					pcDecisionText = `<span style="color:var(--danger-color);">æ‹’ç¨¿</span>`;
					pcReasonText = `å®¡ç¨¿æ„è§åè´Ÿé¢ï¼ŒPCå»ºè®®ä¿®æ”¹åé‡æŠ•ã€‚`;
				}
			} else {
				pcDecisionText = `<span style="color:var(--danger-color);">æ‹’ç¨¿</span>`;
				pcReasonText = 'å®¡ç¨¿äººæ™®éä¸è®¤å¯ï¼ŒPCå†³å®šæ‹’ç¨¿ã€‚';
			}
			
			let blInfo = '';
			if (borderlineChance !== null) {
				const chancePercent = (borderlineChance * 100).toFixed(0);
				const sourceText = adjustment.adjustmentEnabled 
					? `åŸºç¡€${(adjustment.borderlineBaseRate * 100).toFixed(0)}%+åˆ†æ•°ä¿®æ­£` 
					: 'åŸºäºè®ºæ–‡åˆ†æ•°è®¡ç®—';
				blInfo = `
				<div style="font-size:0.75rem;color:var(--text-secondary);margin-top:6px;padding-top:6px;border-top:1px dashed var(--border-color);">
					ğŸ’¡ Borderlineå½•å–æ¦‚ç‡ï¼š${chancePercent}%ï¼ˆ${sourceText}ï¼‰
				</div>`;
			}
			
			// â˜…â˜…â˜… ä¿®æ”¹ï¼šwhite æ”¹ä¸º var(--card-bg)ï¼Œæ·»åŠ è¾¹æ¡† â˜…â˜…â˜…
			return `
			<div style="padding:12px;background:linear-gradient(135deg,rgba(155,89,182,0.1),rgba(108,92,231,0.1));border-radius:8px;margin-bottom:12px;border:1px solid rgba(155,89,182,0.3);">
				<div style="font-weight:600;color:#9b59b6;margin-bottom:8px;">
					<i class="fas fa-user-tie"></i> PC Meta Review
				</div>
				<div style="background:var(--card-bg);border-radius:6px;padding:10px;border:1px solid var(--border-color);">
					<div style="font-size:0.8rem;margin-bottom:6px;">
						<strong>æ€»å®¡ç¨¿åˆ†ï¼š</strong>${totalReviewScore}ï¼ˆ${totalReviewScore >= 1 ? 'åæ­£é¢' : totalReviewScore === 0 ? 'ä¸­ç«‹' : 'åè´Ÿé¢'}ï¼‰
					</div>
					<div style="font-size:0.8rem;margin-bottom:6px;">
						<strong>ç»¼åˆè¯„ä¼°ï¼š</strong>${pcReasonText}
					</div>
					<div style="font-size:0.85rem;">
						<strong>PCå†³å®šï¼š</strong>${pcDecisionText}
					</div>
					${blInfo}
				</div>
			</div>`;
		}

		/*** æ¸²æŸ“å…¨çƒç»Ÿè®¡*/
		function renderGlobalStats(confInfo, monthStats, grade) {
			const acceptRate = ((monthStats.acceptRate || 0) * 100).toFixed(1);
			
			return `
			<div style="padding:12px;background:linear-gradient(135deg,rgba(116,185,255,0.1),rgba(162,155,254,0.1));border-radius:8px;margin-bottom:12px;font-size:0.8rem;border:1px solid rgba(116,185,255,0.3);">
				<div style="font-weight:600;color:var(--info-color);margin-bottom:8px;">
					<i class="fas fa-globe"></i> ${confInfo.name} å…¨çƒç»Ÿè®¡
				</div>
				<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:6px;">
					<div>ğŸ“ æŠ•ç¨¿ï¼š<strong>${monthStats.submissions}</strong>ç¯‡</div>
					<div>âœ… å½•ç”¨ï¼š<strong>${monthStats.accepted || 0}</strong>ç¯‡</div>
					<div>ğŸ“ˆ å½•ç”¨ç‡ï¼š<strong>${acceptRate}%</strong></div>
					<div>ğŸ¯ Oralå‚è€ƒï¼šâ‰¥${monthStats.p90AcceptedScore || '-'}åˆ†</div>
				</div>
			</div>`;
		}

		/*** æ¸²æŸ“æœ€ç»ˆç»“æœ*/
		function renderFinalResult(accepted, acceptType, confInfo, totalReviewScore, borderlineChance) {
			if (accepted) {
				const colors = { 'Poster': '#74b9ff', 'Oral': '#fdcb6e', 'Best Paper': '#fd79a8' };
				return `
				<div style="text-align:center;padding:12px;background:linear-gradient(135deg,${colors[acceptType]}33,${colors[acceptType]}66);border-radius:10px;">
					<div style="font-size:1.8rem;margin-bottom:8px;">ğŸ‰</div>
					<div style="font-size:1.1rem;font-weight:700;color:${colors[acceptType]};">
						æ­å–œï¼è®ºæ–‡è¢« ${confInfo.name} ${confInfo.year} æ¥æ”¶ä¸º ${acceptType}ï¼
					</div>
				</div>`;
			} else {
				return `
				<div style="text-align:center;padding:12px;background:rgba(225,112,85,0.15);border-radius:10px;">
					<div style="font-size:1.8rem;margin-bottom:8px;">ğŸ˜¢</div>
					<div style="font-size:1.1rem;font-weight:700;color:var(--danger-color);">
						å¾ˆé—æ†¾ï¼Œè®ºæ–‡è¢« ${confInfo.name} ${confInfo.year} æ‹’ç¨¿äº†
					</div>
					<div style="margin-top:6px;font-size:0.85rem;color:var(--text-secondary);">
						å¯æ ¹æ®å®¡ç¨¿æ„è§ä¿®æ”¹åé‡æŠ•å…¶ä»–ä¼šè®®
					</div>
				</div>`;
			}
		}

		/*** å¤„ç†å®¡ç¨¿ç»“æœåç»­é€»è¾‘*/
		function handleReviewOutcome(accepted, acceptType, paper, grade, slot, extraInfo, results) {
			if (accepted) {
				// è®°å½•æŠ•ç¨¿æ•°æ®
				const resultStr = acceptType.toLowerCase().replace(/\s+/g, '_');
				recordSubmission(
					extraInfo.submittedMonth || gameState.month,
					grade,
					paper.submittedScore,
					resultStr,
					gameState.isReversed
				);
				
				// è°ƒç”¨åŸæœ‰çš„å½•å–å¤„ç†é€»è¾‘
				handlePaperAccepted(paper, grade, acceptType, slot, extraInfo);
			} else {
				// è®°å½•æ‹’ç¨¿æ•°æ®
				recordSubmission(
					extraInfo.submittedMonth || gameState.month,
					grade,
					paper.submittedScore,
					'rejected',
					gameState.isReversed
				);
				
				// æ›´æ–°æ‹’ç¨¿ç»Ÿè®¡
				gameState.rejectedCount++;
				gameState.rejectedPapers = gameState.rejectedPapers || {};
				gameState.rejectedPapers[paper.title] = (gameState.rejectedPapers[paper.title] || 0) + 1;
				
				if (gameState.rejectedPapers[paper.title] >= 3) {
					gameState.achievementConditions = gameState.achievementConditions || {};
					gameState.achievementConditions.tripleRejected = true;
				}
				
				// åå®¡ç¨¿äººæƒ©ç½š
				if (extraInfo.badReviewerCount > 0) {
					const sanLoss = extraInfo.badReviewerCount;
					changeSan(-sanLoss);
					addLog('å®¡ç¨¿æ‰“å‡»', `${extraInfo.badReviewerCount}ä¸ªæ¶æ„å®¡ç¨¿äºº`, `SAN-${sanLoss}`);
				}
				
				// èµ„æ·±å¤§ç‰›æŒ‡å¯¼
				if (extraInfo.hasExpert) {
					const existingBuff = gameState.buffs.permanent.find(b => 
						b.type === 'idea_bonus' && b.name === 'æŒ‡ç‚¹è¿·æ´¥ï¼šæ¯æ¬¡æƒ³ideaåˆ†æ•°+1'
					);
					if (!existingBuff) {
						gameState.buffs.permanent.push({ 
							type: 'idea_bonus', 
							name: 'æŒ‡ç‚¹è¿·æ´¥ï¼šæ¯æ¬¡æƒ³ideaåˆ†æ•°+1', 
							value: 1, 
							permanent: true 
						});
						addLog('å› ç¥¸å¾—ç¦', 'èµ„æ·±å¤§ç‰›çš„æŒ‡ç‚¹è¿·æ´¥', 'æ°¸ä¹…buff-æ¯æ¬¡æƒ³ideaåˆ†æ•°+1');
					}
				}
				
				// é‡ç½®è¿ç»­ä¸­ç¨¿è®¡æ•°
				gameState.consecutiveAccepts = 0;
				
				// æ¸…é™¤å®¡ç¨¿çŠ¶æ€
				paper.reviewing = false;
				paper.submittedGrade = null;
				paper.submittedScore = null;
				paper.reviewMonths = 0;
				paper.submittedMonth = null;
				paper.conferenceInfo = null;
				paper.conferenceLocation = null;
			}
		}

		// ==================== è¾…åŠ©å‡½æ•° ====================


        // å¼‚æ­¥è®°å½•æŠ•ç¨¿æ•°æ®
        async function recordSubmission(gameMonth, grade, submittedScore, result, isReversed) {
            if (!supabase) return;
            
            try {
                await supabase.from('paper_submissions').insert({
                    game_month: gameMonth,
                    grade: grade,
                    submitted_score: submittedScore,
                    result: result.toLowerCase().replace(' ', '_'),
                    is_reversed: isReversed
                });
                console.log('âœ… æŠ•ç¨¿è®°å½•å·²ä¿å­˜');
            } catch (e) {
                console.error('è®°å½•æŠ•ç¨¿å¤±è´¥:', e);
            }
        }

		// ==================== åœ¨çº¿äººæ•°ç³»ç»Ÿ ====================
		let onlineSessionId = null;
		let onlineHeartbeatTimer = null;

		// ç”Ÿæˆä¼šè¯ID
		function getOnlineSessionId() {
			let id = sessionStorage.getItem('graduate_online_session');
			if (!id) {
				id = Date.now().toString(36) + Math.random().toString(36).substr(2, 6);
				sessionStorage.setItem('graduate_online_session', id);
			}
			return id;
		}

		// å‘é€å¿ƒè·³ï¼ˆä»…ç»´æŒåœ¨çº¿çŠ¶æ€ï¼‰
		async function sendOnlineHeartbeat() {
			if (!supabase || !onlineSessionId) return;
			
			try {
				await supabase
					.from('online_users')
					.upsert({ 
						session_id: onlineSessionId, 
						last_seen: new Date().toISOString() 
					});
				
				// æ¸…ç†è¶…è¿‡5åˆ†é’Ÿæœªæ´»è·ƒçš„è®°å½•
				const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000).toISOString();
				await supabase
					.from('online_users')
					.delete()
					.lt('last_seen', fiveMinutesAgo);
			} catch (e) {
				// é™é»˜å¤±è´¥
			}
		}

		// â˜…â˜…â˜… æ ¸å¿ƒï¼šè·å–å½“å‰åœ¨çº¿äººæ•° â˜…â˜…â˜…
		async function getCurrentOnlineCount() {
			if (!supabase) return 0;
			
			try {
				const threeMinutesAgo = new Date(Date.now() - 3 * 60 * 1000).toISOString();
				const { count, error } = await supabase
					.from('online_users')
					.select('*', { count: 'exact', head: true })
					.gte('last_seen', threeMinutesAgo);
				
				if (error) throw error;
				return count || 0;
			} catch (e) {
				console.error('è·å–å½“å‰åœ¨çº¿å¤±è´¥:', e);
				return 0;
			}
		}

		// â˜…â˜…â˜… æ ¸å¿ƒï¼šè·å–å†å²æœ€å¤§åœ¨çº¿ï¼ˆä»æ‰€æœ‰è®°å½•ä¸­å–æœ€å¤§å€¼ï¼‰â˜…â˜…â˜…
		async function getHistoryMaxOnline() {
			if (!supabase) return 0;
			
			try {
				const { data, error } = await supabase
					.from('online_peak_records')
					.select('online_count')
					.order('online_count', { ascending: false })
					.limit(1)
					.single();
				
				if (error && error.code !== 'PGRST116') { // PGRST116 = æ²¡æœ‰è®°å½•
					throw error;
				}
				
				return data?.online_count || 0;
			} catch (e) {
				console.error('è·å–å†å²æœ€å¤§åœ¨çº¿å¤±è´¥:', e);
				return 0;
			}
		}

		// â˜…â˜…â˜… æ ¸å¿ƒï¼šæ£€æµ‹å¹¶å†™å…¥æ–°å³°å€¼è®°å½•ï¼ˆä¸è¦†ç›–ï¼Œæ’å…¥æ–°è®°å½•ï¼‰â˜…â˜…â˜…
		async function checkAndRecordPeakOnline() {
			if (!supabase) return null;
			
			try {
				// 1. è·å–å½“å‰åœ¨çº¿äººæ•°
				const currentOnline = await getCurrentOnlineCount();
				
				// 2. è·å–å†å²æœ€å¤§åœ¨çº¿
				const historyMax = await getHistoryMaxOnline();
				
				// 3. å¦‚æœå½“å‰åœ¨çº¿ > æ‰€æœ‰å†å²è®°å½•çš„æœ€å¤§å€¼ï¼Œæ’å…¥æ–°è®°å½•
				if (currentOnline > historyMax) {
					const { error } = await supabase
						.from('online_peak_records')
						.insert({ online_count: currentOnline });
					
					if (!error) {
						console.log(`âœ… æ–°å³°å€¼è®°å½•å·²å†™å…¥: ${currentOnline} (å†å²æœ€å¤§: ${historyMax})`);
					}
					
					return { currentOnline, maxOnline: currentOnline };
				}
				
				return { currentOnline, maxOnline: historyMax };
			} catch (e) {
				console.error('æ£€æµ‹å³°å€¼å¤±è´¥:', e);
				return null;
			}
		}

		// â˜…â˜…â˜… å¯åŠ¨åœ¨çº¿è¿½è¸ªï¼ˆæ–°ç”¨æˆ·æˆ–åˆ·æ–°é¡µé¢æ—¶è§¦å‘ï¼‰â˜…â˜…â˜…
		function startOnlineTracking() {
			onlineSessionId = getOnlineSessionId();
			
			// é¦–æ¬¡å‘é€å¿ƒè·³ï¼Œç¡®ä¿ç”¨æˆ·è¢«è®°å½•
			sendOnlineHeartbeat().then(() => {
				// â˜…â˜…â˜… æ¯æ¬¡é¡µé¢åŠ è½½ï¼ˆæ–°ç”¨æˆ·æˆ–åˆ·æ–°ï¼‰éƒ½æ£€æµ‹å¹¶å¯èƒ½å†™å…¥å³°å€¼ â˜…â˜…â˜…
				checkAndRecordPeakOnline().then(stats => {
					if (stats) {
						updateOnlineDisplay(stats.currentOnline, stats.maxOnline);
						console.log(`ğŸ‘¤ åœ¨çº¿ç»Ÿè®¡: å½“å‰ ${stats.currentOnline}, å†å²æœ€å¤§ ${stats.maxOnline}`);
					}
				});
			});
			
			// æ¯30ç§’å‘é€å¿ƒè·³ï¼ˆä»…ç»´æŒåœ¨çº¿çŠ¶æ€ï¼Œä¸æ£€æµ‹å³°å€¼ï¼‰
			onlineHeartbeatTimer = setInterval(() => {
				sendOnlineHeartbeat();
			}, 30 * 1000);
			
			// æ¯60ç§’æ›´æ–°å½“å‰åœ¨çº¿æ˜¾ç¤ºï¼ˆä¸å†™å…¥å³°å€¼ï¼‰
			setInterval(async () => {
				const currentOnline = await getCurrentOnlineCount();
				const onlineEl = document.getElementById('online-count-value');
				if (onlineEl) onlineEl.textContent = currentOnline;
			}, 60 * 1000);
			
			// é¡µé¢å…³é—­æ—¶æ¸…ç†
			window.addEventListener('beforeunload', () => {
				if (onlineHeartbeatTimer) {
					clearInterval(onlineHeartbeatTimer);
				}
				if (supabase && onlineSessionId) {
					const deleteUrl = `${SUPABASE_URL}/rest/v1/online_users?session_id=eq.${onlineSessionId}`;
					fetch(deleteUrl, {
						method: 'DELETE',
						headers: {
							'apikey': SUPABASE_ANON_KEY,
							'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
						},
						keepalive: true
					}).catch(() => {});
				}
			});
		}

		// æ›´æ–°åœ¨çº¿æ˜¾ç¤º
		function updateOnlineDisplay(currentOnline, maxOnline) {
			const onlineEl = document.getElementById('online-count-value');
			const maxEl = document.getElementById('max-online-value');
			if (onlineEl) onlineEl.textContent = currentOnline;
			if (maxEl) maxEl.textContent = maxOnline;
		}

		// è·å–ä»Šæ—¥åŒ—äº¬æ—¶é—´0ç‚¹çš„UTCæ—¶é—´
		function getTodayStartUTC() {
			const now = new Date();
			const beijingTime = new Date(now.getTime() + 8 * 60 * 60 * 1000);
			const year = beijingTime.getUTCFullYear();
			const month = beijingTime.getUTCMonth();
			const day = beijingTime.getUTCDate();
			return new Date(Date.UTC(year, month, day) - 8 * 60 * 60 * 1000).toISOString();
		}

		// è·å–ä»Šæ—¥åŒ—äº¬æ—¥æœŸå­—ç¬¦ä¸²
		function getTodayDateString() {
			const now = new Date();
			const beijingTime = new Date(now.getTime() + 8 * 60 * 60 * 1000);
			return beijingTime.toISOString().split('T')[0];
		}

		// è·å–æ‰€æœ‰ç»Ÿè®¡æ•°æ®
		async function getAllStats() {
			if (!supabase) return null;
			
			try {
				const todayStart = getTodayStartUTC();
				
				// å¹¶è¡Œè·å–å„é¡¹ç»Ÿè®¡
				const [currentOnline, historyMax, todayPvResult, todayUvResult, todayGamesResult] = await Promise.all([
					getCurrentOnlineCount(),
					getHistoryMaxOnline(),
					supabase
						.from('site_visits')
						.select('*', { count: 'exact', head: true })
						.eq('type', 'pv')
						.gte('created_at', todayStart),
					supabase
						.from('site_visits')
						.select('*', { count: 'exact', head: true })
						.eq('type', 'uv')
						.gte('created_at', todayStart),
					supabase
						.from('game_endings')
						.select('*', { count: 'exact', head: true })
						.gte('created_at', todayStart)
				]);
				
				return {
					online: currentOnline,
					maxOnline: historyMax,
					todayPv: todayPvResult.count || 0,
					todayUv: todayUvResult.count || 0,
					todayGames: todayGamesResult.count || 0
				};
			} catch (e) {
				console.error('è·å–ç»Ÿè®¡å¤±è´¥:', e);
				return null;
			}
		}

		// æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
		async function updateAllStatsDisplay() {
			const stats = await getAllStats();
			
			if (stats) {
				const el = (id) => document.getElementById(id);
				if (el('online-count-value')) el('online-count-value').textContent = stats.online;
				if (el('max-online-value')) el('max-online-value').textContent = stats.maxOnline;
				if (el('today-pv-value')) el('today-pv-value').textContent = stats.todayPv;
				if (el('today-uv-value')) el('today-uv-value').textContent = stats.todayUv;
				if (el('today-games-value')) el('today-games-value').textContent = stats.todayGames;
			}
		}

		// ==================== ç•™è¨€æ¿ç³»ç»Ÿ ====================
		const MESSAGES_PER_PAGE = 10;
		let currentMessagePage = 1;
		let totalMessagePages = 1;
		let replyToMessage = null;
		let messagesCache = null;

		// åŠ è½½ç•™è¨€
		async function loadMessages(page = 1) {
			const listEl = document.getElementById('message-list');
			const paginationEl = document.getElementById('message-pagination');
			
			if (!supabase) {
				listEl.innerHTML = '<div class="no-messages"><i class="fas fa-database"></i><div>ç•™è¨€æœåŠ¡æš‚ä¸å¯ç”¨</div></div>';
				return;
			}
			
			listEl.innerHTML = '<div style="text-align:center;color:var(--text-secondary);font-size:0.85rem;padding:20px;"><i class="fas fa-spinner fa-spin"></i> åŠ è½½ç•™è¨€ä¸­...</div>';
			
			try {
				// è·å–ä¸»ç•™è¨€æ€»æ•°
				const { count: totalCount, error: countError } = await supabase
					.from('messages')
					.select('*', { count: 'exact', head: true })
					.is('parent_id', null);
				
				if (countError) throw countError;
				
				totalMessagePages = Math.max(1, Math.ceil(totalCount / MESSAGES_PER_PAGE));
				currentMessagePage = Math.min(page, totalMessagePages);
				
				// è·å–å½“å‰é¡µçš„ä¸»ç•™è¨€
				const offset = (currentMessagePage - 1) * MESSAGES_PER_PAGE;
				const { data: mainMessages, error: mainError } = await supabase
					.from('messages')
					.select('*')
					.is('parent_id', null)
					.order('created_at', { ascending: false })
					.range(offset, offset + MESSAGES_PER_PAGE - 1);
				
				if (mainError) throw mainError;
				
				if (!mainMessages || mainMessages.length === 0) {
					listEl.innerHTML = '<div class="no-messages"><i class="fas fa-comment-slash"></i><div>æš‚æ— ç•™è¨€ï¼Œæ¥åšç¬¬ä¸€ä¸ªç•™è¨€çš„äººå§ï¼</div></div>';
					paginationEl.style.display = 'none';
					return;
				}
				
				// è·å–è¿™äº›ä¸»ç•™è¨€çš„æ‰€æœ‰å›å¤
				const mainIds = mainMessages.map(m => m.id);
				const { data: replies, error: repliesError } = await supabase
					.from('messages')
					.select('*')
					.in('parent_id', mainIds)
					.order('created_at', { ascending: true });
				
				if (repliesError) throw repliesError;
				
				// æŒ‰parent_idåˆ†ç»„å›å¤
				const repliesMap = {};
				(replies || []).forEach(reply => {
					if (!repliesMap[reply.parent_id]) {
						repliesMap[reply.parent_id] = [];
					}
					repliesMap[reply.parent_id].push(reply);
				});
				
				// æ¸²æŸ“ç•™è¨€
				listEl.innerHTML = mainMessages.map(msg => renderMessage(msg, repliesMap[msg.id] || [])).join('');
				
				// æ›´æ–°åˆ†é¡µ
				updatePagination();
				paginationEl.style.display = totalMessagePages > 1 ? 'block' : 'none';
				
			} catch (e) {
				console.error('åŠ è½½ç•™è¨€å¤±è´¥:', e);
				listEl.innerHTML = `<div class="no-messages"><i class="fas fa-exclamation-triangle"></i><div>åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div><button class="btn btn-info" onclick="loadMessages(${currentMessagePage})" style="margin-top:10px;"><i class="fas fa-redo"></i> é‡è¯•</button></div>`;
			}
		}

		// æ¸²æŸ“å•æ¡ç•™è¨€
		function renderMessage(msg, replies = []) {
			const time = formatMessageTime(msg.created_at);
			const replyCount = replies.length;
			
			let repliesHtml = '';
			if (replyCount > 0) {
				repliesHtml = `
					<div class="message-replies">
						${replies.map(reply => `
							<div class="message-item reply">
								<div class="message-header">
									<span class="message-nickname">${escapeHtml(reply.nickname)}</span>
									<span class="message-time">${formatMessageTime(reply.created_at)}</span>
								</div>
								<div class="message-content">${escapeHtml(reply.content)}</div>
							</div>
						`).join('')}
					</div>
				`;
			}
			
			return `
				<div class="message-item" data-id="${msg.id}">
					<div class="message-header">
						<span class="message-nickname">${escapeHtml(msg.nickname)}</span>
						<span class="message-time">${time}</span>
					</div>
					<div class="message-content">${escapeHtml(msg.content)}</div>
					<div class="message-actions">
						<button onclick="setReplyTo(${msg.id}, '${escapeHtml(msg.nickname)}', '${escapeHtml(msg.content.substring(0, 30))}')">
							<i class="fas fa-reply"></i> å›å¤
						</button>
						${replyCount > 0 ? `<span class="reply-count"><i class="fas fa-comments"></i> ${replyCount} æ¡å›å¤</span>` : ''}
					</div>
					${repliesHtml}
				</div>
			`;
		}

		// æ ¼å¼åŒ–æ—¶é—´
		function formatMessageTime(dateStr) {
			const date = new Date(dateStr);
			const now = new Date();
			const diff = now - date;
			
			// 1åˆ†é’Ÿå†…
			if (diff < 60 * 1000) {
				return 'åˆšåˆš';
			}
			// 1å°æ—¶å†…
			if (diff < 60 * 60 * 1000) {
				return `${Math.floor(diff / 60 / 1000)} åˆ†é’Ÿå‰`;
			}
			// 24å°æ—¶å†…
			if (diff < 24 * 60 * 60 * 1000) {
				return `${Math.floor(diff / 60 / 60 / 1000)} å°æ—¶å‰`;
			}
			// 7å¤©å†…
			if (diff < 7 * 24 * 60 * 60 * 1000) {
				return `${Math.floor(diff / 24 / 60 / 60 / 1000)} å¤©å‰`;
			}
			// æ›´æ—©
			return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
		}

		// HTMLè½¬ä¹‰
		function escapeHtml(text) {
			const div = document.createElement('div');
			div.textContent = text;
			return div.innerHTML;
		}

		// è®¾ç½®å›å¤ç›®æ ‡
		function setReplyTo(id, nickname, preview) {
			replyToMessage = { id, nickname };
			document.getElementById('reply-indicator').style.display = 'block';
			document.getElementById('reply-to-name').textContent = nickname;
			document.getElementById('reply-preview').textContent = preview.length >= 30 ? preview + '...' : preview;
			document.getElementById('msg-content').focus();
			document.getElementById('msg-content').placeholder = `å›å¤ ${nickname}...`;
		}

		// å–æ¶ˆå›å¤
		function cancelReply() {
			replyToMessage = null;
			document.getElementById('reply-indicator').style.display = 'none';
			document.getElementById('msg-content').placeholder = 'è¯´ç‚¹ä»€ä¹ˆå§...ï¼ˆæ”¯æŒå›å¤å…¶ä»–äººçš„ç•™è¨€ï¼‰';
		}

		// å‘è¡¨ç•™è¨€
		async function postMessage() {
			const nicknameInput = document.getElementById('msg-nickname');
			const contentInput = document.getElementById('msg-content');
			
			const nickname = nicknameInput.value.trim();
			const content = contentInput.value.trim();
			
			if (!nickname) {
				showModal('âŒ æç¤º', '<p>è¯·è¾“å…¥æ˜µç§°ï¼</p>', [{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
				nicknameInput.focus();
				return;
			}
			
			if (!content) {
				showModal('âŒ æç¤º', '<p>è¯·è¾“å…¥ç•™è¨€å†…å®¹ï¼</p>', [{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
				contentInput.focus();
				return;
			}
			
			if (nickname.length > 20) {
				showModal('âŒ æç¤º', '<p>æ˜µç§°ä¸èƒ½è¶…è¿‡20ä¸ªå­—ç¬¦ï¼</p>', [{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			if (content.length > 500) {
				showModal('âŒ æç¤º', '<p>ç•™è¨€å†…å®¹ä¸èƒ½è¶…è¿‡500ä¸ªå­—ç¬¦ï¼</p>', [{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			if (!supabase) {
				showModal('âŒ é”™è¯¯', '<p>ç•™è¨€æœåŠ¡æš‚ä¸å¯ç”¨</p>', [{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			try {
				const messageData = {
					nickname: nickname,
					content: content,
					parent_id: replyToMessage ? replyToMessage.id : null
				};
				
				const { error } = await supabase.from('messages').insert(messageData);
				
				if (error) throw error;
				
				// æ¸…ç©ºè¾“å…¥
				contentInput.value = '';
				cancelReply();
				
				// ä¿å­˜æ˜µç§°åˆ°æœ¬åœ°
				localStorage.setItem('graduateSimulator_nickname', nickname);
				
				// å¦‚æœæ˜¯å›å¤ï¼Œåˆ·æ–°å½“å‰é¡µï¼›å¦‚æœæ˜¯æ–°ç•™è¨€ï¼Œè·³è½¬åˆ°ç¬¬ä¸€é¡µ
				if (replyToMessage) {
					await loadMessages(currentMessagePage);
				} else {
					await loadMessages(1);
				}
				
				showModal('âœ… æˆåŠŸ', '<p>ç•™è¨€å‘è¡¨æˆåŠŸï¼</p>', [{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
				
			} catch (e) {
				console.error('å‘è¡¨ç•™è¨€å¤±è´¥:', e);
				showModal('âŒ é”™è¯¯', '<p>å‘è¡¨å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>', [{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
			}
		}

		// ç¿»é¡µ
		function changeMessagePage(delta) {
			const newPage = currentMessagePage + delta;
			if (newPage >= 1 && newPage <= totalMessagePages) {
				loadMessages(newPage);
			}
		}

		// æ›´æ–°åˆ†é¡µUI
		function updatePagination() {
			document.getElementById('page-info').textContent = `ç¬¬ ${currentMessagePage} / ${totalMessagePages} é¡µ`;
			document.getElementById('prev-page-btn').disabled = currentMessagePage <= 1;
			document.getElementById('next-page-btn').disabled = currentMessagePage >= totalMessagePages;
		}

		// åˆå§‹åŒ–ç•™è¨€æ¿
		function initMessageBoard() {
			// æ¢å¤ä¿å­˜çš„æ˜µç§°
			const savedNickname = localStorage.getItem('graduateSimulator_nickname');
			if (savedNickname) {
				document.getElementById('msg-nickname').value = savedNickname;
			}
			
			// åŠ è½½ç•™è¨€
			loadMessages(1);
		}

		// å¯åŠ¨åœ¨çº¿è¿½è¸ªï¼ˆå¿ƒè·³æŒç»­ï¼Œç»Ÿè®¡åªæŸ¥ä¸€æ¬¡ï¼‰
		function startOnlineTracking() {
			if (!supabase) return;
			
			onlineSessionId = getOnlineSessionId();
			
			// ç«‹å³å¿ƒè·³
			sendOnlineHeartbeat();
			
			// åªæŸ¥è¯¢ä¸€æ¬¡ç»Ÿè®¡
			updateAllStatsDisplay();
			
			// æŒç»­å¿ƒè·³ï¼ˆæ¸¸æˆä¸­ä¹Ÿå‘ï¼‰
			if (!onlineHeartbeatTimer) {
				onlineHeartbeatTimer = setInterval(sendOnlineHeartbeat, 60 * 1000);
			}
		}


		// ==================== æ¸¸æˆè¯´æ˜ç³»ç»Ÿ ====================

		function showGuide(type) {
			let title = '';
			let content = '';
			
			switch(type) {
				case 'basics':
					title = 'ğŸ“– åŸºç¡€ç©æ³•ä¸å±æ€§';
					content = `
		<div style="max-height:60vh;overflow-y:auto;font-size:0.85rem;line-height:1.6;">
			<div style="background:linear-gradient(135deg,rgba(108,92,231,0.1),rgba(162,155,254,0.1));border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--primary-color);margin:0 0 8px 0;">ğŸ¯ æ¸¸æˆç›®æ ‡</h4>
				<ul style="margin:0;padding-left:20px;">
					<li><strong>ç¡•å£«æ¯•ä¸š</strong>ï¼š3å¹´ï¼ˆ36ä¸ªæœˆï¼‰å†…ç§‘ç ”åˆ†â‰¥1</li>
					<li><strong>åšå£«æ¯•ä¸š</strong>ï¼š5å¹´ï¼ˆ60ä¸ªæœˆï¼‰å†…ç§‘ç ”åˆ†â‰¥7</li>
					<li><strong>è½¬åšæ¡ä»¶</strong>ï¼šç¡•å£«ç¬¬2å¹´12æœˆç§‘ç ”åˆ†â‰¥2ï¼Œæˆ–ç¬¬3å¹´12æœˆç§‘ç ”åˆ†â‰¥3</li>
				</ul>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--success-color);margin:0 0 8px 0;">ğŸ“Š äº”å¤§å±æ€§è¯¦è§£</h4>
				
				<div style="margin-bottom:10px;padding:8px;background:var(--card-bg);border-radius:6px;border-left:3px solid #e74c3c;">
					<strong>ğŸ§  SANå€¼ï¼ˆç²¾ç¥çŠ¶æ€ï¼‰</strong>
					<div style="font-size:0.8rem;color:var(--text-secondary);">
						â€¢ åˆå§‹å€¼ï¼š20/20<br>
						â€¢ æ¯æœˆè‡ªç„¶æ¢å¤ï¼š+1ï¼ˆé€†ä½å¤§å¤šæ•°+3/+4ï¼‰<br>
						â€¢ <span style="color:var(--danger-color);">é™ä¸ºè´Ÿæ•°è§¦å‘"ä¸å ªé‡è´Ÿ"ç»“å±€</span><br>
						â€¢ è®¾è®¡æ€è·¯ï¼šæ¨¡æ‹Ÿç ”ç©¶ç”Ÿçš„ç²¾ç¥å‹åŠ›ï¼Œéœ€è¦å¹³è¡¡ç§‘ç ”å¼ºåº¦å’Œä¼‘æ¯
					</div>
				</div>
				
				<div style="margin-bottom:10px;padding:8px;background:var(--card-bg);border-radius:6px;border-left:3px solid #3498db;">
					<strong>ğŸ”¬ ç§‘ç ”èƒ½åŠ›</strong>
					<div style="font-size:0.8rem;color:var(--text-secondary);">
						â€¢ åˆå§‹å€¼ï¼š1ï¼Œä¸Šé™ï¼š20<br>
						â€¢ ç›´æ¥å½±å“è®ºæ–‡åˆ†æ•°ç”Ÿæˆ<br>
						â€¢ <strong>è§£é”è®ºæ–‡æ§½</strong>ï¼š6â†’ç¬¬2æ§½ï¼Œ12â†’ç¬¬3æ§½ï¼Œ18â†’ç¬¬4æ§½<br>
						â€¢ å…¬å¼å½±å“ï¼šåŸºç¡€åˆ† = ç§‘ç ”èƒ½åŠ› Ã— (0.5~1.5éšæœº)<br>
						â€¢ è®¾è®¡æ€è·¯ï¼šæ ¸å¿ƒæˆé•¿å±æ€§ï¼Œå†³å®šè®ºæ–‡è´¨é‡ä¸Šé™
					</div>
				</div>
				
				<div style="margin-bottom:10px;padding:8px;background:var(--card-bg);border-radius:6px;border-left:3px solid #9b59b6;">
					<strong>ğŸ‘¥ ç¤¾äº¤èƒ½åŠ›</strong>
					<div style="font-size:0.8rem;color:var(--text-secondary);">
						â€¢ åˆå§‹å€¼ï¼š1ï¼Œä¸Šé™ï¼š20<br>
						â€¢ è¾¾åˆ°<strong>6çº§</strong>ï¼šè§£é”å¼€ä¼šé«˜çº§é€‰é¡¹ã€è®©å¸ˆå¼Ÿåˆ†æ‹…æ— æƒ©ç½š<br>
						â€¢ è¾¾åˆ°<strong>12çº§</strong>ï¼šè§£é”æ‹äººé€‰é¡¹ã€æ›´å¤šåˆä½œæœºä¼š<br>
						â€¢ <span style="color:var(--danger-color);">é™ä¸ºè´Ÿæ•°è§¦å‘"è¢«å­¤ç«‹"ç»“å±€</span><br>
						â€¢ è®¾è®¡æ€è·¯ï¼šå½±å“äººé™…å…³ç³»å’Œäº‹ä»¶é€‰é¡¹ï¼Œé«˜ç¤¾äº¤èƒ½è·å¾—æ›´å¤šå¸®åŠ©
					</div>
				</div>
				
				<div style="margin-bottom:10px;padding:8px;background:var(--card-bg);border-radius:6px;border-left:3px solid #e91e63;">
					<strong>â¤ï¸ å¯¼å¸ˆå¥½æ„Ÿåº¦</strong>
					<div style="font-size:0.8rem;color:var(--text-secondary);">
						â€¢ åˆå§‹å€¼ï¼š1ï¼Œä¸Šé™ï¼š20<br>
						â€¢ è¾¾åˆ°<strong>6çº§</strong>ï¼šå¼€ä¼šæŠ¥é”€åªæ‰£1å¥½æ„Ÿã€å¯¼å¸ˆæ›´å®¹æ˜“è¢«è¯´æœ<br>
						â€¢ è¾¾åˆ°<strong>12çº§</strong>ï¼šè·å¾—æ›´å¤šèµ„æºæ”¯æŒ<br>
						â€¢ <span style="color:var(--danger-color);">é™ä¸ºè´Ÿæ•°è§¦å‘"é€å‡ºå¸ˆé—¨"ç»“å±€</span><br>
						â€¢ è®¾è®¡æ€è·¯ï¼šæ¨¡æ‹Ÿå¯¼å­¦å…³ç³»ï¼Œå½±å“èµ„æºè·å–å’Œäº‹ä»¶ç»“æœ
					</div>
				</div>
				
				<div style="padding:8px;background:var(--card-bg);border-radius:6px;border-left:3px solid #f39c12;">
					<strong>ğŸ’° é‡‘å¸</strong>
					<div style="font-size:0.8rem;color:var(--text-secondary);">
						â€¢ åˆå§‹å€¼ï¼š1<br>
						â€¢ æ¯æœˆæ”¶å…¥ï¼šç¡•å£«+1ï¼Œåšå£«+3ï¼ˆæ‰£é™¤1å¼€é”€ï¼‰<br>
						â€¢ ç”¨é€”ï¼šå•†åº—è´­ç‰©ã€å¼€ä¼šè´¹ç”¨ã€çº¦ä¼šå¼€é”€<br>
						â€¢ <span style="color:var(--danger-color);">é™ä¸ºè´Ÿæ•°è§¦å‘"ç©·å›°æ½¦å€’"ç»“å±€</span><br>
						â€¢ è®¾è®¡æ€è·¯ï¼šæ¨¡æ‹Ÿç»æµå‹åŠ›ï¼Œéœ€è¦åˆç†è§„åˆ’æ”¯å‡º
					</div>
				</div>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--warning-color);margin:0 0 8px 0;">ğŸ® åŸºæœ¬æ“ä½œ</h4>
				<table style="width:100%;font-size:0.8rem;border-collapse:collapse;">
					<tr style="background:var(--card-bg);">
						<th style="padding:6px;text-align:left;border-bottom:1px solid var(--border-color);">æ“ä½œ</th>
						<th style="padding:6px;text-align:center;border-bottom:1px solid var(--border-color);">æ¶ˆè€—</th>
						<th style="padding:6px;text-align:left;border-bottom:1px solid var(--border-color);">æ•ˆæœ</th>
					</tr>
					<tr><td style="padding:6px;">ğŸ“– çœ‹è®ºæ–‡</td><td style="padding:6px;text-align:center;">SAN-2</td><td style="padding:6px;">ä¸‹æ¬¡æƒ³idea+1åˆ†ï¼Œæ¯5æ¬¡ç§‘ç ”+1</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">ğŸ’¼ æ‰“å·¥</td><td style="padding:6px;text-align:center;">SAN-5</td><td style="padding:6px;">é‡‘é’±+2</td></tr>
					<tr><td style="padding:6px;">ğŸ’¡ æƒ³idea</td><td style="padding:6px;text-align:center;">SAN-2</td><td style="padding:6px;">å¢åŠ è®ºæ–‡ideaåˆ†æ•°</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">ğŸ”¬ åšå®éªŒ</td><td style="padding:6px;text-align:center;">SAN-3</td><td style="padding:6px;">å¢åŠ è®ºæ–‡å®éªŒåˆ†æ•°</td></tr>
					<tr><td style="padding:6px;">âœï¸ å†™è®ºæ–‡</td><td style="padding:6px;text-align:center;">SAN-4</td><td style="padding:6px;">å¢åŠ è®ºæ–‡å†™ä½œåˆ†æ•°</td></tr>
				</table>
				<div style="margin-top:8px;font-size:0.75rem;color:var(--text-secondary);">
					âš ï¸ æ¯æœˆåªèƒ½æ‰§è¡Œ1æ¬¡æŒç»­æ“ä½œï¼ˆéšè—è§‰é†’"å‹¤èƒ½è¡¥æ‹™"å¯å¢åŠ åˆ°2æ¬¡ï¼‰
				</div>
			</div>
			
			<div style="background:linear-gradient(135deg,rgba(0,184,148,0.1),rgba(85,239,196,0.1));border-radius:10px;padding:12px;">
				<h4 style="color:var(--success-color);margin:0 0 8px 0;">ğŸ’¡ è®¾è®¡æ€è·¯</h4>
				<div style="font-size:0.8rem;color:var(--text-secondary);">
					æ¸¸æˆæ¨¡æ‹ŸçœŸå®ç ”ç©¶ç”Ÿç”Ÿæ´»çš„èµ„æºç®¡ç†ï¼š
					<ul style="margin:5px 0;padding-left:20px;">
						<li><strong>ç²¾åŠ›æœ‰é™</strong>ï¼šSANå€¼ä»£è¡¨ç²¾ç¥çŠ¶æ€ï¼Œè¿‡åº¦åŠ³ç´¯ä¼šå´©æºƒ</li>
						<li><strong>å¤šç»´å¹³è¡¡</strong>ï¼šç§‘ç ”ã€ç¤¾äº¤ã€å¯¼å¸ˆå…³ç³»ã€ç»æµéƒ½éœ€è¦å…¼é¡¾</li>
						<li><strong>å±æ€§é—¨æ§›</strong>ï¼š6/12æ˜¯å…³é”®èŠ‚ç‚¹ï¼Œè§£é”æ›´å¤šé€‰é¡¹</li>
						<li><strong>å»ºè®®</strong>ï¼šå‰æœŸä¼˜å…ˆå°†ç§‘ç ”å’Œç¤¾äº¤æå‡åˆ°6ï¼Œè§£é”æ›´å¤šå¯èƒ½æ€§</li>
					</ul>
				</div>
			</div>
		</div>`;
					break;
					
				case 'paperScore':
					title = 'ğŸ“Š è®ºæ–‡åˆ†æ•°è®¡ç®—';
					content = `
		<div style="max-height:60vh;overflow-y:auto;font-size:0.85rem;line-height:1.6;">
			<div style="background:linear-gradient(135deg,rgba(108,92,231,0.1),rgba(162,155,254,0.1));border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--primary-color);margin:0 0 8px 0;">ğŸ“ åŸºç¡€åˆ†æ•°å…¬å¼</h4>
				<div style="background:var(--card-bg);border-radius:8px;padding:10px;font-family:monospace;font-size:0.85rem;">
					<div style="color:var(--success-color);margin-bottom:5px;">// å•æ¬¡æ“ä½œç”Ÿæˆåˆ†æ•°</div>
					åŸºç¡€åˆ† = round(ç§‘ç ”èƒ½åŠ› Ã— éšæœº(0.5~1.5) + éšæœº(0~5))<br>
					æœ€ç»ˆåˆ† = åŸºç¡€åˆ† Ã— buffä¹˜æ•° + buffåŠ æˆ<br><br>
					<div style="color:var(--success-color);margin-bottom:5px;">// ä¿åº•æœºåˆ¶</div>
					å®é™…åˆ†æ•° = max(ç”Ÿæˆåˆ†æ•°, å½“å‰åˆ†æ•° + 1)
				</div>
				<div style="margin-top:8px;font-size:0.8rem;color:var(--text-secondary);">
					ğŸ’¡ <strong>ä¿åº•æœºåˆ¶</strong>ï¼šæ— è®ºç”Ÿæˆå¤šå°‘åˆ†ï¼Œæ¯æ¬¡æ“ä½œè‡³å°‘è®©åˆ†æ•°+1
				</div>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--warning-color);margin:0 0 8px 0;">ğŸ“ˆ åˆ†æ•°æœŸæœ›å€¼è®¡ç®—</h4>
				<table style="width:100%;font-size:0.8rem;border-collapse:collapse;">
					<tr style="background:var(--card-bg);">
						<th style="padding:6px;border-bottom:1px solid var(--border-color);">ç§‘ç ”èƒ½åŠ›</th>
						<th style="padding:6px;border-bottom:1px solid var(--border-color);">æœŸæœ›åŸºç¡€åˆ†</th>
						<th style="padding:6px;border-bottom:1px solid var(--border-color);">åˆ†æ•°èŒƒå›´</th>
					</tr>
					<tr><td style="padding:6px;text-align:center;">1</td><td style="padding:6px;text-align:center;">3.5</td><td style="padding:6px;text-align:center;">1~7</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;text-align:center;">5</td><td style="padding:6px;text-align:center;">7.5</td><td style="padding:6px;text-align:center;">3~13</td></tr>
					<tr><td style="padding:6px;text-align:center;">10</td><td style="padding:6px;text-align:center;">12.5</td><td style="padding:6px;text-align:center;">5~20</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;text-align:center;">15</td><td style="padding:6px;text-align:center;">17.5</td><td style="padding:6px;text-align:center;">8~28</td></tr>
					<tr><td style="padding:6px;text-align:center;">20</td><td style="padding:6px;text-align:center;">22.5</td><td style="padding:6px;text-align:center;">10~35</td></tr>
				</table>
				<div style="margin-top:8px;font-size:0.75rem;color:var(--text-secondary);">
					å…¬å¼ï¼šæœŸæœ›å€¼ = ç§‘ç ”èƒ½åŠ› Ã— 1.0 + 2.5ï¼ˆéšæœºéƒ¨åˆ†æœŸæœ›ï¼‰
				</div>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--danger-color);margin:0 0 8px 0;">â³ åˆ†æ•°è¡°å‡æœºåˆ¶</h4>
				<div style="background:var(--card-bg);border-radius:8px;padding:10px;font-family:monospace;font-size:0.85rem;">
					æ¯æœˆè¡°å‡ï¼šideaåˆ†æ•°-1ï¼Œå®éªŒåˆ†æ•°-1ï¼ˆå†™ä½œä¸è¡°å‡ï¼‰<br>
					æœ€ä½è¡°å‡è‡³ï¼š1
				</div>
				<div style="margin-top:8px;font-size:0.8rem;color:var(--text-secondary);">
					âš ï¸ <strong>è®¾è®¡æ€è·¯</strong>ï¼šæ¨¡æ‹Ÿç§‘ç ”æ—¶æ•ˆæ€§ï¼Œçƒ­ç‚¹ä¼šè¿‡æ—¶ï¼Œéœ€è¦åŠæ—¶æŠ•ç¨¿<br>
					ğŸ’¡ éšè—è§‰é†’"é¢„è§æœªæ¥çƒ­ç‚¹"å¯ä»¥å®Œå…¨ç¦æ­¢è¡°å‡
				</div>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--success-color);margin:0 0 8px 0;">âœ¨ BuffåŠ æˆç³»ç»Ÿ</h4>
				<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:0.8rem;">
					<div style="padding:8px;background:var(--card-bg);border-radius:6px;">
						<strong>åŠ æ³•Buffï¼ˆå åŠ ï¼‰</strong><br>
						â€¢ çœ‹è®ºæ–‡ï¼šä¸‹æ¬¡idea+1<br>
						â€¢ å¯¼å¸ˆæŒ‡ç‚¹ï¼šidea+5<br>
						â€¢ åŒå­¦åˆä½œï¼šå®éªŒ+5<br>
						â€¢ å¤§ç‰›åˆä½œï¼šå†™ä½œ+8
					</div>
					<div style="padding:8px;background:var(--card-bg);border-radius:6px;">
						<strong>ä¹˜æ³•Buffï¼ˆå åŠ ï¼‰</strong><br>
						â€¢ å¤§ç‰›äº¤æµï¼šideaÃ—1.25<br>
						â€¢ ä¼ä¸šäº¤æµï¼šå®éªŒÃ—1.25<br>
						â€¢ AI Labå®ä¹ ï¼šå®éªŒÃ—1.25
					</div>
				</div>
				<div style="margin-top:8px;font-size:0.75rem;color:var(--text-secondary);">
					è®¡ç®—é¡ºåºï¼šå…ˆä¹˜ååŠ ï¼Œå³ æœ€ç»ˆåˆ† = åŸºç¡€åˆ† Ã— ä¹˜æ•° + åŠ æˆ
				</div>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:#e74c3c;margin:0 0 8px 0;">ğŸ˜° Debuffæƒ©ç½šç³»ç»Ÿ</h4>
				<div style="font-size:0.8rem;">
					<div style="padding:8px;background:rgba(231,76,60,0.1);border-radius:6px;margin-bottom:6px;">
						<strong>ç–²åŠ³ç´¯ç§¯</strong>ï¼ˆæ¯è¿ç»­æ“ä½œ5æ¬¡è§¦å‘ï¼‰<br>
						â€¢ çµæ„Ÿæ¯ç«­ï¼šä¸‹æ¬¡æƒ³ideaæ€»åˆ†Ã·2<br>
						â€¢ ä¸»æœºå‘çƒ«ï¼šä¸‹æ¬¡åšå®éªŒæ€»åˆ†Ã·2<br>
						â€¢ æ— ä»ä¸‹ç¬”ï¼šä¸‹æ¬¡å†™è®ºæ–‡æ€»åˆ†Ã·2
					</div>
					<div style="padding:8px;background:rgba(231,76,60,0.1);border-radius:6px;">
						<strong>æ¾æ‡ˆdebuff</strong>ï¼ˆè¿ç»­ä¸­ç¨¿3ç¯‡è§¦å‘ï¼‰<br>
						â€¢ ä¸‹æœˆæ‰€æœ‰æ“ä½œæ€»åˆ†Ã·2<br>
						â€¢ ä¼‘æ¯ä¸€ä¸ªæœˆè‡ªåŠ¨æ¶ˆé™¤
					</div>
				</div>
			</div>
			
			<div style="background:linear-gradient(135deg,rgba(0,184,148,0.1),rgba(85,239,196,0.1));border-radius:10px;padding:12px;">
				<h4 style="color:var(--success-color);margin:0 0 8px 0;">ğŸ¯ æŠ•ç¨¿åˆ†æ•°å‚è€ƒ</h4>
				<table style="width:100%;font-size:0.8rem;border-collapse:collapse;">
					<tr style="background:var(--card-bg);">
						<th style="padding:6px;">ç­‰çº§</th>
						<th style="padding:6px;">Posterå‚è€ƒ</th>
						<th style="padding:6px;">Oralå‚è€ƒ</th>
						<th style="padding:6px;">Best Paper</th>
					</tr>
					<tr><td style="padding:6px;text-align:center;color:#e74c3c;font-weight:bold;">Aç±»</td><td style="padding:6px;text-align:center;">â‰¥70</td><td style="padding:6px;text-align:center;">â‰¥85</td><td style="padding:6px;text-align:center;">â‰¥100</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;text-align:center;color:#f39c12;font-weight:bold;">Bç±»</td><td style="padding:6px;text-align:center;">â‰¥45</td><td style="padding:6px;text-align:center;">â‰¥55</td><td style="padding:6px;text-align:center;">â‰¥70</td></tr>
					<tr><td style="padding:6px;text-align:center;color:#27ae60;font-weight:bold;">Cç±»</td><td style="padding:6px;text-align:center;">â‰¥30</td><td style="padding:6px;text-align:center;">â‰¥35</td><td style="padding:6px;text-align:center;">â‰¥45</td></tr>
				</table>
				<div style="margin-top:8px;font-size:0.75rem;color:var(--text-secondary);">
					âš ï¸ ä»¥ä¸Šä¸ºå‚è€ƒå€¼ï¼Œå®é™…å½•å–å—å®¡ç¨¿äººã€ä¼šè®®çƒ­åº¦ç­‰å½±å“
				</div>
			</div>
		</div>`;
					break;
					
				case 'review':
					title = 'ğŸ“ å®¡ç¨¿æœºåˆ¶è¯¦è§£';
					content = `
		<div style="max-height:60vh;overflow-y:auto;font-size:0.85rem;line-height:1.6;">
			<div style="background:linear-gradient(135deg,rgba(108,92,231,0.1),rgba(162,155,254,0.1));border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--primary-color);margin:0 0 8px 0;">ğŸ‘¨â€ğŸ”¬ å®¡ç¨¿äººç±»å‹ä¸æ¦‚ç‡</h4>
				<table style="width:100%;font-size:0.8rem;border-collapse:collapse;">
					<tr style="background:var(--card-bg);">
						<th style="padding:6px;text-align:left;">ç±»å‹</th>
						<th style="padding:6px;text-align:center;">æ¦‚ç‡</th>
						<th style="padding:6px;text-align:left;">ç‰¹ç‚¹</th>
					</tr>
					<tr><td style="padding:6px;">æ™®é€šå®¡ç¨¿äºº</td><td style="padding:6px;text-align:center;">40%</td><td style="padding:6px;font-size:0.75rem;">æ ‡å‡†è¯„å®¡ï¼Œå¯èƒ½ç»™æ”¹è¿›å»ºè®®(+3)</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;color:var(--success-color);">å¿ƒè½¯å®¡ç¨¿äºº</td><td style="padding:6px;text-align:center;">10%</td><td style="padding:6px;font-size:0.75rem;">å®½æ¾è¯„å®¡ï¼Œçœ‹æœ€é«˜ä¸¤é¡¹åˆ†æ•°</td></tr>
					<tr><td style="padding:6px;color:var(--primary-color);">èµ„æ·±å¤§ç‰›</td><td style="padding:6px;text-align:center;">10%</td><td style="padding:6px;font-size:0.75rem;">é‡è§†idea(Ã—2)ï¼Œç»™é«˜è´¨é‡å»ºè®®(+8)</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;color:var(--danger-color);">æ¶æ„å°åŒè¡Œ</td><td style="padding:6px;text-align:center;">10%</td><td style="padding:6px;font-size:0.75rem;">ä¸¥è‹›è¯„å®¡ï¼Œçœ‹æœ€ä½ä¸¤é¡¹ï¼ŒSAN-1</td></tr>
					<tr><td style="padding:6px;color:var(--warning-color);">GPTå®¡ç¨¿äºº</td><td style="padding:6px;text-align:center;">20%</td><td style="padding:6px;font-size:0.75rem;">éšæœºæƒé‡è¯„å®¡</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;color:var(--danger-color);">39é—®é¢˜å®¡ç¨¿äºº</td><td style="padding:6px;text-align:center;">10%</td><td style="padding:6px;font-size:0.75rem;">åªçœ‹æœ€ä½åˆ†(Ã—3)ï¼ŒSAN-1</td></tr>
				</table>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--warning-color);margin:0 0 8px 0;">ğŸ“ æœ‰æ•ˆåˆ†è®¡ç®—å…¬å¼</h4>
				<div style="font-size:0.8rem;background:var(--card-bg);border-radius:8px;padding:10px;font-family:monospace;">
					<div style="margin-bottom:6px;"><strong>æ™®é€š/GPTå®¡ç¨¿äººï¼š</strong></div>
					æœ‰æ•ˆåˆ† = ideaÃ—w1 + expÃ—w2 + writeÃ—w3<br>
					<span style="color:var(--text-secondary);">// w1,w2,w3éšæœºï¼Œå„åœ¨0.8~1.4ä¹‹é—´ï¼Œæ€»å’Œä¸º3</span><br><br>
					
					<div style="margin-bottom:6px;"><strong>èµ„æ·±å¤§ç‰›ï¼š</strong></div>
					æœ‰æ•ˆåˆ† = ideaÃ—2 + expÃ—0.5 + writeÃ—0.5<br><br>
					
					<div style="margin-bottom:6px;"><strong>å¿ƒè½¯å®¡ç¨¿äººï¼š</strong></div>
					æœ‰æ•ˆåˆ† = æœ€é«˜åˆ†Ã—1.5 + æ¬¡é«˜åˆ†Ã—1.5<br><br>
					
					<div style="margin-bottom:6px;"><strong>æ¶æ„å°åŒè¡Œï¼š</strong></div>
					æœ‰æ•ˆåˆ† = æœ€ä½åˆ†Ã—1.5 + æ¬¡ä½åˆ†Ã—1.5<br><br>
					
					<div style="margin-bottom:6px;"><strong>39é—®é¢˜å®¡ç¨¿äººï¼š</strong></div>
					æœ‰æ•ˆåˆ† = æœ€ä½åˆ†Ã—3
				</div>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--success-color);margin:0 0 8px 0;">ğŸ¯ å½•å–é˜ˆå€¼ï¼ˆAç±»ä¸ºä¾‹ï¼‰</h4>
				<table style="width:100%;font-size:0.8rem;border-collapse:collapse;">
					<tr style="background:var(--card-bg);">
						<th style="padding:6px;">å®¡ç¨¿äºº</th>
						<th style="padding:6px;">Rejecté˜ˆå€¼</th>
						<th style="padding:6px;">Borderlineé˜ˆå€¼</th>
					</tr>
					<tr><td style="padding:6px;">æ™®é€š/èµ„æ·±</td><td style="padding:6px;text-align:center;">&lt;50</td><td style="padding:6px;text-align:center;">&lt;80</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">å¿ƒè½¯</td><td style="padding:6px;text-align:center;">&lt;40</td><td style="padding:6px;text-align:center;">&lt;60</td></tr>
					<tr><td style="padding:6px;">GPT</td><td style="padding:6px;text-align:center;">&lt;40</td><td style="padding:6px;text-align:center;">&lt;90</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">æ¶æ„/39é—®é¢˜</td><td style="padding:6px;text-align:center;">&lt;70</td><td style="padding:6px;text-align:center;">&lt;100</td></tr>
				</table>
				<div style="margin-top:8px;font-size:0.75rem;color:var(--text-secondary);">
					åˆ¤å®šï¼šæœ‰æ•ˆåˆ† &lt; Rejecté˜ˆå€¼ â†’ Reject(-1)ï¼›&lt; Borderlineé˜ˆå€¼ â†’ Borderline(0)ï¼›å¦åˆ™ â†’ Accept(+1)
				</div>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:#9b59b6;margin:0 0 8px 0;">âš–ï¸ PCæœ€ç»ˆå†³å®š</h4>
				<div style="font-size:0.8rem;">
					<div style="padding:8px;background:var(--card-bg);border-radius:6px;margin-bottom:6px;">
						<strong>æ€»å®¡ç¨¿åˆ† = ä¸‰ä½å®¡ç¨¿äººåˆ†æ•°ä¹‹å’Œ</strong><br>
						â€¢ â‰¥1ï¼šç›´æ¥å½•ç”¨<br>
						â€¢ =0ï¼ˆBorderlineï¼‰ï¼šæ ¹æ®æ¦‚ç‡åˆ¤å®šï¼ˆåŸºç¡€50%~70%ï¼‰<br>
						â€¢ =-1ï¼šå°æ¦‚ç‡å½•ç”¨ï¼ˆåŸºç¡€30%~50%ï¼‰<br>
						â€¢ â‰¤-2ï¼šç›´æ¥æ‹’ç¨¿
					</div>
					<div style="padding:8px;background:rgba(253,203,110,0.15);border-radius:6px;">
						<strong>Borderlineå½•å–æ¦‚ç‡å…¬å¼</strong><br>
						åŸºç¡€æ¦‚ç‡ = ç­‰çº§åŸºç¡€(A:50%,B:60%,C:70%)<br>
						åˆ†æ•°ä¿®æ­£ = sigmoid((è®ºæ–‡åˆ†-åŸºå‡†åˆ†)/èŒƒå›´) Ã— 12%<br>
						æœ€ç»ˆæ¦‚ç‡ = åŸºç¡€æ¦‚ç‡ + åˆ†æ•°ä¿®æ­£
					</div>
				</div>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--info-color);margin:0 0 8px 0;">ğŸŒ¡ï¸ ä¼šè®®çƒ­åº¦è°ƒæ•´</h4>
				<div style="font-size:0.8rem;color:var(--text-secondary);">
					<p>å½“ç´¯è®¡æŠ•ç¨¿â‰¥1000ç¯‡æ—¶ï¼Œç³»ç»Ÿä¼šæ ¹æ®å…¨çƒæŠ•ç¨¿æ•°æ®åŠ¨æ€è°ƒæ•´å½•å–éš¾åº¦ï¼š</p>
					<ul style="margin:5px 0;padding-left:20px;">
						<li><strong>çƒ­é—¨ä¼šè®®</strong>ï¼ˆæŠ•ç¨¿&gt;å¹³å‡150%ï¼‰ï¼šå½•å–é˜ˆå€¼ç•¥å¾®æé«˜</li>
						<li><strong>å†·é—¨ä¼šè®®</strong>ï¼ˆæŠ•ç¨¿&lt;å¹³å‡50%ï¼‰ï¼šå½•å–é˜ˆå€¼ç•¥å¾®é™ä½</li>
					</ul>
					<p style="color:var(--warning-color);">è®¾è®¡æ€è·¯ï¼šæ¨¡æ‹ŸçœŸå®ä¼šè®®çš„ç«äº‰ç¨‹åº¦å·®å¼‚</p>
				</div>
			</div>
			
			<div style="background:linear-gradient(135deg,rgba(0,184,148,0.1),rgba(85,239,196,0.1));border-radius:10px;padding:12px;">
				<h4 style="color:var(--success-color);margin:0 0 8px 0;">ğŸ’¡ æé«˜ä¸­ç¨¿ç‡çš„ç­–ç•¥</h4>
				<ul style="font-size:0.8rem;margin:0;padding-left:20px;">
					<li>å‡è¡¡å‘å±•ä¸‰é¡¹åˆ†æ•°ï¼Œé¿å…æ˜æ˜¾çŸ­æ¿</li>
					<li>èµ„æ·±å¤§ç‰›é‡è§†ideaï¼Œéœ€è¦ä¿è¯ideaåˆ†æ•°é«˜</li>
					<li>é‡åˆ°æ¶æ„å®¡ç¨¿äººæ—¶ï¼Œæœ€ä½åˆ†å¾ˆå…³é”®</li>
					<li>ç¤¾äº¤è¾¾äººè§‰é†’å¯ä»¥æ”¹å˜å®¡ç¨¿äººåˆ†å¸ƒï¼ˆå¢åŠ å¥½å®¡ç¨¿äººæ¦‚ç‡ï¼‰</li>
					<li>æ‹’ç¨¿åè®ºæ–‡ä¼šè·å¾—æ”¹è¿›å»ºè®®ï¼Œå¯é‡æŠ•</li>
				</ul>
			</div>
		</div>`;
					break;
					
				case 'citation':
					title = 'ğŸ“ˆ å¼•ç”¨å¢é•¿å…¬å¼';
					content = `
		<div style="max-height:60vh;overflow-y:auto;font-size:0.85rem;line-height:1.6;">
			<div style="background:linear-gradient(135deg,rgba(108,92,231,0.1),rgba(162,155,254,0.1));border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--primary-color);margin:0 0 8px 0;">ğŸ“ æ ¸å¿ƒå…¬å¼</h4>
				<div style="background:var(--card-bg);border-radius:8px;padding:12px;font-family:monospace;font-size:0.85rem;">
					<div style="color:var(--success-color);margin-bottom:8px;">// æ¯æœˆå¼•ç”¨å¢é•¿è®¡ç®—</div>
					
					<strong>â‘  åŸºç¡€å¢é€Ÿ</strong><br>
					baseScore = max(0, è®ºæ–‡åˆ†æ•° - 2 Ã— å‘è¡¨æœˆæ•°)<br>
					baseGrowth = baseScore Ã— 0.1<br><br>
					
					<strong>â‘¡ ä¼šè®®å½±å“å› å­</strong><br>
					impactFactor = (è¯¥ä¼šè®®ä¸­ç¨¿å‡åˆ†/å¹³å‡ä¸­ç¨¿å‡åˆ†) Ã— (è¯¥ä¼šè®®æŠ•ç¨¿æ•°/å¹³å‡æŠ•ç¨¿æ•°)<br>
					<span style="color:var(--text-secondary);">// èŒƒå›´é™åˆ¶åœ¨ 0.2 ~ 4.0</span><br><br>
					
					<strong>â‘¢ æ¨å¹¿å€ç‡ï¼ˆåŠ æ³•å åŠ ï¼‰</strong><br>
					promotionMultiplier = 1 + å„é¡¹åŠ æˆä¹‹å’Œ<br><br>
					
					<strong>â‘£ æœ€ç»ˆå¢é€Ÿ</strong><br>
					finalGrowth = baseGrowth Ã— impactFactor Ã— promotionMultiplier
				</div>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--warning-color);margin:0 0 8px 0;">ğŸ“Š æ¨å¹¿åŠ æˆæ˜ç»†</h4>
				<table style="width:100%;font-size:0.8rem;border-collapse:collapse;">
					<tr style="background:var(--card-bg);">
						<th style="padding:6px;text-align:left;">æ¨å¹¿æ–¹å¼</th>
						<th style="padding:6px;text-align:center;">åŠ æˆ</th>
						<th style="padding:6px;text-align:center;">æ¶ˆè€—</th>
					</tr>
					<tr><td style="padding:6px;">ğŸ“„ æŒ‚arxiv</td><td style="padding:6px;text-align:center;color:var(--success-color);">+25%</td><td style="padding:6px;text-align:center;">SAN-3</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">ğŸ’» GitHubå¼€æº</td><td style="padding:6px;text-align:center;color:var(--success-color);">+50%</td><td style="padding:6px;text-align:center;">SAN-6</td></tr>
					<tr><td style="padding:6px;">ğŸ“± å°çº¢ä¹¦å®£ä¼ </td><td style="padding:6px;text-align:center;color:var(--success-color);">+25%</td><td style="padding:6px;text-align:center;">SAN-3</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">ğŸ“° é‡å­ä½å°é¢ï¼ˆä»…Aç±»ï¼‰</td><td style="padding:6px;text-align:center;color:var(--success-color);">+100å¼•ç”¨</td><td style="padding:6px;text-align:center;">é‡‘é’±-10</td></tr>
				</table>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--accent-color);margin:0 0 8px 0;">ğŸ† å½•å–ç±»å‹åŠ æˆ</h4>
				<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;font-size:0.8rem;">
					<div style="padding:8px;background:var(--card-bg);border-radius:6px;text-align:center;">
						<div style="font-size:1.2rem;">ğŸ“„</div>
						<strong>Poster</strong><br>
						<span style="color:var(--text-secondary);">åŸºç¡€å€ç‡</span>
					</div>
					<div style="padding:8px;background:rgba(253,203,110,0.2);border-radius:6px;text-align:center;">
						<div style="font-size:1.2rem;">ğŸ¤</div>
						<strong>Oral</strong><br>
						<span style="color:var(--warning-color);">+50%</span>
					</div>
					<div style="padding:8px;background:rgba(253,121,168,0.2);border-radius:6px;text-align:center;">
						<div style="font-size:1.2rem;">ğŸ†</div>
						<strong>Best Paper</strong><br>
						<span style="color:var(--accent-color);">+400%</span>
					</div>
				</div>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--info-color);margin:0 0 8px 0;">ğŸ“‰ åˆ†æ•°è¡°å‡å¯¹å¼•ç”¨çš„å½±å“</h4>
				<div style="font-size:0.8rem;color:var(--text-secondary);">
					<p>å…¬å¼ä¸­ <code>baseScore = max(0, è®ºæ–‡åˆ†æ•° - 2 Ã— å‘è¡¨æœˆæ•°)</code> è¡¨ç¤ºï¼š</p>
					<ul style="margin:5px 0;padding-left:20px;">
						<li>è®ºæ–‡å‘è¡¨åï¼ŒåŸºç¡€åˆ†æ¯æœˆå‡å°‘2ç‚¹</li>
						<li>å½“åŸºç¡€åˆ†é™åˆ°0æ—¶ï¼Œå¼•ç”¨å¢é•¿åœæ­¢</li>
						<li>é«˜åˆ†è®ºæ–‡çš„å¼•ç”¨å¢é•¿æŒç»­æ—¶é—´æ›´é•¿</li>
					</ul>
					<div style="margin-top:8px;padding:8px;background:var(--card-bg);border-radius:6px;">
						<strong>ä¾‹ï¼šè®ºæ–‡åˆ†æ•°60</strong><br>
						å¯æŒç»­å¢é•¿æœˆæ•° = 60 Ã· 2 = 30ä¸ªæœˆ<br>
						å‰10ä¸ªæœˆåŸºç¡€å¢é€Ÿ = (60-20) Ã— 0.1 = 4å¼•ç”¨/æœˆ
					</div>
				</div>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--success-color);margin:0 0 8px 0;">ğŸ”¢ å¼•ç”¨å¢é•¿ç¤ºä¾‹</h4>
				<div style="background:var(--card-bg);border-radius:8px;padding:10px;font-size:0.8rem;">
					<strong>å‡è®¾ï¼šAç±»Oralè®ºæ–‡ï¼Œåˆ†æ•°80ï¼Œä¼šè®®å½±å“å› å­1.2</strong><br>
					æ¨å¹¿ï¼šarxiv + GitHubå¼€æº<br><br>
					
					ç¬¬1ä¸ªæœˆè®¡ç®—ï¼š<br>
					â€¢ baseScore = 80 - 2Ã—1 = 78<br>
					â€¢ baseGrowth = 78 Ã— 0.1 = 7.8<br>
					â€¢ promotionMultiplier = 1 + 0.5(Oral) + 0.25(arxiv) + 0.5(GitHub) = 2.25<br>
					â€¢ finalGrowth = 7.8 Ã— 1.2 Ã— 2.25 = <strong style="color:var(--success-color);">21.06</strong> å¼•ç”¨
				</div>
			</div>
			
			<div style="background:linear-gradient(135deg,rgba(0,184,148,0.1),rgba(85,239,196,0.1));border-radius:10px;padding:12px;">
				<h4 style="color:var(--success-color);margin:0 0 8px 0;">ğŸ’¡ æœ€å¤§åŒ–å¼•ç”¨çš„ç­–ç•¥</h4>
				<ul style="font-size:0.8rem;margin:0;padding-left:20px;">
					<li><strong>è¿½æ±‚é«˜åˆ†æŠ•ç¨¿</strong>ï¼šè®ºæ–‡åˆ†æ•°ç›´æ¥å†³å®šå¼•ç”¨å¢é•¿é€Ÿåº¦å’ŒæŒç»­æ—¶é—´</li>
					<li><strong>äº‰å–Oral/Best Paper</strong>ï¼šæä¾›50%~400%çš„æ°¸ä¹…åŠ æˆ</li>
					<li><strong>åŠæ—¶æ¨å¹¿</strong>ï¼šarxiv+GitHub+å°çº¢ä¹¦ç»„åˆå¯è¾¾+100%åŠ æˆ</li>
					<li><strong>åŒé—¨åˆä½œbuff</strong>ï¼šéšæœºäº‹ä»¶ä¸­çº¦å®šäº’æŒ‚å¯è·å¾—+100%åŠ æˆ</li>
					<li><strong>Aç±»è®ºæ–‡å¯ç”¨é‡å­ä½</strong>ï¼šç›´æ¥+100å¼•ç”¨</li>
				</ul>
			</div>
		</div>`;
					break;
					
				case 'events':
					title = 'ğŸ² äº‹ä»¶ç³»ç»Ÿ';
					content = `
		<div style="max-height:60vh;overflow-y:auto;font-size:0.85rem;line-height:1.6;">
			<div style="background:linear-gradient(135deg,rgba(108,92,231,0.1),rgba(162,155,254,0.1));border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--primary-color);margin:0 0 8px 0;">ğŸ“… å›ºå®šäº‹ä»¶æ—¶é—´è¡¨</h4>
				<table style="width:100%;font-size:0.8rem;border-collapse:collapse;">
					<tr style="background:var(--card-bg);">
						<th style="padding:6px;">æ¸¸æˆæœˆä»½</th>
						<th style="padding:6px;">ç°å®å¯¹åº”</th>
						<th style="padding:6px;">äº‹ä»¶</th>
					</tr>
					<tr><td style="padding:6px;text-align:center;">1æœˆï¼ˆç¬¬2å¹´èµ·ï¼‰</td><td style="padding:6px;text-align:center;">9æœˆ</td><td style="padding:6px;">ğŸ“ å¥–å­¦é‡‘è¯„å®š</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;text-align:center;">2æœˆ</td><td style="padding:6px;text-align:center;">10æœˆ</td><td style="padding:6px;">ğŸ æ•™å¸ˆèŠ‚</td></tr>
					<tr><td style="padding:6px;text-align:center;">5æœˆ</td><td style="padding:6px;text-align:center;">1æœˆ</td><td style="padding:6px;">â„ï¸ å¯’å‡ï¼ˆå‹å²é’±+1ï¼ŒSAN+2ï¼‰</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;text-align:center;">11æœˆ</td><td style="padding:6px;text-align:center;">7æœˆ</td><td style="padding:6px;">â˜€ï¸ æš‘å‡ï¼ˆSAN+3ï¼‰</td></tr>
					<tr><td style="padding:6px;text-align:center;">12æœˆ</td><td style="padding:6px;text-align:center;">8æœˆ</td><td style="padding:6px;">ğŸ“ å­¦å¹´æ€»ç»“ï¼ˆå››é€‰ä¸€å¥–åŠ±ï¼‰</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;text-align:center;">å¶æ•°æœˆ</td><td style="padding:6px;text-align:center;">-</td><td style="padding:6px;">ğŸ² éšæœºäº‹ä»¶</td></tr>
				</table>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--warning-color);margin:0 0 8px 0;">ğŸ“ å¥–å­¦é‡‘è¦æ±‚</h4>
				<table style="width:100%;font-size:0.8rem;border-collapse:collapse;">
					<tr style="background:var(--card-bg);">
						<th style="padding:6px;">å¹´ä»½</th>
						<th style="padding:6px;">ç§‘ç ”åˆ†è¦æ±‚</th>
						<th style="padding:6px;">å¥–é‡‘</th>
					</tr>
					<tr><td style="padding:6px;text-align:center;">ç¬¬2å¹´</td><td style="padding:6px;text-align:center;">â‰¥1</td><td style="padding:6px;text-align:center;">5é‡‘å¸</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;text-align:center;">ç¬¬3å¹´</td><td style="padding:6px;text-align:center;">â‰¥3</td><td style="padding:6px;text-align:center;">5é‡‘å¸</td></tr>
					<tr><td style="padding:6px;text-align:center;">ç¬¬4å¹´</td><td style="padding:6px;text-align:center;">â‰¥6</td><td style="padding:6px;text-align:center;">8é‡‘å¸</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;text-align:center;">ç¬¬5å¹´</td><td style="padding:6px;text-align:center;">â‰¥9</td><td style="padding:6px;text-align:center;">8é‡‘å¸</td></tr>
				</table>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--success-color);margin:0 0 8px 0;">ğŸ² éšæœºäº‹ä»¶æ± ï¼ˆ15ç§ï¼‰</h4>
				<div style="font-size:0.8rem;display:grid;grid-template-columns:1fr 1fr;gap:6px;">
					<div style="padding:6px;background:var(--card-bg);border-radius:4px;">1. æŒ‡å¯¼æœ¬ç§‘ç”Ÿæ¯•è®¾</div>
					<div style="padding:6px;background:var(--card-bg);border-radius:4px;">2. å¸®å¯¼å¸ˆå®¡ç¨¿</div>
					<div style="padding:6px;background:var(--card-bg);border-radius:4px;">3. çªç„¶æ„Ÿå†’</div>
					<div style="padding:6px;background:var(--card-bg);border-radius:4px;">4. å¯¼å¸ˆå®‰æ’åšé¡¹ç›®</div>
					<div style="padding:6px;background:var(--card-bg);border-radius:4px;">5. å¯¼å¸ˆæ‰¾ä½ è°ˆè¯</div>
					<div style="padding:6px;background:var(--card-bg);border-radius:4px;">6. å®éªŒå®¤ç»„ä¼š</div>
					<div style="padding:6px;background:var(--card-bg);border-radius:4px;">7. å®éªŒå®¤å›¢å»º</div>
					<div style="padding:6px;background:var(--card-bg);border-radius:4px;">8. å¯¼å¸ˆç»è´¹å……è¶³</div>
					<div style="padding:6px;background:var(--card-bg);border-radius:4px;">9. å­¦ä¹ æ–°çŸ¥è¯†</div>
					<div style="padding:6px;background:var(--card-bg);border-radius:4px;">10. åŒé—¨æ‰¾ä½ åˆä½œ</div>
					<div style="padding:6px;background:var(--card-bg);border-radius:4px;">11. å¸ˆå…„å¸ˆå§åˆä½œï¼ˆç¤¾äº¤â‰¥6ï¼‰</div>
					<div style="padding:6px;background:var(--card-bg);border-radius:4px;">12. å¯¼å¸ˆæŠ¢ä¸€ä½œ</div>
					<div style="padding:6px;background:var(--card-bg);border-radius:4px;">13. æœåŠ¡å™¨åäº†</div>
					<div style="padding:6px;background:var(--card-bg);border-radius:4px;">14. æŒ‡å¯¼å¸ˆå¼Ÿå¸ˆå¦¹ï¼ˆæœ‰è®ºæ–‡åï¼‰</div>
					<div style="padding:6px;background:var(--card-bg);border-radius:4px;">15. ç©æ¸¸æˆæ”¾æ¾</div>
				</div>
				<div style="margin-top:8px;font-size:0.75rem;color:var(--text-secondary);">
					äº‹ä»¶ç”¨å®Œåä¼šé‡ç½®ï¼Œæ¯ä¸ªäº‹ä»¶æ¯è½®åªè§¦å‘ä¸€æ¬¡
				</div>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--accent-color);margin:0 0 8px 0;">ğŸ‰ å¼€ä¼šäº‹ä»¶</h4>
				<div style="font-size:0.8rem;">
					<p>è®ºæ–‡ä¸­ç¨¿åéœ€è¦å‚åŠ ä¼šè®®ï¼Œé€‰æ‹©å‚ä¼šæ–¹å¼ï¼š</p>
					<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin:8px 0;">
						<div style="padding:6px;background:var(--card-bg);border-radius:4px;text-align:center;">
							ğŸ’° è‡ªè´¹<br><span style="color:var(--danger-color);">é‡‘é’±-4</span>
						</div>
						<div style="padding:6px;background:var(--card-bg);border-radius:4px;text-align:center;">
							ğŸ‘¨â€ğŸ« å¯¼å¸ˆæŠ¥é”€<br><span style="color:var(--danger-color);">å¥½æ„Ÿ-1/-2</span>
						</div>
						<div style="padding:6px;background:var(--card-bg);border-radius:4px;text-align:center;">
							ğŸ‘¥ ä»£å‚åŠ <br><span style="color:var(--text-secondary);">ç¤¾äº¤â‰¥6å…è´¹</span>
						</div>
					</div>
					<p><strong>ä¼šè®®æ´»åŠ¨é€‰é¡¹</strong>ï¼ˆäº²è‡ªå‚åŠ æ—¶éšæœº3é€‰ï¼‰ï¼š</p>
					<ul style="margin:5px 0;padding-left:20px;font-size:0.75rem;">
						<li>ğŸ–ï¸ é¡ºä¾¿æ—…æ¸¸ï¼ˆSAN+6ï¼‰</li>
						<li>â˜• èŒ¶æ­‡+æ™šå®´ï¼ˆSAN+1ï¼Œç¤¾äº¤+1ï¼‰</li>
						<li>ğŸ”¬ åŒè¡Œäº¤æµï¼ˆä¸‹æ¬¡å®éªŒÃ—3æ¬¡ï¼‰</li>
						<li>ğŸ’¡ å¹¿æ³›äº¤æµï¼ˆä¸‹æ¬¡ideaÃ—3æ¬¡ï¼‰</li>
						<li>ğŸŒŸ æ‰¾å¤§ç‰›äº¤æµï¼ˆideaÃ—1.25ï¼‰â†’å¯å‘å±•ä¸ºè”åˆåŸ¹å…»</li>
						<li>ğŸ¢ æ‰¾ä¼ä¸šäº¤æµï¼ˆå®éªŒÃ—1.25ï¼‰â†’3æ¬¡åè§£é”AI Labå®ä¹ </li>
						<li>ğŸ’• å’Œå¼‚æ€§å­¦è€…äº¤æµï¼ˆç¤¾äº¤â‰¥6ï¼‰â†’å¯å‘å±•ä¸ºæ‹äºº</li>
					</ul>
				</div>
			</div>
			
			<div style="background:linear-gradient(135deg,rgba(0,184,148,0.1),rgba(85,239,196,0.1));border-radius:10px;padding:12px;">
				<h4 style="color:var(--success-color);margin:0 0 8px 0;">ğŸ’¡ äº‹ä»¶ç³»ç»Ÿè®¾è®¡æ€è·¯</h4>
				<ul style="font-size:0.8rem;margin:0;padding-left:20px;">
					<li><strong>å±æ€§é—¨æ§›æœºåˆ¶</strong>ï¼šç¤¾äº¤â‰¥6/12è§£é”æ›´å¤šé€‰é¡¹ï¼Œå¥½æ„Ÿâ‰¥6å‡å°‘æƒ©ç½š</li>
					<li><strong>é£é™©æ”¶ç›Šå¹³è¡¡</strong>ï¼šé«˜æ”¶ç›Šé€‰é¡¹é€šå¸¸æœ‰æ›´é«˜é£é™©æˆ–æ¶ˆè€—</li>
					<li><strong>ç´¯ç§¯æ•ˆåº”</strong>ï¼šå¤šæ¬¡ä¸å¤§ç‰›/ä¼ä¸š/å¼‚æ€§äº¤æµå¯è§£é”ç‰¹æ®Šå‘å±•è·¯çº¿</li>
					<li><strong>éšæœºæ€§æ§åˆ¶</strong>ï¼šäº‹ä»¶æ± æœºåˆ¶ç¡®ä¿ç©å®¶èƒ½ä½“éªŒåˆ°æ‰€æœ‰äº‹ä»¶</li>
				</ul>
			</div>
		</div>`;
					break;
					
				case 'buffs':
					title = 'âœ¨ Buffä¸Debuff';
					content = `
		<div style="max-height:60vh;overflow-y:auto;font-size:0.85rem;line-height:1.6;">
			<div style="background:linear-gradient(135deg,rgba(0,184,148,0.15),rgba(85,239,196,0.15));border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--success-color);margin:0 0 8px 0;">âœ¨ æ°¸ä¹…Buffï¼ˆè·å–åä¸€ç›´ç”Ÿæ•ˆï¼‰</h4>
				<table style="width:100%;font-size:0.8rem;border-collapse:collapse;">
					<tr style="background:var(--card-bg);">
						<th style="padding:6px;text-align:left;">æ¥æº</th>
						<th style="padding:6px;text-align:left;">æ•ˆæœ</th>
					</tr>
					<tr><td style="padding:6px;">ğŸª‘ äººä½“å·¥å­¦æ¤…ï¼ˆ10é‡‘ï¼‰</td><td style="padding:6px;">æ¯æœˆSAN+1</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">âŒ¨ï¸ æœºæ¢°é”®ç›˜ï¼ˆ8é‡‘ï¼‰</td><td style="padding:6px;">å†™è®ºæ–‡SANæ¶ˆè€—-1</td></tr>
					<tr><td style="padding:6px;">ğŸ–¥ï¸ 4Kæ˜¾ç¤ºå™¨ï¼ˆ8é‡‘ï¼‰</td><td style="padding:6px;">çœ‹è®ºæ–‡SANæ¶ˆè€—-1</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">ğŸ–¥ï¸ GPUæœåŠ¡å™¨ï¼ˆ12é‡‘ï¼‰</td><td style="padding:6px;">æ¯æ¬¡åšå®éªŒå¤šåš1æ¬¡</td></tr>
					<tr><td style="padding:6px;">ğŸŒŸ è”åˆåŸ¹å…»ï¼ˆå¤§ç‰›æ·±å…¥åˆä½œï¼‰</td><td style="padding:6px;">æ¯æ¬¡å†™è®ºæ–‡+8åˆ†</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">ğŸ¢ AI Labå®ä¹ ï¼ˆä¼ä¸šäº¤æµ3æ¬¡ï¼‰</td><td style="padding:6px;">åšå®éªŒÃ—1.25ï¼Œæ¯æœˆé‡‘+2ï¼ŒSAN-3</td></tr>
					<tr><td style="padding:6px;">ğŸ’• æ‹äºº-æ´»æ³¼å‹</td><td style="padding:6px;">æ¯æœˆSAN+3ï¼Œé‡‘-1</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">ğŸ’• æ‹äºº-èªæ…§å‹</td><td style="padding:6px;">æ¯æ¬¡æƒ³idea/å®éªŒ/å†™è®ºæ–‡+1æ¬¡ï¼Œé‡‘-1</td></tr>
					<tr><td style="padding:6px;">ğŸ“– æŒ‡ç‚¹è¿·æ´¥ï¼ˆå¤§ç‰›æ‹’ç¨¿ï¼‰</td><td style="padding:6px;">æ¯æ¬¡æƒ³idea+1åˆ†</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">ğŸ“š å­¦ä¹ æ–°çŸ¥è¯†</td><td style="padding:6px;">å¯¹åº”æ“ä½œ+1åˆ†</td></tr>
				</table>
			</div>
			
			<div style="background:linear-gradient(135deg,rgba(116,185,255,0.15),rgba(162,155,254,0.15));border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--info-color);margin:0 0 8px 0;">â±ï¸ ä¸´æ—¶Buffï¼ˆä½¿ç”¨åæ¶ˆå¤±ï¼‰</h4>
				<table style="width:100%;font-size:0.8rem;border-collapse:collapse;">
					<tr style="background:var(--card-bg);">
						<th style="padding:6px;text-align:left;">æ¥æº</th>
						<th style="padding:6px;text-align:left;">æ•ˆæœ</th>
					</tr>
					<tr><td style="padding:6px;">ğŸ“– çœ‹è®ºæ–‡</td><td style="padding:6px;">ä¸‹æ¬¡æƒ³idea+1åˆ†</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">ğŸŒŸ å¤§ç‰›äº¤æµ</td><td style="padding:6px;">ä¸‹æ¬¡æƒ³ideaÃ—1.25</td></tr>
					<tr><td style="padding:6px;">ğŸ¢ ä¼ä¸šäº¤æµ</td><td style="padding:6px;">ä¸‹æ¬¡åšå®éªŒÃ—1.25</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">ğŸ¤ åŒå­¦åˆä½œ</td><td style="padding:6px;">ä¸‹æ¬¡åšå®éªŒ+5åˆ†</td></tr>
					<tr><td style="padding:6px;">ğŸ‘¨â€ğŸ“ å¸ˆå…„æŒ‡å¯¼</td><td style="padding:6px;">ä¸‹æ¬¡æƒ³idea+10åˆ†</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">ğŸ’¡ å¼€ä¼šå¹¿æ³›äº¤æµ</td><td style="padding:6px;">ä¸‹æ¬¡æƒ³ideaå¤šæƒ³3æ¬¡</td></tr>
					<tr><td style="padding:6px;">ğŸ”¬ å¼€ä¼šåŒè¡Œäº¤æµ</td><td style="padding:6px;">ä¸‹æ¬¡åšå®éªŒå¤šåš3æ¬¡</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">ğŸ¤ åŒé—¨äº’æŒ‚</td><td style="padding:6px;">ä¸‹ç¯‡ä¸­ç¨¿å¼•ç”¨é€Ÿåº¦+100%</td></tr>
				</table>
			</div>
			
			<div style="background:linear-gradient(135deg,rgba(253,203,110,0.15),rgba(243,156,18,0.15));border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--warning-color);margin:0 0 8px 0;">ğŸ¤– æœ¬æœˆè®¢é˜…Buffï¼ˆæœˆæœ«æ¶ˆå¤±ï¼‰</h4>
				<table style="width:100%;font-size:0.8rem;border-collapse:collapse;">
					<tr style="background:var(--card-bg);">
						<th style="padding:6px;">å•†å“</th>
						<th style="padding:6px;">ä»·æ ¼</th>
						<th style="padding:6px;">æ•ˆæœ</th>
					</tr>
					<tr><td style="padding:6px;">Geminiè®¢é˜…</td><td style="padding:6px;text-align:center;">2é‡‘</td><td style="padding:6px;">æœ¬æœˆæƒ³idea SAN-1ï¼Œ+4åˆ†</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">GPTè®¢é˜…</td><td style="padding:6px;text-align:center;">4é‡‘</td><td style="padding:6px;">æœ¬æœˆåšå®éªŒ SAN-1ï¼Œ+4åˆ†</td></tr>
					<tr><td style="padding:6px;">Claudeè®¢é˜…</td><td style="padding:6px;text-align:center;">3é‡‘</td><td style="padding:6px;">æœ¬æœˆå†™è®ºæ–‡ SAN-1ï¼Œ+4åˆ†</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">ç§ŸGPUæœåŠ¡å™¨</td><td style="padding:6px;text-align:center;">2é‡‘</td><td style="padding:6px;">æœ¬æœˆåšå®éªŒå¤šåš1æ¬¡</td></tr>
				</table>
			</div>
			
			<div style="background:linear-gradient(135deg,rgba(231,76,60,0.15),rgba(192,57,43,0.15));border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--danger-color);margin:0 0 8px 0;">ğŸ˜° Debuffï¼ˆè´Ÿé¢æ•ˆæœï¼‰</h4>
				<table style="width:100%;font-size:0.8rem;border-collapse:collapse;">
					<tr style="background:var(--card-bg);">
						<th style="padding:6px;text-align:left;">åç§°</th>
						<th style="padding:6px;text-align:left;">è§¦å‘æ¡ä»¶</th>
						<th style="padding:6px;text-align:left;">æ•ˆæœ</th>
					</tr>
					<tr><td style="padding:6px;">ğŸ’« çµæ„Ÿæ¯ç«­</td><td style="padding:6px;">è¿ç»­æƒ³idea 5æ¬¡</td><td style="padding:6px;">ä¸‹æ¬¡æƒ³ideaæ€»åˆ†Ã·2</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">ğŸ”¥ ä¸»æœºå‘çƒ«</td><td style="padding:6px;">è¿ç»­åšå®éªŒ 5æ¬¡</td><td style="padding:6px;">ä¸‹æ¬¡åšå®éªŒæ€»åˆ†Ã·2</td></tr>
					<tr><td style="padding:6px;">âœï¸ æ— ä»ä¸‹ç¬”</td><td style="padding:6px;">è¿ç»­å†™è®ºæ–‡ 5æ¬¡</td><td style="padding:6px;">ä¸‹æ¬¡å†™è®ºæ–‡æ€»åˆ†Ã·2</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">ğŸ˜´ æ¾æ‡ˆ</td><td style="padding:6px;">è¿ç»­ä¸­ç¨¿ 3ç¯‡</td><td style="padding:6px;">ä¸‹æœˆæ‰€æœ‰æ“ä½œæ€»åˆ†Ã·2</td></tr>
					<tr><td style="padding:6px;">ğŸ˜ˆ è¢«å·idea</td><td style="padding:6px;">åŒé—¨å­¦æœ¯äº¤æµ50%</td><td style="padding:6px;">ä¸‹æ¬¡æƒ³ideaæ€»åˆ†Ã·2</td></tr>
				</table>
				<div style="margin-top:8px;font-size:0.75rem;color:var(--text-secondary);">
					ğŸ’¡ debuffåœ¨è§¦å‘å¯¹åº”æ“ä½œåè‡ªåŠ¨æ¶ˆé™¤ï¼›æ¾æ‡ˆdebuffä¼‘æ¯ä¸€ä¸ªæœˆå¯æ¶ˆé™¤
				</div>
			</div>
			
			<div style="background:linear-gradient(135deg,rgba(0,184,148,0.1),rgba(85,239,196,0.1));border-radius:10px;padding:12px;">
				<h4 style="color:var(--success-color);margin:0 0 8px 0;">ğŸ’¡ Buffç³»ç»Ÿè®¾è®¡æ€è·¯</h4>
				<ul style="font-size:0.8rem;margin:0;padding-left:20px;">
					<li><strong>å åŠ æœºåˆ¶</strong>ï¼šåŒç±»å‹buffä¼šå åŠ ï¼Œä¹˜æ³•buffå åŠ ä¸ºåŠ æ³•ï¼ˆä¸¤ä¸ªÃ—1.25 = Ã—1.5ï¼‰</li>
					<li><strong>æˆå°±è¿½è¸ª</strong>ï¼šè§¦å‘æ‰€æœ‰ç±»å‹buffå¯è·å¾—"Buffä¹‹ç¥"æˆå°±</li>
					<li><strong>ç­–ç•¥æ€§æ¶ˆè€—</strong>ï¼šä¸´æ—¶bufféœ€è¦è§„åˆ’ä½•æ—¶ä½¿ç”¨ï¼Œé…åˆè®¢é˜…buffæ•ˆæœæ›´ä½³</li>
					<li><strong>å¹³è¡¡è®¾è®¡</strong>ï¼šå¼ºåŠ›buffé€šå¸¸æœ‰æ¶ˆè€—ä»£ä»·æˆ–è·å–æ¡ä»¶</li>
				</ul>
			</div>
		</div>`;
					break;
					
				case 'characters':
					title = 'ğŸ‘¥ è§’è‰²ä¸è§‰é†’ç³»ç»Ÿ';
					content = `
		<div style="max-height:60vh;overflow-y:auto;font-size:0.85rem;line-height:1.6;">
			<div style="background:linear-gradient(135deg,rgba(108,92,231,0.1),rgba(162,155,254,0.1));border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--primary-color);margin:0 0 8px 0;">â˜€ï¸ æ­£ä½è§’è‰²ä¸€è§ˆ</h4>
				<div style="font-size:0.8rem;">
					${characters.map(c => `
					<div style="padding:8px;background:var(--card-bg);border-radius:6px;margin-bottom:6px;border-left:3px solid var(--primary-color);">
						<div style="display:flex;justify-content:space-between;align-items:center;">
							<strong>${c.icon} ${c.name}</strong>
							<span style="font-size:0.75rem;color:var(--text-secondary);">${c.bonus}</span>
						</div>
						<div style="font-size:0.75rem;color:var(--success-color);margin-top:4px;">
							âš¡ è½¬åšè§‰é†’ã€${c.awakenName}ã€‘ï¼š${c.awakenDesc}
						</div>
						${c.hiddenAwakenName ? `
						<div style="font-size:0.75rem;color:#f39c12;margin-top:2px;">
							âš™ï¸ éšè—è§‰é†’ã€${c.hiddenAwakenName}ã€‘ï¼š${c.hiddenAwakenDesc}
						</div>` : ''}
					</div>`).join('')}
				</div>
			</div>
			
			<div style="background:linear-gradient(135deg,rgba(155,89,182,0.1),rgba(231,76,60,0.1));border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:#9b59b6;margin:0 0 8px 0;">ğŸŒ‘ é€†ä½è§’è‰²ä¸€è§ˆ</h4>
				<div style="font-size:0.8rem;">
					${characters.filter(c => c.reversed).map(c => `
					<div style="padding:8px;background:var(--card-bg);border-radius:6px;margin-bottom:6px;border-left:3px solid #9b59b6;">
						<div style="display:flex;justify-content:space-between;align-items:center;">
							<strong>${c.reversed.icon} ${c.reversed.name}</strong>
						</div>
						<div style="font-size:0.75rem;color:var(--text-secondary);margin-top:2px;">${c.reversed.bonus}</div>
						<div style="font-size:0.75rem;color:#e74c3c;margin-top:2px;">
							âš¡ é€†ä½è§‰é†’ã€${c.reversed.awakenName}ã€‘ï¼š${c.reversed.awakenDesc}
						</div>
					</div>`).join('')}
				</div>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--warning-color);margin:0 0 8px 0;">âš™ï¸ éšè—è§‰é†’è§¦å‘æ¡ä»¶</h4>
				<table style="width:100%;font-size:0.8rem;border-collapse:collapse;">
					<tr style="background:var(--card-bg);">
						<th style="padding:6px;text-align:left;">è§’è‰²</th>
						<th style="padding:6px;text-align:left;">éšè—è§‰é†’æ¡ä»¶</th>
					</tr>
					<tr><td style="padding:6px;">å¤§å¤šæ•°</td><td style="padding:6px;">è½¬åšæ—¶ç§‘ç ”ã€ç¤¾äº¤ã€å¥½æ„Ÿéƒ½â‰¤3</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">é™¢å£«è½¬ä¸–</td><td style="padding:6px;">è½¬åšæ—¶æ— Aç±»å’ŒBç±»è®ºæ–‡</td></tr>
					<tr><td style="padding:6px;">ç¤¾äº¤è¾¾äºº</td><td style="padding:6px;">è½¬åšæ—¶ç¤¾äº¤â‰¤6</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">å¯Œå¯æ•Œå›½</td><td style="padding:6px;">è½¬åšæ—¶é‡‘å¸â‰¤2</td></tr>
					<tr><td style="padding:6px;">å¯¼å¸ˆå­å¥³</td><td style="padding:6px;">è½¬åšæ—¶å¥½æ„Ÿåº¦â‰¤6</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">å¤©é€‰ä¹‹äºº</td><td style="padding:6px;">è½¬åšæ—¶ç§‘ç ”=ç¤¾äº¤=å¥½æ„Ÿï¼ˆä¸‰é¡¹ç›¸ç­‰ï¼‰</td></tr>
				</table>
				<div style="margin-top:8px;font-size:0.75rem;color:var(--text-secondary);">
					ğŸ’¡ æ»¡è¶³æ¡ä»¶æ—¶å¯åœ¨æ™®é€šè§‰é†’å’Œéšè—è§‰é†’ä¹‹é—´é€‰æ‹©
				</div>
			</div>
			
			<div style="background:linear-gradient(135deg,rgba(255,215,0,0.15),rgba(255,140,0,0.15));border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:#d68910;margin:0 0 8px 0;">ğŸŒŸ çœŸÂ·å¤§å¤šæ•°ï¼ˆéšè—è§’è‰²ï¼‰</h4>
				<div style="font-size:0.8rem;">
					<div style="padding:8px;background:var(--card-bg);border-radius:6px;">
						<strong>ğŸŒ è§£é”æ¡ä»¶</strong>ï¼š6ä¸ªè§’è‰²çš„æ­£ä½å’Œé€†ä½æ¨¡å¼éƒ½è¾¾åˆ°åšå£«æ¯•ä¸šï¼ˆå…±12ä¸ªï¼‰<br><br>
						<strong>è§’è‰²ç‰¹ç‚¹</strong>ï¼š<br>
						â€¢ æ— åˆå§‹å±æ€§åŠ æˆ<br>
						â€¢ æ— è½¬åšè§‰é†’æ•ˆæœ<br>
						â€¢ ä¸€åˆ‡é è‡ªå·±<br><br>
						<strong>ğŸ† ä¸“å±çœŸå®ç»“å±€</strong>ï¼š<br>
						â€¢ çœŸÂ·åšå£«æ¯•ä¸šï¼šåšå£«æ¯•ä¸šä¸”å‘è¡¨â‰¥3ç¯‡è®ºæ–‡<br>
						â€¢ çœŸÂ·çŒ®èº«ç§‘ç ”ï¼šåšå£«æ¯•ä¸šä¸”æ€»å¼•ç”¨>2000
					</div>
				</div>
			</div>
			
			<div style="background:linear-gradient(135deg,rgba(0,184,148,0.1),rgba(85,239,196,0.1));border-radius:10px;padding:12px;">
				<h4 style="color:var(--success-color);margin:0 0 8px 0;">ğŸ’¡ è§’è‰²é€‰æ‹©å»ºè®®</h4>
				<ul style="font-size:0.8rem;margin:0;padding-left:20px;">
					<li><strong>æ–°æ‰‹æ¨è</strong>ï¼šå¤©é€‰ä¹‹äººï¼ˆå…¨é¢å‘å±•ï¼‰ã€é™¢å£«è½¬ä¸–ï¼ˆç§‘ç ”å¼ºåŠ¿ï¼‰</li>
					<li><strong>æƒ³å¿«é€Ÿæ¯•ä¸š</strong>ï¼šé™¢å£«è½¬ä¸–ï¼ˆç§‘ç ”èƒ½åŠ›é«˜ï¼Œè®ºæ–‡åˆ†æ•°é«˜ï¼‰</li>
					<li><strong>æƒ³ä½“éªŒäº‹ä»¶</strong>ï¼šç¤¾äº¤è¾¾äººï¼ˆè§£é”æ›´å¤šé€‰é¡¹ï¼‰ã€å¯¼å¸ˆå­å¥³ï¼ˆå¯¼å¸ˆå…³ç³»å¥½ï¼‰</li>
					<li><strong>æƒ³æŒ‘æˆ˜é«˜éš¾åº¦</strong>ï¼šé€†ä½æ¨¡å¼ã€çœŸÂ·å¤§å¤šæ•°</li>
					<li><strong>éšè—è§‰é†’æµæ´¾</strong>ï¼šæ•…æ„å‹ä½å±æ€§è§¦å‘éšè—è§‰é†’ï¼Œè·å¾—ç‹¬ç‰¹èƒ½åŠ›</li>
				</ul>
			</div>
		</div>`;
					break;
					
				case 'strategy':
					title = 'ğŸ¯ è¿›é˜¶ç­–ç•¥æ”»ç•¥';
					content = `
		<div style="max-height:60vh;overflow-y:auto;font-size:0.85rem;line-height:1.6;">
			<div style="background:linear-gradient(135deg,rgba(108,92,231,0.1),rgba(162,155,254,0.1));border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--primary-color);margin:0 0 8px 0;">ğŸ“ˆ å¼€å±€ç­–ç•¥ï¼ˆç¬¬1å¹´ï¼‰</h4>
				<div style="font-size:0.8rem;">
					<div style="padding:8px;background:var(--card-bg);border-radius:6px;margin-bottom:6px;">
						<strong>ğŸ¯ æ ¸å¿ƒç›®æ ‡</strong>ï¼šç§‘ç ”åˆ†â‰¥1ï¼ˆæ‹¿åˆ°ç¬¬2å¹´å¥–å­¦é‡‘ï¼‰ï¼Œå±æ€§æå‡åˆ°6
					</div>
					<div style="padding:8px;background:var(--card-bg);border-radius:6px;margin-bottom:6px;">
						<strong>ğŸ“Š æ¨èèŠ‚å¥</strong>ï¼š<br>
						â€¢ å‰3ä¸ªæœˆï¼šçœ‹è®ºæ–‡æ”’buffï¼Œç§‘ç ”èƒ½åŠ›ä½æ—¶æƒ³ideaæ•ˆç‡ä½<br>
						â€¢ ç¬¬4-6æœˆï¼šå¼€å§‹å†™ç¬¬ä¸€ç¯‡è®ºæ–‡ï¼Œç›®æ ‡Cç±»<br>
						â€¢ ç¬¬7-9æœˆï¼šæŠ•ç¨¿+å‡†å¤‡ç¬¬äºŒç¯‡<br>
						â€¢ ç¬¬10-12æœˆï¼šäº‰å–ä¸­ç¨¿ï¼Œå‡†å¤‡è½¬åšåˆ¤å®š
					</div>
					<div style="padding:8px;background:var(--card-bg);border-radius:6px;">
						<strong>âš ï¸ æ³¨æ„äº‹é¡¹</strong>ï¼š<br>
						â€¢ ä¼˜å…ˆæŠŠç§‘ç ”æåˆ°6ï¼ˆè§£é”ç¬¬2è®ºæ–‡æ§½ï¼‰<br>
						â€¢ ç¤¾äº¤æåˆ°6ï¼ˆè§£é”æ›´å¤šäº‹ä»¶é€‰é¡¹ï¼‰<br>
						â€¢ ä¿æŒSANå€¼â‰¥5ï¼Œé¿å…å´©æºƒ<br>
						â€¢ é‡‘é’±ç•™3-5å¤‡ç”¨ï¼Œåº”å¯¹çªå‘äº‹ä»¶
					</div>
				</div>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--success-color);margin:0 0 8px 0;">ğŸ“ è®ºæ–‡å†™ä½œæœ€ä¼˜ç­–ç•¥</h4>
				<div style="font-size:0.8rem;">
					<div style="padding:8px;background:var(--card-bg);border-radius:6px;margin-bottom:6px;">
						<strong>ğŸ”„ å•ç¯‡è®ºæ–‡æµç¨‹</strong>ï¼š<br>
						1. å…ˆæ”’buffï¼ˆçœ‹è®ºæ–‡ã€è®¢é˜…AIå·¥å…·ï¼‰<br>
						2. ä¸€å£æ°”æƒ³3-4æ¬¡ideaï¼ˆé…åˆbuffï¼‰<br>
						3. ä¸€å£æ°”åš3-4æ¬¡å®éªŒï¼ˆç§Ÿ/ä¹°GPUï¼‰<br>
						4. å†™2-3æ¬¡è®ºæ–‡<br>
						5. ç«‹å³æŠ•ç¨¿ï¼ˆé¿å…è¡°å‡ï¼‰
					</div>
					<div style="padding:8px;background:var(--card-bg);border-radius:6px;margin-bottom:6px;">
						<strong>ğŸ“Š åˆ†æ•°åˆ†é…å»ºè®®</strong>ï¼š<br>
						â€¢ å°½é‡å‡è¡¡ï¼Œé¿å…çŸ­æ¿è¢«æ¶æ„å®¡ç¨¿äººæŠ“ä½<br>
						â€¢ ideaç¨é«˜ä¸€ç‚¹ï¼ˆå¤§ç‰›å®¡ç¨¿äººé‡è§†ideaï¼‰<br>
						â€¢ æŠ•ç¨¿å‰æ€»åˆ†ç›®æ ‡ï¼šAç±»â‰¥70ï¼ŒBç±»â‰¥45ï¼ŒCç±»â‰¥30
					</div>
					<div style="padding:8px;background:var(--card-bg);border-radius:6px;">
						<strong>â° æ—¶æœºé€‰æ‹©</strong>ï¼š<br>
						â€¢ æŸ¥çœ‹å…¨çƒç»Ÿè®¡ï¼Œé€‰æ‹©æŠ•ç¨¿é‡è¾ƒå°‘çš„"å†·é—¨"ä¼šè®®<br>
						â€¢ é¿å…debuffæœŸé—´æŠ•ç¨¿ï¼ˆå…ˆæ¶ˆåŒ–debuffï¼‰<br>
						â€¢ è½¬åšå‰ç¡®ä¿æœ‰è®ºæ–‡åœ¨å®¡ï¼Œä¸­ç¨¿å¯è·å¾—å¼€ä¼šbuff
					</div>
				</div>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--warning-color);margin:0 0 8px 0;">ğŸ”„ è½¬åšå†³ç­–åˆ†æ</h4>
				<div style="font-size:0.8rem;">
					<table style="width:100%;border-collapse:collapse;margin-bottom:8px;">
						<tr style="background:var(--card-bg);">
							<th style="padding:6px;">æ—¶æœº</th>
							<th style="padding:6px;">è¦æ±‚</th>
							<th style="padding:6px;">å»ºè®®</th>
						</tr>
						<tr><td style="padding:6px;">ç¬¬2å¹´12æœˆ</td><td style="padding:6px;">ç§‘ç ”åˆ†â‰¥2</td><td style="padding:6px;">å±æ€§å¥½å°±è½¬ï¼Œå¦åˆ™ç­‰</td></tr>
						<tr style="background:var(--card-bg);"><td style="padding:6px;">ç¬¬3å¹´12æœˆ</td><td style="padding:6px;">ç§‘ç ”åˆ†â‰¥3</td><td style="padding:6px;">æœ€åæœºä¼šï¼Œå»ºè®®è½¬</td></tr>
					</table>
					<div style="padding:8px;background:rgba(253,203,110,0.15);border-radius:6px;">
						<strong>ğŸ’¡ è½¬åšæ”¶ç›Šåˆ†æ</strong>ï¼š<br>
						â€¢ è§‰é†’æ•ˆæœéå¸¸å¼ºåŠ›ï¼ˆå±æ€§ç¿»å€/ç‰¹æ®Šèƒ½åŠ›ï¼‰<br>
						â€¢ åšå£«å·¥èµ„æ›´é«˜ï¼ˆæ¯æœˆ+3 vs +1ï¼‰<br>
						â€¢ æœ‰æ›´å¤šæ—¶é—´å†²å‡»é«˜æˆå°±<br>
						â€¢ è§£é”æ›´é«˜çº§ç»“å±€ï¼ˆé’æ¤’ã€å­¦æœ¯ä¹‹æ˜Ÿã€æœªæ¥é™¢å£«ï¼‰
					</div>
				</div>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--accent-color);margin:0 0 8px 0;">ğŸ† æˆå°±æ”»ç•¥ç²¾è¦</h4>
				<div style="font-size:0.8rem;">
					<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
						<div style="padding:6px;background:var(--card-bg);border-radius:4px;">
							<strong>ğŸ’• å–œç»“è‰¯ç¼˜</strong><br>
							<span style="font-size:0.75rem;">ç¤¾äº¤â‰¥12åå¤šæ¬¡ä¸åŒä¸€å¼‚æ€§äº¤æµ</span>
						</div>
						<div style="padding:6px;background:var(--card-bg);border-radius:4px;">
							<strong>ğŸ¯ ç™¾å‘ç™¾ä¸­</strong><br>
							<span style="font-size:0.75rem;">ä»ä¸è¢«æ‹’ç¨¿ï¼ˆå¯åªæŠ•Cç±»ä¿ç¨³ï¼‰</span>
						</div>
						<div style="padding:6px;background:var(--card-bg);border-radius:4px;">
							<strong>â˜• å’–å•¡çˆ±å¥½è€…</strong><br>
							<span style="font-size:0.75rem;">æ¯æœˆéƒ½ä¹°å†°ç¾å¼</span>
						</div>
						<div style="padding:6px;background:var(--card-bg);border-radius:4px;">
							<strong>ğŸ† å…¨æ”¶é›†</strong><br>
							<span style="font-size:0.75rem;">9ç§è®ºæ–‡ç±»å‹å„ä¸­ä¸€ç¯‡</span>
						</div>
						<div style="padding:6px;background:var(--card-bg);border-radius:4px;">
							<strong>ğŸ§’ å¤©æ‰å°‘å¹´</strong><br>
							<span style="font-size:0.75rem;">è½¬åšæ—¶ç§‘ç ”åˆ†å·²â‰¥7</span>
						</div>
						<div style="padding:6px;background:var(--card-bg);border-radius:4px;">
							<strong>ğŸ”¥ ç«åŠ›å…¨å¼€</strong><br>
							<span style="font-size:0.75rem;">4ç¯‡è®ºæ–‡åŒæ—¶åœ¨å®¡</span>
						</div>
					</div>
				</div>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--danger-color);margin:0 0 8px 0;">âš ï¸ å¸¸è§å¤±è´¥åŸå› </h4>
				<div style="font-size:0.8rem;">
					<div style="padding:8px;background:rgba(231,76,60,0.1);border-radius:6px;margin-bottom:6px;">
						<strong>1. SANå€¼å´©æºƒ</strong><br>
						åŸå› ï¼šè¿ç»­é«˜å¼ºåº¦æ“ä½œã€é€†ä½å¤§å¤šæ•°çš„SANå‡å°‘ç¿»å€<br>
						å¯¹ç­–ï¼šä¿æŒSANâ‰¥8ï¼Œè´­ä¹°äººä½“å·¥å­¦æ¤…ï¼Œé€‚æ—¶ä¼‘æ¯
					</div>
					<div style="padding:8px;background:rgba(231,76,60,0.1);border-radius:6px;margin-bottom:6px;">
						<strong>2. é‡‘é’±è€—å°½</strong><br>
						åŸå› ï¼šè¿‡åº¦æ¶ˆè´¹ã€æ‹äººå¼€é”€ã€äº‹ä»¶é€‰æ‹©ä¸å½“<br>
						å¯¹ç­–ï¼šä¿æŒé‡‘é’±â‰¥3ï¼Œæ‰“å·¥è¡¥å……ï¼Œåˆç†è§„åˆ’å¼€æ”¯
					</div>
					<div style="padding:8px;background:rgba(231,76,60,0.1);border-radius:6px;margin-bottom:6px;">
						<strong>3. å¯¼å¸ˆå…³ç³»ç ´è£‚</strong><br>
						åŸå› ï¼šå¤šæ¬¡æ‹’ç»å¯¼å¸ˆå®‰æ’ã€æ•™å¸ˆèŠ‚ä¸é€ç¤¼<br>
						å¯¹ç­–ï¼šå¥½æ„Ÿåº¦ä½æ—¶å¤šé…åˆå¯¼å¸ˆï¼Œé€ç¤¼æŒ½å›
					</div>
					<div style="padding:8px;background:rgba(231,76,60,0.1);border-radius:6px;">
						<strong>4. è®ºæ–‡è´¨é‡ä¸è¶³</strong><br>
						åŸå› ï¼šç§‘ç ”èƒ½åŠ›å¤ªä½ã€åˆ†æ•°è¡°å‡ã€çŸ­æ¿æ˜æ˜¾<br>
						å¯¹ç­–ï¼šå…ˆæå‡ç§‘ç ”èƒ½åŠ›ï¼Œæ”’buffåé›†ä¸­å†™ä½œ
					</div>
				</div>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:#9b59b6;margin:0 0 8px 0;">ğŸŒ‘ é€†ä½æ¨¡å¼æ”»ç•¥</h4>
				<div style="font-size:0.8rem;">
					<div style="padding:8px;background:var(--card-bg);border-radius:6px;margin-bottom:6px;">
						<strong>æ€ æƒ°ä¹‹å¤§å¤šæ•°</strong>ï¼šSANå‡å°‘ç¿»å€ï¼Œä½†æ¯æœˆå›å¤+3<br>
						ç­–ç•¥ï¼šå‡å°‘æ¶ˆè€—å¤§çš„æ“ä½œï¼Œåˆ©ç”¨é«˜å›å¤å¹³è¡¡
					</div>
					<div style="padding:8px;background:var(--card-bg);border-radius:6px;margin-bottom:6px;">
						<strong>æ„šé’ä¹‹é™¢å£«è½¬ä¸–</strong>ï¼šç§‘ç ”=0ï¼Œå…¨è®ºæ–‡æ§½<br>
						ç­–ç•¥ï¼šé è½¬åŒ–è·å¾—é‡‘é’±å’ŒSANï¼Œå¤šå†™ä½åˆ†è®ºæ–‡åˆ·é‡
					</div>
					<div style="padding:8px;background:var(--card-bg);border-radius:6px;margin-bottom:6px;">
						<strong>è´ªæ±‚ä¹‹å¯Œå¯æ•Œå›½</strong>ï¼šæ¯æœˆå±æ€§é‡ç½®ä¸º1<br>
						ç­–ç•¥ï¼šè§‰é†’åå˜ä¸ºåŠå¹´é‡ç½®+æ¶ˆè´¹æ¶¨å±æ€§ï¼Œç–¯ç‹‚èŠ±é’±
					</div>
					<div style="padding:8px;background:var(--card-bg);border-radius:6px;">
						<strong>ç©ºæƒ³ä¹‹å¤©é€‰ä¹‹äºº</strong>ï¼šæ¯æœˆå±æ€§éšæœºäº¤æ¢<br>
						ç­–ç•¥ï¼šæ¥å—éšæœºæ€§ï¼Œçªç ´ä¸Šé™çš„å±æ€§ä¼šä¿ç•™
					</div>
				</div>
			</div>
			
			<div style="background:linear-gradient(135deg,rgba(0,184,148,0.1),rgba(85,239,196,0.1));border-radius:10px;padding:12px;">
				<h4 style="color:var(--success-color);margin:0 0 8px 0;">ğŸ¯ æœ€é«˜ç»“å±€è·¯çº¿</h4>
				<div style="font-size:0.8rem;">
					<div style="padding:10px;background:var(--card-bg);border-radius:6px;">
						<strong>ğŸ‘‘ æœªæ¥é™¢å£«è·¯çº¿</strong>ï¼š<br>
						è¦æ±‚ï¼šAç±»â‰¥5ç¯‡ï¼Œå¼•ç”¨>2000ï¼Œè”åˆåŸ¹å…»<br><br>
						<strong>å…³é”®èŠ‚ç‚¹</strong>ï¼š<br>
						1. ç¬¬1å¹´ï¼šCç±»ä¿åº•æ‹¿å¥–å­¦é‡‘ï¼Œç¤¾äº¤æåˆ°6<br>
						2. ç¬¬2å¹´ï¼šå†²Aç±»ï¼Œå¤šå‚åŠ å¼€ä¼šè®¤è¯†å¤§ç‰›<br>
						3. è½¬åšï¼šè§¦å‘è§‰é†’ï¼Œè”åˆåŸ¹å…»å¤§ç‰›<br>
						4. åšå£«æœŸï¼šç¨³å®šäº§å‡ºAç±»ï¼Œåšå¥½æ¨å¹¿æ¶¨å¼•ç”¨<br>
						5. æ¯•ä¸šå‰ï¼šç¡®ä¿5ç¯‡Aç±»+2000å¼•ç”¨+è”åˆåŸ¹å…»<br><br>
						<strong>æ ¸å¿ƒç­–ç•¥</strong>ï¼š<br>
						â€¢ ç§‘ç ”èƒ½åŠ›å°½å¿«åˆ°18ï¼ˆå¼€å…¨æ§½ï¼‰<br>
						â€¢ å¼€ä¼šå¿…é¡»äº²è‡ªå»ï¼Œå‘å±•å¤§ç‰›å…³ç³»<br>
						â€¢ æ¯ç¯‡Aç±»éƒ½åšå®Œæ•´æ¨å¹¿ï¼ˆarxiv+GitHub+å°çº¢ä¹¦ï¼‰<br>
						â€¢ Best Paperè®ºæ–‡ä¼˜å…ˆå‘å±•ï¼ˆå¼•ç”¨Ã—5ï¼‰
					</div>
				</div>
			</div>
		</div>`;
					break;
					
				default:
					title = 'â“ æœªçŸ¥ç±»å‹';
					content = '<p>è¯·é€‰æ‹©æœ‰æ•ˆçš„è¯´æ˜ç±»å‹ã€‚</p>';
			}
			
			showModal(title, content, [{ text: 'å…³é—­', class: 'btn-primary', action: closeModal }]);
		}

        // ==================== å¯åŠ¨æ¸¸æˆ ====================
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
