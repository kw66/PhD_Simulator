<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>研究生模拟器</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-color: #6c5ce7;
            --secondary-color: #a29bfe;
            --accent-color: #fd79a8;
            --success-color: #00b894;
            --warning-color: #fdcb6e;
            --danger-color: #e17055;
            --info-color: #74b9ff;
            --love-color: #ff6b9d;
            --light-bg: #f8f9fa;
            --card-bg: #ffffff;
            --text-primary: #2d3436;
            --text-secondary: #636e72;
            --border-color: #dfe6e9;
            --shadow: 0 4px 15px rgba(0,0,0,0.1);
            --shadow-hover: 0 8px 25px rgba(0,0,0,0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: var(--text-primary);
        }

        /* 逆位暗色主题 */
		body.reversed-theme {
			--primary-color: #9b59b6;
			--secondary-color: #8e44ad;
			--accent-color: #c0392b;
			--success-color: #27ae60;
			--warning-color: #f39c12;
			--danger-color: #e74c3c;
			--light-bg: #2c2c2c;
			--card-bg: #1a1a2e;
			--text-primary: #e0e0e0;
			--text-secondary: #a0a0a0;
			--border-color: #444;
			--achievement-text: #ffffff;
			--achievement-bg: #5b2c6f;
			--achievement-border: #d7bde2;
			--achievement-shadow: 0 2px 10px rgba(155, 89, 182, 0.5);
		}

        body.reversed-theme #start-screen {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
        }

        body.reversed-theme .start-container {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 1px solid #9b59b6;
            box-shadow: 0 0 30px rgba(155, 89, 182, 0.3);
        }

        body.reversed-theme .game-title {
            background: linear-gradient(135deg, #9b59b6, #e74c3c);
            -webkit-background-clip: text;
            background-clip: text;
        }

        body.reversed-theme .character-card {
            background: #16213e;
            border-color: #444;
        }

        body.reversed-theme .character-card:hover {
            border-color: #9b59b6;
            box-shadow: 0 0 15px rgba(155, 89, 182, 0.4);
        }

        body.reversed-theme .character-card.selected {
            border-color: #e74c3c;
            background: linear-gradient(135deg, rgba(155,89,182,0.2), rgba(231,76,60,0.2));
            box-shadow: 0 0 20px rgba(231, 76, 60, 0.4);
        }

        body.reversed-theme .game-intro {
            background: #16213e;
            border: 1px solid #444;
        }

        body.reversed-theme .panel {
            background: #1a1a2e;
            border: 1px solid #333;
        }

        body.reversed-theme .log-content,
        body.reversed-theme .shop-item,
        body.reversed-theme .research-stat,
        body.reversed-theme .paper-slot,
        body.reversed-theme .score-box {
            background: #16213e;
        }

        body.reversed-theme .log-entry {
            background: #0f0f23;
            border-left-color: #9b59b6;
        }

        body.reversed-theme .modal {
            background: #1a1a2e;
            border: 1px solid #9b59b6;
        }

        body.reversed-theme #global-stats-panel {
            background: #16213e;
        }

        body.reversed-theme .mode-toggle-container {
            background: #333;
        }

        body.reversed-theme .mode-toggle-btn.active {
            background: var(--card-bg);
        }

        body.reversed-theme .mode-description {
            background: #16213e;
        }
        
        /* 角色显示 */
        .character-display {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: var(--light-bg);
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .character-display:hover {
            background: var(--border-color);
        }

        .character-display .char-icon {
            font-size: 1.4rem;
        }

        .character-display .char-name {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-primary);
        }

        .character-display .char-mode {
            margin-left: auto;
            font-size: 0.65rem;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .character-display .char-mode.normal-mode {
            background: rgba(108, 92, 231, 0.15);
            color: #6c5ce7;
        }

        .character-display .char-mode.reversed-mode {
            background: rgba(155, 89, 182, 0.2);
            color: #9b59b6;
        }

        body.reversed-theme .character-display {
            background: #2d2d44;
        }

        body.reversed-theme .character-display:hover {
            background: #3d3d54;
        }

        /* 逆位模式配色优化 */
        body.reversed-theme .graduation-info-compact .remaining-badge {
            background: linear-gradient(135deg, #7d6608, #9a7d0a);
            color: #ffeaa7;
        }

        body.reversed-theme .graduation-info-compact .date-badge {
            background: linear-gradient(135deg, #6c3483, #8e44ad);
            color: #e8daef;
        }

        body.reversed-theme .graduation-info-compact .target-badge {
            background: #2d2d44;
            color: #bb8fce;
            border: 1px solid #444;
        }

        body.reversed-theme .action-btn {
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        body.reversed-theme .action-btn:hover:not(:disabled) {
            border-color: rgba(255, 255, 255, 0.3);
        }

        body.reversed-theme .btn-primary {
            background: linear-gradient(135deg, #5b2c6f, #7d3c98);
            color: #e8daef;
        }

        body.reversed-theme .btn-success {
            background: linear-gradient(135deg, #145a32, #1e8449);
            color: #d5f5e3;
        }

        body.reversed-theme .btn-danger {
            background: linear-gradient(135deg, #8e44ad, #9b59b6);
            color: white;
            box-shadow: 0 2px 8px rgba(142, 68, 173, 0.4);
        }

        body.reversed-theme .btn-warning {
            background: linear-gradient(135deg, #9a7d0a, #b7950b);
            color: #1a1a2e;
            font-weight: 600;
        }

        body.reversed-theme .btn-info {
            background: linear-gradient(135deg, #1a5276, #2874a6);
            color: #d4e6f1;
        }

        body.reversed-theme .btn-accent {
            background: linear-gradient(135deg, #922b21, #b03a2e);
            color: #fadbd8;
        }

        body.reversed-theme .progress-fill.san {
            background: linear-gradient(90deg, #e74c3c, #f39c12);
        }

        body.reversed-theme .quick-btn.next-month-btn {
            background: linear-gradient(135deg, #8e44ad, #9b59b6);
        }

        body.reversed-theme .quick-btn.next-month-btn i {
            color: white;
        }

        body.reversed-theme .quick-btn {
            background: #2d2d44;
            color: #e0e0e0;
            border: 1px solid #444;
        }

        body.reversed-theme .quick-btn i {
            color: #bb8fce;
        }

        body.reversed-theme .gold-display {
            background: linear-gradient(135deg, #7d6608, #9a7d0a);
            color: #ffeaa7;
        }

        body.reversed-theme .gold-display .gold-info {
            color: #ffeaa7;
        }

        body.reversed-theme .gold-display .gold-info i {
            color: #f1c40f;
        }

        body.reversed-theme .reviewing-badge {
            background: #7d6608;
            color: #ffeaa7;
        }

        body.reversed-theme .reviewing-badge.grade-A {
            background: linear-gradient(135deg, #922b21, #c0392b);
            color: white;
        }

        body.reversed-theme .reviewing-badge.grade-B {
            background: linear-gradient(135deg, #7d6608, #9a7d0a);
            color: #ffeaa7;
        }

        body.reversed-theme .reviewing-badge.grade-C {
            background: linear-gradient(135deg, #1e8449, #27ae60);
            color: white;
        }

        body.reversed-theme .shop-item-price {
            color: #f1c40f;
        }

        body.reversed-theme .difficulty-badge {
            border: 1px solid rgba(255,255,255,0.2);
        }

        body.reversed-theme .difficulty-badge.legendary { 
            background: rgba(155,89,182,0.4); 
            color: #d7bde2; 
        }

        body.reversed-theme .difficulty-badge.nightmare { 
            background: rgba(231,76,60,0.4); 
            color: #f5b7b1; 
        }

        body.reversed-theme .difficulty-badge.expert { 
            background: rgba(230,126,34,0.4); 
            color: #fad7a0; 
        }

        body.reversed-theme .difficulty-badge.hard { 
            background: rgba(241,196,15,0.4); 
            color: #f9e79f; 
        }

        body.reversed-theme .difficulty-badge.normal { 
            background: rgba(52,152,219,0.4); 
            color: #aed6f1; 
        }

        body.reversed-theme .difficulty-badge.easy { 
            background: rgba(46,204,113,0.4); 
            color: #abebc6; 
        }

        body.reversed-theme .progress-bar {
            background: #333;
        }

        body.reversed-theme .attribute-label .value {
            color: #bb8fce;
        }

        body.reversed-theme .paper-promotions .btn[disabled] {
            background: #444 !important;
            color: #888 !important;
            border: none;
        }
		
		/* 基础成就样式 */
		.achievement-item {
			padding: 6px 12px;
			border-radius: 16px;
			font-size: 0.8rem;
			margin: 4px;
			display: inline-block;
			cursor: pointer;  /* ★ 新增：手型指针 */
			transition: all 0.3s ease;  /* ★ 新增：过渡动画 */
		}

		/* 正位模式样式 */
		body:not(.reversed-theme) .achievement-item {
			background: linear-gradient(135deg, #fdcb6e33, #ffeaa733);
			color: #2d3436;
			border: 1px solid #fdcb6e;
		}

		/* ★ 新增：正位模式悬停效果 */
		body:not(.reversed-theme) .achievement-item:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(253, 203, 110, 0.5);
		}

		/* 逆位模式样式 */
		body.reversed-theme .achievement-item {
			background: linear-gradient(135deg, #6c3483, #4a235a);
			color: #ffffff;
			border: 1px solid #d7bde2;
			box-shadow: 0 2px 10px rgba(155, 89, 182, 0.5);
			font-weight: 500;
			text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
		}

		/* 逆位模式悬停效果 */
		body.reversed-theme .achievement-item:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(155, 89, 182, 0.5);
		}

		/* 未解锁成就 */
		body.reversed-theme .locked-achievement {
			background: #1e1525;
			color: #a0a0a0;
			border: 1px dashed #6c3483;
			opacity: 0.7;
		}	
		
		body.reversed-theme .achievement-item {
			transition: all 0.3s ease;
		}

		body.reversed-theme .achievement-item:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(155, 89, 182, 0.5);
		}

		body.reversed-theme .locked-achievement:hover {
			color: #c0c0c0 !important;
			border-style: solid;
		}

		/* 全球统计面板中的成就/结局标签 */
		.stats-tag {
			padding: 4px 8px;
			background: white;
			border-radius: 6px;
			font-size: 0.65rem;
			border: 1px solid var(--border-color);
		}

		.stats-tag strong {
			color: var(--success-color);
		}

		.stats-tag.ending-tag strong {
			color: var(--primary-color);
		}

		body.reversed-theme .stats-tag {
			background: #2d2d44;
			color: #e0e0e0;
			border-color: #555;
		}

		body.reversed-theme .stats-tag strong {
			color: #58d68d;
		}

		body.reversed-theme .stats-tag.ending-tag strong {
			color: #bb8fce;
		}

		/* 未解锁成就样式 */
		.locked-achievement-tag {
			padding: 4px 8px;
			background: #e0e0e0;
			border-radius: 15px;
			font-size: 0.75rem;
			color: #999;
			cursor: pointer;
			transition: all 0.3s ease;
		}

		.locked-achievement-tag:hover {
			background: #d0d0d0;
			color: #666;
		}

		body.reversed-theme .locked-achievement-tag {
			background: #3d3d5c;
			color: #a0a0a0;
			border: 1px dashed #6c3483;
		}

		body.reversed-theme .locked-achievement-tag:hover {
			background: #4d4d6c;
			color: #c0c0c0;
			border-color: #8e44ad;
		}

		/* 弹窗内的统计标签 */
		.modal-stats-tag {
			padding: 4px 8px;
			background: var(--light-bg);
			border-radius: 6px;
			font-size: 0.7rem;
			cursor: pointer;
			transition: all 0.3s ease;
		}

		.modal-stats-tag:hover {
			transform: translateY(-1px);
		}

		.modal-stats-tag strong {
			color: var(--success-color);
		}

		body.reversed-theme .modal-stats-tag {
			background: #2d2d44;
			color: #e0e0e0;
			border: 1px solid #444;
		}

		body.reversed-theme .modal-stats-tag strong {
			color: #58d68d;
		}		
		
		body.reversed-theme .meta-records {
			background: #2d2d44 !important;
		}

		body.reversed-theme .meta-records div[style*="border-bottom"] {
			border-color: #444 !important;
		}

        /* 弹窗样式 */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active { opacity: 1; visibility: visible; }

        .modal {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 25px;
            max-width: 550px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: var(--shadow-hover);
            transform: scale(0.8);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal { transform: scale(1); }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 15px;
            text-align: center;
        }

        .modal-content { margin-bottom: 15px; line-height: 1.7; font-size: 0.95rem; }

        .modal-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* 按钮样式 */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-family: inherit;
        }

        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow); }
        .btn:active:not(:disabled) { transform: translateY(0); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }

        .btn-primary { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; }
        .btn-success { background: linear-gradient(135deg, var(--success-color), #55efc4); color: white; }
        .btn-danger { background: linear-gradient(135deg, var(--danger-color), #fab1a0); color: white; }
        .btn-warning { background: linear-gradient(135deg, var(--warning-color), #ffeaa7); color: var(--text-primary); }
        .btn-info { background: linear-gradient(135deg, var(--info-color), #a0d2ff); color: white; }
        .btn-accent { background: linear-gradient(135deg, var(--accent-color), #ffb8d0); color: white; }

        /* 开始界面 */
        #start-screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: background 0.5s ease;
        }

        .start-container {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px 30px;
            max-width: 850px;
            width: 100%;
            box-shadow: var(--shadow-hover);
            text-align: center;
            transition: all 0.5s ease;
        }

        .game-title {
            font-size: 2.2rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }

        .game-author {
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        /* 模式切换按钮 */
        .mode-toggle-container {
            display: flex;
            justify-content: center;
            gap: 0;
            margin: 15px auto;
            background: var(--border-color);
            border-radius: 25px;
            padding: 4px;
            max-width: 280px;
        }

        .mode-toggle-btn {
            flex: 1;
            padding: 10px 25px;
            border: none;
            border-radius: 20px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            background: transparent;
            color: var(--text-secondary);
        }

        .mode-toggle-btn:hover {
            color: var(--text-primary);
        }

        .mode-toggle-btn.active {
            background: var(--card-bg);
            color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .mode-toggle-btn.active.reversed-active {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            box-shadow: 0 2px 15px rgba(155, 89, 182, 0.4);
        }

        .mode-description {
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 15px;
            padding: 8px 20px;
            background: var(--light-bg);
            border-radius: 20px;
            transition: all 0.3s ease;
        }

        .game-intro {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 20px;
            padding: 12px 15px;
            background: var(--light-bg);
            border-radius: 12px;
            text-align: left;
        }

        .game-intro p { margin-bottom: 3px; }

        .character-selection h3 {
            font-size: 1.1rem;
            color: var(--primary-color);
            margin-bottom: 12px;
        }

        .character-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        @media (max-width: 700px) {
            .character-grid { grid-template-columns: repeat(2, 1fr); }
        }

        .character-card {
            background: var(--light-bg);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
			position: relative; /* 新增，用于覆盖层定位 */
        }

        .character-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
            border-color: var(--secondary-color);
        }

        .character-card.selected {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, rgba(108,92,231,0.1), rgba(162,155,254,0.1));
        }

        .character-card .icon { font-size: 1.8rem; margin-bottom: 5px; }
        .character-card .name { font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 3px; }
        .character-card .desc { font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 6px; line-height: 1.3; }
        .character-card .bonus {
            padding: 5px 8px;
            background: rgba(0,184,148,0.15);
            border-radius: 6px;
            font-size: 0.7rem;
            color: var(--success-color);
            font-weight: 500;
        }

        /* 难度星级样式 */
        .difficulty-container {
            margin-top: 8px;
            padding: 6px 8px;
            background: rgba(241, 196, 15, 0.1);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .difficulty-stars {
            display: flex;
            align-items: center;
            gap: 1px;
        }

        .difficulty-stars i {
            font-size: 0.7rem;
            color: #f1c40f;
        }

        .difficulty-stars i.far {
            opacity: 0.6;
        }

        .difficulty-label {
            font-size: 0.65rem;
            color: var(--text-secondary);
        }

        .difficulty-badge {
            font-size: 0.6rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 8px;
        }

        .difficulty-badge.legendary { background: rgba(155,89,182,0.2); color: #9b59b6; }
        .difficulty-badge.nightmare { background: rgba(231,76,60,0.2); color: #e74c3c; }
        .difficulty-badge.expert { background: rgba(230,126,34,0.2); color: #e67e22; }
        .difficulty-badge.hard { background: rgba(241,196,15,0.2); color: #f39c12; }
        .difficulty-badge.normal { background: rgba(52,152,219,0.2); color: #3498db; }
        .difficulty-badge.easy { background: rgba(46,204,113,0.2); color: #27ae60; }
        .difficulty-badge.unknown { background: rgba(149,165,166,0.2); color: #95a5a6; }

        .start-btn { font-size: 1.1rem; padding: 12px 40px; }

        /* 游戏主界面 */
        #game-screen { display: none; min-height: 100vh; padding: 10px; }

        .game-container {
            display: grid;
            grid-template-columns: 260px 1fr 280px;
            gap: 10px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .panel {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 12px;
            box-shadow: var(--shadow);
        }

        .panel-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border-color);
        }

        .left-column { display: flex; flex-direction: column; gap: 10px; }
        .middle-column { display: flex; flex-direction: column; gap: 10px; }
        .right-column { display: flex; flex-direction: column; gap: 10px; }

        /* 属性栏 */
        .attribute-bar { margin-bottom: 8px; }

        .attribute-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
            font-size: 0.8rem;
        }

        .attribute-label .name { 
            display: flex; 
            align-items: center; 
            gap: 4px; 
            cursor: help;
        }
        .attribute-label .value { font-weight: 600; color: var(--primary-color); }

        .progress-bar {
            height: 10px;
            background: var(--border-color);
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        .progress-fill.san { background: linear-gradient(90deg, #e17055, #fdcb6e); }
        .progress-fill.research { background: linear-gradient(90deg, #6c5ce7, #a29bfe); }
        .progress-fill.social { background: linear-gradient(90deg, #00b894, #55efc4); }
        .progress-fill.favor { background: linear-gradient(90deg, #fd79a8, #ffb8d0); }

        .gold-display {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
            border-radius: 8px;
            margin-top: 5px;
        }

        .gold-display .gold-info {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .gold-display .gold-info i { color: #d68910; font-size: 1rem; }

        /* Buff栏 */
        .buff-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            max-height: 80px;
            overflow-y: auto;
        }

        .buff-tag {
            padding: 3px 7px;
            border-radius: 12px;
            font-size: 0.65rem;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .buff-tag.permanent {
            background: linear-gradient(135deg, rgba(0,184,148,0.2), rgba(85,239,196,0.2));
            color: #00a878;
            border: 1px solid var(--success-color);
        }

        .buff-tag.temporary {
            background: linear-gradient(135deg, rgba(116,185,255,0.2), rgba(162,155,254,0.2));
            color: #4a90d9;
            border: 1px solid var(--info-color);
        }

        .buff-tag.debuff {
            background: linear-gradient(135deg, rgba(225,112,85,0.2), rgba(250,177,160,0.2));
            color: #d63031;
            border: 1px solid var(--danger-color);
        }

        .buff-tag.love {
            background: linear-gradient(135deg, rgba(255,107,157,0.2), rgba(255,182,193,0.3));
            color: var(--love-color);
            border: 1px solid var(--love-color);
        }

        /* 科研成果栏 */
        .research-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-bottom: 8px;
        }

        .research-stat {
            padding: 5px;
            background: var(--light-bg);
            border-radius: 6px;
            text-align: center;
        }

        .research-stat .label { font-size: 0.65rem; color: var(--text-secondary); }
        .research-stat .value { font-size: 0.95rem; font-weight: 700; color: var(--primary-color); }

        .paper-list { max-height: 150px; overflow-y: auto; }

        .paper-item {
            padding: 8px;
            background: var(--light-bg);
            border-radius: 6px;
            margin-bottom: 6px;
            border-left: 3px solid var(--primary-color);
        }

        .paper-item.grade-A { border-left-color: #e17055; }
        .paper-item.grade-B { border-left-color: #fdcb6e; }
        .paper-item.grade-C { border-left-color: #00b894; }

        .paper-item .title { font-size: 0.75rem; font-weight: 500; margin-bottom: 3px; }
        .paper-item .meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        /* 毕业信息栏 */
        .graduation-info-compact {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            flex-wrap: wrap;
        }

        .graduation-info-compact .date-time {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
        }

        .graduation-info-compact .date-badge {
            padding: 4px 10px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 6px;
            font-weight: 600;
        }

        .graduation-info-compact .remaining-badge {
            padding: 4px 10px;
            background: linear-gradient(135deg, var(--warning-color), #ffeaa7);
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.8rem;
        }

        .graduation-info-compact .target-badge {
            padding: 4px 10px;
            background: var(--light-bg);
            border-radius: 6px;
            font-size: 0.8rem;
            color: var(--primary-color);
            font-weight: 500;
        }

        /* 游戏日志栏 */
        .log-content {
            height: 320px;
            overflow-y: auto;
            padding: 8px;
            background: var(--light-bg);
            border-radius: 10px;
        }

        .log-entry {
            padding: 7px 9px;
            margin-bottom: 5px;
            border-radius: 6px;
            background: white;
            border-left: 3px solid var(--primary-color);
            font-size: 0.8rem;
        }

        .log-entry .date { font-weight: 600; color: var(--primary-color); font-size: 0.75rem; }
        .log-entry .event { color: var(--text-primary); margin: 2px 0; }
        .log-entry .result { color: var(--success-color); font-weight: 500; font-size: 0.75rem; }
        .log-entry.negative .result { color: var(--danger-color); }

		/* 操作栏 */
		.action-grid {
			display: grid;
			grid-template-columns: repeat(3, 1fr);
			gap: 8px;
		}

		.action-btn {
			padding: 12px 10px;
			display: flex;
			flex-direction: column;
			align-items: center;
			gap: 6px;
			font-size: 1rem;
		}

		.action-btn .action-top {
			display: flex;
			align-items: center;
			gap: 6px;
		}

		.action-btn .action-top i { 
			font-size: 1.3rem; 
		}

		.action-btn .action-top span { 
			font-weight: 500;
			line-height: 1.2; 
		}

		.action-cost {
			font-size: 0.8rem;
			opacity: 0.9;
		}

        /* 论文工作站 */
        .paper-slots { display: flex; flex-direction: column; gap: 10px; }

        .paper-slot {
            padding: 10px;
            background: var(--light-bg);
            border-radius: 10px;
            border: 2px dashed var(--border-color);
        }

        .paper-slot.active { border-style: solid; border-color: var(--primary-color); }
        .paper-slot.locked { opacity: 0.5; }

        .paper-slot .slot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .paper-slot .slot-title { font-weight: 600; color: var(--primary-color); font-size: 0.85rem; }
        .paper-slot .paper-title { font-size: 0.75rem; font-weight: 500; margin-bottom: 6px; word-break: break-word; }

        .paper-scores {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-bottom: 6px;
        }

        .score-box {
            text-align: center;
            padding: 5px;
            background: white;
            border-radius: 5px;
        }

        .score-box .label { font-size: 0.6rem; color: var(--text-secondary); }
        .score-box .value { font-size: 0.9rem; font-weight: 700; color: var(--primary-color); }

        .paper-total {
            text-align: center;
            padding: 5px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 5px;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .paper-actions { display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; }
        .paper-actions .btn { padding: 5px; font-size: 0.7rem; justify-content: center; }

        .new-paper-btn {
            width: 100%;
            padding: 15px;
            border: 2px dashed var(--primary-color);
            background: transparent;
            color: var(--primary-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            font-family: inherit;
        }

        .new-paper-btn:hover { background: rgba(108,92,231,0.1); }

        .reviewing-badge {
            display: inline-block;
            padding: 2px 6px;
            background: var(--warning-color);
            color: var(--text-primary);
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 500;
        }

        .reviewing-badge.grade-A {
            background: linear-gradient(135deg, #e17055, #fab1a0);
            color: white;
        }

        .reviewing-badge.grade-B {
            background: linear-gradient(135deg, #fdcb6e, #ffeaa7);
            color: var(--text-primary);
        }

        .reviewing-badge.grade-C {
            background: linear-gradient(135deg, #00b894, #55efc4);
            color: white;
        }

        /* 商店样式 */
        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            background: var(--light-bg);
            border-radius: 8px;
            margin-bottom: 6px;
        }

        .shop-item.disabled { opacity: 0.5; }

        .shop-item-info { flex: 1; }
        .shop-item-name { font-weight: 600; font-size: 0.85rem; }
        .shop-item-desc { font-size: 0.7rem; color: var(--text-secondary); }

        .shop-item-action {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .shop-item-price {
            color: #d68910;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .shop-item-action .btn {
            padding: 4px 10px;
            font-size: 0.75rem;
        }

        /* 统计面板分隔 */
        .stats-section {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px dashed var(--border-color);
        }

        .stats-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        /* 滚动条 */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: var(--light-bg); border-radius: 2px; }
        ::-webkit-scrollbar-thumb { background: var(--secondary-color); border-radius: 2px; }

        @media (max-width: 1100px) { .game-container { grid-template-columns: 1fr; } }

        .hidden { display: none !important; }

        /* 移动端适配 */
        @media (max-width: 768px) {
            .left-column { display: flex; flex-direction: column; }
            #graduation-panel { order: 1; }
            #attributes-panel { order: 3; }
            #research-panel { order: 2; }

            .middle-column { display: flex; flex-direction: column; }
            #action-panel { order: 1; }
            #buff-panel { order: 3; }
            #log-panel { order: 2; }

            .start-container { padding: 15px; margin: 10px; width: calc(100% - 20px); }
            .game-title { font-size: 1.6rem; }
            .game-intro { font-size: 0.8rem; padding: 10px; }
            .character-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; }
            .character-card { padding: 10px; }
            .character-card .icon { font-size: 1.5rem; }
            .character-card .name { font-size: 0.9rem; }
            .character-card .desc { font-size: 0.7rem; }
            .character-card .bonus { font-size: 0.65rem; padding: 4px 6px; }

            #game-screen { padding: 5px; }
            .game-container { grid-template-columns: 1fr; gap: 8px; }
            .panel { padding: 10px; border-radius: 12px; }
            .panel-title { font-size: 0.85rem; padding-bottom: 6px; margin-bottom: 8px; }

            .log-content { height: 200px; padding: 6px; }
            .action-grid { grid-template-columns: repeat(3, 1fr); gap: 5px; }
            .action-btn { padding: 12px 8px; font-size: 0.75rem; min-height: 60px; }

            .modal { max-width: 95%; max-height: 90vh; padding: 15px; }
            .modal-title { font-size: 1.1rem; }
            .modal-content { font-size: 0.85rem; }
        }

        @media (max-width: 400px) {
            .character-grid { grid-template-columns: 1fr; }
            .action-grid { grid-template-columns: repeat(2, 1fr); }
        }

        /* 移动端底部快捷栏 */
        .mobile-quick-bar {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            padding: 8px 5px;
            z-index: 100;
            justify-content: space-around;
        }

        .quick-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 8px 12px;
            border: none;
            background: var(--light-bg);
            border-radius: 8px;
            font-size: 0.7rem;
            color: var(--text-primary);
            cursor: pointer;
            font-family: inherit;
        }

        .quick-btn i { font-size: 1.1rem; color: var(--primary-color); }
        .quick-btn.next-month-btn { background: linear-gradient(135deg, var(--danger-color), #fab1a0); color: white; }
        .quick-btn.next-month-btn i { color: white; }

        @media (max-width: 768px) {
            .mobile-quick-bar.game-active { display: flex; }
            #game-screen { padding-bottom: 70px; }
        }
		
		/* ==================== 折叠功能CSS样式（增强版）==================== */

		/* 可折叠面板标题 */
		.panel-title.collapsible {
			cursor: pointer;
			user-select: none;
			transition: all 0.3s ease;
			display: flex;
			align-items: center;
		}

		.panel-title.collapsible:hover {
			color: var(--accent-color);
		}

		.panel-title .collapse-icon {
			font-size: 0.75rem;
			color: var(--text-secondary);
			transition: transform 0.3s ease;
			flex-shrink: 0;
		}

		.panel-title .collapse-icon.rotated {
			transform: rotate(-90deg);
		}

		/* 折叠内容区域 */
		.collapsible-content {
			overflow: hidden;
			transition: max-height 0.35s ease, opacity 0.25s ease, padding 0.35s ease;
			max-height: 2000px;
			opacity: 1;
		}

		.collapsible-content.collapsed {
			max-height: 0 !important;
			opacity: 0;
			padding-top: 0 !important;
			padding-bottom: 0 !important;
			margin-top: 0 !important;
			margin-bottom: 0 !important;
		}

		/* 折叠状态的面板 */
		.panel.panel-collapsed {
			padding-bottom: 12px;
		}

		.panel.panel-collapsed .panel-title {
			margin-bottom: 0;
			padding-bottom: 0;
			border-bottom: none;
		}

		/* 折叠提示徽章 */
		.collapse-hint {
			font-size: 0.6rem;
			padding: 2px 6px;
			background: var(--light-bg);
			border-radius: 8px;
			color: var(--text-secondary);
			margin-left: 8px;
		}

		/* 开始页面折叠区块 */
		.collapsible-section {
			margin-bottom: 15px;
		}

		.collapsible-header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 12px 15px;
			background: var(--light-bg);
			border-radius: 10px;
			cursor: pointer;
			user-select: none;
			transition: all 0.3s ease;
		}

		.collapsible-header:hover {
			background: var(--border-color);
		}

		.collapsible-header h3,
		.collapsible-header h4 {
			margin: 0;
			font-size: 1rem;
			color: var(--primary-color);
			display: flex;
			align-items: center;
			gap: 8px;
		}

		.collapsible-header .collapse-toggle {
			font-size: 0.85rem;
			color: var(--text-secondary);
			transition: transform 0.3s ease;
		}

		.collapsible-header.collapsed .collapse-toggle {
			transform: rotate(-90deg);
		}

		.collapsible-body {
			overflow: hidden;
			transition: max-height 0.4s ease, opacity 0.3s ease, padding 0.3s ease;
			max-height: 3000px;
			opacity: 1;
		}

		.collapsible-body.collapsed {
			max-height: 0;
			opacity: 0;
			padding-top: 0 !important;
		}

		/* 逆位主题下的折叠样式 */
		body.reversed-theme .collapsible-header {
			background: #2d2d44;
		}

		body.reversed-theme .collapsible-header:hover {
			background: #3d3d54;
		}

		body.reversed-theme .panel-title.collapsible:hover {
			color: #bb8fce;
		}

		body.reversed-theme .collapse-hint {
			background: #2d2d44;
		}

		/* 快速展开/收起所有按钮 */
		.collapse-all-btn {
			position: fixed;
			bottom: 80px;
			right: 15px;
			z-index: 99;
			padding: 8px 12px;
			background: var(--card-bg);
			border: 1px solid var(--border-color);
			border-radius: 20px;
			font-size: 0.75rem;
			cursor: pointer;
			box-shadow: var(--shadow);
			display: none;
		}

		@media (max-width: 768px) {
			.collapse-all-btn {
				display: flex;
				align-items: center;
				gap: 5px;
			}
		}

		body.reversed-theme .collapse-all-btn {
			background: #1a1a2e;
			border-color: #444;
			color: #e0e0e0;
		}

		/* ==================== 角色卡片折叠功能 ==================== */

		.character-card {
			position: relative;
		}

		.character-card .card-header {
			display: flex;
			align-items: center;
			gap: 8px;
			cursor: pointer;
			padding-bottom: 8px;
			margin-bottom: 8px;
			border-bottom: 1px dashed var(--border-color);
			transition: all 0.3s ease;
		}

		.character-card .card-header:hover {
			color: var(--primary-color);
		}

		.character-card .card-header .header-left {
			display: flex;
			align-items: center;
			gap: 8px;
			flex: 1;
		}

		.character-card .card-header .collapse-icon {
			font-size: 0.7rem;
			color: var(--text-secondary);
			transition: transform 0.3s ease;
		}

		.character-card .card-header .collapse-icon.rotated {
			transform: rotate(-90deg);
		}

		.character-card .card-body {
			overflow: hidden;
			transition: max-height 0.35s ease, opacity 0.25s ease;
			max-height: 1000px;
			opacity: 1;
		}

		.character-card .card-body.collapsed {
			max-height: 0 !important;
			opacity: 0;
		}

		.character-card.card-collapsed {
			padding-bottom: 12px;
		}

		.character-card.card-collapsed .card-header {
			border-bottom: none;
			padding-bottom: 0;
			margin-bottom: 0;
		}

		/* 折叠状态下的迷你难度显示 */
		.character-card .mini-difficulty {
			display: none;
			align-items: center;
			gap: 6px;
			margin-left: auto;
			margin-right: 8px;
		}

		.character-card.card-collapsed .mini-difficulty {
			display: flex;
		}

		/* 逆位主题下的卡片折叠样式 */
		body.reversed-theme .character-card .card-header {
			border-bottom-color: #444;
		}

		body.reversed-theme .character-card .card-header:hover {
			color: #bb8fce;
		}

		/* ==================== 留言板样式 ==================== */
		.message-input-area {
			background: var(--card-bg);
			padding: 15px;
			border-radius: 10px;
			border: 1px solid var(--border-color);
		}

		.message-input-area input:focus,
		.message-input-area textarea:focus {
			outline: none;
			border-color: var(--primary-color);
			box-shadow: 0 0 0 2px rgba(108, 92, 231, 0.1);
		}

		.message-item {
			background: var(--card-bg);
			border-radius: 10px;
			padding: 12px 15px;
			margin-bottom: 10px;
			border: 1px solid var(--border-color);
			transition: all 0.3s ease;
		}

		.message-item:hover {
			border-color: var(--secondary-color);
			box-shadow: 0 2px 8px rgba(0,0,0,0.05);
		}

		.message-item.reply {
			margin-left: 30px;
			border-left: 3px solid var(--secondary-color);
			background: linear-gradient(135deg, rgba(162,155,254,0.05), rgba(108,92,231,0.05));
		}

		.message-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 8px;
		}

		.message-nickname {
			font-weight: 600;
			color: var(--primary-color);
			font-size: 0.9rem;
		}

		.message-time {
			font-size: 0.7rem;
			color: var(--text-secondary);
		}

		.message-content {
			font-size: 0.85rem;
			line-height: 1.6;
			color: var(--text-primary);
			word-break: break-word;
		}

		.message-reply-to {
			font-size: 0.75rem;
			color: var(--text-secondary);
			margin-bottom: 5px;
			padding: 4px 8px;
			background: var(--light-bg);
			border-radius: 4px;
			display: inline-block;
		}

		.message-actions {
			margin-top: 8px;
			display: flex;
			gap: 10px;
		}

		.message-actions button {
			background: none;
			border: none;
			color: var(--text-secondary);
			font-size: 0.75rem;
			cursor: pointer;
			padding: 4px 8px;
			border-radius: 4px;
			transition: all 0.2s ease;
			font-family: inherit;
		}

		.message-actions button:hover {
			background: var(--light-bg);
			color: var(--primary-color);
		}

		.reply-count {
			color: var(--info-color);
			font-size: 0.75rem;
			margin-left: 5px;
		}

		.message-replies {
			margin-top: 10px;
			padding-top: 10px;
			border-top: 1px dashed var(--border-color);
		}

		.no-messages {
			text-align: center;
			padding: 30px;
			color: var(--text-secondary);
		}

		.no-messages i {
			font-size: 2rem;
			margin-bottom: 10px;
			opacity: 0.5;
		}

		/* 逆位主题留言板样式 */
		body.reversed-theme .message-input-area {
			background: #16213e;
			border-color: #444;
		}

		body.reversed-theme .message-input-area input,
		body.reversed-theme .message-input-area textarea {
			background: #1a1a2e;
			border-color: #444;
			color: #e0e0e0;
		}

		body.reversed-theme .message-input-area input::placeholder,
		body.reversed-theme .message-input-area textarea::placeholder {
			color: #666;
		}

		body.reversed-theme .message-item {
			background: #16213e;
			border-color: #333;
		}

		body.reversed-theme .message-item:hover {
			border-color: #9b59b6;
		}

		body.reversed-theme .message-item.reply {
			border-left-color: #9b59b6;
			background: linear-gradient(135deg, rgba(155,89,182,0.1), rgba(142,68,173,0.1));
		}

		body.reversed-theme .message-nickname {
			color: #bb8fce;
		}

		body.reversed-theme .message-reply-to {
			background: #2d2d44;
		}

		body.reversed-theme .message-actions button:hover {
			background: #2d2d44;
			color: #bb8fce;
		}

		body.reversed-theme #reply-indicator {
			background: rgba(155, 89, 182, 0.15);
		}

		body.reversed-theme #reply-indicator span:first-child {
			color: #bb8fce;
		}

		/* 游戏说明按钮区域样式增强 */
		#guide-section .collapsible-header {
			background: linear-gradient(135deg, rgba(108,92,231,0.1), rgba(253,121,168,0.1));
		}

		#guide-section .collapsible-header:hover {
			background: linear-gradient(135deg, rgba(108,92,231,0.2), rgba(253,121,168,0.2));
		}

		body.reversed-theme #guide-section .collapsible-header {
			background: linear-gradient(135deg, rgba(155,89,182,0.2), rgba(231,76,60,0.2));
		}

		/* 说明弹窗内的表格样式 */
		.modal table {
			background: var(--card-bg);
		}

		.modal code {
			word-break: break-word;
		}

		/* 响应式调整 */
		@media (max-width: 600px) {
			#guide-section .btn {
				font-size: 0.7rem !important;
				padding: 8px 4px !important;
			}
			
			#guide-section .btn i {
				display: block;
				margin-bottom: 2px;
			}
		}
		/* ==================== 真·大多数解锁栏 ==================== */
		.zodiac-unlock-panel {
			margin-top: 15px;
			position: relative;
			border-radius: 16px;
			padding: 0;
			overflow: hidden;
			transition: all 0.3s ease;
		}

		/* ====== 正位模式 - 浅灰色石碑风格 ====== */
		body:not(.reversed-theme) .zodiac-unlock-panel {
			background: linear-gradient(135deg, #e8e8e8 0%, #f5f5f5 50%, #e8e8e8 100%);
			border: 2px solid #d0d0d0;
			box-shadow: 
				0 4px 15px rgba(0, 0, 0, 0.08),
				inset 0 0 30px rgba(255, 255, 255, 0.5);
		}

		/* ====== 逆位模式 - 深紫色神秘风格 ====== */
		body.reversed-theme .zodiac-unlock-panel {
			background: linear-gradient(135deg, #1a1a2a 0%, #2a2a3a 50%, #1a1a2a 100%);
			border: 2px solid #3a3a4a;
			box-shadow: 
				0 4px 20px rgba(0, 0, 0, 0.4),
				inset 0 0 40px rgba(0, 0, 0, 0.3);
		}

		/* ==================== 标题区域 ==================== */
		.zodiac-header {
			position: relative;
			z-index: 2;
			text-align: center;
			padding: 18px 15px 12px;
		}

		/* 正位标题 */
		body:not(.reversed-theme) .zodiac-header {
			background: linear-gradient(180deg, rgba(108,92,231,0.08) 0%, transparent 100%);
			border-bottom: 1px solid rgba(108, 92, 231, 0.15);
		}

		body:not(.reversed-theme) .zodiac-title {
			color: #6c5ce7;
			text-shadow: 0 1px 2px rgba(108, 92, 231, 0.2);
		}

		body:not(.reversed-theme) .zodiac-subtitle {
			color: #888;
		}

		/* 逆位标题 */
		body.reversed-theme .zodiac-header {
			background: linear-gradient(180deg, rgba(255,215,0,0.1) 0%, transparent 100%);
			border-bottom: 1px solid rgba(255, 215, 0, 0.2);
		}

		body.reversed-theme .zodiac-title {
			color: #ffd700;
			text-shadow: 
				0 0 10px rgba(255, 215, 0, 0.6),
				0 0 20px rgba(255, 215, 0, 0.3);
		}

		body.reversed-theme .zodiac-subtitle {
			color: rgba(255, 255, 255, 0.5);
		}

		.zodiac-title {
			font-size: 1.2rem;
			font-weight: 700;
			letter-spacing: 2px;
			margin-bottom: 4px;
		}

		.zodiac-subtitle {
			font-size: 0.75rem;
			letter-spacing: 1px;
		}

		/* ==================== 进度条 ==================== */
		.zodiac-progress {
			margin: 10px 20px 0;
			height: 6px;
			border-radius: 3px;
			overflow: hidden;
		}

		body:not(.reversed-theme) .zodiac-progress {
			background: rgba(108, 92, 231, 0.15);
		}

		body.reversed-theme .zodiac-progress {
			background: rgba(255, 255, 255, 0.1);
		}

		.zodiac-progress-fill {
			height: 100%;
			background: linear-gradient(90deg, #6c5ce7, #ffd700, #9b59b6);
			background-size: 200% 100%;
			animation: progressShine 3s linear infinite;
			border-radius: 3px;
			transition: width 0.5s ease;
		}

		@keyframes progressShine {
			0% { background-position: 200% 0; }
			100% { background-position: -200% 0; }
		}

		.zodiac-progress-text {
			font-size: 0.75rem;
			margin-top: 6px;
		}

		body:not(.reversed-theme) .zodiac-progress-text {
			color: #888;
		}

		body.reversed-theme .zodiac-progress-text {
			color: rgba(255, 255, 255, 0.6);
		}

		/* ==================== 主体区域 ==================== */
		.zodiac-body {
			position: relative;
			z-index: 2;
			display: flex;
			min-height: 260px;
		}

		/* 中央分隔线 */
		.zodiac-divider {
			position: absolute;
			left: 50%;
			top: 0;
			bottom: 0;
			width: 2px;
			transform: translateX(-50%);
			z-index: 5;
		}

		body:not(.reversed-theme) .zodiac-divider {
			background: linear-gradient(
				180deg,
				transparent 0%,
				rgba(108, 92, 231, 0.2) 20%,
				rgba(108, 92, 231, 0.4) 50%,
				rgba(108, 92, 231, 0.2) 80%,
				transparent 100%
			);
		}

		body.reversed-theme .zodiac-divider {
			background: linear-gradient(
				180deg,
				transparent 0%,
				rgba(255, 215, 0, 0.2) 20%,
				rgba(255, 215, 0, 0.5) 50%,
				rgba(255, 215, 0, 0.2) 80%,
				transparent 100%
			);
		}

		/* ==================== 中央核心图标 ==================== */
		.zodiac-center {
			position: absolute;
			left: 50%;
			top: 50%;
			transform: translate(-50%, -50%);
			z-index: 10;
		}

		.zodiac-core {
			width: 60px;
			height: 60px;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 1.8rem;
			transition: all 0.3s ease;
		}

		/* 正位核心 */
		body:not(.reversed-theme) .zodiac-core.locked {
			background: linear-gradient(135deg, #d0d0d0 0%, #c0c0c0 100%);
			border: 3px solid #b0b0b0;
			box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
		}

		body:not(.reversed-theme) .zodiac-core.unlocked {
			background: radial-gradient(circle, #6c5ce7 0%, #5b4cdb 60%, #4a3cc9 100%);
			border: 3px solid #6c5ce7;
			box-shadow: 
				0 0 15px rgba(108, 92, 231, 0.5),
				0 0 30px rgba(108, 92, 231, 0.3),
				inset 0 0 10px rgba(255, 255, 255, 0.3);
			animation: corePulseNormal 2s ease-in-out infinite;
		}

		@keyframes corePulseNormal {
			0%, 100% { 
				box-shadow: 
					0 0 15px rgba(108, 92, 231, 0.5),
					0 0 30px rgba(108, 92, 231, 0.3);
			}
			50% { 
				box-shadow: 
					0 0 25px rgba(108, 92, 231, 0.7),
					0 0 50px rgba(108, 92, 231, 0.5);
			}
		}

		/* 逆位核心 */
		body.reversed-theme .zodiac-core.locked {
			background: linear-gradient(135deg, #3a3a4a 0%, #2a2a3a 100%);
			border: 3px solid #4a4a5a;
			box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.5);
		}

		body.reversed-theme .zodiac-core.unlocked {
			background: radial-gradient(circle, #ffd700 0%, #ff8c00 60%, #cc6600 100%);
			border: 3px solid #ffd700;
			box-shadow: 
				0 0 20px rgba(255, 215, 0, 0.7),
				0 0 40px rgba(255, 140, 0, 0.4),
				inset 0 0 15px rgba(255, 255, 255, 0.3);
			animation: corePulseReversed 2s ease-in-out infinite;
		}

		@keyframes corePulseReversed {
			0%, 100% { 
				box-shadow: 
					0 0 20px rgba(255, 215, 0, 0.7),
					0 0 40px rgba(255, 140, 0, 0.4);
			}
			50% { 
				box-shadow: 
					0 0 30px rgba(255, 215, 0, 0.9),
					0 0 60px rgba(255, 140, 0, 0.6);
			}
		}

		/* ==================== 左右半区通用 ==================== */
		.zodiac-half {
			flex: 1;
			padding: 15px;
			cursor: pointer;
			transition: all 0.3s ease;
			position: relative;
			display: flex;
			flex-direction: column;
			align-items: center;
		}

		.zodiac-half-title {
			font-size: 1rem;
			font-weight: 600;
			margin-bottom: 12px;
			display: flex;
			align-items: center;
			gap: 6px;
			transition: all 0.3s ease;
			position: relative;
			z-index: 2;
		}

		.zodiac-grid {
			display: grid;
			grid-template-columns: repeat(2, 1fr);
			gap: 10px;
			width: 100%;
			max-width: 160px;
			position: relative;
			z-index: 2;
		}

		.zodiac-click-hint {
			position: absolute;
			bottom: 10px;
			font-size: 0.65rem;
			opacity: 0;
			transition: opacity 0.3s ease;
			pointer-events: none;
			z-index: 2;
		}

		.zodiac-half:hover .zodiac-click-hint {
			opacity: 1;
		}

		body:not(.reversed-theme) .zodiac-click-hint {
			color: rgba(108, 92, 231, 0.6);
		}

		body.reversed-theme .zodiac-click-hint {
			color: rgba(255, 255, 255, 0.35);
		}

		/* ==================== 正位模式 - 左侧正位半区（浅灰石碑）==================== */
		body:not(.reversed-theme) .zodiac-half.normal-half {
			background: linear-gradient(135deg, #f0f0f0 0%, #e5e5e5 50%, #f0f0f0 100%);
		}

		body:not(.reversed-theme) .zodiac-half.normal-half::before {
			content: '';
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: 
				radial-gradient(ellipse at 20% 30%, rgba(255, 255, 255, 0.5) 0%, transparent 50%),
				radial-gradient(ellipse at 80% 70%, rgba(200, 200, 200, 0.3) 0%, transparent 50%);
			pointer-events: none;
		}

		body:not(.reversed-theme) .zodiac-half.normal-half.active {
			background: linear-gradient(135deg, #f5f5f5 0%, #ebebeb 50%, #f5f5f5 100%);
			box-shadow: inset 0 0 20px rgba(108, 92, 231, 0.05);
		}

		body:not(.reversed-theme) .zodiac-half.normal-half .zodiac-half-title {
			color: #666;
			text-shadow: 0 1px 1px rgba(255, 255, 255, 0.8);
		}

		body:not(.reversed-theme) .zodiac-half.normal-half.active .zodiac-half-title {
			color: #6c5ce7;
		}

		/* 正位模式 - 正位符文（浅灰石头质感）*/
		body:not(.reversed-theme) .zodiac-half.normal-half .zodiac-rune {
			background: linear-gradient(145deg, #e8e8e8 0%, #d8d8d8 50%, #c8c8c8 100%);
			border: 2px solid #c0c0c0;
			box-shadow: 
				inset 2px 2px 4px rgba(255, 255, 255, 0.6),
				inset -2px -2px 4px rgba(0, 0, 0, 0.08),
				0 2px 4px rgba(0, 0, 0, 0.1);
		}

		body:not(.reversed-theme) .zodiac-half.normal-half .zodiac-rune.locked {
			background: linear-gradient(145deg, #d8d8d8 0%, #c8c8c8 50%, #b8b8b8 100%);
			border-color: #b0b0b0;
		}

		body:not(.reversed-theme) .zodiac-half.normal-half .zodiac-rune.locked .rune-icon {
			filter: grayscale(100%) brightness(0.7);
			opacity: 0.5;
		}

		body:not(.reversed-theme) .zodiac-half.normal-half .zodiac-rune.locked .rune-name {
			color: rgba(0, 0, 0, 0.3);
		}

		body:not(.reversed-theme) .zodiac-half.normal-half .zodiac-rune.unlocked {
			background: linear-gradient(145deg, #f0f0f0 0%, #e0e0e0 50%, #d0d0d0 100%);
			border-color: #6c5ce7;
			box-shadow: 
				inset 2px 2px 4px rgba(255, 255, 255, 0.7),
				inset -2px -2px 4px rgba(0, 0, 0, 0.05),
				0 0 8px rgba(108, 92, 231, 0.3);
		}

		body:not(.reversed-theme) .zodiac-half.normal-half .zodiac-rune.unlocked .rune-icon {
			filter: none;
			opacity: 1;
		}

		body:not(.reversed-theme) .zodiac-half.normal-half .zodiac-rune.unlocked .rune-name {
			color: #333;
		}

		/* ==================== 正位模式 - 右侧逆位半区（浅紫色）==================== */
		body:not(.reversed-theme) .zodiac-half.reversed-half {
			background: linear-gradient(135deg, #f5f0fa 0%, #ebe5f5 50%, #f5f0fa 100%);
		}

		body:not(.reversed-theme) .zodiac-half.reversed-half::before {
			content: '';
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: 
				radial-gradient(ellipse at 30% 20%, rgba(155, 89, 182, 0.08) 0%, transparent 50%),
				radial-gradient(ellipse at 70% 80%, rgba(108, 92, 231, 0.08) 0%, transparent 50%);
			pointer-events: none;
		}

		body:not(.reversed-theme) .zodiac-half.reversed-half.active {
			background: linear-gradient(135deg, #f8f3fc 0%, #f0eaf8 50%, #f8f3fc 100%);
		}

		body:not(.reversed-theme) .zodiac-half.reversed-half .zodiac-half-title {
			color: #9b59b6;
		}

		body:not(.reversed-theme) .zodiac-half.reversed-half.active .zodiac-half-title {
			color: #8e44ad;
			text-shadow: 0 0 5px rgba(155, 89, 182, 0.3);
		}

		/* 正位模式 - 逆位符文（浅紫色）*/
		body:not(.reversed-theme) .zodiac-half.reversed-half .zodiac-rune {
			background: linear-gradient(135deg, #f0e8f5 0%, #e5daf0 100%);
			border: 2px solid #d0c0e0;
			box-shadow: inset 0 0 8px rgba(155, 89, 182, 0.05);
		}

		body:not(.reversed-theme) .zodiac-half.reversed-half .zodiac-rune.locked {
			background: linear-gradient(135deg, #e8e0f0 0%, #ddd5e8 100%);
			border-color: #c8b8d8;
		}

		body:not(.reversed-theme) .zodiac-half.reversed-half .zodiac-rune.locked .rune-icon {
			filter: grayscale(80%) brightness(0.8);
			opacity: 0.4;
		}

		body:not(.reversed-theme) .zodiac-half.reversed-half .zodiac-rune.locked .rune-name {
			color: rgba(155, 89, 182, 0.35);
		}

		body:not(.reversed-theme) .zodiac-half.reversed-half .zodiac-rune.unlocked {
			background: linear-gradient(135deg, rgba(155, 89, 182, 0.15) 0%, rgba(108, 92, 231, 0.1) 100%);
			border-color: #9b59b6;
			box-shadow: 0 0 10px rgba(155, 89, 182, 0.25);
		}

		body:not(.reversed-theme) .zodiac-half.reversed-half .zodiac-rune.unlocked .rune-icon {
			filter: none;
		}

		body:not(.reversed-theme) .zodiac-half.reversed-half .zodiac-rune.unlocked .rune-name {
			color: #8e44ad;
		}

		/* ==================== 逆位模式 - 左侧正位半区（深灰石头）==================== */
		body.reversed-theme .zodiac-half.normal-half {
			background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 50%, #2a2a2a 100%);
		}

		body.reversed-theme .zodiac-half.normal-half::before {
			content: '';
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: 
				radial-gradient(ellipse at 20% 30%, rgba(80, 80, 80, 0.3) 0%, transparent 50%),
				radial-gradient(ellipse at 80% 70%, rgba(60, 60, 60, 0.3) 0%, transparent 50%);
			pointer-events: none;
		}

		body.reversed-theme .zodiac-half.normal-half.active {
			background: linear-gradient(135deg, #3a3a3a 0%, #4a4a4a 50%, #3a3a3a 100%);
			box-shadow: inset 0 0 30px rgba(255, 255, 255, 0.05);
		}

		body.reversed-theme .zodiac-half.normal-half .zodiac-half-title {
			color: #a0a0a0;
			text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
		}

		body.reversed-theme .zodiac-half.normal-half.active .zodiac-half-title {
			color: #d0d0d0;
		}

		/* 逆位模式 - 正位符文（深灰石头质感）*/
		body.reversed-theme .zodiac-half.normal-half .zodiac-rune {
			background: linear-gradient(145deg, #4a4a4a 0%, #3a3a3a 50%, #2a2a2a 100%);
			border: 2px solid #5a5a5a;
			box-shadow: 
				inset 2px 2px 4px rgba(255, 255, 255, 0.1),
				inset -2px -2px 4px rgba(0, 0, 0, 0.3),
				0 3px 6px rgba(0, 0, 0, 0.3);
		}

		body.reversed-theme .zodiac-half.normal-half .zodiac-rune.locked {
			background: linear-gradient(145deg, #3a3a3a 0%, #2a2a2a 50%, #1a1a1a 100%);
			border-color: #3a3a3a;
		}

		body.reversed-theme .zodiac-half.normal-half .zodiac-rune.locked .rune-icon {
			filter: grayscale(100%) brightness(0.5);
			opacity: 0.4;
		}

		body.reversed-theme .zodiac-half.normal-half .zodiac-rune.locked .rune-name {
			color: rgba(255, 255, 255, 0.25);
		}

		body.reversed-theme .zodiac-half.normal-half .zodiac-rune.unlocked {
			background: linear-gradient(145deg, #5a5a5a 0%, #4a4a4a 50%, #3a3a3a 100%);
			border-color: #7a7a7a;
			box-shadow: 
				inset 2px 2px 4px rgba(255, 255, 255, 0.15),
				inset -2px -2px 4px rgba(0, 0, 0, 0.2),
				0 0 10px rgba(200, 200, 200, 0.2);
		}

		body.reversed-theme .zodiac-half.normal-half .zodiac-rune.unlocked .rune-icon {
			filter: none;
			opacity: 1;
		}

		body.reversed-theme .zodiac-half.normal-half .zodiac-rune.unlocked .rune-name {
			color: rgba(255, 255, 255, 0.8);
		}

		/* ==================== 逆位模式 - 右侧逆位半区（深紫神秘）==================== */
		body.reversed-theme .zodiac-half.reversed-half {
			background: linear-gradient(135deg, #1a1a2e 0%, #2a2a4a 50%, #1a1a2e 100%);
		}

		body.reversed-theme .zodiac-half.reversed-half::before {
			content: '';
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: 
				radial-gradient(ellipse at 30% 20%, rgba(155, 89, 182, 0.15) 0%, transparent 50%),
				radial-gradient(ellipse at 70% 80%, rgba(108, 92, 231, 0.15) 0%, transparent 50%);
			pointer-events: none;
		}

		body.reversed-theme .zodiac-half.reversed-half.active {
			background: linear-gradient(135deg, #2a2a4a 0%, #3a3a5a 50%, #2a2a4a 100%);
		}

		body.reversed-theme .zodiac-half.reversed-half .zodiac-half-title {
			color: #a29bfe;
			text-shadow: 0 0 10px rgba(162, 155, 254, 0.5);
		}

		body.reversed-theme .zodiac-half.reversed-half.active .zodiac-half-title {
			color: #d4b5ff;
			text-shadow: 0 0 15px rgba(212, 181, 255, 0.7);
		}

		/* 逆位模式 - 逆位符文（紫色发光）*/
		body.reversed-theme .zodiac-half.reversed-half .zodiac-rune {
			background: linear-gradient(135deg, #2a2a4a 0%, #3a3a5a 100%);
			border: 2px solid #4a4a6a;
			box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3);
		}

		body.reversed-theme .zodiac-half.reversed-half .zodiac-rune.locked {
			background: linear-gradient(135deg, #1a1a2e 0%, #2a2a3e 100%);
			border-color: #3a3a4a;
		}

		body.reversed-theme .zodiac-half.reversed-half .zodiac-rune.locked .rune-icon {
			filter: grayscale(100%) brightness(0.4);
			opacity: 0.3;
		}

		body.reversed-theme .zodiac-half.reversed-half .zodiac-rune.locked .rune-name {
			color: rgba(162, 155, 254, 0.3);
		}

		body.reversed-theme .zodiac-half.reversed-half .zodiac-rune.unlocked {
			background: radial-gradient(circle, rgba(155, 89, 182, 0.4) 0%, rgba(108, 92, 231, 0.3) 100%);
			border-color: #9b59b6;
			box-shadow: 
				0 0 15px rgba(155, 89, 182, 0.5),
				0 0 30px rgba(155, 89, 182, 0.2),
				inset 0 0 10px rgba(255, 255, 255, 0.1);
			animation: runeGlowReversed 2s ease-in-out infinite;
		}

		@keyframes runeGlowReversed {
			0%, 100% { 
				box-shadow: 
					0 0 15px rgba(155, 89, 182, 0.5),
					0 0 30px rgba(155, 89, 182, 0.2);
			}
			50% { 
				box-shadow: 
					0 0 20px rgba(155, 89, 182, 0.7),
					0 0 40px rgba(155, 89, 182, 0.4);
			}
		}

		body.reversed-theme .zodiac-half.reversed-half .zodiac-rune.unlocked .rune-icon {
			filter: drop-shadow(0 0 5px rgba(155, 89, 182, 0.8));
		}

		body.reversed-theme .zodiac-half.reversed-half .zodiac-rune.unlocked .rune-name {
			color: #e0d0ff;
			text-shadow: 0 0 5px rgba(155, 89, 182, 0.5);
		}

		/* ==================== 通用符文样式 ==================== */
		.zodiac-rune {
			position: relative;
			width: 65px;
			height: 65px;
			margin: 0 auto;
			border-radius: 50%;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			transition: all 0.3s ease;
			cursor: pointer;
		}

		.zodiac-rune:hover {
			transform: scale(1.08);
		}

		.zodiac-rune .rune-icon {
			font-size: 1.6rem;
			transition: all 0.3s ease;
		}

		.zodiac-rune .rune-name {
			font-size: 0.6rem;
			margin-top: 2px;
			transition: all 0.3s ease;
		}

		.zodiac-rune.locked::after {
			content: '🔒';
			position: absolute;
			font-size: 0.7rem;
			top: -3px;
			right: -3px;
			opacity: 0.7;
		}

		/* ==================== 底部区域 ==================== */
		.zodiac-footer {
			position: relative;
			z-index: 2;
			padding: 15px 20px;
			text-align: center;
		}

		body:not(.reversed-theme) .zodiac-footer {
			background: linear-gradient(0deg, rgba(108,92,231,0.05) 0%, transparent 100%);
			border-top: 1px solid rgba(108, 92, 231, 0.1);
		}

		body.reversed-theme .zodiac-footer {
			background: linear-gradient(0deg, rgba(0,0,0,0.4) 0%, transparent 100%);
			border-top: 1px solid rgba(255, 215, 0, 0.1);
		}

		.zodiac-unlock-btn {
			padding: 10px 35px;
			font-size: 0.95rem;
			font-weight: 600;
			border: none;
			border-radius: 20px;
			cursor: pointer;
			transition: all 0.3s ease;
			font-family: inherit;
		}

		.zodiac-unlock-btn.available {
			background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);
			color: white;
			box-shadow: 0 0 15px rgba(108, 92, 231, 0.4);
		}

		body.reversed-theme .zodiac-unlock-btn.available {
			background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
			color: #1a1a2e;
			box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
		}

		.zodiac-unlock-btn.available:hover {
			transform: translateY(-2px);
			box-shadow: 0 0 25px rgba(108, 92, 231, 0.6);
		}

		body.reversed-theme .zodiac-unlock-btn.available:hover {
			box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
		}

		.zodiac-unlock-btn.active {
			background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
			color: white;
			box-shadow: 0 0 15px rgba(231, 76, 60, 0.4);
		}

		.zodiac-unlock-btn.disabled {
			background: #c0c0c0;
			color: #888;
			cursor: not-allowed;
		}

		body.reversed-theme .zodiac-unlock-btn.disabled {
			background: #3a3a4a;
			color: rgba(255, 255, 255, 0.4);
		}

		.zodiac-status-text {
			font-size: 0.75rem;
			margin-top: 8px;
		}

		body:not(.reversed-theme) .zodiac-status-text {
			color: #888;
		}

		body:not(.reversed-theme) .zodiac-status-text.success {
			color: #6c5ce7;
		}

		body.reversed-theme .zodiac-status-text {
			color: rgba(255, 255, 255, 0.5);
		}

		body.reversed-theme .zodiac-status-text.success {
			color: #ffd700;
		}

		/* ==================== 响应式 ==================== */
		@media (max-width: 500px) {
			.zodiac-grid {
				grid-template-columns: repeat(3, 1fr);
				max-width: 100%;
			}
			.zodiac-rune {
				width: 50px;
				height: 50px;
			}
			.zodiac-rune .rune-icon {
				font-size: 1.3rem;
			}
			.zodiac-core {
				width: 45px;
				height: 45px;
				font-size: 1.4rem;
			}
			.zodiac-body {
				min-height: 200px;
			}
		}
		/* 符文可点击提示 */
		.zodiac-rune {
			cursor: pointer;
		}

		.zodiac-rune::before {
			content: '点击选择';
			position: absolute;
			bottom: -20px;
			left: 50%;
			transform: translateX(-50%);
			font-size: 0.55rem;
			white-space: nowrap;
			opacity: 0;
			transition: opacity 0.3s ease;
			pointer-events: none;
			padding: 2px 6px;
			border-radius: 4px;
			z-index: 10;
		}

		body:not(.reversed-theme) .zodiac-rune::before {
			color: #6c5ce7;
			background: rgba(108, 92, 231, 0.1);
		}

		body.reversed-theme .zodiac-rune::before {
			color: rgba(255, 255, 255, 0.7);
			background: rgba(0, 0, 0, 0.3);
		}

		.zodiac-rune:hover::before {
			opacity: 1;
		}

		/* 符文悬停效果增强 */
		.zodiac-rune:hover {
			transform: scale(1.15);
		}

		.zodiac-rune:active {
			transform: scale(1.05);
		}
    </style>
</head>


<body>
    <!-- 开始界面 -->
    <div id="start-screen">
        <div class="start-container">
			<h1 class="game-title">🎓 研究生模拟器-正式版</h1>
			<p class="game-author">
				作者：<a href="https://xhslink.com/m/A2DFslJF4mb" target="_blank" style="color:var(--primary-color);text-decoration:none;">落星峦</a>
				&nbsp;|&nbsp;
				项目：<a href="https://github.com/kw66/PhD_Simulator" target="_blank" style="color:var(--primary-color);text-decoration:none;">GitHub</a>
				&nbsp;|&nbsp;
				测试：雁栖湖
				&nbsp;|&nbsp;
				<a href="http://xhslink.com/o/8czcPQfNziK" target="_blank" style="color:var(--accent-color);text-decoration:none;">🎨 科研绘图</a>
				&nbsp;|&nbsp;
				<a href="http://xhslink.com/o/AC6pvxkgOhv" target="_blank" style="color:var(--success-color);text-decoration:none;">🏢 实习</a>
			</p>

			<!-- 访问统计 -->
			<div id="visitor-stats" style="text-align:center;font-size:0.75rem;color:var(--text-secondary);margin-bottom:15px;">
				<!-- 第一行：实时数据 -->
				<div style="margin-bottom:5px;">
					<span style="display:inline;">
						🟢 历史在线 <span id="max-online-value" style="color:var(--accent-color);font-weight:600;">-</span>
					</span>
					&nbsp;|&nbsp; 
					<span id="busuanzi_container_site_pv" style="display:inline;">
						📊 总访问 <span id="busuanzi_value_site_pv" style="color:var(--primary-color);font-weight:600;">-</span>
					</span> 
					&nbsp;|&nbsp; 
					<span id="busuanzi_container_site_uv" style="display:inline;">
						👥 总访客 <span id="busuanzi_value_site_uv" style="color:var(--primary-color);font-weight:600;">-</span>
					</span>
					&nbsp;|&nbsp; 
					<span id="total-games-container" style="display:inline;">
						🎮 总游玩 <span id="total-games-value" style="color:var(--primary-color);font-weight:600;">-</span>
					</span>
				</div>
				<!-- 第二行：今日数据 -->
				<div>
					<span style="display:inline;">
						🟢 当前在线 <span id="online-count-value" style="color:var(--success-color);font-weight:600;">-</span>
					</span>
					&nbsp;|&nbsp; 
					<span style="display:inline;">
						☀️ 今日访问 <span id="today-pv-value" style="color:var(--warning-color);font-weight:600;">-</span>
					</span>
					&nbsp;|&nbsp; 
					<span style="display:inline;">
						👤 今日访客 <span id="today-uv-value" style="color:var(--warning-color);font-weight:600;">-</span>
					</span>
					&nbsp;|&nbsp; 
					<span style="display:inline;">
						🎯 今日游玩 <span id="today-games-value" style="color:var(--warning-color);font-weight:600;">-</span>
					</span>
				</div>
			</div>
            
            <!-- 模式切换按钮 -->
            <div class="mode-toggle-container" style="display:none;">
                <button class="mode-toggle-btn active" id="normal-mode-btn" onclick="switchMode(false)">
                    ☀️ 正位
                </button>
                <button class="mode-toggle-btn" id="reversed-mode-btn" onclick="switchMode(true)">
                    🌑 逆位
                </button>
            </div>
            
            <div class="mode-description" id="mode-description">
                📚 经典模式，体验标准的研究生生涯
            </div>
            
            <div class="game-intro" id="game-intro">
                <p>📚 <strong>欢迎来到研究生模拟器！</strong>体验研究生生涯，平衡科研、生活和人际关系，努力发表论文，最终顺利毕业。</p>
                <p>🎯 <strong>游戏目标</strong>：硕士毕业科研分≥1（3年），博士毕业科研分≥7（5年）</p>
                <p>📝 <strong>论文科研分</strong>：A类=4分，B类=2分，C类=1分</p>
                <p>💡 <strong>属性影响</strong>：科研能力影响论文分数；社交能力和导师好感度影响事件选项和结果。<strong>建议优先将属性提升至6以解锁更多选项！</strong></p>
                <p>⚠️ <strong>注意</strong>：保持SAN值、导师好感度和金钱为正数，否则将触发不良结局！</p>
            </div>
			
			<!-- ==================== 5. 修改开始页面HTML结构 ==================== -->

			<!-- 角色选择区块（可折叠） -->
			<div class="collapsible-section" id="character-section">
				<div class="collapsible-header" onclick="toggleStartSection('character')">
					<h3 id="selection-title"><i class="fas fa-users"></i> 选择你的角色</h3>
					<div style="display:flex;align-items:center;gap:8px;">
						<!-- ★★★ 新增：卡片全部展开/收起按钮 ★★★ -->
						<button class="btn" style="padding:3px 8px;font-size:0.65rem;background:var(--light-bg);color:var(--text-secondary);border:1px solid var(--border-color);" 
								onclick="event.stopPropagation();toggleAllCharacterCards(true)">
							<i class="fas fa-compress-alt"></i> 收起卡片
						</button>
						<button class="btn" style="padding:3px 8px;font-size:0.65rem;background:var(--light-bg);color:var(--text-secondary);border:1px solid var(--border-color);" 
								onclick="event.stopPropagation();toggleAllCharacterCards(false)">
							<i class="fas fa-expand-alt"></i> 展开卡片
						</button>
						<i class="fas fa-chevron-down collapse-toggle" id="character-collapse-icon"></i>
					</div>
				</div>
				<div class="collapsible-body" id="character-body">
					<!-- 真·大多数解锁进度容器 -->
					<div id="true-normal-progress" style="margin-top:15px;"></div>
					<div class="character-grid" id="character-grid" style="margin-top:10px;"></div>
				</div>
			</div>
            <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
                <button class="btn btn-primary start-btn" id="start-btn" disabled>
                    <i class="fas fa-play"></i> 开始新的生涯
                </button>
                <button class="btn btn-warning start-btn" onclick="openLoadModalFromStart()">
                    <i class="fas fa-folder-open"></i> 读取存档
                </button>
            </div>
						
			<!-- ==================== 游戏说明按钮区域 ==================== -->
			<div class="collapsible-section" id="guide-section" style="margin-top:20px;">
				<div class="collapsible-header" onclick="toggleStartSection('guide')">
					<h3 style="margin:0;font-size:0.95rem;color:var(--primary-color);display:flex;align-items:center;gap:6px;">
						<i class="fas fa-book"></i> 游戏说明与攻略
					</h3>
					<i class="fas fa-chevron-down collapse-toggle" id="guide-collapse-icon"></i>
				</div>
				<div class="collapsible-body" id="guide-body">
					<div style="padding:15px;background:var(--light-bg);border-radius:0 0 10px 10px;">
						<div style="display:grid;grid-template-columns:repeat(4, 1fr);gap:8px;">
							<button class="btn btn-info" style="padding:10px 8px;font-size:0.8rem;" onclick="showGuide('basics')">
								<i class="fas fa-gamepad"></i><br>基础玩法与属性
							</button>
							<button class="btn btn-success" style="padding:10px 8px;font-size:0.8rem;" onclick="showGuide('paperScore')">
								<i class="fas fa-calculator"></i><br>论文分数计算
							</button>
							<button class="btn btn-warning" style="padding:10px 8px;font-size:0.8rem;" onclick="showGuide('review')">
								<i class="fas fa-user-edit"></i><br>审稿机制详解
							</button>
							<button class="btn btn-accent" style="padding:10px 8px;font-size:0.8rem;" onclick="showGuide('citation')">
								<i class="fas fa-chart-line"></i><br>引用增长公式
							</button>
							<button class="btn btn-primary" style="padding:10px 8px;font-size:0.8rem;" onclick="showGuide('events')">
								<i class="fas fa-dice"></i><br>事件系统
							</button>
							<button class="btn btn-danger" style="padding:10px 8px;font-size:0.8rem;" onclick="showGuide('buffs')">
								<i class="fas fa-magic"></i><br>Buff与Debuff
							</button>
							<button class="btn btn-info" style="padding:10px 8px;font-size:0.8rem;" onclick="showGuide('characters')">
								<i class="fas fa-users"></i><br>角色与觉醒系统
							</button>
							<button class="btn btn-success" style="padding:10px 8px;font-size:0.8rem;" onclick="showGuide('strategy')">
								<i class="fas fa-chess"></i><br>进阶策略攻略
							</button>
						</div>
						<div style="margin-top:10px;text-align:center;font-size:0.75rem;color:var(--text-secondary);">
							<i class="fas fa-info-circle"></i> 点击按钮查看详细的游戏机制说明和公式
						</div>
					</div>
				</div>
			</div>
			<!-- ==================== 游戏说明按钮区域结束 ==================== -->
			
			
			<!-- 全球统计面板（可折叠）-->
			<div class="collapsible-section" id="stats-section" style="margin-top:20px;display:none;">
				<div class="collapsible-header" onclick="toggleStartSection('stats')">
					<h3 style="margin:0;font-size:0.95rem;color:var(--primary-color);display:flex;align-items:center;gap:6px;">
						<i class="fas fa-chart-pie"></i> 全球统计（最近10000局）
					</h3>
					<i class="fas fa-chevron-down collapse-toggle" id="stats-collapse-icon"></i>
				</div>
				<div class="collapsible-body" id="stats-body">
					<div id="global-stats-content" style="padding:15px;background:var(--light-bg);border-radius:0 0 10px 10px;">
						<div id="stats-loading" style="text-align:center;color:var(--text-secondary);font-size:0.85rem;">
							<i class="fas fa-spinner fa-spin"></i> 加载中...
						</div>
						<div id="stats-content" style="display:none;">
							<!-- 正位统计 -->
							<div id="normal-stats-section" class="stats-section">
								<div id="normal-ending-stats" style="margin-bottom:10px;"></div>
								<div id="normal-achievement-stats"></div>
							</div>
							
							<!-- 逆位统计 -->
							<div id="reversed-stats-section" class="stats-section" style="display:none;">
								<div id="reversed-ending-stats" style="margin-bottom:10px;"></div>
								<div id="reversed-achievement-stats"></div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- 留言板（可折叠）-->
			<div class="collapsible-section" id="message-section" style="margin-top:20px;">
				<div class="collapsible-header" onclick="toggleStartSection('message')">
					<h3 style="margin:0;font-size:0.95rem;color:var(--primary-color);display:flex;align-items:center;gap:6px;">
						<i class="fas fa-comments"></i> 留言板
					</h3>
					<i class="fas fa-chevron-down collapse-toggle" id="message-collapse-icon"></i>
				</div>
				<div class="collapsible-body" id="message-body">
					<div id="message-board" style="padding:15px;background:var(--light-bg);border-radius:0 0 10px 10px;">
						<!-- 发表留言区 -->
						<div class="message-input-area">
							<div style="display:flex;gap:10px;margin-bottom:10px;">
								<input type="text" id="msg-nickname" placeholder="昵称（必填）" maxlength="20" 
									   style="flex:1;padding:8px 12px;border:1px solid var(--border-color);border-radius:8px;font-size:0.85rem;font-family:inherit;background:var(--card-bg);color:var(--text-primary);">
								<button class="btn btn-primary" onclick="postMessage()" style="padding:8px 16px;font-size:0.85rem;">
									<i class="fas fa-paper-plane"></i> 发送
								</button>
							</div>
							<textarea id="msg-content" placeholder="说点什么吧...（支持回复其他人的留言）" maxlength="500" rows="3"
									  style="width:100%;padding:10px 12px;border:1px solid var(--border-color);border-radius:8px;font-size:0.85rem;font-family:inherit;resize:vertical;background:var(--card-bg);color:var(--text-primary);"></textarea>
							<div id="reply-indicator" style="display:none;margin-top:8px;padding:8px 12px;background:rgba(108,92,231,0.1);border-radius:6px;font-size:0.8rem;">
								<span style="color:var(--primary-color);">回复 <strong id="reply-to-name"></strong>：</span>
								<span id="reply-preview" style="color:var(--text-secondary);"></span>
								<button onclick="cancelReply()" style="float:right;background:none;border:none;color:var(--danger-color);cursor:pointer;font-size:0.8rem;">
									<i class="fas fa-times"></i> 取消
								</button>
							</div>
						</div>
						
						<!-- 留言列表 -->
						<div id="message-list" style="margin-top:15px;">
							<div style="text-align:center;color:var(--text-secondary);font-size:0.85rem;padding:20px;">
								<i class="fas fa-spinner fa-spin"></i> 加载留言中...
							</div>
						</div>
						
						<!-- 分页控制 -->
						<div id="message-pagination" style="display:none;margin-top:15px;text-align:center;">
							<button class="btn btn-info" id="prev-page-btn" onclick="changeMessagePage(-1)" style="padding:6px 12px;font-size:0.8rem;" disabled>
								<i class="fas fa-chevron-left"></i> 上一页
							</button>
							<span id="page-info" style="margin:0 15px;font-size:0.85rem;color:var(--text-secondary);">第 1 页</span>
							<button class="btn btn-info" id="next-page-btn" onclick="changeMessagePage(1)" style="padding:6px 12px;font-size:0.8rem;">
								下一页 <i class="fas fa-chevron-right"></i>
							</button>
						</div>
					</div>
				</div>
			</div>
        </div>
    </div>




	<!-- 游戏主界面 -->
	<div id="game-screen">
		<div class="game-container">
			<!-- 左侧栏 -->
			<div class="left-column">
				<!-- 毕业信息栏 -->
				<div class="panel" id="graduation-panel">
					<div class="panel-title collapsible" onclick="toggleCollapse('graduation-panel')">
						<i class="fas fa-graduation-cap"></i> 毕业信息
						<div style="margin-left:auto;display:flex;gap:5px;align-items:center;">
							<button class="btn btn-info" style="padding:3px 8px;font-size:0.7rem;" onclick="event.stopPropagation();openSaveModal()"><i class="fas fa-save"></i> 存档</button>
							<button class="btn btn-warning" style="padding:3px 8px;font-size:0.7rem;" onclick="event.stopPropagation();openLoadModal()"><i class="fas fa-folder-open"></i> 读档</button>
							<i class="fas fa-chevron-down collapse-icon" id="graduation-panel-collapse-icon"></i>
						</div>
					</div>
					<div class="collapsible-content" id="graduation-panel-content">
						<div class="graduation-info-compact">
							<div class="date-time">
								<span class="date-badge">第<span id="current-year">1</span>年第<span id="current-month">1</span>月</span>
								<span class="remaining-badge"><i class="fas fa-hourglass-half"></i> 剩余<span id="remaining-time">36</span>月</span>
							</div>
							<span class="target-badge" id="graduation-target">🎯 硕士：科研分≥1</span>
							<button class="btn btn-danger" style="padding:3px 10px;font-size:0.7rem;" onclick="confirmRestart()"><i class="fas fa-redo"></i> 重开</button>
						</div>
					</div>
				</div>

				<!-- 属性栏 -->
				<div class="panel" id="attributes-panel">
					<div class="panel-title collapsible" onclick="toggleCollapse('attributes-panel')">
						<i class="fas fa-chart-bar"></i> 个人属性
						<i class="fas fa-chevron-down collapse-icon" id="attributes-panel-collapse-icon"></i>
					</div>
					<div class="collapsible-content" id="attributes-panel-content">
						<div class="character-display" id="character-display" onclick="event.stopPropagation();showCharacterDetail()" style="cursor:pointer;">
							<span class="char-icon" id="char-icon">👤</span>
							<span class="char-name" id="char-name">-</span>
							<span class="char-mode" id="char-mode"></span>
							<i class="fas fa-info-circle" style="margin-left:auto;color:var(--text-secondary);font-size:0.75rem;"></i>
						</div>
						
						<div class="attribute-bar">
							<div class="attribute-label">
								<span class="name" title="精神状态，降为负数则不堪重负"><i class="fas fa-brain"></i> SAN值</span>
								<span class="value"><span id="san-value">20</span>/<span id="san-max">20</span></span>
							</div>
							<div class="progress-bar"><div class="progress-fill san" id="san-bar"></div></div>
						</div>
						<div class="attribute-bar">
							<div class="attribute-label">
								<span class="name" title="影响论文分数生成，达到6/12/18解锁新论文槽"><i class="fas fa-flask"></i> 科研能力</span>
								<span class="value"><span id="research-value">1</span>/<span id="research-max">20</span></span>
							</div>
							<div class="progress-bar"><div class="progress-fill research" id="research-bar"></div></div>
						</div>
						<div class="attribute-bar">
							<div class="attribute-label">
								<span class="name" title="影响事件选项和结果，达到6/12解锁更多选项"><i class="fas fa-users"></i> 社交能力</span>
								<span class="value"><span id="social-value">1</span>/20</span>
							</div>
							<div class="progress-bar"><div class="progress-fill social" id="social-bar"></div></div>
						</div>
						<div class="attribute-bar">
							<div class="attribute-label">
								<span class="name" title="影响事件选项和结果，降为负数则被退学"><i class="fas fa-heart"></i> 导师好感度</span>
								<span class="value"><span id="favor-value">1</span>/20</span>
							</div>
							<div class="progress-bar"><div class="progress-fill favor" id="favor-bar"></div></div>
						</div>
						<div class="gold-display">
							<div class="gold-info"><i class="fas fa-coins"></i><span><span id="gold-value">1</span> 金币</span></div>
							<div style="display:flex;gap:5px;">
								<button class="btn btn-warning" style="padding:5px 10px;font-size:0.75rem;" onclick="openShop()"><i class="fas fa-store"></i> 商店</button>
								<button class="btn" style="padding:5px 10px;font-size:0.75rem;background:linear-gradient(135deg,#f39c12,#e67e22);color:white;" onclick="openAchievementShop()"><i class="fas fa-trophy"></i> <span id="achievement-coins-display">0</span></button>
							</div>
						</div>
					</div>
				</div>

				<!-- 科研成果栏 -->
				<div class="panel" id="research-panel">
					<div class="panel-title collapsible" onclick="toggleCollapse('research-panel')">
						<i class="fas fa-award"></i> 科研成果
						<i class="fas fa-chevron-down collapse-icon" id="research-panel-collapse-icon"></i>
					</div>
					<div class="collapsible-content" id="research-panel-content">
						<div class="research-summary">
							<div class="research-stat"><div class="label">A类</div><div class="value" id="paper-a-count">0</div></div>
							<div class="research-stat"><div class="label">B类</div><div class="value" id="paper-b-count">0</div></div>
							<div class="research-stat"><div class="label">C类</div><div class="value" id="paper-c-count">0</div></div>
							<div class="research-stat"><div class="label">科研分</div><div class="value" id="total-score">0</div></div>
							<div class="research-stat"><div class="label">总引用</div><div class="value" id="total-citations">0</div></div>
							<div class="research-stat"><div class="label">论文数</div><div class="value" id="paper-total-count">0</div></div>
						</div>
						<div style="font-size:0.65rem;color:var(--text-secondary);margin-bottom:6px;text-align:center;">A类=4分 B类=2分 C类=1分</div>
						<div class="paper-list" id="published-papers">
							<p style="color:var(--text-secondary);font-size:0.75rem;text-align:center;">暂无已发表论文</p>
						</div>
					</div>
				</div>
			</div>

			<!-- 中间栏 -->
			<div class="middle-column">
				<!-- 游戏日志栏 -->
				<div class="panel" id="log-panel" style="flex:1;">
					<div class="panel-title collapsible" onclick="toggleCollapse('log-panel')">
						<i class="fas fa-scroll"></i> 游戏日志
						<span id="event-preview" style="margin-left:8px;font-size:0.7rem;font-weight:400;color:var(--text-secondary);"></span>
						<i class="fas fa-chevron-down collapse-icon" id="log-panel-collapse-icon" style="margin-left:auto;"></i>
					</div>
					<div class="collapsible-content" id="log-panel-content">
						<div class="log-content" id="log-content"></div>
					</div>
				</div>

				<!-- 增益/减益效果栏 -->
				<div class="panel" id="buff-panel">
					<div class="panel-title collapsible" onclick="toggleCollapse('buff-panel')">
						<i class="fas fa-magic"></i> 增益/减益效果
						<i class="fas fa-chevron-down collapse-icon" id="buff-panel-collapse-icon"></i>
					</div>
					<div class="collapsible-content" id="buff-panel-content">
						<div class="buff-list" id="buff-list"><span style="color:var(--text-secondary);font-size:0.8rem;">暂无效果</span></div>
					</div>
				</div>

				<!-- 操作栏 -->
				<div class="panel" id="action-panel">
					<div class="panel-title collapsible" onclick="toggleCollapse('action-panel')">
						<i class="fas fa-gamepad"></i> 操作
						<i class="fas fa-chevron-down collapse-icon" id="action-panel-collapse-icon"></i>
					</div>
					<div class="collapsible-content" id="action-panel-content">
						<div class="action-grid">
							<button class="btn btn-info action-btn" id="btn-read" onclick="readPaper()"><i class="fas fa-book-open"></i><span>看论文</span></button>
							<button class="btn btn-warning action-btn" id="btn-work" onclick="partTimeJob()"><i class="fas fa-briefcase"></i><span>打工</span></button>
							<button class="btn btn-accent action-btn" id="btn-idea" onclick="thinkIdea()"><i class="fas fa-lightbulb"></i><span>想idea</span></button>
							<button class="btn btn-primary action-btn" id="btn-experiment" onclick="doExperiment()"><i class="fas fa-vial"></i><span>做实验</span></button>
							<button class="btn btn-success action-btn" id="btn-write" onclick="writePaper()"><i class="fas fa-pen-fancy"></i><span>写论文</span></button>
							<button class="btn btn-danger action-btn" id="btn-next" onclick="nextMonth()"><i class="fas fa-forward"></i><span>下一月</span></button>
						</div>
					</div>
				</div>
			</div>

			<!-- 右侧栏 -->
			<div class="right-column">
				<div class="panel" id="workstation-panel">
					<div class="panel-title collapsible" onclick="toggleCollapse('workstation-panel')">
						<i class="fas fa-file-alt"></i> 论文工作站
						<div style="margin-left:auto;display:flex;gap:5px;align-items:center;">
							<button class="btn btn-info" style="padding:3px 8px;font-size:0.7rem;" onclick="event.stopPropagation();showAllConferencesInfo()">
								<i class="fas fa-calendar-alt"></i> 会议一览
							</button>
							<i class="fas fa-chevron-down collapse-icon" id="workstation-panel-collapse-icon"></i>
						</div>
					</div>
					<div class="collapsible-content" id="workstation-panel-content">
						<div class="paper-slots" id="paper-slots"></div>
					</div>
				</div>
			</div>
		</div>
	</div>

    <!-- 弹窗 -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal" id="modal">
            <h3 class="modal-title" id="modal-title">标题</h3>
            <div class="modal-content" id="modal-content">内容</div>
            <div class="modal-buttons" id="modal-buttons"></div>
        </div>
    </div>

    <!-- 移动端底部快捷栏 -->
    <div class="mobile-quick-bar" id="mobile-quick-bar">
        <button class="quick-btn" onclick="scrollToPanel('action-panel')">
            <i class="fas fa-gamepad"></i>
            <span>操作</span>
        </button>
        <button class="quick-btn" onclick="scrollToPanel('workstation-panel')">
            <i class="fas fa-file-alt"></i>
            <span>论文</span>
        </button>
        <button class="quick-btn" onclick="scrollToPanel('attributes-panel')">
            <i class="fas fa-chart-bar"></i>
            <span>属性</span>
        </button>
        <button class="quick-btn" onclick="openShop()">
            <i class="fas fa-store"></i>
            <span>商店</span>
        </button>
		<button class="quick-btn" onclick="openAchievementShop()" style="background:linear-gradient(135deg,#f39c12,#e67e22);color:white;">
			<i class="fas fa-trophy" style="color:white;"></i>
			<span>成就</span>
		</button>
        <button class="quick-btn next-month-btn" onclick="nextMonth()">
            <i class="fas fa-forward"></i>
            <span>下月</span>
        </button>
    </div>
	<!-- 快速折叠/展开按钮（移动端） -->
	<button class="collapse-all-btn" id="collapse-all-btn" onclick="toggleAllPanels()">
		<i class="fas fa-compress-alt" id="collapse-all-btn-icon"></i>
		<span id="collapse-all-btn-text">收起全部</span>
	</button>
    <script>

		// ==================== 面板折叠功能（完整版）====================

		// 折叠状态存储
		const collapseStates = {};

		// 初始化折叠状态（从localStorage读取）
		function initCollapseStates() {
			const saved = localStorage.getItem('graduateSimulator_collapseStates');
			if (saved) {
				try {
					Object.assign(collapseStates, JSON.parse(saved));
				} catch (e) {
					console.warn('读取折叠状态失败:', e);
				}
			}
		}

		// 保存折叠状态
		function saveCollapseStates() {
			localStorage.setItem('graduateSimulator_collapseStates', JSON.stringify(collapseStates));
		}

		// 切换折叠状态
		function toggleCollapse(panelId) {
			const content = document.getElementById(`${panelId}-content`);
			const icon = document.getElementById(`${panelId}-collapse-icon`);
			const panel = document.getElementById(panelId);
			
			if (!content) {
				console.warn(`找不到面板内容: ${panelId}-content`);
				return;
			}
			
			const isCollapsed = content.classList.toggle('collapsed');
			collapseStates[panelId] = isCollapsed;
			
			// 更新图标
			if (icon) {
				icon.classList.toggle('rotated', isCollapsed);
			}
			
			// 更新面板样式
			if (panel) {
				panel.classList.toggle('panel-collapsed', isCollapsed);
			}
			
			saveCollapseStates();
		}

		// 应用保存的折叠状态
		function applyCollapseStates() {
			for (const [panelId, isCollapsed] of Object.entries(collapseStates)) {
				const content = document.getElementById(`${panelId}-content`);
				const icon = document.getElementById(`${panelId}-collapse-icon`);
				const panel = document.getElementById(panelId);
				
				if (content && isCollapsed) {
					content.classList.add('collapsed');
					if (icon) {
						icon.classList.add('rotated');
					}
					if (panel) {
						panel.classList.add('panel-collapsed');
					}
				}
			}
		}

		// 展开所有面板
		function expandAllPanels() {
			const panelIds = ['graduation-panel', 'attributes-panel', 'research-panel', 
							  'log-panel', 'buff-panel', 'action-panel', 'workstation-panel'];
			
			panelIds.forEach(panelId => {
				const content = document.getElementById(`${panelId}-content`);
				const icon = document.getElementById(`${panelId}-collapse-icon`);
				const panel = document.getElementById(panelId);
				
				if (content) {
					content.classList.remove('collapsed');
					collapseStates[panelId] = false;
				}
				if (icon) {
					icon.classList.remove('rotated');
				}
				if (panel) {
					panel.classList.remove('panel-collapsed');
				}
			});
			
			saveCollapseStates();
		}

		// 收起所有面板
		function collapseAllPanels() {
			const panelIds = ['graduation-panel', 'attributes-panel', 'research-panel', 
							  'log-panel', 'buff-panel', 'action-panel', 'workstation-panel'];
			
			panelIds.forEach(panelId => {
				const content = document.getElementById(`${panelId}-content`);
				const icon = document.getElementById(`${panelId}-collapse-icon`);
				const panel = document.getElementById(panelId);
				
				if (content) {
					content.classList.add('collapsed');
					collapseStates[panelId] = true;
				}
				if (icon) {
					icon.classList.add('rotated');
				}
				if (panel) {
					panel.classList.add('panel-collapsed');
				}
			});
			
			saveCollapseStates();
		}

		// 切换全部展开/收起
		let allCollapsed = false;
		function toggleAllPanels() {
			if (allCollapsed) {
				expandAllPanels();
				allCollapsed = false;
				document.getElementById('collapse-all-btn-text').textContent = '收起全部';
				document.getElementById('collapse-all-btn-icon').className = 'fas fa-compress-alt';
			} else {
				collapseAllPanels();
				allCollapsed = true;
				document.getElementById('collapse-all-btn-text').textContent = '展开全部';
				document.getElementById('collapse-all-btn-icon').className = 'fas fa-expand-alt';
			}
		}

		// ==================== 开始页面折叠功能 ====================

		// 开始页面区块折叠状态
		const startSectionStates = {};

		function initStartSectionStates() {
			const saved = localStorage.getItem('graduateSimulator_startSections');
			if (saved) {
				try {
					Object.assign(startSectionStates, JSON.parse(saved));
				} catch (e) {
					console.warn('读取开始页面折叠状态失败:', e);
				}
			}
		}

		function saveStartSectionStates() {
			localStorage.setItem('graduateSimulator_startSections', JSON.stringify(startSectionStates));
		}

		function toggleStartSection(sectionId) {
			const body = document.getElementById(`${sectionId}-body`);
			const icon = document.getElementById(`${sectionId}-collapse-icon`);
			const header = body?.previousElementSibling;
			
			if (!body) {
				console.warn(`找不到区块: ${sectionId}-body`);
				return;
			}
			
			const isCollapsed = body.classList.toggle('collapsed');
			startSectionStates[sectionId] = isCollapsed;
			
			if (header) {
				header.classList.toggle('collapsed', isCollapsed);
			}
			
			if (icon) {
				icon.style.transform = isCollapsed ? 'rotate(-90deg)' : 'rotate(0deg)';
			}
			
			saveStartSectionStates();
		}

		function applyStartSectionStates() {
			for (const [sectionId, isCollapsed] of Object.entries(startSectionStates)) {
				const body = document.getElementById(`${sectionId}-body`);
				const icon = document.getElementById(`${sectionId}-collapse-icon`);
				const header = body?.previousElementSibling;
				
				if (body && isCollapsed) {
					body.classList.add('collapsed');
					if (header) header.classList.add('collapsed');
					if (icon) icon.style.transform = 'rotate(-90deg)';
				}
			}
		}
	
        // ==================== 游戏数据 ====================
		 const characters = [
		{ 
			id: 'normal', 
			name: '大多数', 
			icon: '👤', 
			awakenIcon: '🔥',
			desc: '芸芸众生中的普通一员', 
			bonus: '无特殊能力', 
			awakenName: '我命由我不由天',
			awakenDesc: '转博时所有属性×2', 
			// 隐藏觉醒
			hiddenAwakenName: '勤能补拙',
			hiddenAwakenIcon: '💪',
			hiddenAwakenDesc: '每个月行动次数+1（看论文、写论文、想idea、打工、做实验可以做2次）',
			hiddenAwakenCondition: (gs) => gs.research <= 3 && gs.favor <= 3 && gs.social <= 3,
			stats: { research: 0, social: 0, favor: 0, gold: 0 },
			reversed: {
				name: '怠惰之《大多数》',
				icon: '😴',
				awakenIcon: '💀',
				desc: '懒惰是原罪，也是护盾',
				bonus: 'SAN减少翻倍，初始属性全5，每月SAN+3',
				awakenName: '极致怠惰',
				awakenDesc: '转博时属性翻倍。SAN减少3倍，每月SAN+4',
				stats: { research: 4, social: 4, favor: 4, gold: 4 }
			}
		},
		{ 
			id: 'genius', 
			name: '院士转世', 
			icon: '🔬', 
			awakenIcon: '🧬',
			desc: '天生就是做科研的料', 
			bonus: '科研能力初始+5', 
			awakenName: '学术天赋觉醒',
			awakenDesc: '转博时每有1篇A类论文，科研+2，上限+2',
			// 隐藏觉醒
			hiddenAwakenName: '预见未来热点',
			hiddenAwakenIcon: '🔮',
			hiddenAwakenDesc: '论文的idea和实验分数每月不再衰减',
			hiddenAwakenCondition: (gs) => gs.paperA === 0 && gs.paperB === 0,
			stats: { research: 5 },
			reversed: {
				name: '愚钝之《院士转世》',
				icon: '🤡',
				awakenIcon: '🎭',
				desc: '科研是什么？能吃吗？',
				bonus: '科研固定0，全论文槽，科研提升→金+4,SAN+4,社交+1,好感+1',
				awakenName: '大智若愚',
				awakenDesc: '科研提升→金+8,SAN+8,社交+2,好感+2',
				stats: {}
			}
		},
		{ 
			id: 'social', 
			name: '社交达人', 
			icon: '🤝', 
			awakenIcon: '🌐',
			desc: '八面玲珑的社交高手', 
			bonus: '社交能力初始+5', 
			awakenName: '人脉网络激活',
			awakenDesc: '转博时根据社交能力改变审稿人分布',
			// 隐藏觉醒
			hiddenAwakenName: '师兄师姐救我',
			hiddenAwakenIcon: '🆘',
			hiddenAwakenDesc: '获得主动技能（限用1次）：下次想idea时，科研能力视为科研+社交',
			hiddenAwakenCondition: (gs) => gs.social <= 6,
			stats: { social: 5 },
			reversed: {
				name: '嫉妒之《社交达人》',
				icon: '🐍',
				awakenIcon: '👁️',
				desc: '见不得别人好，也见不得自己差',
				bonus: '社交初始5，社交-1→科研+1,好感+1 | 社交+1→SAN+1,金+1',
				awakenName: '嫉妒重置',
				awakenDesc: '转博时社交能力变为5',
				stats: { social: 4 }
			}
		},
		{ 
			id: 'rich', 
			name: '富可敌国', 
			icon: '💰', 
			awakenIcon: '💎',
			desc: '家境殷实无忧无虑', 
			bonus: '金币值初始+5', 
			awakenName: '财富倍增术',
			awakenDesc: '转博时金币×3',
			// 隐藏觉醒
			hiddenAwakenName: '不求暴富但求稳定',
			hiddenAwakenIcon: '🏦',
			hiddenAwakenDesc: '每月工资+1',
			hiddenAwakenCondition: (gs) => gs.gold <= 2,
			stats: { gold: 5 },
			reversed: {
				name: '贪求之《富可敌国》',
				icon: '🏴‍☠️',
				awakenIcon: '💸',
				desc: '除了钱一无所有',
				bonus: '每月SAN/科研/社交/好感重置为1，每月金钱+3',
				awakenName: '金钱的力量',
				awakenDesc: '半年重置一次，每花费4金币属性各+1，每月金钱+3',
				stats: {}
			}
		},
		{ 
			id: 'teacher-child', 
			name: '导师子女', 
			icon: '👨‍👧', 
			awakenIcon: '👑',
			desc: '近水楼台先得月', 
			bonus: '导师好感度初始+5', 
			awakenName: '血脉共鸣',
			awakenDesc: '转博时好感度超12的部分转化为科研和金币',
			// 隐藏觉醒
			hiddenAwakenName: '导师救我',
			hiddenAwakenIcon: '🛡️',
			hiddenAwakenDesc: '获得主动技能（限用1次）：下次想idea时，科研能力视为科研+好感度',
			hiddenAwakenCondition: (gs) => gs.favor <= 6,
			stats: { favor: 5 },
			reversed: {
				name: '玩世之《导师子女》',
				icon: '🎪',
				awakenIcon: '🃏',
				desc: '叛逆是我的代名词',
				bonus: '好感不会低于0，好感归0→重置为4，社交+1，科研+1，金+2',
				awakenName: '变本加厉',
				awakenDesc: '好感归0→重置为2，社交+1，科研+1，金+2',
				stats: { favor: 0 }
			}
		},
		{ 
			id: 'chosen', 
			name: '天选之人', 
			icon: '⭐', 
			awakenIcon: '✨',
			desc: '命运的宠儿全面发展', 
			bonus: '科研+2 社交+2 好感+2 金币+2', 
			awakenName: '查缺补漏',
			awakenDesc: '转博时补齐所有短板',
			// 隐藏觉醒
			hiddenAwakenName: '孤注一掷',
			hiddenAwakenIcon: '🎯',
			hiddenAwakenDesc: '选择一项属性，其他两项变为1并将值转化到该属性',
			hiddenAwakenCondition: (gs) => gs.research === gs.social && gs.social === gs.favor,
			stats: { research: 2, social: 2, favor: 2, gold: 2 },
			reversed: {
				name: '空想之《天选之人》',
				icon: '🌀',
				awakenIcon: '🎲',
				desc: '命运是一场轮盘赌',
				bonus: '每月:科研/社交/好感随机交换，SAN/金随机交换，可突破属性上限',
				awakenName: '命运轮盘',
				awakenDesc: '每月:科研/社交/好感/SAN/金全部随机交换，可突破属性上限',
				stats: {}
			}
		}
	];

        const paperTitleWords = {
            adjectives: ['Deep', 'Neural', 'Efficient', 'Scalable', 'Robust', 'Adaptive', 'Dynamic', 'Multi-modal', 'Self-supervised', 'Federated', 'Attention-based', 'Graph-based', 'Hierarchical', 'Contrastive', 'Progressive', 'Unified'],
            nouns: ['Learning', 'Networks', 'Transformers', 'Models', 'Representations', 'Framework', 'Architecture', 'Approach', 'Method', 'System', 'Embeddings', 'Reasoning', 'Generation', 'Recognition'],
            verbs: ['Understanding', 'Generating', 'Predicting', 'Detecting', 'Recognizing', 'Synthesizing', 'Optimizing', 'Training', 'Enhancing', 'Improving'],
            domains: ['Vision', 'Language', 'Speech', 'Text', 'Images', 'Videos', 'Knowledge', 'Data', 'Graphs', 'Medical', '3D', 'Autonomous']
        };

        const ALL_BUFF_TYPES = [
            'monthly_san', 'exp_times', 'write_san_reduce', 'read_san_reduce',
            'idea_bonus', 'exp_bonus', 'write_bonus', 'idea_times', 'write_times', 'citation_multiply'
        ];

		const ALL_ACHIEVEMENTS = [
			'💕 喜结良缘', '💰 家财万贯', '⬡ 六边形战士', '🏆 诺奖选手', 
			'🌸 交际花', '🤝 铁杆师生', '⚡ 精力满满', '🎯 百发百中', 
			'☕ 我爱茶歇', '🏖️ 公费旅游', '🤖 论文机器',
			'📚 千引大佬', '☕ 咖啡爱好者', '✨ Buff之神',
			'📜 高分论文', '🍀 幸运儿', '😭 倒霉蛋',
			'🎻 曲高和寡', '💪 全力以赴', '🏆 全收集',
			'👊 越战越勇', '🧠 人间清醒', '🔥 火力全开',
			'🍚 食之无味', '🤖 机械飞升', '🛋️ 全套家具',
			'🧒 天才少年',
			'💎 无法埋没', '🔔 不鸣则已', '📊 严重偏科', '💼 打工狂人', '📖 爱看论文', '🏹 一箭双雕',
		];

        // 结局名称映射
		const ENDING_NAMES = {
			'quit': '🚪 主动退学',
			'burnout': '😢 不堪重负',
			'expelled': '😭 逐出师门',
			'poor': '💸 穷困潦倒',
			'delay': '⏰ 延毕',
			'isolated': '😔 被孤立', 
			'master': '🎓 硕士毕业',
			'excellent_master': '🌟 优秀硕士',
			'phd': '🎓 博士毕业',
			'excellent_phd': '🏆 优秀博士',
			'green_pepper': '🌶️ 青椒',
			'become_advisor': '👨‍🏫 我就是导师',
			'academic_star': '⭐ 学术之星',
			'future_academician': '👑 未来院士',
			// 真实结局
			'true_phd': '🌟 真·博士毕业',  
			'true_devotion': '💫 真·投身学术', 
			'true_life': '🌈 真·感受生活',
		};

        // 困难结局（博士毕业及以上）
		const HARD_ENDINGS = ['phd', 'excellent_phd', 'green_pepper', 'become_advisor', 'academic_star', 'future_academician', 'true_phd', 'true_devotion', 'true_life'];

        // 结局达成要求数据
		const ENDING_REQUIREMENTS = {
			// ... 保留原有内容 ...
			'quit': '主动选择重开并确认退学',
			'burnout': 'SAN值降为负数',
			'expelled': '导师好感度降为负数',
			'poor': '金币降为负数',
			'delay': '毕业时间到但科研分不足（硕士<1或博士<7）',
			'isolated': '社交能力降为负数',
			'master': '硕士3年内科研分≥1',
			'excellent_master': '硕士3年内科研分≥4',
			'phd': '博士5年内科研分≥7',
			'excellent_phd': '博士毕业且A类论文≥3',
			'green_pepper': '博士毕业且A类≥4、引用>500',
			'become_advisor': '博士毕业且A类≥5、引用>1000',
			'academic_star': '博士毕业且A类≥5、引用>1000、大牛联合培养',
			'future_academician': '博士毕业且A类≥5、引用>2000、大牛联合培养',
			// 真实结局
			'true_phd': '使用真·大多数角色，博士毕业且发表≥3篇论文',
			'true_devotion': '使用真·大多数角色，博士毕业且总引用≥1000',
			'true_life': '使用真·大多数角色，顺利毕业（硕士或博士）且达成≥10个成就且总引用<1000'
		};

        // 成就达成要求数据
		const ACHIEVEMENT_REQUIREMENTS = {
			'💕 喜结良缘': '顺利毕业且与异性学者发展为恋人关系（社交≥12后在开会时多次交流同一人）',
			'💰 家财万贯': '顺利毕业且结局时金币≥30',
			'⬡ 六边形战士': '顺利毕业且结局时科研、社交、好感、金币均>15',
			'🏆 诺奖选手': '顺利毕业且科研能力达到20',
			'🌸 交际花': '顺利毕业且社交能力达到20',
			'🤝 铁杆师生': '顺利毕业且导师好感度达到20',
			'⚡ 精力满满': '顺利毕业且结局时SAN值≥20',
			'🎯 百发百中': '顺利毕业且论文从未被拒稿',
			'☕ 我爱茶歇': '顺利毕业且在开会事件中选择茶歇+晚宴≥3次',
			'🏖️ 公费旅游': '顺利毕业且在开会事件中选择顺便旅游≥3次',
			'🤖 论文机器': '顺利毕业且发表论文总数≥10',
			'📚 千引大佬': '顺利毕业且总引用数≥1000',
			'☕ 咖啡爱好者': '顺利毕业且每月都购买冰美式',
			'✨ Buff之神': '顺利毕业且触发过所有类型的Buff效果',
			'📜 高分论文': '顺利毕业且论文中稿后(可能的改进后)分数达到125',
			'🍀 幸运儿': '顺利毕业且论文收到三位大牛审稿人的一致改进',
			'😭 倒霉蛋': '顺利毕业且三个审稿人都是坏审稿人(恶意小同行或者39个问题审稿人)',
			'🎻 曲高和寡': '顺利毕业且只中过A类论文，没有B和C',
			'💪 全力以赴': '顺利毕业且毕业时SAN和金钱都为0',
			'🏆 全收集': '顺利毕业且毕业时中稿A,B,C的poster，oral，best paper共9类论文',
			'👊 越战越勇': '顺利毕业且毕业时至少被拒稿5次',
			'🧠 人间清醒': '顺利毕业且拥有两次转博机会都拒绝了',
			'🔥 火力全开': '顺利毕业且论文槽位同时有4篇论文在审',
			'🍚 食之无味': '顺利毕业且一篇论文被连续拒稿3次',
			'🤖 机械飞升': '顺利毕业且商店购买5台GPU服务器',
			'🛋️ 全套家具': '顺利毕业且购买工学椅+显示器+键盘',
			'🧒 天才少年': '顺利毕业且转博时就达到博士毕业要求',
			'💎 无法埋没': '顺利毕业且单篇C类论文引用超过100',
			'🔔 不鸣则已': '顺利毕业且第一篇论文引用超过200',
			'📊 严重偏科': '顺利毕业且毕业时科研能力、导师好感度、社交能力最高和最低的差距超过12',
			'💼 打工狂人': '顺利毕业且毕业时至少打工10次',
			'📖 爱看论文': '顺利毕业且毕业时至少看20次论文',
			'🏹 一箭双雕': '顺利毕业且曾在一个会议同时中稿≥2篇论文',
		};

        // 商店物品
		const shopItems = [
			{ id: 'coffee', name: '冰美式', desc: 'SAN值+3', price: 2, monthlyOnce: true, boughtThisMonth: false },
			{ id: 'gemini', name: 'Gemini订阅', desc: '本月想idea时SAN-1，分数+4', price: 2, monthlyOnce: true, boughtThisMonth: false },
			{ id: 'gpt', name: 'GPT订阅', desc: '本月做实验时SAN-1，分数+4', price: 4, monthlyOnce: true, boughtThisMonth: false },
			{ id: 'claude', name: 'Claude订阅', desc: '本月写论文时SAN-1，分数+4', price: 3, monthlyOnce: true, boughtThisMonth: false },
			{ id: 'gpu_rent', name: '租GPU服务器', desc: '本月做实验多做1次', price: 2, once: false },
			{ id: 'gpu_buy', name: '购买GPU服务器', desc: '永久buff-每次做实验多做1次', price: 12, once: false },
			{ id: 'chair', name: '人体工学椅', desc: '永久buff-每月SAN值+1', price: 10, once: true, bought: false },
			{ id: 'keyboard', name: '机械键盘', desc: '永久buff-写论文变为SAN-3', price: 8, once: true, bought: false },
			{ id: 'monitor', name: '4K显示器', desc: '永久buff-读论文变为SAN-1', price: 8, once: true, bought: false }
		];
		
		// ==================== 会议配置 ====================
		const CONFERENCES = {
			1: {  // 现实9月
				A: { name: 'ICLR', fullName: 'International Conference on Learning Representations', field: '深度学习' },
				B: { name: 'ICRA', fullName: 'International Conference on Robotics and Automation', field: '机器人' },
				C: { name: 'WACV', fullName: 'Winter Conference on Applications of Computer Vision', field: '计算机视觉' }
			},
			2: {  // 现实10月
				A: { name: 'WWW', fullName: 'The Web Conference', field: '万维网' },
				B: { name: 'NAACL', fullName: 'North American Chapter of ACL', field: '自然语言处理' },
				C: { name: 'MMAsia', fullName: 'ACM Multimedia Asia', field: '多媒体' }
			},
			3: {  // 现实11月
				A: { name: 'CVPR', fullName: 'Conference on Computer Vision and Pattern Recognition', field: '计算机视觉' },
				B: { name: 'CIKM', fullName: 'Conference on Information and Knowledge Management', field: '信息管理' },
				C: { name: 'ICDAR', fullName: 'International Conference on Document Analysis and Recognition', field: '文档分析' }
			},
			4: {  // 现实12月
				A: { name: 'ACL', fullName: 'Annual Meeting of the Association for Computational Linguistics', field: '自然语言处理' },
				B: { name: 'ICONIP', fullName: 'International Conference on Neural Information Processing', field: '神经网络' },
				C: { name: 'ICPR', fullName: 'International Conference on Pattern Recognition', field: '模式识别' }
			},
			5: {  // 现实1月
				A: { name: 'IJCAI', fullName: 'International Joint Conference on Artificial Intelligence', field: '人工智能' },
				B: { name: 'ICME', fullName: 'IEEE International Conference on Multimedia and Expo', field: '多媒体' },
				C: { name: 'ICIP', fullName: 'IEEE International Conference on Image Processing', field: '图像处理' }
			},
			6: {  // 现实2月
				A: { name: 'ICML', fullName: 'International Conference on Machine Learning', field: '机器学习' },
				B: { name: 'COLT', fullName: 'Conference on Learning Theory', field: '学习理论' },
				C: { name: 'IJCNN', fullName: 'International Joint Conference on Neural Networks', field: '神经网络' }
			},
			7: {  // 现实3月
				A: { 
					name: 'ICCV/ECCV',
					alternates: {
						odd: { name: 'ICCV', fullName: 'International Conference on Computer Vision' },
						even: { name: 'ECCV', fullName: 'European Conference on Computer Vision' }
					},
					field: '计算机视觉'
				},
				B: { name: 'ISCA', fullName: 'Annual Conference of ISCA', field: '语音' },
				C: { name: 'IROS', fullName: 'IEEE/RSJ International Conference on Intelligent Robots and Systems', field: '机器人' }
			},
			8: {  // 现实4月
				A: { name: 'ACM MM', fullName: 'ACM International Conference on Multimedia', field: '多媒体' },
				B: { name: 'EACL', fullName: 'European Chapter of ACL', field: '自然语言处理' },
				C: { name: 'IJCB', fullName: 'International Joint Conference on Biometrics', field: '生物识别' }
			},
			9: {  // 现实5月
				A: { name: 'NeurIPS', fullName: 'Conference on Neural Information Processing Systems', field: '机器学习' },
				B: { name: 'ECAI', fullName: 'European Conference on Artificial Intelligence', field: '人工智能' },
				C: { name: 'BMVC', fullName: 'British Machine Vision Conference', field: '计算机视觉' }
			},
			10: {  // 现实6月
				A: { name: 'EMNLP', fullName: 'Conference on Empirical Methods in Natural Language Processing', field: '自然语言处理' },
				B: { name: 'CoNLL', fullName: 'Conference on Computational Natural Language Learning', field: '自然语言' },
				C: { name: 'PRCV', fullName: 'Chinese Conference on Pattern Recognition and Computer Vision', field: '模式识别' }
			},
			11: {  // 现实7月
				A: { name: 'COLING', fullName: 'International Conference on Computational Linguistics', field: '计算语言学' },
				B: { name: 'RSS', fullName: 'Robotics: Science and Systems', field: '机器人' },
				C: { name: 'ACCV', fullName: 'Asian Conference on Computer Vision', field: '计算机视觉' }
			},
			12: {  // 现实8月
				A: { name: 'AAAI', fullName: 'AAAI Conference on Artificial Intelligence', field: '人工智能' },
				B: { name: 'ICMR', fullName: 'ACM International Conference on Multimedia Retrieval', field: '多媒体检索' },
				C: { name: '3DV', fullName: 'International Conference on 3D Vision', field: '三维视觉' }
			}
		};

        const CONFERENCE_LOCATIONS = [
            // 北美
            { city: 'San Francisco', country: 'USA' },
            { city: 'Seattle', country: 'USA' },
            { city: 'New Orleans', country: 'USA' },
            { city: 'Vancouver', country: 'Canada' },
            { city: 'Montreal', country: 'Canada' },
            { city: 'New York', country: 'USA' },
            { city: 'Miami', country: 'USA' },
            { city: 'Honolulu', country: 'USA' },
            { city: 'San Diego', country: 'USA' },
            { city: 'Boston', country: 'USA' },
            { city: 'Los Angeles', country: 'USA' },
            { city: 'Toronto', country: 'Canada' },
            // 欧洲
            { city: 'Barcelona', country: 'Spain' },
            { city: 'Vienna', country: 'Austria' },
            { city: 'Amsterdam', country: 'Netherlands' },
            { city: 'Paris', country: 'France' },
            { city: 'Munich', country: 'Germany' },
            { city: 'London', country: 'UK' },
            { city: 'Florence', country: 'Italy' },
            { city: 'Dublin', country: 'Ireland' },
            { city: 'Stockholm', country: 'Sweden' },
            { city: 'Zurich', country: 'Switzerland' },
            { city: 'Edinburgh', country: 'UK' },
            { city: 'Milan', country: 'Italy' },
            // 亚太
            { city: 'Singapore', country: 'Singapore' },
            { city: 'Tokyo', country: 'Japan' },
            { city: 'Seoul', country: 'South Korea' },
            { city: 'Hong Kong', country: 'China' },
            { city: 'Beijing', country: 'China' },
            { city: 'Shanghai', country: 'China' },
            { city: 'Sydney', country: 'Australia' },
            { city: 'Melbourne', country: 'Australia' },
            { city: 'Taipei', country: 'Taiwan' },
            { city: 'Bangkok', country: 'Thailand' },
            { city: 'Kyoto', country: 'Japan' },
            { city: 'Shenzhen', country: 'China' }
        ];
	
		
        // ==================== 游戏状态 ====================
        let gameState = {};
        let selectedCharacter = null;
        let isReversedMode = false;
        let characterDifficultyData = {};
        let currentEndingData = null;
		
		let isTrueNormalMode = false;  // 是否选择了真·大多数模式

		function getInitialState() {
			return {
				character: null,
				characterName: '',
				degree: 'master',
				year: 1,
				month: 1,
				totalMonths: 0,
				maxYears: 3,
				san: 20,
				sanMax: 20,
				research: 1,
				social: 1,
				favor: 1,
				gold: 1,
				paperA: 0,
				paperB: 0,
				paperC: 0,
				totalScore: 0,
				totalCitations: 0,
				publishedPapers: [],
				paperSlots: 1,
				papers: [null, null, null, null],
				buffs: { permanent: [], temporary: [] },
				actionUsed: false,
				readCount: 0,
				workCount: 0,
				firstPaperAccepted: false,
				firstAPaperAccepted: false,
				hasLover: false,
				loverType: null,
				bigBullCooperation: false,
				rejectedCount: 0,
				teaBreakCount: 0,
				tourCount: 0,
				metBigBull: false,
				metBeautiful: false,
				metSmart: false,
				bigBullDeepCount: 0,
				beautifulCount: 0,
				smartCount: 0,
				availableRandomEvents: [],
				usedRandomEvents: [],
				triggeredBuffTypes: [],
				coffeeBoughtCount: 0,
				isReversed: false,
				reversedAwakened: false,
				blockedResearchGains: 0,
				
				pendingPhDChoice: false,
				pendingConference: null,
				goldSpentTotal: 0,
				enterpriseCount: 0,
				ailabInternship: false,
				firstBestPaperAccepted: false,
				firstABestPaperAccepted: false,
				badmintonMonth: -1,
				
				lastResetMonth: 0,
				socialAwakened: false,
				reviewerDistribution: null,
				
				ideaClickCount: 0,
				expClickCount: 0,
				writeClickCount: 0,
				consecutiveAccepts: 0,
				
				rejectedPapers: {},
				maxConcurrentReviews: 0,
				phdOpportunitiesRejected: 0,
				gpuServersBought: 0,
				furnitureBought: {
					chair: false,
					monitor: false,
					keyboard: false
				},
				achievementConditions: {
					highScorePaper: false,
					unanimousImprovement: false,
					allBadReviewers: false,
					tripleRejected: false,
					bought5GPUs: false,
					fullFurnitureSet: false,
					phdRequirementMetEarly: false,
					rejectedPhdTwice: false
				},
				paperTypeCollection: new Set(),
				
				// ★★★ 新增：隐藏觉醒相关状态 ★★★
				hiddenAwakened: false,           // 是否触发了隐藏觉醒
				hiddenAwakenType: null,          // 隐藏觉醒类型
				actionLimit: 1,                  // 每月行动次数限制（勤能补拙为2）
				actionCount: 0,                  // 本月已使用行动次数
				noDecay: false,                  // 是否禁止论文分数衰减（预见未来热点）
				hasSeniorHelpSkill: false,       // 是否有师兄师姐救我技能
				usedSeniorHelpSkill: false,      // 是否已使用师兄师姐救我
				hasTeacherHelpSkill: false,      // 是否有导师救我技能
				usedTeacherHelpSkill: false,     // 是否已使用导师救我
				monthlyWageBonus: 0,             // 每月工资加成（不求暴富但求稳定）
				nextIdeaResearchBonus: 0,        // 下次想idea的临时科研加成（主动技能用，不算buff）
				nextIdeaBonusSource: null,        // 加成来源（'senior' 或 'teacher'）
				isTrueNormal: false,  // 是否使用真·大多数角色
				researchMax: 20,
				socialMax: 20,  
				favorMax: 20, 
                
                // ★★★ 新增：投稿统计和会议信息 ★★★
                submissionStats: null,           // 投稿统计快照
                pendingConferenceInfo: null,      // 待开会议信息
				achievementCoins: 0,  // 成就币
			};
		}


        // ==================== Supabase 统计系统 ====================
		const SUPABASE_URL = 'https://ypefmpeekfucmarbbdov.supabase.co';
		const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlwZWZtcGVla2Z1Y21hcmJiZG92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NTA2NTYsImV4cCI6MjA4MTUyNjY1Nn0.XTOQNFuuwfu9nwDTnO9-NEqlzZnzdCVnEmYEJh0rXf8';
        //const SUPABASE_URL = 'https://orzejzmyzugxtyrzfcse.supabase.co';
        //const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9yemVqem15enVneHR5cnpmY3NlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzMDYyMTUsImV4cCI6MjA4MDg4MjIxNX0.lx9W0v9KpRPmQR0kdxCSWVks_az5rLCr7D3JI2efeM4';

        //let supabase = null;
        let statsInitialized = false;
        let statsCache = null;
        let statsCacheTime = 0;
        let visitStatsCache = null;
        let visitStatsCacheTime = 0;
        const CACHE_DURATION = 10 * 60 * 1000;

		// ==================== 持久化缓存系统 ====================
		const CACHE_KEYS = {
			STATS: 'graduateSimulator_statsCache',
			VISIT: 'graduateSimulator_visitCache',
			GAMES: 'graduateSimulator_gamesCache',
			CHARACTER_RECORDS: 'graduateSimulator_charRecordsCache'
		};

		// 从localStorage获取缓存（带过期检查和有效性验证）
		function getLocalCache(key) {
			try {
				const cached = localStorage.getItem(key);
				if (!cached) return null;
				
				const { data, timestamp } = JSON.parse(cached);
				
				// 检查是否过期
				if (Date.now() - timestamp > CACHE_DURATION) {
					localStorage.removeItem(key);
					console.log(`缓存已过期: ${key}`);
					return null;
				}
				
				// ★★★ 检查数据有效性 ★★★
				if (data === null || data === undefined) {
					localStorage.removeItem(key);
					console.log(`缓存数据无效: ${key}`);
					return null;
				}
				
				// 对于统计数据，额外检查结构
				if (key === CACHE_KEYS.STATS) {
					if (!data.normal || !data.reversed) {
						localStorage.removeItem(key);
						console.log(`统计缓存结构无效: ${key}`);
						return null;
					}
				}
				
				return data;
			} catch (e) {
				console.warn('读取缓存失败:', e);
				// 缓存损坏时删除
				try { localStorage.removeItem(key); } catch(err) {}
				return null;
			}
		}

		// 存储缓存到localStorage（只存储有效数据）
		function setLocalCache(key, data) {
			// ★★★ 不缓存无效数据 ★★★
			if (data === null || data === undefined) {
				console.log(`跳过缓存无效数据: ${key}`);
				return;
			}
			
			try {
				localStorage.setItem(key, JSON.stringify({
					data,
					timestamp: Date.now()
				}));
				console.log(`已缓存: ${key}`);
			} catch (e) {
				console.error('存储缓存失败:', e);
			}
		}

		// ★★★ 新增：清除指定缓存 ★★★
		function clearLocalCache(key) {
			try {
				localStorage.removeItem(key);
				console.log(`已清除缓存: ${key}`);
			} catch (e) {
				console.error('清除缓存失败:', e);
			}
		}

		// ★★★ 新增：清除所有统计缓存（用于强制刷新）★★★
		function clearAllStatsCache() {
			Object.values(CACHE_KEYS).forEach(key => {
				try { localStorage.removeItem(key); } catch(e) {}
			});
			console.log('已清除所有统计缓存');
		}

		// ==================== 真实结局解锁系统 ====================
		const PHD_UNLOCK_KEY = 'graduateSimulator_phdUnlocks';

		// 获取各角色博士通关记录
		function getCharacterPhdUnlocks() {
			try {
				const data = localStorage.getItem(PHD_UNLOCK_KEY);
				if (data) {
					return JSON.parse(data);
				}
			} catch (e) {
				console.warn('读取博士通关记录失败:', e);
			}
			return {
				normal: {normal: false,  genius: false, social: false, rich: false, 'teacher-child': false, chosen: false, },
				reversed: {normal: false,  genius: false, social: false, rich: false, 'teacher-child': false, chosen: false, }
			};
		}

		// 记录角色博士通关
		function recordCharacterPhdUnlock(characterId, isReversed) {
			const unlocks = getCharacterPhdUnlocks();
			const mode = isReversed ? 'reversed' : 'normal';
			unlocks[mode][characterId] = true;
			localStorage.setItem(PHD_UNLOCK_KEY, JSON.stringify(unlocks));
			console.log(`✅ 记录博士通关: ${characterId} (${mode})`);
		}

		// 检查是否解锁真·大多数（需要6个角色的正位和逆位都博士毕业）
		function isTrueNormalUnlocked() {
			const unlocks = getCharacterPhdUnlocks();
			const allCharacterIds = ['normal', 'genius', 'social', 'rich', 'teacher-child', 'chosen'];
			
			// 检查每个角色的正位和逆位是否都达到博士毕业
			for (const charId of allCharacterIds) {
				if (!unlocks.normal[charId] || !unlocks.reversed[charId]) {
					return false;
				}
			}
			return true;
		}

		// 获取解锁进度（总共12个：6角色×2模式）
		function getTrueNormalUnlockProgress() {
			const unlocks = getCharacterPhdUnlocks();
			const allCharacterIds = ['normal', 'genius', 'social', 'rich', 'teacher-child', 'chosen'];
			
			let unlockedCount = 0;
			const details = [];
			
			for (const charId of allCharacterIds) {
				const normalUnlocked = unlocks.normal[charId] || false;
				const reversedUnlocked = unlocks.reversed[charId] || false;
				
				if (normalUnlocked) unlockedCount++;
				if (reversedUnlocked) unlockedCount++;
				
				const char = characters.find(c => c.id === charId);
				details.push({
					id: charId,
					name: char ? char.name : charId,
					normalUnlocked,
					reversedUnlocked
				});
			}
			
			return {
				unlocked: unlockedCount,
				total: 12,
				isComplete: unlockedCount === 12,
				details
			};
		}

		// 获取玩家本地达成的结局和成就记录
		function getPlayerAchievements() {
			const recordKey = 'graduateSimulator_playerRecords';
			try {
				const records = localStorage.getItem(recordKey);
				if (records) {
					const parsed = JSON.parse(records);
					return {
						achievements: {
							normal: new Set(parsed.achievements?.normal || []),
							reversed: new Set(parsed.achievements?.reversed || [])
						},
						endings: {
							normal: new Set(parsed.endings?.normal || []),
							reversed: new Set(parsed.endings?.reversed || [])
						}
					};
				}
			} catch (e) {
				console.warn('读取玩家记录失败:', e);
			}
			
			return {
				achievements: { normal: new Set(), reversed: new Set() },
				endings: { normal: new Set(), reversed: new Set() }
			};
		}

		// 保存玩家达成的结局和成就
		function savePlayerRecord(endingType, achievements, isReversed) {
			const recordKey = 'graduateSimulator_playerRecords';
			try {
				let records = { 
					achievements: { normal: [], reversed: [] }, 
					endings: { normal: [], reversed: [] } 
				};
				
				const existing = localStorage.getItem(recordKey);
				if (existing) {
					records = JSON.parse(existing);
					// 确保结构完整
					if (!records.achievements) records.achievements = { normal: [], reversed: [] };
					if (!records.endings) records.endings = { normal: [], reversed: [] };
					if (!records.achievements.normal) records.achievements.normal = [];
					if (!records.achievements.reversed) records.achievements.reversed = [];
					if (!records.endings.normal) records.endings.normal = [];
					if (!records.endings.reversed) records.endings.reversed = [];
				}
				
				const mode = isReversed ? 'reversed' : 'normal';
				
				// 添加结局
				if (!records.endings[mode].includes(endingType)) {
					records.endings[mode].push(endingType);
				}
				
				// 添加成就
				achievements.forEach(ach => {
					if (!records.achievements[mode].includes(ach)) {
						records.achievements[mode].push(ach);
					}
				});
				
				localStorage.setItem(recordKey, JSON.stringify(records));
			} catch (e) {
				console.error('保存玩家记录失败:', e);
			}
		}

		function initStats() {
			if (statsInitialized) return;
			
			try {
				if (typeof window.supabase === 'undefined' || !window.supabase.createClient) {
					console.warn('⚠️ Supabase SDK 未加载');
					return;
				}
				
				supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
				statsInitialized = true;
				console.log('✅ Supabase 初始化成功');
				recordVisit();
				startOnlineTracking();  // ★ 启动
				
			} catch (e) {
				console.error('❌ 初始化失败:', e);
				supabase = null;
			}
		}

		async function recordVisit() {
			if (!supabase) return;
			try {
				// 记录 PV（每次访问都记录）
				await supabase.from('site_visits').insert({ type: 'pv' });
				
				// ★★★ 修复：每天每个用户只记录一次 UV ★★★
				const todayStr = getTodayDateString();
				const visitorKey = 'graduate_simulator_visitor';
				const lastUvDateKey = 'graduate_simulator_last_uv_date';
				
				const isNewVisitor = !localStorage.getItem(visitorKey);
				const lastUvDate = localStorage.getItem(lastUvDateKey);
				const isNewDay = lastUvDate !== todayStr;
				
				// 新访客 或 新的一天（老访客今天第一次访问）都记录 UV
				if (isNewVisitor || isNewDay) {
					await supabase.from('site_visits').insert({ type: 'uv' });
					localStorage.setItem(visitorKey, 'true');
					localStorage.setItem(lastUvDateKey, todayStr);
					console.log(isNewVisitor ? '✅ 新访客已记录' : '✅ 今日访客已记录');
				}
			} catch (e) {
				console.error('记录访问失败:', e);
			}
		}

		async function getVisitStats() {
			// 先检查本地缓存
			const cached = getLocalCache(CACHE_KEYS.VISIT);
			if (cached) {
				console.log('使用本地缓存的访问统计');
				visitStatsCache = cached;
				visitStatsCacheTime = Date.now();
				return cached;
			}
			
			if (!supabase) return { pv: 0, uv: 0 };
			
			try {
				const { count: pvCount, error: pvError } = await supabase
					.from('site_visits')
					.select('*', { count: 'exact', head: true })
					.eq('type', 'pv');
				
				if (pvError) throw pvError;
				
				const { count: uvCount, error: uvError } = await supabase
					.from('site_visits')
					.select('*', { count: 'exact', head: true })
					.eq('type', 'uv');
					
				if (uvError) throw uvError;
				
				const result = { pv: pvCount || 0, uv: uvCount || 0 };
				
				// ★★★ 成功后才缓存 ★★★
				visitStatsCache = result;
				visitStatsCacheTime = Date.now();
				setLocalCache(CACHE_KEYS.VISIT, result);
				
				return result;
			} catch (e) {
				console.error('获取访问统计失败:', e);
				// 失败时返回内存缓存或默认值，不存储缓存
				return visitStatsCache || { pv: 0, uv: 0 };
			}
		}



		async function recordEnding(endingType, endingTitle) {
			// ★★★ 移除数据验证，直接上传 ★★★
			
			// 计算成就数量
			const achievements = collectAchievements(endingType);
			const achievementCount = achievements.length;
			
			// 更新本地记录
			updateLocalMeta(
				gameState.character, 
				gameState.isReversed, 
				gameState.totalScore, 
				gameState.totalCitations, 
				achievementCount,
				endingType,  // ★★★ 新增参数 ★★★
			);
			
			if (!supabase) return;
			
			try {
				const { error } = await supabase.from('game_endings').insert({
					ending_type: endingType,
					ending_title: endingTitle,
					character: gameState.character,
					is_reversed: gameState.isReversed,
					total_months: gameState.totalMonths,
					total_score: gameState.totalScore,
					paper_a: gameState.paperA,
					paper_b: gameState.paperB,
					paper_c: gameState.paperC,
					total_citations: gameState.totalCitations,
					achievements_count: achievementCount
				});
				
				if (error) throw error;
				console.log('✅ 结局已记录:', endingTitle);
				
				// 清除缓存
				globalCharacterRecords = null;
			} catch (e) {
				console.error('❌ 记录结局失败:', e);
			}
		}

        async function recordAchievements(achievements) {
            if (!supabase || achievements.length === 0) return;
            try {
                const records = achievements.map(ach => ({
                    achievement_name: ach,
                    character: gameState.character,
                    is_reversed: gameState.isReversed
                }));
                
                const { error } = await supabase.from('game_achievements').insert(records);
                
                if (error) throw error;
                console.log('✅ 成就已记录:', achievements);
            } catch (e) {
                console.error('❌ 记录成就失败:', e);
            }
        }


		// ★★★ 新增：快速获取游戏总数（用 count 查询）★★★
		async function getTotalGamesCount() {
			// 先检查本地缓存
			const cached = getLocalCache(CACHE_KEYS.GAMES);
			if (cached !== null && cached !== undefined) {
				console.log('使用本地缓存的游戏总数');
				return cached;
			}
			
			if (!supabase) return 0;
			
			try {
				const { count, error } = await supabase
					.from('game_endings')
					.select('*', { count: 'exact', head: true });
				
				if (error) throw error;
				
				const result = count || 0;
				
				// ★★★ 成功后才缓存 ★★★
				setLocalCache(CACHE_KEYS.GAMES, result);
				
				return result;
			} catch (e) {
				console.error('获取游戏总数失败:', e);
				// 失败时不缓存
				return 0;
			}
		}
		// ==================== 统计 Fallback 函数 (修复报错) ====================
		async function getGlobalStatsFallback() {
			console.log('⚠️ 统计加载进入 Fallback 模式 (使用默认空数据)');
			
			// 1. 定义一个基础的空统计结构
			const createEmptyStats = () => {
				const stats = {
					endings: {},
					achievements: {},
					totalGames: 0,
					characterEndings: {}
				};
				
				// 初始化所有结局计数为 0
				if (typeof ENDING_NAMES !== 'undefined') {
					Object.keys(ENDING_NAMES).forEach(key => stats.endings[key] = 0);
				}
				
				// 初始化所有成就计数为 0
				if (typeof ALL_ACHIEVEMENTS !== 'undefined') {
					ALL_ACHIEVEMENTS.forEach(key => stats.achievements[key] = 0);
				}
				
				// 初始化角色难度数据
				const allCharIds = ['normal', 'genius', 'social', 'rich', 'teacher-child', 'chosen', 'true-normal'];
				allCharIds.forEach(id => {
					stats.characterEndings[id] = { total: 0, hard: 0 };
				});
				
				return stats;
			};

			// 2. 返回完整的正位和逆位结构
			// 即使无法连接数据库，返回这个结构也能保证游戏UI正常渲染“暂无数据”而不是白屏
			return {
				normal: createEmptyStats(),
				reversed: createEmptyStats()
			};
		}
		// ==================== 优化后：从缓存表获取全球统计 ====================
		async function getGlobalStats() {
			// 先检查本地缓存
			const cached = getLocalCache(CACHE_KEYS.STATS);
			if (cached) {
				console.log('使用本地缓存的全球统计');
				statsCache = cached;
				statsCacheTime = Date.now();
				return cached;
			}
			
			if (!supabase) {
				console.warn('Supabase未初始化');
				return null;
			}
			
			try {
				// 尝试从缓存表读取（优化后的方式）
				const [endingsRes, achievementsRes, difficultyRes] = await Promise.all([
					supabase.from('stats_endings_cache').select('*'),
					supabase.from('stats_achievements_cache').select('*'),
					supabase.from('stats_character_difficulty_cache').select('*')
				]);
				
				// 检查缓存表是否存在且有数据
				const hasCache = !endingsRes.error && endingsRes.data && endingsRes.data.length > 0;
				
				if (hasCache) {
					// 使用缓存表数据
					const stats = {
						normal: { endings: {}, achievements: {}, totalGames: 0, characterEndings: {} },
						reversed: { endings: {}, achievements: {}, totalGames: 0, characterEndings: {} }
					};
					
					// 处理结局数据
					endingsRes.data.forEach(function(row) {
						stats[row.mode].endings[row.ending_type] = row.count;
						stats[row.mode].totalGames += row.count;
					});
					
					// 处理成就数据
					if (achievementsRes.data) {
						achievementsRes.data.forEach(function(row) {
							stats[row.mode].achievements[row.achievement_name] = row.count;
						});
					}
					
					// 处理角色难度数据
					if (difficultyRes.data) {
						difficultyRes.data.forEach(function(row) {
							var mode = row.is_reversed ? 'reversed' : 'normal';
							stats[mode].characterEndings[row.character_id] = {
								total: row.total_games,
								hard: row.hard_games
							};
						});
					}
					
					// 缓存结果
					statsCache = stats;
					statsCacheTime = Date.now();
					setLocalCache(CACHE_KEYS.STATS, stats);
					
					console.log('✅ 从缓存表加载统计完成');
					return stats;
				}
				
				// 缓存表不存在或为空，fallback 到原有逻辑
				console.log('缓存表为空，使用原有逻辑加载数据');
				return await getGlobalStatsFallback();
				
			} catch (e) {
				console.error('获取统计失败:', e);
				// 出错时尝试 fallback
				return await getGlobalStatsFallback();
			}
		}

		function renderModeStats(mode, modeStats, endingContainer, achievementContainer) {
			if (!endingContainer || !achievementContainer) {
				console.warn('统计容器不存在');
				return;
			}
			
			const playerRecords = getPlayerAchievements();
			const playerEndingsSet = playerRecords.endings[mode] || new Set();
			const playerAchievementsSet = playerRecords.achievements[mode] || new Set();
			
			const totalGames = modeStats.totalGames || 0;
			
			// ==================== 渲染结局统计（按完成率排序）====================
			// ★★★ 新增：逆位模式下过滤掉真·大多数相关结局（逆位无法选择真·大多数）★★★
			const trueNormalEndings = ['true_phd', 'true_devotion', 'true_life'];
			const endingsToShow = mode === 'reversed' 
				? Object.entries(ENDING_NAMES).filter(([type]) => !trueNormalEndings.includes(type))
				: Object.entries(ENDING_NAMES);
			
			// 构建结局数据数组
			const endingEntries = endingsToShow.map(([type, name]) => {
				const count = modeStats.endings[type] || 0;
				const percent = totalGames > 0 ? (count / totalGames) * 100 : 0;
				const isAchieved = playerEndingsSet instanceof Set 
					? playerEndingsSet.has(type) 
					: (Array.isArray(playerEndingsSet) && playerEndingsSet.includes(type));
				return { type, name, count, percent, isAchieved };
			});
			
			// 按百分比从高到低排序
			endingEntries.sort((a, b) => b.percent - a.percent);
			
			// 分离已达成和未达成
			const achievedEndingsSorted = endingEntries.filter(e => e.isAchieved);
			const unachievedEndingsSorted = endingEntries.filter(e => !e.isAchieved);
			
			let achievedEndingsHtml = achievedEndingsSorted.map(e => {
				// 真实结局额外显示数量
				const isTrueEnding = e.type === 'true_phd' || e.type === 'true_devotion' || e.type === 'true_life';
				const displayText = isTrueEnding 
					? `${e.name} <strong>${e.percent.toFixed(1)}% (${e.count}人)</strong>`
					: `${e.name} <strong>${e.percent.toFixed(1)}%</strong>`;
				return `
					<span class="stats-tag ending-tag" 
						  onclick="showSingleEndingRequirement('${e.type}')" 
						  style="cursor:pointer;">
						${displayText}
					</span>
				`;
			}).join('');
			
			let unachievedEndingsHtml = unachievedEndingsSorted.map(e => {
				const isTrueEnding = e.type === 'true_phd' || e.type === 'true_devotion' || e.type === 'true_life';
				const displayText = isTrueEnding 
					? `${e.name} <strong>${e.percent.toFixed(1)}% (${e.count}人)</strong>`
					: `${e.name} <strong>${e.percent.toFixed(1)}%</strong>`;
				return `
					<span class="stats-tag ending-tag" 
						  onclick="showSingleEndingRequirement('${e.type}')" 
						  style="cursor:pointer;opacity:0.5;">
						${displayText}
					</span>
				`;
			}).join('');
			
			let endingHtml = '';
			if (achievedEndingsHtml) {
				endingHtml += `
					<div style="margin-bottom:8px;">
						<div style="font-size:0.7rem;color:var(--success-color);margin-bottom:4px;">✓ 玩家已达成结局（全球结局比率）</div>
						<div style="display:flex;flex-wrap:wrap;gap:4px;">${achievedEndingsHtml}</div>
					</div>`;
			}
			if (unachievedEndingsHtml) {
				endingHtml += `
					<div>
						<div style="font-size:0.7rem;color:var(--text-secondary);margin-bottom:4px;">○ 玩家未达成结局（全球结局比率）</div>
						<div style="display:flex;flex-wrap:wrap;gap:4px;">${unachievedEndingsHtml}</div>
					</div>`;
			}
			if (!endingHtml) {
				endingHtml = '<span style="color:var(--text-secondary);font-size:0.75rem;">暂无数据</span>';
			}
			endingContainer.innerHTML = endingHtml;
			
			// ==================== 渲染成就统计（按完成率排序）====================
			const achievementEntries = ALL_ACHIEVEMENTS.map(ach => {
				const count = modeStats.achievements[ach] || 0;
				const percent = totalGames > 0 ? (count / totalGames) * 100 : 0;
				const isAchieved = playerAchievementsSet instanceof Set 
					? playerAchievementsSet.has(ach) 
					: (Array.isArray(playerAchievementsSet) && playerAchievementsSet.includes(ach));
				return { ach, count, percent, isAchieved };
			});
			
			// 按百分比从高到低排序
			achievementEntries.sort((a, b) => b.percent - a.percent);
			
			const achievedAchSorted = achievementEntries.filter(a => a.isAchieved);
			const unachievedAchSorted = achievementEntries.filter(a => !a.isAchieved);
			
			let achievedAchHtml = achievedAchSorted.map(a => `
				<span class="stats-tag" 
					  onclick="showSingleAchievementRequirement('${a.ach}')" 
					  style="cursor:pointer;">
					${a.ach} <strong>${a.percent.toFixed(1)}%</strong>
				</span>
			`).join('');
			
			let unachievedAchHtml = unachievedAchSorted.map(a => `
				<span class="stats-tag" 
					  onclick="showSingleAchievementRequirement('${a.ach}')" 
					  style="cursor:pointer;opacity:0.5;">
					${a.ach} <strong>${a.percent.toFixed(1)}%</strong>
				</span>
			`).join('');
			
			let achievementHtml = '';
			if (achievedAchHtml) {
				achievementHtml += `
					<div style="margin-bottom:8px;">
						<div style="font-size:0.7rem;color:var(--success-color);margin-bottom:4px;">✓ 玩家已达成成就（全球玩家达成率）</div>
						<div style="display:flex;flex-wrap:wrap;gap:4px;">${achievedAchHtml}</div>
					</div>`;
			}
			if (unachievedAchHtml) {
				achievementHtml += `
					<div>
						<div style="font-size:0.7rem;color:var(--text-secondary);margin-bottom:4px;">○ 玩家未达成成就（全球玩家达成率）</div>
						<div style="display:flex;flex-wrap:wrap;gap:4px;">${unachievedAchHtml}</div>
					</div>`;
			}
			if (!achievementHtml) {
				achievementHtml = '<span style="color:var(--text-secondary);font-size:0.75rem;">暂无数据</span>';
			}
			achievementContainer.innerHTML = achievementHtml;
		}

		// ==================== 简化后：直接使用预计算的难度数据 ====================
		function calculateCharacterDifficulty(stats) {
			const difficultyData = {};
			const allCharacterRates = [];
			
			// 所有角色ID（包括真·大多数）
			const allCharIds = ['normal', 'genius', 'social', 'rich', 'teacher-child', 'chosen'];
			
			// 收集所有角色的博士通关率
			allCharIds.forEach(charId => {
				// 正位数据
				const normalData = stats.normal.characterEndings[charId] || { total: 0, hard: 0 };
				const normalRate = normalData.total >= 5 ? normalData.hard / normalData.total : null;
				allCharacterRates.push({
					id: charId,
					isReversed: false,
					rate: normalRate,
					total: normalData.total,
					hard: normalData.hard
				});
				
				// 逆位数据
				const reversedData = stats.reversed.characterEndings[charId] || { total: 0, hard: 0 };
				const reversedRate = reversedData.total >= 5 ? reversedData.hard / reversedData.total : null;
				allCharacterRates.push({
					id: charId,
					isReversed: true,
					rate: reversedRate,
					total: reversedData.total,
					hard: reversedData.hard
				});
			});
			
			// 过滤有效数据并排序
			const validRates = allCharacterRates.filter(c => c.rate !== null);
			validRates.sort((a, b) => b.rate - a.rate); // 博士率高的排前面（更简单）
			
			// 计算难度星级
			validRates.forEach((char, index) => {
				const rank = index + 1;
				const difficulty = Math.ceil(rank * 12 / validRates.length);
				const key = `${char.id}_${char.isReversed ? 'reversed' : 'normal'}`;
				difficultyData[key] = {
					stars: Math.min(12, Math.max(1, difficulty)),
					rate: char.rate,
					total: char.total,
					hard: char.hard,
					rank: rank,
					totalRanked: validRates.length
				};
			});
			
			// 处理数据不足的角色
			allCharacterRates.forEach(char => {
				const key = `${char.id}_${char.isReversed ? 'reversed' : 'normal'}`;
				if (!difficultyData[key]) {
					difficultyData[key] = {
						stars: null,
						rate: null,
						total: char.total,
						hard: char.hard,
						rank: null,
						totalRanked: validRates.length
					};
				}
			});
			
			// 真·大多数固定12星
			const trueNormalData = stats.normal.characterEndings['true-normal'] || { total: 0, hard: 0 };
			difficultyData['true-normal_normal'] = {
				stars: 12,
				rate: trueNormalData.total >= 5 ? trueNormalData.hard / trueNormalData.total : null,
				total: trueNormalData.total,
				hard: trueNormalData.hard,
				rank: 0,
				totalRanked: validRates.length,
				isFixed: true
			};
			
			return difficultyData;
		}

        function renderDifficultyStars(stars) {
            if (stars === null) {
                return '<span class="no-data">数据不足</span>';
            }

            let html = '';
            const fullStars = Math.floor(stars / 2);
            const halfStar = stars % 2 === 1;
            const emptyStars = 6 - fullStars - (halfStar ? 1 : 0);

            for (let i = 0; i < fullStars; i++) {
                html += '<i class="fas fa-star"></i>';
            }
            if (halfStar) {
                html += '<i class="far fa-star"></i>';
            }
            for (let i = 0; i < emptyStars; i++) {
                html += '<i class="far fa-star" style="opacity:0.3;"></i>';
            }

            return html;
        }

        function getDifficultyBadge(stars) {
            if (stars === null) return '<span class="difficulty-badge unknown">?</span>';
            if (stars >= 11) return '<span class="difficulty-badge legendary">传说</span>';
            if (stars >= 9) return '<span class="difficulty-badge nightmare">噩梦</span>';
            if (stars >= 7) return '<span class="difficulty-badge expert">专家</span>';
            if (stars >= 5) return '<span class="difficulty-badge hard">困难</span>';
            if (stars >= 3) return '<span class="difficulty-badge normal">普通</span>';
            return '<span class="difficulty-badge easy">简单</span>';
        }

		async function loadGlobalStatsDisplay() {
			const section = document.getElementById('stats-section');
			const loading = document.getElementById('stats-loading');
			const content = document.getElementById('stats-content');
			
			section.style.display = 'block';
			loading.style.display = 'block';
			content.style.display = 'none';
			
			// 第1步：快速加载总数
			Promise.all([
				getVisitStats(),
				getTotalGamesCount()
			]).then(([visitStats, totalGames]) => {
				const pvEl = document.getElementById('busuanzi_value_site_pv');
				const uvEl = document.getElementById('busuanzi_value_site_uv');
				const gamesEl = document.getElementById('total-games-value');
				
				if (pvEl) pvEl.textContent = visitStats.pv || 0;
				if (uvEl) uvEl.textContent = visitStats.uv || 0;
				if (gamesEl) gamesEl.textContent = totalGames;
			}).catch(e => {
				console.error('加载访问统计失败:', e);
			});
			
			// 第2步：加载详细统计
			setTimeout(async () => {
				try {
					if (!supabase) {
						loading.innerHTML = `
							<span style="color:var(--text-secondary);font-size:0.8rem;">📊 统计服务暂不可用</span>
							<button class="btn btn-info" style="margin-left:10px;padding:3px 8px;font-size:0.7rem;" onclick="retryLoadStats()">
								<i class="fas fa-redo"></i> 重试
							</button>
						`;
						return;
					}
					
					loading.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在加载详细统计...';
					
					const stats = await getGlobalStats();
					
					if (!stats) {
						// ★★★ 加载失败时显示重试按钮 ★★★
						loading.innerHTML = `
							<span style="color:var(--warning-color);font-size:0.8rem;">⚠️ 统计加载失败</span>
							<button class="btn btn-info" style="margin-left:10px;padding:3px 8px;font-size:0.7rem;" onclick="retryLoadStats()">
								<i class="fas fa-redo"></i> 重试
							</button>
						`;
						return;
					}
					
					characterDifficultyData = calculateCharacterDifficulty(stats);
					
					loading.style.display = 'none';
					content.style.display = 'block';
					
					// 渲染统计（使用原有的combined容器或新的分离容器）
					const normalEndingEl = document.getElementById('normal-ending-stats');
					const normalAchEl = document.getElementById('normal-achievement-stats');
					const reversedEndingEl = document.getElementById('reversed-ending-stats');
					const reversedAchEl = document.getElementById('reversed-achievement-stats');
					
					// 如果有分离的容器，使用分离显示
					if (normalEndingEl && reversedEndingEl) {
						renderModeStats('normal', stats.normal, normalEndingEl, normalAchEl);
						renderModeStats('reversed', stats.reversed, reversedEndingEl, reversedAchEl);
						
						// 根据当前模式显示对应统计
						const normalSection = document.getElementById('normal-stats-section');
						const reversedSection = document.getElementById('reversed-stats-section');
						if (normalSection && reversedSection) {
							normalSection.style.display = isReversedMode ? 'none' : 'block';
							reversedSection.style.display = isReversedMode ? 'block' : 'none';
						}
					} else {
						// 兼容旧的combined容器
						const combinedEndingEl = document.getElementById('combined-ending-stats');
						const combinedAchEl = document.getElementById('combined-achievement-stats');
						if (combinedEndingEl && combinedAchEl) {
							const currentMode = isReversedMode ? 'reversed' : 'normal';
							renderModeStats(currentMode, stats[currentMode], combinedEndingEl, combinedAchEl);
						}
					}
					
					renderCharacterGrid();
					
					// 角色记录异步加载
					getGlobalCharacterRecords().then(() => {
						renderCharacterGrid();
						console.log('✅ 全部加载完成');
					}).catch(e => {
						console.error('加载角色记录失败:', e);
					});
					
				} catch (e) {
					console.error('加载统计失败:', e);
					loading.innerHTML = `
						<span style="color:var(--warning-color);font-size:0.8rem;">⚠️ 加载失败: ${e.message || '未知错误'}</span>
						<button class="btn btn-info" style="margin-left:10px;padding:3px 8px;font-size:0.7rem;" onclick="retryLoadStats()">
							<i class="fas fa-redo"></i> 重试
						</button>
					`;
				}
			}, 100);
		}

		// ★★★ 新增：重试加载统计（清除缓存后重新加载）★★★
		function retryLoadStats() {
			console.log('手动重试加载统计...');
			// 清除所有统计缓存
			clearAllStatsCache();
			// 重置内存缓存
			statsCache = null;
			statsCacheTime = 0;
			visitStatsCache = null;
			visitStatsCacheTime = 0;
			globalCharacterRecords = null;
			globalCharacterRecordsTime = 0;
			// 重新加载
			loadGlobalStatsDisplay();
		}


        // ==================== 模式切换 ====================
		function switchMode(reversed) {
			isReversedMode = reversed;
			isTrueNormalMode = false;  // ★★★ 切换模式时重置真·大多数状态 ★★★
            
            const normalBtn = document.getElementById('normal-mode-btn');
            const reversedBtn = document.getElementById('reversed-mode-btn');
            const modeDesc = document.getElementById('mode-description');
            const gameIntro = document.getElementById('game-intro');
            const selectionTitle = document.getElementById('selection-title');
            
            normalBtn.classList.toggle('active', !reversed);
            reversedBtn.classList.toggle('active', reversed);
            reversedBtn.classList.toggle('reversed-active', reversed);
            
            document.body.classList.toggle('reversed-theme', reversed);
            document.querySelectorAll('.character-card').forEach(card => card.classList.remove('selected'));
            
            if (reversed) {
                modeDesc.innerHTML = '💀 逆位模式，循规蹈矩？不免太过无趣！';
                selectionTitle.innerHTML = '<i class="fas fa-moon"></i> 选择你的逆位角色';
                gameIntro.innerHTML = `
                    <p>🌑 <strong>逆位模式已开启！</strong>每个角色都有独特的逆位效果，规则将被颠覆。</p>
                    <p>⚠️ <strong>注意</strong>：逆位角色玩法更独特，属性变化规则可能完全不同！</p>
                    <p>🎯 <strong>游戏目标</strong>：硕士毕业科研分≥1（3年），博士毕业科研分≥7（5年）</p>
                    <p>📝 <strong>论文科研分</strong>：A类=4分，B类=2分，C类=1分</p>
                    <p>💀 <strong>挑战自我</strong>：逆位角色的转博觉醒效果也完全不同！</p>
                `;
            } else {
                modeDesc.innerHTML = '📚 经典模式，体验标准的研究生生涯';
                selectionTitle.innerHTML = '<i class="fas fa-users"></i> 选择你的角色';
                gameIntro.innerHTML = `
                    <p>📚 <strong>欢迎来到研究生模拟器！</strong>体验研究生生涯，平衡科研、生活和人际关系，努力发表论文，最终顺利毕业。</p>
                    <p>🎯 <strong>游戏目标</strong>：硕士毕业科研分≥1（3年），博士毕业科研分≥7（5年）</p>
                    <p>📝 <strong>论文科研分</strong>：A类=4分，B类=2分，C类=1分</p>
                    <p>💡 <strong>属性影响</strong>：科研能力影响论文分数；社交能力和导师好感度影响事件选项和结果。<strong>建议优先将属性提升至6以解锁更多选项！</strong></p>
                    <p>⚠️ <strong>注意</strong>：保持SAN值、导师好感度和金钱为正数，否则将触发不良结局！</p>
                `;
            }
            
            selectedCharacter = null;
            document.getElementById('start-btn').disabled = true;
			// ★★★ 切换统计面板显示 ★★★
			const normalSection = document.getElementById('normal-stats-section');
			const reversedSection = document.getElementById('reversed-stats-section');
			if (normalSection && reversedSection) {
				normalSection.style.display = reversed ? 'none' : 'block';
				reversedSection.style.display = reversed ? 'block' : 'none';
			}
            
            renderCharacterGrid();
        }

        // ==================== 初始化 ====================
		function init() {
			// 初始化折叠状态
			initCollapseStates();
			initStartSectionStates();
			
			renderCharacterGrid();
			document.getElementById('start-btn').addEventListener('click', startGame);
			
			initStats();
			loadGlobalStatsDisplay();
			
			// ★★★ 新增：加载今日统计和在线人数 ★★★
			updateAllStatsDisplay();
			
			// ★★★ 新增：每30秒刷新一次在线人数和今日统计 ★★★
			setInterval(() => {
				updateAllStatsDisplay();
			}, 30 * 1000);
			
			setTimeout(() => {
				const messageSection = document.getElementById('message-section');
				if (messageSection) {
					messageSection.style.display = 'block';
					initMessageBoard();
				}
			}, 500);
			
			// 应用保存的开始页面折叠状态
			applyStartSectionStates();
		}
				




		// ==================== 3. 修改renderCharacterGrid添加折叠功能 ====================
		// 点击解锁栏符文，跳转并选中对应角色
		function selectCharacterFromRune(charId, isReversedSide) {
			// 如果需要切换模式
			if (isReversedSide !== isReversedMode) {
				switchMode(isReversedSide);
				// 等待渲染完成后再选择角色
				setTimeout(() => {
					selectAndScrollToCharacter(charId);
				}, 100);
			} else {
				selectAndScrollToCharacter(charId);
			}
		}

		// 选中角色并滚动到卡片位置
		function selectAndScrollToCharacter(charId) {
			// 选中角色
			selectCharacter(charId);
			
			// 找到对应的角色卡片并滚动
			const card = document.querySelector(`.character-card[data-id="${charId}"]`);
			if (card) {
				// 如果卡片是折叠状态，先展开
				if (card.classList.contains('card-collapsed')) {
					const body = card.querySelector('.card-body');
					const icon = card.querySelector('.card-header .collapse-icon');
					card.classList.remove('card-collapsed');
					if (body) body.classList.remove('collapsed');
					if (icon) icon.classList.remove('rotated');
					
					// 更新折叠状态存储
					const states = getCharacterCardCollapseStates();
					const cardKey = `${charId}_${isReversedMode ? 'reversed' : 'normal'}`;
					states[cardKey] = false;
					saveCharacterCardCollapseStates(states);
				}
				
				// 滚动到卡片位置
				card.scrollIntoView({ behavior: 'smooth', block: 'center' });
				
				// 添加高亮动画效果
				card.style.transition = 'all 0.3s ease';
				card.style.boxShadow = '0 0 20px rgba(108, 92, 231, 0.6)';
				setTimeout(() => {
					card.style.boxShadow = '';
				}, 1000);
			}
		}
		function renderCharacterGrid() {
			const grid = document.getElementById('character-grid');
			const globalRecords = globalCharacterRecords;
			
			// 检查真·大多数解锁状态
			const trueNormalUnlocked = isTrueNormalUnlocked();
			const unlockProgress = getTrueNormalUnlockProgress();
			
			// 获取全球博士通关统计
			const globalPhdStats = {};
			let trueNormalUnlockedCount = 0;
			
			if (statsCache) {
				const allCharIds = ['genius', 'social', 'rich', 'teacher-child', 'chosen', 'normal'];
				allCharIds.forEach(charId => {
					const normalData = statsCache.normal?.characterEndings?.[charId];
					globalPhdStats[`${charId}_normal`] = normalData?.hard || 0;
					
					const reversedData = statsCache.reversed?.characterEndings?.[charId];
					globalPhdStats[`${charId}_reversed`] = reversedData?.hard || 0;
				});
				
				const trueNormalData = statsCache.normal?.characterEndings?.['true-normal'];
				trueNormalUnlockedCount = trueNormalData?.hard || 0;
			}

			// ★★★ 获取角色卡片折叠状态 ★★★
			const cardCollapseStates = getCharacterCardCollapseStates();

		// 解锁进度栏 - 石碑风格
		const progressContainer = document.getElementById('true-normal-progress');
		if (progressContainer) {
			const trueNormalUnlocked = isTrueNormalUnlocked();
			const unlockProgress = getTrueNormalUnlockProgress();
			
			// 计算进度
			const normalUnlocked = unlockProgress.details.filter(d => d.normalUnlocked).length;
			const reversedUnlocked = unlockProgress.details.filter(d => d.reversedUnlocked).length;
			const totalUnlocked = normalUnlocked + reversedUnlocked;
			const progressPercent = (totalUnlocked / 12 * 100).toFixed(0);
			
			// 正位角色图标
			const normalIcons = {
				'normal': '👤',
				'genius': '🔬',
				'social': '🤝',
				'rich': '💰',
				'teacher-child': '👨‍👧',
				'chosen': '⭐'
			};
			
			// 逆位角色图标
			const reversedIcons = {
				'normal': '😴',
				'genius': '🤡',
				'social': '🐍',
				'rich': '🏴‍☠️',
				'teacher-child': '🎪',
				'chosen': '🌀'
			};
			
			// 生成角色符文HTML
			const generateRuneHtml = (details, isReversedSide) => {
				const icons = isReversedSide ? reversedIcons : normalIcons;
				
				// 正位名称缩写
				const normalNameMap = {
					'normal': '大多数',
					'genius': '院士',
					'social': '社交',
					'rich': '富豪',
					'teacher-child': '子女',
					'chosen': '天选'
				};
				
				// 逆位名称缩写（使用逆位角色名前两个字）
				const reversedNameMap = {
					'normal': '怠惰',
					'genius': '愚钝',
					'social': '嫉妒',
					'rich': '贪求',
					'teacher-child': '玩世',
					'chosen': '空想'
				};
				
				const nameMap = isReversedSide ? reversedNameMap : normalNameMap;
				
				return details.map(d => {
					const isUnlocked = isReversedSide ? d.reversedUnlocked : d.normalUnlocked;
					const icon = icons[d.id] || '❓';
					const shortName = nameMap[d.id] || d.name.substring(0, 2);
					
					// 完整名称用于tooltip
					const fullName = isReversedSide 
						? {
							'normal': '怠惰之《大多数》',
							'genius': '愚钝之《院士转世》',
							'social': '嫉妒之《社交达人》',
							'rich': '贪求之《富可敌国》',
							'teacher-child': '玩世之《导师子女》',
							'chosen': '空想之《天选之人》'
						}[d.id] || d.name
						: d.name;
					
					// ★★★ 添加点击事件，阻止冒泡避免触发半区的switchMode ★★★
					return `
						<div class="zodiac-rune ${isUnlocked ? 'unlocked' : 'locked'}" 
							 title="${fullName} - 点击选择此角色"
							 onclick="event.stopPropagation(); selectCharacterFromRune('${d.id}', ${isReversedSide})">
							<span class="rune-icon">${icon}</span>
							<span class="rune-name">${shortName}</span>
						</div>
					`;
				}).join('');
			};
			
			// 底部内容
			let footerContent = '';
			if (trueNormalUnlocked) {
				if (isReversedMode) {
					footerContent = `
						<div class="zodiac-status-text">
							⚠️ 真·大多数仅在正位模式下可用
						</div>
						<div class="zodiac-status-text success" style="margin-top:5px;">
							✨ 已完全解锁
						</div>
					`;
				} else {
					footerContent = `
						<button class="zodiac-unlock-btn ${isTrueNormalMode ? 'active' : 'available'}" onclick="toggleTrueNormalMode()">
							${isTrueNormalMode ? '🔙 取消选择' : '🌟 开启真·大多数'}
						</button>
						<div class="zodiac-status-text ${isTrueNormalMode ? '' : 'success'}">
							${isTrueNormalMode ? '🔥 已选择 - 无特殊能力' : '✨ 已完全解锁'}
						</div>
					`;
				}
			} else {
				footerContent = `
					<button class="zodiac-unlock-btn disabled" disabled>
						🔒 ${totalUnlocked}/12
					</button>
					<div class="zodiac-status-text">
						每个角色需正位+逆位博士毕业
					</div>
				`;
			}
			
			progressContainer.innerHTML = `
				<div class="zodiac-unlock-panel">
					<!-- 分隔线 -->
					<div class="zodiac-divider"></div>
					
					<!-- 标题 -->
					<div class="zodiac-header">
						<div class="zodiac-title">✦ 真·大多数 ✦</div>
						<div class="zodiac-subtitle">完成所有挑战解锁终极模式</div>
						<div class="zodiac-progress">
							<div class="zodiac-progress-fill" style="width:${progressPercent}%;"></div>
						</div>
						<div class="zodiac-progress-text">${totalUnlocked} / 12</div>
					</div>
					
					<!-- 主体 -->
					<div class="zodiac-body">
						<!-- 中央核心 -->
						<div class="zodiac-center">
							<div class="zodiac-core ${trueNormalUnlocked ? 'unlocked' : 'locked'}">
								${trueNormalUnlocked ? '🌍' : '🔒'}
							</div>
						</div>
						
						<!-- 左侧 - 正位 -->
						<div class="zodiac-half normal-half ${!isReversedMode ? 'active' : ''}" onclick="switchMode(false)">
							<div class="zodiac-half-title">
								☀️ 正位 <span style="font-size:0.8em;opacity:0.7;">(${normalUnlocked}/6)</span>
							</div>
							<div class="zodiac-grid">
								${generateRuneHtml(unlockProgress.details, false)}
							</div>
							<div class="zodiac-click-hint">点击切换正位</div>
						</div>
						
						<!-- 右侧 - 逆位 -->
						<div class="zodiac-half reversed-half ${isReversedMode ? 'active' : ''}" onclick="switchMode(true)">
							<div class="zodiac-half-title">
								🌑 逆位 <span style="font-size:0.8em;opacity:0.7;">(${reversedUnlocked}/6)</span>
							</div>
							<div class="zodiac-grid">
								${generateRuneHtml(unlockProgress.details, true)}
							</div>
							<div class="zodiac-click-hint">点击切换逆位</div>
						</div>
					</div>
					
					<!-- 底部 -->
					<div class="zodiac-footer">
						${footerContent}
					</div>
				</div>
			`;
			
			progressContainer.style.display = 'block';
		}
			
			// 渲染角色卡片
			grid.innerHTML = characters.map(char => {
				const isTrueNormalAvailable = char.id === 'normal' && !isReversedMode && trueNormalUnlocked;
				
				let data, displayIcon, displayName, displayDesc, displayBonus, displayAwaken;
				let statsCharId = char.id;
				let statsIsReversed = isReversedMode;
				
				if (isTrueNormalAvailable && isTrueNormalMode) {
					displayIcon = '🌍';  
					displayName = '真·大多数';  
					displayDesc = '经历过所有角色的洗礼，回归本真';
					displayBonus = '无特殊能力，一切靠自己';
					displayAwaken = {
						icon: '❌',
						name: '无',
						desc: '转博时没有任何觉醒效果'
					};
					data = char;
					statsCharId = 'true-normal';
					statsIsReversed = false;
				} else if (isReversedMode && char.reversed) {
					data = char.reversed;
					displayIcon = data.icon;
					displayName = data.name;
					displayDesc = data.desc;
					displayBonus = data.bonus;
					displayAwaken = {
						icon: data.awakenIcon,
						name: data.awakenName,
						desc: data.awakenDesc
					};
				} else {
					data = char;
					displayIcon = char.icon;
					displayName = char.name;
					displayDesc = char.desc;
					displayBonus = char.bonus;
					displayAwaken = {
						icon: char.awakenIcon,
						name: char.awakenName,
						desc: char.awakenDesc
					};
				}
				
				const diffKey = `${statsCharId}_${statsIsReversed ? 'reversed' : 'normal'}`;
				const diffData = characterDifficultyData[diffKey] || { stars: null, rate: null, total: 0 };
				
				// 获取本地最高记录
				const localRecord = getCharacterLocalRecord(statsCharId, statsIsReversed);
				const hasLocalRecord = localRecord.maxScore > 0;
				
				// 获取全球记录
				const mode = statsIsReversed ? 'reversed' : 'normal';
				const globalRecord = globalRecords?.[mode]?.[statsCharId] || {
					today: { maxScore: 0, maxCitations: 0, maxAchievements: 0 },
					history: { maxScore: 0, maxCitations: 0, maxAchievements: 0 }
				};
				const hasGlobalRecord = globalRecord.history.maxScore > 0;
				
				// 难度显示
				let starsHtml, badgeHtml, rateText, totalGames;
				if (statsCharId === 'true-normal') {
					starsHtml = renderDifficultyStars(12);
					badgeHtml = '<span class="difficulty-badge legendary">传说</span>';
					rateText = diffData.rate !== null ? `${(diffData.rate * 100).toFixed(1)}%` : '?';
					totalGames = diffData.total || 0;
				} else {
					starsHtml = renderDifficultyStars(diffData.stars);
					badgeHtml = getDifficultyBadge(diffData.stars);
					rateText = diffData.rate !== null ? `${(diffData.rate * 100).toFixed(1)}%` : '?';
					totalGames = diffData.total || 0;
				}
				
				const cardClass = isReversedMode ? 'character-card reversed-card' : 'character-card';
				const bonusClass = isReversedMode ? 'background:rgba(231,76,60,0.15);color:#e74c3c;' : '';
				
				const trueNormalStyle = (isTrueNormalAvailable && isTrueNormalMode) 
					? 'background:linear-gradient(135deg,rgba(255,215,0,0.15),rgba(255,140,0,0.15));border-color:rgba(255,140,0,0.5);' 
					: '';
				const trueNormalBonusStyle = (isTrueNormalAvailable && isTrueNormalMode)
					? 'background:linear-gradient(135deg,rgba(255,215,0,0.2),rgba(255,140,0,0.2));color:#d68910;'
					: bonusClass;
				
				const awakenBg = isReversedMode 
					? 'background:linear-gradient(135deg,rgba(155,89,182,0.15),rgba(231,76,60,0.15));border-color:rgba(231,76,60,0.4);' 
					: (isTrueNormalAvailable && isTrueNormalMode)
						? 'background:linear-gradient(135deg,rgba(149,165,166,0.15),rgba(127,140,141,0.15));border-color:rgba(127,140,141,0.4);'
						: 'background:linear-gradient(135deg,rgba(102,126,234,0.1),rgba(118,75,162,0.1));border-color:rgba(102,126,234,0.3);';
				const awakenColor = isReversedMode ? '#e74c3c' : (isTrueNormalAvailable && isTrueNormalMode) ? '#7f8c8d' : 'var(--primary-color)';

				let hiddenAwakenHint = '';
				if (!isReversedMode && char.hiddenAwakenName && !(isTrueNormalAvailable && isTrueNormalMode)) {
					hiddenAwakenHint = `
						<div style="margin-top:6px;padding:4px 8px;background:linear-gradient(135deg,rgba(253,203,110,0.15),rgba(243,156,18,0.15));border-radius:6px;border:1px dashed rgba(243,156,18,0.4);">
							<div style="font-size:0.6rem;color:#d68910;display:flex;align-items:center;gap:4px;">
								<span>⚙️</span>
								<span>隐藏觉醒：游戏中特定条件触发</span>
							</div>
						</div>
					`;
				}

				const metaRecordHtml = `
					<div class="meta-records" style="margin-top:8px;padding:8px;background:var(--light-bg);border-radius:8px;font-size:0.6rem;">
						<div style="margin-bottom:6px;padding-bottom:6px;border-bottom:1px dashed var(--border-color);">
							<div style="font-weight:600;color:var(--success-color);margin-bottom:4px;">👤 我的最高</div>
							${hasLocalRecord ? `
								<div style="display:flex;justify-content:space-between;color:var(--text-secondary);">
									<span>🎯${localRecord.maxScore}分</span>
									<span style="color:var(--border-color);">|</span>
									<span>📚${localRecord.maxCitations}引</span>
									<span style="color:var(--border-color);">|</span>
									<span>🏆${localRecord.maxAchievements}成就</span>
								</div>
							` : `<div style="color:var(--text-secondary);text-align:center;">暂无记录</div>`}
						</div>
						<div style="margin-bottom:6px;padding-bottom:6px;border-bottom:1px dashed var(--border-color);">
							<div style="font-weight:600;color:var(--warning-color);margin-bottom:4px;">☀️ 今日全球</div>
							${globalRecord.today.maxScore > 0 ? `
								<div style="display:flex;justify-content:space-between;color:var(--text-secondary);">
									<span>🎯${globalRecord.today.maxScore}分</span>
									<span style="color:var(--border-color);">|</span>
									<span>📚${globalRecord.today.maxCitations}引</span>
									<span style="color:var(--border-color);">|</span>
									<span>🏆${globalRecord.today.maxAchievements}成就</span>
								</div>
							` : `<div style="color:var(--text-secondary);text-align:center;">今日暂无</div>`}
						</div>
						<div>
							<div style="font-weight:600;color:var(--accent-color);margin-bottom:4px;">👑 历史全球</div>
							${hasGlobalRecord ? `
								<div style="display:flex;justify-content:space-between;color:var(--text-secondary);">
									<span>🎯${globalRecord.history.maxScore}分</span>
									<span style="color:var(--border-color);">|</span>
									<span>📚${globalRecord.history.maxCitations}引</span>
									<span style="color:var(--border-color);">|</span>
									<span>🏆${globalRecord.history.maxAchievements}成就</span>
								</div>
							` : `<div style="color:var(--text-secondary);text-align:center;">暂无记录</div>`}
						</div>
					</div>
				`;

				const difficultyNote = (statsCharId === 'true-normal') 
					? '<div style="font-size:0.5rem;color:#9b59b6;margin-top:2px;">⚠️ 固定最高难度</div>' 
					: '';

				// ★★★ 检查该卡片是否折叠 ★★★
				const cardKey = `${char.id}_${isReversedMode ? 'reversed' : 'normal'}`;
				const isCollapsed = cardCollapseStates[cardKey] || false;
				const collapsedClass = isCollapsed ? 'card-collapsed' : '';
				const bodyCollapsedClass = isCollapsed ? 'collapsed' : '';
				const iconRotatedClass = isCollapsed ? 'rotated' : '';

				return `
				<div class="${cardClass} ${collapsedClass}" data-id="${char.id}" style="${trueNormalStyle}">
					<!-- 卡片头部（可点击折叠）-->
					<div class="card-header" onclick="toggleCharacterCard('${char.id}', event)">
						<div class="header-left">
							<span style="font-size:1.5rem;">${displayIcon}</span>
							<span style="font-weight:600;font-size:1rem;">${displayName}</span>
						</div>
						<div class="mini-difficulty">
							<span style="font-size:0.6rem;color:var(--text-secondary);">${diffData.stars !== null ? diffData.stars + '★' : '?'}</span>
							${badgeHtml}
						</div>
						<i class="fas fa-chevron-down collapse-icon ${iconRotatedClass}"></i>
					</div>
					
					<!-- 卡片内容（可折叠）-->
					<div class="card-body ${bodyCollapsedClass}">
						<div class="desc">${displayDesc}</div>
						<div class="bonus" style="${trueNormalBonusStyle}">${displayBonus}</div>
						<div class="awaken-info" style="margin-top:8px;padding:6px 8px;${awakenBg}border-radius:6px;border:1px dashed;">
							<div style="font-size:0.65rem;color:${awakenColor};font-weight:600;margin-bottom:2px;">
								<span style="margin-right:3px;">⚡</span>转博觉醒: ${displayAwaken.icon} ${displayAwaken.name}
							</div>
							<div style="font-size:0.6rem;color:var(--text-secondary);">${displayAwaken.desc}</div>
							${hiddenAwakenHint}
						</div>
						${metaRecordHtml}
						<div class="difficulty-container">
							<div>
								<span class="difficulty-label">难度</span>
								<div class="difficulty-stars">${starsHtml}</div>
								${difficultyNote}
							</div>
							<div style="text-align:right;">
								${badgeHtml}
								<div style="font-size:0.55rem;color:var(--text-secondary);margin-top:2px;">
									博士率:${rateText} (${totalGames}局)
								</div>
							</div>
						</div>
					</div>
				</div>
			`}).join('');
			
			// ★★★ 为卡片添加点击选择功能（排除折叠按钮区域）★★★
			document.querySelectorAll('.character-card').forEach(card => {
				card.addEventListener('click', function(e) {
					// 如果点击的是折叠按钮区域，不触发选择
					if (e.target.closest('.card-header')) return;
					selectCharacter(this.dataset.id);
				});
			});
		}

		// ==================== 角色卡片折叠状态 ====================

		function getCharacterCardCollapseStates() {
			try {
				const saved = localStorage.getItem('graduateSimulator_cardCollapseStates');
				return saved ? JSON.parse(saved) : {};
			} catch (e) {
				return {};
			}
		}

		function saveCharacterCardCollapseStates(states) {
			try {
				localStorage.setItem('graduateSimulator_cardCollapseStates', JSON.stringify(states));
			} catch (e) {
				console.warn('保存卡片折叠状态失败:', e);
			}
		}

		function toggleCharacterCard(charId, event) {
			event.stopPropagation(); // 阻止冒泡，避免触发选择
			
			const cardKey = `${charId}_${isReversedMode ? 'reversed' : 'normal'}`;
			const states = getCharacterCardCollapseStates();
			
			states[cardKey] = !states[cardKey];
			saveCharacterCardCollapseStates(states);
			
			// 找到对应卡片并切换状态
			const card = document.querySelector(`.character-card[data-id="${charId}"]`);
			if (card) {
				const body = card.querySelector('.card-body');
				const icon = card.querySelector('.card-header .collapse-icon');
				
				if (states[cardKey]) {
					card.classList.add('card-collapsed');
					body.classList.add('collapsed');
					icon.classList.add('rotated');
				} else {
					card.classList.remove('card-collapsed');
					body.classList.remove('collapsed');
					icon.classList.remove('rotated');
				}
			}
		}

		// 全部展开/收起角色卡片
		function toggleAllCharacterCards(collapse) {
			const states = getCharacterCardCollapseStates();
			const mode = isReversedMode ? 'reversed' : 'normal';
			
			characters.forEach(char => {
				const cardKey = `${char.id}_${mode}`;
				states[cardKey] = collapse;
			});
			
			saveCharacterCardCollapseStates(states);
			renderCharacterGrid();
		}

		// 切换真·大多数模式
		function toggleTrueNormalMode() {
			isTrueNormalMode = !isTrueNormalMode;
			renderCharacterGrid();
			
			if (isTrueNormalMode) {
				// ★★★ 修复：开启真·大多数模式时，自动选中 normal 角色 ★★★
				setTimeout(() => selectCharacter('normal'), 50);
			} else {
				// 关闭真·大多数模式时，如果之前选中的是 normal，重新选中以更新样式
				if (selectedCharacter && selectedCharacter.id === 'normal') {
					setTimeout(() => selectCharacter('normal'), 50);
				}
			}
		}

		function selectCharacter(id) {
			selectedCharacter = characters.find(c => c.id === id);
			
			// ★★★ 修复：如果在真·大多数模式下选择了其他角色，关闭真·大多数模式 ★★★
			if (isTrueNormalMode && id !== 'normal') {
				isTrueNormalMode = false;
				renderCharacterGrid();  // 重新渲染以更新真·大多数面板状态
			}
			
			document.querySelectorAll('.character-card').forEach(card => {
				card.classList.toggle('selected', card.dataset.id === id);
			});
			document.getElementById('start-btn').disabled = false;
		}

		async function startGame() {
			if (!selectedCharacter) return;

			gameState = getInitialState();
			
			resetAchievementShop();
			const achievementCount = getPlayerAchievementCount();
			gameState.achievementCoins = achievementCount;

			if (achievementCount > 0) {
				addLog('成就系统', '获得成就币', `基于历史${achievementCount}个成就，获得${achievementCount}成就币`);
			}			
			// ★★★ 修复：真·大多数使用独立的角色ID ★★★
			gameState.isTrueNormal = (selectedCharacter.id === 'normal' && !isReversedMode && isTrueNormalMode);
			gameState.character = gameState.isTrueNormal ? 'true-normal' : selectedCharacter.id;
			gameState.isReversed = isReversedMode;

			// 真·大多数没有初始加成
			if (!gameState.isTrueNormal) {
				const charData = isReversedMode && selectedCharacter.reversed 
					? selectedCharacter.reversed 
					: selectedCharacter;
				
				gameState.characterName = charData.name;

				if (charData.stats.research) gameState.research += charData.stats.research;
				if (charData.stats.social) gameState.social += charData.stats.social;
				if (charData.stats.favor) gameState.favor += charData.stats.favor;
				if (charData.stats.gold) gameState.gold += charData.stats.gold;

				if (isReversedMode) {
					initReversedCharacter();
				}
			} else {
				gameState.characterName = '真·大多数';
			}

			shopItems.forEach(item => {
				if (item.once) item.bought = false;
				if (item.monthlyOnce) item.boughtThisMonth = false;
			});

			resetRandomEventPool();
			
			if(gameState.publishedPapers.length === 0) {
				gameState.availableRandomEvents = gameState.availableRandomEvents.filter(e => e !== 14);
			}

			// ★★★ 修改：先使用默认值，立即显示游戏界面 ★★★
			gameState.submissionStats = getDefaultSubmissionStats();

			// ★★★ 先切换界面，不要等待数据加载 ★★★
			document.getElementById('start-screen').classList.add('hidden');
			document.getElementById('game-screen').style.display = 'block';
			document.getElementById('mobile-quick-bar').classList.add('game-active');

			document.getElementById('log-content').innerHTML = '';
			checkResearchUnlock(true);
			updateAllUI();
			renderPaperSlots();

			addLog('游戏开始', `欢迎来到研究生模拟器！你选择了【${gameState.characterName}】`);
			
			if (isReversedMode) {
				addLog('⚠️ 逆位模式', '命运的阴暗面已开启，规则将有所不同...');
			}
			
			addLog('游戏目标', '硕士毕业需要科研分≥1，博士毕业需要科研分≥7');
			addLog('游戏提示', '论文科研分：A类=4分，B类=2分，C类=1分');
			addLog('操作提示', '每月可执行一次持续操作（看论文/打工/想idea/做实验/写论文）');
			addLog('属性提示', '科研能力影响论文分数，社交能力和导师好感度影响事件走向，建议优先提升至6');
			
			setTimeout(() => {
				applyCollapseStates();
			}, 100);

			// ★★★ 修改：后台异步加载投稿统计，带超时机制 ★★★
			loadSubmissionStatsAsync();
		}

		// ==================== 简化后的异步加载 ====================
		async function loadSubmissionStatsAsync(retryCount = 0) {
			const maxRetries = 2;
			const timeout = 5000;
			
			try {
				const timeoutPromise = new Promise((_, reject) => {
					setTimeout(() => reject(new Error('加载超时')), timeout);
				});
				
				const loadPromise = loadSubmissionStats();
				const stats = await Promise.race([loadPromise, timeoutPromise]);
				
				if (stats && Object.keys(stats).length > 0) {
					gameState.submissionStats = stats;
					console.log('✅ 投稿统计已加载');
					renderPaperSlots();
					updateResearchResults();
				} else {
					throw new Error('返回数据为空');
				}
			} catch (e) {
				console.warn(`加载投稿统计失败(第${retryCount + 1}次):`, e.message);
				
				if (retryCount < maxRetries) {
					setTimeout(() => loadSubmissionStatsAsync(retryCount + 1), 2000);
				} else {
					console.warn('使用默认投稿统计');
					if (!gameState.submissionStats) {
						gameState.submissionStats = getDefaultSubmissionStats();
					}
					renderPaperSlots();
				}
			}
		}

        // ★★★ 关键修改：逆位角色初始化 ★★★
        function initReversedCharacter() {
            switch (gameState.character) {
                case 'genius':
                    gameState.research = 0;
                    gameState.paperSlots = 4;
                    addLog('逆位效果', '愚钝之《院士转世》', '科研能力固定为0，全部论文槽已解锁');
                    break;
                    
				case 'rich':
					// ★★★ 修改：重置为1而不是0 ★★★
					gameState.san = 1;
					gameState.research = 1;
					gameState.social = 1;
					gameState.favor = 1;
					gameState.goldSpentTotal = 0;
					gameState.lastResetMonth = 0;
					addLog('逆位效果', '贪求之《富可敌国》', 
						 '除了钱一无所有，每月属性重置为1，金钱+3');
					break;
                    
				case 'teacher-child':
					// ★★★ 新能力：好感不会低于0，归零时重置 ★★★
					// 初始好感度已在角色stats中设置为9（+基础1=10）
					addLog('逆位效果', '玩世之《导师子女》', 
						 '好感度不会低于0，归零时重置为4并获得奖励');
					break;
                    
                case 'social':
                    // 保持原有效果
                    break;
                    
                case 'chosen':
                    // 保持原有效果
                    break;
                    
                case 'normal':
                    // 保持原有效果
                    break;
            }
        }

        function resetRandomEventPool() {
            gameState.availableRandomEvents = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 12, 13, 15];
            if(gameState.publishedPapers.length > 0) {
                gameState.availableRandomEvents.push(14);
            }
            gameState.usedRandomEvents = [];
        }

        // ==================== 通用属性修改函数（支持逆位）====================
        // 计算实际SAN变化值（考虑怠惰之大多数的翻倍效果）
        function getActualSanChange(delta) {
            if (gameState.isReversed && gameState.character === 'normal' && delta < 0) {
                const multiplier = gameState.reversedAwakened ? 3 : 2;
                return delta * multiplier;
            }
            return delta;
        }
        
        function changeSan(delta) {
            if (gameState.isReversed && gameState.character === 'normal' && delta < 0) {
                const multiplier = gameState.reversedAwakened ? 3 : 2;
                delta = delta * multiplier;
            }
            
            if (delta > 0) {
                gameState.san = Math.min(gameState.sanMax, gameState.san + delta);
            } else {
                gameState.san += delta;
            }
            updateAllUI();
            if (gameState.san < 0) {
                triggerEnding('burnout');
                return false;
            }
            return true;
        }

        // ★★★ 关键修改：changeGold函数 ★★★
		function changeGold(delta) {
			// ★★★ 修改：贪求之富可敌国觉醒后每花费4金币属性各+1 ★★★
			if (gameState.isReversed && gameState.character === 'rich' && gameState.reversedAwakened && delta < 0) {
				const spent = Math.abs(delta);
				gameState.goldSpentTotal = (gameState.goldSpentTotal || 0) + spent;
				
				// ★★★ 修改：每消费4金币，SAN/科研/社交/好感各+1 ★★★
				const attributeGains = Math.floor(gameState.goldSpentTotal / 4);
				const previousGains = Math.floor((gameState.goldSpentTotal - spent) / 4);
				const newGains = attributeGains - previousGains;
				
				if (newGains > 0) {
					gameState.san = Math.min(gameState.sanMax, gameState.san + newGains);
					gameState.research = Math.min(20, gameState.research + newGains);
					gameState.social = Math.min(20, gameState.social + newGains);
					gameState.favor = Math.min(20, gameState.favor + newGains);
					addLog('逆位效果', '金钱觉醒', `累计消费${gameState.goldSpentTotal}金 → SAN+${newGains}, 科研+${newGains}, 社交+${newGains}, 好感+${newGains}`);
				}
			}
			
			gameState.gold += delta;
			updateAllUI();
			if (gameState.gold < 0) {
				triggerEnding('poor');
				return false;
			}
			return true;
		}

		function changeFavor(delta) {
			const favorMax = gameState.favorMax || 20;
			
			// ★★★ 玩世之导师子女：全新能力 - 好感不会低于0，归零时重置 ★★★
			if (gameState.isReversed && gameState.character === 'teacher-child') {
				// 正常应用好感度变化（不反转）
				if (delta > 0) {
					gameState.favor = Math.min(favorMax, gameState.favor + delta);
				} else {
					gameState.favor += delta;
				}
				
				// 好感度归零检测
				if (gameState.favor <= 0) {
					if (gameState.reversedAwakened) {
						// 觉醒后：重置为2，社交+1，科研+1，金币+2
						gameState.favor = 2;
						gameState.social = Math.min(gameState.socialMax || 20, gameState.social + 1);
						gameState.research = Math.min(gameState.researchMax || 20, gameState.research + 1);
						gameState.gold += 2;
						addLog('逆位效果', '变本加厉（觉醒）', `好感度归零，重置为2 → 社交+1, 科研+1, 金币+2`);
					} else {
						// 未觉醒：重置为4，社交+1，科研+1，金币+2
						gameState.favor = 4;
						gameState.social = Math.min(gameState.socialMax || 20, gameState.social + 1);
						gameState.research = Math.min(gameState.researchMax || 20, gameState.research + 1);
						gameState.gold += 2;
						addLog('逆位效果', '变本加厉', `好感度归零，重置为4 → 社交+1, 科研+1, 金币+2`);
					}
				}
				
				updateAllUI();
				// 玩世之导师子女不会因好感度触发退学
				return true;
			}
			
			// 非导师子女的原有逻辑
			if (delta > 0) {
				gameState.favor = Math.min(favorMax, gameState.favor + delta);
			} else {
				gameState.favor += delta;
			}
			
			updateAllUI();
			if (gameState.favor < 0) {
				triggerEnding('expelled');
				return false;
			}
			return true;
		}

		function changeResearch(delta) {
			// 愚钝之院士转世：科研能力固定为0
			if (gameState.isReversed && gameState.character === 'genius') {
				if (delta > 0) {
					gameState.blockedResearchGains += delta;
					if (gameState.reversedAwakened) {
						// ★★★ 修改：觉醒后金+8，SAN+8，社交+2，好感+2 ★★★
						const sanGain = delta * 8;
						const goldGain = delta * 8;
						const favorGain = delta * 2;
						const socialGain = delta * 2;
						gameState.san = Math.min(gameState.sanMax, gameState.san + sanGain);
						gameState.gold += goldGain;
						gameState.favor = Math.min(20, gameState.favor + favorGain);
						gameState.social = Math.min(20, gameState.social + socialGain);
						addLog('逆位效果', '大智若愚', `科研提升被转化 → SAN+${sanGain}, 金+${goldGain}, 好感+${favorGain}, 社交+${socialGain}`);
					} else {
						// ★★★ 修改：未觉醒时金+4，SAN+4，社交+1，好感+1 ★★★
						const sanGain = delta * 4;
						const goldGain = delta * 4;
						const socialGain = delta * 1;
						const favorGain = delta * 1;
						gameState.san = Math.min(gameState.sanMax, gameState.san + sanGain);
						gameState.gold += goldGain;
						gameState.social = Math.min(20, gameState.social + socialGain);
						gameState.favor = Math.min(20, gameState.favor + favorGain);
						addLog('逆位效果', '愚钝转化', `科研提升被转化 → SAN+${sanGain}, 金+${goldGain}, 社交+${socialGain}, 好感+${favorGain}`);
					}
				}
				gameState.research = 0;
				updateAllUI();
				return true;
			}
            
			if (delta > 0) {
				// ★★★ 修改：使用动态上限 ★★★
				const maxResearch = gameState.researchMax || 20;
				gameState.research = Math.min(maxResearch, gameState.research + delta);
				checkResearchUnlock();
			} else {
				gameState.research = Math.max(0, gameState.research + delta);
			}
			updateAllUI();
			return true;
		}

		function changeSocial(delta) {
			const oldSocial = gameState.social;
			const socialMax = gameState.socialMax || 20;

			if (delta > 0) {
				gameState.social = Math.min(socialMax, gameState.social + delta);
			} else {
				gameState.social += delta;
			}

			// 检查社交能力是否为负数
			if (gameState.social < 0) {
				triggerEnding('isolated'); // 触发“被孤立”结局
				return false;
			}

			// 其他逻辑（如逆位角色的效果）
			if (gameState.isReversed && gameState.character === 'social') {
				const change = gameState.social - oldSocial;
				if (change < 0) {
					const amount = Math.abs(change);
					changeResearch(amount);
					gameState.favor = Math.min(gameState.favorMax || 20, gameState.favor + amount);
					addLog('逆位效果', '嫉妒转化', `社交-${amount} → 科研+${amount}, 好感+${amount}`);
				} else if (change > 0) {
					gameState.san = Math.min(gameState.sanMax, gameState.san + change);
					gameState.gold += change;
					addLog('逆位效果', '嫉妒反馈', `社交+${change} → SAN+${change}, 金钱+${change}`);
				}
			}

			updateAllUI();
			return true;
		}


        // ★★★ 关键修改：changeStats函数 ★★★
        function changeStats(changes) {
            let gameOver = false;
            
            if (changes.sanMax) gameState.sanMax += changes.sanMax;
            
            if (changes.san) {
                let sanDelta = changes.san;
                if (gameState.isReversed && gameState.character === 'normal' && sanDelta < 0) {
                    const multiplier = gameState.reversedAwakened ? 3 : 2;
                    sanDelta = sanDelta * multiplier;
                }
                
                if (sanDelta > 0) {
                    gameState.san = Math.min(gameState.sanMax, gameState.san + sanDelta);
                } else {
                    gameState.san += sanDelta;
                }
                if (gameState.san < 0) gameOver = 'burnout';
            }
            
			if (changes.gold) {
				// ★★★ 修改：贪求之富可敌国觉醒后每花费4金币属性各+1 ★★★
				if (gameState.isReversed && gameState.character === 'rich' && gameState.reversedAwakened && changes.gold < 0) {
					const spent = Math.abs(changes.gold);
					gameState.goldSpentTotal = (gameState.goldSpentTotal || 0) + spent;
					
					// ★★★ 修改：6改为4 ★★★
					const attributeGains = Math.floor(gameState.goldSpentTotal / 4);
					const previousGains = Math.floor((gameState.goldSpentTotal - spent) / 4);
					const newGains = attributeGains - previousGains;
					
					if (newGains > 0) {
						gameState.san = Math.min(gameState.sanMax, gameState.san + newGains);
						gameState.research = Math.min(20, gameState.research + newGains);
						gameState.social = Math.min(20, gameState.social + newGains);
						gameState.favor = Math.min(20, gameState.favor + newGains);
						addLog('逆位效果', '金钱觉醒', `累计消费${gameState.goldSpentTotal}金 → SAN+${newGains}, 科研+${newGains}, 社交+${newGains}, 好感+${newGains}`);
					}
				}
				gameState.gold += changes.gold;
				if (gameState.gold < 0 && !gameOver) gameOver = 'poor';
			}
            
			if (changes.favor) {
				const favorMax = gameState.favorMax || 20;
				
				// ★★★ 玩世之导师子女：全新能力 ★★★
				if (gameState.isReversed && gameState.character === 'teacher-child') {
					if (changes.favor > 0) {
						gameState.favor = Math.min(favorMax, gameState.favor + changes.favor);
					} else {
						gameState.favor += changes.favor;
					}
					
					// ✅ 添加归零条件判断
					if (gameState.favor <= 0) {
						if (gameState.reversedAwakened) {
							gameState.favor = 2;
							gameState.social = Math.min(gameState.socialMax || 20, gameState.social + 1);
							gameState.research = Math.min(gameState.researchMax || 20, gameState.research + 1);
							gameState.gold += 2;
							addLog('逆位效果', '变本加厉（觉醒）', `好感度归零，重置为2 → 社交+1, 科研+1, 金币+2`);
						} else {
							gameState.favor = 4;
							gameState.social = Math.min(gameState.socialMax || 20, gameState.social + 1);
							gameState.research = Math.min(gameState.researchMax || 20, gameState.research + 1);
							gameState.gold += 2;
							addLog('逆位效果', '变本加厉', `好感度归零，重置为4 → 社交+1, 科研+1, 金币+2`);
						}
					}
					// 玩世之导师子女不会因好感度触发退学
				} else {
					// 非导师子女的原有逻辑
					if (changes.favor > 0) {
						gameState.favor = Math.min(favorMax, gameState.favor + changes.favor);
					} else {
						gameState.favor += changes.favor;
					}
					if (gameState.favor < 0 && !gameOver) gameOver = 'expelled';
				}
			}
            
			if (changes.research) {
				if (gameState.isReversed && gameState.character === 'genius') {
					if (changes.research > 0) {
						gameState.blockedResearchGains += changes.research;
						// ★★★ 修改：觉醒后8倍，未觉醒4倍 ★★★
						const sanGain = changes.research * (gameState.reversedAwakened ? 8 : 4);
						const goldGain = changes.research * (gameState.reversedAwakened ? 8 : 4);
						gameState.san = Math.min(gameState.sanMax, gameState.san + sanGain);
						gameState.gold += goldGain;
						// ★★★ 修改：未觉醒也有社交和好感加成 ★★★
						if (gameState.reversedAwakened) {
							gameState.favor = Math.min(20, gameState.favor + changes.research * 2);
							gameState.social = Math.min(20, gameState.social + changes.research * 2);
						} else {
							gameState.favor = Math.min(20, gameState.favor + changes.research * 1);
							gameState.social = Math.min(20, gameState.social + changes.research * 1);
						}
					}
					gameState.research = 0;
				} else {
                    if (changes.research > 0) {
                        gameState.research = Math.min(20, gameState.research + changes.research);
                        checkResearchUnlock();
                    } else {
                        gameState.research = Math.max(0, gameState.research + changes.research);
                    }
                }
            }
            
			if (changes.social) {
				const oldSocial = gameState.social;
				const socialMax = gameState.socialMax || 20;  // ★★★ 新增 ★★★
				if (changes.social > 0) {
					gameState.social = Math.min(socialMax, gameState.social + changes.social);  // ★★★ 修改 ★★★
				} else {
					gameState.social = Math.max(0, gameState.social + changes.social);
				}
				
				// 嫉妒之社交达人
				if (gameState.isReversed && gameState.character === 'social') {
					const change = gameState.social - oldSocial;
					if (change < 0) {
						const amount = Math.abs(change);
						changeResearch(amount);
						gameState.favor = Math.min(gameState.favorMax || 20, gameState.favor + amount);  // ★★★ 修改 ★★★
						addLog('逆位效果', '嫉妒转化', `社交-${amount} → 科研+${amount}, 好感+${amount}`);
					} else if (change > 0) {
						gameState.san = Math.min(gameState.sanMax, gameState.san + change);
						gameState.gold += change;
						addLog('逆位效果', '嫉妒反馈', `社交+${change} → SAN+${change}, 金钱+${change}`);
					}
				}
			}
            
            updateAllUI();
            
            if (gameOver) {
                triggerEnding(gameOver);
                return false;
            }
            return true;
        }
		
        // ==================== UI更新 ====================
        function updateAllUI() {
            updateAttributes();
            updateGraduation();
            updateBuffs();
            updateResearchResults();
            updateActionButtons();
            updateEventPreview();
        }

		function updateAttributes() {
			document.getElementById('san-value').textContent = gameState.san;
			document.getElementById('san-max').textContent = gameState.sanMax;
			document.getElementById('san-bar').style.width = `${Math.max(0, (gameState.san / gameState.sanMax) * 100)}%`;

			const researchMax = gameState.researchMax || 20;
			document.getElementById('research-value').textContent = gameState.research;
			document.getElementById('research-max').textContent = researchMax;
			document.getElementById('research-bar').style.width = `${(gameState.research / researchMax) * 100}%`;

			// ★★★ 修改：支持动态社交上限 ★★★
			const socialMax = gameState.socialMax || 20;
			document.getElementById('social-value').textContent = gameState.social;
			// 需要在HTML中添加social-max元素，或者修改显示方式
			const socialValueEl = document.querySelector('#attributes-panel .attribute-bar:nth-child(4) .value');
			if (socialValueEl) {
				socialValueEl.innerHTML = `<span id="social-value">${gameState.social}</span>/${socialMax}`;
			}
			document.getElementById('social-bar').style.width = `${(gameState.social / socialMax) * 100}%`;

			// ★★★ 修改：支持动态好感上限 ★★★
			const favorMax = gameState.favorMax || 20;
			document.getElementById('favor-value').textContent = gameState.favor;
			const favorValueEl = document.querySelector('#attributes-panel .attribute-bar:nth-child(5) .value');
			if (favorValueEl) {
				favorValueEl.innerHTML = `<span id="favor-value">${gameState.favor}</span>/${favorMax}`;
			}
			document.getElementById('favor-bar').style.width = `${Math.max(0, (gameState.favor / favorMax) * 100)}%`;

			document.getElementById('gold-value').textContent = gameState.gold;
			updateCharacterDisplay();
			
			const achievementCoinsDisplay = document.getElementById('achievement-coins-display');
			if (achievementCoinsDisplay) {
				achievementCoinsDisplay.textContent = gameState.achievementCoins || 0;
			}
		}

		function updateCharacterDisplay() {
			// ★★★ 修复：先检查真·大多数 ★★★
			if (gameState.isTrueNormal) {
				document.getElementById('char-icon').textContent = '🌍';
				document.getElementById('char-name').textContent = '真·大多数';
				
				const modeEl = document.getElementById('char-mode');
				modeEl.textContent = '✨ 真实';
				modeEl.className = 'char-mode normal-mode';
				modeEl.style.background = 'linear-gradient(135deg,rgba(255,215,0,0.3),rgba(255,140,0,0.3))';
				modeEl.style.color = '#d68910';
				return;
			}
			
			// 然后再查找普通角色
			const charData = characters.find(c => c.id === gameState.character);
			if (!charData) return;
			
			const displayData = gameState.isReversed && charData.reversed ? charData.reversed : charData;
			const isAwakened = gameState.reversedAwakened || (gameState.degree === 'phd' && !gameState.isReversed);
			
			const icon = isAwakened
				? (gameState.isReversed ? displayData.awakenIcon : charData.awakenIcon)
				: displayData.icon;
			
			document.getElementById('char-icon').textContent = icon;
			document.getElementById('char-name').textContent = displayData.name;
			
			const modeEl = document.getElementById('char-mode');
			modeEl.style.background = '';  // 重置样式
			modeEl.style.color = '';
			if (gameState.isReversed) {
				modeEl.textContent = '🌑 逆位';
				modeEl.className = 'char-mode reversed-mode';
			} else {
				modeEl.textContent = '☀️ 正位';
				modeEl.className = 'char-mode normal-mode';
			}
		}

		function showCharacterDetail() {
			// ★★★ 修复：真·大多数特殊处理 ★★★
			if (gameState.character === 'true-normal' || gameState.isTrueNormal) {
				const html = `
					<div style="text-align:center;margin-bottom:15px;">
						<div style="font-size:3rem;margin-bottom:8px;">🌍</div>
						<div style="font-size:1.2rem;font-weight:700;color:#d68910;">真·大多数</div>
						<div style="font-size:0.8rem;color:var(--text-secondary);margin-top:4px;">✨ 真实模式</div>
					</div>
					
					<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:10px;">
						<div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:5px;">📜 角色描述</div>
						<div style="font-size:0.85rem;">经历过所有角色的洗礼，回归本真</div>
					</div>
					
					<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:10px;">
						<div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:5px;">✨ 初始效果</div>
						<div style="font-size:0.85rem;color:var(--text-secondary);font-weight:500;">无特殊能力，一切靠自己</div>
					</div>
					
					<div style="background:rgba(149,165,166,0.15);border-radius:10px;padding:12px;border:1px dashed #7f8c8d;">
						<div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:5px;">⚡ 转博觉醒</div>
						<div style="display:flex;align-items:center;gap:8px;margin-bottom:5px;">
							<span style="font-size:1.2rem;">❌</span>
							<span style="font-size:0.9rem;font-weight:600;color:#7f8c8d;">无觉醒效果</span>
						</div>
						<div style="font-size:0.85rem;">转博时没有任何特殊效果，这就是最真实的研究生生活</div>
						<div style="margin-top:6px;font-size:0.7rem;color:var(--text-secondary);">未激活 - 转博时触发（无效果）</div>
					</div>
				`;
				
				showModal('👤 角色详情', html, [{ text: '关闭', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			const charData = characters.find(c => c.id === gameState.character);
			if (!charData) {
				console.error('无法找到角色数据:', gameState.character);
				showModal('❌ 错误', '<p>角色数据加载失败</p>', 
					[{ text: '确定', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			const isReversed = gameState.isReversed;
			const displayData = isReversed && charData.reversed ? charData.reversed : charData;
			
			// ★★★ 新增：判断是否触发了隐藏觉醒 ★★★
			const hasHiddenAwaken = gameState.hiddenAwakened && !isReversed;
			const isAwakened = gameState.reversedAwakened || (gameState.degree === 'phd' && !isReversed) || hasHiddenAwaken;
			
			// ★★★ 修改：根据觉醒类型显示不同图标 ★★★
			let currentIcon;
			if (hasHiddenAwaken) {
				currentIcon = charData.hiddenAwakenIcon;
			} else if (isAwakened) {
				currentIcon = isReversed ? displayData.awakenIcon : charData.awakenIcon;
			} else {
				currentIcon = displayData.icon;
			}
			
			const modeColor = isReversed ? '#9b59b6' : '#6c5ce7';
			const modeText = isReversed ? '🌑 逆位模式' : '☀️ 正位模式';
			
			// ★★★ 新增：根据觉醒类型显示不同的觉醒信息 ★★★
			let awakenIcon, awakenName, awakenDesc, awakenActivated;
			if (hasHiddenAwaken) {
				awakenIcon = charData.hiddenAwakenIcon;
				awakenName = charData.hiddenAwakenName;
				awakenDesc = charData.hiddenAwakenDesc;
				awakenActivated = true;
			} else {
				awakenIcon = isReversed ? displayData.awakenIcon : charData.awakenIcon;
				awakenName = isReversed ? displayData.awakenName : charData.awakenName;
				awakenDesc = isReversed ? displayData.awakenDesc : charData.awakenDesc;
				awakenActivated = gameState.reversedAwakened || (gameState.degree === 'phd' && !isReversed);
			}
			
			let html = `
				<div style="text-align:center;margin-bottom:15px;">
					<div style="font-size:3rem;margin-bottom:8px;">${currentIcon}</div>
					<div style="font-size:1.2rem;font-weight:700;color:${modeColor};">${displayData.name}</div>
					<div style="font-size:0.8rem;color:var(--text-secondary);margin-top:4px;">${modeText}</div>
					${isAwakened ? `<div style="margin-top:6px;"><span style="padding:3px 10px;background:linear-gradient(135deg,${hasHiddenAwaken ? '#f39c12,#e67e22' : '#f39c12,#e74c3c'});color:white;border-radius:12px;font-size:0.75rem;">⚡ ${hasHiddenAwaken ? '隐藏觉醒' : '已觉醒'}</span></div>` : ''}
				</div>
				
				<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:10px;">
					<div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:5px;">📜 角色描述</div>
					<div style="font-size:0.85rem;">${displayData.desc}</div>
				</div>
				
				<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:10px;">
					<div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:5px;">✨ 初始效果</div>
					<div style="font-size:0.85rem;color:var(--success-color);font-weight:500;">${displayData.bonus}</div>
				</div>
				
				<div style="background:${hasHiddenAwaken ? 'linear-gradient(135deg,rgba(243,156,18,0.15),rgba(230,126,34,0.15))' : (isReversed ? 'rgba(155,89,182,0.1)' : 'rgba(102,126,234,0.1)')};border-radius:10px;padding:12px;border:1px dashed ${hasHiddenAwaken ? '#f39c12' : modeColor};">
					<div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:5px;">⚡ ${hasHiddenAwaken ? '隐藏觉醒' : '转博觉醒'}: ${awakenName}</div>
					<div style="display:flex;align-items:center;gap:8px;margin-bottom:5px;">
						<span style="font-size:1.2rem;">${awakenIcon}</span>
						<span style="font-size:0.9rem;font-weight:600;color:${hasHiddenAwaken ? '#f39c12' : modeColor};">${awakenName}</span>
					</div>
					<div style="font-size:0.85rem;">${awakenDesc}</div>
					${awakenActivated ? '<div style="margin-top:6px;font-size:0.7rem;color:var(--success-color);">✓ 已激活</div>' : '<div style="margin-top:6px;font-size:0.7rem;color:var(--text-secondary);">未激活 - 转博时触发</div>'}
				</div>
			`;
			
			showModal('👤 角色详情', html, [{ text: '关闭', class: 'btn-primary', action: closeModal }]);
		}

        function updateGraduation() {
            document.getElementById('current-year').textContent = gameState.year;
            document.getElementById('current-month').textContent = gameState.month;
            const remaining = (gameState.maxYears * 12) - gameState.totalMonths;
            document.getElementById('remaining-time').textContent = remaining;
            document.getElementById('graduation-target').textContent = 
                gameState.degree === 'master' ? '🎯 硕士：科研分≥1' : '🎯 博士：科研分≥7';
        }

		function updateBuffs() {
			const list = document.getElementById('buff-list');
			const allBuffs = [...gameState.buffs.permanent, ...gameState.buffs.temporary];
			
			if (!gameState.triggeredBuffTypes) {
				gameState.triggeredBuffTypes = [];
			}
			allBuffs.forEach(buff => {
				if (buff.type && !gameState.triggeredBuffTypes.includes(buff.type)) {
					gameState.triggeredBuffTypes.push(buff.type);
				}
			});
			
			if (gameState.hasLover) {
				const loverBuffName = gameState.loverType === 'beautiful' 
					? '💕恋人(SAN+3,金-1)' 
					: '💕聪慧恋人(金-1)';
				allBuffs.push({ type: 'lover', name: loverBuffName, permanent: true, isLove: true });
			}
			
			if (gameState.ailabInternship) {
				const sanCost = gameState.isReversed && gameState.character === 'normal' 
					? (gameState.reversedAwakened ? 9 : 6) 
					: 3;
				allBuffs.push({ 
					type: 'internship', 
					name: `🏢AILab实习(金+2,SAN-${sanCost})`, 
					permanent: true, 
					isInternship: true 
				});
			}
			
			if (allBuffs.length === 0) {
				list.innerHTML = '<span style="color:var(--text-secondary);font-size:0.8rem;">暂无效果</span>';
				return;
			}
			
			// ★★★ 定义负面debuff类型（需要单独显示，不合并）★★★
			const negativeDebuffTypes = [
				'idea_exhaustion',      // 灵感枯竭
				'exp_overheat',         // 主机发烫
				'write_block',          // 无从下笔
				'slack_debuff',         // 松懈
				'idea_stolen'           // 被偷idea
			];
			
			// ★★★ 定义正面订阅buff类型（需要单独显示，不合并）★★★
			const subscriptionBuffTypes = [
				'idea_san_reduce',      // Gemini订阅
				'exp_san_reduce',       // GPT订阅
				'write_san_reduce_temp' // Claude订阅
			];
			
			// ★★★ 定义debuff类型的显示名称 ★★★
			const specialBuffNames = {
				// 负面debuff
				'idea_exhaustion': '💫 灵感枯竭：下次想idea总分÷2',
				'exp_overheat': '🔥 主机发烫：下次做实验总分÷2',
				'write_block': '✏️ 无从下笔：下次写论文总分÷2',
				'slack_debuff': '😴 松懈：下月所有操作总分÷2',
				'idea_stolen': '😈 被偷idea：下次想idea总分÷2',
				// 正面订阅buff
				'idea_san_reduce': '🤖 Gemini：本月想idea SAN-1,分+4',
				'exp_san_reduce': '🤖 GPT：本月做实验 SAN-1,分+4',
				'write_san_reduce_temp': '🤖 Claude：本月写论文 SAN-1,分+4'
			};
			
			const mergedMap = {};
			const specialBuffs = [];  // 单独存放特殊buff/debuff
			
			allBuffs.forEach(buff => {
				if (buff.isLove) {
					mergedMap['lover'] = buff;
					return;
				}
				if (buff.isInternship) {
					mergedMap['internship'] = buff;
					return;
				}
				if (buff.type === 'mentorship') {
					mergedMap['mentorship'] = buff;
					return;
				}
				
				// ★★★ 负面debuff单独处理 ★★★
				if (negativeDebuffTypes.includes(buff.type)) {
					specialBuffs.push({
						name: specialBuffNames[buff.type] || buff.name,
						permanent: false,
						isLove: false,
						isDebuff: true,
						isSpecialDebuff: true
					});
					return;
				}
				
				// ★★★ 订阅buff单独处理（正面效果）★★★
				if (subscriptionBuffTypes.includes(buff.type)) {
					// 检查是否已经添加过（避免重复显示）
					const alreadyAdded = specialBuffs.some(b => b.subscriptionType === buff.type);
					if (!alreadyAdded) {
						specialBuffs.push({
							name: specialBuffNames[buff.type] || buff.name,
							permanent: false,
							isLove: false,
							isDebuff: false,
							isSubscription: true,  // ★★★ 标记为订阅buff ★★★
							subscriptionType: buff.type
						});
					}
					return;
				}
				
				const key = `${buff.type}_${buff.multiply ? 'mul' : 'add'}_${buff.permanent ? 'perm' : 'temp'}`;
				
				if (mergedMap[key]) {
					if (buff.multiply) {
						mergedMap[key].value += (buff.value - 1);
					} else {
						mergedMap[key].value += buff.value;
					}
				} else {
					mergedMap[key] = { ...buff };
				}
				
				if (buff.multiply && mergedMap[key].value < 0) {
					mergedMap[key].value = 0;
				}
			});
			
			const merged = Object.values(mergedMap).map(buff => {
				if (buff.isLove) {
					return { name: buff.name, permanent: true, isLove: true, isDebuff: false };
				}
				if (buff.isInternship) {
					return { name: buff.name, permanent: true, isInternship: true, isDebuff: false };
				}
				if (buff.type === 'mentorship') {
					return { 
						name: buff.name, 
						desc: buff.desc,
						permanent: true, 
						isLove: false, 
						isDebuff: false,
						isMentorship: true 
					};
				}
				
				let name = '';
				const prefix = buff.permanent ? '每次' : '下次';
				const typeNames = {
					'idea_bonus': '想idea分数',
					'exp_bonus': '做实验分数',
					'write_bonus': '写论文分数',
					'idea_times': '想idea',
					'exp_times': '做实验',
					'write_times': '写论文',
					'monthly_san': '每月SAN',
					'read_san_reduce': '读论文SAN',
					'write_san_reduce': '写论文SAN',
					'citation_multiply': '中稿引用'
				};
				
				const typeName = typeNames[buff.type] || buff.type;
				let isDebuff = false;
				
				if (buff.type.includes('_times')) {
					name = `${prefix}${typeName}+${buff.value}次`;
				} else if (buff.type === 'monthly_san') {
					name = `每月SAN+${buff.value}`;
				} else if (buff.type === 'read_san_reduce') {
					name = `读论文SAN-1`;
				} else if (buff.type === 'write_san_reduce') {
					name = `写论文SAN-3`;
				} else if (buff.type === 'citation_multiply') {
					name = `下篇中稿引用×${buff.value}`;
				} else if (buff.multiply) {
					if (buff.value < 1) isDebuff = true;
					name = `${prefix}${typeName}×${buff.value}`;
				} else {
					if (buff.value < 0) isDebuff = true;
					const sign = buff.value >= 0 ? '+' : '';
					name = `${prefix}${typeName}${sign}${buff.value}`;
				}
				
				return { name, permanent: buff.permanent, isLove: false, isDebuff };
			});
			
			// ★★★ 合并普通buff和特殊buff ★★★
			const allDisplayBuffs = [...merged, ...specialBuffs];
			
			list.innerHTML = allDisplayBuffs.map(buff => {
				let tagClass = 'buff-tag ';
				if (buff.isLove) tagClass += 'love';
				else if (buff.isInternship) tagClass += 'temporary';
				else if (buff.isSubscription) tagClass += 'temporary';  // ★★★ 订阅buff用蓝色 ★★★
				else if (buff.isSpecialDebuff) tagClass += 'debuff';
				else if (buff.isMentorship) tagClass += 'permanent';
				else if (buff.isDebuff) tagClass += 'debuff';
				else if (buff.permanent) tagClass += 'permanent';
				else tagClass += 'temporary';
				
				let icon = 'fa-clock';
				if (buff.isLove) icon = 'fa-heart';
				else if (buff.isInternship) icon = 'fa-building';
				else if (buff.isSubscription) icon = 'fa-robot';  // ★★★ 订阅buff用机器人图标 ★★★
				else if (buff.isSpecialDebuff) icon = 'fa-exclamation-triangle';
				else if (buff.isMentorship) icon = 'fa-user-graduate';
				else if (buff.isDebuff) icon = 'fa-arrow-down';
				else if (buff.permanent) icon = 'fa-infinity';
				
				const descText = buff.isMentorship && buff.desc ? ` (${buff.desc})` : '';
				
				return `<span class="${tagClass}">
					<i class="fas ${icon}"></i>
					${buff.name}${descText}
				</span>`;
			}).join('');
			const buffListEl = document.getElementById('buff-list');
			
			// 师兄师姐救我技能
			if (gameState.hasSeniorHelpSkill && !gameState.usedSeniorHelpSkill) {
				const skillHtml = `<span class="buff-tag permanent" style="cursor:pointer;background:linear-gradient(135deg,rgba(243,156,18,0.3),rgba(230,126,34,0.3));border-color:#f39c12;" onclick="useSeniorHelpSkill()">
					<i class="fas fa-hands-helping"></i>
					🆘 师兄师姐救我（点击使用）
				</span>`;
				buffListEl.innerHTML += skillHtml;
			}
			
			// 导师救我技能
			if (gameState.hasTeacherHelpSkill && !gameState.usedTeacherHelpSkill) {
				const skillHtml = `<span class="buff-tag permanent" style="cursor:pointer;background:linear-gradient(135deg,rgba(253,121,168,0.3),rgba(232,67,147,0.3));border-color:#fd79a8;" onclick="useTeacherHelpSkill()">
					<i class="fas fa-user-shield"></i>
					🛡️ 导师救我（点击使用）
				</span>`;
				buffListEl.innerHTML += skillHtml;
			}
		}			

		// ★★★ 新增：师兄师姐救我技能 ★★★
		function useSeniorHelpSkill() {
			if (!gameState.hasSeniorHelpSkill || gameState.usedSeniorHelpSkill) {
				showModal('❌ 无法使用', '<p>技能不可用或已使用过。</p>', 
					[{ text: '确定', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			const bonusValue = gameState.social;
			
			showModal('🆘 师兄师姐救我', 
				`<div style="text-align:center;margin-bottom:15px;">
					<div style="font-size:2.5rem;margin-bottom:10px;">🆘</div>
					<div style="font-size:1.1rem;font-weight:600;color:#f39c12;">师兄师姐救我</div>
				</div>
				<p>使用此技能后，<strong>下次想idea时</strong>，你的科研能力将视为：</p>
				<div style="text-align:center;padding:15px;background:var(--light-bg);border-radius:10px;margin:15px 0;">
					<span style="font-size:1.2rem;color:var(--primary-color);font-weight:600;">
						科研(${gameState.research}) + 社交(${bonusValue}) = ${gameState.research + bonusValue}
					</span>
				</div>
				<p style="color:var(--danger-color);font-size:0.85rem;"><i class="fas fa-exclamation-triangle"></i> 注意：此技能仅可使用一次！</p>`,
				[
					{ text: '取消', class: 'btn-info', action: closeModal },
					{ text: '✨ 使用技能', class: 'btn-warning', action: () => {
						gameState.usedSeniorHelpSkill = true;
						gameState.nextIdeaResearchBonus = gameState.social;
						gameState.nextIdeaBonusSource = 'senior';
						addLog('主动技能', '师兄师姐救我', `下次想idea时科研能力+${gameState.social}（社交值）`);
						closeModal();
						updateBuffs();
						updateAllUI();
					}}
				]
			);
		}

		// ★★★ 新增：导师救我技能 ★★★
		function useTeacherHelpSkill() {
			if (!gameState.hasTeacherHelpSkill || gameState.usedTeacherHelpSkill) {
				showModal('❌ 无法使用', '<p>技能不可用或已使用过。</p>', 
					[{ text: '确定', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			const bonusValue = gameState.favor;
			
			showModal('🛡️ 导师救我', 
				`<div style="text-align:center;margin-bottom:15px;">
					<div style="font-size:2.5rem;margin-bottom:10px;">🛡️</div>
					<div style="font-size:1.1rem;font-weight:600;color:#fd79a8;">导师救我</div>
				</div>
				<p>使用此技能后，<strong>下次想idea时</strong>，你的科研能力将视为：</p>
				<div style="text-align:center;padding:15px;background:var(--light-bg);border-radius:10px;margin:15px 0;">
					<span style="font-size:1.2rem;color:var(--primary-color);font-weight:600;">
						科研(${gameState.research}) + 好感度(${bonusValue}) = ${gameState.research + bonusValue}
					</span>
				</div>
				<p style="color:var(--danger-color);font-size:0.85rem;"><i class="fas fa-exclamation-triangle"></i> 注意：此技能仅可使用一次！</p>`,
				[
					{ text: '取消', class: 'btn-info', action: closeModal },
					{ text: '✨ 使用技能', class: 'btn-accent', action: () => {
						gameState.usedTeacherHelpSkill = true;
						gameState.nextIdeaResearchBonus = gameState.favor;
						gameState.nextIdeaBonusSource = 'teacher';
						addLog('主动技能', '导师救我', `下次想idea时科研能力+${gameState.favor}（好感度值）`);
						closeModal();
						updateBuffs();
						updateAllUI();
					}}
				]
			);
		}

		function updateResearchResults() {
			document.getElementById('paper-a-count').textContent = gameState.paperA;
			document.getElementById('paper-b-count').textContent = gameState.paperB;
			document.getElementById('paper-c-count').textContent = gameState.paperC;
			document.getElementById('total-score').textContent = gameState.totalScore;
			document.getElementById('total-citations').textContent = gameState.totalCitations;
			document.getElementById('paper-total-count').textContent = gameState.publishedPapers.length;

			const paperList = document.getElementById('published-papers');
			if (gameState.publishedPapers.length === 0) {
				paperList.innerHTML = '<p style="color:var(--text-secondary);font-size:0.75rem;text-align:center;">暂无已发表论文</p>';
			} else {
				paperList.innerHTML = gameState.publishedPapers.map((p, index) => {
					// ★★★ 获取会议名称 ★★★
					const confName = p.conferenceInfo 
						? `${p.conferenceInfo.name} ${p.conferenceInfo.year} (${p.grade}类)` 
						: `${p.grade}类`;
					
					// ★★★ 新增：计算并显示影响因子和录用率 ★★★
					let statsInfo = '';
					if (p.conferenceInfo && gameState.submissionStats) {
						const month = p.conferenceInfo.month || 1;
						const statsKey = `${month}_${p.grade}_${gameState.isReversed}`;
						const stats = gameState.submissionStats[statsKey];
						
						if (stats && stats.submissions >= 10) {
							const impactFactor = getConferenceImpactFactor(p.conferenceInfo, p.grade);
							const acceptRate = (stats.acceptRate * 100).toFixed(1);
							statsInfo = `
								<div style="font-size:0.6rem;color:var(--text-secondary);margin-top:2px;">
									📊 IF:${impactFactor.toFixed(2)} | 录用率:${acceptRate}%
								</div>
							`;
						}
					}
					
					// ★★★ 新增：引用增速显示 ★★★
					const citationMultiplierText = p.citationMultiplier > 1 
						? ` <span style="color:var(--success-color);">(×${p.citationMultiplier.toFixed(2)})</span>` 
						: '';
					
					return `
					<div class="paper-item grade-${p.grade}">
						<div class="title">${p.title}</div>
						<div class="meta">
							<span>${confName}|${p.acceptType}</span>
							<span>分:${p.score} 引:${p.citations}${citationMultiplierText}</span>
						</div>
						${statsInfo}
						<div class="paper-promotions" style="margin-top:6px;display:flex;flex-wrap:wrap;gap:3px;">
							<button class="btn ${p.promotions?.arxiv ? '' : 'btn-info'}" 
								style="padding:2px 5px;font-size:0.6rem;${p.promotions?.arxiv ? 'opacity:0.5;background:#ccc;color:#666;cursor:default;' : ''}" 
								onclick="promotePaper(${index}, 'arxiv')" 
								${p.promotions?.arxiv ? 'disabled' : ''}>
								${p.promotions?.arxiv ? '✓arxiv' : '挂arxiv'}
							</button>
							<button class="btn ${p.promotions?.github ? '' : 'btn-success'}" 
								style="padding:2px 5px;font-size:0.6rem;${p.promotions?.github ? 'opacity:0.5;background:#ccc;color:#666;cursor:default;' : ''}" 
								onclick="promotePaper(${index}, 'github')" 
								${p.promotions?.github ? 'disabled' : ''}>
								${p.promotions?.github ? '✓开源' : 'github开源'}
							</button>
							<button class="btn ${p.promotions?.xiaohongshu ? '' : 'btn-accent'}" 
								style="padding:2px 5px;font-size:0.6rem;${p.promotions?.xiaohongshu ? 'opacity:0.5;background:#ccc;color:#666;cursor:default;' : ''}" 
								onclick="promotePaper(${index}, 'xiaohongshu')" 
								${p.promotions?.xiaohongshu ? 'disabled' : ''}>
								${p.promotions?.xiaohongshu ? '✓小红书' : '小红书宣传'}
							</button>
							<button class="btn ${p.promotions?.quantumbit ? '' : (p.grade === 'A' ? 'btn-warning' : '')}" 
								style="padding:2px 5px;font-size:0.6rem;${p.promotions?.quantumbit || p.grade !== 'A' ? 'opacity:0.5;background:#ccc;color:#666;cursor:default;' : ''}" 
								onclick="promotePaper(${index}, 'quantumbit')" 
								${p.promotions?.quantumbit || p.grade !== 'A' ? 'disabled' : ''}
								title="${p.grade !== 'A' ? '仅A类论文可用' : ''}">
								${p.promotions?.quantumbit ? '✓量子位' : (p.grade !== 'A' ? '量子位(仅A类)' : '量子位封面')}
							</button>
						</div>
					</div>
				`}).join('');
			}
		}

        function getActionCosts() {
            const has4K = gameState.buffs.permanent.some(b => b.type === 'read_san_reduce');
            const hasKeyboard = gameState.buffs.permanent.some(b => b.type === 'write_san_reduce');
            
            return {
                read: { san: has4K ? -1 : -2 },
                work: { san: -5, gold: 2 },
                idea: { san: -2 },
                experiment: { san: -3 },
                write: { san: hasKeyboard ? -3 : -4 }
            };
        }

        function formatCost(cost) {
            const parts = [];
            if (cost.san) parts.push(`<span style="color:${cost.san > 0 ? 'var(--success-color)' : 'var(--danger-color)'}">SAN${cost.san > 0 ? '+' : ''}${cost.san}</span>`);
            if (cost.gold) parts.push(`<span style="color:${cost.gold > 0 ? 'var(--success-color)' : 'var(--danger-color)'}">💰${cost.gold > 0 ? '+' : ''}${cost.gold}</span>`);
            return parts.join(' ');
        }

		function updateActionButtons() {
			const btns = ['btn-read', 'btn-work', 'btn-idea', 'btn-experiment', 'btn-write'];
			
			// 基于行动次数判断
			const actionsRemaining = gameState.actionLimit - gameState.actionCount;
			const allUsed = actionsRemaining <= 0;
			
			btns.forEach(id => {
				const btn = document.getElementById(id);
				btn.disabled = allUsed;
				btn.style.opacity = allUsed ? '0.5' : '1';
			});
			
			const costs = getActionCosts();
			
			// 显示剩余行动次数
			const actionCountDisplay = gameState.actionLimit > 1 
				? ` (${actionsRemaining}/${gameState.actionLimit})` 
				: '';
			
			// 改为2行布局：第一行图标+文字，第二行效果
			document.getElementById('btn-read').innerHTML = `
				<div class="action-top"><i class="fas fa-book-open"></i><span>看论文${actionCountDisplay}</span></div>
				<span class="action-cost">${formatCost(costs.read)}</span>`;
			document.getElementById('btn-work').innerHTML = `
				<div class="action-top"><i class="fas fa-briefcase"></i><span>打工${actionCountDisplay}</span></div>
				<span class="action-cost">${formatCost(costs.work)}</span>`;
			document.getElementById('btn-idea').innerHTML = `
				<div class="action-top"><i class="fas fa-lightbulb"></i><span>想idea${actionCountDisplay}</span></div>
				<span class="action-cost">${formatCost(costs.idea)}</span>`;
			document.getElementById('btn-experiment').innerHTML = `
				<div class="action-top"><i class="fas fa-vial"></i><span>做实验${actionCountDisplay}</span></div>
				<span class="action-cost">${formatCost(costs.experiment)}</span>`;
			document.getElementById('btn-write').innerHTML = `
				<div class="action-top"><i class="fas fa-pen-fancy"></i><span>写论文${actionCountDisplay}</span></div>
				<span class="action-cost">${formatCost(costs.write)}</span>`;
		}

        // ==================== 事件预告系统 ====================
		function getUpcomingEvents() {
			const events = [];
			
			for (let i = 1; i <= 2; i++) {
				let checkMonth = gameState.month + i;
				let checkYear = gameState.year;
				
				if (checkMonth > 12) {
					checkMonth -= 12;
					checkYear++;
				}
				
				const checkTotalMonths = gameState.totalMonths + i;
				const maxMonths = gameState.maxYears * 12;
				if (checkTotalMonths > maxMonths) continue;
				
				let monthEvents = [];  // 一个月可能有多个事件
				
				// ★★★ 新增：检查审稿结果 ★★★
				let reviewCount = 0;
				gameState.papers.forEach((paper, idx) => {
					if (paper && paper.reviewing) {
						const remainingMonths = paper.reviewMonths - i;
						if (remainingMonths <= 0) {
							reviewCount++;
						}
					}
				});
				if (reviewCount > 0) {
					monthEvents.push({
						name: reviewCount > 1 ? `${reviewCount}篇审稿结果` : '审稿结果',
						icon: '📬'
					});
				}
				
				// 原有事件检测
				if (checkMonth === 5) {
					monthEvents.push({ name: '寒假', icon: '❄️' });
				} else if (checkMonth === 11) {
					monthEvents.push({ name: '暑假', icon: '☀️' });
				} else if (checkMonth === 1 && checkYear >= 2) {
					monthEvents.push({ name: '奖学金', icon: '🎓' });
				} else if (checkMonth === 2) {
					monthEvents.push({ name: '教师节', icon: '🎁' });
				} else if (checkMonth === 12) {
					monthEvents.push({ name: '学年总结', icon: '📅' });
				} else if (checkMonth % 2 === 0 && monthEvents.length === 0) {
					// 只有没有其他事件时才显示随机事件
					monthEvents.push({ name: '随机事件', icon: '🎲' });
				}
				
				// 添加到事件列表
				monthEvents.forEach(evt => {
					events.push({
						month: i,
						name: evt.name,
						icon: evt.icon,
						label: i === 1 ? '下月' : '2月后'
					});
				});
			}
			
			return events;
		}

		function updateEventPreview() {
			const previewEl = document.getElementById('event-preview');
			if (!previewEl) return;
			
			const events = getUpcomingEvents();
			
			// 日历按钮始终显示
			const calendarBtn = `<span style="cursor:pointer;padding:2px 6px;background:var(--light-bg);border-radius:10px;font-size:0.6rem;margin-left:6px;" onclick="event.stopPropagation();showFullCalendar()" title="查看完整事件日历">📅 日历</span>`;
			
			if (events.length === 0) {
				previewEl.innerHTML = calendarBtn;
				return;
			}
			
			const previewHtml = events.map(e => 
				`<span style="margin-left:6px;padding:2px 6px;background:${getEventColor(e.name)};border-radius:10px;font-size:0.6rem;white-space:nowrap;">${e.icon} ${e.label}:${e.name}</span>`
			).join('');
			
			previewEl.innerHTML = `${previewHtml}${calendarBtn}`;
		}

		function getEventColor(eventName) {
			const colors = {
				'寒假': 'rgba(116,185,255,0.25)',
				'暑假': 'rgba(253,203,110,0.25)',
				'奖学金': 'rgba(108,92,231,0.25)',
				'教师节': 'rgba(253,121,168,0.25)',
				'随机事件': 'rgba(0,184,148,0.2)',
				'学年总结': 'rgba(162,155,254,0.25)'  // ★★★ 新增 ★★★
			};
			return colors[eventName] || 'rgba(99,110,114,0.15)';
		}
		// ==================== 显示完整事件日历 ====================
		function showFullCalendar() {
			const maxYears = 5; // 显示5年
			
			// 游戏月份转现实月份
			function gameMonthToRealMonth(gameMonth) {
				return ((gameMonth - 1 + 8) % 12) + 1;
			}
			
			// 获取月份的固定事件
			function getMonthEvent(year, month) {
				const events = [];
				
				if (month === 5) {
					events.push({ icon: '❄️', name: '寒假', desc: '回家过年，压岁钱+1，SAN+2', color: 'rgba(116,185,255,0.25)' });
				}
				if (month === 11) {
					events.push({ icon: '☀️', name: '暑假', desc: '暑假休息，SAN+3', color: 'rgba(253,203,110,0.25)' });
				}
				if (month === 1 && year >= 2) {
					const req = { 2: 1, 3: 3, 4: 6, 5: 9 }[year] || 9;
					const reward = { 2: 5, 3: 5, 4: 8, 5: 8 }[year] || 8;
					events.push({ icon: '🎓', name: '奖学金', desc: `要求科研分≥${req}，奖励${reward}金`, color: 'rgba(108,92,231,0.25)' });
				}
				if (month === 2) {
					events.push({ icon: '🎁', name: '教师节', desc: '可选择送礼物给导师', color: 'rgba(253,121,168,0.25)' });
				}
				if (month === 12) {
					events.push({ icon: '📅', name: '学年总结', desc: '回顾这一年的经历', color: 'rgba(162,155,254,0.25)' });
					
					// 转博判断
					if (year === 2) {
						events.push({ icon: '🎓', name: '转博机会', desc: '科研分≥2可选择转博', color: 'rgba(0,184,148,0.25)' });
					} else if (year === 3) {
						events.push({ icon: '🎓', name: '硕士毕业/转博', desc: '科研分≥1毕业，≥3可转博', color: 'rgba(0,184,148,0.25)' });
					}
				}
				
				// 偶数月随机事件（排除已有固定事件的月份）
				if (month % 2 === 0 && month !== 2 && month !== 12) {
					events.push({ icon: '🎲', name: '随机事件', desc: '可能遇到各种随机事件', color: 'rgba(0,184,148,0.2)' });
				}
				
				return events;
			}
			
			let html = '<div style="max-height:60vh;overflow-y:auto;">';
			
			// 当前进度指示
			const currentYear = gameState.year || 1;
			const currentMonth = gameState.month || 1;
			const degree = gameState.degree || 'master';
			const totalYears = degree === 'master' ? 3 : 5;
			
			html += `
			<div style="padding:10px;background:linear-gradient(135deg,rgba(108,92,231,0.1),rgba(162,155,254,0.1));border-radius:8px;margin-bottom:12px;text-align:center;">
				<div style="font-size:0.85rem;color:var(--primary-color);font-weight:600;">
					📍 当前进度：第${currentYear}年第${currentMonth}月（${degree === 'master' ? '硕士' : '博士'}）
				</div>
				<div style="font-size:0.75rem;color:var(--text-secondary);margin-top:4px;">
					剩余 ${(totalYears * 12) - gameState.totalMonths} 个月
				</div>
			</div>
			`;
			
			// 遍历5年
			for (let year = 1; year <= maxYears; year++) {
				const isCurrentYear = year === currentYear;
				const yearBg = isCurrentYear ? 'linear-gradient(135deg,rgba(108,92,231,0.1),rgba(253,121,168,0.1))' : 'var(--light-bg)';
				const yearBorder = isCurrentYear ? '2px solid var(--primary-color)' : '1px solid var(--border-color)';
				
				// 年份标题
				let yearLabel = `第${year}年`;
				if (year <= 3) yearLabel += '（硕士）';
				if (year >= 4) yearLabel += '（博士）';
				if (year === 3) yearLabel += ' / 硕士毕业年';
				if (year === 5) yearLabel += ' / 博士毕业年';
				
				html += `
				<div style="margin-bottom:15px;padding:12px;background:${yearBg};border-radius:10px;border:${yearBorder};">
					<div style="font-weight:600;color:var(--primary-color);margin-bottom:10px;font-size:0.9rem;display:flex;align-items:center;gap:6px;">
						${isCurrentYear ? '📍' : '📆'} ${yearLabel}
					</div>
					<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;">
				`;
				
				// 遍历12个月
				for (let month = 1; month <= 12; month++) {
					const realMonth = gameMonthToRealMonth(month);
					const events = getMonthEvent(year, month);
					const isCurrentMonthCell = isCurrentYear && month === currentMonth;
					const isPast = (year < currentYear) || (year === currentYear && month < currentMonth);
					
					const cellBg = isCurrentMonthCell 
						? 'linear-gradient(135deg,var(--primary-color),var(--secondary-color))' 
						: isPast 
							? 'rgba(149,165,166,0.2)' 
							: 'var(--card-bg)';
					const cellColor = isCurrentMonthCell ? 'white' : isPast ? 'var(--text-secondary)' : 'var(--text-primary)';
					const cellBorder = isCurrentMonthCell ? 'none' : '1px solid var(--border-color)';
					
					html += `
					<div style="padding:6px;background:${cellBg};border-radius:6px;border:${cellBorder};min-height:50px;">
						<div style="font-size:0.7rem;font-weight:600;color:${cellColor};margin-bottom:4px;">
							${month}月<span style="font-size:0.6rem;opacity:0.8;">（${realMonth}月）</span>
						</div>
					`;
					
					if (events.length > 0) {
						events.forEach(evt => {
							const evtColor = isCurrentMonthCell ? 'rgba(255,255,255,0.9)' : isPast ? 'var(--text-secondary)' : '';
							html += `
							<div style="font-size:0.6rem;padding:2px 4px;background:${isCurrentMonthCell ? 'rgba(255,255,255,0.2)' : evt.color};border-radius:4px;margin-bottom:2px;color:${evtColor};" title="${evt.desc}">
								${evt.icon} ${evt.name}
							</div>
							`;
						});
					} else {
						html += `<div style="font-size:0.55rem;color:${isCurrentMonthCell ? 'rgba(255,255,255,0.7)' : 'var(--text-secondary)'};text-align:center;">无固定事件</div>`;
					}
					
					html += '</div>';
				}
				
				html += '</div></div>';
			}
			
			html += '</div>';
			
			// 图例说明
			html += `
			<div style="margin-top:12px;padding:10px;background:var(--light-bg);border-radius:8px;font-size:0.7rem;">
				<div style="font-weight:600;margin-bottom:6px;color:var(--text-secondary);">📖 事件图例</div>
				<div style="display:flex;flex-wrap:wrap;gap:8px;">
					<span style="padding:2px 6px;background:rgba(116,185,255,0.25);border-radius:4px;">❄️ 寒假</span>
					<span style="padding:2px 6px;background:rgba(253,203,110,0.25);border-radius:4px;">☀️ 暑假</span>
					<span style="padding:2px 6px;background:rgba(108,92,231,0.25);border-radius:4px;">🎓 奖学金</span>
					<span style="padding:2px 6px;background:rgba(253,121,168,0.25);border-radius:4px;">🎁 教师节</span>
					<span style="padding:2px 6px;background:rgba(162,155,254,0.25);border-radius:4px;">📅 学年总结</span>
					<span style="padding:2px 6px;background:rgba(0,184,148,0.25);border-radius:4px;">🎓 转博/毕业</span>
					<span style="padding:2px 6px;background:rgba(0,184,148,0.2);border-radius:4px;">🎲 随机事件</span>
				</div>
				<div style="margin-top:8px;color:var(--text-secondary);">
					<div>• <strong>x月（y月）</strong>：学年第x月（现实y月）</div>
					<div>• 鼠标悬停事件可查看详细说明</div>
					<div>• 灰色区域为已过去的月份</div>
				</div>
			</div>
			`;
			
			showModal('📅 完整事件日历（5年）', html, [
				{ text: '关闭', class: 'btn-primary', action: closeModal }
			]);
		}
        // ==================== 下一个月 ====================
		function nextMonth() {
			// ★★★ 新增：重置行动次数 ★★★
			gameState.actionCount = 0;
			gameState.actionUsed = false;
			
			gameState.month++;
			gameState.totalMonths++;
			
			// ★★★ 空想之天选之人：月初最先执行属性交换 ★★★
			if (gameState.isReversed && gameState.character === 'chosen') {
				processChosenSwap();
			}
			
			// ★★★ 检查并处理松懈debuff ★★★
			const hadSlackBuff = gameState.buffs.temporary.some(b => b.type === 'slack_debuff');
			if (hadSlackBuff) {
				gameState.buffs.temporary = gameState.buffs.temporary.filter(b => b.type !== 'slack_debuff');
				addLog('状态恢复', '松懈debuff消除', '经过休整，状态恢复正常');
			}
			
			// ★★★ 清除本月限定的buff ★★★
			gameState.buffs.temporary = gameState.buffs.temporary.filter(b => !b.thisMonthOnly);
			
			// ★★★ 贪求之富可敌国：在月初最先执行重置 ★★★
			if (gameState.isReversed && gameState.character === 'rich') {
				let shouldReset = false;
				if (gameState.reversedAwakened) {
					// 觉醒后：半年（6个月）重置一次
					if (gameState.totalMonths - gameState.lastResetMonth >= 6) {
						shouldReset = true;
						gameState.lastResetMonth = gameState.totalMonths;
					}
				} else {
					// 觉醒前：每月重置
					shouldReset = true;
				}
				
				if (shouldReset) {
					const oldSan = gameState.san;
					const oldResearch = gameState.research;
					const oldSocial = gameState.social;
					const oldFavor = gameState.favor;
					
					// ★★★ 修改：重置为1而不是0 ★★★
					gameState.san = 1;
					gameState.research = 1;
					gameState.social = 1;
					gameState.favor = 1;
					
					const resetType = gameState.reversedAwakened ? '半年重置' : '每月重置';
					addLog('逆位效果', `贪求之${resetType}`, 
						`SAN ${oldSan}→1, 科研 ${oldResearch}→1, 社交 ${oldSocial}→1, 好感 ${oldFavor}→1`);
				}
			}
			
			if (gameState.month > 12) {
				gameState.month = 1;
				gameState.year++;
			}

			// ★★★ 修改：工资计算（加入月度工资加成）★★★
			const baseSalary = gameState.degree === 'master' ? 1 : 3;
			const salary = baseSalary + (gameState.monthlyWageBonus || 0);  // 不求暴富但求稳定加成
			
			// ★★★ 贪求之富可敌国：只保留每月+3金 ★★★
			let extraGold = 0;
			if (gameState.isReversed && gameState.character === 'rich') {
				extraGold = 3;
			}
			
			gameState.gold += salary - 1 + extraGold;

			let sanRecovery = 1;
			if (gameState.isReversed && gameState.character === 'normal') {
				// ★★★ 修改：转博后回复4而不是5 ★★★
				sanRecovery = gameState.reversedAwakened ? 4 : 3;
			}
			gameState.san = Math.min(gameState.sanMax, gameState.san + sanRecovery);

			if (gameState.hasLover) {
				if (gameState.loverType === 'beautiful') {
					gameState.san = Math.min(gameState.sanMax, gameState.san + 3);
				}
				
				gameState.gold -= 1;
				
				// 富可敌国觉醒：恋爱开销也算消费
				if (gameState.isReversed && gameState.character === 'rich' && gameState.reversedAwakened) {
					gameState.goldSpentTotal = (gameState.goldSpentTotal || 0) + 1;
					
					const attributeGains = Math.floor(gameState.goldSpentTotal / 6);
					const previousGains = Math.floor((gameState.goldSpentTotal - 1) / 6);
					const newGains = attributeGains - previousGains;
					
					if (newGains > 0) {
						gameState.san = Math.min(gameState.sanMax, gameState.san + newGains);
						gameState.research = Math.min(20, gameState.research + newGains);
						gameState.social = Math.min(20, gameState.social + newGains);
						gameState.favor = Math.min(20, gameState.favor + newGains);
						addLog('逆位效果', '金钱觉醒', `累计消费${gameState.goldSpentTotal}金 → SAN+${newGains}, 科研+${newGains}, 社交+${newGains}, 好感+${newGains}`);
					}
				}
				
				if (gameState.gold < 0) {
					triggerEnding('poor');
					return;
				}
			}

			// ★★★ AILab 实习效果 ★★★
			if (gameState.ailabInternship) {
				gameState.gold += 2;
				
				const baseSanCost = 3;
				const actualSanCost = Math.abs(getActualSanChange(-baseSanCost));
				gameState.san -= actualSanCost;
				
				if (gameState.san < 0) {
					triggerEnding('burnout');
					return;
				}
			}

			// ★★★ 人体工学椅效果 ★★★
			if (gameState.buffs.permanent.some(b => b.type === 'monthly_san')) {
				gameState.san = Math.min(gameState.sanMax, gameState.san + 1);
			}
			
			const mentorshipBuff = gameState.buffs.permanent.find(b => b.type === 'mentorship');
			if(mentorshipBuff) {
				const baseSanCost = 1;
				const actualSanCost = Math.abs(getActualSanChange(-baseSanCost));
				
				changeSan(-baseSanCost);
				
				const researchBonus = gameState.research;
				gameState.totalCitations += researchBonus;
				gameState.publishedPapers.forEach(paper => {
					paper.citations += Math.floor(researchBonus / gameState.publishedPapers.length);
				});
				
				let sanText = `SAN-${actualSanCost}`;
				if (actualSanCost !== baseSanCost) {
					sanText += `（怠惰×${gameState.reversedAwakened ? 3 : 2}）`;
				}
				addLog('长期合作', '指导师弟师妹的成果', `${sanText}，总引用+${researchBonus}`);
			}
			

			// ★★★ 修改：论文分数衰减（支持预见未来热点）★★★
			let decayLogs = [];
			gameState.papers.forEach((paper, idx) => {
				if (paper && !paper.reviewing) {
					// ★★★ 新增：如果有noDecay标志，跳过衰减 ★★★
					if (gameState.noDecay) {
						// 不衰减，什么都不做
					} else {
						let decayInfo = [];
						if (paper.ideaScore > 1) {
							paper.ideaScore--;
							decayInfo.push(`idea-1`);
						}
						if (paper.expScore > 1) {
							paper.expScore--;
							decayInfo.push(`实验-1`);
						}
						if (decayInfo.length > 0) {
							decayLogs.push(`槽${idx + 1}:${decayInfo.join('，')}`);
						}
					}
				}
			});

			// 审稿进度
			let pendingReviewSlots = [];
			gameState.papers.forEach((paper, idx) => {
				if (paper && paper.reviewing) {
					paper.reviewMonths--;
					if (paper.reviewMonths <= 0) {
						paper.reviewMonths = 0;
						pendingReviewSlots.push(idx);  // 按槽位顺序收集
					}
				}
			});

			// 更新引用
			updateCitations();

			// 重置月度商品
			shopItems.forEach(item => {
				if (item.monthlyOnce) item.boughtThisMonth = false;
			});

			let logResult = `工资+${salary}`;
			// ★★★ 新增：显示工资加成来源 ★★★
			if (gameState.monthlyWageBonus > 0) {
				logResult += `（含稳定加成+${gameState.monthlyWageBonus}）`;
			}
			logResult += `，开销-1`;
			if (extraGold > 0) logResult += `，逆位额外+${extraGold}金`;
			logResult += `，休息SAN+${sanRecovery}`;
			if (gameState.hasLover) {
				if (gameState.loverType === 'beautiful') {
					logResult += '，恋人SAN+3';
				}
				logResult += '，约会-1金';
			}
			if (gameState.ailabInternship) {
				const actualSanCost = Math.abs(getActualSanChange(-3));
				logResult += `，实习+2金，实习SAN-${actualSanCost}`;
			}
			
			if (gameState.buffs.permanent.some(b => b.type === 'monthly_san')) {
				logResult += '，工学椅SAN+1';
			}
			addLog('进入下一月', `第${gameState.year}年第${gameState.month}月`, logResult);

			// ★★★ 修改：衰减日志（预见未来热点时显示不同信息）★★★
			if (gameState.noDecay) {
				// 每5个月提示一次，避免日志刷屏
				if (gameState.totalMonths % 5 === 0) {
					addLog('预见热点', '论文分数保持稳定', 'idea和实验分数不衰减');
				}
			} else if (decayLogs.length > 0) {
				addLog('时效性降低', '论文分数自然衰减', decayLogs.join('；'));
			}

			// ★★★ 关键修改：审稿事件优先处理 ★★★
			// 如果有待处理的审稿结果，先处理审稿，完成后再触发月末事件
			if (pendingReviewSlots.length > 0) {
				// 定义月末事件回调
				const triggerMonthlyEvents = () => {
					// 12月特殊处理：转博或学年总结
					if (gameState.month === 12) {
						const canPhD = gameState.degree === 'master' && (
							(gameState.year === 2 && gameState.totalScore >= 2) ||
							(gameState.year === 3 && gameState.totalScore >= 3)
						);
						
						if (canPhD) {
							checkGraduation();
						} else {
							triggerYearEndSummaryEvent();
						}
					} else if (gameState.month === 5) {
						triggerWinterVacationEvent();
					} else if (gameState.month === 11) {
						triggerSummerVacationEvent();
					} else if (gameState.month === 1 && gameState.year >= 2) {
						triggerScholarshipEvent();
					} else if (gameState.month === 2) {
						triggerTeachersDayEvent();
					} else if (gameState.month % 2 === 0) {
						triggerOtherRandomEvent();
					}
					
					// 检查毕业
					checkGraduation();
					updateAllUI();
					renderPaperSlots();
				};
				
				// 开始审稿事件处理流程，完成后触发月末事件
				startReviewProcessing(pendingReviewSlots, triggerMonthlyEvents);
				
				updateAllUI();
				renderPaperSlots();
				return;  // ★★★ 提前返回，等待审稿流程完成 ★★★
			}

			// 没有审稿结果时，正常触发月末事件
			if (gameState.month === 12) {
				const canPhD = gameState.degree === 'master' && (
					(gameState.year === 2 && gameState.totalScore >= 2) ||
					(gameState.year === 3 && gameState.totalScore >= 3)
				);
				
				if (canPhD) {
					checkGraduation();
					updateAllUI();
					renderPaperSlots();
					return;
				} else {
					triggerYearEndSummaryEvent();
				}
			} else if (gameState.month === 5) {
				triggerWinterVacationEvent();
			} else if (gameState.month === 11) {
				triggerSummerVacationEvent();
			} else if (gameState.month === 1 && gameState.year >= 2) {
				triggerScholarshipEvent();
			} else if (gameState.month === 2) {
				triggerTeachersDayEvent();
			} else if (gameState.month % 2 === 0) {
				triggerOtherRandomEvent();
			}

			checkGraduation();
			updateAllUI();
			renderPaperSlots();
		}

        // 空想之天选之人：属性随机交换
		function processChosenSwap() {
			// 获取当前上限
			const researchMax = gameState.researchMax || 20;
			const socialMax = gameState.socialMax || 20;
			const favorMax = gameState.favorMax || 20;
			
			if (gameState.reversedAwakened) {
				const values = [gameState.research, gameState.social, gameState.favor, gameState.san, gameState.gold];
				const shuffled = shuffle([...values]);
				
				const oldStats = `科研${gameState.research}/${researchMax} 社交${gameState.social}/${socialMax} 好感${gameState.favor}/${favorMax} SAN${gameState.san}/${gameState.sanMax} 金${gameState.gold}`;
				
				// ★★★ 新逻辑：如果交换后的值超过上限，则提升上限 ★★★
				const newResearch = Math.max(0, shuffled[0]);
				const newSocial = Math.max(0, shuffled[1]);
				const newFavor = Math.max(0, shuffled[2]);
				const newSan = Math.max(0, shuffled[3]);
				const newGold = shuffled[4];
				
				// 更新上限（如果新值超过当前上限）
				if (newResearch > researchMax) gameState.researchMax = newResearch;
				if (newSocial > socialMax) gameState.socialMax = newSocial;
				if (newFavor > favorMax) gameState.favorMax = newFavor;
				if (newSan > gameState.sanMax) gameState.sanMax = newSan;
				
				// 设置新值
				gameState.research = newResearch;
				gameState.social = newSocial;
				gameState.favor = newFavor;
				gameState.san = newSan;
				gameState.gold = newGold;
				
				const newResearchMax = gameState.researchMax;
				const newSocialMax = gameState.socialMax;
				const newFavorMax = gameState.favorMax;
				
				const newStats = `科研${gameState.research}/${newResearchMax} 社交${gameState.social}/${newSocialMax} 好感${gameState.favor}/${newFavorMax} SAN${gameState.san}/${gameState.sanMax} 金${gameState.gold}`;
				
				// 检查是否有上限突破
				const breakthroughs = [];
				if (newResearchMax > researchMax) breakthroughs.push(`科研上限${researchMax}→${newResearchMax}`);
				if (newSocialMax > socialMax) breakthroughs.push(`社交上限${socialMax}→${newSocialMax}`);
				if (newFavorMax > favorMax) breakthroughs.push(`好感上限${favorMax}→${newFavorMax}`);
				if (gameState.sanMax > (gameState.sanMax - (newSan > gameState.sanMax - (newSan - shuffled[3]) ? newSan - shuffled[3] : 0))) {
					// 这个判断比较复杂，简化处理
				}
				
				const breakthroughText = breakthroughs.length > 0 ? `，上限突破：${breakthroughs.join('，')}` : '';
				addLog('命运轮盘', '全属性随机交换', `${oldStats} → ${newStats}${breakthroughText}`);
			} else {
				const stats1 = [gameState.research, gameState.social, gameState.favor];
				const shuffled1 = shuffle([...stats1]);
				
				const stats2 = [gameState.san, gameState.gold];
				const shuffled2 = shuffle([...stats2]);
				
				const oldStats = `科研${gameState.research}/${researchMax} 社交${gameState.social}/${socialMax} 好感${gameState.favor}/${favorMax} | SAN${gameState.san}/${gameState.sanMax} 金${gameState.gold}`;
				
				// ★★★ 新逻辑：如果交换后的值超过上限，则提升上限 ★★★
				const newResearch = Math.max(0, shuffled1[0]);
				const newSocial = Math.max(0, shuffled1[1]);
				const newFavor = Math.max(0, shuffled1[2]);
				const newSan = Math.max(0, shuffled2[0]);
				const newGold = shuffled2[1];
				
				// 更新上限
				if (newResearch > researchMax) gameState.researchMax = newResearch;
				if (newSocial > socialMax) gameState.socialMax = newSocial;
				if (newFavor > favorMax) gameState.favorMax = newFavor;
				if (newSan > gameState.sanMax) gameState.sanMax = newSan;
				
				// 设置新值
				gameState.research = newResearch;
				gameState.social = newSocial;
				gameState.favor = newFavor;
				gameState.san = newSan;
				gameState.gold = newGold;
				
				const newResearchMax = gameState.researchMax;
				const newSocialMax = gameState.socialMax;
				const newFavorMax = gameState.favorMax;
				
				const newStats = `科研${gameState.research}/${newResearchMax} 社交${gameState.social}/${newSocialMax} 好感${gameState.favor}/${newFavorMax} | SAN${gameState.san}/${gameState.sanMax} 金${gameState.gold}`;
				
				// 检查是否有上限突破
				const breakthroughs = [];
				if (newResearchMax > researchMax) breakthroughs.push(`科研上限→${newResearchMax}`);
				if (newSocialMax > socialMax) breakthroughs.push(`社交上限→${newSocialMax}`);
				if (newFavorMax > favorMax) breakthroughs.push(`好感上限→${newFavorMax}`);
				
				const breakthroughText = breakthroughs.length > 0 ? `，✨上限突破：${breakthroughs.join('，')}` : '';
				addLog('命运轮盘', '属性随机交换', `${oldStats} → ${newStats}${breakthroughText}`);
			}
			
			checkResearchUnlock();
		}

		// ★★★ 新增：计算会议影响因子 ★★★
		function getConferenceImpactFactor(conferenceInfo, grade) {
			// 如果没有统计数据，返回基础因子1.0
			if (!gameState.submissionStats || !conferenceInfo) {
				return 1.0;
			}
			
			const currentMonth = conferenceInfo.month || gameState.month || 1;
			const isReversed = gameState.isReversed;
			
			// 获取该会议的统计
			const currentKey = `${currentMonth}_${grade}_${isReversed}`;
			const currentStats = gameState.submissionStats[currentKey];
			
			if (!currentStats || currentStats.submissions < 10) {
				return 1.0;
			}
			
			// ★★★ 计算该会议的中稿均分 ★★★
			const currentAcceptedScores = [];
			if (currentStats.avgScorePoster > 0) currentAcceptedScores.push({ score: currentStats.avgScorePoster, count: currentStats.poster || 0 });
			if (currentStats.avgScoreOral > 0) currentAcceptedScores.push({ score: currentStats.avgScoreOral, count: currentStats.oral || 0 });
			if (currentStats.avgScoreBestPaper > 0) currentAcceptedScores.push({ score: currentStats.avgScoreBestPaper, count: currentStats.bestPaper || 0 });
			
			let currentAvgAcceptedScore = 0;
			let currentTotalAccepted = 0;
			currentAcceptedScores.forEach(item => {
				currentAvgAcceptedScore += item.score * item.count;
				currentTotalAccepted += item.count;
			});
			currentAvgAcceptedScore = currentTotalAccepted > 0 ? currentAvgAcceptedScore / currentTotalAccepted : 0;
			
			// ★★★ 计算同级别所有会议的平均投稿数量 ★★★
			let sameLevelTotalSubmissions = 0;
			let sameLevelConferenceCount = 0;
			
			for (let month = 1; month <= 12; month++) {
				const key = `${month}_${grade}_${isReversed}`;
				const stats = gameState.submissionStats[key];
				
				if (stats && stats.submissions >= 10) {
					sameLevelTotalSubmissions += stats.submissions;
					sameLevelConferenceCount++;
				}
			}
			
			// 同级别平均投稿数
			const sameLevelAvgSubmissions = sameLevelConferenceCount > 0 
				? sameLevelTotalSubmissions / sameLevelConferenceCount 
				: currentStats.submissions;
			
			// ★★★ 计算全体论文（所有等级A/B/C）的平均中稿均分 ★★★
			let allGradesTotalScore = 0;
			let allGradesCount = 0;
			
			for (const g of ['A', 'B', 'C']) {
				for (let month = 1; month <= 12; month++) {
					const key = `${month}_${g}_${isReversed}`;
					const stats = gameState.submissionStats[key];
					
					if (stats && stats.submissions >= 10) {
						// 计算该会议的中稿均分
						const acceptedScores = [];
						if (stats.avgScorePoster > 0) acceptedScores.push({ score: stats.avgScorePoster, count: stats.poster || 0 });
						if (stats.avgScoreOral > 0) acceptedScores.push({ score: stats.avgScoreOral, count: stats.oral || 0 });
						if (stats.avgScoreBestPaper > 0) acceptedScores.push({ score: stats.avgScoreBestPaper, count: stats.bestPaper || 0 });
						
						let avgScore = 0;
						let totalAccepted = 0;
						acceptedScores.forEach(item => {
							avgScore += item.score * item.count;
							totalAccepted += item.count;
						});
						avgScore = totalAccepted > 0 ? avgScore / totalAccepted : 0;
						
						if (avgScore > 0) {
							allGradesTotalScore += avgScore;
							allGradesCount++;
						}
					}
				}
			}
			
			// 全体论文平均分
			const allGradesAvgScore = allGradesCount > 0 ? allGradesTotalScore / allGradesCount : currentAvgAcceptedScore;
			
			// 如果没有有效数据，返回基础因子
			if (sameLevelAvgSubmissions === 0 || allGradesAvgScore === 0 || currentAvgAcceptedScore === 0) {
				return 1.0;
			}
			
			// ★★★ 新公式：影响因子 = (论文投稿数/同级别论文平均投稿数) * (论文平均分/全体论文平均分) ★★★
			const submissionRatio = currentStats.submissions / sameLevelAvgSubmissions;
			const scoreRatio = currentAvgAcceptedScore / allGradesAvgScore;
			
			let impactFactor = submissionRatio * scoreRatio;
			
			// 限制范围，避免极端值（0.2 ~ 4.0）
			impactFactor = Math.max(0.2, Math.min(4.0, impactFactor));
			
			return impactFactor;
		}

		function updateCitations() {
			gameState.publishedPapers.forEach(paper => {
				paper.monthsSincePublish = (paper.monthsSincePublish || 0) + 1;
				
				// 初始化小数累积字段
				if (paper.pendingCitationFraction === undefined) {
					paper.pendingCitationFraction = 0;
				}
				
				// ★★★ 新计算方式 ★★★
				// 基础增速 = 论文中稿分数（会随时间衰减）* 0.1
				const baseScore = Math.max(0, paper.score - 2 * paper.monthsSincePublish);
				let baseGrowth = baseScore * 0.1;
				
				// ★★★ 会议影响因子 ★★★
				const impactFactor = getConferenceImpactFactor(paper.conferenceInfo, paper.grade);
				
				// ★★★ 推广倍率（加法效果）★★★
				let promotionRate = 0;  // 额外倍率（从0开始累加）
				
				// 接收类型加成
				if (paper.acceptType === 'Oral') {
					promotionRate += 0.5;  // oral提供50%倍率
				} else if (paper.acceptType === 'Best Paper') {
					promotionRate += 4.0;  // best paper提供400%倍率
				}
				
				// 推广加成（原本是乘法，现在改为加法）
				if (paper.promotions?.arxiv) promotionRate += 0.25;
				if (paper.promotions?.github) promotionRate += 0.5;
				if (paper.promotions?.xiaohongshu) promotionRate += 0.25;
				
				// 同门合作加成（原本citationMultiplier是乘数，现在转为加成）
				// citationMultiplier=2 表示×2，转换为+100%倍率
				const fellowBonus = ((paper.citationMultiplier || 1) - 1) * 100 / 100;  // 转为百分比
				promotionRate += fellowBonus;
				
				// 最终推广倍率 = 1 + 累加的所有加成
				const promotionMultiplier = 1 + promotionRate;
				
				// 最终增速 = 基础增速 × 会议影响因子 × 推广倍率
				const finalGrowth = baseGrowth * impactFactor * promotionMultiplier;
				
				// 加上之前累积的小数部分
				const totalGrowth = finalGrowth + paper.pendingCitationFraction;
				
				// 下取整得到本月实际增加的引用
				const actualGain = Math.floor(totalGrowth);
				
				// 保存小数部分到下个月
				paper.pendingCitationFraction = totalGrowth - actualGain;
				
				// 增加引用
				if (actualGain > 0) {
					paper.citations += actualGain;
					gameState.totalCitations += actualGain;
				}
			});
		}
		
        // ==================== 毕业检查 ====================
        function checkGraduation() {
            if (gameState.pendingPhDChoice) {
                return;
            }
            
            const maxMonths = gameState.maxYears * 12;
            
            if (gameState.degree === 'master') {
                if ((gameState.year === 2 && gameState.month === 12 && gameState.totalScore >= 2) ||
                    (gameState.year === 3 && gameState.month === 12 && gameState.totalScore >= 3)) {
                    showPhDOptionModal();
                    return;
                }
            }
            
            if (gameState.totalMonths >= maxMonths) {
                if (gameState.degree === 'master') {
                    if (gameState.totalScore >= 1) {
                        triggerEnding('master');
                    } else {
                        triggerEnding('delay');
                    }
                } else if (gameState.degree === 'phd') {
                    if (gameState.totalScore >= 7) {
                        triggerEnding('phd');
                    } else {
                        triggerEnding('delay');
                    }
                }
                return;
            }
        }
			
		function showPhDOptionModal() {
			if (gameState.totalScore >= 7) {
				gameState.achievementConditions = gameState.achievementConditions || {};
				gameState.achievementConditions.phdRequirementMetEarly = true;
			}
			
			gameState.pendingPhDChoice = true;
			
			const isSecondYear = gameState.year === 2;
			const notPhDText = isSecondYear ? '继续读硕士' : '硕士毕业';
			const requirementText = isSecondYear ? '≥2分' : '≥3分';
			const notPhDDesc = isSecondYear 
				? '<p style="color:var(--text-secondary);font-size:0.85rem;">选择继续读硕士，明年还有一次转博机会，但竞争更激烈，需要科研分≥3分</p>'
				: '';
			
			showModal('🎓 转博选择',
				`<p>恭喜！你的科研成绩优异（${requirementText}），获得了转博资格！</p>
				 <p>是否选择继续攻读博士学位？</p>
				 <p style="color:var(--text-secondary);font-size:0.85rem;">博士毕业要求：科研分≥7，学习年限5年</p>
				 ${notPhDDesc}
				 <div style="margin-top:12px;padding:10px;background:linear-gradient(135deg,rgba(253,203,110,0.15),rgba(0,184,148,0.15));border-radius:8px;border-left:3px solid var(--success-color);">
					 <p style="font-size:0.85rem;color:var(--text-secondary);margin:0;">
						 💡 <strong>神秘老人：</strong>如果你取得了每一年的奖学金、拥有一篇A类论文，那么祝贺你，你的前期是比较成功的！
					 </p>
				 </div>`,
				[
					{ text: notPhDText, class: 'btn-info', action: () => { 
						gameState.pendingPhDChoice = false;
						gameState.phdOpportunitiesRejected = (gameState.phdOpportunitiesRejected || 0) + 1;
						if (gameState.phdOpportunitiesRejected >= 2) {
							gameState.achievementConditions = gameState.achievementConditions || {};
							gameState.achievementConditions.rejectedPhdTwice = true;
						}
						closeModal();
						
						if (isSecondYear) {
							addLog('转博选择', '选择继续读硕士', '明年还有一次转博机会');
							updateAllUI();
							
							// ★★★ 补上12月的学年总结事件 ★★★
							if (gameState.month === 12) {
								setTimeout(() => triggerYearEndSummaryEvent(), 300);
							}
							
							if (gameState.pendingConference) {
								const grade = gameState.pendingConference;
								gameState.pendingConference = null;
								setTimeout(() => showConferenceModal(grade), 300);
							}
						} else {
							// ★★★ 第3年选择硕士毕业时，也补上学年总结 ★★★
							addLog('转博选择', '选择硕士毕业', '准备毕业');
							if (gameState.month === 12) {
								setTimeout(() => {
									triggerYearEndSummaryEvent();
									// 学年总结完成后再触发毕业
									// 但为了简化，直接毕业
								}, 100);
							}
							setTimeout(() => triggerEnding('master'), 500);
						}
					}},
					{ text: '📚 转为博士', class: 'btn-primary', action: () => {
						gameState.pendingPhDChoice = false;
						gameState.degree = 'phd';
						gameState.maxYears = 5;
						closeModal();
						setTimeout(() => showPhDTribulationModal(), 200);
					}}
				]
			);
		}

        // ★★★ 关键修改：转博觉醒函数 ★★★

		function showPhDTribulationModal() {
			const character = gameState.character;
			
			// ★★★ 修复：防御性检查，优先处理真·大多数 ★★★
			if (character === 'true-normal' || gameState.isTrueNormal) {
				// 确保状态一致
				gameState.isTrueNormal = true;
				
				const html = `
					<div style="text-align:center;">
						<div style="font-size:4rem;margin-bottom:15px;">🌍</div>
						<div style="font-size:1.5rem;font-weight:700;background:linear-gradient(135deg,#ffd700,#ff8c00);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:10px;">
							转博成功
						</div>
						<div style="font-size:0.95rem;color:var(--text-secondary);margin-bottom:20px;">
							作为真·大多数，你没有任何觉醒技能
						</div>
					</div>
					
					<div style="background:linear-gradient(135deg,rgba(255,215,0,0.15),rgba(255,140,0,0.15));border-radius:12px;padding:15px;margin-bottom:15px;border:2px solid rgba(255,140,0,0.3);">
						<div style="text-align:center;margin-bottom:12px;">
							<div style="font-size:1.3rem;font-weight:700;color:#d68910;margin-bottom:5px;">❌ 无觉醒</div>
							<div style="font-size:0.85rem;color:var(--text-secondary);font-style:italic;">一切都要靠自己</div>
						</div>
						<div style="background:white;border-radius:8px;padding:12px;text-align:center;">
							<div style="font-size:0.9rem;color:var(--text-secondary);">
								没有任何属性加成<br>
								没有任何特殊能力<br>
								这就是最真实的研究生生活
							</div>
						</div>
					</div>
					
					<div style="text-align:center;padding:10px;background:var(--light-bg);border-radius:8px;font-size:0.85rem;">
						<div style="color:#d68910;font-weight:600;margin-bottom:5px;">📜 真实的博士之路</div>
						<div style="color:var(--text-secondary);">博士毕业要求：科研分 ≥ 7</div>
					</div>
				`;
				
				showModal('🎓 真·转博', html, [
					{ text: '❌ 靠自己！', class: 'btn-warning', action: () => {
						addLog('真·转博', '转博成功，没有任何觉醒效果', '一切都要靠自己');
						closeModal();
						updateAllUI();
						renderPaperSlots();
						
						if (gameState.pendingConference) {
							const grade = gameState.pendingConference;
							gameState.pendingConference = null;
							setTimeout(() => showConferenceModal(grade), 300);
						}
					}}
				]);
				
				return;
			}
			
			const charData = characters.find(c => c.id === character);
			
			// ★★★ 新增：角色数据不存在时的错误处理 ★★★
			if (!charData) {
				console.error('无法找到角色数据:', character);
				showModal('⚠️ 错误', '<p>角色数据加载失败，请重新开始游戏。</p>', 
					[{ text: '确定', class: 'btn-primary', action: () => {
						closeModal();
						restartGame();
					}}]);
				return;
			}
			
			// ★★★ 逆位角色觉醒（保持原有逻辑不变）★★★
			if (gameState.isReversed) {
				gameState.reversedAwakened = true;
				
				let effectName = '';
				let effectDesc = '';
				let bonusDetails = [];
				
				switch (character) {
					case 'normal': // 怠惰之大多数
						effectName = '💀 极致怠惰';
						effectDesc = '懒惰的极致就是一切都翻倍...包括痛苦';
						const oldR1 = gameState.research, oldS1 = gameState.social, oldF1 = gameState.favor, oldG1 = gameState.gold;
						gameState.research = Math.min(20, gameState.research * 2);
						gameState.social = Math.min(20, gameState.social * 2);
						gameState.favor = Math.min(20, gameState.favor * 2);
						gameState.gold = gameState.gold * 2;
						bonusDetails.push(`科研 ${oldR1} → ${gameState.research}`);
						bonusDetails.push(`社交 ${oldS1} → ${gameState.social}`);
						bonusDetails.push(`好感 ${oldF1} → ${gameState.favor}`);
						bonusDetails.push(`金币 ${oldG1} → ${gameState.gold}`);
						bonusDetails.push('⚠️ SAN减少变为3倍');
						bonusDetails.push('✨ 每月SAN回复变为5');
						
						const mentorshipBuff = gameState.buffs.permanent.find(b => b.type === 'mentorship');
						if (mentorshipBuff) {
							mentorshipBuff.desc = '每月SAN-3（怠惰×3），总引用+科研能力值';
						}
						break;
						
					case 'genius': // 愚钝之院士转世
						effectName = '🎭 大智若愚';
						effectDesc = '真正的智慧不在于科研数值';
						bonusDetails.push('科研提升转化效果升级');
						bonusDetails.push('每1点科研提升 → 好感+2, SAN+6, 社交+2, 金+6');
						break;
						
					case 'social': // 嫉妒之社交达人
						effectName = '👁️ 嫉妒重置';
						effectDesc = '社交能力重置，触发连带效果';
						const oldSocialVal = gameState.social;
						if (oldSocialVal > 5) {
							const decrease = oldSocialVal - 5;
							gameState.research = Math.min(20, gameState.research + decrease);
							gameState.favor = Math.min(20, gameState.favor + decrease);
							bonusDetails.push(`社交 ${oldSocialVal} → 5`);
							bonusDetails.push(`触发嫉妒转化：科研+${decrease}, 好感+${decrease}`);
						} else if (oldSocialVal < 5) {
							const increase = 5 - oldSocialVal;
							gameState.san = Math.min(gameState.sanMax, gameState.san + increase);
							gameState.gold += increase;
							bonusDetails.push(`社交 ${oldSocialVal} → 5`);
							bonusDetails.push(`触发嫉妒反馈：SAN+${increase}, 金钱+${increase}`);
						} else {
							bonusDetails.push('社交已经是5，无变化');
						}
						gameState.social = 5;
						break;
						
					case 'rich':
						effectName = '💸 金钱的力量';
						effectDesc = '半年重置一次，消费金币可提升属性';
						gameState.goldSpentTotal = 0;
						gameState.lastResetMonth = gameState.totalMonths;
						bonusDetails.push('✨ 属性重置周期：每月 → 每半年');
						bonusDetails.push('✨ 每花费6金币 → SAN+1, 科研+1, 社交+1, 好感+1');
						bonusDetails.push('💰 快去花钱提升属性吧！');
						break;
						
					case 'teacher-child': // 玩世之导师子女
						effectName = '🃏 变本加厉';
						effectDesc = '叛逆到底，但收益依旧';
						bonusDetails.push('好感归零时重置为2（原为4）');
						bonusDetails.push('重置时仍获得：社交+1，科研+1，金币+2');
						break;
						
					case 'chosen': // 空想之天选之人
						effectName = '🎲 命运轮盘';
						effectDesc = '五属性全部加入轮盘赌局';
						bonusDetails.push('每月随机交换升级');
						bonusDetails.push('科研/社交/好感/SAN/金 全部参与交换');
						break;
				}
				
				checkResearchUnlock(true);
				
				const html = `
					<div style="text-align:center;">
						<div style="font-size:4rem;margin-bottom:15px;animation:pulse 1s infinite;">🌑</div>
						<div style="font-size:1.5rem;font-weight:700;background:linear-gradient(135deg,#9b59b6,#e74c3c);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:10px;">
							逆位觉醒！
						</div>
						<div style="font-size:0.95rem;color:var(--text-secondary);margin-bottom:20px;">
							黑暗中蕴含的力量已被激活...
						</div>
					</div>
					
					<div style="background:linear-gradient(135deg,rgba(155,89,182,0.2),rgba(231,76,60,0.2));border-radius:12px;padding:15px;margin-bottom:15px;border:2px solid rgba(231,76,60,0.5);">
						<div style="text-align:center;margin-bottom:12px;">
							<div style="font-size:1.3rem;font-weight:700;color:#e74c3c;margin-bottom:5px;">${effectName}</div>
							<div style="font-size:0.85rem;color:var(--text-secondary);font-style:italic;">${effectDesc}</div>
						</div>
						<div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:12px;">
							<div style="font-size:0.8rem;color:#a0a0a0;margin-bottom:8px;text-align:center;">🌙 觉醒效果 🌙</div>
							<div style="display:flex;flex-direction:column;gap:6px;">
								${bonusDetails.map(detail => `
									<div style="display:flex;align-items:center;justify-content:center;gap:8px;padding:6px 12px;background:linear-gradient(135deg,rgba(155,89,182,0.2),rgba(231,76,60,0.2));border-radius:6px;font-size:0.85rem;font-weight:500;color:#e74c3c;">
										${detail.startsWith('⚠️') || detail.startsWith('✨') || detail.startsWith('💰') ? '' : '<i class="fas fa-moon"></i>'} ${detail}
									</div>
								`).join('')}
							</div>
						</div>
					</div>
					
					<div style="text-align:center;padding:10px;background:rgba(0,0,0,0.1);border-radius:8px;font-size:0.85rem;">
						<div style="color:#9b59b6;font-weight:600;margin-bottom:5px;">📜 继续你的黑暗旅程</div>
						<div style="color:var(--text-secondary);">博士毕业要求：科研分 ≥ 7</div>
					</div>
				`;
				
				showModal('🌑 逆位觉醒', html, [
					{ text: '🌙 拥抱黑暗', class: 'btn-danger', action: () => {
						addLog('逆位觉醒', `触发【${effectName}】`, bonusDetails.join('，'));
						closeModal();
						updateAllUI();
						renderPaperSlots();
						
						if (gameState.pendingConference) {
							const grade = gameState.pendingConference;
							gameState.pendingConference = null;
							setTimeout(() => showConferenceModal(grade), 300);
						}
					}}
				]);
				
				return;
			}
			
			// ★★★ 正位角色：检查是否满足隐藏觉醒条件 ★★★
			const hasHiddenAwaken = charData.hiddenAwakenCondition && charData.hiddenAwakenCondition(gameState);
			
			if (hasHiddenAwaken) {
				// 显示二选一弹窗
				showAwakenChoiceModal(charData);
			} else {
				// 直接触发普通觉醒
				applyNormalAwaken(charData);
			}
		}

		// ★★★ 新增：显示觉醒二选一弹窗 ★★★
		function showAwakenChoiceModal(charData) {
			const character = gameState.character;
			
			const html = `
				<div style="text-align:center;">
					<div style="font-size:3rem;margin-bottom:15px;animation:pulse 1s infinite;">⚡</div>
					<div style="font-size:1.3rem;font-weight:700;background:linear-gradient(135deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:10px;">
						渡劫成功！觉醒分支出现！
					</div>
					<div style="font-size:0.9rem;color:var(--text-secondary);margin-bottom:20px;">
						你满足了隐藏觉醒的触发条件，请选择你的觉醒路线：
					</div>
				</div>
				
				<div style="display:flex;flex-direction:column;gap:15px;margin-bottom:20px;">
					<!-- 普通觉醒选项 -->
					<div style="background:linear-gradient(135deg,rgba(102,126,234,0.15),rgba(118,75,162,0.15));border-radius:12px;padding:15px;border:2px solid rgba(102,126,234,0.3);cursor:pointer;transition:all 0.3s;" 
						 onmouseover="this.style.borderColor='rgba(102,126,234,0.8)';this.style.transform='translateY(-2px)'"
						 onmouseout="this.style.borderColor='rgba(102,126,234,0.3)';this.style.transform='translateY(0)'"
						 onclick="selectAwaken('normal')">
						<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
							<span style="font-size:1.5rem;">${charData.awakenIcon}</span>
							<span style="font-size:1.1rem;font-weight:700;color:#667eea;">${charData.awakenName}</span>
						</div>
						<div style="font-size:0.85rem;color:var(--text-secondary);">${charData.awakenDesc}</div>
					</div>
					
					<!-- 隐藏觉醒选项 -->
					<div style="background:linear-gradient(135deg,rgba(253,203,110,0.2),rgba(243,156,18,0.2));border-radius:12px;padding:15px;border:2px dashed rgba(243,156,18,0.5);cursor:pointer;transition:all 0.3s;position:relative;" 
						 onmouseover="this.style.borderColor='rgba(243,156,18,1)';this.style.transform='translateY(-2px)'"
						 onmouseout="this.style.borderColor='rgba(243,156,18,0.5)';this.style.transform='translateY(0)'"
						 onclick="selectAwaken('hidden')">
						<div style="position:absolute;top:-8px;right:10px;background:linear-gradient(135deg,#f39c12,#e74c3c);color:white;padding:2px 8px;border-radius:10px;font-size:0.65rem;font-weight:600;">⚙️ 隐藏觉醒</div>
						<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
							<span style="font-size:1.5rem;">${charData.hiddenAwakenIcon}</span>
							<span style="font-size:1.1rem;font-weight:700;color:#f39c12;">${charData.hiddenAwakenName}</span>
						</div>
						<div style="font-size:0.85rem;color:var(--text-secondary);">${charData.hiddenAwakenDesc}</div>
					</div>
				</div>
				
				<div style="text-align:center;padding:10px;background:var(--light-bg);border-radius:8px;font-size:0.8rem;color:var(--text-secondary);">
					<i class="fas fa-info-circle"></i> 选择后无法更改，请谨慎决定！
				</div>
			`;
			
			// 定义全局选择函数
			window.selectAwaken = function(type) {
				closeModal();
				if (type === 'hidden') {
					applyHiddenAwaken(charData);
				} else {
					applyNormalAwaken(charData);
				}
			};
			
			showModal('⚡ 觉醒选择', html, []);
		}

		// ★★★ 新增：应用隐藏觉醒效果 ★★★
		function applyHiddenAwaken(charData) {
			const character = gameState.character;
			gameState.hiddenAwakened = true;
			gameState.hiddenAwakenType = character;
			
			let effectName = charData.hiddenAwakenIcon + ' ' + charData.hiddenAwakenName;
			let effectDesc = charData.hiddenAwakenDesc;
			let bonusDetails = [];
			
			switch (character) {
				case 'normal': // 勤能补拙
					gameState.actionLimit = 2;
					bonusDetails.push('每月行动次数：1 → 2');
					bonusDetails.push('看论文/打工/想idea/做实验/写论文每月可执行2次');
					break;
					
				case 'genius': // 预见未来热点
					gameState.noDecay = true;
					bonusDetails.push('论文idea分数不再每月衰减');
					bonusDetails.push('论文实验分数不再每月衰减');
					bonusDetails.push('✨ 论文质量将更加稳定！');
					break;
					
				case 'social': // 师兄师姐救我
					gameState.hasSeniorHelpSkill = true;
					bonusDetails.push('获得主动技能【师兄师姐救我】');
					bonusDetails.push('使用后：下次想idea时科研能力视为 科研+社交');
					bonusDetails.push('⚠️ 此技能仅可使用1次');
					break;
					
				case 'rich': // 不求暴富但求稳定
					gameState.monthlyWageBonus = 1;
					bonusDetails.push('每月工资额外+1');
					bonusDetails.push('✨ 稳定的收入让生活更从容');
					break;
					
				case 'teacher-child': // 导师救我
					gameState.hasTeacherHelpSkill = true;
					bonusDetails.push('获得主动技能【导师救我】');
					bonusDetails.push('使用后：下次想idea时科研能力视为 科研+好感度');
					bonusDetails.push('⚠️ 此技能仅可使用1次');
					break;
					
				case 'chosen': // 孤注一掷
					// 需要让玩家选择保留哪个属性
					showAllInChoiceModal();
					return; // 提前返回，由选择弹窗处理后续
			}
			
			checkResearchUnlock(true);
			showHiddenAwakenResultModal(effectName, effectDesc, bonusDetails);
		}

		// ★★★ 新增：孤注一掷属性选择弹窗 ★★★
		function showAllInChoiceModal() {
			const currentVal = gameState.research; // 三项相等
			const transferVal = (currentVal - 1) * 2; // 两项变1后转移的值
			
			const html = `
				<div style="text-align:center;margin-bottom:15px;">
					<div style="font-size:2.5rem;margin-bottom:10px;">🎯</div>
					<div style="font-size:1.1rem;font-weight:600;color:#f39c12;margin-bottom:5px;">孤注一掷</div>
					<div style="font-size:0.85rem;color:var(--text-secondary);">选择你要强化的属性，其他两项将变为1</div>
				</div>
				
				<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:15px;text-align:center;">
					<div style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:5px;">当前属性均为 ${currentVal}</div>
					<div style="font-size:0.85rem;">选择后：主属性 +${transferVal}，其他两项变为1</div>
				</div>
				
				<div style="display:flex;flex-direction:column;gap:10px;">
					<button class="btn btn-primary" style="width:100%;padding:12px;" onclick="applyAllIn('research')">
						<i class="fas fa-flask"></i> 强化科研能力 → ${currentVal + transferVal}
					</button>
					<button class="btn btn-success" style="width:100%;padding:12px;" onclick="applyAllIn('social')">
						<i class="fas fa-users"></i> 强化社交能力 → ${currentVal + transferVal}
					</button>
					<button class="btn btn-accent" style="width:100%;padding:12px;" onclick="applyAllIn('favor')">
						<i class="fas fa-heart"></i> 强化导师好感度 → ${currentVal + transferVal}
					</button>
				</div>
			`;
			
			window.applyAllIn = function(targetStat) {
				const oldVal = gameState.research; // 三项相等
				const transferVal = (oldVal - 1) * 2;
				const newVal = Math.min(20, oldVal + transferVal);
				
				const bonusDetails = [];
				
				if (targetStat === 'research') {
					gameState.research = newVal;
					gameState.social = 1;
					gameState.favor = 1;
					bonusDetails.push(`科研能力 ${oldVal} → ${newVal}`);
					bonusDetails.push(`社交能力 ${oldVal} → 1`);
					bonusDetails.push(`导师好感度 ${oldVal} → 1`);
				} else if (targetStat === 'social') {
					gameState.research = 1;
					gameState.social = newVal;
					gameState.favor = 1;
					bonusDetails.push(`科研能力 ${oldVal} → 1`);
					bonusDetails.push(`社交能力 ${oldVal} → ${newVal}`);
					bonusDetails.push(`导师好感度 ${oldVal} → 1`);
				} else {
					gameState.research = 1;
					gameState.social = 1;
					gameState.favor = newVal;
					bonusDetails.push(`科研能力 ${oldVal} → 1`);
					bonusDetails.push(`社交能力 ${oldVal} → 1`);
					bonusDetails.push(`导师好感度 ${oldVal} → ${newVal}`);
				}
				
				gameState.hiddenAwakened = true;
				gameState.hiddenAwakenType = 'chosen';
				
				closeModal();
				checkResearchUnlock(true);
				showHiddenAwakenResultModal('🎯 孤注一掷', '将全部力量集中到一点！', bonusDetails);
			};
			
			showModal('🎯 孤注一掷 - 选择强化属性', html, []);
		}

		// ★★★ 新增：显示隐藏觉醒结果弹窗 ★★★
		function showHiddenAwakenResultModal(effectName, effectDesc, bonusDetails) {
			const html = `
				<div style="text-align:center;">
					<div style="font-size:4rem;margin-bottom:15px;animation:pulse 1s infinite;">⚙️</div>
					<div style="font-size:1.5rem;font-weight:700;background:linear-gradient(135deg,#f39c12,#e74c3c);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:10px;">
						隐藏觉醒触发！
					</div>
					<div style="font-size:0.95rem;color:var(--text-secondary);margin-bottom:20px;">
						你发现了不同寻常的道路...
					</div>
				</div>
				
				<div style="background:linear-gradient(135deg,rgba(253,203,110,0.2),rgba(243,156,18,0.2));border-radius:12px;padding:15px;margin-bottom:15px;border:2px solid rgba(243,156,18,0.5);">
					<div style="text-align:center;margin-bottom:12px;">
						<div style="font-size:1.3rem;font-weight:700;color:#f39c12;margin-bottom:5px;">${effectName}</div>
						<div style="font-size:0.85rem;color:var(--text-secondary);font-style:italic;">${effectDesc}</div>
					</div>
					<div style="background:white;border-radius:8px;padding:12px;">
						<div style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:8px;text-align:center;">⚙️ 觉醒效果 ⚙️</div>
						<div style="display:flex;flex-direction:column;gap:6px;">
							${bonusDetails.map(detail => `
								<div style="display:flex;align-items:center;justify-content:center;gap:8px;padding:6px 12px;background:linear-gradient(135deg,rgba(253,203,110,0.15),rgba(243,156,18,0.15));border-radius:6px;font-size:0.85rem;font-weight:500;color:#d68910;">
									${detail.startsWith('⚠️') || detail.startsWith('✨') ? '' : '<i class="fas fa-star"></i>'} ${detail}
								</div>
							`).join('')}
						</div>
					</div>
				</div>
				
				<div style="text-align:center;padding:10px;background:var(--light-bg);border-radius:8px;font-size:0.85rem;">
					<div style="color:var(--primary-color);font-weight:600;margin-bottom:5px;">📜 开启博士修炼之路</div>
					<div style="color:var(--text-secondary);">博士毕业要求：科研分 ≥ 7</div>
				</div>
			`;
			
			showModal('⚙️ 隐藏觉醒', html, [
				{ text: '🎯 踏上独特之路', class: 'btn-warning', action: () => {
					addLog('隐藏觉醒', `触发【${effectName}】`, bonusDetails.join('，'));
					closeModal();
					updateAllUI();
					renderPaperSlots();
					
					if (gameState.pendingConference) {
						const grade = gameState.pendingConference;
						gameState.pendingConference = null;
						setTimeout(() => showConferenceModal(grade), 300);
					}
				}}
			]);
		}

		// ★★★ 新增：应用普通觉醒效果（原有逻辑提取） ★★★
		function applyNormalAwaken(charData) {
			const character = gameState.character;
			let effectName = '';
			let effectDesc = '';
			let bonusDetails = [];
			
			switch (character) {
				case 'genius':
					effectName = '🧬 学术天赋觉醒';
					effectDesc = '院士转世的血脉开始沸腾，过往成就化为实力！';
					const aCount = gameState.paperA || 0;
					if (aCount > 0) {
						// ★★★ 修改：每篇A类论文科研+2，上限+2 ★★★
						const researchGain = aCount * 2;  // 原来是 aCount * 1，改为 aCount * 2
						const maxGain = aCount * 2;
						gameState.researchMax = (gameState.researchMax || 20) + maxGain;
						gameState.research = Math.min(gameState.researchMax, gameState.research + researchGain);
						bonusDetails.push(`A类论文 ${aCount} 篇`);
						bonusDetails.push(`科研能力 +${researchGain}`);
						bonusDetails.push(`科研能力上限 +${maxGain}（现为${gameState.researchMax}）`);
					} else {
						bonusDetails.push('暂无A类论文，继续努力！');
					}
					break;
					
				case 'social':
					effectName = '🌐 人脉网络激活';
					effectDesc = '社交达人的人脉全面绽放，冥冥之中影响了审稿人分布！';
					gameState.socialAwakened = true;
					
					const socialVal = gameState.social;
					let normalP = Math.max(0, 0.40 - socialVal * 0.01);
					let kindP = 0.10 + socialVal * 0.005;
					let expertP = 0.10 + socialVal * 0.01;
					let hostileP = Math.max(0, 0.10 - socialVal * 0.005);
					let gptP = Math.max(0, 0.20 - socialVal * 0.005);
					let questionsP = Math.max(0, 0.10 - socialVal * 0.005);
					
					const totalP = normalP + kindP + expertP + hostileP + gptP + questionsP;
					normalP /= totalP;
					kindP /= totalP;
					expertP /= totalP;
					hostileP /= totalP;
					gptP /= totalP;
					questionsP /= totalP;
					
					gameState.reviewerDistribution = {
						normal: normalP,
						kind: kindP,
						expert: expertP,
						hostile: hostileP,
						gpt: gptP,
						questions: questionsP
					};
					
					bonusDetails.push(`转博时社交: ${socialVal}`);
					bonusDetails.push(`审稿人分布已永久改变`);
					break;
					
				case 'rich':
					effectName = '💎 财富倍增术';
					effectDesc = '富可敌国的底蕴显现，金币储备瞬间翻三倍！';
					const oldGold = gameState.gold;
					gameState.gold = gameState.gold * 3;
					bonusDetails.push(`金币 ${oldGold} → ${gameState.gold} (×3)`);
					break;
					
				case 'teacher-child':
					effectName = '👑 血脉共鸣';
					effectDesc = '导师子女的身份优势凸显，将人脉转化为实际资源！';
					const oldFavorTC = gameState.favor;
					if (oldFavorTC > 12) {
						const overflow = oldFavorTC - 12;
						gameState.favor = 12;
						gameState.research = Math.min(20, gameState.research + overflow);
						gameState.gold += overflow;
						bonusDetails.push(`导师好感度 ${oldFavorTC} → 12`);
						bonusDetails.push(`科研能力 +${overflow}`);
						bonusDetails.push(`金币 +${overflow}`);
					} else {
						bonusDetails.push(`导师好感度未超过12，暂无转化`);
					}
					break;
					
				case 'chosen':
					effectName = '✨ 查缺补漏';
					effectDesc = '天选之人的命运齿轮转动，短板瞬间补齐！';
					const maxStat = Math.max(gameState.research, gameState.social, gameState.favor);
					const oldStats = { research: gameState.research, social: gameState.social, favor: gameState.favor };
					gameState.research = Math.min(20, maxStat);
					gameState.social = Math.min(20, maxStat);
					gameState.favor = Math.min(20, maxStat);
					if (oldStats.research !== maxStat) bonusDetails.push(`科研能力 ${oldStats.research} → ${gameState.research}`);
					if (oldStats.social !== maxStat) bonusDetails.push(`社交能力 ${oldStats.social} → ${gameState.social}`);
					if (oldStats.favor !== maxStat) bonusDetails.push(`导师好感度 ${oldStats.favor} → ${gameState.favor}`);
					if (bonusDetails.length === 0) bonusDetails.push('属性已达最优，无需补齐');
					break;
					
				case 'normal':
				default:
					effectName = '🔥 我命由我不由天';
					effectDesc = '平凡之人爆发出惊人潜力，全面突破自我极限！';
					const oldR = gameState.research, oldS = gameState.social, oldF = gameState.favor, oldG = gameState.gold;
					gameState.research = Math.min(20, gameState.research * 2);
					gameState.social = Math.min(20, gameState.social * 2);
					gameState.favor = Math.min(20, gameState.favor * 2);
					gameState.gold = gameState.gold * 2;
					bonusDetails.push(`科研能力 ${oldR} → ${gameState.research} (×2)`);
					bonusDetails.push(`社交能力 ${oldS} → ${gameState.social} (×2)`);
					bonusDetails.push(`导师好感度 ${oldF} → ${gameState.favor} (×2)`);
					bonusDetails.push(`金币 ${oldG} → ${gameState.gold} (×2)`);
					break;
			}
			
			checkResearchUnlock(true);
			
			const html = `
				<div style="text-align:center;">
					<div style="font-size:4rem;margin-bottom:15px;animation:pulse 1s infinite;">⚡</div>
					<div style="font-size:1.5rem;font-weight:700;background:linear-gradient(135deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:10px;">
						渡劫成功！
					</div>
					<div style="font-size:0.95rem;color:var(--text-secondary);margin-bottom:20px;">
						恭喜突破硕士境界，晋升博士修炼者！
					</div>
				</div>
				
				<div style="background:linear-gradient(135deg,rgba(102,126,234,0.15),rgba(118,75,162,0.15));border-radius:12px;padding:15px;margin-bottom:15px;border:2px solid rgba(102,126,234,0.3);">
					<div style="text-align:center;margin-bottom:12px;">
						<div style="font-size:1.3rem;font-weight:700;color:#667eea;margin-bottom:5px;">${effectName}</div>
						<div style="font-size:0.85rem;color:var(--text-secondary);font-style:italic;">${effectDesc}</div>
					</div>
					<div style="background:white;border-radius:8px;padding:12px;">
						<div style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:8px;text-align:center;">✨ 获得加成 ✨</div>
						<div style="display:flex;flex-direction:column;gap:6px;">
							${bonusDetails.map(detail => `
								<div style="display:flex;align-items:center;justify-content:center;gap:8px;padding:6px 12px;background:linear-gradient(135deg,rgba(0,184,148,0.1),rgba(85,239,196,0.1));border-radius:6px;font-size:0.9rem;font-weight:500;color:var(--success-color);">
									<i class="fas fa-arrow-up"></i> ${detail}
								</div>
							`).join('')}
						</div>
					</div>
				</div>
				
				<div style="text-align:center;padding:10px;background:var(--light-bg);border-radius:8px;font-size:0.85rem;">
					<div style="color:var(--primary-color);font-weight:600;margin-bottom:5px;">📜 新的修炼目标</div>
					<div style="color:var(--text-secondary);">博士毕业要求：科研分 ≥ 7</div>
					<div style="color:var(--text-secondary);">修炼年限：5年</div>
				</div>
			`;
			
			if (!document.getElementById('tribulation-style')) {
				const style = document.createElement('style');
				style.id = 'tribulation-style';
				style.textContent = `
					@keyframes pulse {
						0%, 100% { transform: scale(1); opacity: 1; }
						50% { transform: scale(1.1); opacity: 0.8; }
					}
				`;
				document.head.appendChild(style);
			}
			
			showModal('⚡ 转博渡劫', html, [
				{ text: '🎯 开启博士修炼之路', class: 'btn-primary', action: () => {
					addLog('转博渡劫', `触发【${effectName}】`, bonusDetails.join('，'));
					closeModal();
					updateAllUI();
					renderPaperSlots();
					
					if (gameState.pendingConference) {
						const grade = gameState.pendingConference;
						gameState.pendingConference = null;
						setTimeout(() => showConferenceModal(grade), 300);
					}
				}}
			]);
		}
		
        // ==================== 论文推广功能 ====================
		function promotePaper(index, type) {
			const paper = gameState.publishedPapers[index];
			if (!paper) return;

			if (!paper.promotions) {
				paper.promotions = { arxiv: false, github: false, xiaohongshu: false, quantumbit: false };
			}
			if (!paper.citationMultiplier) paper.citationMultiplier = 1;

			if (paper.promotions[type]) return;

			const typeNames = {
				arxiv: '挂arxiv',
				github: 'github开源',
				xiaohongshu: '小红书宣传',
				quantumbit: '量子位封面'
			};

			let result = '';
			let canProceed = true;
			
			switch(type) {
				case 'arxiv': {
					const baseSanCost = 3;
					const actualSanCost = Math.abs(getActualSanChange(-baseSanCost));
					
					if (gameState.san < actualSanCost) {
						const tipText = actualSanCost !== baseSanCost 
							? `<p>SAN值不足！基础消耗${baseSanCost}点，怠惰×${gameState.reversedAwakened ? 3 : 2}后需要${actualSanCost}点SAN值。</p>` 
							: `<p>SAN值不足！需要至少${baseSanCost}点SAN值。</p>`;
						showModal('❌ 操作失败', tipText, 
							[{ text: '确定', class: 'btn-primary', action: closeModal }]);
						return;
					}
					paper.promotions.arxiv = true;
					// ★★★ 改为加法：+0.25 ★★★
					paper.citationMultiplier += 0.25;
					const sanText = actualSanCost !== baseSanCost 
						? `SAN值-${actualSanCost}（怠惰×${gameState.reversedAwakened ? 3 : 2}）` 
						: `SAN值-${baseSanCost}`;
					result = `${sanText}，论文引用速度+25%`;
					canProceed = changeSan(-baseSanCost);
					break;
				}
				case 'github': {
					const baseSanCost = 6;
					const actualSanCost = Math.abs(getActualSanChange(-baseSanCost));
					
					if (gameState.san < actualSanCost) {
						const tipText = actualSanCost !== baseSanCost 
							? `<p>SAN值不足！基础消耗${baseSanCost}点，怠惰×${gameState.reversedAwakened ? 3 : 2}后需要${actualSanCost}点SAN值。</p>` 
							: `<p>SAN值不足！需要至少${baseSanCost}点SAN值。</p>`;
						showModal('❌ 操作失败', tipText, 
							[{ text: '确定', class: 'btn-primary', action: closeModal }]);
						return;
					}
					paper.promotions.github = true;
					// ★★★ 改为加法：+0.5 ★★★
					paper.citationMultiplier += 0.5;
					const sanText = actualSanCost !== baseSanCost 
						? `SAN值-${actualSanCost}（怠惰×${gameState.reversedAwakened ? 3 : 2}）` 
						: `SAN值-${baseSanCost}`;
					result = `${sanText}，论文引用速度+50%`;
					canProceed = changeSan(-baseSanCost);
					break;
				}
				case 'xiaohongshu': {
					const baseSanCost = 3;
					const actualSanCost = Math.abs(getActualSanChange(-baseSanCost));
					
					if (gameState.san < actualSanCost) {
						const tipText = actualSanCost !== baseSanCost 
							? `<p>SAN值不足！基础消耗${baseSanCost}点，怠惰×${gameState.reversedAwakened ? 3 : 2}后需要${actualSanCost}点SAN值。</p>` 
							: `<p>SAN值不足！需要至少${baseSanCost}点SAN值。</p>`;
						showModal('❌ 操作失败', tipText, 
							[{ text: '确定', class: 'btn-primary', action: closeModal }]);
						return;
					}
					paper.promotions.xiaohongshu = true;
					// ★★★ 改为加法：+0.25 ★★★
					paper.citationMultiplier += 0.25;
					const sanText = actualSanCost !== baseSanCost 
						? `SAN值-${actualSanCost}（怠惰×${gameState.reversedAwakened ? 3 : 2}）` 
						: `SAN值-${baseSanCost}`;
					result = `${sanText}，论文引用速度+25%`;
					canProceed = changeSan(-baseSanCost);
					break;
				}
				case 'quantumbit':
					// ★★★ 量子位保持不变，直接+100引用 ★★★
					if (paper.grade !== 'A') {
						showModal('❌ 操作失败', '<p>只有A类论文才能上量子位封面！</p>', 
							[{ text: '确定', class: 'btn-primary', action: closeModal }]);
						return;
					}
					if (gameState.gold < 10) {
						showModal('❌ 操作失败', '<p>金钱不足！需要至少10金币。</p>', 
							[{ text: '确定', class: 'btn-primary', action: closeModal }]);
						return;
					}
					paper.promotions.quantumbit = true;
					paper.citations += 100;
					gameState.totalCitations += 100;
					result = '金钱-10，论文引用+100';
					canProceed = changeGold(-10);
					break;
			}

			if (canProceed) {
				addLog('论文推广', `"${paper.title.substring(0, 15)}..." ${typeNames[type]}`, result);
				updateAllUI();
			}
		}

		// ==================== 获取会议统计信息（用于显示）====================

		/*** 获取会议的统计摘要信息*/
		function getConferenceStatsForDisplay(month, grade, isReversed) {
			const stats = getMonthStats(month, grade, isReversed);
			const confInfo = getConferenceInfo(month, grade, gameState.year);
			
			// 计算影响因子
			const impactFactor = getConferenceImpactFactor({ month: month }, grade);
			
			// 计算中稿均分
			let avgAcceptedScore = '-';
			if (stats && stats.submissions >= 10) {
				const totalAccepted = (stats.poster || 0) + (stats.oral || 0) + (stats.bestPaper || 0);
				if (totalAccepted > 0 && stats.avgScorePoster) {
					const weightedSum = (stats.avgScorePoster * (stats.poster || 0)) + 
									  (stats.avgScoreOral * (stats.oral || 0)) + 
									  (stats.avgScoreBestPaper * (stats.bestPaper || 0));
					avgAcceptedScore = Math.round(weightedSum / totalAccepted);
				}
			}
			
			return {
				name: confInfo.name,
				fullName: confInfo.fullName,
				year: confInfo.year,
				submissions: stats?.submissions || 0,
				acceptRate: stats?.acceptRate || 0,
				avgAcceptedScore: avgAcceptedScore,
				impactFactor: impactFactor,
				hasEnoughData: stats && stats.submissions >= 10
			};
		}

		/**
		 * 生成会议tooltip文本
		 */
		function generateConferenceTooltip(month, grade, isReversed) {
			const info = getConferenceStatsForDisplay(month, grade, isReversed);
			
			let tooltip = `${info.fullName} ${info.year}`;
			
			if (info.hasEnoughData) {
				tooltip += `\n━━━━━━━━━━━━`;
				tooltip += `\n📊 投稿数: ${info.submissions}`;
				tooltip += `\n✅ 录用率: ${(info.acceptRate * 100).toFixed(1)}%`;
				tooltip += `\n📈 影响因子: ${info.impactFactor.toFixed(2)}`;
				tooltip += `\n🎯 中稿均分: ${info.avgAcceptedScore}`;
			} else {
				tooltip += `\n(数据不足，暂无统计)`;
			}
			
			return tooltip;
		}

        // ==================== 论文工作站 ====================
		
		
		
		function renderPaperSlots() {
			const container = document.getElementById('paper-slots');
			let html = '';
			
			// 预先获取当前月份的会议信息
			const confA = getConferenceInfo(gameState.month, 'A', gameState.year);
			const confB = getConferenceInfo(gameState.month, 'B', gameState.year);
			const confC = getConferenceInfo(gameState.month, 'C', gameState.year);
			
			// ★★★ 新增：获取tooltip信息 ★★★
			const tooltipA = generateConferenceTooltip(gameState.month, 'A', gameState.isReversed);
			const tooltipB = generateConferenceTooltip(gameState.month, 'B', gameState.isReversed);
			const tooltipC = generateConferenceTooltip(gameState.month, 'C', gameState.isReversed);
			
			// ★★★ 新增：获取简要统计用于按钮显示 ★★★
			const statsA = getConferenceStatsForDisplay(gameState.month, 'A', gameState.isReversed);
			const statsB = getConferenceStatsForDisplay(gameState.month, 'B', gameState.isReversed);
			const statsC = getConferenceStatsForDisplay(gameState.month, 'C', gameState.isReversed);
			
			for (let i = 0; i < 4; i++) {
				const unlocked = i < gameState.paperSlots;
				const paper = gameState.papers[i];
				
				if (!unlocked) {
					const req = [0, 6, 12, 18][i];
					html += `<div class="paper-slot locked">
						<div class="slot-header">
							<span class="slot-title">论文槽${i + 1}</span>
							<span class="reviewing-badge"><i class="fas fa-lock"></i> 科研${req}解锁</span>
						</div>
					</div>`;
				} else if (!paper) {
					// ★★★ 修改：显示会议统计信息 ★★★
					html += `<div class="paper-slot">
						<div class="slot-header">
							<span class="slot-title">论文槽${i + 1}</span>
							<span style="color:var(--text-secondary);font-size:0.75rem;">空闲</span>
						</div>
						<button class="new-paper-btn" onclick="createNewPaper(${i})">
							<i class="fas fa-plus"></i> 开启新论文
						</button>
						<div style="margin-top:8px;font-size:0.6rem;color:var(--text-secondary);text-align:center;">
							本月会议：A-${confA.name} | B-${confB.name} | C-${confC.name}
						</div>
						<div style="margin-top:4px;font-size:0.55rem;color:var(--text-secondary);text-align:center;">
							${statsA.hasEnoughData 
								? `录用率: A-${(statsA.acceptRate*100).toFixed(0)}% B-${(statsB.acceptRate*100).toFixed(0)}% C-${(statsC.acceptRate*100).toFixed(0)}%${statsA.submissions === 100 ? ' (默认值)' : ''}` 
								: '(统计数据加载中...)'}
						</div>
					</div>`;
				} else {
					const total = paper.ideaScore + paper.expScore + paper.writeScore;
					const canSubmit = paper.ideaScore > 0 && paper.expScore > 0 && paper.writeScore > 0 && !paper.reviewing;
					const reviewingBadgeClass = paper.reviewing ? `reviewing-badge grade-${paper.submittedGrade}` : '';
					
					let reviewingInfo = '';
					if (paper.reviewing) {
						const confName = paper.conferenceInfo ? paper.conferenceInfo.name : paper.submittedGrade + '类';
						reviewingInfo = `<span class="${reviewingBadgeClass}"><i class="fas fa-hourglass-half"></i> ${confName} 剩余${Math.max(0, paper.reviewMonths)}月</span>`;
					}
					
					// ★★★ 修改：增强投稿按钮的tooltip ★★★
					html += `<div class="paper-slot active">
						<div class="slot-header">
							<span class="slot-title">论文槽${i + 1}</span>
							${reviewingInfo}
						</div>
						<div class="paper-title">${paper.title}</div>
						<div class="paper-scores">
							<div class="score-box"><div class="label">Idea</div><div class="value">${paper.ideaScore}</div></div>
							<div class="score-box"><div class="label">实验</div><div class="value">${paper.expScore}</div></div>
							<div class="score-box"><div class="label">写作</div><div class="value">${paper.writeScore}</div></div>
						</div>
						<div class="paper-total">总分: ${total}</div>
						<div class="paper-actions">
							<button class="btn btn-danger" onclick="submitPaper(${i},'A')" ${!canSubmit?'disabled':''} 
									title="${tooltipA.replace(/"/g, '&quot;')}">
								<i class="fas fa-star"></i> A-${confA.name}
								${statsA.hasEnoughData ? `<span style="font-size:0.6rem;opacity:0.8;">(${(statsA.acceptRate*100).toFixed(0)}%)</span>` : ''}
							</button>
							<button class="btn btn-warning" onclick="submitPaper(${i},'B')" ${!canSubmit?'disabled':''} 
									title="${tooltipB.replace(/"/g, '&quot;')}">
								<i class="fas fa-certificate"></i> B-${confB.name}
								${statsB.hasEnoughData ? `<span style="font-size:0.6rem;opacity:0.8;">(${(statsB.acceptRate*100).toFixed(0)}%)</span>` : ''}
							</button>
							<button class="btn btn-success" onclick="submitPaper(${i},'C')" ${!canSubmit?'disabled':''} 
									title="${tooltipC.replace(/"/g, '&quot;')}">
								<i class="fas fa-check"></i> C-${confC.name}
								${statsC.hasEnoughData ? `<span style="font-size:0.6rem;opacity:0.8;">(${(statsC.acceptRate*100).toFixed(0)}%)</span>` : ''}
							</button>
							<button class="btn btn-info" onclick="abandonPaper(${i})" ${paper.reviewing?'disabled':''}>
								<i class="fas fa-trash"></i> 放弃
							</button>
						</div>
					</div>`;
				}
			}
			container.innerHTML = html;
		}

        function generatePaperTitle() {
            const w = paperTitleWords;
            const templates = [
                () => `${rand(w.adjectives)} ${rand(w.nouns)} for ${rand(w.domains)} ${rand(w.verbs)}`,
                () => `${rand(w.verbs)} ${rand(w.domains)} with ${rand(w.adjectives)} ${rand(w.nouns)}`,
                () => `${rand(w.adjectives)} ${rand(w.adjectives)} ${rand(w.nouns)}`,
                () => `Towards ${rand(w.adjectives)} ${rand(w.domains)} ${rand(w.nouns)}`,
                () => `${rand(w.domains)} ${rand(w.verbs)} via ${rand(w.adjectives)} ${rand(w.nouns)}`
            ];
            return rand(templates)();
        }

        function createNewPaper(slot) {
            const title = generatePaperTitle();
            gameState.papers[slot] = {
                title: title,
                ideaScore: 0,
                expScore: 0,
                writeScore: 0,
                reviewing: false,
                reviewMonths: 0,
                submittedGrade: null,
                submittedScore: 0
            };
            addLog('新论文', `在论文槽${slot + 1}开启：${title}`);
            renderPaperSlots();
        }

        function checkResearchUnlock(silent = false) {
            // 愚钝之院士转世：已全部解锁
            if (gameState.isReversed && gameState.character === 'genius') {
                gameState.paperSlots = 4;
                return;
            }
            
            const thresholds = [0, 6, 12, 18];
            let newUnlock = false;
            for (let i = 1; i < 4; i++) {
                if (gameState.research >= thresholds[i] && gameState.paperSlots <= i) {
                    gameState.paperSlots = i + 1;
                    newUnlock = true;
                }
            }
            if (newUnlock && !silent) {
                showModal('🎉 新论文槽解锁！', 
                    `<p>恭喜！科研能力达到${gameState.research}，解锁论文槽${gameState.paperSlots}！</p>`,
                    [{ text: '太棒了！', class: 'btn-primary', action: closeModal }]);
                renderPaperSlots();
            }
        }
		
        // ==================== 操作功能 ====================
		function readPaper() {
			// ★★★ 修改：检查行动次数而非单次标志 ★★★
			if (gameState.actionCount >= gameState.actionLimit) {
				showModal('❌ 操作失败', `<p>本月行动次数已用完！（${gameState.actionCount}/${gameState.actionLimit}）</p>`, 
					[{ text: '确定', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			const has4K = gameState.buffs.permanent.some(b => b.type === 'read_san_reduce');
			const baseSanCost = has4K ? 1 : 2;
			const actualSanCost = Math.abs(getActualSanChange(-baseSanCost));
			
			if (gameState.san < actualSanCost) {
				const tipText = actualSanCost !== baseSanCost 
					? `<p>SAN值不足！基础消耗${baseSanCost}点，怠惰×${gameState.reversedAwakened ? 3 : 2}后需要${actualSanCost}点SAN值。</p>` 
					: `<p>SAN值不足！需要至少${baseSanCost}点SAN值。</p>`;
				showModal('❌ 操作失败', tipText, 
					[{ text: '确定', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			// ★★★ 修改：增加行动计数 ★★★
			gameState.actionCount++;
			gameState.actionUsed = gameState.actionCount >= gameState.actionLimit;
			
			gameState.buffs.temporary.push({ type: 'idea_bonus', name: '下次想idea分数+1', value: 1, permanent: false });
			gameState.readCount++;

			let result = `SAN值-${actualSanCost}`;
			if (has4K) result += '（4K显示器生效）';
			if (actualSanCost !== baseSanCost) {
				result += `（怠惰×${gameState.reversedAwakened ? 3 : 2}）`;
			}
			result += '，获得临时buff：下次想idea分数+1';
			
			// ★★★ 新增：显示行动次数 ★★★
			if (gameState.actionLimit > 1) {
				result += `（行动${gameState.actionCount}/${gameState.actionLimit}）`;
			}

			if (gameState.readCount % 5 === 0) {
				changeResearch(1);
				result += `，阅读论文达到${gameState.readCount}次，科研能力+1`;
			}

			addLog('看论文', '认真阅读了学术论文', result);
			updateBuffs();
			changeSan(-baseSanCost);
		}

		function partTimeJob() {
			// ★★★ 修改：检查行动次数 ★★★
			if (gameState.actionCount >= gameState.actionLimit) {
				showModal('❌ 操作失败', `<p>本月行动次数已用完！（${gameState.actionCount}/${gameState.actionLimit}）</p>`, 
					[{ text: '确定', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			const baseSanCost = 5;
			const actualSanCost = Math.abs(getActualSanChange(-baseSanCost));
			
			if (gameState.san < actualSanCost) {
				const tipText = actualSanCost !== baseSanCost 
					? `<p>SAN值不足！基础消耗${baseSanCost}点，怠惰×${gameState.reversedAwakened ? 3 : 2}后需要${actualSanCost}点SAN值。</p>` 
					: `<p>SAN值不足！需要至少${baseSanCost}点SAN值。</p>`;
				showModal('❌ 操作失败', tipText, 
					[{ text: '确定', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			// ★★★ 修改：增加行动计数 ★★★
			gameState.actionCount++;
			gameState.actionUsed = gameState.actionCount >= gameState.actionLimit;
			gameState.workCount = (gameState.workCount || 0) + 1;
			
			let result = `SAN值-${actualSanCost}`;
			if (actualSanCost !== baseSanCost) {
				result += `（怠惰×${gameState.reversedAwakened ? 3 : 2}）`;
			}
			result += '，金钱+2';
			
			// ★★★ 新增：显示行动次数 ★★★
			if (gameState.actionLimit > 1) {
				result += `（行动${gameState.actionCount}/${gameState.actionLimit}）`;
			}
			
			addLog('打工', '辛苦工作赚取生活费', result);
			changeStats({ san: -baseSanCost, gold: 2 });
		}


		function thinkIdea() {
			// ★★★ 修改：检查行动次数 ★★★
			if (gameState.actionCount >= gameState.actionLimit) {
				showModal('❌ 操作失败', `<p>本月行动次数已用完！（${gameState.actionCount}/${gameState.actionLimit}）</p>`, 
					[{ text: '确定', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			// 检查debuff存在性（只在第一次生效）
			const hasExhaustion = gameState.buffs.temporary.some(b => b.type === 'idea_exhaustion');
			const hasStolen = gameState.buffs.temporary.some(b => b.type === 'idea_stolen');
			const hasSlack = gameState.buffs.temporary.some(b => b.type === 'slack_debuff');
			
			// 订阅buff（每次都生效）
			const geminiSub = gameState.buffs.temporary.find(b => b.type === 'idea_san_reduce');
			const hasGeminiSub = !!geminiSub;
			
			// SAN消耗计算
			let baseSanCost = 2;
			if (hasGeminiSub) {
				baseSanCost = Math.max(1, baseSanCost - 1);
			}
			
			const actualSanCost = Math.abs(getActualSanChange(-baseSanCost));
			
			if (gameState.san < actualSanCost) {
				const tipText = actualSanCost !== baseSanCost 
					? `<p>SAN值不足！基础消耗${baseSanCost}点，怠惰×${gameState.reversedAwakened ? 3 : 2}后需要${actualSanCost}点SAN值。</p>` 
					: `<p>SAN值不足！需要至少${baseSanCost}点SAN值。</p>`;
				showModal('❌ 操作失败', tipText, 
					[{ text: '确定', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			const available = gameState.papers.map((p, i) => ({ paper: p, index: i }))
				.filter(({ paper }) => paper && !paper.reviewing);
			if (available.length === 0) {
				showModal('无法操作', '<p>没有可用的论文！请先开启一篇新论文。</p>', 
					[{ text: '确定', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			showPaperSelectModal('想idea', available, (index) => {
				gameState.actionCount++;
				gameState.actionUsed = gameState.actionCount >= gameState.actionLimit;
				gameState.ideaClickCount = (gameState.ideaClickCount || 0) + 1;
				
				const paper = gameState.papers[index];
				const oldScore = paper.ideaScore;
				
				let times = 1 + countBuff('idea_times');
				
				// 主动技能加成
				let effectiveResearch = gameState.research;
				let skillUsed = false;
				let skillSource = '';
				
				if (gameState.nextIdeaResearchBonus > 0) {
					effectiveResearch += gameState.nextIdeaResearchBonus;
					skillUsed = true;
					skillSource = gameState.nextIdeaBonusSource === 'senior' ? '师兄师姐救我' : '导师救我';
					gameState.nextIdeaResearchBonus = 0;
					gameState.nextIdeaBonusSource = null;
				}
				
				// ★★★ 核心修改：新的循环逻辑 ★★★
				let currentScore = oldScore;
				let scoreChanges = [];  // 记录每次的分数变化
				
				for (let i = 0; i < times; i++) {
					// ★★★ 第一次使用所有buff，后续只使用永久buff ★★★
					const permanentOnly = (i > 0);
					let gen = calculateScoreWithResearch('idea', effectiveResearch, permanentOnly);
					
					// ★★★ 订阅加成：每次都生效 ★★★
					if (hasGeminiSub && geminiSub.bonusScore) {
						gen += geminiSub.bonusScore;
					}
					
					// ★★★ debuff：只有第一次生效 ★★★
					if (i === 0) {
						if (hasExhaustion) {
							gen = Math.floor(gen / 2);
						}
						if (hasStolen) {
							gen = Math.floor(gen / 2);
						}
						if (hasSlack) {
							gen = Math.floor(gen / 2);
						}
					}
					
					// ★★★ 每次循环都触发保底机制 ★★★
					const newScore = Math.max(gen, currentScore + 1);
					scoreChanges.push({ generated: gen, result: newScore, wasGuaranteed: gen < currentScore + 1 });
					currentScore = newScore;
				}
				
				paper.ideaScore = currentScore;
				
				// 清除已生效的debuff
				if (hasExhaustion) {
					gameState.buffs.temporary = gameState.buffs.temporary.filter(b => b.type !== 'idea_exhaustion');
				}
				if (hasStolen) {
					gameState.buffs.temporary = gameState.buffs.temporary.filter(b => b.type !== 'idea_stolen');
				}
				
				// 疲劳累积检测
				if (gameState.ideaClickCount % 5 === 0) {
					gameState.buffs.temporary.push({ 
						type: 'idea_exhaustion', 
						name: '灵感枯竭：下次想idea总分÷2', 
						value: 0.5, 
						multiply: true, 
						permanent: false 
					});
					addLog('⚠️ 疲劳累积', '灵感枯竭', '连续想idea5次，下次想idea总分除以2');
				}
				
				// 消耗临时buff
				consumeTempBuff('idea_times');
				consumeTempBuff('idea_bonus');
				
				// 构建日志
				let result = `SAN值-${actualSanCost}`;
				if (actualSanCost !== baseSanCost) {
					result += `（怠惰×${gameState.reversedAwakened ? 3 : 2}）`;
				}
				if (skillUsed) {
					result += `（${skillSource}生效！）`;
				}
				if (hasGeminiSub) result += '（Gemini: 每次+4）';
				if (hasExhaustion) result += '（首次灵感枯竭÷2）';
				if (hasStolen) result += '（首次被偷idea÷2）';
				if (hasSlack) result += '（首次松懈÷2）';
				if (times > 1) result += `（想${times}次）`;
				
				if (gameState.actionLimit > 1) {
					result += `（行动${gameState.actionCount}/${gameState.actionLimit}）`;
				}
				
				// ★★★ 显示详细的分数变化过程 ★★★
				const guaranteedCount = scoreChanges.filter(c => c.wasGuaranteed).length;
				result += `，idea分 ${oldScore} → ${currentScore}`;
				if (guaranteedCount > 0) {
					result += `（${guaranteedCount}次保底生效）`;
				}
				
				addLog('想idea', `为"${paper.title.substring(0, 15)}..."思考idea`, result);
				renderPaperSlots();
				changeSan(-baseSanCost);
				updateBuffs();
			});
		}

		function doExperiment() {
			if (gameState.actionCount >= gameState.actionLimit) {
				showModal('❌ 操作失败', `<p>本月行动次数已用完！（${gameState.actionCount}/${gameState.actionLimit}）</p>`, 
					[{ text: '确定', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			// 检查debuff（只在第一次生效）
			const hasOverheat = gameState.buffs.temporary.some(b => b.type === 'exp_overheat');
			const hasSlack = gameState.buffs.temporary.some(b => b.type === 'slack_debuff');
			
			// 订阅buff（每次都生效）
			const gptSub = gameState.buffs.temporary.find(b => b.type === 'exp_san_reduce');
			const hasGptSub = !!gptSub;
			
			let baseSanCost = 3;
			if (hasGptSub) {
				baseSanCost = Math.max(1, baseSanCost - 1);
			}
			
			const actualSanCost = Math.abs(getActualSanChange(-baseSanCost));
			
			if (gameState.san < actualSanCost) {
				const tipText = actualSanCost !== baseSanCost 
					? `<p>SAN值不足！基础消耗${baseSanCost}点，怠惰×${gameState.reversedAwakened ? 3 : 2}后需要${actualSanCost}点SAN值。</p>` 
					: `<p>SAN值不足！需要至少${baseSanCost}点SAN值。</p>`;
				showModal('❌ 操作失败', tipText, 
					[{ text: '确定', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			const available = gameState.papers.map((p, i) => ({ paper: p, index: i }))
				.filter(({ paper }) => paper && !paper.reviewing && paper.ideaScore > 0);
			if (available.length === 0) {
				showModal('无法操作', '<p>没有可用的论文！需要先有idea分大于0的论文。</p>', 
					[{ text: '确定', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			showPaperSelectModal('做实验', available, (index) => {
				gameState.actionCount++;
				gameState.actionUsed = gameState.actionCount >= gameState.actionLimit;
				gameState.expClickCount = (gameState.expClickCount || 0) + 1;
				
				const paper = gameState.papers[index];
				const oldScore = paper.expScore;
				
				let times = 1 + countBuff('exp_times');
				
				// ★★★ 核心修改：新的循环逻辑 ★★★
				let currentScore = oldScore;
				let scoreChanges = [];
				
				for (let i = 0; i < times; i++) {
					// ★★★ 第一次使用所有buff，后续只使用永久buff ★★★
					const permanentOnly = (i > 0);
					let gen = calculateScore('exp', permanentOnly);
					
					// ★★★ 订阅加成：每次都生效 ★★★
					if (hasGptSub && gptSub.bonusScore) {
						gen += gptSub.bonusScore;
					}
					
					// ★★★ debuff：只有第一次生效 ★★★
					if (i === 0) {
						if (hasOverheat) {
							gen = Math.floor(gen / 2);
						}
						if (hasSlack) {
							gen = Math.floor(gen / 2);
						}
					}
					
					// ★★★ 每次循环都触发保底机制 ★★★
					const newScore = Math.max(gen, currentScore + 1);
					scoreChanges.push({ generated: gen, result: newScore, wasGuaranteed: gen < currentScore + 1 });
					currentScore = newScore;
				}
				
				paper.expScore = currentScore;
				
				// 清除已生效的debuff
				if (hasOverheat) {
					gameState.buffs.temporary = gameState.buffs.temporary.filter(b => b.type !== 'exp_overheat');
				}
				
				// 疲劳累积
				if (gameState.expClickCount % 5 === 0) {
					gameState.buffs.temporary.push({ 
						type: 'exp_overheat', 
						name: '主机发烫：下次做实验总分÷2', 
						value: 0.5, 
						multiply: true, 
						permanent: false 
					});
					addLog('⚠️ 疲劳累积', '主机发烫', '连续做实验5次，下次做实验总分除以2');
				}
				
				consumeTempBuff('exp_times');
				consumeTempBuff('exp_bonus');
				
				// 构建日志
				let result = `SAN值-${actualSanCost}`;
				if (actualSanCost !== baseSanCost) {
					result += `（怠惰×${gameState.reversedAwakened ? 3 : 2}）`;
				}
				if (hasGptSub) result += '（GPT: 每次+4）';
				if (hasOverheat) result += '（首次主机发烫÷2）';
				if (hasSlack) result += '（首次松懈÷2）';
				if (times > 1) result += `（做${times}次）`;
				
				if (gameState.actionLimit > 1) {
					result += `（行动${gameState.actionCount}/${gameState.actionLimit}）`;
				}
				
				const guaranteedCount = scoreChanges.filter(c => c.wasGuaranteed).length;
				result += `，实验分 ${oldScore} → ${currentScore}`;
				if (guaranteedCount > 0) {
					result += `（${guaranteedCount}次保底生效）`;
				}
				
				addLog('做实验', `为"${paper.title.substring(0, 15)}..."做实验`, result);
				renderPaperSlots();
				changeSan(-baseSanCost);
				updateBuffs();
			});
		}

		function writePaper() {
			if (gameState.actionCount >= gameState.actionLimit) {
				showModal('❌ 操作失败', `<p>本月行动次数已用完！（${gameState.actionCount}/${gameState.actionLimit}）</p>`, 
					[{ text: '确定', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			// 检查debuff（只在第一次生效）
			const hasWritersBlock = gameState.buffs.temporary.some(b => b.type === 'write_block');
			const hasSlack = gameState.buffs.temporary.some(b => b.type === 'slack_debuff');
			
			// 订阅buff（每次都生效）
			const claudeSub = gameState.buffs.temporary.find(b => b.type === 'write_san_reduce_temp');
			const hasClaudeSub = !!claudeSub;
			
			const hasKeyboard = gameState.buffs.permanent.some(b => b.type === 'write_san_reduce');
			let baseSanCost = hasKeyboard ? 3 : 4;
			
			if (hasClaudeSub) {
				baseSanCost = Math.max(1, baseSanCost - 1);
			}
			
			const actualSanCost = Math.abs(getActualSanChange(-baseSanCost));
			
			if (gameState.san < actualSanCost) {
				const tipText = actualSanCost !== baseSanCost 
					? `<p>SAN值不足！基础消耗${baseSanCost}点，怠惰×${gameState.reversedAwakened ? 3 : 2}后需要${actualSanCost}点SAN值。</p>` 
					: `<p>SAN值不足！需要至少${baseSanCost}点SAN值。</p>`;
				showModal('❌ 操作失败', tipText, 
					[{ text: '确定', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			const available = gameState.papers.map((p, i) => ({ paper: p, index: i }))
				.filter(({ paper }) => paper && !paper.reviewing && paper.expScore > 0);
			if (available.length === 0) {
				showModal('无法操作', '<p>没有可用的论文！需要先有实验分大于0的论文。</p>', 
					[{ text: '确定', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			showPaperSelectModal('写论文', available, (index) => {
				gameState.actionCount++;
				gameState.actionUsed = gameState.actionCount >= gameState.actionLimit;
				gameState.writeClickCount = (gameState.writeClickCount || 0) + 1;
				
				const paper = gameState.papers[index];
				const oldScore = paper.writeScore;
				
				let times = 1 + countBuff('write_times');
				
				// ★★★ 核心修改：新的循环逻辑 ★★★
				let currentScore = oldScore;
				let scoreChanges = [];
				
				for (let i = 0; i < times; i++) {
					// ★★★ 第一次使用所有buff，后续只使用永久buff ★★★
					const permanentOnly = (i > 0);
					let gen = calculateScore('write', permanentOnly);
					
					// ★★★ 订阅加成：每次都生效 ★★★
					if (hasClaudeSub && claudeSub.bonusScore) {
						gen += claudeSub.bonusScore;
					}
					
					// ★★★ debuff：只有第一次生效 ★★★
					if (i === 0) {
						if (hasWritersBlock) {
							gen = Math.floor(gen / 2);
						}
						if (hasSlack) {
							gen = Math.floor(gen / 2);
						}
					}
					
					// ★★★ 每次循环都触发保底机制 ★★★
					const newScore = Math.max(gen, currentScore + 1);
					scoreChanges.push({ generated: gen, result: newScore, wasGuaranteed: gen < currentScore + 1 });
					currentScore = newScore;
				}
				
				paper.writeScore = currentScore;
				
				// 清除已生效的debuff
				if (hasWritersBlock) {
					gameState.buffs.temporary = gameState.buffs.temporary.filter(b => b.type !== 'write_block');
				}
				
				// 疲劳累积
				if (gameState.writeClickCount % 5 === 0) {
					gameState.buffs.temporary.push({ 
						type: 'write_block', 
						name: '无从下笔：下次写论文总分÷2', 
						value: 0.5, 
						multiply: true, 
						permanent: false 
					});
					addLog('⚠️ 疲劳累积', '无从下笔', '连续写论文5次，下次写论文总分除以2');
				}
				
				consumeTempBuff('write_times');
				consumeTempBuff('write_bonus');
				
				// 构建日志
				let result = `SAN值-${actualSanCost}`;
				if (hasKeyboard) result += '（机械键盘生效）';
				if (hasClaudeSub) result += '（Claude: 每次+4）';
				if (hasWritersBlock) result += '（首次无从下笔÷2）';
				if (hasSlack) result += '（首次松懈÷2）';
				if (times > 1) result += `（写${times}次）`;
				
				if (gameState.actionLimit > 1) {
					result += `（行动${gameState.actionCount}/${gameState.actionLimit}）`;
				}
				
				const guaranteedCount = scoreChanges.filter(c => c.wasGuaranteed).length;
				result += `，写作分 ${oldScore} → ${currentScore}`;
				if (guaranteedCount > 0) {
					result += `（${guaranteedCount}次保底生效）`;
				}
				
				addLog('写论文', `为"${paper.title.substring(0, 15)}..."写作`, result);
				renderPaperSlots();
				changeSan(-baseSanCost);
				updateBuffs();
			});
		}

		// ★★★ 修改：支持自定义科研值 + permanentOnly ★★★
		function calculateScoreWithResearch(type, customResearch, permanentOnly = false) {
			const base = customResearch * (0.5 + Math.random());
			const randomBonus = Math.floor(Math.random() * 6);
			let score = Math.round(base + randomBonus);

			let bonus = 0, multiplier = 1;
			const buffType = type + '_bonus';
			
			const buffsToCheck = permanentOnly 
				? gameState.buffs.permanent 
				: [...gameState.buffs.permanent, ...gameState.buffs.temporary];
			
			buffsToCheck.forEach(b => {
				if (b.type === buffType) {
					if (b.multiply) {
						multiplier += (b.value - 1);
					} else {
						bonus += b.value;
					}
				}
			});
			
			multiplier = Math.max(0, multiplier);
			return Math.max(0, Math.round(score * multiplier + bonus));
		}

		// ★★★ 修改：增加 permanentOnly 参数 ★★★
		function calculateScore(type, permanentOnly = false) {
			const base = gameState.research * (0.5 + Math.random());
			const randomBonus = Math.floor(Math.random() * 6);
			let score = Math.round(base + randomBonus);

			let bonus = 0, multiplier = 1;
			const buffType = type + '_bonus';
			
			// ★★★ 根据参数决定使用哪些buff ★★★
			const buffsToCheck = permanentOnly 
				? gameState.buffs.permanent 
				: [...gameState.buffs.permanent, ...gameState.buffs.temporary];
			
			buffsToCheck.forEach(b => {
				if (b.type === buffType) {
					if (b.multiply) {
						multiplier += (b.value - 1);
					} else {
						bonus += b.value;
					}
				}
			});
			
			multiplier = Math.max(0, multiplier);
			return Math.max(0, Math.round(score * multiplier + bonus));
		}

        function countBuff(type) {
            let count = 0;
            [...gameState.buffs.permanent, ...gameState.buffs.temporary].forEach(b => {
                if (b.type === type) count += b.value;
            });
            return count;
        }

        function consumeTempBuff(type) {
            gameState.buffs.temporary = gameState.buffs.temporary.filter(b => b.type !== type);
        }
		
        
		// ==================== 新增：统一审稿事件队列系统 ====================

		/**
		 * 开始处理本月的审稿结果
		 * @param {Array} slots - 待处理的审稿槽位索引数组（已按顺序）
		 * @param {Function} onComplete - 所有审稿和开会处理完成后的回调
		 */
		function startReviewProcessing(slots, onComplete) {
			if (!slots || slots.length === 0) {
				if (onComplete) onComplete();
				return;
			}
			
			// 初始化处理状态
			gameState._reviewProcessing = {
				pendingSlots: [...slots],        // 待处理的审稿槽位（按顺序）
				acceptedByConference: {},        // 按会议分组的中稿论文 { confKey: { confInfo, confLocation, papers: [] } }
				pendingConferences: [],          // 待处理的开会事件
				onComplete: onComplete           // 完成回调
			};
			
			// 开始处理第一个审稿结果
			processNextReviewInQueue();
		}

		/**
		 * 处理队列中的下一个审稿结果
		 */
		function processNextReviewInQueue() {
			const state = gameState._reviewProcessing;
			if (!state) return;
			
			if (state.pendingSlots.length === 0) {
				// 所有审稿结果已处理，开始处理开会事件
				prepareConferencesInQueue();
				return;
			}
			
			const slotIdx = state.pendingSlots.shift();
			const paper = gameState.papers[slotIdx];
			
			if (paper && paper.reviewing) {
				processPaperResult(slotIdx);
			} else {
				// 槽位已不在审稿状态，跳过处理下一个
				processNextReviewInQueue();
			}
		}

		/**
		 * 记录中稿论文的会议信息（在handlePaperAccepted中调用）
		 */
		function recordAcceptedPaperConference(paper, grade, acceptType) {
			const state = gameState._reviewProcessing;
			if (!state) return;
			
			const confInfo = paper.conferenceInfo || getConferenceInfo(paper.submittedMonth || gameState.month, grade, gameState.year);
			const confLocation = paper.conferenceLocation || getConferenceLocation(paper.title);
			
			// 生成会议唯一标识
			const confKey = `${confInfo.name}_${confInfo.year}`;
			
			if (!state.acceptedByConference[confKey]) {
				state.acceptedByConference[confKey] = {
					confInfo: confInfo,
					confLocation: confLocation,
					grade: grade,
					papers: []
				};
			}
			
			state.acceptedByConference[confKey].papers.push({
				title: paper.title,
				grade: grade,
				acceptType: acceptType
			});
		}

		/**
		 * 准备开会事件队列
		 */
		function prepareConferencesInQueue() {
			const state = gameState._reviewProcessing;
			if (!state) return;
			
			const conferences = Object.values(state.acceptedByConference);
			
			// 检查一箭双雕成就
			conferences.forEach(conf => {
				if (conf.papers.length >= 2) {
					if (!gameState.achievementConditions) {
						gameState.achievementConditions = {};
					}
					gameState.achievementConditions.twoInOneConference = true;
				}
			});
			
			// 存储待处理的会议
			state.pendingConferences = conferences;
			
			// 开始处理开会事件
			processNextConferenceInQueue();
		}

		/**
		 * 处理队列中的下一个开会事件
		 */
		function processNextConferenceInQueue() {
			const state = gameState._reviewProcessing;
			if (!state) return;
			
			if (!state.pendingConferences || state.pendingConferences.length === 0) {
				// 所有开会事件已处理，完成审稿流程
				finishReviewProcessing();
				return;
			}
			
			const conf = state.pendingConferences.shift();
			// 显示合并后的开会选择弹窗
			showConferenceModalMerged(conf);
		}

		/**
		 * 完成审稿处理流程
		 */
		function finishReviewProcessing() {
			const state = gameState._reviewProcessing;
			const onComplete = state ? state.onComplete : null;
			
			// 清理处理状态
			delete gameState._reviewProcessing;
			
			// 执行完成回调（触发月末事件）
			if (onComplete) {
				setTimeout(onComplete, 100);
			}
		}

		/**
		 * 显示合并后的开会选择弹窗（支持同一会议多篇论文）
		 */
		function showConferenceModalMerged(confData) {
			const { confInfo, confLocation, papers, grade } = confData;
			const paperCount = papers.length;
			const isMultiple = paperCount >= 2;
			
			const favorCost = gameState.favor >= 6 ? 1 : 2;
			const proxyCost = gameState.social >= 6 ? 0 : 1;

			const favorText = gameState.favor >= 6 
				? '👨‍🏫 导师报销（好感度-1）' 
				: '👨‍🏫 导师报销（好感度-2）';
			const proxyText = gameState.social >= 6 
				? '👥 请同学代参加（免费）' 
				: '👥 请人代参加（金钱-1）';

			// 构建论文列表显示
			let papersListHtml = '';
			if (isMultiple) {
				papersListHtml = `
				<div style="margin:12px 0;padding:10px;background:linear-gradient(135deg,rgba(253,203,110,0.2),rgba(0,184,148,0.2));border-radius:8px;border:1px solid rgba(253,203,110,0.4);">
					<div style="font-size:0.85rem;font-weight:600;color:#d68910;margin-bottom:8px;">
						🏹 一箭双雕！同一会议中了${paperCount}篇论文
					</div>
					<div style="font-size:0.8rem;color:var(--text-secondary);">
						${papers.map((p, i) => `${i + 1}. ${p.title.substring(0, 25)}... (${p.grade}类-${p.acceptType})`).join('<br>')}
					</div>
				</div>`;
			}

			showModal('🎓 开会选择', 
				`<p>恭喜！${isMultiple ? `${paperCount}篇` : ''}论文被接收！需要参加学术会议进行展示。</p>
				 <div style="margin:15px 0;padding:12px;background:linear-gradient(135deg,rgba(108,92,231,0.1),rgba(162,155,254,0.1));border-radius:10px;border:1px solid rgba(108,92,231,0.2);">
					 <div style="font-size:0.9rem;font-weight:600;color:var(--primary-color);margin-bottom:5px;">📍 会议信息</div>
					 <div style="font-size:1rem;font-weight:700;">${confInfo.name} ${confInfo.year}</div>
					 <div style="font-size:0.85rem;color:var(--text-secondary);">${confInfo.fullName}</div>
					 <div style="font-size:0.85rem;margin-top:5px;">📌 ${confLocation.city}, ${confLocation.country}</div>
				 </div>
				 ${papersListHtml}
				 <p>请选择参会方式：</p>`, 
				[
				{ text: '💰 自己出钱（金钱-4）', class: 'btn-warning', action: () => {
					addLog('开会', `自费参加 ${confInfo.name} ${confInfo.year} @ ${confLocation.city}`, `金钱-4${isMultiple ? `，展示${paperCount}篇论文` : ''}`);
					closeModal();
					if (changeGold(-4)) {
						setTimeout(() => showConferenceEventModalMerged(confInfo, confLocation, papers), 200);
					} else {
						// 金钱不足导致游戏结束
						processNextConferenceInQueue();
					}
				}},
				{ text: favorText, class: 'btn-info', action: () => {
					const result = gameState.favor >= 6 
						? '导师爽快报销，好感度-1' 
						: '导师好感度-2';
					addLog('开会', `导师报销参加 ${confInfo.name} ${confInfo.year} @ ${confLocation.city}`, `${result}${isMultiple ? `，展示${paperCount}篇论文` : ''}`);
					closeModal();
					if (changeFavor(-favorCost)) {
						setTimeout(() => showConferenceEventModalMerged(confInfo, confLocation, papers), 200);
					} else {
						// 好感度不足导致游戏结束
						processNextConferenceInQueue();
					}
				}},
				{ text: proxyText, class: 'btn-primary', action: () => {
					if (gameState.social >= 6) {
						addLog('开会', `请同学代为参加 ${confInfo.name} ${confInfo.year}`, '同学义气帮忙，免费');
					} else {
						addLog('开会', `请人代为参加 ${confInfo.name} ${confInfo.year}`, '金钱-1');
						changeGold(-proxyCost);
					}
					closeModal();
					// 代参加不触发开会事件，直接处理下一个
					processNextConferenceInQueue();
				}}
			]);
		}

		/**
		 * 显示合并后的开会事件弹窗
		 */
		function showConferenceEventModalMerged(confInfo, confLocation, papers) {
			const isMultiple = papers.length >= 2;
			const confString = `${confInfo.name} ${confInfo.year} @ ${confLocation.city}, ${confLocation.country}`;
			
			// 原有的开会选项逻辑保持不变
			let options = [
				{ text: '🏖️ 顺便旅游', fn: () => { 
					gameState.tourCount++;
					addLog('开会事件', `在${confLocation.city}顺便旅游`, 'SAN值+6');
					return changeSan(6);
				}},
				{ text: '☕ 茶歇+晚宴', fn: () => { 
					gameState.teaBreakCount++;
					addLog('开会事件', '茶歇+晚宴', 'SAN值+1，社交能力+1');
					return changeStats({ san: 1, social: 1 });
				}},
				{ text: '🔬 同行交流', fn: () => { 
					gameState.buffs.temporary.push({ type: 'exp_times', name: '下次做实验多做3次', value: 3, permanent: false }); 
					addLog('开会事件', '同行交流', '临时buff-下次做实验多做3次');
					updateBuffs();
					return true;
				}},
				{ text: '💡 广泛交流', fn: () => { 
					gameState.buffs.temporary.push({ type: 'idea_times', name: '下次想idea多想3次', value: 3, permanent: false }); 
					addLog('开会事件', '广泛交流', '临时buff-下次想idea多想3次');
					updateBuffs();
					return true;
				}},
				{ text: '🌟 找大牛交流', fn: () => { 
					gameState.buffs.temporary.push({ type: 'idea_bonus', name: '下次想idea分数×1.25', value: 1.25, multiply: true, permanent: false }); 
					gameState.metBigBull = true;
					addLog('开会事件', '找大牛交流', '临时buff-下次想idea分数×1.25');
					updateBuffs();
					return true;
				}},
				{ text: '🏢 找企业交流', fn: () => { 
					gameState.enterpriseCount = (gameState.enterpriseCount || 0) + 1;
					gameState.buffs.temporary.push({ type: 'exp_bonus', name: '下次做实验分数×1.25', value: 1.25, multiply: true, permanent: false }); 
					addLog('开会事件', '找企业交流', `临时buff-下次做实验分数×1.25（第${gameState.enterpriseCount}次）`);
					updateBuffs();
					
					if (gameState.enterpriseCount === 3 && !gameState.ailabInternship) {
						setTimeout(() => showAILabInternshipModal(), 300);
					}
					return true;
				}},
				{ text: '🤝 找同学合作', fn: () => { 
					gameState.buffs.temporary.push({ type: 'exp_bonus', name: '下次做实验分数+5', value: 5, permanent: false }); 
					addLog('开会事件', '找同学合作', '临时buff-下次做实验分数+5');
					updateBuffs();
					return true;
				}}
			];

			// 社交>=6解锁更多选项
			if (gameState.social >= 6) {
				options.push(
					{ text: '🎓 找大牛合作', fn: () => { 
						gameState.buffs.temporary.push({ type: 'write_bonus', name: '下次写论文分数+8', value: 8, permanent: false }); 
						gameState.metBigBull = true;
						addLog('开会事件', '找大牛合作', '临时buff-下次写论文分数+8，社交能力+1');
						updateBuffs();
						return changeSocial(1);
					}},
					{ text: '💕 和活泼的异性学者交流', fn: () => { 
						gameState.metBeautiful = true;
						gameState.beautifulCount++;
						addLog('开会事件', '和活泼的异性学者交流', 'SAN值+5，社交能力+1');
						return changeStats({ san: 5, social: 1 });
					}},
					{ text: '🧠 和聪慧的异性学者交流', fn: () => { 
						gameState.buffs.temporary.push({ type: 'idea_times', name: '下次想idea多想2次', value: 2, permanent: false });
						gameState.metSmart = true;
						gameState.smartCount++;
						addLog('开会事件', '和聪慧的异性学者交流', 'SAN值+1，社交能力+1，临时buff-下次想idea多想2次');
						updateBuffs();
						return changeStats({ san: 1, social: 1 });
					}}
				);
			}

			// 继续交流选项（保持原有逻辑）
			if (gameState.metBigBull && !gameState.bigBullCooperation) {
				options.push({ text: '🌟 和上次那个大牛深入合作', fn: () => {
					gameState.buffs.temporary.push({ type: 'write_bonus', name: '下次写论文分数+8', value: 8, permanent: false });
					gameState.bigBullDeepCount++;
					addLog('开会事件', '和上次那个大牛深入合作', '临时buff-下次写论文分数+8');
					updateBuffs();
					if (gameState.research >= 12 && gameState.bigBullDeepCount >= 2) {
						setTimeout(showBigBullCoopModal, 300);
					}
					return true;
				}});
			}

			if (gameState.metBeautiful && !gameState.hasLover) {
				options.push({ text: '💕 和上次那个活泼的异性学者交流', fn: () => {
					gameState.beautifulCount++;
					addLog('开会事件', '和上次那个活泼的异性学者交流', 'SAN值+8，SAN值上限+3');
					gameState.sanMax += 3;
					changeSan(8);
					if (gameState.social >= 12 && gameState.beautifulCount >= 2) {
						setTimeout(() => showLoverModal('beautiful'), 300);
					}
					return true;
				}});
			}

			if (gameState.metSmart && !gameState.hasLover) {
				options.push({ text: '🧠 和上次那个聪慧的异性学者交流', fn: () => {
					gameState.smartCount++;
					addLog('开会事件', '和上次那个聪慧的异性学者交流', 'SAN值+1，科研能力+1');
					changeSan(1);
					changeResearch(1);
					if (gameState.social >= 12 && gameState.smartCount >= 2) {
						setTimeout(() => showLoverModal('smart'), 300);
					}
					return true;
				}});
			}

			const selected = shuffle(options).slice(0, 3);
			
			// 显示弹窗，选择后处理下一个开会事件
			showModal(`🎉 ${confString}`, 
				`<div style="margin-bottom:15px;">
					<p>你来到了<strong>${confLocation.city}</strong>参加<strong>${confInfo.name}</strong>${isMultiple ? `，展示了${papers.length}篇论文` : ''}，在学术会议上，你可以选择：</p>
				</div>`, 
				selected.map(opt => ({
					text: opt.text, class: 'btn-primary', action: () => {
						closeModal();
						opt.fn();
						// 处理下一个开会事件
						setTimeout(() => processNextConferenceInQueue(), 100);
					}
				}))
			);
		}		
		
		// ==================== 论文投稿与审稿 ====================
		function submitPaper(slot, grade) {
			const paper = gameState.papers[slot];
			if (!paper || paper.reviewing) return;
			if (paper.ideaScore <= 0 || paper.expScore <= 0 || paper.writeScore <= 0) return;

			const confInfo = getConferenceInfo(gameState.month, grade, gameState.year);
			const location = getConferenceLocation(paper.title);
			
			paper.reviewing = true;
			paper.reviewMonths = 4;
			paper.submittedGrade = grade;
			paper.submittedScore = paper.ideaScore + paper.expScore + paper.writeScore;
			paper.submittedMonth = gameState.month;
			paper.conferenceInfo = confInfo;
			paper.conferenceLocation = location;
			
			// ✅ 新增：保存投稿时的分数快照
			paper.submittedIdeaScore = paper.ideaScore;
			paper.submittedExpScore = paper.expScore;
			paper.submittedWriteScore = paper.writeScore;

            const currentReviews = gameState.papers.filter(p => p?.reviewing).length;
            gameState.maxConcurrentReviews = Math.max(gameState.maxConcurrentReviews || 0, currentReviews);

            // ★★★ 修改日志，显示会议名称 ★★★
            addLog('投稿', `将"${paper.title.substring(0, 15)}..."投至${confInfo.name} ${confInfo.year}（${grade}类）`, `总分${paper.submittedScore}，进入4个月审稿期`);
            renderPaperSlots();
        }

        function abandonPaper(slot) {
            const paper = gameState.papers[slot];
            if (!paper || paper.reviewing) return;
            
            showModal('确认放弃', '<p>确定要放弃这篇论文吗？所有进度将丢失！</p>', [
                { text: '取消', class: 'btn-info', action: closeModal },
                { text: '确定放弃', class: 'btn-danger', action: () => {
                    addLog('放弃论文', `放弃了"${paper.title.substring(0, 15)}..."`, '论文槽已清空');
                    gameState.papers[slot] = null;
                    closeModal();
                    renderPaperSlots();
                }}
            ]);
        }
		
		function generateReviewer() {
			// ★★★ 社交达人觉醒后使用固定的概率分布 ★★★
			if (gameState.socialAwakened && gameState.reviewerDistribution) {
				const dist = gameState.reviewerDistribution;
				
				const r = Math.random();
				let cumulative = 0;
				
				cumulative += dist.normal;
				if (r < cumulative) return { type: 'normal', name: '普通审稿人' };
				
				cumulative += dist.kind;
				if (r < cumulative) return { type: 'kind', name: '心软审稿人' };
				
				cumulative += dist.expert;
				if (r < cumulative) return { type: 'expert', name: '资深大牛' };
				
				cumulative += dist.hostile;
				if (r < cumulative) return { type: 'hostile', name: '恶意小同行' };
				
				cumulative += dist.gpt;
				if (r < cumulative) return { type: 'gpt', name: 'GPT审稿人' };
				
				return { type: 'questions', name: '39个问题审稿人' };
			}
			
			// 默认分布
			const r = Math.random();
			if (r < 0.40) return { type: 'normal', name: '普通审稿人' };
			if (r < 0.50) return { type: 'kind', name: '心软审稿人' };
			if (r < 0.60) return { type: 'expert', name: '资深大牛' };
			if (r < 0.70) return { type: 'hostile', name: '恶意小同行' };
			if (r < 0.90) return { type: 'gpt', name: 'GPT审稿人' };
			return { type: 'questions', name: '39个问题审稿人' };
		}


		function handlePaperAccepted(paper, grade, acceptType, slot, extraInfo) {
			// ★★★ 新增：检查并应用引用倍增buff ★★★
			let citationBuff = 1;
			const citationMultiplyBuff = gameState.buffs.temporary.find(b => b.type === 'citation_multiply');
			if (citationMultiplyBuff) {
				citationBuff = citationMultiplyBuff.value;
				gameState.buffs.temporary = gameState.buffs.temporary.filter(b => b.type !== 'citation_multiply');
				addLog('Buff生效', '同门合作', `本篇论文引用速度+${(citationBuff-1)*100}%（与推广加成叠加）`);
			}
			
			const scoreMap = { 'A': 4, 'B': 2, 'C': 1 };
			const sanGain = { 
				'A': { 'Poster': 6, 'Oral': 8, 'Best Paper': 12 }, 
				'B': { 'Poster': 3, 'Oral': 4, 'Best Paper': 5 }, 
				'C': { 'Poster': 2, 'Oral': 2, 'Best Paper': 3 } 
			};
			const favorGain = { 
				'A': { 'Poster': 2, 'Oral': 3, 'Best Paper': 4 }, 
				'B': { 'Poster': 1, 'Oral': 1, 'Best Paper': 2 }, 
				'C': { 'Poster': 0, 'Oral': 0, 'Best Paper': 1 } 
			};

			const paperRankMap = {
				'A-Best Paper': 9,
				'A-Oral': 8,
				'A-Poster': 7,
				'B-Best Paper': 6,
				'B-Oral': 5,
				'B-Poster': 4,
				'C-Best Paper': 3,
				'C-Oral': 2,
				'C-Poster': 1
			};
			
			const currentRank = paperRankMap[`${grade}-${acceptType}`];
			
			const higherOrEqualCount = gameState.publishedPapers.filter(p => {
				const pRank = paperRankMap[`${p.grade}-${p.acceptType}`];
				return pRank >= currentRank;
			}).length;
			
			const baseSan = sanGain[grade][acceptType];
			const baseFavor = favorGain[grade][acceptType];
			
			const actualSanGain = Math.max(1, baseSan - higherOrEqualCount);
			const favorReduction = Math.floor(higherOrEqualCount / 2);
			const actualFavorGain = baseFavor > 0 ? Math.max(0, baseFavor - favorReduction) : 0;
			
			const hasDecay = actualSanGain < baseSan || actualFavorGain < baseFavor;
			
			gameState.san = Math.min(gameState.sanMax, gameState.san + actualSanGain);
			gameState.favor = Math.min(20, gameState.favor + actualFavorGain);
			gameState.totalScore += scoreMap[grade];

			if (grade === 'A') gameState.paperA++;
			else if (grade === 'B') gameState.paperB++;
			else gameState.paperC++;

			let bonusResearch = 0;
			if (!gameState.firstPaperAccepted) {
				gameState.firstPaperAccepted = true;
				bonusResearch++;
				addLog('首次发表论文', '科研能力+1', '首次发表论文奖励');
			}
			if (grade === 'A' && !gameState.firstAPaperAccepted) {
				gameState.firstAPaperAccepted = true;
				bonusResearch++;
				addLog('首次发表A类论文', '科研能力+1', '首次发表A类论文奖励');
			}
			if (acceptType === 'Best Paper' && !gameState.firstBestPaperAccepted) {
				gameState.firstBestPaperAccepted = true;
				bonusResearch++;
				addLog('首次发表Best Paper', '科研能力+1', '首次发表Best Paper奖励');
			}
			if (grade === 'A' && acceptType === 'Best Paper' && !gameState.firstABestPaperAccepted) {
				gameState.firstABestPaperAccepted = true;
				bonusResearch++;
				addLog('首次发表A类Best Paper', '科研能力+1', '首次发表A类Best Paper奖励');
			}
			if (bonusResearch > 0) {
				changeResearch(bonusResearch);
			}

			gameState.consecutiveAccepts = (gameState.consecutiveAccepts || 0) + 1;
			
			if (gameState.consecutiveAccepts >= 3) {
				gameState.buffs.temporary.push({ 
					type: 'slack_debuff', 
					name: '松懈：下月所有操作总分÷2', 
					value: 0.5, 
					multiply: true, 
					permanent: false,
					expiresOnRest: true
				});
				addLog('⚠️ 志得意满', '连续中稿3篇', '获得松懈debuff，下月想idea/做实验/写论文总分÷2（休息一个月可消除）');
				gameState.consecutiveAccepts = 0;
			}

			const finalScore = paper.submittedScore || (paper.ideaScore + paper.expScore + paper.writeScore);

			// ★★★ 记录录取数据 ★★★
			const resultStr = acceptType.toLowerCase().replace(/\s+/g, '_');
			recordSubmission(
				extraInfo?.submittedMonth || gameState.month,
				grade,
				paper.submittedScore,
				resultStr,
				gameState.isReversed
			);
			
			gameState.publishedPapers.push({
				title: paper.title,
				grade,
				acceptType,
				score: finalScore,
				citations: 0,
				monthsSincePublish: 0,
				promotions: { arxiv: false, github: false, xiaohongshu: false, quantumbit: false },
				citationMultiplier: citationBuff,
				pendingCitationFraction: 0,
				conferenceInfo: paper.conferenceInfo ? {
					...paper.conferenceInfo,
					month: paper.submittedMonth || gameState.month
				} : {
					name: grade + '类会议',
					year: getRealYear(gameState.year, gameState.month),
					month: paper.submittedMonth || gameState.month
				},
				conferenceLocation: paper.conferenceLocation
			});

			if (gameState.publishedPapers.length === 1 && !gameState.availableRandomEvents.includes(14)) {
				gameState.availableRandomEvents.push(14);
				addLog('系统', '新事件解锁', '指导师弟师妹事件已解锁');
			}

			gameState.paperTypeCollection = gameState.paperTypeCollection || new Set();
			gameState.paperTypeCollection.add(`${grade}-${acceptType}`);

			// ★★★ 修改日志，显示会议名称 ★★★
			const confInfo = paper.conferenceInfo || getConferenceInfo(gameState.month, grade, gameState.year);
			let result = `SAN+${actualSanGain}，好感+${actualFavorGain}，科研分+${scoreMap[grade]}`;
			if (bonusResearch > 0) result += `，科研能力+${bonusResearch}`;
			
			if (hasDecay) {
				result += `（已发${higherOrEqualCount}篇同级或更高，边际效益递减）`;
			}
			
			if (gameState.consecutiveAccepts > 0) {
				result += `（连续中稿${gameState.consecutiveAccepts}/3）`;
			}
			
			addLog('🎉 论文中稿', `${confInfo.name} ${confInfo.year} 接收为${acceptType}`, result);

			// ★★★ 关键修改：根据是否在队列模式下决定后续处理 ★★★
			if (gameState._reviewProcessing) {
				// 在队列模式下，记录会议信息，稍后统一处理开会事件
				recordAcceptedPaperConference(paper, grade, acceptType);
				
				// 清空论文槽
				gameState.papers[slot] = null;
				
				// 继续处理下一个审稿结果
				setTimeout(() => processNextReviewInQueue(), 100);
				
				updateBuffs();
				renderPaperSlots();
				updateAllUI();
				return;  // 不触发开会弹窗，稍后统一处理
			}
			
			// ★★★ 非队列模式（兼容旧逻辑，如读档后触发）★★★
			gameState.pendingConferenceInfo = {
				info: paper.conferenceInfo,
				location: paper.conferenceLocation,
				grade: grade
			};

			gameState.papers[slot] = null;

			// 检查转博条件
			const canPhD = gameState.degree === 'master' && (
				(gameState.year === 2 && gameState.month === 12 && gameState.totalScore >= 2) ||
				(gameState.year === 3 && gameState.month === 12 && gameState.totalScore >= 3)
			);

			if (canPhD) {
				gameState.pendingConference = grade;
				setTimeout(() => showPhDOptionModal(), 300);
			} else {
				setTimeout(() => showConferenceModal(grade), 300);
			}
			
			updateBuffs();
		}

		// ==================== 显示所有会议信息 ====================
		function showAllConferencesInfo() {
			let html = '<div style="max-height:60vh;overflow-y:auto;">';
			
			// 表头
			html += `
			<table style="width:100%;border-collapse:collapse;font-size:0.75rem;">
				<thead>
					<tr style="background:var(--light-bg);">
						<th style="padding:6px;text-align:left;border-bottom:2px solid var(--border-color);">月份</th>
						<th style="padding:6px;text-align:left;border-bottom:2px solid var(--border-color);">等级</th>
						<th style="padding:6px;text-align:left;border-bottom:2px solid var(--border-color);">会议名称</th>
						<th style="padding:6px;text-align:center;border-bottom:2px solid var(--border-color);">投稿数</th>
						<th style="padding:6px;text-align:center;border-bottom:2px solid var(--border-color);">中稿率</th>
						<th style="padding:6px;text-align:center;border-bottom:2px solid var(--border-color);">中稿均分</th>
						<th style="padding:6px;text-align:center;border-bottom:2px solid var(--border-color);">影响因子</th>
					</tr>
				</thead>
				<tbody>
			`;
			
			const grades = ['A', 'B', 'C'];
			const gradeColors = { A: '#e17055', B: '#fdcb6e', C: '#00b894' };
			
			// 游戏月份转现实月份的函数
			function gameMonthToRealMonth(gameMonth) {
				return ((gameMonth - 1 + 8) % 12) + 1;
			}
			
			for (let month = 1; month <= 12; month++) {
				const realMonth = gameMonthToRealMonth(month);
				
				for (let gradeIdx = 0; gradeIdx < grades.length; gradeIdx++) {
					const grade = grades[gradeIdx];
					const confInfo = getConferenceInfo(month, grade, gameState.year || 1);
					const stats = getMonthStats(month, grade, gameState.isReversed || false);
					const impactFactor = getConferenceImpactFactor({ month: month }, grade);
					
					// 计算中稿均分
					let avgAcceptedScore = '-';
					if (stats && stats.submissions >= 10) {
						const totalAccepted = (stats.poster || 0) + (stats.oral || 0) + (stats.bestPaper || 0);
						if (totalAccepted > 0 && stats.avgScorePoster) {
							const weightedSum = (stats.avgScorePoster * (stats.poster || 0)) + 
											  (stats.avgScoreOral * (stats.oral || 0)) + 
											  (stats.avgScoreBestPaper * (stats.bestPaper || 0));
							avgAcceptedScore = Math.round(weightedSum / totalAccepted);
						}
					}
					
					const acceptRate = stats && stats.submissions >= 10 
						? (stats.acceptRate * 100).toFixed(1) + '%' 
						: '-';
					const submissions = stats ? stats.submissions : 0;
					const ifValue = stats && stats.submissions >= 10 
						? impactFactor.toFixed(2) 
						: '-';
					
					const rowBg = month % 2 === 0 ? 'var(--light-bg)' : 'transparent';
					
					// 当前月份高亮
					const isCurrentMonth = gameState.month === month;
					const highlightStyle = isCurrentMonth ? 'border-left:3px solid var(--primary-color);' : '';
					
					// 只在每个月的第一行（A类）显示月份
					const showMonth = gradeIdx === 0;
					const monthCell = showMonth 
						? `<td style="padding:5px 6px;border-bottom:1px solid var(--border-color);vertical-align:middle;" rowspan="3">
							<div style="font-weight:600;${isCurrentMonth ? 'color:var(--primary-color);' : ''}">
								${isCurrentMonth ? '📍 ' : ''}第${month}月
							</div>
							<div style="font-size:0.65rem;color:var(--text-secondary);">（${realMonth}月）</div>
						   </td>`
						: '';
					
					html += `
					<tr style="background:${rowBg};${highlightStyle}">
						${monthCell}
						<td style="padding:5px 6px;border-bottom:1px solid var(--border-color);">
							<span style="padding:2px 6px;background:${gradeColors[grade]}22;color:${gradeColors[grade]};border-radius:4px;font-weight:600;">${grade}类</span>
						</td>
						<td style="padding:5px 6px;border-bottom:1px solid var(--border-color);font-weight:500;">${confInfo.name}</td>
						<td style="padding:5px 6px;border-bottom:1px solid var(--border-color);text-align:center;">${submissions}</td>
						<td style="padding:5px 6px;border-bottom:1px solid var(--border-color);text-align:center;">${acceptRate}</td>
						<td style="padding:5px 6px;border-bottom:1px solid var(--border-color);text-align:center;">${avgAcceptedScore}</td>
						<td style="padding:5px 6px;border-bottom:1px solid var(--border-color);text-align:center;">${ifValue}</td>
					</tr>
					`;
				}
			}
			
			html += '</tbody></table></div>';
			
			html += `
			<div style="margin-top:12px;padding:10px;background:var(--light-bg);border-radius:8px;font-size:0.75rem;color:var(--text-secondary);">
				<div style="margin-bottom:6px;"><strong>📖 说明：</strong></div>
				<div>• <strong>第x月</strong>：学年第x个月 | <strong>（y月）</strong>：对应现实月份</div>
				<div>• <strong>中稿率</strong>：全球玩家该会议的录用率</div>
				<div>• <strong>中稿均分</strong>：被录用论文的平均投稿分数</div>
				<div>• <strong>影响因子</strong>：基于投稿热度和中稿均分计算，影响论文引用增速</div>
				<div style="margin-top:6px;color:var(--warning-color);">
					<i class="fas fa-info-circle"></i> 投稿数≥10时才显示详细统计数据
				</div>
			</div>
			`;
			
			showModal('📊 全部会议信息一览', html, [
				{ text: '关闭', class: 'btn-primary', action: closeModal }
			]);
		}

        // ==================== 开会系统 ====================
        function showConferenceModal(grade) {
            const favorCost = gameState.favor >= 6 ? 1 : 2;
            const proxyCost = gameState.social >= 6 ? 0 : 1;

            const favorText = gameState.favor >= 6 
                ? '👨‍🏫 导师报销（好感度-1）' 
                : '👨‍🏫 导师报销（好感度-2）';
            const proxyText = gameState.social >= 6 
                ? '👥 请同学代参加（免费）' 
                : '👥 请人代参加（金钱-1）';

            // ★★★ 获取会议信息 ★★★
            let confInfo, confLocation;
            if (gameState.pendingConferenceInfo) {
                confInfo = gameState.pendingConferenceInfo.info;
                confLocation = gameState.pendingConferenceInfo.location;
            } else {
                confInfo = getConferenceInfo(gameState.month, grade, gameState.year);
                confLocation = CONFERENCE_LOCATIONS[Math.floor(Math.random() * CONFERENCE_LOCATIONS.length)];
            }
            
            const confString = formatConferenceString(confInfo, confLocation);

            showModal('🎓 开会选择', 
                `<p>恭喜论文被接收！需要参加学术会议进行展示。</p>
                 <div style="margin:15px 0;padding:12px;background:linear-gradient(135deg,rgba(108,92,231,0.1),rgba(162,155,254,0.1));border-radius:10px;border:1px solid rgba(108,92,231,0.2);">
                     <div style="font-size:0.9rem;font-weight:600;color:var(--primary-color);margin-bottom:5px;">📍 会议信息</div>
                     <div style="font-size:1rem;font-weight:700;">${confInfo.name} ${confInfo.year}</div>
                     <div style="font-size:0.85rem;color:var(--text-secondary);">${confInfo.fullName}</div>
                     <div style="font-size:0.85rem;margin-top:5px;">📌 ${confLocation.city}, ${confLocation.country}</div>
                 </div>
                 <p>请选择参会方式：</p>`, 
                [
                { text: '💰 自己出钱（金钱-4）', class: 'btn-warning', action: () => {
                    addLog('开会', `自费参加 ${confInfo.name} ${confInfo.year} @ ${confLocation.city}`, '金钱-4');
                    closeModal();
                    if (changeGold(-4)) {
                        setTimeout(() => showConferenceEventModal(confInfo, confLocation), 200);
                    }
                }},
                { text: favorText, class: 'btn-info', action: () => {
                    const result = gameState.favor >= 6 
                        ? '导师爽快报销，好感度-1' 
                        : '导师好感度-2';
                    addLog('开会', `导师报销参加 ${confInfo.name} ${confInfo.year} @ ${confLocation.city}`, result);
                    closeModal();
                    if (changeFavor(-favorCost)) {
                        setTimeout(() => showConferenceEventModal(confInfo, confLocation), 200);
                    }
                }},
                { text: proxyText, class: 'btn-primary', action: () => {
                    if (gameState.social >= 6) {
                        addLog('开会', `请同学代为参加 ${confInfo.name} ${confInfo.year}`, '同学义气帮忙，免费');
                        closeModal();
                        // 清除会议信息
                        gameState.pendingConferenceInfo = null;
                    } else {
                        addLog('开会', `请人代为参加 ${confInfo.name} ${confInfo.year}`, '金钱-1');
                        closeModal();
                        changeGold(-proxyCost);
                        // 清除会议信息
                        gameState.pendingConferenceInfo = null;
                    }
                }}
            ]);
        }

        function showConferenceEventModal(confInfo, confLocation) {
            // 清除会议信息
            gameState.pendingConferenceInfo = null;
            
            // 如果没有传入会议信息，使用默认值
            if (!confInfo) {
                confInfo = { name: '学术会议', year: getRealYear(gameState.year, gameState.month), fullName: 'Academic Conference' };
            }
            if (!confLocation) {
                confLocation = CONFERENCE_LOCATIONS[Math.floor(Math.random() * CONFERENCE_LOCATIONS.length)];
            }
            
            const confString = `${confInfo.name} ${confInfo.year} @ ${confLocation.city}, ${confLocation.country}`;
            
            let options = [
                { text: '🏖️ 顺便旅游', fn: () => { 
                    gameState.tourCount++;
                    addLog('开会事件', `在${confLocation.city}顺便旅游`, 'SAN值+6');
                    return changeSan(6);
                }},
                { text: '☕ 茶歇+晚宴', fn: () => { 
                    gameState.teaBreakCount++;
                    addLog('开会事件', '茶歇+晚宴', 'SAN值+1，社交能力+1');
                    return changeStats({ san: 1, social: 1 });
                }},
                { text: '🔬 同行交流', fn: () => { 
                    gameState.buffs.temporary.push({ type: 'exp_times', name: '下次做实验多做3次', value: 3, permanent: false }); 
                    addLog('开会事件', '同行交流', '临时buff-下次做实验多做3次');
                    updateBuffs();
                    return true;
                }},
                { text: '💡 广泛交流', fn: () => { 
                    gameState.buffs.temporary.push({ type: 'idea_times', name: '下次想idea多想3次', value: 3, permanent: false }); 
                    addLog('开会事件', '广泛交流', '临时buff-下次想idea多想3次');
                    updateBuffs();
                    return true;
                }},
                { text: '🌟 找大牛交流', fn: () => { 
                    gameState.buffs.temporary.push({ type: 'idea_bonus', name: '下次想idea分数×1.25', value: 1.25, multiply: true, permanent: false }); 
                    gameState.metBigBull = true;
                    addLog('开会事件', '找大牛交流', '临时buff-下次想idea分数×1.25');
                    updateBuffs();
                    return true;
                }},
                { text: '🏢 找企业交流', fn: () => { 
                    gameState.enterpriseCount = (gameState.enterpriseCount || 0) + 1;
                    gameState.buffs.temporary.push({ type: 'exp_bonus', name: '下次做实验分数×1.25', value: 1.25, multiply: true, permanent: false }); 
                    addLog('开会事件', '找企业交流', `临时buff-下次做实验分数×1.25（第${gameState.enterpriseCount}次）`);
                    updateBuffs();
                    
                    if (gameState.enterpriseCount === 3 && !gameState.ailabInternship) {
                        setTimeout(() => showAILabInternshipModal(), 300);
                    }
                    return true;
                }},
                { text: '🤝 找同学合作', fn: () => { 
                    gameState.buffs.temporary.push({ type: 'exp_bonus', name: '下次做实验分数+5', value: 5, permanent: false }); 
                    addLog('开会事件', '找同学合作', '临时buff-下次做实验分数+5');
                    updateBuffs();
                    return true;
                }}
            ];

            if (gameState.social >= 6) {
                options.push(
                    { text: '🎓 找大牛合作', fn: () => { 
                        gameState.buffs.temporary.push({ type: 'write_bonus', name: '下次写论文分数+8', value: 8, permanent: false }); 
                        gameState.metBigBull = true;
                        addLog('开会事件', '找大牛合作', '临时buff-下次写论文分数+8，社交能力+1');
                        updateBuffs();
                        return changeSocial(1);
                    }},
                    { text: '💕 和活泼的异性学者交流', fn: () => { 
                        gameState.metBeautiful = true;
                        gameState.beautifulCount++;
                        addLog('开会事件', '和活泼的异性学者交流', 'SAN值+5，社交能力+1');
                        return changeStats({ san: 5, social: 1 });
                    }},
                    { text: '🧠 和聪慧的异性学者交流', fn: () => { 
                        gameState.buffs.temporary.push({ type: 'idea_times', name: '下次想idea多想2次', value: 2, permanent: false });
                        gameState.metSmart = true;
                        gameState.smartCount++;
                        addLog('开会事件', '和聪慧的异性学者交流', 'SAN值+1，社交能力+1，临时buff-下次想idea多想2次');
                        updateBuffs();
                        return changeStats({ san: 1, social: 1 });
                    }}
                );
            }

            if (gameState.metBigBull && !gameState.bigBullCooperation) {
                options.push({ text: '🌟 和上次那个大牛深入合作', fn: () => {
                    gameState.buffs.temporary.push({ type: 'write_bonus', name: '下次写论文分数+8', value: 8, permanent: false });
                    gameState.bigBullDeepCount++;
                    addLog('开会事件', '和上次那个大牛深入合作', '临时buff-下次写论文分数+8');
                    updateBuffs();
                    if (gameState.research >= 12 && gameState.bigBullDeepCount >= 2) {
                        setTimeout(showBigBullCoopModal, 300);
                    }
                    return true;
                }});
            }

            if (gameState.metBeautiful && !gameState.hasLover) {
                options.push({ text: '💕 和上次那个活泼的异性学者交流', fn: () => {
                    gameState.beautifulCount++;
                    addLog('开会事件', '和上次那个活泼的异性学者交流', 'SAN值+8，SAN值上限+3');
                    gameState.sanMax += 3;
                    changeSan(8);
                    if (gameState.social >= 12 && gameState.beautifulCount >= 2) {
                        setTimeout(() => showLoverModal('beautiful'), 300);
                    }
                    return true;
                }});
            }

            if (gameState.metSmart && !gameState.hasLover) {
                options.push({ text: '🧠 和上次那个聪慧的异性学者交流', fn: () => {
                    gameState.smartCount++;
                    addLog('开会事件', '和上次那个聪慧的异性学者交流', 'SAN值+1，科研能力+1');
                    changeSan(1);
                    changeResearch(1);
                    if (gameState.social >= 12 && gameState.smartCount >= 2) {
                        setTimeout(() => showLoverModal('smart'), 300);
                    }
                    return true;
                }});
            }

            const selected = shuffle(options).slice(0, 3);
            
            // ★★★ 修改弹窗标题，显示会议名称和地点 ★★★
            showModal(`🎉 ${confString}`, 
                `<div style="margin-bottom:15px;">
                    <p>你来到了<strong>${confLocation.city}</strong>参加<strong>${confInfo.name}</strong>，在学术会议上，你可以选择：</p>
                </div>`, 
                selected.map(opt => ({
                    text: opt.text, class: 'btn-primary', action: () => {
                        closeModal();
                        opt.fn();
                    }
                }))
            );
        }

        function showLoverModal(type) {
            const desc = type === 'beautiful' 
                ? '你和那个活泼的异性学者越来越熟悉了' 
                : '你和那个聪慧的异性学者越来越默契了';
            
            const bonusDesc = type === 'beautiful'
                ? '<div style="margin-top:10px;padding:8px;background:rgba(253,121,168,0.1);border-radius:8px;font-size:0.8rem;"><strong>恋人效果：</strong><br>✨ SAN值立即回满<br>✨ SAN上限+4<br>✨ 每月SAN+3<br>💸 每月金钱-1（约会开销）</div>'
                : '<div style="margin-top:10px;padding:8px;background:rgba(116,185,255,0.1);border-radius:8px;font-size:0.8rem;"><strong>恋人效果：</strong><br>✨ SAN+1，科研能力+1<br>✨ 每次想idea/做实验/写论文多一次<br>💸 每月金钱-1（约会开销）</div>';
            
            showModal('💕 发展关系', `<p>${desc}，是否成为恋人？</p>${bonusDesc}`, [
                { text: '还是算了', class: 'btn-info', action: closeModal },
                { text: '❤️ 成为恋人', class: 'btn-accent', action: () => {
                    gameState.hasLover = true;
                    gameState.loverType = type;
                    if (type === 'beautiful') {
                        gameState.san = gameState.sanMax;
                        gameState.sanMax += 4;
                        addLog('💕 恋爱', '和活泼的异性学者成为恋人', 'SAN值回满，SAN上限+4，每月SAN+3，每月金钱-1');
                    } else {
                        changeResearch(1);
                        gameState.buffs.permanent.push(
                            { type: 'idea_times', name: '每次想idea多想1次', value: 1, permanent: true },
                            { type: 'exp_times', name: '每次做实验多做1次', value: 1, permanent: true },
                            { type: 'write_times', name: '每次写论文多写1次', value: 1, permanent: true }
                        );
                        addLog('💕 恋爱', '和聪慧的异性学者成为恋人', 'SAN+1，科研能力+1，永久buff-每次想idea/做实验/写论文多一次，每月金钱-1');
                        changeSan(1);
                    }
                    closeModal();
                    updateAllUI();
                    updateBuffs();
                }}
            ]);
        }

        function showAILabInternshipModal() {
            const sanCost = gameState.isReversed && gameState.character === 'normal' 
                ? (gameState.reversedAwakened ? 9 : 6) 
                : 3;
            
            showModal('🏢 实习邀请', 
                `<div style="text-align:center;margin-bottom:15px;">
                    <div style="font-size:2.5rem;margin-bottom:10px;">🤖</div>
                    <div style="font-size:1.1rem;font-weight:600;color:var(--primary-color);">上海AI Lab 远程实习邀请</div>
                </div>
                <p>你在企业交流中表现出色，AI Lab 的L研究员对你印象深刻，向你发出了远程实习邀请！</p>
                
                <div style="background:var(--light-bg);border-radius:10px;padding:12px;margin:15px 0;">
                    <div style="font-size:0.85rem;font-weight:600;margin-bottom:8px;">📋 实习待遇：</div>
                    <div style="display:flex;flex-direction:column;gap:6px;font-size:0.85rem;">
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span style="color:var(--success-color);">✓</span>
                            <span>永久buff：做实验分数 ×1.25</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span style="color:var(--success-color);">✓</span>
                            <span>每月金钱 +2（实习工资）</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span style="color:var(--danger-color);">✗</span>
                            <span>每月SAN -${sanCost}（工作压力）${sanCost !== 3 ? '（怠惰效果）' : ''}</span>
                        </div>
                    </div>
                </div>
                
                <p style="font-size:0.8rem;color:var(--text-secondary);text-align:center;">
                    远程实习可以兼顾学业，但需要承担额外的工作压力
                </p>`,
                [
                    { text: '婉拒邀请', class: 'btn-info', action: () => {
                        addLog('实习邀请', '婉拒了AI Lab的实习邀请', '专心完成学业');
                        closeModal();
                    }},
                    { text: '🚀 接受实习', class: 'btn-primary', action: () => {
                        gameState.ailabInternship = true;
                        gameState.buffs.permanent.push({ 
                            type: 'exp_bonus', 
                            name: '实习加成：做实验分数×1.25', 
                            value: 1.25, 
                            multiply: true, 
                            permanent: true 
                        });
                        addLog('实习邀请', '接受了AI Lab的远程实习', '永久buff-做实验分数×1.25，每月金钱+2，每月SAN-3');
                        closeModal();
                        updateBuffs();
                        updateAllUI();
                    }}
                ]
            );
        }

        function showBigBullCoopModal() {
            showModal('🌟 联合培养', '<p>大牛对你的科研能力印象深刻，提议与你的导师联合培养你，是否接受？</p>', [
                { text: '婉拒', class: 'btn-info', action: closeModal },
                { text: '✨ 接受联合培养', class: 'btn-primary', action: () => {
                    gameState.bigBullCooperation = true;
                    gameState.buffs.permanent.push({ type: 'write_bonus', name: '每次写论文分数+8', value: 8, permanent: true });
                    addLog('联合培养', '导师与大牛联合培养', '永久buff-每次写论文分数+8');
                    closeModal();
                    updateBuffs();
                }}
            ]);
        }
		// ==================== 成就商店系统 ====================
		const achievementShopItems = [
			{ 
				id: 'soap', 
				name: '🧼 香皂', 
				desc: '清除所有携带的非永久buff和debuff', 
				basePrice: 7, 
				pricePerYear: 0,  // 价格不随年份变化
				once: true, 
				bought: false 
			},
			{ 
				id: 'premium_soap', 
				name: '🧴 高级香皂', 
				desc: '清除所有携带的非永久debuff', 
				basePrice: 10, 
				pricePerYear: 0, 
				once: true, 
				bought: false 
			},
			{ 
				id: 'chicken_burger', 
				name: '🍔 板烧鸡腿堡', 
				desc: '回复2点SAN值', 
				basePrice: 5, 
				pricePerYear: -1,  // 每年售价-1
				once: true, 
				bought: false 
			},
			{ 
				id: 'beef_burger', 
				name: '🥩 安格斯厚牛堡', 
				desc: 'SAN上限+2', 
				basePrice: 3, 
				pricePerYear: 1,  // 每年售价+1
				once: true, 
				bought: false 
			},
			{ 
				id: 'fake_flower', 
				name: '🌸 假花', 
				desc: '导师好感度+1', 
				basePrice: 8, 
				pricePerYear: -1, 
				once: true, 
				bought: false 
			},
			{ 
				id: 'real_flower', 
				name: '💐 鲜花', 
				desc: '导师好感度上限+1', 
				basePrice: 3, 
				pricePerYear: 1, 
				once: true, 
				bought: false 
			},
			{ 
				id: 'mooncake', 
				name: '🥮 月饼', 
				desc: '社交能力+1', 
				basePrice: 8, 
				pricePerYear: -1, 
				once: true, 
				bought: false 
			},
			{ 
				id: 'snow_mooncake', 
				name: '🍡 冰皮月饼', 
				desc: '社交能力上限+1', 
				basePrice: 3, 
				pricePerYear: 1, 
				once: true, 
				bought: false 
			},
			{ 
				id: 'watermelon_book', 
				name: '📗 西瓜书', 
				desc: '科研能力+1', 
				basePrice: 12, 
				pricePerYear: -2, 
				once: true, 
				bought: false 
			},
			{ 
				id: 'andrew_ng_course', 
				name: '💻 吴恩达课程', 
				desc: '科研能力上限+1', 
				basePrice: 4, 
				pricePerYear: 1, 
				once: true, 
				bought: false 
			},
			{ 
				id: 'bitcoin', 
				name: '₿ 比特币', 
				desc: '金币+1（每年额外+1）', 
				basePrice: 8, 
				pricePerYear: 0, 
				once: true, 
				bought: false,
				special: 'bitcoin'  // 特殊标记：比特币效果随年份增加
			}
		];

		// 获取玩家历史成就数量（用于计算成就币）
		function getPlayerAchievementCount() {
			const playerRecords = getPlayerAchievements();
			const normalCount = playerRecords.achievements.normal instanceof Set 
				? playerRecords.achievements.normal.size 
				: (Array.isArray(playerRecords.achievements.normal) ? playerRecords.achievements.normal.length : 0);
			const reversedCount = playerRecords.achievements.reversed instanceof Set 
				? playerRecords.achievements.reversed.size 
				: (Array.isArray(playerRecords.achievements.reversed) ? playerRecords.achievements.reversed.length : 0);
			
			// 返回两种模式成就的并集数量（去重）
			const allAchievements = new Set();
			
			if (playerRecords.achievements.normal instanceof Set) {
				playerRecords.achievements.normal.forEach(a => allAchievements.add(a));
			} else if (Array.isArray(playerRecords.achievements.normal)) {
				playerRecords.achievements.normal.forEach(a => allAchievements.add(a));
			}
			
			if (playerRecords.achievements.reversed instanceof Set) {
				playerRecords.achievements.reversed.forEach(a => allAchievements.add(a));
			} else if (Array.isArray(playerRecords.achievements.reversed)) {
				playerRecords.achievements.reversed.forEach(a => allAchievements.add(a));
			}
			
			return allAchievements.size;
		}

		// 计算成就商店物品当前价格
		function getAchievementItemPrice(item) {
			const yearsPassed = gameState.year - 1;  // 第1年为0年过去
			let price = item.basePrice + (item.pricePerYear * yearsPassed);
			return Math.max(1, price);  // 最低价格为1
		}

		// 获取比特币当前效果
		function getBitcoinEffect() {
			const yearsPassed = gameState.year - 1;
			return 1 + yearsPassed;  // 第1年+1金，第2年+2金，以此类推
		}

		// 打开成就商店
		function openAchievementShop() {
			const achievementCoins = gameState.achievementCoins || 0;
			
			let html = `
				<div style="margin-bottom:15px;padding:12px;background:linear-gradient(135deg,rgba(253,203,110,0.2),rgba(243,156,18,0.2));border-radius:10px;border:1px solid rgba(243,156,18,0.4);">
					<div style="display:flex;justify-content:space-between;align-items:center;">
						<div>
							<span style="font-size:1.2rem;">🏆</span>
							<span style="font-weight:600;color:#d68910;">成就币</span>
						</div>
						<div style="font-size:1.3rem;font-weight:700;color:#d68910;">${achievementCoins}</div>
					</div>
					<div style="font-size:0.7rem;color:var(--text-secondary);margin-top:5px;">
						基于历史成就数量获得，每局游戏重置
					</div>
				</div>
				<div style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:10px;">
					💡 提示：部分物品价格会随游戏年份变化
				</div>
				<div style="max-height:350px;overflow-y:auto;">
			`;
			
			achievementShopItems.forEach(item => {
				const currentPrice = getAchievementItemPrice(item);
				const canBuy = achievementCoins >= currentPrice && !item.bought;
				const reason = item.bought ? '已购买' : (achievementCoins < currentPrice ? '成就币不足' : '');
				
				// 动态描述
				let displayDesc = item.desc;
				if (item.special === 'bitcoin') {
					const effect = getBitcoinEffect();
					displayDesc = `金币+${effect}（当前年份效果）`;
				}
				
				// 价格变化提示
				let priceHint = '';
				if (item.pricePerYear !== 0) {
					const change = item.pricePerYear > 0 ? `+${item.pricePerYear}` : `${item.pricePerYear}`;
					priceHint = `<span style="font-size:0.65rem;color:${item.pricePerYear > 0 ? 'var(--danger-color)' : 'var(--success-color)'};">(每年${change})</span>`;
				}
				
				html += `
					<div class="shop-item ${!canBuy ? 'disabled' : ''}" style="margin-bottom:8px;">
						<div class="shop-item-info">
							<div class="shop-item-name">${item.name}</div>
							<div class="shop-item-desc">${displayDesc}</div>
						</div>
						<div class="shop-item-action">
							<span class="shop-item-price" style="color:#d68910;">🏆${currentPrice} ${priceHint}</span>
							<button class="btn btn-warning" onclick="buyAchievementItem('${item.id}')" ${!canBuy ? 'disabled' : ''} style="padding:4px 10px;font-size:0.75rem;">
								${reason || '购买'}
							</button>
						</div>
					</div>
				`;
			});
			
			html += '</div>';
			
			showModal('🏆 成就商店', html, [{ text: '关闭', class: 'btn-info', action: closeModal }]);
		}

		// 购买成就商店物品
		function buyAchievementItem(id) {
			const item = achievementShopItems.find(i => i.id === id);
			if (!item) return;
			
			const currentPrice = getAchievementItemPrice(item);
			
			if (gameState.achievementCoins < currentPrice) {
				showModal('❌ 购买失败', `<p>成就币不足！需要${currentPrice}成就币，当前只有${gameState.achievementCoins}成就币。</p>`, 
					[{ text: '确定', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			if (item.bought) {
				showModal('❌ 购买失败', `<p>该物品已购买过！</p>`, 
					[{ text: '确定', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			// 扣除成就币
			gameState.achievementCoins -= currentPrice;
			item.bought = true;
			
			let result = `成就币-${currentPrice}`;
			
			// 应用物品效果
			switch (id) {
				case 'soap':
					// 清除所有非永久buff和debuff
					const removedCount = gameState.buffs.temporary.length;
					gameState.buffs.temporary = [];
					result += `，清除了${removedCount}个临时效果`;
					break;
					
				case 'premium_soap':
					// 只清除非永久debuff（保留正面buff）
					const debuffTypes = ['idea_exhaustion', 'exp_overheat', 'write_block', 'slack_debuff', 'idea_stolen'];
					const beforeLength = gameState.buffs.temporary.length;
					gameState.buffs.temporary = gameState.buffs.temporary.filter(b => {
						// 保留正面buff，清除debuff
						if (debuffTypes.includes(b.type)) return false;
						if (b.isDebuff) return false;
						if (b.value < 0 && !b.multiply) return false;
						if (b.multiply && b.value < 1) return false;
						return true;
					});
					const removedDebuffs = beforeLength - gameState.buffs.temporary.length;
					result += `，清除了${removedDebuffs}个debuff`;
					break;
					
				case 'chicken_burger':
					gameState.san = Math.min(gameState.sanMax, gameState.san + 2);
					result += '，SAN值+2';
					break;
					
				case 'beef_burger':
					gameState.sanMax += 2;
					result += '，SAN上限+2';
					break;
					
				case 'fake_flower':
					gameState.favor = Math.min(gameState.favorMax || 20, gameState.favor + 1);
					result += '，导师好感度+1';
					break;
					
				case 'real_flower':
					gameState.favorMax = (gameState.favorMax || 20) + 1;
					result += `，导师好感度上限+1（现为${gameState.favorMax}）`;
					break;
					
				case 'mooncake':
					gameState.social = Math.min(gameState.socialMax || 20, gameState.social + 1);
					result += '，社交能力+1';
					break;
					
				case 'snow_mooncake':
					gameState.socialMax = (gameState.socialMax || 20) + 1;
					result += `，社交能力上限+1（现为${gameState.socialMax}）`;
					break;
					
				case 'watermelon_book':
					gameState.research = Math.min(gameState.researchMax || 20, gameState.research + 1);
					checkResearchUnlock();
					result += '，科研能力+1';
					break;
					
				case 'andrew_ng_course':
					gameState.researchMax = (gameState.researchMax || 20) + 1;
					result += `，科研能力上限+1（现为${gameState.researchMax}）`;
					break;
					
				case 'bitcoin':
					const goldGain = getBitcoinEffect();
					gameState.gold += goldGain;
					result += `，金币+${goldGain}`;
					break;
			}
			
			addLog('成就商店', `购买了${item.name}`, result);
			closeModal();
			openAchievementShop();  // 刷新商店界面
			updateAllUI();
			updateBuffs();
		}

		// 重置成就商店（每局游戏开始时调用）
		function resetAchievementShop() {
			achievementShopItems.forEach(item => {
				item.bought = false;
			});
		}
        // ==================== 商店系统 ====================
		function openShop() {
			let html = '<div>';
			shopItems.forEach(item => {
				const canBuy = gameState.gold >= item.price && !(item.once && item.bought) && !(item.monthlyOnce && item.boughtThisMonth);
				const reason = gameState.gold < item.price ? '金币不足' : (item.once && item.bought) ? '已购买' : (item.monthlyOnce && item.boughtThisMonth) ? '本月已购' : '';
				
				// ★★★ 新增：冰美式动态描述 ★★★
				let itemDesc = item.desc;
				if (item.id === 'coffee') {
					const count = gameState.coffeeBoughtCount || 0;
					const currentBonus = 3 + Math.floor(count / 15);
					const nextMilestone = (Math.floor(count / 15) + 1) * 15;
					const nextBonus = currentBonus + 1;
					
					itemDesc = `SAN值+${currentBonus}`;
					itemDesc += ` (${count}/${nextMilestone}杯时+${nextBonus})`;
				}
				
				html += `<div class="shop-item ${!canBuy ? 'disabled' : ''}">
					<div class="shop-item-info">
						<div class="shop-item-name">${item.name}</div>
						<div class="shop-item-desc">${itemDesc}</div>
					</div>
					<div class="shop-item-action">
						<span class="shop-item-price">💰${item.price}</span>
						<button class="btn btn-primary" onclick="buyItem('${item.id}')" ${!canBuy ? 'disabled' : ''}>${reason || '购买'}</button>
					</div>
				</div>`;
			});
			html += '</div>';
			showModal('🛒 商店', html, [{ text: '关闭', class: 'btn-info', action: closeModal }]);
		}

        function buyItem(id) {
            const item = shopItems.find(i => i.id === id);
            if (!item) return;
            
            if (gameState.gold < item.price) {
                showModal('❌ 购买失败', `<p>金钱不足！购买${item.name}需要${item.price}金币，当前只有${gameState.gold}金币。</p>`, 
                    [{ text: '确定', class: 'btn-primary', action: closeModal }]);
                return;
            }
            
            let result = `金钱-${item.price}`;
            
            // 富可敌国觉醒：通过消费增加属性
            if (gameState.isReversed && gameState.character === 'rich' && gameState.reversedAwakened) {
                const spent = item.price;
                gameState.goldSpentTotal = (gameState.goldSpentTotal || 0) + spent;
                
                const attributeGains = Math.floor(gameState.goldSpentTotal / 6);
                const previousGains = Math.floor((gameState.goldSpentTotal - spent) / 6);
                const newGains = attributeGains - previousGains;
                
                if (newGains > 0) {
                    gameState.san = Math.min(gameState.sanMax, gameState.san + newGains);
                    gameState.research = Math.min(20, gameState.research + newGains);
                    gameState.social = Math.min(20, gameState.social + newGains);
                    gameState.favor = Math.min(20, gameState.favor + newGains);
                    result += `，金钱觉醒(累计${gameState.goldSpentTotal}金)：SAN+${newGains}, 科研+${newGains}, 社交+${newGains}, 好感+${newGains}`;
                }
            }
            
            gameState.gold -= item.price;
            
            switch(id) {
                case 'gpu_buy':
                    gameState.gpuServersBought = (gameState.gpuServersBought || 0) + 1;
                    if (gameState.gpuServersBought >= 5) {
                        gameState.achievementConditions = gameState.achievementConditions || {};
                        gameState.achievementConditions.bought5GPUs = true;
                    }
                    break;
                    
                case 'chair':
                    gameState.furnitureBought = gameState.furnitureBought || {};
                    gameState.furnitureBought.chair = true;
                    break;
                case 'monitor':
                    gameState.furnitureBought = gameState.furnitureBought || {};
                    gameState.furnitureBought.monitor = true;
                    break;
                case 'keyboard':
                    gameState.furnitureBought = gameState.furnitureBought || {};
                    gameState.furnitureBought.keyboard = true;
                    break;
            }
            
            // 检查全套家具成就
            if (gameState.furnitureBought && 
                gameState.furnitureBought.chair && 
                gameState.furnitureBought.monitor && 
                gameState.furnitureBought.keyboard) {
                gameState.achievementConditions = gameState.achievementConditions || {};
                gameState.achievementConditions.fullFurnitureSet = true;
            }
            
            switch (id) {
                case 'chair':
                    item.bought = true;
                    gameState.buffs.permanent.push({ type: 'monthly_san', name: '每月SAN值+1', value: 1, permanent: true });
                    result += '，获得永久buff-每月SAN值+1';
                    break;
                case 'gpu_buy':
                    gameState.buffs.permanent.push({ type: 'exp_times', name: '每次做实验多做1次', value: 1, permanent: true });
                    result += '，获得永久buff-每次做实验多做1次';
                    break;
                case 'keyboard':
                    item.bought = true;
                    gameState.buffs.permanent.push({ type: 'write_san_reduce', name: '写论文SAN-3', value: 1, permanent: true });
                    result += '，获得永久buff-每次写论文变为SAN值-3';
                    break;
                case 'monitor':
                    item.bought = true;
                    gameState.buffs.permanent.push({ type: 'read_san_reduce', name: '读论文SAN-1', value: 1, permanent: true });
                    result += '，获得永久buff-读论文变为SAN值-1';
                    break;
				case 'coffee':
					item.boughtThisMonth = true;
					gameState.coffeeBoughtCount = (gameState.coffeeBoughtCount || 0) + 1;
					const coffeeBonus = 3 + Math.floor(gameState.coffeeBoughtCount / 15);
					gameState.san = Math.min(gameState.sanMax, gameState.san + coffeeBonus);
					result += `，SAN值+${coffeeBonus}`;
					break;
					
				case 'gemini':
					item.boughtThisMonth = true;
					// ★★★ 只添加一个综合buff，不再单独添加分数buff ★★★
					gameState.buffs.temporary.push({ 
						type: 'idea_san_reduce', 
						name: 'Gemini订阅', 
						value: 1, 
						permanent: false,
						thisMonthOnly: true,
						bonusScore: 4  // ★★★ 在buff中记录分数加成 ★★★
					});
					result += '，获得本月buff-想idea时SAN消耗-1，分数+4';
					break;
					
				case 'gpt':
					item.boughtThisMonth = true;
					gameState.buffs.temporary.push({ 
						type: 'exp_san_reduce', 
						name: 'GPT订阅', 
						value: 1, 
						permanent: false,
						thisMonthOnly: true,
						bonusScore: 4
					});
					result += '，获得本月buff-做实验时SAN消耗-1，分数+4';
					break;
					
				case 'claude':
					item.boughtThisMonth = true;
					gameState.buffs.temporary.push({ 
						type: 'write_san_reduce_temp', 
						name: 'Claude订阅', 
						value: 1, 
						permanent: false,
						thisMonthOnly: true,
						bonusScore: 4
					});
					result += '，获得本月buff-写论文时SAN消耗-1，分数+4';
					break;
					
				case 'gpu_rent':
					// 改为本月buff而不是下次
					gameState.buffs.temporary.push({ 
						type: 'exp_times', 
						name: '本月做实验多做1次', 
						value: 1, 
						permanent: false,
						thisMonthOnly: true
					});
					result += '，获得本月buff-做实验多做1次';
					break;
            }
            
            addLog('购买', `购买了${item.name}`, result);
            closeModal();
            openShop();
            updateAllUI();
            updateBuffs();
        }
        // ==================== 寒假暑假事件 ====================
        function triggerWinterVacationEvent() {
            showModal('❄️ 寒假', 
                `<p>寒假到了！回家过年，收到了长辈的压岁钱，好好休息一下吧～</p>
                 <div style="text-align:center;font-size:2rem;margin:15px 0;">🧧🏠🎆</div>`,
                [{ 
                    text: '🎊 新年快乐！', 
                    class: 'btn-accent', 
					action: () => {
						gameState.gold += 1;
						gameState.san = Math.min(gameState.sanMax, gameState.san + 2);
						addLog('❄️ 寒假', '回家过年', '压岁钱+1，SAN值+2');
						closeModal();
						updateAllUI();
					}
                }]
            );
        }

        function triggerSummerVacationEvent() {
            showModal('☀️ 暑假', 
                `<p>暑假来啦！虽然科研不能停，但可以稍微放松一下，调整状态～</p>
                 <div style="text-align:center;font-size:2rem;margin:15px 0;">🏖️🍉🌴</div>`,
                [{ 
                    text: '😎 好好休息！', 
                    class: 'btn-success', 
					action: () => {
						gameState.san = Math.min(gameState.sanMax, gameState.san + 3);
						addLog('☀️ 暑假', '暑假休息', 'SAN值+3');
						closeModal();
						updateAllUI();
					}
                }]
            );
        }
        
        // ==================== 随机事件系统 ====================
		function triggerScholarshipEvent() {
			const req = { 2: 1, 3: 3, 4: 6, 5: 9 }[gameState.year] || 9;
			// ★★★ 修改：10元改为8元 ★★★
			const reward = { 2: 5, 3: 5, 4: 8, 5: 8 }[gameState.year] || 8;
			
			if (gameState.totalScore >= req) {
				gameState.gold += reward;
				showModal('🎓 奖学金', `<p>恭喜！你的科研分达到${gameState.totalScore}分，满足本年度奖学金要求（≥${req}分），获得奖学金${reward}金币！</p>`,
					[{ text: '太棒了！', class: 'btn-primary', action: () => {
						addLog('奖学金', `第${gameState.year}年奖学金`, `科研分${gameState.totalScore}≥${req}，金钱+${reward}`);
						closeModal(); updateAllUI();
					}}]);
			} else {
				showModal('🎓 奖学金', `<p>遗憾落选！本年度奖学金要求科研分≥${req}，你目前${gameState.totalScore}分。</p>`,
					[{ text: '继续努力', class: 'btn-info', action: () => {
						addLog('奖学金', `第${gameState.year}年奖学金`, `科研分${gameState.totalScore}<${req}，遗憾落选`);
						closeModal();
					}}]);
			}
		}

        function triggerTeachersDayEvent() {
            showModal('🎁 教师节', '<p>教师节到了，你准备送导师什么礼物？</p>', [
                { text: '什么也不送', class: 'btn-info', action: () => {
                    closeModal();
                    if (gameState.favor >= 6) {
                        addLog('教师节', '什么也不送', '无事发生');
                        updateAllUI();
                    } else {
                        addLog('教师节', '什么也不送', '导师对你略有不满，导师好感度-1');
                        changeFavor(-1);
                    }
                }},
                { text: '🍵 赠送茶叶（1金）', class: 'btn-primary', action: () => {
                    addLog('教师节', '赠送茶叶', '金钱-1，导师开心收下茶叶，导师好感度+1');
                    closeModal();
                    gameState.favor = Math.min(20, gameState.favor + 1);
                    changeGold(-1);
                }},
                { text: '📮 赠送邮票（3金）', class: 'btn-warning', action: () => {
                    addLog('教师节', '赠送邮票', '金钱-3，导师开心收下邮票并点了点头，导师好感度+2');
                    closeModal();
                    gameState.favor = Math.min(20, gameState.favor + 2);
                    changeGold(-3);
                }}
            ]);
        }

		// ★★★ 新增：学年总结事件 ★★★
		function triggerYearEndSummaryEvent() {
			showModal('📅 学年总结', 
				`<div style="text-align:center;margin-bottom:15px;">
					<div style="font-size:2.5rem;margin-bottom:10px;">📝</div>
					<div style="font-size:1.1rem;font-weight:600;color:var(--primary-color);">第${gameState.year}年学年总结</div>
					<div style="font-size:0.85rem;color:var(--text-secondary);margin-top:5px;">除了科研，你今年都干了什么？</div>
				</div>
				<p style="text-align:center;color:var(--text-secondary);font-size:0.85rem;">选择一项作为你今年的主要活动：</p>`,
				[
					{ text: '😴 都在睡大觉', class: 'btn-info', action: () => {
						addLog('学年总结', '今年除了科研都在睡大觉', 'SAN+5');
						closeModal();
						changeSan(5);
					}},
					{ text: '🎉 和同学玩耍', class: 'btn-success', action: () => {
						addLog('学年总结', '今年主要在和同学玩耍', '社交能力+1');
						closeModal();
						changeSocial(1);
					}},
					{ text: '👨‍🏫 帮导师干活', class: 'btn-accent', action: () => {
						addLog('学年总结', '今年主要在帮导师干活', '导师好感度+1');
						closeModal();
						changeFavor(1);
					}},
					{ text: '💼 偷偷实习', class: 'btn-warning', action: () => {
						addLog('学年总结', '今年偷偷在外面实习', '金钱+2');
						closeModal();
						changeGold(2);
					}}
				]
			);
		}

        function triggerOtherRandomEvent() {
            let availableEvents = [...gameState.availableRandomEvents];
            
            if (gameState.social >= 6 && !availableEvents.includes(11) && !gameState.usedRandomEvents.includes(11)) {
                availableEvents.push(11);
            }
            
            if (availableEvents.length === 0) {
                resetRandomEventPool();
                availableEvents = [...gameState.availableRandomEvents];
                if (gameState.social >= 6) {
                    availableEvents.push(11);
                }
                addLog('事件轮换', '新一轮随机事件开始', '所有事件重新可用');
            }
            
            const eventIndex = Math.floor(Math.random() * availableEvents.length);
            const eventId = availableEvents[eventIndex];
            // ★★★ 新增：检查是否抵抗感冒 ★★★
			if (eventId === 3 && gameState.totalMonths === gameState.badmintonMonth + 1) {
				// 从可用池中移除感冒事件
				gameState.availableRandomEvents = gameState.availableRandomEvents.filter(e => e !== 3);
				if (!gameState.usedRandomEvents.includes(3)) {
					gameState.usedRandomEvents.push(3);
				}
				
				// 显示抵抗感冒的提示
				showModal('💪 随机事件', 
					`<p>本来你要感冒了...</p>
					 <div style="text-align:center;font-size:2rem;margin:15px 0;">🏸➡️🛡️</div>
					 <p>但是上个月打羽毛球强化了身体，成功抵抗了感冒！</p>`,
					[{ 
						text: '身体倍儿棒！', 
						class: 'btn-success', 
						action: () => {
							addLog('随机事件', '感冒来袭', '上个月打羽毛球强化了身体，成功抵抗！');
							closeModal();
							updateAllUI();
						}
					}]
				);
				return;
			}
			
			gameState.availableRandomEvents = gameState.availableRandomEvents.filter(e => e !== eventId);
			if (!gameState.usedRandomEvents.includes(eventId)) {
				gameState.usedRandomEvents.push(eventId);
			}
			
			const eventMap = {
				1: showRandomEvent1,
				2: showRandomEvent2,
				3: showRandomEvent3,
				4: showRandomEvent4,
				5: showRandomEvent5,
				6: showRandomEvent6,
				7: showRandomEvent7,
				8: showRandomEvent8,
				9: showRandomEvent9,
				10: showRandomEvent10,
				11: showRandomEvent11,
				12: showRandomEvent12,
				13: showRandomEvent13,
				14: showRandomEvent14,
				15: showRandomEvent15,
			};
			
			if (eventMap[eventId]) {
				eventMap[eventId]();
			}
		}

        function showRandomEvent1() {
            showModal('📚 随机事件', '<p>导师派你指导本科生毕设。</p>', [
                { text: '残忍拒绝', class: 'btn-danger', action: () => {
                    addLog('随机事件', '导师派你指导本科生毕设 - 残忍拒绝', '导师对你略有不满，导师好感度-1');
                    closeModal();
                    changeFavor(-1);
                }},
                { text: '亲力亲为', class: 'btn-primary', action: () => {
                    closeModal();
                    const baseSanCost = -3;
                    const actualSanCost = getActualSanChange(baseSanCost);
                    const sanText = actualSanCost !== baseSanCost ? `SAN值${actualSanCost}（怠惰×${gameState.reversedAwakened ? 3 : 2}）` : `SAN值${actualSanCost}`;
                    
                    if (Math.random() < 0.5) {
                        addLog('随机事件', '导师派你指导本科生毕设 - 亲力亲为', `本科生顺利毕业，后成为你的师弟师妹帮助你科研打下手，${sanText}，科研能力+1`);
                        changeResearch(1);
                    } else {
                        addLog('随机事件', '导师派你指导本科生毕设 - 亲力亲为', `本科生顺利毕业，${sanText}`);
                    }
                    changeSan(baseSanCost);
                }},
                { text: '让师弟师妹去指导', class: 'btn-info', action: () => {
                    closeModal();
                    if (gameState.social < 6) {
                        addLog('随机事件', '导师派你指导本科生毕设 - 让师弟师妹去指导', '师弟师妹对你颇有微词，社交能力-1');
                        changeSocial(-1);
                    } else {
                        addLog('随机事件', '导师派你指导本科生毕设 - 让师弟师妹去指导', '师弟师妹成功为你分忧');
                        updateAllUI();
                    }
                }}
            ]);
        }

        function showRandomEvent2() {
            showModal('📝 随机事件', '<p>导师让你帮他审稿。</p>', [
                { text: '以没时间为由拒绝', class: 'btn-danger', action: () => {
                    addLog('随机事件', '导师让你帮他审稿 - 以没时间为由拒绝', '导师对你略有不满，导师好感度-1');
                    closeModal();
                    changeFavor(-1);
                }},
                { text: '认真审稿', class: 'btn-primary', action: () => {
                    closeModal();
                    const baseSanCost = -2;
                    const actualSanCost = getActualSanChange(baseSanCost);
                    const sanText = actualSanCost !== baseSanCost ? `SAN值${actualSanCost}（怠惰×${gameState.reversedAwakened ? 3 : 2}）` : `SAN值${actualSanCost}`;
                    
                    if (Math.random() < 0.5) {
                        gameState.buffs.temporary.push({ type: 'idea_bonus', name: '下次想idea分数+4', value: 4, permanent: false });
                        addLog('随机事件', '导师让你帮他审稿 - 认真审稿', `得到了启发，${sanText}，临时buff-下次想idea分数+4`);
                        updateBuffs();
                    } else {
                        addLog('随机事件', '导师让你帮他审稿 - 认真审稿', `无事发生，${sanText}`);
                    }
                    changeSan(baseSanCost);
                }},
                { text: '交给师弟师妹', class: 'btn-info', action: () => {
                    closeModal();
                    if (gameState.social < 6) {
                        addLog('随机事件', '导师让你帮他审稿 - 交给师弟师妹', '师弟师妹对你颇有微词，社交能力-1');
                        changeSocial(-1);
                    } else {
                        addLog('随机事件', '导师让你帮他审稿 - 交给师弟师妹', '师弟师妹成功为你分忧');
                        updateAllUI();
                    }
                }}
            ]);
        }

		function showRandomEvent3() {
			showModal('🤧 随机事件', '<p>突然感冒了。</p>', [
				{ text: '强撑', class: 'btn-danger', action: () => {
					closeModal();
					if (Math.random() < 0.5) {
						const baseSanCost = -8;
						const actualSanCost = getActualSanChange(baseSanCost);
						const sanText = actualSanCost !== baseSanCost 
							? `SAN值${actualSanCost}（怠惰×${gameState.reversedAwakened ? 3 : 2}）` 
							: `SAN值${actualSanCost}`;
						addLog('随机事件', '突然感冒了 - 强撑', `身体透支了，${sanText}`);
						changeSan(baseSanCost);
					} else {
						// ★★★ 修改：年轻人身体好的结果 ★★★
						gameState.sanMax -= 2;
						// ★★★ 新增：如果当前SAN高于新上限，则同步降低 ★★★
						if (gameState.san > gameState.sanMax) {
							const sanReduced = gameState.san - gameState.sanMax;
							gameState.san = gameState.sanMax;
							addLog('随机事件', '突然感冒了 - 强撑', `这次没事但留下了病根，SAN上限-2，SAN值-${sanReduced}`);
						} else {
							addLog('随机事件', '突然感冒了 - 强撑', '这次没事但留下了病根，SAN上限-2');
						}
						updateAllUI();
					}
				}},
				{ text: '自己买感冒药', class: 'btn-primary', action: () => {
					addLog('随机事件', '突然感冒了 - 自己买感冒药', '喝999感冒灵好了，金钱-2');
					closeModal();
					changeGold(-2);
				}},
				{ text: '去医院看病', class: 'btn-info', action: () => {
					addLog('随机事件', '突然感冒了 - 去医院看病', '医生妙手回春，你比生病前还精神，SAN值+2，金钱-4');
					gameState.san = Math.min(gameState.sanMax, gameState.san + 2);
					closeModal();
					changeGold(-4);
				}}
			]);
		}

        function showRandomEvent4() {
            showModal('💼 随机事件', '<p>导师安排你做项目。</p>', [
                { text: '横向项目', class: 'btn-warning', action: () => {
                    const baseSanCost = -7;
                    const actualSanCost = getActualSanChange(baseSanCost);
                    const sanText = actualSanCost !== baseSanCost ? `SAN值${actualSanCost}（怠惰×${gameState.reversedAwakened ? 3 : 2}）` : `SAN值${actualSanCost}`;
                    addLog('随机事件', '导师安排你做项目 - 横向项目', `成功结项，${sanText}，导师好感度+1，金钱+5`);
                    closeModal();
                    gameState.favor = Math.min(20, gameState.favor + 1);
                    gameState.gold += 5;
                    changeSan(baseSanCost);
                }},
                { text: '纵向项目', class: 'btn-primary', action: () => {
                    const baseSanCost = -5;
                    const actualSanCost = getActualSanChange(baseSanCost);
                    const sanText = actualSanCost !== baseSanCost ? `SAN值${actualSanCost}（怠惰×${gameState.reversedAwakened ? 3 : 2}）` : `SAN值${actualSanCost}`;
                    addLog('随机事件', '导师安排你做项目 - 纵向项目', `成功结项，${sanText}，导师好感度+1，科研能力+1`);
                    closeModal();
                    gameState.favor = Math.min(20, gameState.favor + 1);
                    changeResearch(1);
                    changeSan(baseSanCost);
                }},
                { text: '拒绝项目', class: 'btn-danger', action: () => {
                    closeModal();
                    if (gameState.research < 6) {
                        addLog('随机事件', '导师安排你做项目 - 拒绝项目', '导师对你比较不满，导师好感度-2');
                        changeFavor(-2);
                    } else if (gameState.research < 12) {
                        addLog('随机事件', '导师安排你做项目 - 拒绝项目', '导师对你略为不满，导师好感度-1');
                        changeFavor(-1);
                    } else {
                        addLog('随机事件', '导师安排你做项目 - 拒绝项目', '导师让你以科研为重');
                        updateAllUI();
                    }
                }},
                { text: '让师弟师妹分担', class: 'btn-info', action: () => {
                    closeModal();
                    if (gameState.social < 6) {
                        const baseSanCost = -2;
                        const actualSanCost = getActualSanChange(baseSanCost);
                        const sanText = actualSanCost !== baseSanCost ? `SAN值${actualSanCost}（怠惰×${gameState.reversedAwakened ? 3 : 2}）` : `SAN值${actualSanCost}`;
                        addLog('随机事件', '导师安排你做项目 - 让师弟师妹分担一部分', `师弟师妹对你颇有微词，${sanText}，社交能力-1`);
                        changeSocial(-1);
                        changeSan(baseSanCost);
                    } else if (gameState.social < 12) {
                        const baseSanCost = -2;
                        const actualSanCost = getActualSanChange(baseSanCost);
                        const sanText = actualSanCost !== baseSanCost ? `SAN值${actualSanCost}（怠惰×${gameState.reversedAwakened ? 3 : 2}）` : `SAN值${actualSanCost}`;
                        addLog('随机事件', '导师安排你做项目 - 让师弟师妹分担一部分', `师弟师妹成功为你分忧，${sanText}`);
                        changeSan(baseSanCost);
                    } else {
                        addLog('随机事件', '导师安排你做项目 - 让师弟师妹分担一部分', '师弟师妹主动全包了');
                        updateAllUI();
                    }
                }}
            ]);
        }

        function showRandomEvent5() {
            showModal('💬 随机事件', '<p>导师找你谈话。</p>', [
                { text: '认真准备科研进展', class: 'btn-primary', action: () => {
                    closeModal();
                    if (Math.random() < 0.5) {
                        gameState.buffs.temporary.push({ type: 'idea_bonus', name: '下次想idea分数+5', value: 5, permanent: false });
                        addLog('随机事件', '导师找你谈话 - 认真准备科研进展', '导师指出你关键错误，临时buff-下次想idea分数+5');
                        updateBuffs();
                        updateAllUI();
                    } else {
                        addLog('随机事件', '导师找你谈话 - 认真准备科研进展', '导师发现你在摸鱼，导师好感度-1');
                        changeFavor(-1);
                    }
                }},
                { text: '向导师询问如何科研', class: 'btn-info', action: () => {
                    closeModal();
                    if (gameState.favor < 6) {
                        addLog('随机事件', '导师找你谈话 - 向导师询问如何科研', '导师觉得你天资愚笨，导师好感度-1');
                        changeFavor(-1);
                    } else {
                        addLog('随机事件', '导师找你谈话 - 向导师询问如何科研', '导师传授你科研秘诀，科研能力+1');
                        changeResearch(1);
                    }
                }},
                { text: '告诉导师想要去实习', class: 'btn-warning', action: () => {
                    closeModal();
                    if (gameState.favor >= 6) {
                        const baseSanCost = -6;
                        const actualSanCost = getActualSanChange(baseSanCost);
                        const sanText = actualSanCost !== baseSanCost ? `SAN值${actualSanCost}（怠惰×${gameState.reversedAwakened ? 3 : 2}）` : `SAN值${actualSanCost}`;
                        gameState.buffs.temporary.push({ type: 'exp_bonus', name: '下次做实验分数+5', value: 5, permanent: false });
                        gameState.gold += 5;
                        addLog('随机事件', '导师找你谈话 - 告诉导师想要去实习', `导师居然同意了但要兼顾科研，${sanText}，临时buff-下次做实验分数+5，金钱+5`);
                        updateBuffs();
                        changeSan(baseSanCost);
                    } else {
                        addLog('随机事件', '导师找你谈话 - 告诉导师想要去实习', '导师果然拒绝了，导师好感度-1');
                        changeFavor(-1);
                    }
                }}
            ]);
        }

        function showRandomEvent6() {
            showModal('📊 随机事件', '<p>实验室召开组会。</p>', [
                { text: '讲解一篇深奥论文', class: 'btn-primary', action: () => {
                    closeModal();
                    if (gameState.research < 6) {
                        addLog('随机事件', '实验室召开组会 - 讲解一篇深奥论文', '导师发现你不懂装懂，导师好感度-1');
                        changeFavor(-1);
                    } else {
                        addLog('随机事件', '实验室召开组会 - 讲解一篇深奥论文', '导师夸赞了你的见解，导师好感度+1');
                        changeFavor(1);
                    }
                }},
                { text: '讲解系列论文', class: 'btn-warning', action: () => {
                    closeModal();
                    const baseSanCost = -3;
                    const actualSanCost = getActualSanChange(baseSanCost);
                    const sanText = actualSanCost !== baseSanCost ? `SAN值${actualSanCost}（怠惰×${gameState.reversedAwakened ? 3 : 2}）` : `SAN值${actualSanCost}`;
                    
                    if (Math.random() < 0.5) {
                        addLog('随机事件', '实验室召开组会 - 讲解系列论文', `虽然很辛苦但导师大力夸赞了你的见解，${sanText}，导师好感度+2`);
                        gameState.favor = Math.min(20, gameState.favor + 2);
                    } else {
                        addLog('随机事件', '实验室召开组会 - 讲解系列论文', `虽然很辛苦但导师没来参会，${sanText}`);
                    }
                    changeSan(baseSanCost);
                }},
                { text: '偷偷水过去', class: 'btn-info', action: () => {
                    closeModal();
                    if (Math.random() < 0.5) {
                        addLog('随机事件', '实验室召开组会 - 偷偷水过去', '导师对你略有不满，导师好感度-1');
                        changeFavor(-1);
                    } else {
                        addLog('随机事件', '实验室召开组会 - 偷偷水过去', '导师恰好没来');
                        updateAllUI();
                    }
                }}
            ]);
        }

        function showRandomEvent7() {
            showModal('🎉 随机事件', '<p>实验室组织团建。</p>', [
                { text: '🏸 打羽毛球', class: 'btn-primary', action: () => {
					gameState.badmintonMonth = gameState.totalMonths;
                    addLog('随机事件', '实验室组织团建 - 打羽毛球', '脖子和手臂得到了强化，有助于抵抗感冒，SAN值+2');
                    closeModal();
                    changeSan(2);
                }},
                { text: '🃏 打德州扑克', class: 'btn-warning', action: () => {
                    closeModal();
                    if (Math.random() < 0.5) {
                        addLog('随机事件', '实验室组织团建 - 打德州扑克', '输了，金钱-5');
                        changeGold(-5);
                    } else {
                        addLog('随机事件', '实验室组织团建 - 打德州扑克', '赢了，金钱+5');
                        changeGold(5);
                    }
                }},
                { text: '🎤 KTV唱歌', class: 'btn-accent', action: () => {
                    addLog('随机事件', '实验室组织团建 - KTV唱歌', '唱了猪猪侠主题曲，聪明勇敢有力气，社交能力+1');
                    closeModal();
                    changeSocial(1);
                }},
				{ text: '🍜 聚餐', class: 'btn-info', action: () => {
					closeModal();
					if (Math.random() < 0.5) {
						addLog('随机事件', '实验室组织团建 - 聚餐', '吃饱了，金钱-3，SAN值+5');
						gameState.san = Math.min(gameState.sanMax, gameState.san + 5);
						changeGold(-3);
					} else {
						addLog('随机事件', '实验室组织团建 - 聚餐', '导师请客，SAN值+5');
						changeSan(5);
					}
				}}
            ]);
        }

        function showRandomEvent8() {
            showModal('💰 随机事件', '<p>导师科研经费充足，你建议。</p>', [
                { text: '🖥️ 购买GPU服务器', class: 'btn-primary', action: () => {
                    closeModal();
                    if (Math.random() < 0.5) {
                        addLog('随机事件', '导师科研经费充足 - 购买高性能GPU服务器', '导师并不想买');
                    } else {
                        gameState.buffs.permanent.push({ type: 'exp_times', name: '每次做实验多做一次', value: 1, permanent: true });
                        addLog('随机事件', '导师科研经费充足 - 购买高性能GPU服务器', '你只分到了一张显卡，但总比没有好，永久buff-每次做实验多做一次');
                        updateBuffs();
                    }
                    updateAllUI();
                }},
                { text: '💵 多发劳务费', class: 'btn-warning', action: () => {
                    closeModal();
                    const amount = gameState.favor < 6 ? 2 : gameState.favor < 12 ? 4 : 8;
                    const desc = gameState.favor < 6 ? '导师只发了一点点' : gameState.favor < 12 ? '导师发了很多' : '导师全给你了';
                    gameState.gold += amount;
                    addLog('随机事件', '导师科研经费充足 - 多发劳务费', `${desc}，金钱+${amount}`);
                    updateAllUI();
                }},
                { text: '🪑 装修学生工位', class: 'btn-info', action: () => {
                    closeModal();
                    gameState.buffs.permanent.push(
                        { type: 'idea_bonus', name: '每次想idea分数+1', value: 1, permanent: true },
                        { type: 'write_bonus', name: '每次写论文分数+1', value: 1, permanent: true }
                    );
                    addLog('随机事件', '导师科研经费充足 - 装修学生工位', '非常舒适，永久buff-每次想idea分数+1，永久buff-每次写论文分数+1');
                    updateAllUI();
                    updateBuffs();
                }}
            ]);
        }

        function showRandomEvent9() {
            showModal('📖 随机事件', '<p>你打算学点新知识，你会选择。</p>', [
                { text: '📚 基础知识', class: 'btn-primary', action: () => {
                    closeModal();
                    if (gameState.research < 4) {
                        addLog('随机事件', '学习新知识 - 基础知识', '打好了基础，科研能力+1');
                        changeResearch(1);
                    } else {
                        addLog('随机事件', '学习新知识 - 基础知识', '对你没有什么帮助');
                        updateAllUI();
                    }
                }},
                { text: '💻 代码知识', class: 'btn-info', action: () => {
                    closeModal();
                    gameState.buffs.permanent.push({ type: 'exp_bonus', name: '每次做实验分数+1', value: 1, permanent: true });
                    addLog('随机事件', '学习新知识 - 代码知识', '永久buff-每次做实验分数+1');
                    updateAllUI();
                    updateBuffs();
                }},
                { text: '🚀 最新技术', class: 'btn-warning', action: () => {
                    closeModal();
                    gameState.buffs.permanent.push({ type: 'idea_bonus', name: '每次想idea分数+1', value: 1, permanent: true });
                    addLog('随机事件', '学习新知识 - 最新技术', '永久buff-每次想idea分数+1');
                    updateAllUI();
                    updateBuffs();
                }},
                { text: '🔮 深奥的知识', class: 'btn-accent', action: () => {
                    closeModal();
                    gameState.buffs.permanent.push({ type: 'write_bonus', name: '每次写论文分数+1', value: 1, permanent: true });
                    addLog('随机事件', '学习新知识 - 看起来很深奥的知识', '永久buff-每次写论文分数+1');
                    updateAllUI();
                    updateBuffs();
                }}
            ]);
        }

        function showRandomEvent10() {
            showModal('🤝 随机事件', '<p>同门找你合作论文，你会选择。</p>', [
                { text: '学术交流', class: 'btn-primary', action: () => {
                    closeModal();
					if (Math.random() < 0.5) {
						gameState.buffs.temporary.push({ type: 'idea_stolen', name: '下次想idea总分÷2', value: 0.5, multiply: true, permanent: false });  // ★★★ 改为除2 ★★★
						addLog('随机事件', '同门找你合作论文 - 学术交流', '被同门偷走idea，临时debuff-下次想idea总分÷2');
					} else {
                        gameState.buffs.temporary.push({ type: 'idea_bonus', name: '下次想idea分数+5', value: 5, permanent: false });
                        addLog('随机事件', '同门找你合作论文 - 学术交流', '共同进步，临时buff-下次想idea分数+5');
                    }
                    updateAllUI();
                    updateBuffs();
                }},
				{ text: '约定互挂论文', class: 'btn-warning', action: () => {
					closeModal();
					if (Math.random() < 0.5) {
						gameState.buffs.temporary.push({ type: 'citation_multiply', name: '下一篇中稿论文引用速度+100%', value: 2, permanent: false });
						addLog('随机事件', '同门找你合作论文 - 约定互挂论文', '你们一起中了论文，临时buff-下一篇中稿的论文引用速度+100%（与其他推广加成叠加）');
					} else {
                        addLog('随机事件', '同门找你合作论文 - 约定互挂论文', '同门太菜了，一直没中论文');
                    }
                    updateAllUI();
                    updateBuffs();
                }},
                { text: '婉拒合作', class: 'btn-info', action: () => {
                    addLog('随机事件', '同门找你合作论文 - 婉拒合作', '无事发生');
                    closeModal();
                }},
                { text: '开展全面合作', class: 'btn-success', action: () => {
                    closeModal();
                    if (gameState.social < 6) {
                        gameState.buffs.temporary.push({ type: 'idea_times', name: '下次想idea多想1次', value: 1, permanent: false });
                        addLog('随机事件', '同门找你合作论文 - 开展全面合作', '成功合作，临时buff-下次想idea多想1次');
                    } else {
                        gameState.buffs.temporary.push(
                            { type: 'idea_times', name: '下次想idea多想1次', value: 1, permanent: false },
                            { type: 'write_times', name: '下次写论文多写1次', value: 1, permanent: false }
                        );
                        addLog('随机事件', '同门找你合作论文 - 开展全面合作', '深入合作，临时buff-下次想idea多想1次，临时buff-下次写论文多写1次');
                    }
                    updateAllUI();
                    updateBuffs();
                }}
            ]);
        }

        function showRandomEvent11() {
            showModal('👨‍🎓 随机事件', '<p>师兄师姐找你合作论文，你会选择。</p>', [
                { text: '观望一下', class: 'btn-info', action: () => {
                    addLog('随机事件', '师兄师姐找你合作论文 - 观望一下', '师兄师姐先找了同门合作');
                    closeModal();
                }},
                { text: '浅浅合作', class: 'btn-primary', action: () => {
                    closeModal();
                    gameState.buffs.temporary.push({ type: 'idea_bonus', name: '下次想idea分数+10', value: 10, permanent: false });
                    addLog('随机事件', '师兄师姐找你合作论文 - 浅浅合作', '师兄师姐给了你一个idea，临时buff-下次想idea分数+10');
                    updateAllUI();
                    updateBuffs();
                }},
                { text: '深入合作', class: 'btn-warning', action: () => {
                    addLog('随机事件', '师兄师姐找你合作论文 - 深入合作', '遇到靠谱的师兄师姐，科研能力+1');
                    closeModal();
                    changeResearch(1);
                }},
                { text: '拜入门下', class: 'btn-success', action: () => {
                    closeModal();
                    changeResearch(1);
                    gameState.buffs.permanent.push({ type: 'write_bonus', name: '每次写论文分数+3', value: 3, permanent: true });
                    addLog('随机事件', '师兄师姐找你合作论文 - 拜入门下', '你收获了第二导师，科研能力+1，永久buff-每次写论文分数+3');
                    updateAllUI();
                    updateBuffs();
                }}
            ]);
        }

		function showRandomEvent12() {
			// ★★★ 新增：判断是否为导师子女角色 ★★★
			const isTeacherChild = gameState.character === 'teacher-child';
			
			// ★★★ 新增：根据角色动态生成选项文本 ★★★
			const grabOptionText = isTeacherChild 
				? '劝说导师抢师弟师妹一作 🎁（导师子女：获得C类论文）' 
				: '劝说导师抢师弟师妹一作';
			const grabOptionClass = isTeacherChild ? 'btn-success' : 'btn-warning';  // 导师子女用绿色按钮突出显示
			
			showModal('⚠️ 随机事件', '<p>导师想要抢你论文的一作。</p>', [
				{ text: '向导师诉苦', class: 'btn-primary', action: () => {
					closeModal();
					if (gameState.favor >= 6) {
						addLog('随机事件', '导师想要抢你论文的一作 - 向导师诉苦', '导师心软了');
						updateAllUI();
					} else {
						gameState.buffs.temporary.push({ type: 'idea_bonus', name: '下次想idea分数-5', value: -5, permanent: false });
						addLog('随机事件', '导师想要抢你论文的一作 - 向导师诉苦', '导师不要一作了，但也减少了指导，临时debuff-下次想idea分数-3');
						updateAllUI();
						updateBuffs();
					}
				}},
				{ text: grabOptionText, class: grabOptionClass, action: () => {  // ★★★ 使用动态文本和样式 ★★★
					closeModal();
					if (gameState.character === 'teacher-child') {  // ★★★ 简化判断条件 ★★★
						const title = generatePaperTitle();
						gameState.publishedPapers.push({
							title: title,
							grade: 'C',
							acceptType: 'Poster',
							score: 15,
							citations: 0,
							monthsSincePublish: 0,
							promotions: { arxiv: false, github: false, xiaohongshu: false, quantumbit: false },
							citationMultiplier: 1
						});
						gameState.paperC++;
						gameState.totalScore += 1;
						addLog('随机事件', '导师想要抢你论文的一作 - 劝说导师抢师弟师妹一作', '导师抢来并给了你一篇C类论文');
					} else {
						addLog('随机事件', '导师想要抢你论文的一作 - 劝说导师抢师弟师妹一作', '师弟师妹对你略有不满，社交能力-1');
						changeSocial(-1);
					}
					updateAllUI();
				}},
				{ text: '据理力争', class: 'btn-info', action: () => {
					closeModal();
					if (gameState.favor >= 6) {
						addLog('随机事件', '导师想要抢你论文的一作 - 据理力争', '导师轻松被你说服');
						updateAllUI();
					} else {
						const baseSanCost = -2;
						const actualSanCost = getActualSanChange(baseSanCost);
						const sanText = actualSanCost !== baseSanCost ? `SAN值${actualSanCost}（怠惰×${gameState.reversedAwakened ? 3 : 2}）` : `SAN值${actualSanCost}`;
						addLog('随机事件', '导师想要抢你论文的一作 - 据理力争', `导师艰难被你说服，${sanText}`);
						changeSan(baseSanCost);
					}
				}},
				{ text: '以死相逼', class: 'btn-danger', action: () => {
					addLog('随机事件', '导师想要抢你论文的一作 - 以死相逼', '导师对你略有不满，导师好感度-1');
					closeModal();
					changeFavor(-1);
				}}
			]);
		}

        function showRandomEvent13() {
            showModal('💻 随机事件', '<p>实验室服务器突然坏了。</p>', [
                { text: '催导师快修', class: 'btn-primary', action: () => {
                    closeModal();
                    gameState.buffs.permanent.push({ type: 'exp_bonus', name: '每次做实验分数-2', value: -2, permanent: true });
                    addLog('随机事件', '实验室服务器突然坏了 - 催导师快修', '导师每次坏了就帮你重启，永久debuff-每次做实验分数-2');
                    updateAllUI();
                    updateBuffs();
                }},
                { text: '举报同门挖矿', class: 'btn-warning', action: () => {
                    addLog('随机事件', '实验室服务器突然坏了 - 举报同门用服务器挖矿', '同门负责修好了，社交能力-2');
                    closeModal();
                    changeSocial(-2);
                }},
                { text: '自己重装系统', class: 'btn-info', action: () => {
                    closeModal();
                    const baseSanCost = -3;
                    const actualSanCost = getActualSanChange(baseSanCost);
                    const sanText = actualSanCost !== baseSanCost ? `SAN值${actualSanCost}（怠惰×${gameState.reversedAwakened ? 3 : 2}）` : `SAN值${actualSanCost}`;
                    
                    if (Math.random() < 0.5) {
                        addLog('随机事件', '实验室服务器突然坏了 - 自己尝试重装系统', `费劲周折修好了，${sanText}`);
                    } else {
                        changeSocial(-1);
                        gameState.buffs.temporary.push({ type: 'exp_bonus', name: '下次实验总分÷2', value: 0.5, multiply: true, permanent: false });  // ★★★ 改为除2 ★★★
                        addLog('随机事件', '实验室服务器突然坏了 - 自己尝试重装系统', `服务器数据忘了备份了，临时debuff-下次实验分数×0.5，社交能力-1，${sanText}`);
                        updateBuffs();
                    }
                    changeSan(baseSanCost);
                }},
                { text: '淘宝找人修理', class: 'btn-danger', action: () => {
                    closeModal();
                    if (Math.random() < 0.5) {
                        addLog('随机事件', '实验室服务器突然坏了 - 淘宝找人修理', '遇到高手修好了，金币-2');
                        changeGold(-2);
                    } else {
                        const baseSanCost = -2;
                        const actualSanCost = getActualSanChange(baseSanCost);
                        const sanText = actualSanCost !== baseSanCost ? `SAN值${actualSanCost}（怠惰×${gameState.reversedAwakened ? 3 : 2}）` : `SAN值${actualSanCost}`;
                        addLog('随机事件', '实验室服务器突然坏了 - 淘宝找人修理', `遇到无良商家修了很久，金币-4，${sanText}`);
                        gameState.san += actualSanCost;
                        changeGold(-4);
                    }
                }}
            ]);
        }

        function showRandomEvent14() {
            const baseSanCost = 1;
            const actualSanCost = Math.abs(getActualSanChange(-baseSanCost));
            const sanDescText = actualSanCost !== baseSanCost 
                ? `每月SAN-${actualSanCost}（怠惰×${gameState.reversedAwakened ? 3 : 2}）` 
                : `每月SAN-${baseSanCost}`;
            
            showModal('👨‍🎓 随机事件', '<p>你已经初窥科研门道了，考虑指导师弟师妹：</p>', [
                { text: '精力有限算了', class: 'btn-info', action: () => {
                    addLog('随机事件', '指导师弟师妹 - 精力有限算了', '无事发生');
                    closeModal();
                }},
                { text: '最近有个idea可以合作一波', class: 'btn-primary', action: () => {
					const baseCost = 5;
					const actualCost = Math.abs(getActualSanChange(-baseCost));
					
					let sanText = `SAN-${actualCost}`;
					if (actualCost !== baseCost) {
						sanText += `（怠惰×${gameState.reversedAwakened ? 3 : 2}）`;
					}
					addLog('随机事件', '指导师弟师妹 - 合作一个idea', `${sanText}，社交+1`);
					closeModal();
					changeSocial(1);
					changeSan(-baseCost);  // 直接扣除，如果变负会自动触发burnout结局
				}},
                { text: '展开长期合作', class: 'btn-success', action: () => {
                    gameState.buffs.permanent.push({
                        type: 'mentorship',
                        name: '指导师弟师妹',
                        desc: `${sanDescText}，总引用+科研能力值`,
                        permanent: true
                    });
                    addLog('随机事件', '指导师弟师妹 - 展开长期合作', `${sanDescText}，总引用+科研能力值`);
                    closeModal();
                    updateBuffs();
                }}
            ]);
        }

		function showRandomEvent15() {
			showModal('🎮 随机事件', '<p>学了一天你打算玩游戏放松一下。</p>', [
				{ text: '🌲 玩泰拉瑞亚', class: 'btn-success', action: () => {
					const baseSanCost = 4;
					const actualSanCost = Math.abs(getActualSanChange(-baseSanCost));
					const sanText = actualSanCost !== baseSanCost 
						? `SAN值-${actualSanCost}（怠惰×${gameState.reversedAwakened ? 3 : 2}）` 
						: `SAN值-${baseSanCost}`;
					addLog('随机事件', '玩游戏放松 - 玩泰拉瑞亚', `你和同学废寝忘食的联机，${sanText}，社交能力+1`);
					closeModal();
					changeSocial(1);
					changeSan(-baseSanCost);
				}},
				{ text: '🗼 玩魔塔50层', class: 'btn-primary', action: () => {
					const baseSanCost = 6;
					const actualSanCost = Math.abs(getActualSanChange(-baseSanCost));
					const sanText = actualSanCost !== baseSanCost 
						? `SAN值-${actualSanCost}（怠惰×${gameState.reversedAwakened ? 3 : 2}）` 
						: `SAN值-${baseSanCost}`;
					addLog('随机事件', '玩游戏放松 - 玩魔塔50层', `你绞尽脑汁终于击败了骑士队长，${sanText}，科研能力+1`);
					closeModal();
					changeResearch(1);
					changeSan(-baseSanCost);
				}},
				{ text: '🎓 玩研究生模拟器', class: 'btn-info', action: () => {
					addLog('随机事件', '玩游戏放松 - 玩研究生模拟器', '是个轻松愉快的小游戏呢，SAN值+2');
					closeModal();
					changeSan(2);
				}},
				{ text: '👑 玩王者荣耀', class: 'btn-warning', action: () => {
					const baseSanCost = 5;
					const actualSanCost = Math.abs(getActualSanChange(-baseSanCost));
					const sanText = actualSanCost !== baseSanCost 
						? `SAN值-${actualSanCost}（怠惰×${gameState.reversedAwakened ? 3 : 2}）` 
						: `SAN值-${baseSanCost}`;
					addLog('随机事件', '玩游戏放松 - 玩王者荣耀', `成为小代，${sanText}，金币+2`);  // ✅ 改为反引号
					closeModal();
					changeSan(-baseSanCost);  // ✅ 扣SAN
					changeGold(2);            // ✅ 加金币
				}}
			]);
		}

        // ==================== 游戏结局 ====================
        function triggerEnding(type) {
            let title, desc, emoji;
            let endingType = type;
            
            switch (type) {
				case 'isolated':
				title = '被孤立';
				desc = '你的社交能力降为负数，最终被同学和导师孤立，无法继续学业...';
				emoji = '😔';
				break;
                case 'burnout': title = '不堪重负'; desc = '繁重的科研压力压垮了你，你最终选择了离开...'; emoji = '😢'; break;
                case 'expelled': title = '逐出师门'; desc = '导师对你彻底失望，你被劝退了...'; emoji = '😭'; break;
                case 'poor': title = '穷困潦倒'; desc = '你连饭都吃不起了，只能含恨离开...'; emoji = '💸'; break;
                case 'delay': title = '延毕'; desc = '你没能在规定时间内完成毕业要求，只能延期毕业...'; emoji = '⏰'; break;
                case 'quit': title = '主动退学'; desc = '你决定放弃学业，开启人生新篇章...也许这也是一种勇气。'; emoji = '🚪'; break;
				case 'master':
					// ★★★ 新增：真·大多数硕士毕业时检查真·感受生活 ★★★
					if (gameState.isTrueNormal) {
						const tempAchievements = collectAchievements('master');
						const achievementCount = tempAchievements.length;
						if (achievementCount >= 10 && gameState.totalCitations < 1000) {
							title = '真·感受生活';
							desc = '科研不是全部，你体验了丰富多彩的研究生生活。';
							emoji = '🌈';
							endingType = 'true_life';
							break;
						}
					}
					
					if (gameState.totalScore >= 4) { 
						title = '优秀硕士毕业'; 
						desc = '恭喜！你以优异的成绩完成了硕士学业，未来可期！'; 
						emoji = '🌟'; 
						endingType = 'excellent_master';
					} else { 
						title = '硕士毕业'; 
						desc = '恭喜！你顺利完成了硕士学业！'; 
						emoji = '🎓'; 
					}
					break;
                case 'phd':
                    const e = getPhDEndingType();
                    title = e.title; desc = e.desc; emoji = e.emoji;
                    endingType = e.type;
                    break;
            }
			// ★★★ 记录博士通关（用于解锁真·大多数）★★★
			if (HARD_ENDINGS.includes(endingType)) {
				recordCharacterPhdUnlock(gameState.character, gameState.isReversed);
			}
            
            recordEnding(endingType, title);
            
            const achievements = collectAchievements(endingType);
            recordAchievements(achievements);
            
            showEndingModal(title, desc, emoji, endingType);
        }

		function getPhDEndingType() {
			const { paperA, totalCitations, bigBullCooperation, publishedPapers, isTrueNormal } = gameState;
			const totalPapers = publishedPapers.length;
			
			// ★★★ 真实结局判定（优先级最高）★★★
			if (isTrueNormal) {
				// 计算当前成就数量（用于真·感受生活判定）
				const tempAchievements = collectAchievements('phd');
				const achievementCount = tempAchievements.length;
				
				// 优先级1：真·投身科研（引用≥1000）
				if (totalCitations >= 1000) {
					return { type: 'true_devotion', title: '真·投身科研', desc: '你用最朴素的方式，达到了科研的巅峰。', emoji: '💫' };
				}
				
				// 优先级2：真·感受生活（10个成就 + 引用<1000）
				if (achievementCount >= 10 && totalCitations < 1000) {
					return { type: 'true_life', title: '真·感受生活', desc: '科研不是全部，你体验了丰富多彩的研究生生活。', emoji: '🌈' };
				}
				
				// 优先级3：真·博士毕业（发表≥3篇论文）
				if (totalPapers >= 3) {
					return { type: 'true_phd', title: '真·博士毕业', desc: '没有任何外挂，你凭借自己的努力完成了博士学业。', emoji: '🌟' };
				}
				
				// 真·大多数但未达成真实结局条件，返回普通博士结局
				return { type: 'phd', title: '博士毕业', desc: '恭喜！你顺利完成了博士学业！', emoji: '🎓' };
			}
			
			// 原有结局判定
			if (paperA >= 5 && totalCitations > 2000 && bigBullCooperation) 
				return { type: 'future_academician', title: '未来院士', desc: '你的学术成就令人瞩目，成功去大牛组当副教授！', emoji: '👑' };
			if (paperA >= 5 && totalCitations > 1000 && bigBullCooperation) 
				return { type: 'academic_star', title: '学术之星', desc: '你的才华被大牛赏识，成功去大牛组飞升疾走！', emoji: '⭐' };
			if (paperA >= 5 && totalCitations > 1000) 
				return { type: 'become_advisor', title: '我就是导师', desc: '恭喜！你成功留校成为副教授！', emoji: '👨‍🏫' };
			if (paperA >= 4 && totalCitations > 500) 
				return { type: 'green_pepper', title: '青椒', desc: '恭喜！你成功留校飞升疾走！', emoji: '🌶️' };
			if (paperA >= 3) 
				return { type: 'excellent_phd', title: '优秀博士毕业', desc: '恭喜！你以优异的成绩完成了博士学业！', emoji: '🏆' };
			return { type: 'phd', title: '博士毕业', desc: '恭喜！你顺利完成了博士学业！', emoji: '🎓' };
		}

		function collectAchievements(endingType) {
			const a = [];
			
			// 定义顺利毕业的结局类型
			const graduationEndings = ['master', 'excellent_master', 'phd', 'excellent_phd', 'green_pepper', 'become_advisor', 'academic_star', 'future_academician', 'true_phd', 'true_devotion', 'true_life'];
			const isGraduated = graduationEndings.includes(endingType);
			
			// 所有成就都需要顺利毕业才能取得
			if (!isGraduated) {
				return a;
			}
			
			if (gameState.hasLover) a.push('💕 喜结良缘');
			if (gameState.gold >= 30) a.push('💰 家财万贯');
			if (gameState.research > 15 && gameState.social > 15 && gameState.favor > 15 && gameState.gold > 15) a.push('⬡ 六边形战士');
			if (gameState.research >= 20) a.push('🏆 诺奖选手');
			if (gameState.social >= 20) a.push('🌸 交际花');
			if (gameState.favor >= 20) a.push('🤝 铁杆师生');
			if (gameState.san >= 20) a.push('⚡ 精力满满');
			if (gameState.rejectedCount === 0 && gameState.publishedPapers.length > 0) a.push('🎯 百发百中');
			if (gameState.teaBreakCount >= 3) a.push('☕ 我爱茶歇');
			if (gameState.tourCount >= 3) a.push('🏖️ 公费旅游');
			if (gameState.publishedPapers.length >= 10) a.push('🤖 论文机器');
			if (gameState.totalCitations >= 1000) a.push('📚 千引大佬');
			if (gameState.coffeeBoughtCount >= gameState.totalMonths && gameState.totalMonths > 0) a.push('☕ 咖啡爱好者');
			if (gameState.triggeredBuffTypes && ALL_BUFF_TYPES.every(type => gameState.triggeredBuffTypes.includes(type))) a.push('✨ Buff之神');
			if (gameState.achievementConditions && gameState.achievementConditions.highScorePaper) a.push('📜 高分论文');
			if (gameState.achievementConditions && gameState.achievementConditions.unanimousImprovement) a.push('🍀 幸运儿');
			if (gameState.achievementConditions && gameState.achievementConditions.allBadReviewers) a.push('😭 倒霉蛋');
			if (gameState.paperA > 0 && gameState.paperB === 0 && gameState.paperC === 0) a.push('🎻 曲高和寡');
			if (gameState.san === 0 && gameState.gold === 0) a.push('💪 全力以赴');
			const requiredTypes = [
				'A-Poster', 'A-Oral', 'A-Best Paper',
				'B-Poster', 'B-Oral', 'B-Best Paper',
				'C-Poster', 'C-Oral', 'C-Best Paper'
			];
			if (gameState.paperTypeCollection && requiredTypes.every(type => gameState.paperTypeCollection.has(type))) a.push('🏆 全收集');
			if (gameState.rejectedCount >= 5) a.push('👊 越战越勇');
			if (gameState.achievementConditions && gameState.achievementConditions.rejectedPhdTwice) a.push('🧠 人间清醒');
			if (gameState.maxConcurrentReviews >= 4) a.push('🔥 火力全开');
			if (gameState.achievementConditions && gameState.achievementConditions.tripleRejected) a.push('🍚 食之无味');
			if (gameState.achievementConditions && gameState.achievementConditions.bought5GPUs) a.push('🤖 机械飞升');
			if (gameState.achievementConditions && gameState.achievementConditions.fullFurnitureSet) a.push('🛋️ 全套家具');
			if (gameState.achievementConditions && gameState.achievementConditions.phdRequirementMetEarly) a.push('🧒 天才少年');
			
			const hasCPaperOver100 = gameState.publishedPapers.some(p => p.grade === 'C' && p.citations > 100);
			if (hasCPaperOver100) a.push('💎 无法埋没');
			if (gameState.publishedPapers.length > 0 && gameState.publishedPapers[0].citations > 200) a.push('🔔 不鸣则已');
			const stats = [gameState.research, gameState.favor, gameState.social];
			const maxStat = Math.max(...stats);
			const minStat = Math.min(...stats);
			if (maxStat - minStat > 12) a.push('📊 严重偏科');
			if ((gameState.workCount || 0) >= 10) a.push('💼 打工狂人');
			if ((gameState.readCount || 0) >= 20) a.push('📖 爱看论文');
			if (gameState.achievementConditions && gameState.achievementConditions.twoInOneConference) a.push('🏹 一箭双雕');
			
			return a;
		}

		function showEndingModal(title, desc, emoji, endingType) {
			currentEndingData = { title, desc, emoji, endingType };

			const achievements = collectAchievements(endingType);
			// ★★★ 保存玩家本地达成记录 ★★★
			savePlayerRecord(endingType, achievements, gameState.isReversed);
			const locked = ALL_ACHIEVEMENTS.filter(x => !achievements.includes(x));
			
			let modeLabel;
			if (gameState.isTrueNormal) {
				modeLabel = '<span style="color:#d68910;font-size:0.8rem;background:linear-gradient(135deg,rgba(255,215,0,0.3),rgba(255,140,0,0.3));padding:2px 8px;border-radius:10px;">✨ 真实模式</span>';
			} else if (gameState.isReversed) {
				modeLabel = '<span style="color:#9b59b6;font-size:0.8rem;">🌑 逆位模式</span>';
			} else {
				modeLabel = '<span style="color:#6c5ce7;font-size:0.8rem;">☀️ 正位模式</span>';
			}

			const failedEndings = ['quit', 'burnout', 'expelled', 'poor', 'delay'];
			const successEndings = ['master', 'excellent_master', 'phd', 'excellent_phd', 'green_pepper', 'become_advisor', 'academic_star', 'future_academician'];
			const isFailed = failedEndings.includes(endingType);
			const isSuccess = successEndings.includes(endingType);

			let html = `<div style="text-align:center;margin-bottom:15px;">
				<div style="font-size:3rem;margin-bottom:10px;">${emoji}</div>
				<div style="font-size:1.3rem;font-weight:700;color:var(--primary-color);margin-bottom:8px;">${title}</div>
				${modeLabel}
				<div style="color:var(--text-secondary);line-height:1.5;font-size:0.9rem;margin-top:8px;">${desc}</div>
			</div>`;
			
			if (isFailed) {
				html += `
				<div style="background:linear-gradient(135deg,rgba(253,121,168,0.15),rgba(108,92,231,0.15));border-radius:12px;padding:12px;margin-bottom:12px;text-align:center;">
					<div style="font-size:0.9rem;margin-bottom:8px;">💪 不要灰心！科研之路漫漫，来日方长~</div>
					<a href="http://xhslink.com/o/8czcPQfNziK" target="_blank" 
					   style="display:inline-block;padding:8px 16px;background:linear-gradient(135deg,var(--accent-color),var(--primary-color));color:white;text-decoration:none;border-radius:20px;font-size:0.85rem;font-weight:500;transition:all 0.3s ease;"
					   onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(253,121,168,0.4)'"
					   onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none'">
						<i class="fas fa-palette"></i> 作者向你传授科研绘图心得
					</a>
				</div>`;
			}
			
			if (isSuccess) {
				html += `
				<div style="background:linear-gradient(135deg,rgba(0,184,148,0.15),rgba(108,92,231,0.15));border-radius:12px;padding:12px;margin-bottom:12px;text-align:center;">
					<div style="font-size:0.9rem;margin-bottom:8px;">🎉 恭喜毕业！新的征程即将开始~</div>
					  <a href="http://xhslink.com/o/AC6pvxkgOhv" target="_blank" 
						 style="display:inline-block;padding:8px 16px;background:linear-gradient(135deg,var(--success-color),var(--primary-color));color:white;text-decoration:none;border-radius:20px;font-size:0.85rem;font-weight:500;transition:all 0.3s ease;"
						 onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(0,184,148,0.4)'"
						 onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none'">
						<i class="fas fa-building"></i> 作者诚邀你来上海AI Lab实习
					  </a>
				</div>`;
			}

			// ★★★ 真实结局特殊寄语 ★★★
			const isTrueEnding = endingType === 'true_phd' || endingType === 'true_devotion';
			if (isTrueEnding) {
				html += `
				<div style="background:linear-gradient(135deg,rgba(255,215,0,0.2),rgba(255,140,0,0.2));border-radius:12px;padding:15px;margin-bottom:12px;border:2px solid rgba(255,140,0,0.5);">
					<div style="text-align:center;margin-bottom:12px;">
						<div style="font-size:1.5rem;margin-bottom:8px;">🎊</div>
						<div style="font-size:1.1rem;font-weight:700;color:#d68910;">恭喜你达成了真实结局！</div>
					</div>
					
					<div style="background:white;border-radius:10px;padding:15px;font-size:0.85rem;line-height:1.8;">
						<div style="margin-bottom:12px;">
							<strong style="color:#d68910;">📝 作者寄语：</strong>
						</div>
						
						<div style="margin-bottom:10px;">
							<strong>如果你是在读研究生：</strong><br>
							祝你在读研路上一帆风顺，不忘初心，聪明勇敢有力气！💪
						</div>
						
						<div style="margin-bottom:10px;">
							<strong>如果你还没开始读研/读博：</strong><br>
							这是一个初步体会研究生生活的游戏，好好想想自己想要的是什么。🤔
						</div>
						
						<div>
							<strong>如果你已经毕业了：</strong><br>
							那就权当重温那段逝去的时光吧，在游戏里大杀四方！🎮
						</div>
					</div>
					
					<div style="text-align:center;margin-top:12px;font-size:0.8rem;color:var(--text-secondary);">
						—— 感谢游玩《研究生模拟器》——
					</div>
				</div>`;
			}
			
			// ★★★ 新增：重开按钮放在生涯总结上方 ★★★
			html += `
			<div style="text-align:center;margin-bottom:12px;">
				<button class="btn btn-primary" onclick="restartGame()" style="padding:10px 30px;font-size:1rem;">
					<i class="fas fa-redo"></i> 🔄 我要重开
				</button>
			</div>`;
			
			html += `<div style="background:var(--light-bg);border-radius:12px;padding:15px;margin-bottom:12px;">
				<div style="font-weight:600;margin-bottom:10px;color:var(--primary-color);font-size:0.9rem;"><i class="fas fa-scroll"></i> 生涯总结</div>
				<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:6px;font-size:0.8rem;">
					<div>👤 角色：${gameState.characterName}</div>
					<div>📅 历时：${gameState.totalMonths}个月</div>
					<div>📊 科研分：${gameState.totalScore}</div>
					<div>📝 论文数：${gameState.publishedPapers.length}</div>
					<div>🅰️ A类：${gameState.paperA} 🅱️ B类：${gameState.paperB}</div>
					<div>©️ C类：${gameState.paperC} 📈 引用：${gameState.totalCitations}</div>
					<div>🧠 科研：${gameState.research} 👥 社交：${gameState.social}</div>
					<div>❤️ 好感：${gameState.favor} 💰 金币：${gameState.gold}</div>
				</div>
			</div>`;

			if (achievements.length > 0) {
				html += `
					<div class="achievements-container" 
						 style="margin: 15px 0; background: ${gameState.isReversed ? 'rgba(93, 44, 111, 0.3)' : 'rgba(253, 203, 110, 0.1)'}; 
								border-radius: 12px; 
								padding: 12px;
								border: 1px solid ${gameState.isReversed ? '#8e44ad' : '#fdcb6e'};">
						<div style="font-weight: 600; 
								   margin-bottom: 8px; 
								   color: ${gameState.isReversed ? '#d7bde2' : '#d68910'};">
							<i class="fas fa-trophy"></i> 达成成就 (${achievements.length})
						</div>
						<div style="display: flex; flex-wrap: wrap; gap: 6px;">
							${achievements.map(a => `
								<span class="achievement-item" onclick="showSingleAchievementRequirement('${a}')">
									${a}
								</span>
							`).join('')}
						</div>
					</div>`;
			}

			if (locked.length > 0) {
				html += `
					<div style="background: var(--light-bg); border-radius: 12px; padding: 12px; margin-bottom: 10px;">
						<div style="font-weight: 600; margin-bottom: 8px; color: var(--text-secondary); font-size: 0.85rem; display: flex; align-items: center; justify-content: space-between;">
							<span><i class="fas fa-lock"></i> 未解锁成就</span>
							<span style="font-size: 0.7rem; cursor: pointer;" onclick="showAchievementRequirements()">
								<i class="fas fa-question-circle"></i> 查看要求
							</span>
						</div>
						<div style="display: flex; flex-wrap: wrap; gap: 6px;">
							${locked.map(a => `
								<span class="locked-achievement-tag" onclick="showSingleAchievementRequirement('${a}')">
									${a}
								</span>
							`).join('')}
						</div>
					</div>`;
			}

			html += `<div style="background:linear-gradient(135deg,rgba(108,92,231,0.1),rgba(162,155,254,0.1));border-radius:12px;padding:12px;margin-bottom:10px;cursor:pointer;" onclick="showEndingStatistics()">
				<div style="font-weight:600;margin-bottom:8px;color:var(--primary-color);font-size:0.85rem;display:flex;align-items:center;justify-content:space-between;">
					<span><i class="fas fa-globe"></i> 全球统计</span>
					<span style="font-size:0.7rem;color:var(--text-secondary);">
						<i class="fas fa-chevron-right"></i> 点击查看详情
					</span>
				</div>
				<div style="font-size:0.8rem;color:var(--text-secondary);">
					查看所有结局和成就的全球达成统计
				</div>
			</div>`;

			// ★★★ 修改：底部不再传入按钮，改为空数组 ★★★
			showModal('🎮 游戏结束', html, []);
		}
        
		function showSingleAchievementRequirement(name) {
			const req = ACHIEVEMENT_REQUIREMENTS[name];
			if (!req) return;
			
			// ✅ 修复：正确判断成就是否达成
			const currentAchievements = currentEndingData 
				? collectAchievements(currentEndingData.endingType) 
				: [];
			const achieved = currentAchievements.includes(name);
            
            showModal('🏆 成就要求', `
                <div style="text-align:center;margin-bottom:15px;">
                    <div style="font-size:2rem;margin-bottom:10px;">${name.split(' ')[0]}</div>
                    <div style="font-size:1.1rem;font-weight:600;">${name}</div>
                    ${achieved ? '<div style="color:var(--success-color);margin-top:5px;">✓ 已达成</div>' : ''}
                </div>
                <div style="background:var(--light-bg);border-radius:10px;padding:15px;">
                    <div style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:5px;">达成条件：</div>
                    <div style="font-size:0.9rem;">${req}</div>
                </div>
            `, [{ 
                text: currentEndingData ? '返回结局' : '关闭', 
                class: 'btn-primary', 
                action: () => {
                    closeModal();
                    if (currentEndingData) {
                        setTimeout(() => {
                            showEndingModal(currentEndingData.title, currentEndingData.desc, currentEndingData.emoji, currentEndingData.endingType);
                        }, 100);
                    }
                }
            }]);
        }

        async function showEndingStatistics() {
            showModal('📊 全球统计', '<div style="text-align:center;padding:20px;"><i class="fas fa-spinner fa-spin"></i> 加载中...</div>', []);
            
            const stats = await getGlobalStats();
            
            if (!stats) {
                showModal('📊 全球统计', '<p style="text-align:center;color:var(--text-secondary);">暂无统计数据</p>', 
                    [{ 
                        text: currentEndingData ? '返回结局' : '关闭', 
                        class: 'btn-primary', 
                        action: () => {
                            closeModal();
                            if (currentEndingData) {
                                setTimeout(() => {
                                    showEndingModal(currentEndingData.title, currentEndingData.desc, currentEndingData.emoji, currentEndingData.endingType);
                                }, 100);
                            }
                        }
                    }]);
                return;
            }
            
            const mode = gameState.isReversed ? 'reversed' : 'normal';
            const modeStats = stats[mode];
            const modeIcon = gameState.isReversed ? '🌑' : '☀️';
            const modeName = gameState.isReversed ? '逆位' : '正位';
            
            let totalEndings = 0;
            for (const count of Object.values(modeStats.endings)) {
                totalEndings += count;
            }
            
            let html = `
                <div style="margin-bottom:15px;text-align:center;">
                    <span style="font-size:0.9rem;color:var(--primary-color);font-weight:600;">${modeIcon} ${modeName}模式统计</span>
                    <span style="font-size:0.75rem;color:var(--text-secondary);margin-left:10px;">共 ${totalEndings} 局游戏</span>
                </div>
                
                <div style="margin-bottom:15px;">
                    <div style="font-weight:600;font-size:0.85rem;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
                        <span>📜 结局统计</span>
                        <span style="font-size:0.7rem;color:var(--text-secondary);cursor:pointer;" onclick="showEndingRequirements()">
                            <i class="fas fa-question-circle"></i> 查看要求
                        </span>
                    </div>
                    <div style="display:flex;flex-direction:column;gap:6px;max-height:180px;overflow-y:auto;">
            `;
            
            for (const [type, name] of Object.entries(ENDING_NAMES)) {
                const count = modeStats.endings[type] || 0;
                const percent = totalEndings > 0 ? ((count / totalEndings) * 100).toFixed(1) : 0;
                const barWidth = totalEndings > 0 ? (count / totalEndings) * 100 : 0;
                
                html += `
                    <div style="padding:6px 8px;background:var(--light-bg);border-radius:6px;cursor:pointer;" onclick="showSingleEndingRequirement('${type}')">
                        <div style="display:flex;justify-content:space-between;font-size:0.8rem;margin-bottom:3px;">
                            <span>${name}</span>
                            <span style="color:var(--primary-color);font-weight:600;">${count} <span style="color:var(--text-secondary);font-weight:400;">(${percent}%)</span></span>
                        </div>
                        <div style="height:4px;background:var(--border-color);border-radius:2px;overflow:hidden;">
                            <div style="width:${barWidth}%;height:100%;background:var(--primary-color);border-radius:2px;"></div>
                        </div>
                    </div>
                `;
            }
            
            html += `</div></div>
                
                <div>
                    <div style="font-weight:600;font-size:0.85rem;margin-bottom:8px;">🏆 成就统计</div>
                    <div style="display:flex;flex-wrap:wrap;gap:6px;max-height:120px;overflow-y:auto;">
            `;
            
            for (const ach of ALL_ACHIEVEMENTS) {
                const count = modeStats.achievements[ach] || 0;
                const opacity = count > 0 ? '1' : '0.5';
                html += `
                    <div style="padding:4px 8px;background:var(--light-bg);border-radius:6px;font-size:0.7rem;opacity:${opacity};cursor:pointer;" onclick="showSingleAchievementRequirement('${ach}')">
                        ${ach} <strong style="color:var(--success-color);">${count}</strong>
                    </div>
                `;
            }
            
            html += '</div></div>';
            
            showModal('📊 全球统计', html, [{ 
                text: currentEndingData ? '返回结局' : '关闭', 
                class: 'btn-primary', 
                action: () => {
                    closeModal();
                    if (currentEndingData) {
                        setTimeout(() => {
                            showEndingModal(currentEndingData.title, currentEndingData.desc, currentEndingData.emoji, currentEndingData.endingType);
                        }, 100);
                    }
                }
            }]);
        }

        function showEndingRequirements() {
            let html = '<div style="max-height:60vh;overflow-y:auto;">';
            
            for (const [type, name] of Object.entries(ENDING_NAMES)) {
                const req = ENDING_REQUIREMENTS[type] || '未知';
                html += `
                    <div style="padding:10px;background:var(--light-bg);border-radius:8px;margin-bottom:8px;">
                        <div style="font-weight:600;font-size:0.85rem;margin-bottom:4px;">${name}</div>
                        <div style="font-size:0.75rem;color:var(--text-secondary);">${req}</div>
                    </div>
                `;
            }
            html += '</div>';
            
            showModal('📜 结局达成要求', html, [{ 
                text: currentEndingData ? '返回结局' : '关闭', 
                class: 'btn-primary', 
                action: () => {
                    closeModal();
                    if (currentEndingData) {
                        setTimeout(() => {
                            showEndingModal(currentEndingData.title, currentEndingData.desc, currentEndingData.emoji, currentEndingData.endingType);
                        }, 100);
                    }
                }
            }]);
        }

        function showSingleEndingRequirement(type) {
            const name = ENDING_NAMES[type];
            const req = ENDING_REQUIREMENTS[type] || '未知';
            
            showModal('📜 结局要求', `
                <div style="text-align:center;margin-bottom:15px;">
                    <div style="font-size:1.1rem;font-weight:600;">${name}</div>
                </div>
                <div style="background:var(--light-bg);border-radius:10px;padding:15px;">
                    <div style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:5px;">达成条件：</div>
                    <div style="font-size:0.9rem;">${req}</div>
                </div>
            `, [{ 
                text: currentEndingData ? '返回结局' : '关闭', 
                class: 'btn-primary', 
                action: () => {
                    closeModal();
                    if (currentEndingData) {
                        setTimeout(() => {
                            showEndingModal(currentEndingData.title, currentEndingData.desc, currentEndingData.emoji, currentEndingData.endingType);
                        }, 100);
                    }
                }
            }]);
        }
		
		function showAchievementRequirements() {
			let html = '<div style="max-height:60vh;overflow-y:auto;">';
			
			// ✅ 修复：使用当前结局数据判断成就
			const currentAchievements = currentEndingData 
				? collectAchievements(currentEndingData.endingType) 
				: [];
			
			for (const [name, req] of Object.entries(ACHIEVEMENT_REQUIREMENTS)) {
				const achieved = currentAchievements.includes(name);
				html += `
					<div style="padding:10px;background:var(--light-bg);border-radius:8px;margin-bottom:8px;${achieved ? 'border-left:3px solid var(--success-color);' : ''}">
						<div style="font-weight:600;font-size:0.85rem;margin-bottom:4px;">
							${name} ${achieved ? '<span style="color:var(--success-color);">✓</span>' : ''}
						</div>
						<div style="font-size:0.75rem;color:var(--text-secondary);">${req}</div>
					</div>
				`;
			}
			html += '</div>';
			
			showModal('🏆 成就达成要求', html, [{ 
				text: currentEndingData ? '返回结局' : '关闭', 
				class: 'btn-primary', 
				action: () => {
					closeModal();
					if (currentEndingData) {
						setTimeout(() => {
							showEndingModal(currentEndingData.title, currentEndingData.desc, 
										   currentEndingData.emoji, currentEndingData.endingType);
						}, 100);
					}
				}
			}]);
		}
        // ==================== 重开确认 ====================
        function confirmRestart() {
            if (gameState.totalMonths > 0) {
                showModal('⚠️ 确认重开', 
                    '<p>确定要放弃当前游戏吗？</p><p style="color:var(--danger-color);font-size:0.85rem;">这将触发"主动退学"结局！</p>', 
                    [
                        { text: '继续游戏', class: 'btn-info', action: closeModal },
                        { text: '😢 主动退学', class: 'btn-danger', action: () => {
                            closeModal();
                            triggerEnding('quit');
                        }}
                    ]
                );
            } else {
                restartGame();
            }
        }

        function restartGame() {
            closeModal();
            
            currentEndingData = null;
            
            document.getElementById('mobile-quick-bar').classList.remove('game-active');
            
            selectedCharacter = null;
            document.querySelectorAll('.character-card').forEach(c => c.classList.remove('selected'));
            
            document.getElementById('start-btn').disabled = true;
            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('start-screen').classList.remove('hidden');

            const wasReversed = gameState.isReversed;
            if (wasReversed) {
                document.getElementById('normal-mode-btn').classList.remove('active');
                document.getElementById('reversed-mode-btn').classList.add('active', 'reversed-active');
            } else {
                document.body.classList.remove('reversed-theme');
                isReversedMode = false;
                document.getElementById('normal-mode-btn').classList.add('active');
                document.getElementById('reversed-mode-btn').classList.remove('active', 'reversed-active');
            }

            renderCharacterGrid();
            loadGlobalStatsDisplay();
			// ★ 返回开始页面时重新查询统计
			updateAllStatsDisplay();
        }

		// ==================== Meta进度系统 ====================
		const META_KEY = 'graduateSimulatorMeta';
		const GAME_START_DATE = '2025-12-15T00:00:00Z';

		function getLocalMeta() {
			const meta = localStorage.getItem(META_KEY);
			return meta ? JSON.parse(meta) : { normal: {}, reversed: {} };
		}

		function saveLocalMeta(meta) {
			localStorage.setItem(META_KEY, JSON.stringify(meta));
		}

		function getCharacterLocalRecord(characterId, isReversed) {
			const meta = getLocalMeta();
			const mode = isReversed ? 'reversed' : 'normal';
			return meta[mode]?.[characterId] || { maxScore: 0, maxCitations: 0, maxAchievements: 0 };
		}

		function updateLocalMeta(character, isReversed, score, citations, achievementCount, endingType) {
			// ★★★ 新增：只有好结局才统计 ★★★
			const goodEndings = ['master', 'excellent_master', 'phd', 'excellent_phd', 'green_pepper', 'become_advisor', 'academic_star', 'future_academician', 'true_phd', 'true_devotion', 'true_life'];
			if (!goodEndings.includes(endingType)) {
				console.log('非毕业结局，不更新本地最高记录');
				return null;
			}
			
			const meta = getLocalMeta();
			const mode = isReversed ? 'reversed' : 'normal';
			
			if (!meta[mode]) meta[mode] = {};
			if (!meta[mode][character]) {
				meta[mode][character] = { maxScore: 0, maxCitations: 0, maxAchievements: 0 };
			}
			
			const record = meta[mode][character];
			if (score > record.maxScore) record.maxScore = score;
			if (citations > record.maxCitations) record.maxCitations = citations;
			if (achievementCount > record.maxAchievements) record.maxAchievements = achievementCount;
			
			saveLocalMeta(meta);
			return record;
		}

		// 全球角色记录缓存
		let globalCharacterRecords = null;
		let globalCharacterRecordsTime = 0;

		// ==================== 优化后：从缓存表获取角色记录 ====================
		async function getGlobalCharacterRecords() {
			// 先检查本地缓存
			const cached = getLocalCache(CACHE_KEYS.CHARACTER_RECORDS);
			if (cached) {
				console.log('使用本地缓存的角色记录');
				globalCharacterRecords = cached;
				globalCharacterRecordsTime = Date.now();
				return cached;
			}
			
			if (!supabase) return null;
			
			try {
				console.log('📊 从缓存表加载角色记录...');
				
				const { data, error } = await supabase
					.from('stats_character_records_cache')
					.select('*');
				
				if (error) throw error;
				
				// 初始化数据结构
				const records = { normal: {}, reversed: {} };
				
				// 初始化所有角色
				const allCharIds = ['normal', 'genius', 'social', 'rich', 'teacher-child', 'chosen', 'true-normal'];
				allCharIds.forEach(charId => {
					records.normal[charId] = {
						today: { maxScore: 0, maxCitations: 0, maxAchievements: 0 },
						history: { maxScore: 0, maxCitations: 0, maxAchievements: 0 }
					};
					// 真·大多数只有正位
					if (charId !== 'true-normal') {
						records.reversed[charId] = {
							today: { maxScore: 0, maxCitations: 0, maxAchievements: 0 },
							history: { maxScore: 0, maxCitations: 0, maxAchievements: 0 }
						};
					}
				});
				
				// 填充缓存数据
				(data || []).forEach(row => {
					const mode = row.is_reversed ? 'reversed' : 'normal';
					const charId = row.character_id;
					const recordType = row.record_type; // 'today' or 'history'
					
					if (records[mode] && records[mode][charId] && records[mode][charId][recordType]) {
						records[mode][charId][recordType] = {
							maxScore: row.max_score || 0,
							maxCitations: row.max_citations || 0,
							maxAchievements: row.max_achievements || 0
						};
					}
				});
				
				// 更新缓存
				globalCharacterRecords = records;
				globalCharacterRecordsTime = Date.now();
				setLocalCache(CACHE_KEYS.CHARACTER_RECORDS, records);
				
				console.log('✅ 角色记录加载完成');
				return records;
				
			} catch (e) {
				console.error('获取角色记录失败:', e);
				return globalCharacterRecords || null;
			}
		}



        // ==================== 存档系统 ====================
        const SAVE_KEY = 'graduateSimulatorSaves';
        const MAX_SAVES = 5;

        function getSaves() {
            const saves = localStorage.getItem(SAVE_KEY);
            return saves ? JSON.parse(saves) : [];
        }
		
		// 检查存档是否在有效时间范围内（北京时间2025年12月13日8点之后）
		function isValidSaveTime(saveTime) {
			if (!saveTime) return false;
			
			// 截止时间：北京时间 2025-12-13 08:00
			const cutoffTimeStr = '2025-12-15 08:00';
			
			// 直接字符串比较（存档时间格式: "YYYY-MM-DD HH:mm"）
			return saveTime >= cutoffTimeStr;
		}

		// 获取有效存档（过滤旧存档）
		function getValidSaves() {
			const saves = getSaves();
			return saves.map(save => {
				if (save && !isValidSaveTime(save.saveTime)) {
					return null; // 旧存档视为空
				}
				return save;
			});
		}
		

        function saveSaves(saves) {
            localStorage.setItem(SAVE_KEY, JSON.stringify(saves));
        }

		function openSaveModal() {
			const saves = getSaves();
			let html = '<div style="margin-bottom:15px;color:var(--text-secondary);font-size:0.85rem;">选择存档槽位（最多5个）：</div>';
			
			for (let i = 0; i < MAX_SAVES; i++) {
				const save = saves[i];
				const isOldSave = save && !isValidSaveTime(save.saveTime);
				
				if (save && !isOldSave) {
					// 有效存档
					const modeIcon = save.isReversed ? '🌑' : '☀️';
					html += `
						<div style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--light-bg);border-radius:8px;margin-bottom:8px;">
							<div style="flex:1;">
								<div style="font-weight:600;font-size:0.9rem;">${modeIcon} 槽位 ${i + 1}: ${save.characterName}</div>
								<div style="font-size:0.75rem;color:var(--text-secondary);">
									${save.degree === 'master' ? '硕士' : '博士'} | 第${save.year}年第${save.month}月 | 科研分:${save.totalScore}
								</div>
								<div style="font-size:0.7rem;color:var(--text-secondary);">
									保存于: ${save.saveTime}
								</div>
							</div>
							<button class="btn btn-primary" style="padding:5px 12px;font-size:0.75rem;" onclick="saveGame(${i})">
								<i class="fas fa-save"></i> 覆盖
							</button>
						</div>`;
				} else {
					// 空槽位或旧存档（显示为可新建）
					const oldSaveHint = isOldSave ? '<div style="font-size:0.65rem;color:var(--danger-color);">旧版存档已失效</div>' : '';
					html += `
						<div style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--light-bg);border-radius:8px;margin-bottom:8px;opacity:0.7;">
							<div style="flex:1;">
								<div style="font-weight:600;font-size:0.9rem;">槽位 ${i + 1}: 空</div>
								<div style="font-size:0.75rem;color:var(--text-secondary);">暂无存档</div>
								${oldSaveHint}
							</div>
							<button class="btn btn-success" style="padding:5px 12px;font-size:0.75rem;" onclick="saveGame(${i})">
								<i class="fas fa-plus"></i> 新建
							</button>
						</div>`;
				}
			}
			
			showModal('💾 存档', html, [{ text: '取消', class: 'btn-info', action: closeModal }]);
		}

		function openLoadModal() {
			const saves = getValidSaves(); // 使用过滤后的存档
			
			if (saves.filter(s => s).length === 0) {
				showModal('📂 读档', '<p style="text-align:center;color:var(--text-secondary);">暂无有效存档</p><p style="text-align:center;font-size:0.8rem;color:var(--danger-color);">注：2025-12-15 08:00前的存档已失效</p>', 
					[{ text: '确定', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			let html = '<div style="margin-bottom:15px;color:var(--text-secondary);font-size:0.85rem;">选择要读取的存档：</div>';
			
			for (let i = 0; i < MAX_SAVES; i++) {
				const save = saves[i];
				if (save) {
					const modeIcon = save.isReversed ? '🌑' : '☀️';
					html += `
						<div style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--light-bg);border-radius:8px;margin-bottom:8px;">
							<div style="flex:1;">
								<div style="font-weight:600;font-size:0.9rem;">${modeIcon} 槽位 ${i + 1}: ${save.characterName}</div>
								<div style="font-size:0.75rem;color:var(--text-secondary);">
									${save.degree === 'master' ? '硕士' : '博士'} | 第${save.year}年第${save.month}月 | 科研分:${save.totalScore}
								</div>
								<div style="font-size:0.7rem;color:var(--text-secondary);">
									A类:${save.paperA} B类:${save.paperB} C类:${save.paperC} | 保存于: ${save.saveTime}
								</div>
							</div>
							<button class="btn btn-primary" style="padding:5px 12px;font-size:0.75rem;" onclick="loadGame(${i})">
								<i class="fas fa-folder-open"></i> 读取
							</button>
							<button class="btn btn-danger" style="padding:5px 12px;font-size:0.75rem;" onclick="deleteSave(${i})">
								<i class="fas fa-trash"></i>
							</button>
						</div>`;
				}
			}
			
			showModal('📂 读档', html, [{ text: '取消', class: 'btn-info', action: closeModal }]);
		}

		function openLoadModalFromStart() {
			const saves = getValidSaves(); // 使用过滤后的存档
			
			if (saves.filter(s => s).length === 0) {
				showModal('📂 读档', '<p style="text-align:center;color:var(--text-secondary);">暂无有效存档</p><p style="text-align:center;font-size:0.8rem;color:var(--danger-color);">注：2025-12-15 08:00前的存档已失效</p>', 
					[{ text: '确定', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			let html = '<div style="margin-bottom:15px;color:var(--text-secondary);font-size:0.85rem;">选择要读取的存档：</div>';
			
			for (let i = 0; i < MAX_SAVES; i++) {
				const save = saves[i];
				if (save) {
					const modeIcon = save.isReversed ? '🌑' : '☀️';
					html += `
						<div style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--light-bg);border-radius:8px;margin-bottom:8px;">
							<div style="flex:1;">
								<div style="font-weight:600;font-size:0.9rem;">${modeIcon} 槽位 ${i + 1}: ${save.characterName}</div>
								<div style="font-size:0.75rem;color:var(--text-secondary);">
									${save.degree === 'master' ? '硕士' : '博士'} | 第${save.year}年第${save.month}月 | 科研分:${save.totalScore}
								</div>
								<div style="font-size:0.7rem;color:var(--text-secondary);">
									A类:${save.paperA} B类:${save.paperB} C类:${save.paperC} | 保存于: ${save.saveTime}
								</div>
							</div>
							<button class="btn btn-primary" style="padding:5px 12px;font-size:0.75rem;" onclick="loadGame(${i})">
								<i class="fas fa-folder-open"></i> 读取
							</button>
						</div>`;
				}
			}
			
			showModal('📂 读档', html, [{ text: '取消', class: 'btn-info', action: closeModal }]);
		}

        function saveGame(slot) {
            const saves = getSaves();
            const now = new Date();
            const timeStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            
            const shopState = shopItems.map(item => ({
                id: item.id,
                bought: item.bought || false,
                boughtThisMonth: item.boughtThisMonth || false
            }));
            
            const papersCopy = gameState.papers.map(paper => {
                if (paper === null) return null;
                return {
                    title: paper.title,
                    ideaScore: paper.ideaScore,
                    expScore: paper.expScore,
                    writeScore: paper.writeScore,
                    reviewing: paper.reviewing || false,
                    reviewMonths: paper.reviewing ? Math.min(4, Math.max(0, paper.reviewMonths)) : 0,
                    submittedGrade: paper.submittedGrade || null,
                    submittedScore: paper.submittedScore || 0,
					submittedMonth: paper.submittedMonth || null,
					conferenceInfo: paper.conferenceInfo || null,
					conferenceLocation: paper.conferenceLocation || null,
					submittedIdeaScore: paper.submittedIdeaScore || null,
					submittedExpScore: paper.submittedExpScore || null,
					submittedWriteScore: paper.submittedWriteScore || null,
                };
            });
            
            const publishedPapersCopy = gameState.publishedPapers.map(paper => ({
                title: paper.title,
                grade: paper.grade,
                acceptType: paper.acceptType,
                score: paper.score,
                citations: paper.citations,
                monthsSincePublish: paper.monthsSincePublish || 0,
                promotions: paper.promotions ? { ...paper.promotions } : { arxiv: false, github: false, xiaohongshu: false, quantumbit: false },
                citationMultiplier: paper.citationMultiplier || 1,
				conferenceInfo: paper.conferenceInfo || null,
				conferenceLocation: paper.conferenceLocation || null,
				pendingCitationFraction: paper.pendingCitationFraction || 0
            }));
            
            const buffsCopy = {
                permanent: gameState.buffs.permanent.map(b => ({ ...b })),
                temporary: gameState.buffs.temporary.map(b => ({ ...b }))
            };
            
            const saveData = {
                character: gameState.character,
                characterName: gameState.characterName,
                degree: gameState.degree,
                year: gameState.year,
                month: gameState.month,
                totalMonths: gameState.totalMonths,
                maxYears: gameState.maxYears,
                san: gameState.san,
                sanMax: gameState.sanMax,
                research: gameState.research,
                social: gameState.social,
                favor: gameState.favor,
                gold: gameState.gold,
                
                paperA: gameState.paperA,
                paperB: gameState.paperB,
                paperC: gameState.paperC,
                totalScore: gameState.totalScore,
                totalCitations: gameState.totalCitations,
                publishedPapers: publishedPapersCopy,
                paperSlots: gameState.paperSlots,
                papers: papersCopy,
                
                buffs: buffsCopy,
                
                actionUsed: gameState.actionUsed,
                readCount: gameState.readCount,
				workCount: gameState.workCount || 0,
                firstPaperAccepted: gameState.firstPaperAccepted,
                firstAPaperAccepted: gameState.firstAPaperAccepted,
                hasLover: gameState.hasLover,
                loverType: gameState.loverType,
                bigBullCooperation: gameState.bigBullCooperation,
                rejectedCount: gameState.rejectedCount,
                teaBreakCount: gameState.teaBreakCount,
                tourCount: gameState.tourCount,
                metBigBull: gameState.metBigBull,
                metBeautiful: gameState.metBeautiful,
                metSmart: gameState.metSmart,
                bigBullDeepCount: gameState.bigBullDeepCount,
                beautifulCount: gameState.beautifulCount,
                smartCount: gameState.smartCount,
                
                availableRandomEvents: [...gameState.availableRandomEvents],
                usedRandomEvents: [...gameState.usedRandomEvents],
                triggeredBuffTypes: [...(gameState.triggeredBuffTypes || [])],
                coffeeBoughtCount: gameState.coffeeBoughtCount || 0,
                goldSpentTotal: gameState.goldSpentTotal || 0,
                
                isReversed: gameState.isReversed,
                reversedAwakened: gameState.reversedAwakened,
                blockedResearchGains: gameState.blockedResearchGains,
                goldLocked: gameState.goldLocked,
                statsLocked: gameState.statsLocked,
                
                pendingPhDChoice: gameState.pendingPhDChoice || false,
                pendingConference: gameState.pendingConference || null,
                enterpriseCount: gameState.enterpriseCount || 0,
                ailabInternship: gameState.ailabInternship || false,
                firstBestPaperAccepted: gameState.firstBestPaperAccepted || false,
				firstABestPaperAccepted: gameState.firstABestPaperAccepted || false,
                
                // ★★★ 新增：逆位富可敌国的保存字段 ★★★
                lastResetMonth: gameState.lastResetMonth || 0,
				socialAwakened: gameState.socialAwakened || false,
				reviewerDistribution: gameState.reviewerDistribution || null,
				badmintonMonth: gameState.badmintonMonth || -1,
				ideaClickCount: gameState.ideaClickCount || 0,
				expClickCount: gameState.expClickCount || 0,
				writeClickCount: gameState.writeClickCount || 0,
				consecutiveAccepts: gameState.consecutiveAccepts || 0,
				lastIdeaScore: gameState.lastIdeaScore || 0,
				lastExpScore: gameState.lastExpScore || 0,
				lastWriteScore: gameState.lastWriteScore || 0,
				// 在 saveData 对象中添加以下字段
				hiddenAwakened: gameState.hiddenAwakened || false,
				hiddenAwakenType: gameState.hiddenAwakenType || null,
				actionLimit: gameState.actionLimit || 1,
				actionCount: gameState.actionCount || 0,
				noDecay: gameState.noDecay || false,
				hasSeniorHelpSkill: gameState.hasSeniorHelpSkill || false,
				usedSeniorHelpSkill: gameState.usedSeniorHelpSkill || false,
				hasTeacherHelpSkill: gameState.hasTeacherHelpSkill || false,
				usedTeacherHelpSkill: gameState.usedTeacherHelpSkill || false,
				monthlyWageBonus: gameState.monthlyWageBonus || 0,
				nextIdeaResearchBonus: gameState.nextIdeaResearchBonus || 0,
				nextIdeaBonusSource: gameState.nextIdeaBonusSource || null,
				isTrueNormal: gameState.isTrueNormal || false,
				researchMax: gameState.researchMax || 20,
				socialMax: gameState.socialMax || 20,
				favorMax: gameState.favorMax || 20,
				achievementCoins: gameState.achievementCoins || 0,
				achievementShopState: achievementShopItems.map(item => ({
					id: item.id,
					bought: item.bought || false
				})),
                
                rejectedPapers: {...(gameState.rejectedPapers || {})},
                maxConcurrentReviews: gameState.maxConcurrentReviews || 0,
                phdOpportunitiesRejected: gameState.phdOpportunitiesRejected || 0,
                gpuServersBought: gameState.gpuServersBought || 0,
                furnitureBought: {...(gameState.furnitureBought || {})},
                achievementConditions: {...(gameState.achievementConditions || {})},
                paperTypeCollection: gameState.paperTypeCollection ? [...gameState.paperTypeCollection] : [],
                
                // ★★★ 新增：投稿统计相关 ★★★
                submissionStats: gameState.submissionStats,
                pendingConferenceInfo: gameState.pendingConferenceInfo,                
                shopState: shopState,
                saveTime: timeStr
            };
            
            saves[slot] = saveData;
            saveSaves(saves);
            closeModal();
            
            showModal('✅ 存档成功', `<p style="text-align:center;">游戏已保存到槽位 ${slot + 1}</p>`, 
                [{ text: '确定', class: 'btn-primary', action: closeModal }]);
            
            addLog('系统', '游戏已存档', `槽位 ${slot + 1}`);
        }

        function loadGame(slot) {
            const saves = getSaves();
            const save = saves[slot];
            
            if (!save) {
                showModal('❌ 读档失败', '<p>该存档不存在！</p>', 
                    [{ text: '确定', class: 'btn-primary', action: closeModal }]);
                return;
            }
            
            showModal('⚠️ 确认读档', 
                `<p>确定要读取槽位 ${slot + 1} 的存档吗？</p><p style="color:var(--danger-color);font-size:0.85rem;">当前游戏进度将丢失！</p>`, 
                [
                    { text: '取消', class: 'btn-info', action: closeModal },
                    { text: '确定读取', class: 'btn-primary', action: () => {
                        if (save.shopState) {
                            save.shopState.forEach(savedItem => {
                                const item = shopItems.find(i => i.id === savedItem.id);
                                if (item) {
                                    item.bought = savedItem.bought;
                                    item.boughtThisMonth = savedItem.boughtThisMonth;
                                }
                            });
                        }
                        
                        gameState = {
                            character: save.character,
                            characterName: save.characterName,
                            degree: save.degree,
                            year: save.year,
                            month: save.month,
                            totalMonths: save.totalMonths,
                            maxYears: save.maxYears,
                            san: save.san,
                            sanMax: save.sanMax,
                            research: save.research,
                            social: save.social,
                            favor: save.favor,
                            gold: save.gold,
                            
                            paperA: save.paperA,
                            paperB: save.paperB,
                            paperC: save.paperC,
                            totalScore: save.totalScore,
                            totalCitations: save.totalCitations,
							publishedPapers: save.publishedPapers.map(p => ({ 
								...p, 
								promotions: p.promotions ? { ...p.promotions } : { arxiv: false, github: false, xiaohongshu: false, quantumbit: false },
								citationMultiplier: p.citationMultiplier || 1,
								monthsSincePublish: p.monthsSincePublish || 0,
								// ★★★ 新增字段 ★★★
								pendingCitationFraction: p.pendingCitationFraction || 0,
								conferenceInfo: p.conferenceInfo || null,
								conferenceLocation: p.conferenceLocation || null
							})),
                            paperSlots: save.paperSlots,
                            
							papers: save.papers.map(p => {
								if (p === null) return null;
								return {
									title: p.title,
									ideaScore: p.ideaScore,
									expScore: p.expScore,
									writeScore: p.writeScore,
									reviewing: p.reviewing || false,
									reviewMonths: p.reviewing ? Math.min(4, Math.max(0, p.reviewMonths || 0)) : 0,
									submittedGrade: p.submittedGrade || null,
									submittedScore: p.submittedScore || 0,
									// ★★★ 新增字段 ★★★
									submittedMonth: p.submittedMonth || null,
									conferenceInfo: p.conferenceInfo || null,
									conferenceLocation: p.conferenceLocation || null
								};
							}),
                            
                            buffs: {
                                permanent: save.buffs.permanent.map(b => ({ ...b })),
                                temporary: save.buffs.temporary.map(b => ({ ...b }))
                            },
                            
                            actionUsed: save.actionUsed,
                            readCount: save.readCount,
							workCount: save.workCount || 0,
                            firstPaperAccepted: save.firstPaperAccepted,
                            firstAPaperAccepted: save.firstAPaperAccepted,
                            hasLover: save.hasLover,
                            loverType: save.loverType,
                            bigBullCooperation: save.bigBullCooperation,
                            rejectedCount: save.rejectedCount,
                            teaBreakCount: save.teaBreakCount,
                            tourCount: save.tourCount,
                            metBigBull: save.metBigBull,
                            metBeautiful: save.metBeautiful,
                            metSmart: save.metSmart,
                            bigBullDeepCount: save.bigBullDeepCount,
                            beautifulCount: save.beautifulCount,
                            smartCount: save.smartCount,
                            enterpriseCount: save.enterpriseCount || 0,
                            ailabInternship: save.ailabInternship || false,
                            firstBestPaperAccepted: save.firstBestPaperAccepted || false,
							firstABestPaperAccepted: save.firstABestPaperAccepted || false,
                            goldSpentTotal: save.goldSpentTotal || 0,
                            
                            availableRandomEvents: save.availableRandomEvents ? [...save.availableRandomEvents] : [],
                            usedRandomEvents: save.usedRandomEvents ? [...save.usedRandomEvents] : [],
                            triggeredBuffTypes: save.triggeredBuffTypes ? [...save.triggeredBuffTypes] : [],
                            coffeeBoughtCount: save.coffeeBoughtCount || 0,
                            
                            pendingPhDChoice: save.pendingPhDChoice || false,
                            pendingConference: save.pendingConference || null,
                            
                            isReversed: save.isReversed || false,
                            reversedAwakened: save.reversedAwakened || false,
                            blockedResearchGains: save.blockedResearchGains || 0,
                            
                            
                            // ★★★ 新增：逆位富可敌国的读档字段 ★★★
                            lastResetMonth: save.lastResetMonth || 0,
							socialAwakened: save.socialAwakened || false,
							reviewerDistribution: save.reviewerDistribution || null,
							badmintonMonth: save.badmintonMonth || -1,
							ideaClickCount: save.ideaClickCount || 0,
							expClickCount: save.expClickCount || 0,
							writeClickCount: save.writeClickCount || 0,
							consecutiveAccepts: save.consecutiveAccepts || 0,
							// 在 gameState 赋值中添加以下字段
							hiddenAwakened: save.hiddenAwakened || false,
							hiddenAwakenType: save.hiddenAwakenType || null,
							actionLimit: save.actionLimit || 1,
							actionCount: save.actionCount || 0,
							noDecay: save.noDecay || false,
							hasSeniorHelpSkill: save.hasSeniorHelpSkill || false,
							usedSeniorHelpSkill: save.usedSeniorHelpSkill || false,
							hasTeacherHelpSkill: save.hasTeacherHelpSkill || false,
							usedTeacherHelpSkill: save.usedTeacherHelpSkill || false,
							monthlyWageBonus: save.monthlyWageBonus || 0,
							nextIdeaResearchBonus: save.nextIdeaResearchBonus || 0,
							nextIdeaBonusSource: save.nextIdeaBonusSource || null,
							isTrueNormal: save.isTrueNormal || false,
							researchMax: save.researchMax || 20,
							socialMax: save.socialMax || 20,
							favorMax: save.favorMax || 20,
                            
                            rejectedPapers: save.rejectedPapers ? {...save.rejectedPapers} : {},
                            furnitureBought: save.furnitureBought ? {...save.furnitureBought} : {
                                chair: false,
                                monitor: false,
                                keyboard: false
                            },
                            achievementConditions: save.achievementConditions ? {...save.achievementConditions} : {
                                highScorePaper: false,
                                unanimousImprovement: false,
                                allBadReviewers: false,
                                tripleRejected: false,
                                bought5GPUs: false,
                                fullFurnitureSet: false,
                                phdRequirementMetEarly: false,
                                rejectedPhdTwice: false
                            },
                            maxConcurrentReviews: save.maxConcurrentReviews || 0,
                            phdOpportunitiesRejected: save.phdOpportunitiesRejected || 0,
                            gpuServersBought: save.gpuServersBought || 0,
                            paperTypeCollection: new Set(save.paperTypeCollection || []),
                            // ★★★ 新增：投稿统计相关 ★★★
                            submissionStats: save.submissionStats || null,
                            pendingConferenceInfo: save.pendingConferenceInfo || null
                        };
                        
                        if (!gameState.availableRandomEvents || gameState.availableRandomEvents.length === 0) {
                            if (!gameState.usedRandomEvents || gameState.usedRandomEvents.length === 0) {
                                resetRandomEventPool();
                            }
                        }
                        
                        if (gameState.isReversed) {
                            document.body.classList.add('reversed-theme');
                            isReversedMode = true;
                        } else {
                            document.body.classList.remove('reversed-theme');
                            isReversedMode = false;
                        }
						
						if (save.achievementShopState) {
							save.achievementShopState.forEach(savedItem => {
								const item = achievementShopItems.find(i => i.id === savedItem.id);
								if (item) {
									item.bought = savedItem.bought;
								}
							});
						}
						gameState.achievementCoins = save.achievementCoins || 0;				

                        
                        document.getElementById('start-screen').classList.add('hidden');
                        document.getElementById('game-screen').style.display = 'block';
                        document.getElementById('mobile-quick-bar').classList.add('game-active');
                        
                        updateAllUI();
                        renderPaperSlots();
                        
                        closeModal();
                        addLog('系统', '读取存档成功', `槽位 ${slot + 1}`);
                        
                        let pendingReviews = [];
                        gameState.papers.forEach((paper, idx) => {
                            if (paper && paper.reviewing && paper.reviewMonths <= 0) {
                                pendingReviews.push(idx);
                            }
                        });

                        if (pendingReviews.length > 0) {
                            pendingReviews.forEach((idx, i) => {
                                setTimeout(() => {
                                    if (gameState.papers[idx] && gameState.papers[idx].reviewing) {
                                        processPaperResult(idx);
                                    }
                                }, 500 + i * 300);
                            });
                        } else {
                            let reviewingInfo = '';
                            gameState.papers.forEach((paper, idx) => {
                                if (paper && paper.reviewing) {
                                    reviewingInfo += `<br>• 槽位${idx + 1}: ${paper.submittedGrade}类审稿中，剩余${paper.reviewMonths}月`;
                                }
                            });
                            
                            const modeText = gameState.isReversed ? '（逆位模式）' : '（正位模式）';
                            showModal('✅ 读档成功', 
                                `<p style="text-align:center;">已读取槽位 ${slot + 1} 的存档 ${modeText}</p>
                                 <p style="font-size:0.85rem;color:var(--text-secondary);">
                                    当前进度：第${gameState.year}年第${gameState.month}月<br>
                                    科研分：${gameState.totalScore}
                                    ${reviewingInfo ? '<br><strong>审稿中的论文：</strong>' + reviewingInfo : ''}
                                 </p>`, 
                                [{ text: '继续游戏', class: 'btn-primary', action: closeModal }]);
                        }
                    }}
                ]
            );
        }

        function deleteSave(slot) {
            showModal('⚠️ 确认删除', 
                `<p>确定要删除槽位 ${slot + 1} 的存档吗？</p><p style="color:var(--danger-color);font-size:0.85rem;">此操作不可恢复！</p>`, 
                [
                    { text: '取消', class: 'btn-info', action: closeModal },
                    { text: '确定删除', class: 'btn-danger', action: () => {
                        const saves = getSaves();
                        saves[slot] = null;
                        saveSaves(saves);
                        closeModal();
                        openLoadModal();
                    }}
                ]
            );
        }
		
        // ==================== 弹窗系统 ====================
        let modalCallbacks = [];

        function showModal(title, content, buttons) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-content').innerHTML = content;
            modalCallbacks = buttons.map(b => b.action);
            document.getElementById('modal-buttons').innerHTML = buttons.map((b, i) =>
                `<button class="btn ${b.class}" onclick="modalCallbacks[${i}]()">${b.text}</button>`
            ).join('');
            document.getElementById('modal-overlay').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('active');
        }

        function showPaperSelectModal(action, papers, callback) {
            let html = `<p style="font-size:0.9rem;">请选择要进行"${action}"的论文：</p><div style="display:flex;flex-direction:column;gap:8px;margin-top:10px;">`;
            papers.forEach(({ paper, index }) => {
                const total = paper.ideaScore + paper.expScore + paper.writeScore;
                html += `<div style="padding:12px;background:var(--light-bg);border-radius:10px;cursor:pointer;border:2px solid transparent;transition:all 0.3s;"
                    onmouseover="this.style.borderColor='var(--primary-color)'"
                    onmouseout="this.style.borderColor='transparent'"
                    onclick="paperSelectCallback(${index})">
                    <div style="font-weight:600;margin-bottom:5px;font-size:0.85rem;">${paper.title.substring(0, 30)}${paper.title.length > 30 ? '...' : ''}</div>
                    <div style="display:flex;gap:10px;font-size:0.75rem;color:var(--text-secondary);">
                        <span>💡${paper.ideaScore}</span>
                        <span>🔬${paper.expScore}</span>
                        <span>✍️${paper.writeScore}</span>
                        <span style="color:var(--primary-color);font-weight:600;">总分:${total}</span>
                    </div>
                </div>`;
            });
            html += '</div>';
            window.paperSelectCallback = (idx) => { closeModal(); callback(idx); };
            showModal(`📝 选择论文 - ${action}`, html, [{ text: '取消', class: 'btn-info', action: closeModal }]);
        }

        // ==================== 日志系统 ====================
        function addLog(event, detail, result = '') {
            const logContent = document.getElementById('log-content');
            const dateStr = `第${gameState.year}年第${gameState.month}月`;
            const isNegative = result && (result.includes('-') || result.includes('拒稿') || result.includes('不满') || result.includes('失败') || result.includes('落选'));
            const entry = document.createElement('div');
            entry.className = `log-entry ${isNegative ? 'negative' : ''}`;
            entry.innerHTML = `<div class="date">[${dateStr}] ${event}</div><div class="event">${detail}</div>${result ? `<div class="result">→ ${result}</div>` : ''}`;
            logContent.insertBefore(entry, logContent.firstChild);
            while (logContent.children.length > 100) logContent.removeChild(logContent.lastChild);
        }

        // ==================== 工具函数 ====================
        function rand(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

        function shuffle(arr) {
            const a = [...arr];
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }

        function scrollToPanel(panelId) {
            const panel = document.getElementById(panelId);
            if (panel) {
                panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // ==================== 会议相关函数 ====================
        
        // 计算真实年份：游戏第1年第1月 = 2030年9月
        function getRealYear(gameYear, gameMonth) {
            const baseYear = 2029;
            return baseYear + gameYear + (gameMonth >= 5 ? 1 : 0);
        }

        // 获取会议信息
        function getConferenceInfo(gameMonth, grade, gameYear) {
            const conf = CONFERENCES[gameMonth][grade];
            const realYear = getRealYear(gameYear, gameMonth);
            
            // 处理ICCV/ECCV轮换
            if (conf.alternates) {
                const isOddYear = realYear % 2 === 1;
                const selected = isOddYear ? conf.alternates.odd : conf.alternates.even;
                return {
                    name: selected.name,
                    fullName: selected.fullName,
                    field: conf.field,
                    year: realYear,
					month: gameMonth,
                };
            }
            
            return {
                name: conf.name,
                fullName: conf.fullName,
                field: conf.field,
                year: realYear
            };
        }

        // 获取会议地点（基于论文标题hash，保证同一论文地点固定）
        function getConferenceLocation(paperTitle) {
            const hash = paperTitle.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            return CONFERENCE_LOCATIONS[hash % CONFERENCE_LOCATIONS.length];
        }

        // 格式化会议显示字符串
        function formatConferenceString(confInfo, location) {
            return `${confInfo.name} ${confInfo.year} @ ${location.city}, ${location.country}`;
        }

		// ==================== 投稿统计系统 ====================

		let submissionStatsCache = null;
		let submissionStatsCacheTime = 0;
		const SUBMISSION_CACHE_DURATION = 30 * 60 * 1000; // 30分钟

		// 加载投稿统计数据（从缓存表读取）
		async function loadSubmissionStats() {
			// 检查内存缓存
			if (submissionStatsCache && (Date.now() - submissionStatsCacheTime < SUBMISSION_CACHE_DURATION)) {
				console.log('使用内存缓存的投稿统计');
				return submissionStatsCache;
			}
			
			// 检查localStorage缓存
			const localCacheKey = 'graduateSimulator_submissionStats';
			const cached = getLocalCache(localCacheKey);
			if (cached) {
				console.log('使用本地缓存的投稿统计');
				submissionStatsCache = cached;
				submissionStatsCacheTime = Date.now();
				return cached;
			}
			
			if (!supabase) {
				console.log('Supabase未初始化，使用默认统计');
				const defaultStats = getDefaultSubmissionStats();
				submissionStatsCache = defaultStats;
				submissionStatsCacheTime = Date.now();
				return defaultStats;
			}
			
			try {
				console.log('📊 从缓存表加载投稿统计...');
				
				const { data, error } = await supabase
					.from('stats_submissions_cache')
					.select('*');
				
				if (error) throw error;
				
				if (!data || data.length === 0) {
					console.log('缓存表为空，使用默认统计');
					return getDefaultSubmissionStats();
				}
				
				// 组装统计数据
				const stats = {};
				
				data.forEach(row => {
					const key = `${row.game_month}_${row.grade}_${row.is_reversed}`;
					stats[key] = {
						submissions: row.submissions || 0,
						accepted: row.accepted || 0,
						poster: row.poster || 0,
						oral: row.oral || 0,
						bestPaper: row.best_paper || 0,
						acceptRate: row.submissions > 0 ? row.accepted / row.submissions : 0,
						avgScoreRejected: parseFloat(row.avg_score_rejected) || 0,
						avgScorePoster: parseFloat(row.avg_score_poster) || 0,
						avgScoreOral: parseFloat(row.avg_score_oral) || 0,
						avgScoreBestPaper: parseFloat(row.avg_score_best_paper) || 0,
						p90AcceptedScore: row.p90_accepted_score || 0,
						p99AcceptedScore: row.p99_accepted_score || 0
					};
				});
				
				// 填充缺失的月份/等级组合（使用默认值）
				const defaultStats = getDefaultSubmissionStats();
				for (let month = 1; month <= 12; month++) {
					for (const grade of ['A', 'B', 'C']) {
						for (const reversed of [true, false]) {
							const key = `${month}_${grade}_${reversed}`;
							if (!stats[key]) {
								stats[key] = defaultStats[key];
							}
						}
					}
				}
				
				// 更新缓存
				submissionStatsCache = stats;
				submissionStatsCacheTime = Date.now();
				setLocalCache(localCacheKey, stats);
				
				console.log('✅ 投稿统计加载完成，共', data.length, '条记录');
				return stats;
				
			} catch (e) {
				console.error('加载投稿统计失败:', e);
				return getDefaultSubmissionStats();
			}
		}

		function calcAvg(arr) {
			if (!arr || arr.length === 0) return 0;
			return arr.reduce((a, b) => a + b, 0) / arr.length;
		}



		// 获取默认统计数据
		function getDefaultSubmissionStats() {
			const stats = {};
			
			for (let month = 1; month <= 12; month++) {
				for (const grade of ['A', 'B', 'C']) {
					for (const reversed of [true, false]) {
						const key = `${month}_${grade}_${reversed}`;
						const target = TARGET_ACCEPTANCE_RATES[grade];
						
						stats[key] = {
							submissions: 100,  // ★★★ 关键修改：设为100使hasEnoughData为true ★★★
							accepted: Math.round(100 * target.target),  // ★★★ 新增：计算对应的录用数 ★★★
							poster: Math.round(100 * target.target * 0.7),
							oral: Math.round(100 * target.target * 0.25),
							bestPaper: Math.round(100 * target.target * 0.05),
							acceptRate: target.target,
							avgScoreRejected: grade === 'A' ? 40 : grade === 'B' ? 25 : 15,
							avgScorePoster: grade === 'A' ? 70 : grade === 'B' ? 45 : 30,
							avgScoreOral: grade === 'A' ? 90 : grade === 'B' ? 60 : 40,
							avgScoreBestPaper: grade === 'A' ? 105 : grade === 'B' ? 75 : 50,
							p90AcceptedScore: grade === 'A' ? 85 : grade === 'B' ? 55 : 35,
							p99AcceptedScore: grade === 'A' ? 100 : grade === 'B' ? 70 : 45
						};
					}
				}
			}
			
			return stats;
		}

        // 获取当前月份的统计
        function getMonthStats(gameMonth, grade, isReversed) {
            if (!gameState.submissionStats) {
                return getDefaultSubmissionStats()[`${gameMonth}_${grade}_${isReversed}`];
            }
            return gameState.submissionStats[`${gameMonth}_${grade}_${isReversed}`] || 
                   getDefaultSubmissionStats()[`${gameMonth}_${grade}_${isReversed}`];
        }

		// ==================== 审稿系统 V3 ====================
		// 特性：
		// 1. 会议热度基于同等级平均投稿量计算
		// 2. 累计投稿≥1000时才启用非对称调整
		// 3. 初始状态下BL录取率基于论文分数计算
		// 4. 不同审稿人类型有不同的调整敏感度

		// ==================== 常量配置 ====================

		// 目标录取率
		const TARGET_ACCEPTANCE_RATES = {
			A: { min: 0.20, max: 0.30, target: 0.25 },
			B: { min: 0.30, max: 0.45, target: 0.375 },
			C: { min: 0.40, max: 0.60, target: 0.50 }
		};

		// 基础阈值配置
		const BASE_THRESHOLDS = {
			A: {
				kind:      { reject: 40, borderline: 60 },
				normal:    { reject: 50, borderline: 80 },
				expert:    { reject: 50, borderline: 80 },
				gpt:       { reject: 40, borderline: 90 },
				hostile:   { reject: 70, borderline: 100 },
				questions: { reject: 70, borderline: 100 }
			},
			B: {
				kind:      { reject: 25, borderline: 40 },
				normal:    { reject: 30, borderline: 50 },
				expert:    { reject: 30, borderline: 50 },
				gpt:       { reject: 25, borderline: 60 },
				hostile:   { reject: 40, borderline: 60 },
				questions: { reject: 40, borderline: 60 }
			},
			C: {
				kind:      { reject: 10, borderline: 20 },
				normal:    { reject: 15, borderline: 30 },
				expert:    { reject: 15, borderline: 30 },
				gpt:       { reject: 15, borderline: 40 },
				hostile:   { reject: 20, borderline: 40 },
				questions: { reject: 20, borderline: 40 }
			}
		};

		// 审稿人分组及调整敏感度
		const REVIEWER_GROUPS = {
			kind: 'lenient',
			normal: 'standard',
			expert: 'standard',
			gpt: 'standard',
			hostile: 'strict',
			questions: 'strict'
		};

		const ADJUSTMENT_SENSITIVITY = {
			lenient: 1.2,   // 宽松型：调整幅度放大
			standard: 1.0,  // 标准型：正常调整
			strict: 0.7     // 严格型：调整幅度缩小
		};

		// Borderline基础概率配置
		const BORDERLINE_BASE_CONFIG = {
			A: { baseRate: 0.50, scoreBaseline: 65, scoreRange: 30 },
			B: { baseRate: 0.60, scoreBaseline: 45, scoreRange: 25 },
			C: { baseRate: 0.70, scoreBaseline: 28, scoreRange: 20 }
		};

		// 启用调整的最小投稿量阈值
		const MIN_SUBMISSIONS_FOR_ADJUSTMENT = 100;

		// ==================== 会议热度计算 ====================

		/**
		 * 计算会议相对热度（基于同等级所有会议的平均投稿量）
		 * @param {number} submissions - 当前会议投稿量
		 * @param {string} grade - 等级 A/B/C
		 * @param {object} submissionStats - 所有月份的统计数据
		 * @param {boolean} isReversed - 是否逆位模式
		 * @returns {object} 热度信息
		 */
		function getConferencePopularity(submissions, grade, submissionStats, isReversed) {
			// 计算同等级所有会议的平均投稿量
			let totalSubmissions = 0;
			let conferenceCount = 0;
			
			for (let month = 1; month <= 12; month++) {
				const key = `${month}_${grade}_${isReversed}`;
				const stats = submissionStats ? submissionStats[key] : null;
				if (stats && stats.submissions > 0) {
					totalSubmissions += stats.submissions;
					conferenceCount++;
				}
			}
			
			// 平均投稿量（如果没有数据则使用默认值）
			const defaultAvg = { A: 200, B: 150, C: 100 }[grade];
			const avgSubmissions = conferenceCount > 0 ? totalSubmissions / conferenceCount : defaultAvg;
			
			// 相对热度比值
			const popularityRatio = submissions / avgSubmissions;
			
			// 热度分级
			let category;
			if (popularityRatio >= 1.5) category = 'very_hot';
			else if (popularityRatio >= 1.15) category = 'hot';
			else if (popularityRatio >= 0.85) category = 'normal';
			else if (popularityRatio >= 0.5) category = 'cold';
			else category = 'very_cold';
			
			// 目标录取率调整（热门会议目标录取率略低）
			// 每偏离平均50%，目标录取率调整±3%，上限±5%
			const targetAdjustment = Math.max(-0.05, Math.min(0.05, (1 - popularityRatio) * 0.06));
			
			return {
				submissions,
				avgSubmissions: Math.round(avgSubmissions),
				ratio: popularityRatio,
				category,
				targetAdjustment
			};
		}

		/*** 获取调整后的目标录取率*/
		function getAdjustedTargetRate(grade, monthStats, submissionStats, isReversed) {
			const baseTarget = TARGET_ACCEPTANCE_RATES[grade];
			
			if (!monthStats || monthStats.submissions < 50) {
				return {
					...baseTarget,
					popularity: null,
					adjusted: false
				};
			}
			
			const popularity = getConferencePopularity(
				monthStats.submissions,
				grade,
				submissionStats,
				isReversed
			);
			
			return {
				min: Math.max(0.10, baseTarget.min + popularity.targetAdjustment),
				max: Math.min(0.70, baseTarget.max + popularity.targetAdjustment),
				target: baseTarget.target + popularity.targetAdjustment,
				popularity,
				adjusted: true
			};
		}

		// ==================== 核心：非对称调整系统 ====================

		function calculateAsymmetricAdjustment(grade, monthStats, adjustedTarget) {
			// 初始化结果：使用基础阈值，不调整
			const result = {
				thresholds: {},
				borderlineBaseRate: BORDERLINE_BASE_CONFIG[grade].baseRate,
				useScoreBasedBL: true,  // 是否使用基于分数的BL概率
				adjustmentEnabled: false,
				adjustmentDetails: {
					rejectChange: 0,
					borderlineChange: 0,
					blRateChange: 0,
					reason: ''
				}
			};
			
			// 复制基础阈值
			for (const reviewerType in BASE_THRESHOLDS[grade]) {
				result.thresholds[reviewerType] = { ...BASE_THRESHOLDS[grade][reviewerType] };
			}
			
			// ========== 检查是否启用调整 ==========
			
			// 条件：累计投稿未达到100
			if (monthStats.submissions < MIN_SUBMISSIONS_FOR_ADJUSTMENT) {
				result.adjustmentDetails.reason = 
					`累计投稿${monthStats.submissions}篇，未达到${MIN_SUBMISSIONS_FOR_ADJUSTMENT}篇调整阈值`;
				return result;
			}
			
			// ========== 启用调整 ==========
			result.adjustmentEnabled = true;
			result.useScoreBasedBL = false;  // 启用调整后，BL概率由调整系统控制
			
			const actualRate = monthStats.acceptRate;
			const targetRate = adjustedTarget.target;
			const deviation = actualRate - targetRate;
			
			// 在目标范围内不调整
			if (actualRate >= adjustedTarget.min && actualRate <= adjustedTarget.max) {
				result.adjustmentDetails.reason = 
					`录取率${(actualRate * 100).toFixed(1)}%在目标范围[${(adjustedTarget.min * 100).toFixed(0)}%-${(adjustedTarget.max * 100).toFixed(0)}%]内`;
				return result;
			}
			
			// 录取率过高：需要降低
			if (deviation > 0) {
				return adjustForHighAcceptanceRate(grade, deviation, monthStats, result);
			}
			
			// 录取率过低：需要提高
			if (deviation < 0) {
				return adjustForLowAcceptanceRate(grade, -deviation, monthStats, result);
			}
			
			return result;
		}

		/*** 录取率过高时的调整，策略：50%通过提高Reject阈值，50%通过降低BL概率*/
		function adjustForHighAcceptanceRate(grade, excess, monthStats, result) {
			const halfExcess = excess / 2;
			
			// === 估算当前Borderline区间比例 ===
			const estimatedBLRatio = estimateBorderlineRatio(grade, monthStats);
			
			// === 计算Reject阈值调整 ===
			// 经验公式：阈值提高X%，Reject比例约增加X*0.5%
			const rejectAdjustPercent = Math.min(0.30, halfExcess * 2);
			
			// === 计算Borderline阈值调整（小幅跟随，约为Reject的30%）===
			const borderlineAdjustPercent = rejectAdjustPercent * 0.3;
			
			// === 计算BL录取概率调整 ===
			const baseBLRate = BORDERLINE_BASE_CONFIG[grade].baseRate;
			const blRateReduction = estimatedBLRatio > 0 ? halfExcess / estimatedBLRatio : halfExcess;
			result.borderlineBaseRate = Math.max(0.20, baseBLRate - blRateReduction);
			
			// === 应用到各审稿人（考虑敏感度）===
			applyThresholdAdjustments(grade, result, rejectAdjustPercent, borderlineAdjustPercent, 'increase');
			
			result.adjustmentDetails = {
				rejectChange: rejectAdjustPercent,
				borderlineChange: borderlineAdjustPercent,
				blRateChange: -(baseBLRate - result.borderlineBaseRate),
				reason: `录取率过高(${(monthStats.acceptRate * 100).toFixed(1)}%→目标${(monthStats.acceptRate * 100 - excess * 100).toFixed(1)}%)：` +
						`Reject阈值+${(rejectAdjustPercent * 100).toFixed(0)}%，` +
						`BL基础概率${(result.borderlineBaseRate * 100).toFixed(0)}%`
			};
			
			return result;
		}

		/*** 录取率过低时的调整，策略：优先提高BL概率（最高100%），不够再降低Reject阈值*/
		function adjustForLowAcceptanceRate(grade, deficit, monthStats, result) {
			const estimatedBLRatio = estimateBorderlineRatio(grade, monthStats);
			const baseBLRate = BORDERLINE_BASE_CONFIG[grade].baseRate;
			
			// === 计算BL概率提升能贡献多少 ===
			const blRateRoom = 1.0 - baseBLRate;
			const maxBLContribution = estimatedBLRatio * blRateRoom;
			
			if (deficit <= maxBLContribution) {
				// BL概率提升即可满足
				const blRateIncrease = estimatedBLRatio > 0 ? deficit / estimatedBLRatio : deficit;
				result.borderlineBaseRate = Math.min(1.0, baseBLRate + blRateIncrease);
				
				result.adjustmentDetails = {
					rejectChange: 0,
					borderlineChange: 0,
					blRateChange: result.borderlineBaseRate - baseBLRate,
					reason: `录取率偏低(${(monthStats.acceptRate * 100).toFixed(1)}%)：` +
							`BL基础概率提升至${(result.borderlineBaseRate * 100).toFixed(0)}%`
				};
				
				return result;
			}
			
			// === BL已拉满，需要降低Reject阈值 ===
			result.borderlineBaseRate = 1.0;
			
			const remaining = deficit - maxBLContribution;
			
			// 降低Reject阈值，扩大Borderline区间
			const rejectAdjustPercent = Math.min(0.25, remaining * 2);
			
			// Borderline阈值小幅降低
			const borderlineAdjustPercent = rejectAdjustPercent * 0.15;
			
			// 应用调整
			applyThresholdAdjustments(grade, result, rejectAdjustPercent, borderlineAdjustPercent, 'decrease');
			
			result.adjustmentDetails = {
				rejectChange: -rejectAdjustPercent,
				borderlineChange: -borderlineAdjustPercent,
				blRateChange: 1.0 - baseBLRate,
				reason: `录取率过低(${(monthStats.acceptRate * 100).toFixed(1)}%)：` +
						`BL概率100%，Reject阈值-${(rejectAdjustPercent * 100).toFixed(0)}%`
			};
			
			return result;
		}

		/*** 应用阈值调整到各审稿人*/
		function applyThresholdAdjustments(grade, result, rejectPercent, borderlinePercent, direction) {
			const sign = direction === 'increase' ? 1 : -1;
			
			for (const reviewerType in result.thresholds) {
				const group = REVIEWER_GROUPS[reviewerType];
				const sensitivity = ADJUSTMENT_SENSITIVITY[group];
				const baseThreshold = BASE_THRESHOLDS[grade][reviewerType];
				
				// Reject阈值调整
				const rejectMultiplier = 1 + sign * rejectPercent * sensitivity;
				result.thresholds[reviewerType].reject = Math.round(
					baseThreshold.reject * Math.max(0.70, Math.min(1.35, rejectMultiplier))
				);
				
				// Borderline阈值调整
				const borderlineMultiplier = 1 + sign * borderlinePercent * sensitivity;
				result.thresholds[reviewerType].borderline = Math.round(
					baseThreshold.borderline * Math.max(0.85, Math.min(1.20, borderlineMultiplier))
				);
			}
		}

		/*** 估算Borderline区间比例*/
		function estimateBorderlineRatio(grade, monthStats) {
			// 如果有详细统计
			if (monthStats.borderlineCount !== undefined && monthStats.submissions > 0) {
				return monthStats.borderlineCount / monthStats.submissions;
			}
			
			// 基于录取率估算
			const acceptRate = monthStats.acceptRate || TARGET_ACCEPTANCE_RATES[grade].target;
			// 经验估算：Borderline区间约占 25%-35%
			return Math.min(0.40, Math.max(0.20, acceptRate * 0.8));
		}

		// ==================== Borderline录取概率计算 ====================

		function calculateFinalBorderlineRate(paperScore, grade, reviewScore, adjustment) {
			const config = BORDERLINE_BASE_CONFIG[grade];
			
			// === 基础概率 ===
			let baseProbability;
			
			if (adjustment.useScoreBasedBL) {
				// 未启用调整：完全基于论文分数计算
				baseProbability = calculateScoreBasedBLRate(paperScore, grade, reviewScore);
			} else {
				// 已启用调整：使用调整后的基础概率，再叠加分数影响
				baseProbability = adjustment.borderlineBaseRate;
				
				// 根据审稿总分微调
				if (reviewScore === 1) {
					baseProbability = Math.min(0.95, baseProbability + 0.15);
				} else if (reviewScore === -1) {
					baseProbability = Math.max(0.15, baseProbability - 0.15);
				}
			}
			
			// === 论文分数修正（始终应用）===
			const scoreModifier = calculateScoreModifier(paperScore, grade);
			
			// === 最终概率 ===
			const finalRate = baseProbability + scoreModifier;
			
			return Math.max(0.10, Math.min(0.98, finalRate));
		}

		/*** 基于分数的BL录取率（用于未启用调整时）*/
		function calculateScoreBasedBLRate(paperScore, grade, reviewScore) {
			const config = BORDERLINE_BASE_CONFIG[grade];
			
			// 基础概率根据审稿总分
			let baseProbability;
			switch (reviewScore) {
				case 1:  baseProbability = config.baseRate + 0.25; break;  // 偏正面
				case 0:  baseProbability = config.baseRate; break;          // 中立
				case -1: baseProbability = config.baseRate - 0.20; break;   // 偏负面
				default: baseProbability = config.baseRate;
			}
			
			// 分数影响（使用sigmoid平滑）
			const normalizedScore = (paperScore - config.scoreBaseline) / config.scoreRange;
			const scoreInfluence = (2 / (1 + Math.exp(-normalizedScore)) - 1) * 0.25;
			
			return Math.max(0.15, Math.min(0.90, baseProbability + scoreInfluence));
		}

		/*** 计算分数修正（用于叠加到调整后的基础概率上） */
		function calculateScoreModifier(paperScore, grade) {
			const config = BORDERLINE_BASE_CONFIG[grade];
			const normalizedScore = (paperScore - config.scoreBaseline) / config.scoreRange;
			
			// sigmoid映射，最大±12%修正
			return (2 / (1 + Math.exp(-normalizedScore)) - 1) * 0.12;
		}

		// ==================== 审稿人评审 ====================

		/*** 计算有效分数（根据审稿人权重）*/
		function calculateEffectiveScore(reviewerType, ideaScore, expScore, writeScore) {
			const scores = [
				{ type: 'idea', value: ideaScore },
				{ type: 'exp', value: expScore },
				{ type: 'write', value: writeScore }
			];
			const sortedScores = [...scores].sort((a, b) => a.value - b.value);
			const minScore = sortedScores[0].value;
			const midScore = sortedScores[1].value;
			const maxScore = sortedScores[2].value;
			
			let effectiveScore;
			let weightInfo = '';
			
			switch (reviewerType) {
				case 'expert':
					effectiveScore = ideaScore * 2 + expScore * 0.5 + writeScore * 0.5;
					weightInfo = 'idea×2, exp×0.5, write×0.5';
					break;
				case 'kind':
					effectiveScore = maxScore * 1.5 + midScore * 1.5;
					weightInfo = '最高两项×1.5';
					break;
				case 'hostile':
					effectiveScore = minScore * 1.5 + midScore * 1.5;
					weightInfo = '最低两项×1.5';
					break;
				case 'questions':
					effectiveScore = minScore * 3;
					weightInfo = '最低项×3';
					break;
				case 'normal':
				case 'gpt':
				default:
					const r1 = Math.random() * 0.6;
					const r2 = Math.random() * (0.6 - r1);
					const r3 = 0.6 - r1 - r2;
					const extras = [r1, r2, r3].sort(() => Math.random() - 0.5);
					const w1 = 0.8 + extras[0];
					const w2 = 0.8 + extras[1];
					const w3 = 0.8 + extras[2];
					effectiveScore = ideaScore * w1 + expScore * w2 + writeScore * w3;
					weightInfo = `idea×${w1.toFixed(2)}, exp×${w2.toFixed(2)}, write×${w3.toFixed(2)}`;
					break;
			}
			
			return { effectiveScore: Math.round(effectiveScore), weightInfo };
		}

		/*** 获取单个审稿人的评审结果*/
		function getReviewResultV2(reviewer, grade, paperScore, ideaScore, expScore, writeScore, adjustment) {
			// 计算有效分
			const { effectiveScore, weightInfo } = calculateEffectiveScore(
				reviewer.type, ideaScore, expScore, writeScore
			);
			
			// 获取阈值（可能已调整）
			const threshold = adjustment.thresholds[reviewer.type];
			
			// 判定结果
			let decision, reviewScore;
			if (effectiveScore < threshold.reject) {
				decision = 'Reject';
				reviewScore = -1;
			} else if (effectiveScore < threshold.borderline) {
				decision = 'Borderline';
				reviewScore = 0;
			} else {
				decision = 'Accept';
				reviewScore = 1;
			}
			
			// 生成评语
			const comment = generateReviewComment(decision, reviewer.type);
			
			// 改进建议（仅特定审稿人提供）
			let improvement = 0, improvementType = '';
			if (reviewer.type === 'normal') {
				improvement = 3;
				improvementType = Math.random() < 0.5 ? 'idea' : 'exp';
			} else if (reviewer.type === 'expert') {
				improvement = 8;
				improvementType = Math.random() < 0.5 ? 'idea' : 'exp';
			}
			
			return {
				reviewer,
				decision,
				score: reviewScore,
				effectiveScore,
				weightInfo,
				thresholds: threshold,
				comment,
				improvement,
				improvementType,
				improvement2: 0,
				improvementType2: ''
			};
		}

		/*** 生成评语*/
		function generateReviewComment(decision, type) {
			if (type === 'questions') return '我有39个问题。';
			
			const positive = ['创新性强，实验充分', '写作清晰，贡献明确', '方法新颖，结果有说服力', '工作扎实，有重要贡献'];
			const negative = ['缺乏创新', '写作不足，表达不清', '实验不足，缺少对比', '贡献有限，增量工作'];
			const neutral = ['有一定创新但实验可加强', '想法有趣但写作需改进', '工作还可以但缺少深入分析'];
			
			if (decision === 'Accept') return positive[Math.floor(Math.random() * positive.length)];
			if (decision === 'Reject') return negative[Math.floor(Math.random() * negative.length)];
			
			const all = [...positive, ...negative, ...neutral];
			return all[Math.floor(Math.random() * all.length)];
		}

		// ==================== 录取类型判定 ====================

		/*** 确定录取类型（Poster/Oral/Best Paper）*/
		function determineAcceptTypeV2(paperScore, grade, monthStats) {
			// 获取分位数阈值
			let p90, p99;
			
			if (monthStats && monthStats.p90AcceptedScore) {
				p90 = monthStats.p90AcceptedScore;
				p99 = monthStats.p99AcceptedScore;
			} else {
				// 默认值
				p90 = { A: 85, B: 55, C: 35 }[grade];
				p99 = { A: 100, B: 70, C: 45 }[grade];
			}
			
			// Best Paper判定
			if (paperScore >= p99) {
				const bpChance = Math.min(0.50, 0.10 + (paperScore - p99) * 0.05);
				if (Math.random() < bpChance) {
					return 'Best Paper';
				}
			}
			
			// Oral判定
			if (paperScore >= p90) {
				const oralChance = Math.min(0.40, 0.15 + (paperScore - p90) * 0.03);
				if (Math.random() < oralChance) {
					return 'Oral';
				}
			}
			
			return 'Poster';
		}

		// ==================== 主处理函数 ====================

		/*** 处理论文审稿结果（主函数 - 替换原processPaperResult）*/
		function processPaperResult(slot) {
			const paper = gameState.papers[slot];
			if (!paper || !paper.reviewing) return;
			
			const grade = paper.submittedGrade;
			const submittedScore = paper.submittedScore;
			const submittedMonth = paper.submittedMonth || gameState.month;
			
			// ★★★ 修改：使用投稿时的分数快照 ★★★
			const submittedIdeaScore = paper.submittedIdeaScore || paper.ideaScore;
			const submittedExpScore = paper.submittedExpScore || paper.expScore;
			const submittedWriteScore = paper.submittedWriteScore || paper.writeScore;
    
			
			// 获取统计数据
			const monthStats = getMonthStats(submittedMonth, grade, gameState.isReversed);
			
			// 计算调整后的目标录取率
			const adjustedTarget = getAdjustedTargetRate(
				grade, 
				monthStats, 
				gameState.submissionStats, 
				gameState.isReversed
			);
			
			// 计算非对称调整参数
			const adjustment = calculateAsymmetricAdjustment(grade, monthStats, adjustedTarget);
			
			// 记录审稿期间的分数变化
			const reviewMonthsPassed = 4;
			const beforeScores = {
				idea: paper.ideaScore,
				exp: paper.expScore,
				write: paper.writeScore,
				total: paper.ideaScore + paper.expScore + paper.writeScore
			};
			
			// 生成审稿人并获取评审结果
			const reviewers = [generateReviewer(), generateReviewer(), generateReviewer()];
			const results = reviewers.map(reviewer => 
				getReviewResultV2(
					reviewer, grade, submittedScore,
					submittedIdeaScore,    // ★ 改用投稿时分数
					submittedExpScore,     // ★ 改用投稿时分数
					submittedWriteScore,   // ★ 改用投稿时分数
					adjustment
				)
			);
			
			// 汇总审稿分数
			const totalReviewScore = results.reduce((sum, r) => sum + r.score, 0);
			
			// PC决策
			let accepted = false;
			let acceptType = null;
			let borderlineChance = null;
			
			if (totalReviewScore >= 1) {
				// 审稿人一致认可
				accepted = true;
			} else if (totalReviewScore === 0) {
				// Borderline：计算录取概率
				borderlineChance = calculateFinalBorderlineRate(
					submittedScore, grade, totalReviewScore, adjustment
				);
				accepted = Math.random() < borderlineChance;
			} else if (totalReviewScore === -1) {
				// 偏负面但非完全拒绝：小概率录取
				borderlineChance = calculateFinalBorderlineRate(
					submittedScore, grade, totalReviewScore, adjustment
				);
				accepted = Math.random() < borderlineChance;
			} else {
				// 完全拒绝
				accepted = false;
			}
			
			if (accepted) {
				acceptType = determineAcceptTypeV2(submittedScore, grade, monthStats);
			}
			
			// 应用分数衰减和改进
			let ideaDecay = reviewMonthsPassed;
			let expDecay = reviewMonthsPassed;
			
			if (gameState.noDecay) {
				ideaDecay = 0;
				expDecay = 0;
			} else {
				paper.ideaScore = Math.max(1, paper.ideaScore - ideaDecay);
				paper.expScore = Math.max(1, paper.expScore - expDecay);
			}
			
			// 应用审稿人改进建议
			results.forEach(r => {
				if (r.improvement > 0) {
					if (r.improvementType === 'idea') paper.ideaScore += r.improvement;
					else if (r.improvementType === 'exp') paper.expScore += r.improvement;
					else if (r.improvementType === 'write') paper.writeScore += r.improvement;
				}
			});
			
			const afterScores = {
				idea: paper.ideaScore,
				exp: paper.expScore,
				write: paper.writeScore,
				total: paper.ideaScore + paper.expScore + paper.writeScore
			};
			
			checkReviewAchievements(results, afterScores);
			

			const extraInfo = {
				adjustment,
				adjustedTarget,
				borderlineChance,
				monthStats,
				submittedMonth,
				ideaDecay,
				expDecay,
				badReviewerCount: results.filter(r => 
					r.reviewer.type === 'hostile' || r.reviewer.type === 'questions'
				).length,
				hasExpert: results.some(r => r.reviewer.type === 'expert')
			};
			
			showReviewResultModalV2(
				paper, grade, results, totalReviewScore, 
				acceptType, accepted, slot, 
				beforeScores, afterScores, extraInfo
			);
		}

		/** * 成就检测*/
		function checkReviewAchievements(results, afterScores) {
			gameState.achievementConditions = gameState.achievementConditions || {};
			
			// 高分论文
			if (afterScores.total >= 125) {
				gameState.achievementConditions.highScorePaper = true;
			}
			
			// 全部改进
			if (results.every(r => r.improvement > 0)) {
				gameState.achievementConditions.unanimousImprovement = true;
			}
			
			// 全部坏审稿人
			if (results.every(r => r.reviewer.type === 'hostile' || r.reviewer.type === 'questions')) {
				gameState.achievementConditions.allBadReviewers = true;
			}
		}

		// ==================== 审稿结果弹窗（3页分页版）====================

		// 全局变量存储当前审稿结果数据
		let currentReviewData = null;

		/*** 显示审稿结果弹窗（分页版）*/
		function showReviewResultModalV2(paper, grade, results, totalReviewScore, acceptType, accepted, slot, beforeScores, afterScores, extraInfo) {
			// 存储数据供分页使用
			currentReviewData = {
				paper, grade, results, totalReviewScore, acceptType, accepted, slot,
				beforeScores, afterScores, extraInfo
			};
			
			// 显示第一页
			showReviewResultPage(1);
		}

		/*** 渲染分页指示器 */
		function renderPageIndicator(currentPage, totalPages) {
			let dots = '';
			for (let i = 1; i <= totalPages; i++) {
				const isActive = i === currentPage;
				dots += `<span style="display:inline-block;width:10px;height:10px;background:${isActive ? 'var(--primary-color)' : 'var(--border-color)'};border-radius:50%;margin:0 3px;"></span>`;
			}
			return `<div style="text-align:center;padding:10px;color:var(--text-secondary);font-size:0.8rem;">${dots}</div>`;
		}

		/*** 渲染增强版全球统计*/
		function renderGlobalStatsEnhanced(confInfo, monthStats, grade) {
			if (!monthStats || monthStats.submissions < 20) {
				return `
				<div style="padding:12px;background:linear-gradient(135deg,rgba(116,185,255,0.1),rgba(162,155,254,0.1));border-radius:8px;margin-bottom:12px;font-size:0.8rem;border:1px solid rgba(116,185,255,0.3);">
					<div style="font-weight:600;color:var(--info-color);margin-bottom:8px;">
						<i class="fas fa-globe"></i> ${confInfo.name} 全球统计
					</div>
					<div style="text-align:center;color:var(--text-secondary);padding:10px;">
						数据不足，暂无统计信息
					</div>
				</div>`;
			}
			
			const acceptRate = ((monthStats.acceptRate || 0) * 100).toFixed(1);
			const posterRate = monthStats.submissions > 0 ? ((monthStats.poster || 0) / monthStats.submissions * 100).toFixed(1) : '0';
			const oralRate = monthStats.submissions > 0 ? ((monthStats.oral || 0) / monthStats.submissions * 100).toFixed(1) : '0';
			const bpRate = monthStats.submissions > 0 ? ((monthStats.bestPaper || 0) / monthStats.submissions * 100).toFixed(1) : '0';
			
			// 计算各档位参考分数
			const avgPoster = monthStats.avgScorePoster || (grade === 'A' ? 70 : grade === 'B' ? 45 : 30);
			const avgOral = monthStats.avgScoreOral || (grade === 'A' ? 90 : grade === 'B' ? 60 : 40);
			const avgBP = monthStats.avgScoreBestPaper || (grade === 'A' ? 105 : grade === 'B' ? 75 : 50);
			const avgRejected = monthStats.avgScoreRejected || (grade === 'A' ? 40 : grade === 'B' ? 25 : 15);
			
			// 计算中稿论文平均分
			const totalAccepted = (monthStats.poster || 0) + (monthStats.oral || 0) + (monthStats.bestPaper || 0);
			let avgAcceptedScore = '-';
			if (totalAccepted > 0 && monthStats.avgScorePoster) {
				const weightedSum = (monthStats.avgScorePoster * (monthStats.poster || 0)) + 
								  (monthStats.avgScoreOral * (monthStats.oral || 0)) + 
								  (monthStats.avgScoreBestPaper * (monthStats.bestPaper || 0));
				avgAcceptedScore = Math.round(weightedSum / totalAccepted);
			}
			
			return `
			<div style="padding:12px;background:linear-gradient(135deg,rgba(116,185,255,0.1),rgba(162,155,254,0.1));border-radius:8px;margin-bottom:12px;font-size:0.8rem;border:1px solid rgba(116,185,255,0.3);">
				<div style="font-weight:600;color:var(--info-color);margin-bottom:10px;">
					<i class="fas fa-globe"></i> ${confInfo.name} ${confInfo.year} 全球统计
				</div>
				
				<!-- 投稿概况 -->
				<div style="background:var(--card-bg);border-radius:6px;padding:10px;margin-bottom:8px;border:1px solid var(--border-color);">
					<div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:6px;">📊 投稿概况</div>
					<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;text-align:center;">
						<div>
							<div style="font-size:1.1rem;font-weight:700;color:var(--primary-color);">${monthStats.submissions}</div>
							<div style="font-size:0.65rem;color:var(--text-secondary);">总投稿</div>
						</div>
						<div>
							<div style="font-size:1.1rem;font-weight:700;color:var(--success-color);">${monthStats.accepted || 0}</div>
							<div style="font-size:0.65rem;color:var(--text-secondary);">总录用</div>
						</div>
						<div>
							<div style="font-size:1.1rem;font-weight:700;color:var(--warning-color);">${acceptRate}%</div>
							<div style="font-size:0.65rem;color:var(--text-secondary);">录用率</div>
						</div>
					</div>
				</div>
				
				<!-- 录用分布 -->
				<div style="background:var(--card-bg);border-radius:6px;padding:10px;margin-bottom:8px;border:1px solid var(--border-color);">
					<div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:6px;">🏆 录用分布</div>
					<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;text-align:center;">
						<div style="padding:6px;background:rgba(116,185,255,0.1);border-radius:4px;">
							<div style="font-size:0.9rem;font-weight:600;color:#74b9ff;">${monthStats.poster || 0}</div>
							<div style="font-size:0.6rem;color:var(--text-secondary);">Poster (${posterRate}%)</div>
						</div>
						<div style="padding:6px;background:rgba(253,203,110,0.1);border-radius:4px;">
							<div style="font-size:0.9rem;font-weight:600;color:#fdcb6e;">${monthStats.oral || 0}</div>
							<div style="font-size:0.6rem;color:var(--text-secondary);">Oral (${oralRate}%)</div>
						</div>
						<div style="padding:6px;background:rgba(253,121,168,0.1);border-radius:4px;">
							<div style="font-size:0.9rem;font-weight:600;color:#fd79a8;">${monthStats.bestPaper || 0}</div>
							<div style="font-size:0.6rem;color:var(--text-secondary);">Best (${bpRate}%)</div>
						</div>
					</div>
				</div>
				
				<!-- 分数参考 -->
				<div style="background:var(--card-bg);border-radius:6px;padding:10px;border:1px solid var(--border-color);">
					<div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:6px;">📈 分数参考（投稿时总分）</div>
					<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:6px;font-size:0.75rem;">
						<div style="display:flex;justify-content:space-between;padding:4px 8px;background:rgba(225,112,85,0.1);border-radius:4px;">
							<span>❌ 拒稿均分</span>
							<strong style="color:var(--danger-color);">${Math.round(avgRejected)}</strong>
						</div>
						<div style="display:flex;justify-content:space-between;padding:4px 8px;background:rgba(0,184,148,0.1);border-radius:4px;">
							<span>✅ 中稿均分</span>
							<strong style="color:var(--success-color);">${avgAcceptedScore}</strong>
						</div>
						<div style="display:flex;justify-content:space-between;padding:4px 8px;background:rgba(116,185,255,0.1);border-radius:4px;">
							<span>📄 Poster参考</span>
							<strong style="color:#74b9ff;">≥${Math.round(avgPoster)}</strong>
						</div>
						<div style="display:flex;justify-content:space-between;padding:4px 8px;background:rgba(253,203,110,0.1);border-radius:4px;">
							<span>🎤 Oral参考</span>
							<strong style="color:#d68910;">≥${Math.round(avgOral)}</strong>
						</div>
						<div style="display:flex;justify-content:space-between;padding:4px 8px;background:rgba(253,121,168,0.1);border-radius:4px;grid-column:span 2;">
							<span>🏆 Best Paper参考</span>
							<strong style="color:#fd79a8;">≥${Math.round(avgBP)}</strong>
						</div>
					</div>
					<div style="margin-top:6px;font-size:0.65rem;color:var(--text-secondary);text-align:center;">
						P90阈值: ${monthStats.p90AcceptedScore || '-'} | P99阈值: ${monthStats.p99AcceptedScore || '-'}
					</div>
				</div>
			</div>`;
		}

		/*** 显示审稿结果指定页*/
		function showReviewResultPage(pageNum) {
			const { paper, grade, results, totalReviewScore, acceptType, accepted, slot, beforeScores, afterScores, extraInfo } = currentReviewData;
			const { adjustment, adjustedTarget, borderlineChance, monthStats, ideaDecay, expDecay } = extraInfo;
			
			// 获取会议信息
			const confInfo = paper.conferenceInfo || getConferenceInfo(extraInfo.submittedMonth || gameState.month, grade, gameState.year);
			
			let html = '';
			let pageTitle = '';
			const totalPages = 3;
			
			if (pageNum === 1) {
				// ==================== 第一页：会议信息 + 全球统计 ====================
				pageTitle = '📝 审稿结果 (1/3)';
				
				// 会议和论文信息
				html += `<div style="padding:12px;background:linear-gradient(135deg,rgba(108,92,231,0.1),rgba(162,155,254,0.1));border-radius:10px;margin-bottom:12px;border:1px solid rgba(108,92,231,0.2);">
					<div style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:4px;">投稿会议</div>
					<div style="font-size:1.1rem;font-weight:700;color:var(--primary-color);margin-bottom:2px;">${confInfo.name} ${confInfo.year}</div>
					<div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:8px;">${confInfo.fullName} (${grade}类)</div>
					<div style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:4px;">论文标题</div>
					<div style="font-size:0.9rem;font-weight:500;word-break:break-word;">${paper.title}</div>
					<div style="margin-top:8px;font-size:0.8rem;color:var(--text-secondary);">
						投稿时总分：<strong style="color:var(--primary-color);">${paper.submittedScore}</strong>
					</div>
				</div>`;
				
				// 增强版全球统计
				html += renderGlobalStatsEnhanced(confInfo, monthStats, grade);
				
				// 分页指示
				html += renderPageIndicator(1, totalPages);
				
				showModal(pageTitle, html, [
					{ text: '查看审稿详情 →', class: 'btn-primary', action: () => showReviewResultPage(2) }
				]);
				
			} else if (pageNum === 2) {
				// ==================== 第二页：审稿人评审详情 ====================
				pageTitle = '📝 审稿详情 (2/3)';
				
				// 调整机制展示
				html += renderAdjustmentInfo(adjustment, adjustedTarget, monthStats);
				
				// 审稿人评审详情
				html += `<div style="font-weight:600;color:var(--primary-color);margin-bottom:8px;font-size:0.9rem;">
					<i class="fas fa-user-edit"></i> 审稿人评审 (总分: ${totalReviewScore >= 0 ? '+' : ''}${totalReviewScore})
				</div>`;
				
				results.forEach((r, idx) => {
					const color = r.decision === 'Accept' ? 'var(--success-color)' : 
								 r.decision === 'Reject' ? 'var(--danger-color)' : 'var(--warning-color)';
					
					const thresholdChanged = adjustment.adjustmentEnabled && 
						(adjustment.adjustmentDetails.rejectChange !== 0 || adjustment.adjustmentDetails.borderlineChange !== 0);
					
					const baseThreshold = BASE_THRESHOLDS[grade][r.reviewer.type];
					
					// 改进建议显示
					let improvementHtml = '';
					if (r.improvement > 0) {
						const typeName = r.improvementType === 'idea' ? 'Idea' : r.improvementType === 'exp' ? '实验' : '写作';
						improvementHtml = `<div style="font-size:0.7rem;color:var(--success-color);margin-top:3px;">💡 改进建议：${typeName}+${r.improvement}</div>`;
					}
					
					html += `<div style="padding:8px;background:var(--light-bg);border-radius:6px;margin-bottom:6px;font-size:0.85rem;border-left:3px solid ${color};">
						<div style="display:flex;justify-content:space-between;margin-bottom:4px;">
							<strong>审稿人${idx + 1}: ${r.reviewer.name}</strong>
							<span style="color:${color};font-weight:600;">${r.decision}(${r.score > 0 ? '+' : ''}${r.score})</span>
						</div>
						<div style="font-size:0.7rem;color:var(--text-secondary);margin-bottom:3px;">
							📐 权重: ${r.weightInfo} → 有效分<strong>${r.effectiveScore}</strong>
						</div>
						<div style="font-size:0.65rem;color:var(--text-secondary);margin-bottom:3px;">
							📊 阈值: Reject&lt;${r.thresholds.reject}${thresholdChanged ? `<span style="color:var(--info-color);">(原${baseThreshold.reject})</span>` : ''}, 
							BL&lt;${r.thresholds.borderline}${thresholdChanged ? `<span style="color:var(--info-color);">(原${baseThreshold.borderline})</span>` : ''}
						</div>
						<div style="font-size:0.8rem;color:var(--text-secondary);font-style:italic;">"${r.comment}"</div>
						${improvementHtml}
					</div>`;
				});
				
				// 分页指示
				html += renderPageIndicator(2, totalPages);
				
				showModal(pageTitle, html, [
					{ text: '← 返回结果', class: 'btn-info', action: () => showReviewResultPage(1) },
					{ text: '查看PC决定 →', class: 'btn-primary', action: () => showReviewResultPage(3) }
				]);
				
			} else if (pageNum === 3) {
				// ==================== 第三页：分数变化 + PC决定 ====================
				pageTitle = '📝 PC决定 (3/3)';
				
				// 分数变化说明
				html += renderScoreChangeInfo(beforeScores, afterScores, results, ideaDecay, expDecay);
				
				// PC Meta Review
				html += renderPCMetaReview(totalReviewScore, accepted, acceptType, borderlineChance, adjustment, paper.submittedScore);
				
				// 最终结果
				html += renderFinalResult(accepted, acceptType, confInfo, totalReviewScore, borderlineChance);
				
				// 分页指示
				html += renderPageIndicator(3, totalPages);
				
				showModal(pageTitle, html, [
					{ text: '← 返回详情', class: 'btn-info', action: () => showReviewResultPage(2) },
					{ text: '✓ 确定', class: 'btn-primary', action: () => {
						// 恶意审稿人惩罚
						if (extraInfo.badReviewerCount > 0) {
							const sanLoss = extraInfo.badReviewerCount;
							if (!changeSan(-sanLoss)) {
								currentReviewData = null;
								return;
							}
							addLog('审稿压力', `${extraInfo.badReviewerCount}个刁难审稿人`, `SAN-${sanLoss}`);
						}
						
						if (accepted) {
							handlePaperAccepted(paper, grade, acceptType, slot, extraInfo);
						} else {
							// 记录拒稿数据
							recordSubmission(
								extraInfo.submittedMonth || gameState.month,
								grade,
								paper.submittedScore,
								'rejected',
								gameState.isReversed
							);
							
							gameState.rejectedCount++;
							gameState.rejectedPapers[paper.title] = (gameState.rejectedPapers[paper.title] || 0) + 1;
							
							if (gameState.rejectedPapers[paper.title] >= 3) {
								gameState.achievementConditions.tripleRejected = true;
							}
							
							if (extraInfo.hasExpert) {
								const existingBuff = gameState.buffs.permanent.find(b => b.type === 'idea_bonus' && b.name === '指点迷津：每次想idea分数+1');
								if (!existingBuff) {
									gameState.buffs.permanent.push({ 
										type: 'idea_bonus', 
										name: '指点迷津：每次想idea分数+1', 
										value: 1, 
										permanent: true 
									});
									addLog('因祸得福', '资深大牛的指点迷津', '永久buff-每次想idea分数+1');
								}
							}
							
							gameState.consecutiveAccepts = 0;
							
							paper.reviewing = false;
							paper.submittedGrade = null;
							paper.submittedScore = null;
							paper.reviewMonths = 0;
							paper.submittedMonth = null;
							paper.conferenceInfo = null;
							paper.conferenceLocation = null;
							
							// ★★★ 关键修改：拒稿时也要继续处理队列 ★★★
							if (gameState._reviewProcessing) {
								setTimeout(() => processNextReviewInQueue(), 100);
							}
						}
						
						currentReviewData = null;
						closeModal();
						renderPaperSlots();
						updateAllUI();
					}}
				]);
			}
		}

		/*** 渲染调整机制信息*/
		function renderAdjustmentInfo(adjustment, adjustedTarget, monthStats) {
			if (!monthStats || monthStats.submissions < 30) {
				return '';
			}
			
			const popularity = adjustedTarget.popularity;
			const popularityText = {
				'very_hot': '🔥 非常热门',
				'hot': '🌡️ 热门',
				'normal': '📊 正常',
				'cold': '❄️ 冷门',
				'very_cold': '🧊 非常冷门'
			}[popularity?.category] || '📊 正常';
			
			const adjustmentStatus = adjustment.adjustmentEnabled 
				? `<span style="color:var(--success-color);">✓ 已启用</span>` 
				: `<span style="color:var(--text-secondary);">○ 未启用(需≥${MIN_SUBMISSIONS_FOR_ADJUSTMENT}篇)</span>`;
			
			return `
			<div style="padding:10px;background:linear-gradient(135deg,rgba(253,203,110,0.1),rgba(243,156,18,0.1));border-radius:8px;margin-bottom:12px;font-size:0.8rem;">
				<div style="font-weight:600;color:#d68910;margin-bottom:6px;">
					<i class="fas fa-balance-scale"></i> 录取率调整机制 ${adjustmentStatus}
				</div>
				<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
					<div>
						${popularityText}<br>
						<span style="font-size:0.7rem;color:var(--text-secondary);">
							投稿${monthStats.submissions}篇 / 平均${popularity?.avgSubmissions || '-'}篇
						</span>
					</div>
					<div>
						目标录取率：${(adjustedTarget.target * 100).toFixed(1)}%<br>
						<span style="font-size:0.7rem;color:var(--text-secondary);">
							实际：${((monthStats.acceptRate || 0) * 100).toFixed(1)}%
						</span>
					</div>
				</div>
				${adjustment.adjustmentEnabled ? `
				<div style="margin-top:6px;font-size:0.7rem;color:var(--text-secondary);border-top:1px dashed rgba(243,156,18,0.3);padding-top:6px;">
					${adjustment.adjustmentDetails.reason}
				</div>` : ''}
			</div>`;
		}

		/*** 渲染分数变化信息*/
		function renderScoreChangeInfo(beforeScores, afterScores, results, ideaDecay, expDecay) {
			const improvements = results.filter(r => r.improvement > 0);
			const totalImprovement = improvements.reduce((sum, imp) => sum + imp.improvement, 0);
			const totalDecay = ideaDecay + expDecay;
			const netChange = afterScores.total - beforeScores.total;
			
			if (totalImprovement === 0 && totalDecay === 0) {
				return '';
			}
			
			const netColor = netChange > 0 ? 'var(--success-color)' : netChange < 0 ? 'var(--danger-color)' : 'var(--text-secondary)';
			
			let html = `<div style="padding:12px;background:linear-gradient(135deg,rgba(108,92,231,0.1),rgba(116,185,255,0.1));border-radius:8px;margin-bottom:12px;font-size:0.85rem;border:1px solid var(--border-color);">
				<div style="font-weight:600;color:var(--primary-color);margin-bottom:10px;">
					<i class="fas fa-chart-line"></i> 审稿期间分数变化
				</div>`;
			
			// 衰减信息
			if (gameState.noDecay) {
				html += `<div style="margin-bottom:8px;padding:8px;background:rgba(0,184,148,0.1);border-radius:6px;border-left:3px solid var(--success-color);">
					<div style="font-size:0.8rem;color:var(--success-color);">🔮 预见未来热点生效，分数不衰减</div>
				</div>`;
			} else if (totalDecay > 0) {
				html += `<div style="margin-bottom:8px;padding:8px;background:rgba(225,112,85,0.1);border-radius:6px;border-left:3px solid var(--danger-color);">
					<div style="font-size:0.8rem;color:var(--danger-color);">⏳ 时效性降低：Idea-${ideaDecay}, 实验-${expDecay}</div>
				</div>`;
			}
			
			// 改进信息
			if (improvements.length > 0) {
				html += `<div style="margin-bottom:8px;padding:8px;background:rgba(0,184,148,0.1);border-radius:6px;border-left:3px solid var(--success-color);">
					<div style="font-size:0.8rem;color:var(--success-color);">💡 审稿人建议：`;
				improvements.forEach(imp => {
					const typeName = imp.improvementType === 'idea' ? 'Idea' : imp.improvementType === 'exp' ? '实验' : '写作';
					html += `${imp.reviewer.name}(${typeName}+${imp.improvement}) `;
				});
				html += `</div></div>`;
			}
			
			// ★★★ 修改：white 改为 var(--card-bg) ★★★
			html += `<div style="text-align:center;padding:8px;background:var(--card-bg);border-radius:6px;border:1px solid var(--border-color);">
				总分变化：${beforeScores.total} → <span style="color:${netColor};font-weight:600;">${afterScores.total}</span>
				(净变化：<span style="color:${netColor};">${netChange >= 0 ? '+' : ''}${netChange}</span>)
			</div>`;
			
			html += '</div>';
			return html;
		}

		/*** 渲染PC Meta Review*/
		function renderPCMetaReview(totalReviewScore, accepted, acceptType, borderlineChance, adjustment, paperScore) {
			let pcDecisionText, pcReasonText;
			
			if (totalReviewScore >= 1) {
				pcDecisionText = `<span style="color:var(--success-color);">录用为${acceptType}</span>`;
				pcReasonText = '审稿人普遍认可，PC决定录用。';
			} else if (totalReviewScore === 0) {
				if (accepted) {
					pcDecisionText = `<span style="color:var(--success-color);">录用为${acceptType}</span>`;
					pcReasonText = `审稿人意见分歧（Borderline），PC综合评估后决定录用。`;
				} else {
					pcDecisionText = `<span style="color:var(--danger-color);">拒稿</span>`;
					pcReasonText = `审稿人意见分歧（Borderline），PC综合评估后决定拒稿。`;
				}
			} else if (totalReviewScore === -1) {
				if (accepted) {
					pcDecisionText = `<span style="color:var(--success-color);">录用为${acceptType}</span>`;
					pcReasonText = `审稿意见偏负面，但PC认为论文有价值，决定录用。`;
				} else {
					pcDecisionText = `<span style="color:var(--danger-color);">拒稿</span>`;
					pcReasonText = `审稿意见偏负面，PC建议修改后重投。`;
				}
			} else {
				pcDecisionText = `<span style="color:var(--danger-color);">拒稿</span>`;
				pcReasonText = '审稿人普遍不认可，PC决定拒稿。';
			}
			
			let blInfo = '';
			if (borderlineChance !== null) {
				const chancePercent = (borderlineChance * 100).toFixed(0);
				const sourceText = adjustment.adjustmentEnabled 
					? `基础${(adjustment.borderlineBaseRate * 100).toFixed(0)}%+分数修正` 
					: '基于论文分数计算';
				blInfo = `
				<div style="font-size:0.75rem;color:var(--text-secondary);margin-top:6px;padding-top:6px;border-top:1px dashed var(--border-color);">
					💡 Borderline录取概率：${chancePercent}%（${sourceText}）
				</div>`;
			}
			
			// ★★★ 修改：white 改为 var(--card-bg)，添加边框 ★★★
			return `
			<div style="padding:12px;background:linear-gradient(135deg,rgba(155,89,182,0.1),rgba(108,92,231,0.1));border-radius:8px;margin-bottom:12px;border:1px solid rgba(155,89,182,0.3);">
				<div style="font-weight:600;color:#9b59b6;margin-bottom:8px;">
					<i class="fas fa-user-tie"></i> PC Meta Review
				</div>
				<div style="background:var(--card-bg);border-radius:6px;padding:10px;border:1px solid var(--border-color);">
					<div style="font-size:0.8rem;margin-bottom:6px;">
						<strong>总审稿分：</strong>${totalReviewScore}（${totalReviewScore >= 1 ? '偏正面' : totalReviewScore === 0 ? '中立' : '偏负面'}）
					</div>
					<div style="font-size:0.8rem;margin-bottom:6px;">
						<strong>综合评估：</strong>${pcReasonText}
					</div>
					<div style="font-size:0.85rem;">
						<strong>PC决定：</strong>${pcDecisionText}
					</div>
					${blInfo}
				</div>
			</div>`;
		}

		/*** 渲染全球统计*/
		function renderGlobalStats(confInfo, monthStats, grade) {
			const acceptRate = ((monthStats.acceptRate || 0) * 100).toFixed(1);
			
			return `
			<div style="padding:12px;background:linear-gradient(135deg,rgba(116,185,255,0.1),rgba(162,155,254,0.1));border-radius:8px;margin-bottom:12px;font-size:0.8rem;border:1px solid rgba(116,185,255,0.3);">
				<div style="font-weight:600;color:var(--info-color);margin-bottom:8px;">
					<i class="fas fa-globe"></i> ${confInfo.name} 全球统计
				</div>
				<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:6px;">
					<div>📝 投稿：<strong>${monthStats.submissions}</strong>篇</div>
					<div>✅ 录用：<strong>${monthStats.accepted || 0}</strong>篇</div>
					<div>📈 录用率：<strong>${acceptRate}%</strong></div>
					<div>🎯 Oral参考：≥${monthStats.p90AcceptedScore || '-'}分</div>
				</div>
			</div>`;
		}

		/*** 渲染最终结果*/
		function renderFinalResult(accepted, acceptType, confInfo, totalReviewScore, borderlineChance) {
			if (accepted) {
				const colors = { 'Poster': '#74b9ff', 'Oral': '#fdcb6e', 'Best Paper': '#fd79a8' };
				return `
				<div style="text-align:center;padding:12px;background:linear-gradient(135deg,${colors[acceptType]}33,${colors[acceptType]}66);border-radius:10px;">
					<div style="font-size:1.8rem;margin-bottom:8px;">🎉</div>
					<div style="font-size:1.1rem;font-weight:700;color:${colors[acceptType]};">
						恭喜！论文被 ${confInfo.name} ${confInfo.year} 接收为 ${acceptType}！
					</div>
				</div>`;
			} else {
				return `
				<div style="text-align:center;padding:12px;background:rgba(225,112,85,0.15);border-radius:10px;">
					<div style="font-size:1.8rem;margin-bottom:8px;">😢</div>
					<div style="font-size:1.1rem;font-weight:700;color:var(--danger-color);">
						很遗憾，论文被 ${confInfo.name} ${confInfo.year} 拒稿了
					</div>
					<div style="margin-top:6px;font-size:0.85rem;color:var(--text-secondary);">
						可根据审稿意见修改后重投其他会议
					</div>
				</div>`;
			}
		}

		/*** 处理审稿结果后续逻辑*/
		function handleReviewOutcome(accepted, acceptType, paper, grade, slot, extraInfo, results) {
			if (accepted) {
				// 记录投稿数据
				const resultStr = acceptType.toLowerCase().replace(/\s+/g, '_');
				recordSubmission(
					extraInfo.submittedMonth || gameState.month,
					grade,
					paper.submittedScore,
					resultStr,
					gameState.isReversed
				);
				
				// 调用原有的录取处理逻辑
				handlePaperAccepted(paper, grade, acceptType, slot, extraInfo);
			} else {
				// 记录拒稿数据
				recordSubmission(
					extraInfo.submittedMonth || gameState.month,
					grade,
					paper.submittedScore,
					'rejected',
					gameState.isReversed
				);
				
				// 更新拒稿统计
				gameState.rejectedCount++;
				gameState.rejectedPapers = gameState.rejectedPapers || {};
				gameState.rejectedPapers[paper.title] = (gameState.rejectedPapers[paper.title] || 0) + 1;
				
				if (gameState.rejectedPapers[paper.title] >= 3) {
					gameState.achievementConditions = gameState.achievementConditions || {};
					gameState.achievementConditions.tripleRejected = true;
				}
				
				// 坏审稿人惩罚
				if (extraInfo.badReviewerCount > 0) {
					const sanLoss = extraInfo.badReviewerCount;
					changeSan(-sanLoss);
					addLog('审稿打击', `${extraInfo.badReviewerCount}个恶意审稿人`, `SAN-${sanLoss}`);
				}
				
				// 资深大牛指导
				if (extraInfo.hasExpert) {
					const existingBuff = gameState.buffs.permanent.find(b => 
						b.type === 'idea_bonus' && b.name === '指点迷津：每次想idea分数+1'
					);
					if (!existingBuff) {
						gameState.buffs.permanent.push({ 
							type: 'idea_bonus', 
							name: '指点迷津：每次想idea分数+1', 
							value: 1, 
							permanent: true 
						});
						addLog('因祸得福', '资深大牛的指点迷津', '永久buff-每次想idea分数+1');
					}
				}
				
				// 重置连续中稿计数
				gameState.consecutiveAccepts = 0;
				
				// 清除审稿状态
				paper.reviewing = false;
				paper.submittedGrade = null;
				paper.submittedScore = null;
				paper.reviewMonths = 0;
				paper.submittedMonth = null;
				paper.conferenceInfo = null;
				paper.conferenceLocation = null;
			}
		}

		// ==================== 辅助函数 ====================


        // 异步记录投稿数据
        async function recordSubmission(gameMonth, grade, submittedScore, result, isReversed) {
            if (!supabase) return;
            
            try {
                await supabase.from('paper_submissions').insert({
                    game_month: gameMonth,
                    grade: grade,
                    submitted_score: submittedScore,
                    result: result.toLowerCase().replace(' ', '_'),
                    is_reversed: isReversed
                });
                console.log('✅ 投稿记录已保存');
            } catch (e) {
                console.error('记录投稿失败:', e);
            }
        }

		// ==================== 在线人数系统（改进版）====================
		let onlineSessionId = null;
		let onlineHeartbeatTimer = null;

		// 生成会话ID
		function getOnlineSessionId() {
			let id = sessionStorage.getItem('graduate_online_session');
			if (!id) {
				id = Date.now().toString(36) + Math.random().toString(36).substr(2, 6);
				sessionStorage.setItem('graduate_online_session', id);
			}
			return id;
		}

		// 启动在线追踪
		function startOnlineTracking() {
			if (!supabase) return;
			
			onlineSessionId = getOnlineSessionId();
			
			// 立即发送一次心跳并检查历史在线
			sendOnlineHeartbeat();
			checkAndRecordMaxOnline();
			
			// 每60秒发送心跳
			onlineHeartbeatTimer = setInterval(() => {
				sendOnlineHeartbeat();
			}, 60 * 1000);
			
			// 页面关闭时清理
			window.addEventListener('beforeunload', () => {
				if (onlineSessionId && supabase) {
					// 使用 sendBeacon 确保请求发送
					const url = `${SUPABASE_URL}/rest/v1/online_users?session_id=eq.${onlineSessionId}`;
					navigator.sendBeacon(url, '');
				}
			});
		}

		// 发送心跳
		async function sendOnlineHeartbeat() {
			if (!supabase || !onlineSessionId) return;
			
			try {
				// 发送心跳
				await supabase
					.from('online_users')
					.upsert({ 
						session_id: onlineSessionId, 
						last_seen: new Date().toISOString() 
					});
				
				// 清理超过5分钟未活跃的记录
				const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000).toISOString();
				await supabase
					.from('online_users')
					.delete()
					.lt('last_seen', fiveMinutesAgo);
					
			} catch (e) {
				console.error('心跳发送失败:', e);
			}
		}

		// ★★★ 核心函数：检查并记录历史最高在线 ★★★
		async function checkAndRecordMaxOnline() {
			if (!supabase) return null;
			
			// 使用重试机制确保写入
			const maxRetries = 3;
			
			for (let attempt = 1; attempt <= maxRetries; attempt++) {
				try {
					// 1. 获取当前在线人数
					const threeMinutesAgo = new Date(Date.now() - 3 * 60 * 1000).toISOString();
					const { count: currentOnline, error: countError } = await supabase
						.from('online_users')
						.select('*', { count: 'exact', head: true })
						.gte('last_seen', threeMinutesAgo);
					
					if (countError) throw countError;
					
					const onlineCount = currentOnline || 0;
					
					if (onlineCount === 0) {
						return { current: 0, max: await getHistoryMaxOnline() };
					}
					
					// 2. 查询历史最大在线人数（从 online_records 表）
					const historyMax = await getHistoryMaxOnline();
					
					// 3. 如果当前在线大于历史最大，追加新记录
					if (onlineCount > historyMax) {
						const { error: insertError } = await supabase
							.from('online_records')
							.insert({ 
								online_count: onlineCount,
								recorded_at: new Date().toISOString()
							});
						
						if (insertError) {
							console.error(`记录在线人数失败 (尝试 ${attempt}/${maxRetries}):`, insertError);
							if (attempt < maxRetries) {
								await new Promise(r => setTimeout(r, 500 * attempt)); // 延迟重试
								continue;
							}
						} else {
							console.log(`✅ 新的历史最高在线：${onlineCount} (超过之前的 ${historyMax})`);
							return { current: onlineCount, max: onlineCount };
						}
					}
					
					return { current: onlineCount, max: Math.max(onlineCount, historyMax) };
					
				} catch (e) {
					console.error(`检查在线记录失败 (尝试 ${attempt}/${maxRetries}):`, e);
					if (attempt < maxRetries) {
						await new Promise(r => setTimeout(r, 500 * attempt));
					} // 关闭 if
				} // 关闭 catch
			} // <--- 在这里添加一个大括号，关闭 for 循环
			
			return null;
		}

		// ★★★ 获取历史最高在线人数（从追加记录表中查询最大值）★★★
		async function getHistoryMaxOnline() {
			if (!supabase) return 0;
			
			try {
				// 查询 online_records 表中的最大值
				const { data, error } = await supabase
					.from('online_records')
					.select('online_count')
					.order('online_count', { ascending: false })
					.limit(1)
					.maybeSingle();  // 使用 maybeSingle 避免无数据时报错
				
				if (error) {
					console.error('获取历史最高在线失败:', error);
					return 0;
				}
				
				return data?.online_count || 0;
			} catch (e) {
				console.error('获取历史最高在线异常:', e);
				return 0;
			}
		}

		// 获取今日北京时间0点的UTC时间
		function getTodayStartUTC() {
			// 当前UTC时间 + 8小时 = 北京时间
			const beijingNow = new Date(Date.now() + 8 * 60 * 60 * 1000);
			
			// 取北京时间的年月日
			const yyyy = beijingNow.getUTCFullYear();
			const mm = String(beijingNow.getUTCMonth() + 1).padStart(2, '0');
			const dd = String(beijingNow.getUTCDate()).padStart(2, '0');
			
			// 北京时间今日0点的ISO格式
			const beijingMidnight = `${yyyy}-${mm}-${dd}T00:00:00+08:00`;
			
			// 转为UTC ISO字符串返回
			return new Date(beijingMidnight).toISOString();
		}

		// 获取今日北京日期字符串 (YYYY-MM-DD)
		function getTodayDateString() {
			const beijingNow = new Date(Date.now() + 8 * 60 * 60 * 1000);
			const yyyy = beijingNow.getUTCFullYear();
			const mm = String(beijingNow.getUTCMonth() + 1).padStart(2, '0');
			const dd = String(beijingNow.getUTCDate()).padStart(2, '0');
			return `${yyyy}-${mm}-${dd}`;
		}

		// ★★★ 修改后的获取所有统计数据函数 ★★★
		async function getAllStats() {
			if (!supabase) return null;
			
			try {
				const todayStart = getTodayStartUTC();
				const threeMinutesAgo = new Date(Date.now() - 3 * 60 * 1000).toISOString();
				
				// 并行查询所有统计
				const [
					onlineResult, 
					maxOnlineResult,
					todayPvResult, 
					todayUvResult, 
					todayGamesResult
				] = await Promise.all([
					// 当前在线
					supabase
						.from('online_users')
						.select('*', { count: 'exact', head: true })
						.gte('last_seen', threeMinutesAgo),
					// 历史最高在线（从追加记录表查询）
					supabase
						.from('online_records')
						.select('online_count')
						.order('online_count', { ascending: false })
						.limit(1)
						.maybeSingle(),
					// 今日PV
					supabase
						.from('site_visits')
						.select('*', { count: 'exact', head: true })
						.eq('type', 'pv')
						.gte('created_at', todayStart),
					// 今日UV
					supabase
						.from('site_visits')
						.select('*', { count: 'exact', head: true })
						.eq('type', 'uv')
						.gte('created_at', todayStart),
					// 今日游戏数
					supabase
						.from('game_endings')
						.select('*', { count: 'exact', head: true })
						.gte('created_at', todayStart)
				]);
				
				const currentOnline = onlineResult.count || 0;
				const historyMax = maxOnlineResult.data?.online_count || 0;
				
				// 如果当前在线大于历史最高，记录新纪录
				if (currentOnline > historyMax && currentOnline > 0) {
					// 异步写入，不阻塞返回
					supabase
						.from('online_records')
						.insert({ 
							online_count: currentOnline,
							recorded_at: new Date().toISOString()
						})
						.then(({ error }) => {
							if (error) {
								console.error('追加在线记录失败:', error);
							} else {
								console.log(`✅ 新历史最高在线已记录：${currentOnline}`);
							}
						});
				}
				
				return {
					online: currentOnline,
					maxOnline: Math.max(currentOnline, historyMax),
					todayPv: todayPvResult.count || 0,
					todayUv: todayUvResult.count || 0,
					todayGames: todayGamesResult.count || 0
				};
			} catch (e) {
				console.error('获取统计失败:', e);
				return null;
			}
		}

		// 更新统计显示
		async function updateAllStatsDisplay() {
			console.log('正在更新统计显示...');  // 添加调试日志
			
			const stats = await getAllStats();
			
			console.log('获取到的统计:', stats);  // 添加调试日志
			
			if (stats) {
				const el = (id) => document.getElementById(id);
				if (el('online-count-value')) el('online-count-value').textContent = stats.online;
				if (el('max-online-value')) el('max-online-value').textContent = stats.maxOnline;
				if (el('today-pv-value')) el('today-pv-value').textContent = stats.todayPv;
				if (el('today-uv-value')) el('today-uv-value').textContent = stats.todayUv;
				if (el('today-games-value')) el('today-games-value').textContent = stats.todayGames;
				console.log('✅ 统计显示已更新');
			} else {
				console.error('❌ getAllStats 返回 null');
			}
		}

		// ==================== 留言板系统 ====================
		const MESSAGES_PER_PAGE = 10;
		let currentMessagePage = 1;
		let totalMessagePages = 1;
		let replyToMessage = null;
		let messagesCache = null;

		// 加载留言
		async function loadMessages(page = 1) {
			const listEl = document.getElementById('message-list');
			const paginationEl = document.getElementById('message-pagination');
			
			if (!supabase) {
				listEl.innerHTML = '<div class="no-messages"><i class="fas fa-database"></i><div>留言服务暂不可用</div></div>';
				return;
			}
			
			listEl.innerHTML = '<div style="text-align:center;color:var(--text-secondary);font-size:0.85rem;padding:20px;"><i class="fas fa-spinner fa-spin"></i> 加载留言中...</div>';
			
			try {
				// 获取主留言总数
				const { count: totalCount, error: countError } = await supabase
					.from('messages')
					.select('*', { count: 'exact', head: true })
					.is('parent_id', null);
				
				if (countError) throw countError;
				
				totalMessagePages = Math.max(1, Math.ceil(totalCount / MESSAGES_PER_PAGE));
				currentMessagePage = Math.min(page, totalMessagePages);
				
				// 获取当前页的主留言
				const offset = (currentMessagePage - 1) * MESSAGES_PER_PAGE;
				const { data: mainMessages, error: mainError } = await supabase
					.from('messages')
					.select('*')
					.is('parent_id', null)
					.order('created_at', { ascending: false })
					.range(offset, offset + MESSAGES_PER_PAGE - 1);
				
				if (mainError) throw mainError;
				
				if (!mainMessages || mainMessages.length === 0) {
					listEl.innerHTML = '<div class="no-messages"><i class="fas fa-comment-slash"></i><div>暂无留言，来做第一个留言的人吧！</div></div>';
					paginationEl.style.display = 'none';
					return;
				}
				
				// 获取这些主留言的所有回复
				const mainIds = mainMessages.map(m => m.id);
				const { data: replies, error: repliesError } = await supabase
					.from('messages')
					.select('*')
					.in('parent_id', mainIds)
					.order('created_at', { ascending: true });
				
				if (repliesError) throw repliesError;
				
				// 按parent_id分组回复
				const repliesMap = {};
				(replies || []).forEach(reply => {
					if (!repliesMap[reply.parent_id]) {
						repliesMap[reply.parent_id] = [];
					}
					repliesMap[reply.parent_id].push(reply);
				});
				
				// 渲染留言
				listEl.innerHTML = mainMessages.map(msg => renderMessage(msg, repliesMap[msg.id] || [])).join('');
				
				// 更新分页
				updatePagination();
				paginationEl.style.display = totalMessagePages > 1 ? 'block' : 'none';
				
			} catch (e) {
				console.error('加载留言失败:', e);
				listEl.innerHTML = `<div class="no-messages"><i class="fas fa-exclamation-triangle"></i><div>加载失败，请稍后重试</div><button class="btn btn-info" onclick="loadMessages(${currentMessagePage})" style="margin-top:10px;"><i class="fas fa-redo"></i> 重试</button></div>`;
			}
		}

		// 渲染单条留言
		function renderMessage(msg, replies = []) {
			const time = formatMessageTime(msg.created_at);
			const replyCount = replies.length;
			
			let repliesHtml = '';
			if (replyCount > 0) {
				repliesHtml = `
					<div class="message-replies">
						${replies.map(reply => `
							<div class="message-item reply">
								<div class="message-header">
									<span class="message-nickname">${escapeHtml(reply.nickname)}</span>
									<span class="message-time">${formatMessageTime(reply.created_at)}</span>
								</div>
								<div class="message-content">${escapeHtml(reply.content)}</div>
							</div>
						`).join('')}
					</div>
				`;
			}
			
			return `
				<div class="message-item" data-id="${msg.id}">
					<div class="message-header">
						<span class="message-nickname">${escapeHtml(msg.nickname)}</span>
						<span class="message-time">${time}</span>
					</div>
					<div class="message-content">${escapeHtml(msg.content)}</div>
					<div class="message-actions">
						<button onclick="setReplyTo(${msg.id}, '${escapeHtml(msg.nickname)}', '${escapeHtml(msg.content.substring(0, 30))}')">
							<i class="fas fa-reply"></i> 回复
						</button>
						${replyCount > 0 ? `<span class="reply-count"><i class="fas fa-comments"></i> ${replyCount} 条回复</span>` : ''}
					</div>
					${repliesHtml}
				</div>
			`;
		}

		// 格式化时间
		function formatMessageTime(dateStr) {
			const date = new Date(dateStr);
			const now = new Date();
			const diff = now - date;
			
			// 1分钟内
			if (diff < 60 * 1000) {
				return '刚刚';
			}
			// 1小时内
			if (diff < 60 * 60 * 1000) {
				return `${Math.floor(diff / 60 / 1000)} 分钟前`;
			}
			// 24小时内
			if (diff < 24 * 60 * 60 * 1000) {
				return `${Math.floor(diff / 60 / 60 / 1000)} 小时前`;
			}
			// 7天内
			if (diff < 7 * 24 * 60 * 60 * 1000) {
				return `${Math.floor(diff / 24 / 60 / 60 / 1000)} 天前`;
			}
			// 更早
			return `${date.getMonth() + 1}月${date.getDate()}日`;
		}

		// HTML转义
		function escapeHtml(text) {
			const div = document.createElement('div');
			div.textContent = text;
			return div.innerHTML;
		}

		// 设置回复目标
		function setReplyTo(id, nickname, preview) {
			replyToMessage = { id, nickname };
			document.getElementById('reply-indicator').style.display = 'block';
			document.getElementById('reply-to-name').textContent = nickname;
			document.getElementById('reply-preview').textContent = preview.length >= 30 ? preview + '...' : preview;
			document.getElementById('msg-content').focus();
			document.getElementById('msg-content').placeholder = `回复 ${nickname}...`;
		}

		// 取消回复
		function cancelReply() {
			replyToMessage = null;
			document.getElementById('reply-indicator').style.display = 'none';
			document.getElementById('msg-content').placeholder = '说点什么吧...（支持回复其他人的留言）';
		}

		// 发表留言
		async function postMessage() {
			const nicknameInput = document.getElementById('msg-nickname');
			const contentInput = document.getElementById('msg-content');
			
			const nickname = nicknameInput.value.trim();
			const content = contentInput.value.trim();
			
			if (!nickname) {
				showModal('❌ 提示', '<p>请输入昵称！</p>', [{ text: '确定', class: 'btn-primary', action: closeModal }]);
				nicknameInput.focus();
				return;
			}
			
			if (!content) {
				showModal('❌ 提示', '<p>请输入留言内容！</p>', [{ text: '确定', class: 'btn-primary', action: closeModal }]);
				contentInput.focus();
				return;
			}
			
			if (nickname.length > 20) {
				showModal('❌ 提示', '<p>昵称不能超过20个字符！</p>', [{ text: '确定', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			if (content.length > 500) {
				showModal('❌ 提示', '<p>留言内容不能超过500个字符！</p>', [{ text: '确定', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			if (!supabase) {
				showModal('❌ 错误', '<p>留言服务暂不可用</p>', [{ text: '确定', class: 'btn-primary', action: closeModal }]);
				return;
			}
			
			try {
				const messageData = {
					nickname: nickname,
					content: content,
					parent_id: replyToMessage ? replyToMessage.id : null
				};
				
				const { error } = await supabase.from('messages').insert(messageData);
				
				if (error) throw error;
				
				// 清空输入
				contentInput.value = '';
				cancelReply();
				
				// 保存昵称到本地
				localStorage.setItem('graduateSimulator_nickname', nickname);
				
				// 如果是回复，刷新当前页；如果是新留言，跳转到第一页
				if (replyToMessage) {
					await loadMessages(currentMessagePage);
				} else {
					await loadMessages(1);
				}
				
				showModal('✅ 成功', '<p>留言发表成功！</p>', [{ text: '确定', class: 'btn-primary', action: closeModal }]);
				
			} catch (e) {
				console.error('发表留言失败:', e);
				showModal('❌ 错误', '<p>发表失败，请稍后重试</p>', [{ text: '确定', class: 'btn-primary', action: closeModal }]);
			}
		}

		// 翻页
		function changeMessagePage(delta) {
			const newPage = currentMessagePage + delta;
			if (newPage >= 1 && newPage <= totalMessagePages) {
				loadMessages(newPage);
			}
		}

		// 更新分页UI
		function updatePagination() {
			document.getElementById('page-info').textContent = `第 ${currentMessagePage} / ${totalMessagePages} 页`;
			document.getElementById('prev-page-btn').disabled = currentMessagePage <= 1;
			document.getElementById('next-page-btn').disabled = currentMessagePage >= totalMessagePages;
		}

		// 初始化留言板
		function initMessageBoard() {
			// 恢复保存的昵称
			const savedNickname = localStorage.getItem('graduateSimulator_nickname');
			if (savedNickname) {
				document.getElementById('msg-nickname').value = savedNickname;
			}
			
			// 加载留言
			loadMessages(1);
		}

		// 启动在线追踪（心跳持续，统计只查一次）
		function startOnlineTracking() {
			if (!supabase) return;
			
			onlineSessionId = getOnlineSessionId();
			
			// 立即心跳
			sendOnlineHeartbeat();
			
			// 只查询一次统计
			updateAllStatsDisplay();
			
			// 持续心跳（游戏中也发）
			if (!onlineHeartbeatTimer) {
				onlineHeartbeatTimer = setInterval(sendOnlineHeartbeat, 60 * 1000);
			}
		}


		// ==================== 游戏说明系统 ====================

		function showGuide(type) {
			let title = '';
			let content = '';
			
			switch(type) {
				case 'basics':
					title = '📖 基础玩法与属性';
					content = `
		<div style="max-height:60vh;overflow-y:auto;font-size:0.85rem;line-height:1.6;">
			<div style="background:linear-gradient(135deg,rgba(108,92,231,0.1),rgba(162,155,254,0.1));border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--primary-color);margin:0 0 8px 0;">🎯 游戏目标</h4>
				<ul style="margin:0;padding-left:20px;">
					<li><strong>硕士毕业</strong>：3年（36个月）内科研分≥1</li>
					<li><strong>博士毕业</strong>：5年（60个月）内科研分≥7</li>
					<li><strong>转博条件</strong>：硕士第2年12月科研分≥2，或第3年12月科研分≥3</li>
				</ul>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--success-color);margin:0 0 8px 0;">📊 五大属性详解</h4>
				
				<div style="margin-bottom:10px;padding:8px;background:var(--card-bg);border-radius:6px;border-left:3px solid #e74c3c;">
					<strong>🧠 SAN值（精神状态）</strong>
					<div style="font-size:0.8rem;color:var(--text-secondary);">
						• 初始值：20/20<br>
						• 每月自然恢复：+1（逆位大多数+3/+4）<br>
						• <span style="color:var(--danger-color);">降为负数触发"不堪重负"结局</span><br>
						• 设计思路：模拟研究生的精神压力，需要平衡科研强度和休息
					</div>
				</div>
				
				<div style="margin-bottom:10px;padding:8px;background:var(--card-bg);border-radius:6px;border-left:3px solid #3498db;">
					<strong>🔬 科研能力</strong>
					<div style="font-size:0.8rem;color:var(--text-secondary);">
						• 初始值：1，上限：20<br>
						• 直接影响论文分数生成<br>
						• <strong>解锁论文槽</strong>：6→第2槽，12→第3槽，18→第4槽<br>
						• 公式影响：基础分 = 科研能力 × (0.5~1.5随机)<br>
						• 设计思路：核心成长属性，决定论文质量上限
					</div>
				</div>
				
				<div style="margin-bottom:10px;padding:8px;background:var(--card-bg);border-radius:6px;border-left:3px solid #9b59b6;">
					<strong>👥 社交能力</strong>
					<div style="font-size:0.8rem;color:var(--text-secondary);">
						• 初始值：1，上限：20<br>
						• 达到<strong>6级</strong>：解锁开会高级选项、让师弟分担无惩罚<br>
						• 达到<strong>12级</strong>：解锁恋人选项、更多合作机会<br>
						• <span style="color:var(--danger-color);">降为负数触发"被孤立"结局</span><br>
						• 设计思路：影响人际关系和事件选项，高社交能获得更多帮助
					</div>
				</div>
				
				<div style="margin-bottom:10px;padding:8px;background:var(--card-bg);border-radius:6px;border-left:3px solid #e91e63;">
					<strong>❤️ 导师好感度</strong>
					<div style="font-size:0.8rem;color:var(--text-secondary);">
						• 初始值：1，上限：20<br>
						• 达到<strong>6级</strong>：开会报销只扣1好感、导师更容易被说服<br>
						• 达到<strong>12级</strong>：获得更多资源支持<br>
						• <span style="color:var(--danger-color);">降为负数触发"逐出师门"结局</span><br>
						• 设计思路：模拟导学关系，影响资源获取和事件结果
					</div>
				</div>
				
				<div style="padding:8px;background:var(--card-bg);border-radius:6px;border-left:3px solid #f39c12;">
					<strong>💰 金币</strong>
					<div style="font-size:0.8rem;color:var(--text-secondary);">
						• 初始值：1<br>
						• 每月收入：硕士+1，博士+3（扣除1开销）<br>
						• 用途：商店购物、开会费用、约会开销<br>
						• <span style="color:var(--danger-color);">降为负数触发"穷困潦倒"结局</span><br>
						• 设计思路：模拟经济压力，需要合理规划支出
					</div>
				</div>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--warning-color);margin:0 0 8px 0;">🎮 基本操作</h4>
				<table style="width:100%;font-size:0.8rem;border-collapse:collapse;">
					<tr style="background:var(--card-bg);">
						<th style="padding:6px;text-align:left;border-bottom:1px solid var(--border-color);">操作</th>
						<th style="padding:6px;text-align:center;border-bottom:1px solid var(--border-color);">消耗</th>
						<th style="padding:6px;text-align:left;border-bottom:1px solid var(--border-color);">效果</th>
					</tr>
					<tr><td style="padding:6px;">📖 看论文</td><td style="padding:6px;text-align:center;">SAN-2</td><td style="padding:6px;">下次想idea+1分，每5次科研+1</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">💼 打工</td><td style="padding:6px;text-align:center;">SAN-5</td><td style="padding:6px;">金钱+2</td></tr>
					<tr><td style="padding:6px;">💡 想idea</td><td style="padding:6px;text-align:center;">SAN-2</td><td style="padding:6px;">增加论文idea分数</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">🔬 做实验</td><td style="padding:6px;text-align:center;">SAN-3</td><td style="padding:6px;">增加论文实验分数</td></tr>
					<tr><td style="padding:6px;">✍️ 写论文</td><td style="padding:6px;text-align:center;">SAN-4</td><td style="padding:6px;">增加论文写作分数</td></tr>
				</table>
				<div style="margin-top:8px;font-size:0.75rem;color:var(--text-secondary);">
					⚠️ 每月只能执行1次持续操作（隐藏觉醒"勤能补拙"可增加到2次）
				</div>
			</div>
			
			<div style="background:linear-gradient(135deg,rgba(0,184,148,0.1),rgba(85,239,196,0.1));border-radius:10px;padding:12px;">
				<h4 style="color:var(--success-color);margin:0 0 8px 0;">💡 设计思路</h4>
				<div style="font-size:0.8rem;color:var(--text-secondary);">
					游戏模拟真实研究生生活的资源管理：
					<ul style="margin:5px 0;padding-left:20px;">
						<li><strong>精力有限</strong>：SAN值代表精神状态，过度劳累会崩溃</li>
						<li><strong>多维平衡</strong>：科研、社交、导师关系、经济都需要兼顾</li>
						<li><strong>属性门槛</strong>：6/12是关键节点，解锁更多选项</li>
						<li><strong>建议</strong>：前期优先将科研和社交提升到6，解锁更多可能性</li>
					</ul>
				</div>
			</div>
		</div>`;
					break;
					
				case 'paperScore':
					title = '📊 论文分数计算';
					content = `
		<div style="max-height:60vh;overflow-y:auto;font-size:0.85rem;line-height:1.6;">
			<div style="background:linear-gradient(135deg,rgba(108,92,231,0.1),rgba(162,155,254,0.1));border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--primary-color);margin:0 0 8px 0;">📐 基础分数公式</h4>
				<div style="background:var(--card-bg);border-radius:8px;padding:10px;font-family:monospace;font-size:0.85rem;">
					<div style="color:var(--success-color);margin-bottom:5px;">// 单次操作生成分数</div>
					基础分 = round(科研能力 × 随机(0.5~1.5) + 随机(0~5))<br>
					最终分 = 基础分 × buff乘数 + buff加成<br><br>
					<div style="color:var(--success-color);margin-bottom:5px;">// 保底机制</div>
					实际分数 = max(生成分数, 当前分数 + 1)
				</div>
				<div style="margin-top:8px;font-size:0.8rem;color:var(--text-secondary);">
					💡 <strong>保底机制</strong>：无论生成多少分，每次操作至少让分数+1
				</div>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--warning-color);margin:0 0 8px 0;">📈 分数期望值计算</h4>
				<table style="width:100%;font-size:0.8rem;border-collapse:collapse;">
					<tr style="background:var(--card-bg);">
						<th style="padding:6px;border-bottom:1px solid var(--border-color);">科研能力</th>
						<th style="padding:6px;border-bottom:1px solid var(--border-color);">期望基础分</th>
						<th style="padding:6px;border-bottom:1px solid var(--border-color);">分数范围</th>
					</tr>
					<tr><td style="padding:6px;text-align:center;">1</td><td style="padding:6px;text-align:center;">3.5</td><td style="padding:6px;text-align:center;">1~7</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;text-align:center;">5</td><td style="padding:6px;text-align:center;">7.5</td><td style="padding:6px;text-align:center;">3~13</td></tr>
					<tr><td style="padding:6px;text-align:center;">10</td><td style="padding:6px;text-align:center;">12.5</td><td style="padding:6px;text-align:center;">5~20</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;text-align:center;">15</td><td style="padding:6px;text-align:center;">17.5</td><td style="padding:6px;text-align:center;">8~28</td></tr>
					<tr><td style="padding:6px;text-align:center;">20</td><td style="padding:6px;text-align:center;">22.5</td><td style="padding:6px;text-align:center;">10~35</td></tr>
				</table>
				<div style="margin-top:8px;font-size:0.75rem;color:var(--text-secondary);">
					公式：期望值 = 科研能力 × 1.0 + 2.5（随机部分期望）
				</div>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--danger-color);margin:0 0 8px 0;">⏳ 分数衰减机制</h4>
				<div style="background:var(--card-bg);border-radius:8px;padding:10px;font-family:monospace;font-size:0.85rem;">
					每月衰减：idea分数-1，实验分数-1（写作不衰减）<br>
					最低衰减至：1
				</div>
				<div style="margin-top:8px;font-size:0.8rem;color:var(--text-secondary);">
					⚠️ <strong>设计思路</strong>：模拟科研时效性，热点会过时，需要及时投稿<br>
					💡 隐藏觉醒"预见未来热点"可以完全禁止衰减
				</div>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--success-color);margin:0 0 8px 0;">✨ Buff加成系统</h4>
				<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:0.8rem;">
					<div style="padding:8px;background:var(--card-bg);border-radius:6px;">
						<strong>加法Buff（叠加）</strong><br>
						• 看论文：下次idea+1<br>
						• 导师指点：idea+5<br>
						• 同学合作：实验+5<br>
						• 大牛合作：写作+8
					</div>
					<div style="padding:8px;background:var(--card-bg);border-radius:6px;">
						<strong>乘法Buff（叠加）</strong><br>
						• 大牛交流：idea×1.25<br>
						• 企业交流：实验×1.25<br>
						• AI Lab实习：实验×1.25
					</div>
				</div>
				<div style="margin-top:8px;font-size:0.75rem;color:var(--text-secondary);">
					计算顺序：先乘后加，即 最终分 = 基础分 × 乘数 + 加成
				</div>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:#e74c3c;margin:0 0 8px 0;">😰 Debuff惩罚系统</h4>
				<div style="font-size:0.8rem;">
					<div style="padding:8px;background:rgba(231,76,60,0.1);border-radius:6px;margin-bottom:6px;">
						<strong>疲劳累积</strong>（每连续操作5次触发）<br>
						• 灵感枯竭：下次想idea总分÷2<br>
						• 主机发烫：下次做实验总分÷2<br>
						• 无从下笔：下次写论文总分÷2
					</div>
					<div style="padding:8px;background:rgba(231,76,60,0.1);border-radius:6px;">
						<strong>松懈debuff</strong>（连续中稿3篇触发）<br>
						• 下月所有操作总分÷2<br>
						• 休息一个月自动消除
					</div>
				</div>
			</div>
			
			<div style="background:linear-gradient(135deg,rgba(0,184,148,0.1),rgba(85,239,196,0.1));border-radius:10px;padding:12px;">
				<h4 style="color:var(--success-color);margin:0 0 8px 0;">🎯 投稿分数参考</h4>
				<table style="width:100%;font-size:0.8rem;border-collapse:collapse;">
					<tr style="background:var(--card-bg);">
						<th style="padding:6px;">等级</th>
						<th style="padding:6px;">Poster参考</th>
						<th style="padding:6px;">Oral参考</th>
						<th style="padding:6px;">Best Paper</th>
					</tr>
					<tr><td style="padding:6px;text-align:center;color:#e74c3c;font-weight:bold;">A类</td><td style="padding:6px;text-align:center;">≥70</td><td style="padding:6px;text-align:center;">≥85</td><td style="padding:6px;text-align:center;">≥100</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;text-align:center;color:#f39c12;font-weight:bold;">B类</td><td style="padding:6px;text-align:center;">≥45</td><td style="padding:6px;text-align:center;">≥55</td><td style="padding:6px;text-align:center;">≥70</td></tr>
					<tr><td style="padding:6px;text-align:center;color:#27ae60;font-weight:bold;">C类</td><td style="padding:6px;text-align:center;">≥30</td><td style="padding:6px;text-align:center;">≥35</td><td style="padding:6px;text-align:center;">≥45</td></tr>
				</table>
				<div style="margin-top:8px;font-size:0.75rem;color:var(--text-secondary);">
					⚠️ 以上为参考值，实际录取受审稿人、会议热度等影响
				</div>
			</div>
		</div>`;
					break;
					
				case 'review':
					title = '📝 审稿机制详解';
					content = `
		<div style="max-height:60vh;overflow-y:auto;font-size:0.85rem;line-height:1.6;">
			<div style="background:linear-gradient(135deg,rgba(108,92,231,0.1),rgba(162,155,254,0.1));border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--primary-color);margin:0 0 8px 0;">👨‍🔬 审稿人类型与概率</h4>
				<table style="width:100%;font-size:0.8rem;border-collapse:collapse;">
					<tr style="background:var(--card-bg);">
						<th style="padding:6px;text-align:left;">类型</th>
						<th style="padding:6px;text-align:center;">概率</th>
						<th style="padding:6px;text-align:left;">特点</th>
					</tr>
					<tr><td style="padding:6px;">普通审稿人</td><td style="padding:6px;text-align:center;">40%</td><td style="padding:6px;font-size:0.75rem;">标准评审，可能给改进建议(+3)</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;color:var(--success-color);">心软审稿人</td><td style="padding:6px;text-align:center;">10%</td><td style="padding:6px;font-size:0.75rem;">宽松评审，看最高两项分数</td></tr>
					<tr><td style="padding:6px;color:var(--primary-color);">资深大牛</td><td style="padding:6px;text-align:center;">10%</td><td style="padding:6px;font-size:0.75rem;">重视idea(×2)，给高质量建议(+8)</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;color:var(--danger-color);">恶意小同行</td><td style="padding:6px;text-align:center;">10%</td><td style="padding:6px;font-size:0.75rem;">严苛评审，看最低两项，SAN-1</td></tr>
					<tr><td style="padding:6px;color:var(--warning-color);">GPT审稿人</td><td style="padding:6px;text-align:center;">20%</td><td style="padding:6px;font-size:0.75rem;">随机权重评审</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;color:var(--danger-color);">39问题审稿人</td><td style="padding:6px;text-align:center;">10%</td><td style="padding:6px;font-size:0.75rem;">只看最低分(×3)，SAN-1</td></tr>
				</table>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--warning-color);margin:0 0 8px 0;">📐 有效分计算公式</h4>
				<div style="font-size:0.8rem;background:var(--card-bg);border-radius:8px;padding:10px;font-family:monospace;">
					<div style="margin-bottom:6px;"><strong>普通/GPT审稿人：</strong></div>
					有效分 = idea×w1 + exp×w2 + write×w3<br>
					<span style="color:var(--text-secondary);">// w1,w2,w3随机，各在0.8~1.4之间，总和为3</span><br><br>
					
					<div style="margin-bottom:6px;"><strong>资深大牛：</strong></div>
					有效分 = idea×2 + exp×0.5 + write×0.5<br><br>
					
					<div style="margin-bottom:6px;"><strong>心软审稿人：</strong></div>
					有效分 = 最高分×1.5 + 次高分×1.5<br><br>
					
					<div style="margin-bottom:6px;"><strong>恶意小同行：</strong></div>
					有效分 = 最低分×1.5 + 次低分×1.5<br><br>
					
					<div style="margin-bottom:6px;"><strong>39问题审稿人：</strong></div>
					有效分 = 最低分×3
				</div>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--success-color);margin:0 0 8px 0;">🎯 录取阈值（A类为例）</h4>
				<table style="width:100%;font-size:0.8rem;border-collapse:collapse;">
					<tr style="background:var(--card-bg);">
						<th style="padding:6px;">审稿人</th>
						<th style="padding:6px;">Reject阈值</th>
						<th style="padding:6px;">Borderline阈值</th>
					</tr>
					<tr><td style="padding:6px;">普通/资深</td><td style="padding:6px;text-align:center;">&lt;50</td><td style="padding:6px;text-align:center;">&lt;80</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">心软</td><td style="padding:6px;text-align:center;">&lt;40</td><td style="padding:6px;text-align:center;">&lt;60</td></tr>
					<tr><td style="padding:6px;">GPT</td><td style="padding:6px;text-align:center;">&lt;40</td><td style="padding:6px;text-align:center;">&lt;90</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">恶意/39问题</td><td style="padding:6px;text-align:center;">&lt;70</td><td style="padding:6px;text-align:center;">&lt;100</td></tr>
				</table>
				<div style="margin-top:8px;font-size:0.75rem;color:var(--text-secondary);">
					判定：有效分 &lt; Reject阈值 → Reject(-1)；&lt; Borderline阈值 → Borderline(0)；否则 → Accept(+1)
				</div>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:#9b59b6;margin:0 0 8px 0;">⚖️ PC最终决定</h4>
				<div style="font-size:0.8rem;">
					<div style="padding:8px;background:var(--card-bg);border-radius:6px;margin-bottom:6px;">
						<strong>总审稿分 = 三位审稿人分数之和</strong><br>
						• ≥1：直接录用<br>
						• =0（Borderline）：根据概率判定（基础50%~70%）<br>
						• =-1：小概率录用（基础30%~50%）<br>
						• ≤-2：直接拒稿
					</div>
					<div style="padding:8px;background:rgba(253,203,110,0.15);border-radius:6px;">
						<strong>Borderline录取概率公式</strong><br>
						基础概率 = 等级基础(A:50%,B:60%,C:70%)<br>
						分数修正 = sigmoid((论文分-基准分)/范围) × 12%<br>
						最终概率 = 基础概率 + 分数修正
					</div>
				</div>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--info-color);margin:0 0 8px 0;">🌡️ 会议热度调整</h4>
				<div style="font-size:0.8rem;color:var(--text-secondary);">
					<p>当累计投稿≥1000篇时，系统会根据全球投稿数据动态调整录取难度：</p>
					<ul style="margin:5px 0;padding-left:20px;">
						<li><strong>热门会议</strong>（投稿&gt;平均150%）：录取阈值略微提高</li>
						<li><strong>冷门会议</strong>（投稿&lt;平均50%）：录取阈值略微降低</li>
					</ul>
					<p style="color:var(--warning-color);">设计思路：模拟真实会议的竞争程度差异</p>
				</div>
			</div>
			
			<div style="background:linear-gradient(135deg,rgba(0,184,148,0.1),rgba(85,239,196,0.1));border-radius:10px;padding:12px;">
				<h4 style="color:var(--success-color);margin:0 0 8px 0;">💡 提高中稿率的策略</h4>
				<ul style="font-size:0.8rem;margin:0;padding-left:20px;">
					<li>均衡发展三项分数，避免明显短板</li>
					<li>资深大牛重视idea，需要保证idea分数高</li>
					<li>遇到恶意审稿人时，最低分很关键</li>
					<li>社交达人觉醒可以改变审稿人分布（增加好审稿人概率）</li>
					<li>拒稿后论文会获得改进建议，可重投</li>
				</ul>
			</div>
		</div>`;
					break;
					
				case 'citation':
					title = '📈 引用增长公式';
					content = `
		<div style="max-height:60vh;overflow-y:auto;font-size:0.85rem;line-height:1.6;">
			<div style="background:linear-gradient(135deg,rgba(108,92,231,0.1),rgba(162,155,254,0.1));border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--primary-color);margin:0 0 8px 0;">📐 核心公式</h4>
				<div style="background:var(--card-bg);border-radius:8px;padding:12px;font-family:monospace;font-size:0.85rem;">
					<div style="color:var(--success-color);margin-bottom:8px;">// 每月引用增长计算</div>
					
					<strong>① 基础增速</strong><br>
					baseScore = max(0, 论文分数 - 2 × 发表月数)<br>
					baseGrowth = baseScore × 0.1<br><br>
					
					<strong>② 会议影响因子</strong><br>
					impactFactor = (该会议中稿均分/平均中稿均分) × (该会议投稿数/平均投稿数)<br>
					<span style="color:var(--text-secondary);">// 范围限制在 0.2 ~ 4.0</span><br><br>
					
					<strong>③ 推广倍率（加法叠加）</strong><br>
					promotionMultiplier = 1 + 各项加成之和<br><br>
					
					<strong>④ 最终增速</strong><br>
					finalGrowth = baseGrowth × impactFactor × promotionMultiplier
				</div>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--warning-color);margin:0 0 8px 0;">📊 推广加成明细</h4>
				<table style="width:100%;font-size:0.8rem;border-collapse:collapse;">
					<tr style="background:var(--card-bg);">
						<th style="padding:6px;text-align:left;">推广方式</th>
						<th style="padding:6px;text-align:center;">加成</th>
						<th style="padding:6px;text-align:center;">消耗</th>
					</tr>
					<tr><td style="padding:6px;">📄 挂arxiv</td><td style="padding:6px;text-align:center;color:var(--success-color);">+25%</td><td style="padding:6px;text-align:center;">SAN-3</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">💻 GitHub开源</td><td style="padding:6px;text-align:center;color:var(--success-color);">+50%</td><td style="padding:6px;text-align:center;">SAN-6</td></tr>
					<tr><td style="padding:6px;">📱 小红书宣传</td><td style="padding:6px;text-align:center;color:var(--success-color);">+25%</td><td style="padding:6px;text-align:center;">SAN-3</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">📰 量子位封面（仅A类）</td><td style="padding:6px;text-align:center;color:var(--success-color);">+100引用</td><td style="padding:6px;text-align:center;">金钱-10</td></tr>
				</table>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--accent-color);margin:0 0 8px 0;">🏆 录取类型加成</h4>
				<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;font-size:0.8rem;">
					<div style="padding:8px;background:var(--card-bg);border-radius:6px;text-align:center;">
						<div style="font-size:1.2rem;">📄</div>
						<strong>Poster</strong><br>
						<span style="color:var(--text-secondary);">基础倍率</span>
					</div>
					<div style="padding:8px;background:rgba(253,203,110,0.2);border-radius:6px;text-align:center;">
						<div style="font-size:1.2rem;">🎤</div>
						<strong>Oral</strong><br>
						<span style="color:var(--warning-color);">+50%</span>
					</div>
					<div style="padding:8px;background:rgba(253,121,168,0.2);border-radius:6px;text-align:center;">
						<div style="font-size:1.2rem;">🏆</div>
						<strong>Best Paper</strong><br>
						<span style="color:var(--accent-color);">+400%</span>
					</div>
				</div>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--info-color);margin:0 0 8px 0;">📉 分数衰减对引用的影响</h4>
				<div style="font-size:0.8rem;color:var(--text-secondary);">
					<p>公式中 <code>baseScore = max(0, 论文分数 - 2 × 发表月数)</code> 表示：</p>
					<ul style="margin:5px 0;padding-left:20px;">
						<li>论文发表后，基础分每月减少2点</li>
						<li>当基础分降到0时，引用增长停止</li>
						<li>高分论文的引用增长持续时间更长</li>
					</ul>
					<div style="margin-top:8px;padding:8px;background:var(--card-bg);border-radius:6px;">
						<strong>例：论文分数60</strong><br>
						可持续增长月数 = 60 ÷ 2 = 30个月<br>
						前10个月基础增速 = (60-20) × 0.1 = 4引用/月
					</div>
				</div>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--success-color);margin:0 0 8px 0;">🔢 引用增长示例</h4>
				<div style="background:var(--card-bg);border-radius:8px;padding:10px;font-size:0.8rem;">
					<strong>假设：A类Oral论文，分数80，会议影响因子1.2</strong><br>
					推广：arxiv + GitHub开源<br><br>
					
					第1个月计算：<br>
					• baseScore = 80 - 2×1 = 78<br>
					• baseGrowth = 78 × 0.1 = 7.8<br>
					• promotionMultiplier = 1 + 0.5(Oral) + 0.25(arxiv) + 0.5(GitHub) = 2.25<br>
					• finalGrowth = 7.8 × 1.2 × 2.25 = <strong style="color:var(--success-color);">21.06</strong> 引用
				</div>
			</div>
			
			<div style="background:linear-gradient(135deg,rgba(0,184,148,0.1),rgba(85,239,196,0.1));border-radius:10px;padding:12px;">
				<h4 style="color:var(--success-color);margin:0 0 8px 0;">💡 最大化引用的策略</h4>
				<ul style="font-size:0.8rem;margin:0;padding-left:20px;">
					<li><strong>追求高分投稿</strong>：论文分数直接决定引用增长速度和持续时间</li>
					<li><strong>争取Oral/Best Paper</strong>：提供50%~400%的永久加成</li>
					<li><strong>及时推广</strong>：arxiv+GitHub+小红书组合可达+100%加成</li>
					<li><strong>同门合作buff</strong>：随机事件中约定互挂可获得+100%加成</li>
					<li><strong>A类论文可用量子位</strong>：直接+100引用</li>
				</ul>
			</div>
		</div>`;
					break;
					
				case 'events':
					title = '🎲 事件系统';
					content = `
		<div style="max-height:60vh;overflow-y:auto;font-size:0.85rem;line-height:1.6;">
			<div style="background:linear-gradient(135deg,rgba(108,92,231,0.1),rgba(162,155,254,0.1));border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--primary-color);margin:0 0 8px 0;">📅 固定事件时间表</h4>
				<table style="width:100%;font-size:0.8rem;border-collapse:collapse;">
					<tr style="background:var(--card-bg);">
						<th style="padding:6px;">游戏月份</th>
						<th style="padding:6px;">现实对应</th>
						<th style="padding:6px;">事件</th>
					</tr>
					<tr><td style="padding:6px;text-align:center;">1月（第2年起）</td><td style="padding:6px;text-align:center;">9月</td><td style="padding:6px;">🎓 奖学金评定</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;text-align:center;">2月</td><td style="padding:6px;text-align:center;">10月</td><td style="padding:6px;">🎁 教师节</td></tr>
					<tr><td style="padding:6px;text-align:center;">5月</td><td style="padding:6px;text-align:center;">1月</td><td style="padding:6px;">❄️ 寒假（压岁钱+1，SAN+2）</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;text-align:center;">11月</td><td style="padding:6px;text-align:center;">7月</td><td style="padding:6px;">☀️ 暑假（SAN+3）</td></tr>
					<tr><td style="padding:6px;text-align:center;">12月</td><td style="padding:6px;text-align:center;">8月</td><td style="padding:6px;">📝 学年总结（四选一奖励）</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;text-align:center;">偶数月</td><td style="padding:6px;text-align:center;">-</td><td style="padding:6px;">🎲 随机事件</td></tr>
				</table>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--warning-color);margin:0 0 8px 0;">🎓 奖学金要求</h4>
				<table style="width:100%;font-size:0.8rem;border-collapse:collapse;">
					<tr style="background:var(--card-bg);">
						<th style="padding:6px;">年份</th>
						<th style="padding:6px;">科研分要求</th>
						<th style="padding:6px;">奖金</th>
					</tr>
					<tr><td style="padding:6px;text-align:center;">第2年</td><td style="padding:6px;text-align:center;">≥1</td><td style="padding:6px;text-align:center;">5金币</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;text-align:center;">第3年</td><td style="padding:6px;text-align:center;">≥3</td><td style="padding:6px;text-align:center;">5金币</td></tr>
					<tr><td style="padding:6px;text-align:center;">第4年</td><td style="padding:6px;text-align:center;">≥6</td><td style="padding:6px;text-align:center;">8金币</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;text-align:center;">第5年</td><td style="padding:6px;text-align:center;">≥9</td><td style="padding:6px;text-align:center;">8金币</td></tr>
				</table>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--success-color);margin:0 0 8px 0;">🎲 随机事件池（15种）</h4>
				<div style="font-size:0.8rem;display:grid;grid-template-columns:1fr 1fr;gap:6px;">
					<div style="padding:6px;background:var(--card-bg);border-radius:4px;">1. 指导本科生毕设</div>
					<div style="padding:6px;background:var(--card-bg);border-radius:4px;">2. 帮导师审稿</div>
					<div style="padding:6px;background:var(--card-bg);border-radius:4px;">3. 突然感冒</div>
					<div style="padding:6px;background:var(--card-bg);border-radius:4px;">4. 导师安排做项目</div>
					<div style="padding:6px;background:var(--card-bg);border-radius:4px;">5. 导师找你谈话</div>
					<div style="padding:6px;background:var(--card-bg);border-radius:4px;">6. 实验室组会</div>
					<div style="padding:6px;background:var(--card-bg);border-radius:4px;">7. 实验室团建</div>
					<div style="padding:6px;background:var(--card-bg);border-radius:4px;">8. 导师经费充足</div>
					<div style="padding:6px;background:var(--card-bg);border-radius:4px;">9. 学习新知识</div>
					<div style="padding:6px;background:var(--card-bg);border-radius:4px;">10. 同门找你合作</div>
					<div style="padding:6px;background:var(--card-bg);border-radius:4px;">11. 师兄师姐合作（社交≥6）</div>
					<div style="padding:6px;background:var(--card-bg);border-radius:4px;">12. 导师抢一作</div>
					<div style="padding:6px;background:var(--card-bg);border-radius:4px;">13. 服务器坏了</div>
					<div style="padding:6px;background:var(--card-bg);border-radius:4px;">14. 指导师弟师妹（有论文后）</div>
					<div style="padding:6px;background:var(--card-bg);border-radius:4px;">15. 玩游戏放松</div>
				</div>
				<div style="margin-top:8px;font-size:0.75rem;color:var(--text-secondary);">
					事件用完后会重置，每个事件每轮只触发一次
				</div>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--accent-color);margin:0 0 8px 0;">🎉 开会事件</h4>
				<div style="font-size:0.8rem;">
					<p>论文中稿后需要参加会议，选择参会方式：</p>
					<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin:8px 0;">
						<div style="padding:6px;background:var(--card-bg);border-radius:4px;text-align:center;">
							💰 自费<br><span style="color:var(--danger-color);">金钱-4</span>
						</div>
						<div style="padding:6px;background:var(--card-bg);border-radius:4px;text-align:center;">
							👨‍🏫 导师报销<br><span style="color:var(--danger-color);">好感-1/-2</span>
						</div>
						<div style="padding:6px;background:var(--card-bg);border-radius:4px;text-align:center;">
							👥 代参加<br><span style="color:var(--text-secondary);">社交≥6免费</span>
						</div>
					</div>
					<p><strong>会议活动选项</strong>（亲自参加时随机3选）：</p>
					<ul style="margin:5px 0;padding-left:20px;font-size:0.75rem;">
						<li>🏖️ 顺便旅游（SAN+6）</li>
						<li>☕ 茶歇+晚宴（SAN+1，社交+1）</li>
						<li>🔬 同行交流（下次实验×3次）</li>
						<li>💡 广泛交流（下次idea×3次）</li>
						<li>🌟 找大牛交流（idea×1.25）→可发展为联合培养</li>
						<li>🏢 找企业交流（实验×1.25）→3次后解锁AI Lab实习</li>
						<li>💕 和异性学者交流（社交≥6）→可发展为恋人</li>
					</ul>
				</div>
			</div>
			
			<div style="background:linear-gradient(135deg,rgba(0,184,148,0.1),rgba(85,239,196,0.1));border-radius:10px;padding:12px;">
				<h4 style="color:var(--success-color);margin:0 0 8px 0;">💡 事件系统设计思路</h4>
				<ul style="font-size:0.8rem;margin:0;padding-left:20px;">
					<li><strong>属性门槛机制</strong>：社交≥6/12解锁更多选项，好感≥6减少惩罚</li>
					<li><strong>风险收益平衡</strong>：高收益选项通常有更高风险或消耗</li>
					<li><strong>累积效应</strong>：多次与大牛/企业/异性交流可解锁特殊发展路线</li>
					<li><strong>随机性控制</strong>：事件池机制确保玩家能体验到所有事件</li>
				</ul>
			</div>
		</div>`;
					break;
					
				case 'buffs':
					title = '✨ Buff与Debuff';
					content = `
		<div style="max-height:60vh;overflow-y:auto;font-size:0.85rem;line-height:1.6;">
			<div style="background:linear-gradient(135deg,rgba(0,184,148,0.15),rgba(85,239,196,0.15));border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--success-color);margin:0 0 8px 0;">✨ 永久Buff（获取后一直生效）</h4>
				<table style="width:100%;font-size:0.8rem;border-collapse:collapse;">
					<tr style="background:var(--card-bg);">
						<th style="padding:6px;text-align:left;">来源</th>
						<th style="padding:6px;text-align:left;">效果</th>
					</tr>
					<tr><td style="padding:6px;">🪑 人体工学椅（10金）</td><td style="padding:6px;">每月SAN+1</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">⌨️ 机械键盘（8金）</td><td style="padding:6px;">写论文SAN消耗-1</td></tr>
					<tr><td style="padding:6px;">🖥️ 4K显示器（8金）</td><td style="padding:6px;">看论文SAN消耗-1</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">🖥️ GPU服务器（12金）</td><td style="padding:6px;">每次做实验多做1次</td></tr>
					<tr><td style="padding:6px;">🌟 联合培养（大牛深入合作）</td><td style="padding:6px;">每次写论文+8分</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">🏢 AI Lab实习（企业交流3次）</td><td style="padding:6px;">做实验×1.25，每月金+2，SAN-3</td></tr>
					<tr><td style="padding:6px;">💕 恋人-活泼型</td><td style="padding:6px;">每月SAN+3，金-1</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">💕 恋人-聪慧型</td><td style="padding:6px;">每次想idea/实验/写论文+1次，金-1</td></tr>
					<tr><td style="padding:6px;">📖 指点迷津（大牛拒稿）</td><td style="padding:6px;">每次想idea+1分</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">📚 学习新知识</td><td style="padding:6px;">对应操作+1分</td></tr>
				</table>
			</div>
			
			<div style="background:linear-gradient(135deg,rgba(116,185,255,0.15),rgba(162,155,254,0.15));border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--info-color);margin:0 0 8px 0;">⏱️ 临时Buff（使用后消失）</h4>
				<table style="width:100%;font-size:0.8rem;border-collapse:collapse;">
					<tr style="background:var(--card-bg);">
						<th style="padding:6px;text-align:left;">来源</th>
						<th style="padding:6px;text-align:left;">效果</th>
					</tr>
					<tr><td style="padding:6px;">📖 看论文</td><td style="padding:6px;">下次想idea+1分</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">🌟 大牛交流</td><td style="padding:6px;">下次想idea×1.25</td></tr>
					<tr><td style="padding:6px;">🏢 企业交流</td><td style="padding:6px;">下次做实验×1.25</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">🤝 同学合作</td><td style="padding:6px;">下次做实验+5分</td></tr>
					<tr><td style="padding:6px;">👨‍🎓 师兄指导</td><td style="padding:6px;">下次想idea+10分</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">💡 开会广泛交流</td><td style="padding:6px;">下次想idea多想3次</td></tr>
					<tr><td style="padding:6px;">🔬 开会同行交流</td><td style="padding:6px;">下次做实验多做3次</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">🤝 同门互挂</td><td style="padding:6px;">下篇中稿引用速度+100%</td></tr>
				</table>
			</div>
			
			<div style="background:linear-gradient(135deg,rgba(253,203,110,0.15),rgba(243,156,18,0.15));border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--warning-color);margin:0 0 8px 0;">🤖 本月订阅Buff（月末消失）</h4>
				<table style="width:100%;font-size:0.8rem;border-collapse:collapse;">
					<tr style="background:var(--card-bg);">
						<th style="padding:6px;">商品</th>
						<th style="padding:6px;">价格</th>
						<th style="padding:6px;">效果</th>
					</tr>
					<tr><td style="padding:6px;">Gemini订阅</td><td style="padding:6px;text-align:center;">2金</td><td style="padding:6px;">本月想idea SAN-1，+4分</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">GPT订阅</td><td style="padding:6px;text-align:center;">4金</td><td style="padding:6px;">本月做实验 SAN-1，+4分</td></tr>
					<tr><td style="padding:6px;">Claude订阅</td><td style="padding:6px;text-align:center;">3金</td><td style="padding:6px;">本月写论文 SAN-1，+4分</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">租GPU服务器</td><td style="padding:6px;text-align:center;">2金</td><td style="padding:6px;">本月做实验多做1次</td></tr>
				</table>
			</div>
			
			<div style="background:linear-gradient(135deg,rgba(231,76,60,0.15),rgba(192,57,43,0.15));border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--danger-color);margin:0 0 8px 0;">😰 Debuff（负面效果）</h4>
				<table style="width:100%;font-size:0.8rem;border-collapse:collapse;">
					<tr style="background:var(--card-bg);">
						<th style="padding:6px;text-align:left;">名称</th>
						<th style="padding:6px;text-align:left;">触发条件</th>
						<th style="padding:6px;text-align:left;">效果</th>
					</tr>
					<tr><td style="padding:6px;">💫 灵感枯竭</td><td style="padding:6px;">连续想idea 5次</td><td style="padding:6px;">下次想idea总分÷2</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">🔥 主机发烫</td><td style="padding:6px;">连续做实验 5次</td><td style="padding:6px;">下次做实验总分÷2</td></tr>
					<tr><td style="padding:6px;">✏️ 无从下笔</td><td style="padding:6px;">连续写论文 5次</td><td style="padding:6px;">下次写论文总分÷2</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">😴 松懈</td><td style="padding:6px;">连续中稿 3篇</td><td style="padding:6px;">下月所有操作总分÷2</td></tr>
					<tr><td style="padding:6px;">😈 被偷idea</td><td style="padding:6px;">同门学术交流50%</td><td style="padding:6px;">下次想idea总分÷2</td></tr>
				</table>
				<div style="margin-top:8px;font-size:0.75rem;color:var(--text-secondary);">
					💡 debuff在触发对应操作后自动消除；松懈debuff休息一个月可消除
				</div>
			</div>
			
			<div style="background:linear-gradient(135deg,rgba(0,184,148,0.1),rgba(85,239,196,0.1));border-radius:10px;padding:12px;">
				<h4 style="color:var(--success-color);margin:0 0 8px 0;">💡 Buff系统设计思路</h4>
				<ul style="font-size:0.8rem;margin:0;padding-left:20px;">
					<li><strong>叠加机制</strong>：同类型buff会叠加，乘法buff叠加为加法（两个×1.25 = ×1.5）</li>
					<li><strong>成就追踪</strong>：触发所有类型buff可获得"Buff之神"成就</li>
					<li><strong>策略性消耗</strong>：临时buff需要规划何时使用，配合订阅buff效果更佳</li>
					<li><strong>平衡设计</strong>：强力buff通常有消耗代价或获取条件</li>
				</ul>
			</div>
		</div>`;
					break;
					
				case 'characters':
					title = '👥 角色与觉醒系统';
					content = `
		<div style="max-height:60vh;overflow-y:auto;font-size:0.85rem;line-height:1.6;">
			<div style="background:linear-gradient(135deg,rgba(108,92,231,0.1),rgba(162,155,254,0.1));border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--primary-color);margin:0 0 8px 0;">☀️ 正位角色一览</h4>
				<div style="font-size:0.8rem;">
					${characters.map(c => `
					<div style="padding:8px;background:var(--card-bg);border-radius:6px;margin-bottom:6px;border-left:3px solid var(--primary-color);">
						<div style="display:flex;justify-content:space-between;align-items:center;">
							<strong>${c.icon} ${c.name}</strong>
							<span style="font-size:0.75rem;color:var(--text-secondary);">${c.bonus}</span>
						</div>
						<div style="font-size:0.75rem;color:var(--success-color);margin-top:4px;">
							⚡ 转博觉醒【${c.awakenName}】：${c.awakenDesc}
						</div>
						${c.hiddenAwakenName ? `
						<div style="font-size:0.75rem;color:#f39c12;margin-top:2px;">
							⚙️ 隐藏觉醒【${c.hiddenAwakenName}】：${c.hiddenAwakenDesc}
						</div>` : ''}
					</div>`).join('')}
				</div>
			</div>
			
			<div style="background:linear-gradient(135deg,rgba(155,89,182,0.1),rgba(231,76,60,0.1));border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:#9b59b6;margin:0 0 8px 0;">🌑 逆位角色一览</h4>
				<div style="font-size:0.8rem;">
					${characters.filter(c => c.reversed).map(c => `
					<div style="padding:8px;background:var(--card-bg);border-radius:6px;margin-bottom:6px;border-left:3px solid #9b59b6;">
						<div style="display:flex;justify-content:space-between;align-items:center;">
							<strong>${c.reversed.icon} ${c.reversed.name}</strong>
						</div>
						<div style="font-size:0.75rem;color:var(--text-secondary);margin-top:2px;">${c.reversed.bonus}</div>
						<div style="font-size:0.75rem;color:#e74c3c;margin-top:2px;">
							⚡ 逆位觉醒【${c.reversed.awakenName}】：${c.reversed.awakenDesc}
						</div>
					</div>`).join('')}
				</div>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--warning-color);margin:0 0 8px 0;">⚙️ 隐藏觉醒触发条件</h4>
				<table style="width:100%;font-size:0.8rem;border-collapse:collapse;">
					<tr style="background:var(--card-bg);">
						<th style="padding:6px;text-align:left;">角色</th>
						<th style="padding:6px;text-align:left;">隐藏觉醒条件</th>
					</tr>
					<tr><td style="padding:6px;">大多数</td><td style="padding:6px;">转博时科研、社交、好感都≤3</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">院士转世</td><td style="padding:6px;">转博时无A类和B类论文</td></tr>
					<tr><td style="padding:6px;">社交达人</td><td style="padding:6px;">转博时社交≤6</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">富可敌国</td><td style="padding:6px;">转博时金币≤2</td></tr>
					<tr><td style="padding:6px;">导师子女</td><td style="padding:6px;">转博时好感度≤6</td></tr>
					<tr style="background:var(--card-bg);"><td style="padding:6px;">天选之人</td><td style="padding:6px;">转博时科研=社交=好感（三项相等）</td></tr>
				</table>
				<div style="margin-top:8px;font-size:0.75rem;color:var(--text-secondary);">
					💡 满足条件时可在普通觉醒和隐藏觉醒之间选择
				</div>
			</div>
			
			<div style="background:linear-gradient(135deg,rgba(255,215,0,0.15),rgba(255,140,0,0.15));border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:#d68910;margin:0 0 8px 0;">🌟 真·大多数（隐藏角色）</h4>
				<div style="font-size:0.8rem;">
					<div style="padding:8px;background:var(--card-bg);border-radius:6px;">
						<strong>🌍 解锁条件</strong>：6个角色的正位和逆位模式都达到博士毕业（共12个）<br><br>
						<strong>角色特点</strong>：<br>
						• 无初始属性加成<br>
						• 无转博觉醒效果<br>
						• 一切靠自己<br><br>
						<strong>🏆 专属真实结局</strong>：<br>
						• 真·博士毕业：博士毕业且发表≥3篇论文<br>
						• 真·献身科研：博士毕业且总引用>2000
					</div>
				</div>
			</div>
			
			<div style="background:linear-gradient(135deg,rgba(0,184,148,0.1),rgba(85,239,196,0.1));border-radius:10px;padding:12px;">
				<h4 style="color:var(--success-color);margin:0 0 8px 0;">💡 角色选择建议</h4>
				<ul style="font-size:0.8rem;margin:0;padding-left:20px;">
					<li><strong>新手推荐</strong>：天选之人（全面发展）、院士转世（科研强势）</li>
					<li><strong>想快速毕业</strong>：院士转世（科研能力高，论文分数高）</li>
					<li><strong>想体验事件</strong>：社交达人（解锁更多选项）、导师子女（导师关系好）</li>
					<li><strong>想挑战高难度</strong>：逆位模式、真·大多数</li>
					<li><strong>隐藏觉醒流派</strong>：故意压低属性触发隐藏觉醒，获得独特能力</li>
				</ul>
			</div>
		</div>`;
					break;
					
				case 'strategy':
					title = '🎯 进阶策略攻略';
					content = `
		<div style="max-height:60vh;overflow-y:auto;font-size:0.85rem;line-height:1.6;">
			<div style="background:linear-gradient(135deg,rgba(108,92,231,0.1),rgba(162,155,254,0.1));border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--primary-color);margin:0 0 8px 0;">📈 开局策略（第1年）</h4>
				<div style="font-size:0.8rem;">
					<div style="padding:8px;background:var(--card-bg);border-radius:6px;margin-bottom:6px;">
						<strong>🎯 核心目标</strong>：科研分≥1（拿到第2年奖学金），属性提升到6
					</div>
					<div style="padding:8px;background:var(--card-bg);border-radius:6px;margin-bottom:6px;">
						<strong>📊 推荐节奏</strong>：<br>
						• 前3个月：看论文攒buff，科研能力低时想idea效率低<br>
						• 第4-6月：开始写第一篇论文，目标C类<br>
						• 第7-9月：投稿+准备第二篇<br>
						• 第10-12月：争取中稿，准备转博判定
					</div>
					<div style="padding:8px;background:var(--card-bg);border-radius:6px;">
						<strong>⚠️ 注意事项</strong>：<br>
						• 优先把科研提到6（解锁第2论文槽）<br>
						• 社交提到6（解锁更多事件选项）<br>
						• 保持SAN值≥5，避免崩溃<br>
						• 金钱留3-5备用，应对突发事件
					</div>
				</div>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--success-color);margin:0 0 8px 0;">📝 论文写作最优策略</h4>
				<div style="font-size:0.8rem;">
					<div style="padding:8px;background:var(--card-bg);border-radius:6px;margin-bottom:6px;">
						<strong>🔄 单篇论文流程</strong>：<br>
						1. 先攒buff（看论文、订阅AI工具）<br>
						2. 一口气想3-4次idea（配合buff）<br>
						3. 一口气做3-4次实验（租/买GPU）<br>
						4. 写2-3次论文<br>
						5. 立即投稿（避免衰减）
					</div>
					<div style="padding:8px;background:var(--card-bg);border-radius:6px;margin-bottom:6px;">
						<strong>📊 分数分配建议</strong>：<br>
						• 尽量均衡，避免短板被恶意审稿人抓住<br>
						• idea稍高一点（大牛审稿人重视idea）<br>
						• 投稿前总分目标：A类≥70，B类≥45，C类≥30
					</div>
					<div style="padding:8px;background:var(--card-bg);border-radius:6px;">
						<strong>⏰ 时机选择</strong>：<br>
						• 查看全球统计，选择投稿量较少的"冷门"会议<br>
						• 避免debuff期间投稿（先消化debuff）<br>
						• 转博前确保有论文在审，中稿可获得开会buff
					</div>
				</div>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--warning-color);margin:0 0 8px 0;">🔄 转博决策分析</h4>
				<div style="font-size:0.8rem;">
					<table style="width:100%;border-collapse:collapse;margin-bottom:8px;">
						<tr style="background:var(--card-bg);">
							<th style="padding:6px;">时机</th>
							<th style="padding:6px;">要求</th>
							<th style="padding:6px;">建议</th>
						</tr>
						<tr><td style="padding:6px;">第2年12月</td><td style="padding:6px;">科研分≥2</td><td style="padding:6px;">属性好就转，否则等</td></tr>
						<tr style="background:var(--card-bg);"><td style="padding:6px;">第3年12月</td><td style="padding:6px;">科研分≥3</td><td style="padding:6px;">最后机会，建议转</td></tr>
					</table>
					<div style="padding:8px;background:rgba(253,203,110,0.15);border-radius:6px;">
						<strong>💡 转博收益分析</strong>：<br>
						• 觉醒效果非常强力（属性翻倍/特殊能力）<br>
						• 博士工资更高（每月+3 vs +1）<br>
						• 有更多时间冲击高成就<br>
						• 解锁更高级结局（青椒、学术之星、未来院士）
					</div>
				</div>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--accent-color);margin:0 0 8px 0;">🏆 成就攻略精要</h4>
				<div style="font-size:0.8rem;">
					<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
						<div style="padding:6px;background:var(--card-bg);border-radius:4px;">
							<strong>💕 喜结良缘</strong><br>
							<span style="font-size:0.75rem;">社交≥12后多次与同一异性交流</span>
						</div>
						<div style="padding:6px;background:var(--card-bg);border-radius:4px;">
							<strong>🎯 百发百中</strong><br>
							<span style="font-size:0.75rem;">从不被拒稿（可只投C类保稳）</span>
						</div>
						<div style="padding:6px;background:var(--card-bg);border-radius:4px;">
							<strong>☕ 咖啡爱好者</strong><br>
							<span style="font-size:0.75rem;">每月都买冰美式</span>
						</div>
						<div style="padding:6px;background:var(--card-bg);border-radius:4px;">
							<strong>🏆 全收集</strong><br>
							<span style="font-size:0.75rem;">9种论文类型各中一篇</span>
						</div>
						<div style="padding:6px;background:var(--card-bg);border-radius:4px;">
							<strong>🧒 天才少年</strong><br>
							<span style="font-size:0.75rem;">转博时科研分已≥7</span>
						</div>
						<div style="padding:6px;background:var(--card-bg);border-radius:4px;">
							<strong>🔥 火力全开</strong><br>
							<span style="font-size:0.75rem;">4篇论文同时在审</span>
						</div>
					</div>
				</div>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:var(--danger-color);margin:0 0 8px 0;">⚠️ 常见失败原因</h4>
				<div style="font-size:0.8rem;">
					<div style="padding:8px;background:rgba(231,76,60,0.1);border-radius:6px;margin-bottom:6px;">
						<strong>1. SAN值崩溃</strong><br>
						原因：连续高强度操作、逆位大多数的SAN减少翻倍<br>
						对策：保持SAN≥8，购买人体工学椅，适时休息
					</div>
					<div style="padding:8px;background:rgba(231,76,60,0.1);border-radius:6px;margin-bottom:6px;">
						<strong>2. 金钱耗尽</strong><br>
						原因：过度消费、恋人开销、事件选择不当<br>
						对策：保持金钱≥3，打工补充，合理规划开支
					</div>
					<div style="padding:8px;background:rgba(231,76,60,0.1);border-radius:6px;margin-bottom:6px;">
						<strong>3. 导师关系破裂</strong><br>
						原因：多次拒绝导师安排、教师节不送礼<br>
						对策：好感度低时多配合导师，送礼挽回
					</div>
					<div style="padding:8px;background:rgba(231,76,60,0.1);border-radius:6px;">
						<strong>4. 论文质量不足</strong><br>
						原因：科研能力太低、分数衰减、短板明显<br>
						对策：先提升科研能力，攒buff后集中写作
					</div>
				</div>
			</div>
			
			<div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:12px;">
				<h4 style="color:#9b59b6;margin:0 0 8px 0;">🌑 逆位模式攻略</h4>
				<div style="font-size:0.8rem;">
					<div style="padding:8px;background:var(--card-bg);border-radius:6px;margin-bottom:6px;">
						<strong>怠惰之大多数</strong>：SAN减少翻倍，但每月回复+3<br>
						策略：减少消耗大的操作，利用高回复平衡
					</div>
					<div style="padding:8px;background:var(--card-bg);border-radius:6px;margin-bottom:6px;">
						<strong>愚钝之院士转世</strong>：科研=0，全论文槽<br>
						策略：靠转化获得金钱和SAN，多写低分论文刷量
					</div>
					<div style="padding:8px;background:var(--card-bg);border-radius:6px;margin-bottom:6px;">
						<strong>贪求之富可敌国</strong>：每月属性重置为1<br>
						策略：觉醒后变为半年重置+消费涨属性，疯狂花钱
					</div>
					<div style="padding:8px;background:var(--card-bg);border-radius:6px;">
						<strong>空想之天选之人</strong>：每月属性随机交换<br>
						策略：接受随机性，突破上限的属性会保留
					</div>
				</div>
			</div>
			
			<div style="background:linear-gradient(135deg,rgba(0,184,148,0.1),rgba(85,239,196,0.1));border-radius:10px;padding:12px;">
				<h4 style="color:var(--success-color);margin:0 0 8px 0;">🎯 最高结局路线</h4>
				<div style="font-size:0.8rem;">
					<div style="padding:10px;background:var(--card-bg);border-radius:6px;">
						<strong>👑 未来院士路线</strong>：<br>
						要求：A类≥5篇，引用>2000，联合培养<br><br>
						<strong>关键节点</strong>：<br>
						1. 第1年：C类保底拿奖学金，社交提到6<br>
						2. 第2年：冲A类，多参加开会认识大牛<br>
						3. 转博：触发觉醒，联合培养大牛<br>
						4. 博士期：稳定产出A类，做好推广涨引用<br>
						5. 毕业前：确保5篇A类+2000引用+联合培养<br><br>
						<strong>核心策略</strong>：<br>
						• 科研能力尽快到18（开全槽）<br>
						• 开会必须亲自去，发展大牛关系<br>
						• 每篇A类都做完整推广（arxiv+GitHub+小红书）<br>
						• Best Paper论文优先发展（引用×5）
					</div>
				</div>
			</div>
		</div>`;
					break;
					
				default:
					title = '❓ 未知类型';
					content = '<p>请选择有效的说明类型。</p>';
			}
			
			showModal(title, content, [{ text: '关闭', class: 'btn-primary', action: closeModal }]);
		}

        // ==================== 启动游戏 ====================
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
