<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç ”ç©¶ç”Ÿæ¨¡æ‹Ÿå™¨</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-color: #6c5ce7;
            --secondary-color: #a29bfe;
            --accent-color: #fd79a8;
            --success-color: #00b894;
            --warning-color: #fdcb6e;
            --danger-color: #e17055;
            --info-color: #74b9ff;
            --love-color: #ff6b9d;
            --light-bg: #f8f9fa;
            --card-bg: #ffffff;
            --text-primary: #2d3436;
            --text-secondary: #636e72;
            --border-color: #dfe6e9;
            --shadow: 0 4px 15px rgba(0,0,0,0.1);
            --shadow-hover: 0 8px 25px rgba(0,0,0,0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: var(--text-primary);
        }

        /* é€†ä½æš—è‰²ä¸»é¢˜ */
		body.reversed-theme {
			--primary-color: #9b59b6;
			--secondary-color: #8e44ad;
			--accent-color: #c0392b;
			--success-color: #27ae60;
			--warning-color: #f39c12;
			--danger-color: #e74c3c;
			--light-bg: #2c2c2c;
			--card-bg: #1a1a2e;
			--text-primary: #e0e0e0;
			--text-secondary: #a0a0a0;
			--border-color: #444;
			--achievement-text: #ffffff;
			--achievement-bg: #5b2c6f;
			--achievement-border: #d7bde2;
			--achievement-shadow: 0 2px 10px rgba(155, 89, 182, 0.5);
		}

        body.reversed-theme #start-screen {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
        }

        body.reversed-theme .start-container {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 1px solid #9b59b6;
            box-shadow: 0 0 30px rgba(155, 89, 182, 0.3);
        }

        body.reversed-theme .game-title {
            background: linear-gradient(135deg, #9b59b6, #e74c3c);
            -webkit-background-clip: text;
            background-clip: text;
        }

        body.reversed-theme .character-card {
            background: #16213e;
            border-color: #444;
        }

        body.reversed-theme .character-card:hover {
            border-color: #9b59b6;
            box-shadow: 0 0 15px rgba(155, 89, 182, 0.4);
        }

        body.reversed-theme .character-card.selected {
            border-color: #e74c3c;
            background: linear-gradient(135deg, rgba(155,89,182,0.2), rgba(231,76,60,0.2));
            box-shadow: 0 0 20px rgba(231, 76, 60, 0.4);
        }

        body.reversed-theme .game-intro {
            background: #16213e;
            border: 1px solid #444;
        }

        body.reversed-theme .panel {
            background: #1a1a2e;
            border: 1px solid #333;
        }

        body.reversed-theme .log-content,
        body.reversed-theme .shop-item,
        body.reversed-theme .research-stat,
        body.reversed-theme .paper-slot,
        body.reversed-theme .score-box {
            background: #16213e;
        }

        body.reversed-theme .log-entry {
            background: #0f0f23;
            border-left-color: #9b59b6;
        }

        body.reversed-theme .modal {
            background: #1a1a2e;
            border: 1px solid #9b59b6;
        }

        body.reversed-theme #global-stats-panel {
            background: #16213e;
        }

        body.reversed-theme .mode-toggle-container {
            background: #333;
        }

        body.reversed-theme .mode-toggle-btn.active {
            background: var(--card-bg);
        }

        body.reversed-theme .mode-description {
            background: #16213e;
        }
        
        /* è§’è‰²æ˜¾ç¤º */
        .character-display {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: var(--light-bg);
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .character-display:hover {
            background: var(--border-color);
        }

        .character-display .char-icon {
            font-size: 1.4rem;
        }

        .character-display .char-name {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-primary);
        }

        .character-display .char-mode {
            margin-left: auto;
            font-size: 0.65rem;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .character-display .char-mode.normal-mode {
            background: rgba(108, 92, 231, 0.15);
            color: #6c5ce7;
        }

        .character-display .char-mode.reversed-mode {
            background: rgba(155, 89, 182, 0.2);
            color: #9b59b6;
        }

        body.reversed-theme .character-display {
            background: #2d2d44;
        }

        body.reversed-theme .character-display:hover {
            background: #3d3d54;
        }

        /* é€†ä½æ¨¡å¼é…è‰²ä¼˜åŒ– */
        body.reversed-theme .graduation-info-compact .remaining-badge {
            background: linear-gradient(135deg, #7d6608, #9a7d0a);
            color: #ffeaa7;
        }

        body.reversed-theme .graduation-info-compact .date-badge {
            background: linear-gradient(135deg, #6c3483, #8e44ad);
            color: #e8daef;
        }

        body.reversed-theme .graduation-info-compact .target-badge {
            background: #2d2d44;
            color: #bb8fce;
            border: 1px solid #444;
        }

        body.reversed-theme .action-btn {
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        body.reversed-theme .action-btn:hover:not(:disabled) {
            border-color: rgba(255, 255, 255, 0.3);
        }

        body.reversed-theme .btn-primary {
            background: linear-gradient(135deg, #5b2c6f, #7d3c98);
            color: #e8daef;
        }

        body.reversed-theme .btn-success {
            background: linear-gradient(135deg, #145a32, #1e8449);
            color: #d5f5e3;
        }

        body.reversed-theme .btn-danger {
            background: linear-gradient(135deg, #8e44ad, #9b59b6);
            color: white;
            box-shadow: 0 2px 8px rgba(142, 68, 173, 0.4);
        }

        body.reversed-theme .btn-warning {
            background: linear-gradient(135deg, #9a7d0a, #b7950b);
            color: #1a1a2e;
            font-weight: 600;
        }

        body.reversed-theme .btn-info {
            background: linear-gradient(135deg, #1a5276, #2874a6);
            color: #d4e6f1;
        }

        body.reversed-theme .btn-accent {
            background: linear-gradient(135deg, #922b21, #b03a2e);
            color: #fadbd8;
        }

        body.reversed-theme .progress-fill.san {
            background: linear-gradient(90deg, #e74c3c, #f39c12);
        }

        body.reversed-theme .quick-btn.next-month-btn {
            background: linear-gradient(135deg, #8e44ad, #9b59b6);
        }

        body.reversed-theme .quick-btn.next-month-btn i {
            color: white;
        }

        body.reversed-theme .quick-btn {
            background: #2d2d44;
            color: #e0e0e0;
            border: 1px solid #444;
        }

        body.reversed-theme .quick-btn i {
            color: #bb8fce;
        }

        body.reversed-theme .gold-display {
            background: linear-gradient(135deg, #7d6608, #9a7d0a);
            color: #ffeaa7;
        }

        body.reversed-theme .gold-display .gold-info {
            color: #ffeaa7;
        }

        body.reversed-theme .gold-display .gold-info i {
            color: #f1c40f;
        }

        body.reversed-theme .reviewing-badge {
            background: #7d6608;
            color: #ffeaa7;
        }

        body.reversed-theme .reviewing-badge.grade-A {
            background: linear-gradient(135deg, #922b21, #c0392b);
            color: white;
        }

        body.reversed-theme .reviewing-badge.grade-B {
            background: linear-gradient(135deg, #7d6608, #9a7d0a);
            color: #ffeaa7;
        }

        body.reversed-theme .reviewing-badge.grade-C {
            background: linear-gradient(135deg, #1e8449, #27ae60);
            color: white;
        }

        body.reversed-theme .shop-item-price {
            color: #f1c40f;
        }

        body.reversed-theme .difficulty-badge {
            border: 1px solid rgba(255,255,255,0.2);
        }

        body.reversed-theme .difficulty-badge.legendary { 
            background: rgba(155,89,182,0.4); 
            color: #d7bde2; 
        }

        body.reversed-theme .difficulty-badge.nightmare { 
            background: rgba(231,76,60,0.4); 
            color: #f5b7b1; 
        }

        body.reversed-theme .difficulty-badge.expert { 
            background: rgba(230,126,34,0.4); 
            color: #fad7a0; 
        }

        body.reversed-theme .difficulty-badge.hard { 
            background: rgba(241,196,15,0.4); 
            color: #f9e79f; 
        }

        body.reversed-theme .difficulty-badge.normal { 
            background: rgba(52,152,219,0.4); 
            color: #aed6f1; 
        }

        body.reversed-theme .difficulty-badge.easy { 
            background: rgba(46,204,113,0.4); 
            color: #abebc6; 
        }

        body.reversed-theme .progress-bar {
            background: #333;
        }

        body.reversed-theme .attribute-label .value {
            color: #bb8fce;
        }

        body.reversed-theme .paper-promotions .btn[disabled] {
            background: #444 !important;
            color: #888 !important;
            border: none;
        }
		
		/* åŸºç¡€æˆå°±æ ·å¼ */
		.achievement-item {
			padding: 6px 12px;
			border-radius: 16px;
			font-size: 0.8rem;
			margin: 4px;
			display: inline-block;
			cursor: pointer;  /* â˜… æ–°å¢ï¼šæ‰‹å‹æŒ‡é’ˆ */
			transition: all 0.3s ease;  /* â˜… æ–°å¢ï¼šè¿‡æ¸¡åŠ¨ç”» */
		}

		/* æ­£ä½æ¨¡å¼æ ·å¼ */
		body:not(.reversed-theme) .achievement-item {
			background: linear-gradient(135deg, #fdcb6e33, #ffeaa733);
			color: #2d3436;
			border: 1px solid #fdcb6e;
		}

		/* â˜… æ–°å¢ï¼šæ­£ä½æ¨¡å¼æ‚¬åœæ•ˆæœ */
		body:not(.reversed-theme) .achievement-item:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(253, 203, 110, 0.5);
		}

		/* é€†ä½æ¨¡å¼æ ·å¼ */
		body.reversed-theme .achievement-item {
			background: linear-gradient(135deg, #6c3483, #4a235a);
			color: #ffffff;
			border: 1px solid #d7bde2;
			box-shadow: 0 2px 10px rgba(155, 89, 182, 0.5);
			font-weight: 500;
			text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
		}

		/* é€†ä½æ¨¡å¼æ‚¬åœæ•ˆæœ */
		body.reversed-theme .achievement-item:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(155, 89, 182, 0.5);
		}

		/* æœªè§£é”æˆå°± */
		body.reversed-theme .locked-achievement {
			background: #1e1525;
			color: #a0a0a0;
			border: 1px dashed #6c3483;
			opacity: 0.7;
		}	
		
		body.reversed-theme .achievement-item {
			transition: all 0.3s ease;
		}

		body.reversed-theme .achievement-item:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(155, 89, 182, 0.5);
		}

		body.reversed-theme .locked-achievement:hover {
			color: #c0c0c0 !important;
			border-style: solid;
		}

		/* å…¨çƒç»Ÿè®¡é¢æ¿ä¸­çš„æˆå°±/ç»“å±€æ ‡ç­¾ */
		.stats-tag {
			padding: 4px 8px;
			background: white;
			border-radius: 6px;
			font-size: 0.65rem;
			border: 1px solid var(--border-color);
		}

		.stats-tag strong {
			color: var(--success-color);
		}

		.stats-tag.ending-tag strong {
			color: var(--primary-color);
		}

		body.reversed-theme .stats-tag {
			background: #2d2d44;
			color: #e0e0e0;
			border-color: #555;
		}

		body.reversed-theme .stats-tag strong {
			color: #58d68d;
		}

		body.reversed-theme .stats-tag.ending-tag strong {
			color: #bb8fce;
		}

		/* æœªè§£é”æˆå°±æ ·å¼ */
		.locked-achievement-tag {
			padding: 4px 8px;
			background: #e0e0e0;
			border-radius: 15px;
			font-size: 0.75rem;
			color: #999;
			cursor: pointer;
			transition: all 0.3s ease;
		}

		.locked-achievement-tag:hover {
			background: #d0d0d0;
			color: #666;
		}

		body.reversed-theme .locked-achievement-tag {
			background: #3d3d5c;
			color: #a0a0a0;
			border: 1px dashed #6c3483;
		}

		body.reversed-theme .locked-achievement-tag:hover {
			background: #4d4d6c;
			color: #c0c0c0;
			border-color: #8e44ad;
		}

		/* å¼¹çª—å†…çš„ç»Ÿè®¡æ ‡ç­¾ */
		.modal-stats-tag {
			padding: 4px 8px;
			background: var(--light-bg);
			border-radius: 6px;
			font-size: 0.7rem;
			cursor: pointer;
			transition: all 0.3s ease;
		}

		.modal-stats-tag:hover {
			transform: translateY(-1px);
		}

		.modal-stats-tag strong {
			color: var(--success-color);
		}

		body.reversed-theme .modal-stats-tag {
			background: #2d2d44;
			color: #e0e0e0;
			border: 1px solid #444;
		}

		body.reversed-theme .modal-stats-tag strong {
			color: #58d68d;
		}		
		
		body.reversed-theme .meta-records {
			background: #2d2d44 !important;
		}

		body.reversed-theme .meta-records div[style*="border-bottom"] {
			border-color: #444 !important;
		}

        /* å¼¹çª—æ ·å¼ */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active { opacity: 1; visibility: visible; }

        .modal {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 25px;
            max-width: 550px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: var(--shadow-hover);
            transform: scale(0.8);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal { transform: scale(1); }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 15px;
            text-align: center;
        }

        .modal-content { margin-bottom: 15px; line-height: 1.7; font-size: 0.95rem; }

        .modal-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-family: inherit;
        }

        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow); }
        .btn:active:not(:disabled) { transform: translateY(0); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }

        .btn-primary { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; }
        .btn-success { background: linear-gradient(135deg, var(--success-color), #55efc4); color: white; }
        .btn-danger { background: linear-gradient(135deg, var(--danger-color), #fab1a0); color: white; }
        .btn-warning { background: linear-gradient(135deg, var(--warning-color), #ffeaa7); color: var(--text-primary); }
        .btn-info { background: linear-gradient(135deg, var(--info-color), #a0d2ff); color: white; }
        .btn-accent { background: linear-gradient(135deg, var(--accent-color), #ffb8d0); color: white; }

        /* å¼€å§‹ç•Œé¢ */
        #start-screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: background 0.5s ease;
        }

        .start-container {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px 30px;
            max-width: 850px;
            width: 100%;
            box-shadow: var(--shadow-hover);
            text-align: center;
            transition: all 0.5s ease;
        }

        .game-title {
            font-size: 2.2rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }

        .game-author {
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        /* æ¨¡å¼åˆ‡æ¢æŒ‰é’® */
        .mode-toggle-container {
            display: flex;
            justify-content: center;
            gap: 0;
            margin: 15px auto;
            background: var(--border-color);
            border-radius: 25px;
            padding: 4px;
            max-width: 280px;
        }

        .mode-toggle-btn {
            flex: 1;
            padding: 10px 25px;
            border: none;
            border-radius: 20px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            background: transparent;
            color: var(--text-secondary);
        }

        .mode-toggle-btn:hover {
            color: var(--text-primary);
        }

        .mode-toggle-btn.active {
            background: var(--card-bg);
            color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .mode-toggle-btn.active.reversed-active {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            box-shadow: 0 2px 15px rgba(155, 89, 182, 0.4);
        }

        .mode-description {
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 15px;
            padding: 8px 20px;
            background: var(--light-bg);
            border-radius: 20px;
            transition: all 0.3s ease;
        }

        .game-intro {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 20px;
            padding: 12px 15px;
            background: var(--light-bg);
            border-radius: 12px;
            text-align: left;
        }

        .game-intro p { margin-bottom: 3px; }

        .character-selection h3 {
            font-size: 1.1rem;
            color: var(--primary-color);
            margin-bottom: 12px;
        }

        .character-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        @media (max-width: 700px) {
            .character-grid { grid-template-columns: repeat(2, 1fr); }
        }

        .character-card {
            background: var(--light-bg);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .character-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
            border-color: var(--secondary-color);
        }

        .character-card.selected {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, rgba(108,92,231,0.1), rgba(162,155,254,0.1));
        }

        .character-card .icon { font-size: 1.8rem; margin-bottom: 5px; }
        .character-card .name { font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 3px; }
        .character-card .desc { font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 6px; line-height: 1.3; }
        .character-card .bonus {
            padding: 5px 8px;
            background: rgba(0,184,148,0.15);
            border-radius: 6px;
            font-size: 0.7rem;
            color: var(--success-color);
            font-weight: 500;
        }

        /* éš¾åº¦æ˜Ÿçº§æ ·å¼ */
        .difficulty-container {
            margin-top: 8px;
            padding: 6px 8px;
            background: rgba(241, 196, 15, 0.1);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .difficulty-stars {
            display: flex;
            align-items: center;
            gap: 1px;
        }

        .difficulty-stars i {
            font-size: 0.7rem;
            color: #f1c40f;
        }

        .difficulty-stars i.far {
            opacity: 0.6;
        }

        .difficulty-label {
            font-size: 0.65rem;
            color: var(--text-secondary);
        }

        .difficulty-badge {
            font-size: 0.6rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 8px;
        }

        .difficulty-badge.legendary { background: rgba(155,89,182,0.2); color: #9b59b6; }
        .difficulty-badge.nightmare { background: rgba(231,76,60,0.2); color: #e74c3c; }
        .difficulty-badge.expert { background: rgba(230,126,34,0.2); color: #e67e22; }
        .difficulty-badge.hard { background: rgba(241,196,15,0.2); color: #f39c12; }
        .difficulty-badge.normal { background: rgba(52,152,219,0.2); color: #3498db; }
        .difficulty-badge.easy { background: rgba(46,204,113,0.2); color: #27ae60; }
        .difficulty-badge.unknown { background: rgba(149,165,166,0.2); color: #95a5a6; }

        .start-btn { font-size: 1.1rem; padding: 12px 40px; }

        /* æ¸¸æˆä¸»ç•Œé¢ */
        #game-screen { display: none; min-height: 100vh; padding: 10px; }

        .game-container {
            display: grid;
            grid-template-columns: 260px 1fr 280px;
            gap: 10px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .panel {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 12px;
            box-shadow: var(--shadow);
        }

        .panel-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border-color);
        }

        .left-column { display: flex; flex-direction: column; gap: 10px; }
        .middle-column { display: flex; flex-direction: column; gap: 10px; }
        .right-column { display: flex; flex-direction: column; gap: 10px; }

        /* å±æ€§æ  */
        .attribute-bar { margin-bottom: 8px; }

        .attribute-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
            font-size: 0.8rem;
        }

        .attribute-label .name { 
            display: flex; 
            align-items: center; 
            gap: 4px; 
            cursor: help;
        }
        .attribute-label .value { font-weight: 600; color: var(--primary-color); }

        .progress-bar {
            height: 10px;
            background: var(--border-color);
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        .progress-fill.san { background: linear-gradient(90deg, #e17055, #fdcb6e); }
        .progress-fill.research { background: linear-gradient(90deg, #6c5ce7, #a29bfe); }
        .progress-fill.social { background: linear-gradient(90deg, #00b894, #55efc4); }
        .progress-fill.favor { background: linear-gradient(90deg, #fd79a8, #ffb8d0); }

        .gold-display {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
            border-radius: 8px;
            margin-top: 5px;
        }

        .gold-display .gold-info {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .gold-display .gold-info i { color: #d68910; font-size: 1rem; }

        /* Buffæ  */
        .buff-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            max-height: 80px;
            overflow-y: auto;
        }

        .buff-tag {
            padding: 3px 7px;
            border-radius: 12px;
            font-size: 0.65rem;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .buff-tag.permanent {
            background: linear-gradient(135deg, rgba(0,184,148,0.2), rgba(85,239,196,0.2));
            color: #00a878;
            border: 1px solid var(--success-color);
        }

        .buff-tag.temporary {
            background: linear-gradient(135deg, rgba(116,185,255,0.2), rgba(162,155,254,0.2));
            color: #4a90d9;
            border: 1px solid var(--info-color);
        }

        .buff-tag.debuff {
            background: linear-gradient(135deg, rgba(225,112,85,0.2), rgba(250,177,160,0.2));
            color: #d63031;
            border: 1px solid var(--danger-color);
        }

        .buff-tag.love {
            background: linear-gradient(135deg, rgba(255,107,157,0.2), rgba(255,182,193,0.3));
            color: var(--love-color);
            border: 1px solid var(--love-color);
        }

        /* ç§‘ç ”æˆæœæ  */
        .research-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-bottom: 8px;
        }

        .research-stat {
            padding: 5px;
            background: var(--light-bg);
            border-radius: 6px;
            text-align: center;
        }

        .research-stat .label { font-size: 0.65rem; color: var(--text-secondary); }
        .research-stat .value { font-size: 0.95rem; font-weight: 700; color: var(--primary-color); }

        .paper-list { max-height: 150px; overflow-y: auto; }

        .paper-item {
            padding: 8px;
            background: var(--light-bg);
            border-radius: 6px;
            margin-bottom: 6px;
            border-left: 3px solid var(--primary-color);
        }

        .paper-item.grade-A { border-left-color: #e17055; }
        .paper-item.grade-B { border-left-color: #fdcb6e; }
        .paper-item.grade-C { border-left-color: #00b894; }

        .paper-item .title { font-size: 0.75rem; font-weight: 500; margin-bottom: 3px; }
        .paper-item .meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        /* æ¯•ä¸šä¿¡æ¯æ  */
        .graduation-info-compact {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            flex-wrap: wrap;
        }

        .graduation-info-compact .date-time {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
        }

        .graduation-info-compact .date-badge {
            padding: 4px 10px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 6px;
            font-weight: 600;
        }

        .graduation-info-compact .remaining-badge {
            padding: 4px 10px;
            background: linear-gradient(135deg, var(--warning-color), #ffeaa7);
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.8rem;
        }

        .graduation-info-compact .target-badge {
            padding: 4px 10px;
            background: var(--light-bg);
            border-radius: 6px;
            font-size: 0.8rem;
            color: var(--primary-color);
            font-weight: 500;
        }

        /* æ¸¸æˆæ—¥å¿—æ  */
        .log-content {
            height: 320px;
            overflow-y: auto;
            padding: 8px;
            background: var(--light-bg);
            border-radius: 10px;
        }

        .log-entry {
            padding: 7px 9px;
            margin-bottom: 5px;
            border-radius: 6px;
            background: white;
            border-left: 3px solid var(--primary-color);
            font-size: 0.8rem;
        }

        .log-entry .date { font-weight: 600; color: var(--primary-color); font-size: 0.75rem; }
        .log-entry .event { color: var(--text-primary); margin: 2px 0; }
        .log-entry .result { color: var(--success-color); font-weight: 500; font-size: 0.75rem; }
        .log-entry.negative .result { color: var(--danger-color); }

        /* æ“ä½œæ  */
        .action-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }

        .action-btn {
            padding: 8px 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            font-size: 0.8rem;
        }

        .action-btn i { font-size: 1.1rem; }
        .action-btn span { line-height: 1.2; }

        .action-cost {
            font-size: 0.6rem;
            opacity: 0.9;
            margin-top: 1px;
        }

        /* è®ºæ–‡å·¥ä½œç«™ */
        .paper-slots { display: flex; flex-direction: column; gap: 10px; }

        .paper-slot {
            padding: 10px;
            background: var(--light-bg);
            border-radius: 10px;
            border: 2px dashed var(--border-color);
        }

        .paper-slot.active { border-style: solid; border-color: var(--primary-color); }
        .paper-slot.locked { opacity: 0.5; }

        .paper-slot .slot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .paper-slot .slot-title { font-weight: 600; color: var(--primary-color); font-size: 0.85rem; }
        .paper-slot .paper-title { font-size: 0.75rem; font-weight: 500; margin-bottom: 6px; word-break: break-word; }

        .paper-scores {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-bottom: 6px;
        }

        .score-box {
            text-align: center;
            padding: 5px;
            background: white;
            border-radius: 5px;
        }

        .score-box .label { font-size: 0.6rem; color: var(--text-secondary); }
        .score-box .value { font-size: 0.9rem; font-weight: 700; color: var(--primary-color); }

        .paper-total {
            text-align: center;
            padding: 5px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 5px;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .paper-actions { display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; }
        .paper-actions .btn { padding: 5px; font-size: 0.7rem; justify-content: center; }

        .new-paper-btn {
            width: 100%;
            padding: 15px;
            border: 2px dashed var(--primary-color);
            background: transparent;
            color: var(--primary-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            font-family: inherit;
        }

        .new-paper-btn:hover { background: rgba(108,92,231,0.1); }

        .reviewing-badge {
            display: inline-block;
            padding: 2px 6px;
            background: var(--warning-color);
            color: var(--text-primary);
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 500;
        }

        .reviewing-badge.grade-A {
            background: linear-gradient(135deg, #e17055, #fab1a0);
            color: white;
        }

        .reviewing-badge.grade-B {
            background: linear-gradient(135deg, #fdcb6e, #ffeaa7);
            color: var(--text-primary);
        }

        .reviewing-badge.grade-C {
            background: linear-gradient(135deg, #00b894, #55efc4);
            color: white;
        }

        /* å•†åº—æ ·å¼ */
        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            background: var(--light-bg);
            border-radius: 8px;
            margin-bottom: 6px;
        }

        .shop-item.disabled { opacity: 0.5; }

        .shop-item-info { flex: 1; }
        .shop-item-name { font-weight: 600; font-size: 0.85rem; }
        .shop-item-desc { font-size: 0.7rem; color: var(--text-secondary); }

        .shop-item-action {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .shop-item-price {
            color: #d68910;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .shop-item-action .btn {
            padding: 4px 10px;
            font-size: 0.75rem;
        }

        /* ç»Ÿè®¡é¢æ¿åˆ†éš” */
        .stats-section {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px dashed var(--border-color);
        }

        .stats-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        /* æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: var(--light-bg); border-radius: 2px; }
        ::-webkit-scrollbar-thumb { background: var(--secondary-color); border-radius: 2px; }

        @media (max-width: 1100px) { .game-container { grid-template-columns: 1fr; } }

        .hidden { display: none !important; }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .left-column { display: flex; flex-direction: column; }
            #graduation-panel { order: 1; }
            #attributes-panel { order: 3; }
            #research-panel { order: 2; }

            .middle-column { display: flex; flex-direction: column; }
            #action-panel { order: 1; }
            #buff-panel { order: 3; }
            #log-panel { order: 2; }

            .start-container { padding: 15px; margin: 10px; width: calc(100% - 20px); }
            .game-title { font-size: 1.6rem; }
            .game-intro { font-size: 0.8rem; padding: 10px; }
            .character-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; }
            .character-card { padding: 10px; }
            .character-card .icon { font-size: 1.5rem; }
            .character-card .name { font-size: 0.9rem; }
            .character-card .desc { font-size: 0.7rem; }
            .character-card .bonus { font-size: 0.65rem; padding: 4px 6px; }

            #game-screen { padding: 5px; }
            .game-container { grid-template-columns: 1fr; gap: 8px; }
            .panel { padding: 10px; border-radius: 12px; }
            .panel-title { font-size: 0.85rem; padding-bottom: 6px; margin-bottom: 8px; }

            .log-content { height: 200px; padding: 6px; }
            .action-grid { grid-template-columns: repeat(3, 1fr); gap: 5px; }
            .action-btn { padding: 12px 8px; font-size: 0.75rem; min-height: 60px; }

            .modal { max-width: 95%; max-height: 90vh; padding: 15px; }
            .modal-title { font-size: 1.1rem; }
            .modal-content { font-size: 0.85rem; }
        }

        @media (max-width: 400px) {
            .character-grid { grid-template-columns: 1fr; }
            .action-grid { grid-template-columns: repeat(2, 1fr); }
        }

        /* ç§»åŠ¨ç«¯åº•éƒ¨å¿«æ·æ  */
        .mobile-quick-bar {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            padding: 8px 5px;
            z-index: 100;
            justify-content: space-around;
        }

        .quick-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 8px 12px;
            border: none;
            background: var(--light-bg);
            border-radius: 8px;
            font-size: 0.7rem;
            color: var(--text-primary);
            cursor: pointer;
            font-family: inherit;
        }

        .quick-btn i { font-size: 1.1rem; color: var(--primary-color); }
        .quick-btn.next-month-btn { background: linear-gradient(135deg, var(--danger-color), #fab1a0); color: white; }
        .quick-btn.next-month-btn i { color: white; }

        @media (max-width: 768px) {
            .mobile-quick-bar.game-active { display: flex; }
            #game-screen { padding-bottom: 70px; }
        }
    </style>
</head>


<body>
    <!-- å¼€å§‹ç•Œé¢ -->
    <div id="start-screen">
        <div class="start-container">
            <h1 class="game-title">ğŸ“ ç ”ç©¶ç”Ÿæ¨¡æ‹Ÿå™¨v2.0</h1>
            <p class="game-author">
                ä½œè€…ï¼š<a href="https://xhslink.com/m/A2DFslJF4mb" target="_blank" style="color:var(--primary-color);text-decoration:none;">è½æ˜Ÿå³¦</a>
                &nbsp;|&nbsp;
                é¡¹ç›®ï¼š<a href="https://github.com/kw66/PhD_Simulator" target="_blank" style="color:var(--primary-color);text-decoration:none;">GitHub</a>
                &nbsp;|&nbsp;
                æµ‹è¯•ï¼šé›æ –æ¹–
            </p>
            
            <!-- æ¨¡å¼åˆ‡æ¢æŒ‰é’® -->
            <div class="mode-toggle-container">
                <button class="mode-toggle-btn active" id="normal-mode-btn" onclick="switchMode(false)">
                    â˜€ï¸ æ­£ä½
                </button>
                <button class="mode-toggle-btn" id="reversed-mode-btn" onclick="switchMode(true)">
                    ğŸŒ‘ é€†ä½
                </button>
            </div>
            
            <div class="mode-description" id="mode-description">
                ğŸ“š ç»å…¸æ¨¡å¼ï¼Œä½“éªŒæ ‡å‡†çš„ç ”ç©¶ç”Ÿç”Ÿæ¶¯
            </div>
            
            <div class="game-intro" id="game-intro">
                <p>ğŸ“š <strong>æ¬¢è¿æ¥åˆ°ç ”ç©¶ç”Ÿæ¨¡æ‹Ÿå™¨ï¼</strong>ä½“éªŒç ”ç©¶ç”Ÿç”Ÿæ¶¯ï¼Œå¹³è¡¡ç§‘ç ”ã€ç”Ÿæ´»å’Œäººé™…å…³ç³»ï¼ŒåŠªåŠ›å‘è¡¨è®ºæ–‡ï¼Œæœ€ç»ˆé¡ºåˆ©æ¯•ä¸šã€‚</p>
                <p>ğŸ¯ <strong>æ¸¸æˆç›®æ ‡</strong>ï¼šç¡•å£«æ¯•ä¸šç§‘ç ”åˆ†â‰¥1ï¼ˆ3å¹´ï¼‰ï¼Œåšå£«æ¯•ä¸šç§‘ç ”åˆ†â‰¥7ï¼ˆ5å¹´ï¼‰</p>
                <p>ğŸ“ <strong>è®ºæ–‡ç§‘ç ”åˆ†</strong>ï¼šAç±»=4åˆ†ï¼ŒBç±»=2åˆ†ï¼ŒCç±»=1åˆ†</p>
                <p>ğŸ’¡ <strong>å±æ€§å½±å“</strong>ï¼šç§‘ç ”èƒ½åŠ›å½±å“è®ºæ–‡åˆ†æ•°ï¼›ç¤¾äº¤èƒ½åŠ›å’Œå¯¼å¸ˆå¥½æ„Ÿåº¦å½±å“äº‹ä»¶é€‰é¡¹å’Œç»“æœã€‚<strong>å»ºè®®ä¼˜å…ˆå°†å±æ€§æå‡è‡³6ä»¥è§£é”æ›´å¤šé€‰é¡¹ï¼</strong></p>
                <p>âš ï¸ <strong>æ³¨æ„</strong>ï¼šä¿æŒSANå€¼ã€å¯¼å¸ˆå¥½æ„Ÿåº¦å’Œé‡‘é’±ä¸ºæ­£æ•°ï¼Œå¦åˆ™å°†è§¦å‘ä¸è‰¯ç»“å±€ï¼</p>
            </div>

            <div class="character-selection">
                <h3 id="selection-title"><i class="fas fa-users"></i> é€‰æ‹©ä½ çš„è§’è‰²</h3>
                <div class="character-grid" id="character-grid"></div>
            </div>

            <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
                <button class="btn btn-primary start-btn" id="start-btn" disabled>
                    <i class="fas fa-play"></i> å¼€å§‹æ–°çš„ç”Ÿæ¶¯
                </button>
                <button class="btn btn-warning start-btn" onclick="openLoadModalFromStart()">
                    <i class="fas fa-folder-open"></i> è¯»å–å­˜æ¡£
                </button>
            </div>

            <!-- è®¿é—®ç»Ÿè®¡ -->
            <div id="visitor-stats" style="text-align:center;font-size:0.75rem;color:var(--text-secondary);margin-top:20px;padding-top:15px;border-top:1px solid var(--border-color);">
                <span id="busuanzi_container_site_pv" style="display:inline;">
                    ğŸ“Š æ€»è®¿é—® <span id="busuanzi_value_site_pv" style="color:var(--primary-color);font-weight:600;">-</span> æ¬¡
                </span> 
                &nbsp;|&nbsp; 
                <span id="busuanzi_container_site_uv" style="display:inline;">
                    ğŸ‘¥ è®¿å®¢ <span id="busuanzi_value_site_uv" style="color:var(--primary-color);font-weight:600;">-</span> äºº
                </span>
                &nbsp;|&nbsp; 
                <span id="total-games-container" style="display:inline;">
                    ğŸ® æ¸¸ç© <span id="total-games-value" style="color:var(--primary-color);font-weight:600;">-</span> å±€
                </span>
            </div>

            <!-- å…¨çƒç»Ÿè®¡é¢æ¿ -->
            <div id="global-stats-panel" style="margin-top:20px;padding:15px;background:var(--light-bg);border-radius:12px;display:none;">
                <h4 style="font-size:0.95rem;color:var(--primary-color);margin-bottom:12px;text-align:center;">
                    <i class="fas fa-chart-pie"></i> å…¨çƒç©å®¶ç»Ÿè®¡
                </h4>
                <div id="stats-loading" style="text-align:center;color:var(--text-secondary);font-size:0.85rem;">
                    <i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...
                </div>
                <div id="stats-content" style="display:none;">
                    <!-- æ­£ä½ç»Ÿè®¡ -->
                    <div class="stats-section" id="normal-stats-section">
                        <div style="font-size:0.85rem;font-weight:600;margin-bottom:8px;color:#6c5ce7;">â˜€ï¸ æ­£ä½æ¨¡å¼</div>
                        <div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:6px;">ç»“å±€ç»Ÿè®¡</div>
                        <div id="normal-ending-stats" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;"></div>
                        <div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:6px;">æˆå°±ç»Ÿè®¡</div>
                        <div id="normal-achievement-stats" style="display:flex;flex-wrap:wrap;gap:6px;"></div>
                    </div>
                    <!-- é€†ä½ç»Ÿè®¡ -->
                    <div class="stats-section" id="reversed-stats-section">
                        <div style="font-size:0.85rem;font-weight:600;margin-bottom:8px;color:#9b59b6;">ğŸŒ‘ é€†ä½æ¨¡å¼</div>
                        <div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:6px;">ç»“å±€ç»Ÿè®¡</div>
                        <div id="reversed-ending-stats" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;"></div>
                        <div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:6px;">æˆå°±ç»Ÿè®¡</div>
                        <div id="reversed-achievement-stats" style="display:flex;flex-wrap:wrap;gap:6px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¸¸æˆä¸»ç•Œé¢ -->
    <div id="game-screen">
        <div class="game-container">
            <!-- å·¦ä¾§æ  -->
            <div class="left-column">
                <!-- æ¯•ä¸šä¿¡æ¯æ  -->
                <div class="panel" id="graduation-panel">
                    <div class="panel-title">
                        <i class="fas fa-graduation-cap"></i> æ¯•ä¸šä¿¡æ¯
                        <div style="margin-left:auto;display:flex;gap:5px;">
                            <button class="btn btn-info" style="padding:3px 8px;font-size:0.7rem;" onclick="openSaveModal()"><i class="fas fa-save"></i> å­˜æ¡£</button>
                            <button class="btn btn-warning" style="padding:3px 8px;font-size:0.7rem;" onclick="openLoadModal()"><i class="fas fa-folder-open"></i> è¯»æ¡£</button>
                        </div>
                    </div>
                    <div class="graduation-info-compact">
                        <div class="date-time">
                            <span class="date-badge">ç¬¬<span id="current-year">1</span>å¹´<span id="current-month">1</span>æœˆ</span>
                            <span class="remaining-badge"><i class="fas fa-hourglass-half"></i> å‰©ä½™<span id="remaining-time">36</span>æœˆ</span>
                        </div>
                        <span class="target-badge" id="graduation-target">ğŸ¯ ç¡•å£«ï¼šç§‘ç ”åˆ†â‰¥1</span>
                        <button class="btn btn-danger" style="padding:3px 10px;font-size:0.7rem;" onclick="confirmRestart()"><i class="fas fa-redo"></i> é‡å¼€</button>
                    </div>
                </div>

                <!-- å±æ€§æ  -->
                <div class="panel" id="attributes-panel">
                    <div class="panel-title"><i class="fas fa-chart-bar"></i> ä¸ªäººå±æ€§</div>

                    <div class="character-display" id="character-display" onclick="showCharacterDetail()" style="cursor:pointer;">
                        <span class="char-icon" id="char-icon">ğŸ‘¤</span>
                        <span class="char-name" id="char-name">-</span>
                        <span class="char-mode" id="char-mode"></span>
                        <i class="fas fa-info-circle" style="margin-left:auto;color:var(--text-secondary);font-size:0.75rem;"></i>
                    </div>
                    
                    <div class="attribute-bar">
                        <div class="attribute-label">
                            <span class="name" title="ç²¾ç¥çŠ¶æ€ï¼Œé™ä¸ºè´Ÿæ•°åˆ™ä¸å ªé‡è´Ÿ"><i class="fas fa-brain"></i> SANå€¼</span>
                            <span class="value"><span id="san-value">20</span>/<span id="san-max">20</span></span>
                        </div>
                        <div class="progress-bar"><div class="progress-fill san" id="san-bar"></div></div>
                    </div>
                    <div class="attribute-bar">
                        <div class="attribute-label">
                            <span class="name" title="å½±å“è®ºæ–‡åˆ†æ•°ç”Ÿæˆï¼Œè¾¾åˆ°6/12/18è§£é”æ–°è®ºæ–‡æ§½"><i class="fas fa-flask"></i> ç§‘ç ”èƒ½åŠ›</span>
                            <span class="value"><span id="research-value">1</span>/20</span>
                        </div>
                        <div class="progress-bar"><div class="progress-fill research" id="research-bar"></div></div>
                    </div>
                    <div class="attribute-bar">
                        <div class="attribute-label">
                            <span class="name" title="å½±å“äº‹ä»¶é€‰é¡¹å’Œç»“æœï¼Œè¾¾åˆ°6/12è§£é”æ›´å¤šé€‰é¡¹"><i class="fas fa-users"></i> ç¤¾äº¤èƒ½åŠ›</span>
                            <span class="value"><span id="social-value">1</span>/20</span>
                        </div>
                        <div class="progress-bar"><div class="progress-fill social" id="social-bar"></div></div>
                    </div>
                    <div class="attribute-bar">
                        <div class="attribute-label">
                            <span class="name" title="å½±å“äº‹ä»¶é€‰é¡¹å’Œç»“æœï¼Œé™ä¸ºè´Ÿæ•°åˆ™è¢«é€€å­¦"><i class="fas fa-heart"></i> å¯¼å¸ˆå¥½æ„Ÿåº¦</span>
                            <span class="value"><span id="favor-value">1</span>/20</span>
                        </div>
                        <div class="progress-bar"><div class="progress-fill favor" id="favor-bar"></div></div>
                    </div>
                    <div class="gold-display">
                        <div class="gold-info"><i class="fas fa-coins"></i><span><span id="gold-value">1</span> é‡‘å¸</span></div>
                        <button class="btn btn-warning" style="padding:5px 10px;font-size:0.75rem;" onclick="openShop()"><i class="fas fa-store"></i> å•†åº—</button>
                    </div>
                </div>

                <!-- ç§‘ç ”æˆæœæ  -->
                <div class="panel" id="research-panel">
                    <div class="panel-title"><i class="fas fa-award"></i> ç§‘ç ”æˆæœ</div>
                    <div class="research-summary">
                        <div class="research-stat"><div class="label">Aç±»</div><div class="value" id="paper-a-count">0</div></div>
                        <div class="research-stat"><div class="label">Bç±»</div><div class="value" id="paper-b-count">0</div></div>
                        <div class="research-stat"><div class="label">Cç±»</div><div class="value" id="paper-c-count">0</div></div>
                        <div class="research-stat"><div class="label">ç§‘ç ”åˆ†</div><div class="value" id="total-score">0</div></div>
                        <div class="research-stat"><div class="label">æ€»å¼•ç”¨</div><div class="value" id="total-citations">0</div></div>
                        <div class="research-stat"><div class="label">è®ºæ–‡æ•°</div><div class="value" id="paper-total-count">0</div></div>
                    </div>
                    <div style="font-size:0.65rem;color:var(--text-secondary);margin-bottom:6px;text-align:center;">Aç±»=4åˆ† Bç±»=2åˆ† Cç±»=1åˆ†</div>
                    <div class="paper-list" id="published-papers">
                        <p style="color:var(--text-secondary);font-size:0.75rem;text-align:center;">æš‚æ— å·²å‘è¡¨è®ºæ–‡</p>
                    </div>
                </div>
            </div>

            <!-- ä¸­é—´æ  -->
            <div class="middle-column">
                <!-- æ¸¸æˆæ—¥å¿—æ  -->
                <div class="panel" id="log-panel" style="flex:1;">
                    <div class="panel-title">
                        <i class="fas fa-scroll"></i> æ¸¸æˆæ—¥å¿—
                        <span id="event-preview" style="margin-left:auto;font-size:0.7rem;font-weight:400;color:var(--text-secondary);"></span>
                    </div>
                    <div class="log-content" id="log-content"></div>
                </div>

                <!-- å¢ç›Š/å‡ç›Šæ•ˆæœæ  -->
                <div class="panel" id="buff-panel">
                    <div class="panel-title"><i class="fas fa-magic"></i> å¢ç›Š/å‡ç›Šæ•ˆæœ</div>
                    <div class="buff-list" id="buff-list"><span style="color:var(--text-secondary);font-size:0.8rem;">æš‚æ— æ•ˆæœ</span></div>
                </div>

                <!-- æ“ä½œæ  -->
                <div class="panel" id="action-panel">
                    <div class="panel-title"><i class="fas fa-gamepad"></i> æ“ä½œ</div>
                    <div class="action-grid">
                        <button class="btn btn-info action-btn" id="btn-read" onclick="readPaper()"><i class="fas fa-book-open"></i><span>çœ‹è®ºæ–‡</span></button>
                        <button class="btn btn-warning action-btn" id="btn-work" onclick="partTimeJob()"><i class="fas fa-briefcase"></i><span>æ‰“å·¥</span></button>
                        <button class="btn btn-accent action-btn" id="btn-idea" onclick="thinkIdea()"><i class="fas fa-lightbulb"></i><span>æƒ³idea</span></button>
                        <button class="btn btn-primary action-btn" id="btn-experiment" onclick="doExperiment()"><i class="fas fa-vial"></i><span>åšå®éªŒ</span></button>
                        <button class="btn btn-success action-btn" id="btn-write" onclick="writePaper()"><i class="fas fa-pen-fancy"></i><span>å†™è®ºæ–‡</span></button>
                        <button class="btn btn-danger action-btn" id="btn-next" onclick="nextMonth()"><i class="fas fa-forward"></i><span>ä¸‹ä¸€æœˆ</span></button>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§æ  -->
            <div class="right-column">
                <div class="panel" id="workstation-panel">
                    <div class="panel-title"><i class="fas fa-file-alt"></i> è®ºæ–‡å·¥ä½œç«™</div>
                    <div class="paper-slots" id="paper-slots"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼¹çª— -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal" id="modal">
            <h3 class="modal-title" id="modal-title">æ ‡é¢˜</h3>
            <div class="modal-content" id="modal-content">å†…å®¹</div>
            <div class="modal-buttons" id="modal-buttons"></div>
        </div>
    </div>

    <!-- ç§»åŠ¨ç«¯åº•éƒ¨å¿«æ·æ  -->
    <div class="mobile-quick-bar" id="mobile-quick-bar">
        <button class="quick-btn" onclick="scrollToPanel('action-panel')">
            <i class="fas fa-gamepad"></i>
            <span>æ“ä½œ</span>
        </button>
        <button class="quick-btn" onclick="scrollToPanel('workstation-panel')">
            <i class="fas fa-file-alt"></i>
            <span>è®ºæ–‡</span>
        </button>
        <button class="quick-btn" onclick="scrollToPanel('attributes-panel')">
            <i class="fas fa-chart-bar"></i>
            <span>å±æ€§</span>
        </button>
        <button class="quick-btn" onclick="openShop()">
            <i class="fas fa-store"></i>
            <span>å•†åº—</span>
        </button>
        <button class="quick-btn next-month-btn" onclick="nextMonth()">
            <i class="fas fa-forward"></i>
            <span>ä¸‹æœˆ</span>
        </button>
    </div>
    <script>
	
        // ==================== æ¸¸æˆæ•°æ® ====================
        const characters = [
            { 
                id: 'normal', 
                name: 'å¤§å¤šæ•°', 
                icon: 'ğŸ‘¤', 
                awakenIcon: 'ğŸ”¥',
                desc: 'èŠ¸èŠ¸ä¼—ç”Ÿä¸­çš„æ™®é€šä¸€å‘˜', 
                bonus: 'æ— ç‰¹æ®Šèƒ½åŠ›', 
                awakenName: 'æˆ‘å‘½ç”±æˆ‘ä¸ç”±å¤©',
                awakenDesc: 'è½¬åšæ—¶æ‰€æœ‰å±æ€§Ã—2', 
                stats: { research: 0, social: 0, favor: 0, gold: 0 },
                reversed: {
                    name: 'æ€ æƒ°ä¹‹ã€Šå¤§å¤šæ•°ã€‹',
                    icon: 'ğŸ˜´',
                    awakenIcon: 'ğŸ’€',
                    desc: 'æ‡’æƒ°æ˜¯åŸç½ªï¼Œä¹Ÿæ˜¯æŠ¤ç›¾',
                    bonus: 'SANå‡å°‘ç¿»å€ï¼Œåˆå§‹å±æ€§å…¨5ï¼Œæ¯æœˆSAN+3',
                    awakenName: 'æè‡´æ€ æƒ°',
                    awakenDesc: 'è½¬åšæ—¶å±æ€§ç¿»å€ã€‚SANå‡å°‘3å€ï¼Œæ¯æœˆSAN+5',
                    stats: { research: 4, social: 4, favor: 4, gold: 4 }
                }
            },
            { 
                id: 'genius', 
                name: 'é™¢å£«è½¬ä¸–', 
                icon: 'ğŸ”¬', 
                awakenIcon: 'ğŸ§¬',
                desc: 'å¤©ç”Ÿå°±æ˜¯åšç§‘ç ”çš„æ–™', 
                bonus: 'ç§‘ç ”èƒ½åŠ›åˆå§‹+5', 
                awakenName: 'å­¦æœ¯å¤©èµ‹è§‰é†’',
                awakenDesc: 'è½¬åšæ—¶æ¯æœ‰1ç¯‡Aç±»è®ºæ–‡ï¼Œç§‘ç ”+2',
                stats: { research: 5 },
                reversed: {
                    name: 'æ„šé’ä¹‹ã€Šé™¢å£«è½¬ä¸–ã€‹',
                    icon: 'ğŸ¤¡',
                    awakenIcon: 'ğŸ­',
                    desc: 'ç§‘ç ”æ˜¯ä»€ä¹ˆï¼Ÿèƒ½åƒå—ï¼Ÿ',
                    bonus: 'ç§‘ç ”å›ºå®š0ï¼Œå…¨è®ºæ–‡æ§½ï¼Œç§‘ç ”æå‡â†’SAN+4,é‡‘+4',
                    awakenName: 'å¤§æ™ºè‹¥æ„š',
                    awakenDesc: 'ç§‘ç ”æå‡â†’SAN+6,é‡‘+6,å¥½æ„Ÿ+2,ç¤¾äº¤+2',
                    stats: {}
                }
            },
            { 
                id: 'social', 
                name: 'ç¤¾äº¤è¾¾äºº', 
                icon: 'ğŸ¤', 
                awakenIcon: 'ğŸŒ',
                desc: 'å…«é¢ç²ç‘çš„ç¤¾äº¤é«˜æ‰‹', 
                bonus: 'ç¤¾äº¤èƒ½åŠ›åˆå§‹+5', 
                awakenName: 'äººè„‰ç½‘ç»œæ¿€æ´»',
                awakenDesc: 'è½¬åšæ—¶æ ¹æ®ç¤¾äº¤èƒ½åŠ›æ”¹å˜å®¡ç¨¿äººåˆ†å¸ƒ',
                stats: { social: 5 },
                reversed: {
                    name: 'å«‰å¦’ä¹‹ã€Šç¤¾äº¤è¾¾äººã€‹',
                    icon: 'ğŸ',
                    awakenIcon: 'ğŸ‘ï¸',
                    desc: 'è§ä¸å¾—åˆ«äººå¥½ï¼Œä¹Ÿè§ä¸å¾—è‡ªå·±å·®',
                    bonus: 'ç¤¾äº¤åˆå§‹5ï¼Œç¤¾äº¤-1â†’ç§‘ç ”+1,å¥½æ„Ÿ+1 | ç¤¾äº¤+1â†’SAN+1,é‡‘+1',
                    awakenName: 'å«‰å¦’é‡ç½®',
                    awakenDesc: 'è½¬åšæ—¶ç¤¾äº¤èƒ½åŠ›å˜ä¸º5',
                    stats: { social: 4 }
                }
            },
            { 
                id: 'rich', 
                name: 'å¯Œå¯æ•Œå›½', 
                icon: 'ğŸ’°', 
                awakenIcon: 'ğŸ’',
                desc: 'å®¶å¢ƒæ®·å®æ— å¿§æ— è™‘', 
                bonus: 'é‡‘å¸å€¼åˆå§‹+5', 
                awakenName: 'è´¢å¯Œå€å¢æœ¯',
                awakenDesc: 'è½¬åšæ—¶é‡‘å¸Ã—3',  // â˜…â˜…â˜… ä¿®æ”¹ï¼šæ­£ä½è§‰é†’æ”¹ä¸ºÃ—3 â˜…â˜…â˜…
                stats: { gold: 5 },
                reversed: {
                    name: 'è´ªæ±‚ä¹‹ã€Šå¯Œå¯æ•Œå›½ã€‹',
                    icon: 'ğŸ´â€â˜ ï¸',
                    awakenIcon: 'ğŸ‘‘',
                    desc: 'é™¤äº†é’±ä¸€æ— æ‰€æœ‰',
                    bonus: 'æ¯æœˆSAN/ç§‘ç ”/ç¤¾äº¤/å¥½æ„Ÿé‡ç½®ä¸º0ï¼Œæ¯æœˆé‡‘é’±+3',  // â˜…â˜…â˜… ä¿®æ”¹ï¼šæ–°æ•ˆæœæè¿° â˜…â˜…â˜…
                    awakenName: 'é‡‘é’±çš„åŠ›é‡',
                    awakenDesc: 'åŠå¹´é‡ç½®ä¸€æ¬¡ï¼Œæ¯èŠ±è´¹6é‡‘å¸å±æ€§å„+1',  // â˜…â˜…â˜… ä¿®æ”¹ï¼šæ–°è§‰é†’æè¿° â˜…â˜…â˜…
                    stats: {}  // â˜…â˜…â˜… ä¿®æ”¹ï¼šç»™ä¸€äº›åˆå§‹é‡‘å¸ â˜…â˜…â˜…
                }
            },
            { 
                id: 'teacher-child', 
                name: 'å¯¼å¸ˆå­å¥³', 
                icon: 'ğŸ‘¨â€ğŸ‘§', 
                awakenIcon: 'ğŸ‘‘',
                desc: 'è¿‘æ°´æ¥¼å°å…ˆå¾—æœˆ', 
                bonus: 'å¯¼å¸ˆå¥½æ„Ÿåº¦åˆå§‹+5', 
                awakenName: 'è¡€è„‰å…±é¸£',
                awakenDesc: 'è½¬åšæ—¶å¥½æ„Ÿåº¦è¶…12çš„éƒ¨åˆ†è½¬åŒ–ä¸ºç§‘ç ”å’Œé‡‘å¸',
                stats: { favor: 5 },
                reversed: {
                    name: 'ç©ä¸–ä¹‹ã€Šå¯¼å¸ˆå­å¥³ã€‹',
                    icon: 'ğŸª',
                    awakenIcon: 'ğŸƒ',
                    desc: 'å›é€†æ˜¯æˆ‘çš„ä»£åè¯',
                    bonus: 'å¥½æ„Ÿåˆå§‹12ï¼Œå¥½æ„Ÿâ†“ç¿»å€ï¼Œæ¯æœˆå¥½æ„Ÿ-1ï¼Œå¥½æ„Ÿ-1â†’SAN+1,é‡‘+1',
                    awakenName: 'æµªå­å›å¤´',
                    awakenDesc: 'è½¬åšæ—¶å¥½æ„Ÿåº¦å€’ç½®ä¸º20-å¥½æ„Ÿåº¦',
                    stats: { favor: 11 }
                }
            },
            { 
                id: 'chosen', 
                name: 'å¤©é€‰ä¹‹äºº', 
                icon: 'â­', 
                awakenIcon: 'âœ¨',
                desc: 'å‘½è¿çš„å® å„¿å…¨é¢å‘å±•', 
                bonus: 'ç§‘ç ”+2 ç¤¾äº¤+2 å¥½æ„Ÿ+2 é‡‘å¸+2', 
                awakenName: 'æŸ¥ç¼ºè¡¥æ¼',
                awakenDesc: 'è½¬åšæ—¶è¡¥é½æ‰€æœ‰çŸ­æ¿',
                stats: { research: 2, social: 2, favor: 2, gold: 2 },
                reversed: {
                    name: 'ç©ºæƒ³ä¹‹ã€Šå¤©é€‰ä¹‹äººã€‹',
                    icon: 'ğŸŒ€',
                    awakenIcon: 'ğŸ²',
                    desc: 'å‘½è¿æ˜¯ä¸€åœºè½®ç›˜èµŒ',
                    bonus: 'æ¯æœˆ:ç§‘ç ”/ç¤¾äº¤/å¥½æ„Ÿéšæœºäº¤æ¢ï¼ŒSAN/é‡‘éšæœºäº¤æ¢',
                    awakenName: 'å‘½è¿è½®ç›˜',
                    awakenDesc: 'æ¯æœˆ:ç§‘ç ”/ç¤¾äº¤/å¥½æ„Ÿ/SAN/é‡‘å…¨éƒ¨éšæœºäº¤æ¢',
                    stats: {}
                }
            }
        ];

        const paperTitleWords = {
            adjectives: ['Deep', 'Neural', 'Efficient', 'Scalable', 'Robust', 'Adaptive', 'Dynamic', 'Multi-modal', 'Self-supervised', 'Federated', 'Attention-based', 'Graph-based', 'Hierarchical', 'Contrastive', 'Progressive', 'Unified'],
            nouns: ['Learning', 'Networks', 'Transformers', 'Models', 'Representations', 'Framework', 'Architecture', 'Approach', 'Method', 'System', 'Embeddings', 'Reasoning', 'Generation', 'Recognition'],
            verbs: ['Understanding', 'Generating', 'Predicting', 'Detecting', 'Recognizing', 'Synthesizing', 'Optimizing', 'Training', 'Enhancing', 'Improving'],
            domains: ['Vision', 'Language', 'Speech', 'Text', 'Images', 'Videos', 'Knowledge', 'Data', 'Graphs', 'Medical', '3D', 'Autonomous']
        };

        const ALL_BUFF_TYPES = [
            'monthly_san', 'exp_times', 'write_san_reduce', 'read_san_reduce',
            'idea_bonus', 'exp_bonus', 'write_bonus', 'idea_times', 'write_times', 'citation_multiply'
        ];

        const ALL_ACHIEVEMENTS = [
            'ğŸ’• å–œç»“è‰¯ç¼˜', 'ğŸ’° å®¶è´¢ä¸‡è´¯', 'â¬¡ å…­è¾¹å½¢æˆ˜å£«', 'ğŸ† è¯ºå¥–é€‰æ‰‹', 
            'ğŸŒ¸ äº¤é™…èŠ±', 'ğŸ¤ é“æ†å¸ˆç”Ÿ', 'âš¡ ç²¾åŠ›æ»¡æ»¡', 'ğŸ¯ ç™¾å‘ç™¾ä¸­', 
            'â˜• æˆ‘çˆ±èŒ¶æ­‡', 'ğŸ–ï¸ å…¬è´¹æ—…æ¸¸', 'ğŸ¤– è®ºæ–‡æœºå™¨',
            'ğŸ“š åƒå¼•å¤§ä½¬', 'â˜• å’–å•¡çˆ±å¥½è€…', 'âœ¨ Buffä¹‹ç¥',
            'ğŸ“œ é«˜åˆ†è®ºæ–‡', 'ğŸ€ å¹¸è¿å„¿', 'ğŸ˜­ å€’éœ‰è›‹',
            'ğŸ» æ›²é«˜å’Œå¯¡', 'ğŸ’ª å…¨åŠ›ä»¥èµ´', 'ğŸ† å…¨æ”¶é›†',
            'ğŸ‘Š è¶Šæˆ˜è¶Šå‹‡', 'ğŸ§  äººé—´æ¸…é†’', 'ğŸ”¥ ç«åŠ›å…¨å¼€',
            'ğŸš é£Ÿä¹‹æ— å‘³', 'ğŸ¤– æœºæ¢°é£å‡', 'ğŸ›‹ï¸ å…¨å¥—å®¶å…·',
            'ğŸ§’ å¤©æ‰å°‘å¹´'
        ];

        // ç»“å±€åç§°æ˜ å°„
        const ENDING_NAMES = {
            'quit': 'ğŸšª ä¸»åŠ¨é€€å­¦',
            'burnout': 'ğŸ˜¢ ä¸å ªé‡è´Ÿ',
            'expelled': 'ğŸ˜­ è¢«é€€å­¦',
            'poor': 'ğŸ’¸ ç©·å›°æ½¦å€’',
            'delay': 'â° å»¶æ¯•',
            'master': 'ğŸ“ ç¡•å£«æ¯•ä¸š',
            'excellent_master': 'ğŸŒŸ ä¼˜ç§€ç¡•å£«',
            'phd': 'ğŸ“ åšå£«æ¯•ä¸š',
            'excellent_phd': 'ğŸ† ä¼˜ç§€åšå£«',
            'green_pepper': 'ğŸŒ¶ï¸ é’æ¤’',
            'become_advisor': 'ğŸ‘¨â€ğŸ« æˆ‘å°±æ˜¯å¯¼å¸ˆ',
            'academic_star': 'â­ å­¦æœ¯ä¹‹æ˜Ÿ',
            'future_academician': 'ğŸ‘‘ æœªæ¥é™¢å£«'
        };

        // å›°éš¾ç»“å±€ï¼ˆåšå£«æ¯•ä¸šåŠä»¥ä¸Šï¼‰
        const HARD_ENDINGS = ['phd', 'excellent_phd', 'green_pepper', 'become_advisor', 'academic_star', 'future_academician'];

        // ç»“å±€è¾¾æˆè¦æ±‚æ•°æ®
        const ENDING_REQUIREMENTS = {
            'quit': 'ä¸»åŠ¨é€‰æ‹©é‡å¼€å¹¶ç¡®è®¤é€€å­¦',
            'burnout': 'SANå€¼é™ä¸ºè´Ÿæ•°',
            'expelled': 'å¯¼å¸ˆå¥½æ„Ÿåº¦é™ä¸ºè´Ÿæ•°',
            'poor': 'é‡‘å¸é™ä¸ºè´Ÿæ•°',
            'delay': 'æ¯•ä¸šæ—¶é—´åˆ°ä½†ç§‘ç ”åˆ†ä¸è¶³ï¼ˆç¡•å£«<1æˆ–åšå£«<7ï¼‰',
            'master': 'ç¡•å£«3å¹´å†…ç§‘ç ”åˆ†â‰¥1',
            'excellent_master': 'ç¡•å£«3å¹´å†…ç§‘ç ”åˆ†â‰¥4',
            'phd': 'åšå£«5å¹´å†…ç§‘ç ”åˆ†â‰¥7',
            'excellent_phd': 'åšå£«æ¯•ä¸šä¸”Aç±»è®ºæ–‡â‰¥3',
            'green_pepper': 'åšå£«æ¯•ä¸šä¸”Aç±»â‰¥4ã€å¼•ç”¨>500',
            'become_advisor': 'åšå£«æ¯•ä¸šä¸”Aç±»â‰¥5ã€å¼•ç”¨>1000',
            'academic_star': 'åšå£«æ¯•ä¸šä¸”Aç±»â‰¥5ã€å¼•ç”¨>1000ã€å¤§ç‰›è”åˆåŸ¹å…»',
            'future_academician': 'åšå£«æ¯•ä¸šä¸”Aç±»â‰¥5ã€å¼•ç”¨>2000ã€å¤§ç‰›è”åˆåŸ¹å…»'
        };

        // æˆå°±è¾¾æˆè¦æ±‚æ•°æ®
        const ACHIEVEMENT_REQUIREMENTS = {
            'ğŸ’• å–œç»“è‰¯ç¼˜': 'ä¸å¼‚æ€§å­¦è€…å‘å±•ä¸ºæ‹äººå…³ç³»ï¼ˆç¤¾äº¤â‰¥12ååœ¨å¼€ä¼šæ—¶å¤šæ¬¡äº¤æµåŒä¸€äººï¼‰',
            'ğŸ’° å®¶è´¢ä¸‡è´¯': 'ç»“å±€æ—¶é‡‘å¸>30',
            'â¬¡ å…­è¾¹å½¢æˆ˜å£«': 'ç»“å±€æ—¶ç§‘ç ”ã€ç¤¾äº¤ã€å¥½æ„Ÿã€é‡‘å¸å‡>12',
            'ğŸ† è¯ºå¥–é€‰æ‰‹': 'ç§‘ç ”èƒ½åŠ›è¾¾åˆ°20',
            'ğŸŒ¸ äº¤é™…èŠ±': 'ç¤¾äº¤èƒ½åŠ›è¾¾åˆ°20',
            'ğŸ¤ é“æ†å¸ˆç”Ÿ': 'å¯¼å¸ˆå¥½æ„Ÿåº¦è¾¾åˆ°20',
            'âš¡ ç²¾åŠ›æ»¡æ»¡': 'ç»“å±€æ—¶SANå€¼â‰¥20',
            'ğŸ¯ ç™¾å‘ç™¾ä¸­': 'è‡³å°‘å‘è¡¨1ç¯‡è®ºæ–‡ä¸”ä»æœªè¢«æ‹’ç¨¿',
            'â˜• æˆ‘çˆ±èŒ¶æ­‡': 'åœ¨å¼€ä¼šäº‹ä»¶ä¸­é€‰æ‹©èŒ¶æ­‡+æ™šå®´â‰¥3æ¬¡',
            'ğŸ–ï¸ å…¬è´¹æ—…æ¸¸': 'åœ¨å¼€ä¼šäº‹ä»¶ä¸­é€‰æ‹©é¡ºä¾¿æ—…æ¸¸â‰¥3æ¬¡',
            'ğŸ¤– è®ºæ–‡æœºå™¨': 'å‘è¡¨è®ºæ–‡æ€»æ•°â‰¥10',
            'ğŸ“š åƒå¼•å¤§ä½¬': 'æ€»å¼•ç”¨æ•°â‰¥1000',
            'â˜• å’–å•¡çˆ±å¥½è€…': 'é¡ºåˆ©æ¯•ä¸šä¸”æ¯æœˆéƒ½è´­ä¹°å†°ç¾å¼',
            'âœ¨ Buffä¹‹ç¥': 'è§¦å‘è¿‡æ‰€æœ‰ç±»å‹çš„Buffæ•ˆæœ',
            'ğŸ“œ é«˜åˆ†è®ºæ–‡': 'è®ºæ–‡ä¸­ç¨¿å(å¯èƒ½çš„æ”¹è¿›å)åˆ†æ•°è¾¾åˆ°125',
            'ğŸ€ å¹¸è¿å„¿': 'è®ºæ–‡æ”¶åˆ°ä¸‰ä½å®¡ç¨¿äººçš„ä¸€è‡´æ”¹è¿›',
            'ğŸ˜­ å€’éœ‰è›‹': 'ä¸‰ä¸ªå®¡ç¨¿äººéƒ½æ˜¯åå®¡ç¨¿äºº(æ¶æ„å°åŒè¡Œæˆ–è€…40ä¸ªé—®é¢˜å®¡ç¨¿äºº)',
            'ğŸ» æ›²é«˜å’Œå¯¡': 'åªä¸­è¿‡Aç±»è®ºæ–‡ï¼Œæ²¡æœ‰Bå’ŒC',
            'ğŸ’ª å…¨åŠ›ä»¥èµ´': 'æ¯•ä¸šæ—¶SANå’Œé‡‘é’±éƒ½ä¸º0',
            'ğŸ† å…¨æ”¶é›†': 'æ¯•ä¸šæ—¶ä¸­ç¨¿A,B,Cçš„posterï¼Œoralï¼Œbest paperå…±9ç±»è®ºæ–‡',
            'ğŸ‘Š è¶Šæˆ˜è¶Šå‹‡': 'æ¯•ä¸šæ—¶è‡³å°‘è¢«æ‹’ç¨¿5æ¬¡',
            'ğŸ§  äººé—´æ¸…é†’': 'æ‹¥æœ‰ä¸¤æ¬¡è½¬åšæœºä¼šéƒ½æ‹’ç»äº†',
            'ğŸ”¥ ç«åŠ›å…¨å¼€': 'è®ºæ–‡æ§½ä½åŒæ—¶æœ‰4ç¯‡è®ºæ–‡åœ¨å®¡',
            'ğŸš é£Ÿä¹‹æ— å‘³': 'ä¸€ç¯‡è®ºæ–‡è¢«è¿ç»­æ‹’ç¨¿3æ¬¡',
            'ğŸ¤– æœºæ¢°é£å‡': 'å•†åº—è´­ä¹°5å°GPUæœåŠ¡å™¨',
            'ğŸ›‹ï¸ å…¨å¥—å®¶å…·': 'è´­ä¹°å·¥å­¦æ¤…+æ˜¾ç¤ºå™¨+é”®ç›˜',
            'ğŸ§’ å¤©æ‰å°‘å¹´': 'è½¬åšæ—¶å°±è¾¾åˆ°åšå£«æ¯•ä¸šè¦æ±‚'
        };

        // å•†åº—ç‰©å“
        const shopItems = [
            { id: 'chair', name: 'äººä½“å·¥å­¦æ¤…', desc: 'æ°¸ä¹…buff-æ¯æœˆSANå€¼+1', price: 10, once: true, bought: false },
            { id: 'gpu_rent', name: 'ç§ŸGPUæœåŠ¡å™¨', desc: 'ä¸´æ—¶buff-ä¸‹æ¬¡åšå®éªŒå¤šåš1æ¬¡', price: 2, once: false },
            { id: 'gpu_buy', name: 'è´­ä¹°GPUæœåŠ¡å™¨', desc: 'æ°¸ä¹…buff-æ¯æ¬¡åšå®éªŒå¤šåš1æ¬¡', price: 12, once: false },
            { id: 'keyboard', name: 'æœºæ¢°é”®ç›˜', desc: 'æ°¸ä¹…buff-å†™è®ºæ–‡å˜ä¸ºSAN-3', price: 8, once: true, bought: false },
            { id: 'monitor', name: '4Kæ˜¾ç¤ºå™¨', desc: 'æ°¸ä¹…buff-è¯»è®ºæ–‡å˜ä¸ºSAN-1', price: 8, once: true, bought: false },
            { id: 'coffee', name: 'å†°ç¾å¼', desc: 'SANå€¼+2', price: 1, monthlyOnce: true, boughtThisMonth: false },
            { id: 'polish', name: 'è®ºæ–‡æ¶¦è‰²æœåŠ¡', desc: 'ä¸´æ—¶buff-ä¸‹æ¬¡å†™è®ºæ–‡åˆ†æ•°+5', price: 3, monthlyOnce: true, boughtThisMonth: false },
            { id: 'gemini', name: 'Geminiè®¢é˜…', desc: 'ä¸´æ—¶buff-ä¸‹æ¬¡æƒ³ideaåˆ†æ•°+4', price: 2, monthlyOnce: true, boughtThisMonth: false },
            { id: 'gpt', name: 'GPTè®¢é˜…', desc: 'ä¸´æ—¶buff-ä¸‹æ¬¡å†™è®ºæ–‡åˆ†æ•°+4', price: 3, monthlyOnce: true, boughtThisMonth: false },
            { id: 'claude', name: 'Claudeè®¢é˜…', desc: 'ä¸´æ—¶buff-ä¸‹æ¬¡åšå®éªŒåˆ†æ•°+4', price: 4, monthlyOnce: true, boughtThisMonth: false }
        ];
        // ==================== æ¸¸æˆçŠ¶æ€ ====================
        let gameState = {};
        let selectedCharacter = null;
        let isReversedMode = false;
        let characterDifficultyData = {};
        let currentEndingData = null;

        function getInitialState() {
            return {
                character: null,
                characterName: '',
                degree: 'master',
                year: 1,
                month: 1,
                totalMonths: 0,
                maxYears: 3,
                san: 20,
                sanMax: 20,
                research: 1,
                social: 1,
                favor: 1,
                gold: 1,
                paperA: 0,
                paperB: 0,
                paperC: 0,
                totalScore: 0,
                totalCitations: 0,
                publishedPapers: [],
                paperSlots: 1,
                papers: [null, null, null, null],
                buffs: { permanent: [], temporary: [] },
                actionUsed: false,
                readCount: 0,
                firstPaperAccepted: false,
                firstAPaperAccepted: false,
                hasLover: false,
                loverType: null,
                bigBullCooperation: false,
                rejectedCount: 0,
                teaBreakCount: 0,
                tourCount: 0,
                metBigBull: false,
                metBeautiful: false,
                metSmart: false,
                bigBullDeepCount: 0,
                beautifulCount: 0,
                smartCount: 0,
                availableRandomEvents: [],
                usedRandomEvents: [],
                triggeredBuffTypes: [],
                coffeeBoughtCount: 0,
                isReversed: false,
                reversedAwakened: false,
                blockedResearchGains: 0,
                goldLocked: false,
                statsLocked: false,
                _isMonthlyFavorDecrease: false,
                pendingPhDChoice: false,
                pendingConference: null,
                goldSpentTotal: 0,
                enterpriseCount: 0,
                ailabInternship: false,
                firstBestPaperAccepted: false,
				badmintonMonth: -1,  // â˜…â˜…â˜… æ–°å¢ï¼šè®°å½•æ‰“ç¾½æ¯›çƒçš„æœˆä»½ â˜…â˜…â˜…
                
                // â˜…â˜…â˜… æ–°å¢ï¼šé€†ä½å¯Œå¯æ•Œå›½ç›¸å…³çŠ¶æ€ â˜…â˜…â˜…
                lastResetMonth: 0,  // ä¸Šæ¬¡é‡ç½®çš„æœˆä»½ï¼ˆç”¨äºè§‰é†’ååŠå¹´é‡ç½®ï¼‰
				socialAwakened: false,
				reviewerDistribution: null,
                
                // æ–°å¢æˆå°±ç›¸å…³çŠ¶æ€
                rejectedPapers: {},
                maxConcurrentReviews: 0,
                phdOpportunitiesRejected: 0,
                gpuServersBought: 0,
                furnitureBought: {
                    chair: false,
                    monitor: false,
                    keyboard: false
                },
                achievementConditions: {
                    highScorePaper: false,
                    unanimousImprovement: false,
                    allBadReviewers: false,
                    tripleRejected: false,
                    bought5GPUs: false,
                    fullFurnitureSet: false,
                    phdRequirementMetEarly: false,
                    rejectedPhdTwice: false
                },
                paperTypeCollection: new Set()
            };
        }


        // ==================== Supabase ç»Ÿè®¡ç³»ç»Ÿ ====================
        const SUPABASE_URL = 'https://orzejzmyzugxtyrzfcse.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9yemVqem15enVneHR5cnpmY3NlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzMDYyMTUsImV4cCI6MjA4MDg4MjIxNX0.lx9W0v9KpRPmQR0kdxCSWVks_az5rLCr7D3JI2efeM4';

        let supabase = null;
        let statsInitialized = false;
        let statsCache = null;
        let statsCacheTime = 0;
        let visitStatsCache = null;
        let visitStatsCacheTime = 0;
        const CACHE_DURATION = 10 * 60 * 1000;

        function initStats() {
            if (statsInitialized) return;
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                statsInitialized = true;
                console.log('âœ… Supabase ç»Ÿè®¡ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ');
                recordVisit();
            } catch (e) {
                console.error('âŒ ç»Ÿè®¡ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:', e);
            }
        }

        async function recordVisit() {
            if (!supabase) return;
            try {
                await supabase.from('site_visits').insert({ type: 'pv' });
                
                const visitorKey = 'graduate_simulator_visitor';
                if (!localStorage.getItem(visitorKey)) {
                    await supabase.from('site_visits').insert({ type: 'uv' });
                    localStorage.setItem(visitorKey, 'true');
                }
            } catch (e) {
                console.error('è®°å½•è®¿é—®å¤±è´¥:', e);
            }
        }

        async function getVisitStats() {
            if (visitStatsCache && (Date.now() - visitStatsCacheTime < CACHE_DURATION)) {
                return visitStatsCache;
            }
            
            if (!supabase) return { pv: 0, uv: 0 };
            
            try {
                const { count: pvCount, error: pvError } = await supabase
                    .from('site_visits')
                    .select('*', { count: 'exact', head: true })
                    .eq('type', 'pv');
                
                if (pvError) throw pvError;
                
                const { count: uvCount, error: uvError } = await supabase
                    .from('site_visits')
                    .select('*', { count: 'exact', head: true })
                    .eq('type', 'uv');
                    
                if (uvError) throw uvError;
                
                visitStatsCache = { pv: pvCount || 0, uv: uvCount || 0 };
                visitStatsCacheTime = Date.now();
                
                return visitStatsCache;
            } catch (e) {
                console.error('è·å–è®¿é—®ç»Ÿè®¡å¤±è´¥:', e);
                return visitStatsCache || { pv: 0, uv: 0 };
            }
        }

		async function recordEnding(endingType, endingTitle) {
			// è®¡ç®—æˆå°±æ•°é‡
			const achievements = collectAchievements(endingType);
			const achievementCount = achievements.length;
			
			// â˜…â˜…â˜… æ›´æ–°æœ¬åœ°è®°å½• â˜…â˜…â˜…
			updateLocalMeta(
				gameState.character, 
				gameState.isReversed, 
				gameState.totalScore, 
				gameState.totalCitations, 
				achievementCount
			);
			
			if (!supabase) return;
			
			try {
				const { error } = await supabase.from('game_endings').insert({
					ending_type: endingType,
					ending_title: endingTitle,
					character: gameState.character,
					is_reversed: gameState.isReversed,
					total_months: gameState.totalMonths,
					total_score: gameState.totalScore,
					paper_a: gameState.paperA,
					paper_b: gameState.paperB,
					paper_c: gameState.paperC,
					total_citations: gameState.totalCitations,
					achievements_count: achievementCount
				});
				
				if (error) throw error;
				console.log('âœ… ç»“å±€å·²è®°å½•:', endingTitle);
				
				// æ¸…é™¤ç¼“å­˜
				globalCharacterRecords = null;
			} catch (e) {
				console.error('âŒ è®°å½•ç»“å±€å¤±è´¥:', e);
			}
		}

        async function recordAchievements(achievements) {
            if (!supabase || achievements.length === 0) return;
            try {
                const records = achievements.map(ach => ({
                    achievement_name: ach,
                    character: gameState.character,
                    is_reversed: gameState.isReversed
                }));
                
                const { error } = await supabase.from('game_achievements').insert(records);
                
                if (error) throw error;
                console.log('âœ… æˆå°±å·²è®°å½•:', achievements);
            } catch (e) {
                console.error('âŒ è®°å½•æˆå°±å¤±è´¥:', e);
            }
        }

        async function fetchAllRows(tableName, selectColumns) {
            if (!supabase) return [];
            
            let allData = [];
            let from = 0;
            const pageSize = 1000;
            
            while (true) {
                const { data, error } = await supabase
                    .from(tableName)
                    .select(selectColumns)
                    .range(from, from + pageSize - 1);
                
                if (error) {
                    console.error(`è·å– ${tableName} æ•°æ®å¤±è´¥:`, error);
                    throw error;
                }
                
                if (!data || data.length === 0) break;
                
                allData = allData.concat(data);
                console.log(`${tableName}: å·²è·å– ${allData.length} æ¡è®°å½•`);
                
                if (data.length < pageSize) break;
                
                from += pageSize;
            }
            
            return allData;
        }
        
        async function getGlobalStats() {
            if (statsCache && (Date.now() - statsCacheTime < CACHE_DURATION)) {
                console.log('ä½¿ç”¨ç¼“å­˜çš„å…¨çƒç»Ÿè®¡');
                return statsCache;
            }
            
            if (!supabase) return null;
            
            try {
                const stats = {
                    normal: { endings: {}, achievements: {}, characterEndings: {} },
                    reversed: { endings: {}, achievements: {}, characterEndings: {} }
                };

                const endings = await fetchAllRows('game_endings', 'ending_type, is_reversed, character');
                console.log(`æ€»å…±è·å– ${endings.length} æ¡ç»“å±€è®°å½•`);
                
                endings.forEach(e => {
                    const mode = e.is_reversed ? 'reversed' : 'normal';
                    const type = e.ending_type;
                    const character = e.character;
                    
                    stats[mode].endings[type] = (stats[mode].endings[type] || 0) + 1;
                    
                    if (!stats[mode].characterEndings[character]) {
                        stats[mode].characterEndings[character] = { total: 0, hard: 0 };
                    }
                    stats[mode].characterEndings[character].total++;
                    if (HARD_ENDINGS.includes(type)) {
                        stats[mode].characterEndings[character].hard++;
                    }
                });

                const achievements = await fetchAllRows('game_achievements', 'achievement_name, is_reversed');
                console.log(`æ€»å…±è·å– ${achievements.length} æ¡æˆå°±è®°å½•`);
                
                achievements.forEach(a => {
                    const mode = a.is_reversed ? 'reversed' : 'normal';
                    const name = a.achievement_name;
                    stats[mode].achievements[name] = (stats[mode].achievements[name] || 0) + 1;
                });

                statsCache = stats;
                statsCacheTime = Date.now();
                
                return stats;
            } catch (e) {
                console.error('è·å–ç»Ÿè®¡å¤±è´¥:', e);
                return statsCache || null;
            }
        }

        function calculateCharacterDifficulty(stats) {
            const difficultyData = {};
            const allCharacterRates = [];

            characters.forEach(char => {
                const normalData = stats.normal.characterEndings[char.id] || { total: 0, hard: 0 };
                const normalRate = normalData.total >= 5 ? normalData.hard / normalData.total : null;
                allCharacterRates.push({
                    id: char.id,
                    isReversed: false,
                    rate: normalRate,
                    total: normalData.total,
                    hard: normalData.hard
                });

                const reversedData = stats.reversed.characterEndings[char.id] || { total: 0, hard: 0 };
                const reversedRate = reversedData.total >= 5 ? reversedData.hard / reversedData.total : null;
                allCharacterRates.push({
                    id: char.id,
                    isReversed: true,
                    rate: reversedRate,
                    total: reversedData.total,
                    hard: reversedData.hard
                });
            });

            const validRates = allCharacterRates.filter(c => c.rate !== null);
            validRates.sort((a, b) => b.rate - a.rate);

            validRates.forEach((char, index) => {
                const rank = index + 1;
                const difficulty = Math.ceil(rank * 12 / validRates.length);
                const key = `${char.id}_${char.isReversed ? 'reversed' : 'normal'}`;
                difficultyData[key] = {
                    stars: Math.min(12, Math.max(1, difficulty)),
                    rate: char.rate,
                    total: char.total,
                    hard: char.hard,
                    rank: rank,
                    totalRanked: validRates.length
                };
            });

            allCharacterRates.forEach(char => {
                const key = `${char.id}_${char.isReversed ? 'reversed' : 'normal'}`;
                if (!difficultyData[key]) {
                    difficultyData[key] = {
                        stars: null,
                        rate: null,
                        total: char.total,
                        hard: char.hard,
                        rank: null,
                        totalRanked: validRates.length
                    };
                }
            });

            return difficultyData;
        }

        function renderDifficultyStars(stars) {
            if (stars === null) {
                return '<span class="no-data">æ•°æ®ä¸è¶³</span>';
            }

            let html = '';
            const fullStars = Math.floor(stars / 2);
            const halfStar = stars % 2 === 1;
            const emptyStars = 6 - fullStars - (halfStar ? 1 : 0);

            for (let i = 0; i < fullStars; i++) {
                html += '<i class="fas fa-star"></i>';
            }
            if (halfStar) {
                html += '<i class="far fa-star"></i>';
            }
            for (let i = 0; i < emptyStars; i++) {
                html += '<i class="far fa-star" style="opacity:0.3;"></i>';
            }

            return html;
        }

        function getDifficultyBadge(stars) {
            if (stars === null) return '<span class="difficulty-badge unknown">?</span>';
            if (stars >= 11) return '<span class="difficulty-badge legendary">ä¼ è¯´</span>';
            if (stars >= 9) return '<span class="difficulty-badge nightmare">å™©æ¢¦</span>';
            if (stars >= 7) return '<span class="difficulty-badge expert">ä¸“å®¶</span>';
            if (stars >= 5) return '<span class="difficulty-badge hard">å›°éš¾</span>';
            if (stars >= 3) return '<span class="difficulty-badge normal">æ™®é€š</span>';
            return '<span class="difficulty-badge easy">ç®€å•</span>';
        }

        async function loadGlobalStatsDisplay() {
            const panel = document.getElementById('global-stats-panel');
            const loading = document.getElementById('stats-loading');
            const content = document.getElementById('stats-content');
            
            panel.style.display = 'block';
            
            const visitStats = await getVisitStats();
            const pvEl = document.getElementById('busuanzi_value_site_pv');
            const uvEl = document.getElementById('busuanzi_value_site_uv');
            if (pvEl) pvEl.textContent = visitStats.pv || 0;
            if (uvEl) uvEl.textContent = visitStats.uv || 0;
            
            const stats = await getGlobalStats();
            
            if (!stats) {
                loading.innerHTML = '<span style="color:var(--warning-color);font-size:0.8rem;">âš ï¸ ç»Ÿè®¡åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</span>';
                document.getElementById('total-games-value').textContent = 0;
                return;
            }
            
            let totalGames = 0;
            for (const count of Object.values(stats.normal.endings)) {
                totalGames += count;
            }
            for (const count of Object.values(stats.reversed.endings)) {
                totalGames += count;
            }
            document.getElementById('total-games-value').textContent = totalGames;
            
            characterDifficultyData = calculateCharacterDifficulty(stats);
            
            loading.style.display = 'none';
            content.style.display = 'block';
            
            renderModeStats('normal', stats.normal, document.getElementById('normal-ending-stats'), document.getElementById('normal-achievement-stats'));
            renderModeStats('reversed', stats.reversed, document.getElementById('reversed-ending-stats'), document.getElementById('reversed-achievement-stats'));
            // â˜…â˜…â˜… åŠ è½½å…¨çƒè§’è‰²è®°å½• â˜…â˜…â˜…
			await getGlobalCharacterRecords();
            renderCharacterGrid();
        }

        function renderModeStats(mode, modeStats, endingContainer, achievementContainer) {
            let totalEndings = 0;
            for (const count of Object.values(modeStats.endings)) {
                totalEndings += count;
            }

            let endingHtml = '';
            for (const [type, name] of Object.entries(ENDING_NAMES)) {
                const count = modeStats.endings[type] || 0;
                const percent = totalEndings > 0 ? ((count / totalEndings) * 100).toFixed(1) : 0;
                const opacity = count > 0 ? '1' : '0.4';
                endingHtml += `
                    <div class="stats-tag ending-tag" style="opacity:${opacity};">
                        ${name} <strong>${count}</strong>
                        <span style="color:var(--text-secondary);">(${percent}%)</span>
                    </div>`;
            }
            endingContainer.innerHTML = endingHtml || '<span style="color:var(--text-secondary);font-size:0.75rem;">æš‚æ— æ•°æ®</span>';

            let achievementHtml = '';
            for (const ach of ALL_ACHIEVEMENTS) {
                const count = modeStats.achievements[ach] || 0;
                const opacity = count > 0 ? '1' : '0.5';
                achievementHtml += `
                    <div class="stats-tag" style="opacity:${opacity};">
                        ${ach} <strong>${count}</strong>
                    </div>
                `;
            }
            achievementContainer.innerHTML = achievementHtml;
        }


        // ==================== æ¨¡å¼åˆ‡æ¢ ====================
        function switchMode(reversed) {
            isReversedMode = reversed;
            
            const normalBtn = document.getElementById('normal-mode-btn');
            const reversedBtn = document.getElementById('reversed-mode-btn');
            const modeDesc = document.getElementById('mode-description');
            const gameIntro = document.getElementById('game-intro');
            const selectionTitle = document.getElementById('selection-title');
            
            normalBtn.classList.toggle('active', !reversed);
            reversedBtn.classList.toggle('active', reversed);
            reversedBtn.classList.toggle('reversed-active', reversed);
            
            document.body.classList.toggle('reversed-theme', reversed);
            document.querySelectorAll('.character-card').forEach(card => card.classList.remove('selected'));
            
            if (reversed) {
                modeDesc.innerHTML = 'ğŸ”® é€†ä½æ¨¡å¼ï¼Œå¾ªè§„è¹ˆçŸ©ï¼Ÿä¸å…å¤ªè¿‡æ— è¶£ï¼';
                selectionTitle.innerHTML = '<i class="fas fa-moon"></i> é€‰æ‹©ä½ çš„é€†ä½è§’è‰²';
                gameIntro.innerHTML = `
                    <p>ğŸŒ‘ <strong>é€†ä½æ¨¡å¼å·²å¼€å¯ï¼</strong>æ¯ä¸ªè§’è‰²éƒ½æœ‰ç‹¬ç‰¹çš„é€†ä½æ•ˆæœï¼Œè§„åˆ™å°†è¢«é¢ è¦†ã€‚</p>
                    <p>âš ï¸ <strong>æ³¨æ„</strong>ï¼šé€†ä½è§’è‰²ç©æ³•æ›´ç‹¬ç‰¹ï¼Œå±æ€§å˜åŒ–è§„åˆ™å¯èƒ½å®Œå…¨ä¸åŒï¼</p>
                    <p>ğŸ¯ <strong>æ¸¸æˆç›®æ ‡</strong>ï¼šç¡•å£«æ¯•ä¸šç§‘ç ”åˆ†â‰¥1ï¼ˆ3å¹´ï¼‰ï¼Œåšå£«æ¯•ä¸šç§‘ç ”åˆ†â‰¥7ï¼ˆ5å¹´ï¼‰</p>
                    <p>ğŸ“ <strong>è®ºæ–‡ç§‘ç ”åˆ†</strong>ï¼šAç±»=4åˆ†ï¼ŒBç±»=2åˆ†ï¼ŒCç±»=1åˆ†</p>
                    <p>ğŸ’€ <strong>æŒ‘æˆ˜è‡ªæˆ‘</strong>ï¼šé€†ä½è§’è‰²çš„è½¬åšè§‰é†’æ•ˆæœä¹Ÿå®Œå…¨ä¸åŒï¼</p>
                `;
            } else {
                modeDesc.innerHTML = 'ğŸ“š ç»å…¸æ¨¡å¼ï¼Œä½“éªŒæ ‡å‡†çš„ç ”ç©¶ç”Ÿç”Ÿæ¶¯';
                selectionTitle.innerHTML = '<i class="fas fa-users"></i> é€‰æ‹©ä½ çš„è§’è‰²';
                gameIntro.innerHTML = `
                    <p>ğŸ“š <strong>æ¬¢è¿æ¥åˆ°ç ”ç©¶ç”Ÿæ¨¡æ‹Ÿå™¨ï¼</strong>ä½“éªŒç ”ç©¶ç”Ÿç”Ÿæ¶¯ï¼Œå¹³è¡¡ç§‘ç ”ã€ç”Ÿæ´»å’Œäººé™…å…³ç³»ï¼ŒåŠªåŠ›å‘è¡¨è®ºæ–‡ï¼Œæœ€ç»ˆé¡ºåˆ©æ¯•ä¸šã€‚</p>
                    <p>ğŸ¯ <strong>æ¸¸æˆç›®æ ‡</strong>ï¼šç¡•å£«æ¯•ä¸šç§‘ç ”åˆ†â‰¥1ï¼ˆ3å¹´ï¼‰ï¼Œåšå£«æ¯•ä¸šç§‘ç ”åˆ†â‰¥7ï¼ˆ5å¹´ï¼‰</p>
                    <p>ğŸ“ <strong>è®ºæ–‡ç§‘ç ”åˆ†</strong>ï¼šAç±»=4åˆ†ï¼ŒBç±»=2åˆ†ï¼ŒCç±»=1åˆ†</p>
                    <p>ğŸ’¡ <strong>å±æ€§å½±å“</strong>ï¼šç§‘ç ”èƒ½åŠ›å½±å“è®ºæ–‡åˆ†æ•°ï¼›ç¤¾äº¤èƒ½åŠ›å’Œå¯¼å¸ˆå¥½æ„Ÿåº¦å½±å“äº‹ä»¶é€‰é¡¹å’Œç»“æœã€‚<strong>å»ºè®®ä¼˜å…ˆå°†å±æ€§æå‡è‡³6ä»¥è§£é”æ›´å¤šé€‰é¡¹ï¼</strong></p>
                    <p>âš ï¸ <strong>æ³¨æ„</strong>ï¼šä¿æŒSANå€¼ã€å¯¼å¸ˆå¥½æ„Ÿåº¦å’Œé‡‘é’±ä¸ºæ­£æ•°ï¼Œå¦åˆ™å°†è§¦å‘ä¸è‰¯ç»“å±€ï¼</p>
                `;
            }
            
            selectedCharacter = null;
            document.getElementById('start-btn').disabled = true;
            
            renderCharacterGrid();
        }

        // ==================== åˆå§‹åŒ– ====================
        function init() {
            renderCharacterGrid();
            document.getElementById('start-btn').addEventListener('click', startGame);
            
            initStats();
            loadGlobalStatsDisplay();
        }

		function renderCharacterGrid() {
			const grid = document.getElementById('character-grid');
			const globalRecords = globalCharacterRecords;
			
			grid.innerHTML = characters.map(char => {
				const data = isReversedMode && char.reversed ? char.reversed : char;
				const diffKey = `${char.id}_${isReversedMode ? 'reversed' : 'normal'}`;
				const diffData = characterDifficultyData[diffKey] || { stars: null, rate: null, total: 0 };
				
				// è·å–æœ¬åœ°æœ€é«˜è®°å½•
				const localRecord = getCharacterLocalRecord(char.id, isReversedMode);
				const hasLocalRecord = localRecord.maxScore > 0;
				
				// è·å–å…¨çƒè®°å½•
				const mode = isReversedMode ? 'reversed' : 'normal';
				const globalRecord = globalRecords?.[mode]?.[char.id] || {
					today: { maxScore: 0, maxCitations: 0, maxAchievements: 0 },
					history: { maxScore: 0, maxCitations: 0, maxAchievements: 0 }
				};
				const hasGlobalRecord = globalRecord.history.maxScore > 0;
				
				const starsHtml = renderDifficultyStars(diffData.stars);
				const badgeHtml = getDifficultyBadge(diffData.stars);
				const rateText = diffData.rate !== null ? `${(diffData.rate * 100).toFixed(1)}%` : '?';
				const totalGames = diffData.total || 0;
				
				const cardClass = isReversedMode ? 'character-card reversed-card' : 'character-card';
				const bonusClass = isReversedMode ? 'background:rgba(231,76,60,0.15);color:#e74c3c;' : '';
				const awakenBg = isReversedMode 
					? 'background:linear-gradient(135deg,rgba(155,89,182,0.15),rgba(231,76,60,0.15));border-color:rgba(231,76,60,0.4);' 
					: 'background:linear-gradient(135deg,rgba(102,126,234,0.1),rgba(118,75,162,0.1));border-color:rgba(102,126,234,0.3);';
				const awakenColor = isReversedMode ? '#e74c3c' : 'var(--primary-color)';

				// Metaè®°å½•HTML
				const metaRecordHtml = `
					<div class="meta-records" style="margin-top:8px;padding:8px;background:var(--light-bg);border-radius:8px;font-size:0.6rem;">
						<!-- æˆ‘çš„è®°å½• -->
						<div style="margin-bottom:6px;padding-bottom:6px;border-bottom:1px dashed var(--border-color);">
							<div style="font-weight:600;color:var(--success-color);margin-bottom:4px;">ğŸ‘¤ æˆ‘çš„æœ€é«˜</div>
							${hasLocalRecord ? `
								<div style="display:flex;justify-content:space-between;color:var(--text-secondary);">
									<span>ğŸ¯${localRecord.maxScore}åˆ†</span>
									<span>ğŸ“š${localRecord.maxCitations}å¼•</span>
									<span>ğŸ†${localRecord.maxAchievements}æˆå°±</span>
								</div>
							` : `<div style="color:var(--text-secondary);text-align:center;">æš‚æ— è®°å½•</div>`}
						</div>
						<!-- ä»Šæ—¥å…¨çƒ -->
						<div style="margin-bottom:6px;padding-bottom:6px;border-bottom:1px dashed var(--border-color);">
							<div style="font-weight:600;color:var(--warning-color);margin-bottom:4px;">â˜€ï¸ ä»Šæ—¥å…¨çƒ</div>
							${globalRecord.today.maxScore > 0 ? `
								<div style="display:flex;justify-content:space-between;color:var(--text-secondary);">
									<span>ğŸ¯${globalRecord.today.maxScore}åˆ†</span>
									<span>ğŸ“š${globalRecord.today.maxCitations}å¼•</span>
									<span>ğŸ†${globalRecord.today.maxAchievements}æˆå°±</span>
								</div>
							` : `<div style="color:var(--text-secondary);text-align:center;">ä»Šæ—¥æš‚æ— </div>`}
						</div>
						<!-- å†å²å…¨çƒ -->
						<div>
							<div style="font-weight:600;color:var(--accent-color);margin-bottom:4px;">ğŸ‘‘ å†å²å…¨çƒ</div>
							${hasGlobalRecord ? `
								<div style="display:flex;justify-content:space-between;color:var(--text-secondary);">
									<span>ğŸ¯${globalRecord.history.maxScore}åˆ†</span>
									<span>ğŸ“š${globalRecord.history.maxCitations}å¼•</span>
									<span>ğŸ†${globalRecord.history.maxAchievements}æˆå°±</span>
								</div>
							` : `<div style="color:var(--text-secondary);text-align:center;">æš‚æ— è®°å½•</div>`}
						</div>
					</div>
				`;

				return `
				<div class="${cardClass}" data-id="${char.id}" onclick="selectCharacter('${char.id}')">
					<div class="icon">${data.icon}</div>
					<div class="name">${data.name}</div>
					<div class="desc">${data.desc}</div>
					<div class="bonus" style="${bonusClass}">${data.bonus}</div>
					<div class="awaken-info" style="margin-top:8px;padding:6px 8px;${awakenBg}border-radius:6px;border:1px dashed;">
						<div style="font-size:0.65rem;color:${awakenColor};font-weight:600;margin-bottom:2px;">
							<span style="margin-right:3px;">âš¡</span>è½¬åšè§‰é†’: ${data.awakenIcon} ${data.awakenName}
						</div>
						<div style="font-size:0.6rem;color:var(--text-secondary);">${data.awakenDesc}</div>
					</div>
					${metaRecordHtml}
					<div class="difficulty-container">
						<div>
							<span class="difficulty-label">éš¾åº¦</span>
							<div class="difficulty-stars">${starsHtml}</div>
						</div>
						<div style="text-align:right;">
							${badgeHtml}
							<div style="font-size:0.55rem;color:var(--text-secondary);margin-top:2px;">
								åšå£«ç‡:${rateText} (${totalGames}å±€)
							</div>
						</div>
					</div>
				</div>
			`}).join('');
		}

        function selectCharacter(id) {
            selectedCharacter = characters.find(c => c.id === id);
            document.querySelectorAll('.character-card').forEach(card => {
                card.classList.toggle('selected', card.dataset.id === id);
            });
            document.getElementById('start-btn').disabled = false;
        }

        function startGame() {
            if (!selectedCharacter) return;

            gameState = getInitialState();
            gameState.character = selectedCharacter.id;
            gameState.isReversed = isReversedMode;

            const charData = isReversedMode && selectedCharacter.reversed 
                ? selectedCharacter.reversed 
                : selectedCharacter;
            
            gameState.characterName = charData.name;

            if (charData.stats.research) gameState.research += charData.stats.research;
            if (charData.stats.social) gameState.social += charData.stats.social;
            if (charData.stats.favor) gameState.favor += charData.stats.favor;
            if (charData.stats.gold) gameState.gold += charData.stats.gold;

            if (isReversedMode) {
                initReversedCharacter();
            }

            shopItems.forEach(item => {
                if (item.once) item.bought = false;
                if (item.monthlyOnce) item.boughtThisMonth = false;
            });

            resetRandomEventPool();
            
            if(gameState.publishedPapers.length === 0) {
                gameState.availableRandomEvents = gameState.availableRandomEvents.filter(e => e !== 14);
            }

            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-screen').style.display = 'block';
            document.getElementById('mobile-quick-bar').classList.add('game-active');

            document.getElementById('log-content').innerHTML = '';
            checkResearchUnlock(true);
            updateAllUI();
            renderPaperSlots();

            addLog('æ¸¸æˆå¼€å§‹', `æ¬¢è¿æ¥åˆ°ç ”ç©¶ç”Ÿæ¨¡æ‹Ÿå™¨ï¼ä½ é€‰æ‹©äº†ã€${gameState.characterName}ã€‘`);
            
            if (isReversedMode) {
                addLog('âš ï¸ é€†ä½æ¨¡å¼', 'å‘½è¿çš„é˜´æš—é¢å·²å¼€å¯ï¼Œè§„åˆ™å°†æœ‰æ‰€ä¸åŒ...');
            }
            
            addLog('æ¸¸æˆç›®æ ‡', 'ç¡•å£«æ¯•ä¸šéœ€è¦ç§‘ç ”åˆ†â‰¥1ï¼Œåšå£«æ¯•ä¸šéœ€è¦ç§‘ç ”åˆ†â‰¥7');
            addLog('æ¸¸æˆæç¤º', 'è®ºæ–‡ç§‘ç ”åˆ†ï¼šAç±»=4åˆ†ï¼ŒBç±»=2åˆ†ï¼ŒCç±»=1åˆ†');
            addLog('æ“ä½œæç¤º', 'æ¯æœˆå¯æ‰§è¡Œä¸€æ¬¡æŒç»­æ“ä½œï¼ˆçœ‹è®ºæ–‡/æ‰“å·¥/æƒ³idea/åšå®éªŒ/å†™è®ºæ–‡ï¼‰');
            addLog('å±æ€§æç¤º', 'ç§‘ç ”èƒ½åŠ›å½±å“è®ºæ–‡åˆ†æ•°ï¼Œç¤¾äº¤èƒ½åŠ›å’Œå¯¼å¸ˆå¥½æ„Ÿåº¦å½±å“äº‹ä»¶èµ°å‘ï¼Œå»ºè®®ä¼˜å…ˆæå‡è‡³6');
        }

        // â˜…â˜…â˜… å…³é”®ä¿®æ”¹ï¼šé€†ä½è§’è‰²åˆå§‹åŒ– â˜…â˜…â˜…
        function initReversedCharacter() {
            switch (gameState.character) {
                case 'genius':
                    gameState.research = 0;
                    gameState.paperSlots = 4;
                    addLog('é€†ä½æ•ˆæœ', 'æ„šé’ä¹‹ã€Šé™¢å£«è½¬ä¸–ã€‹', 'ç§‘ç ”èƒ½åŠ›å›ºå®šä¸º0ï¼Œå…¨éƒ¨è®ºæ–‡æ§½å·²è§£é”');
                    break;
                    
                case 'rich':
                    // â˜…â˜…â˜… æ–°æ•ˆæœï¼šé™¤äº†é’±ä¸€æ— æ‰€æœ‰ â˜…â˜…â˜…
                    gameState.san = 0;
                    gameState.research = 0;
                    gameState.social = 0;
                    gameState.favor = 0;
                    gameState.goldSpentTotal = 0;
                    gameState.lastResetMonth = 0;
                    addLog('é€†ä½æ•ˆæœ', 'è´ªæ±‚ä¹‹ã€Šå¯Œå¯æ•Œå›½ã€‹', 
                         'é™¤äº†é’±ä¸€æ— æ‰€æœ‰ï¼Œæ¯æœˆå±æ€§é‡ç½®ä¸º0ï¼Œé‡‘é’±+3');
                    break;
                    
                case 'teacher-child':
                    // ä¿æŒåŸæœ‰æ•ˆæœ
                    break;
                    
                case 'social':
                    // ä¿æŒåŸæœ‰æ•ˆæœ
                    break;
                    
                case 'chosen':
                    // ä¿æŒåŸæœ‰æ•ˆæœ
                    break;
                    
                case 'normal':
                    // ä¿æŒåŸæœ‰æ•ˆæœ
                    break;
            }
        }

        function resetRandomEventPool() {
            gameState.availableRandomEvents = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 12, 13];
            if(gameState.publishedPapers.length > 0) {
                gameState.availableRandomEvents.push(14);
            }
            gameState.usedRandomEvents = [];
        }

        // ==================== é€šç”¨å±æ€§ä¿®æ”¹å‡½æ•°ï¼ˆæ”¯æŒé€†ä½ï¼‰====================
        // è®¡ç®—å®é™…SANå˜åŒ–å€¼ï¼ˆè€ƒè™‘æ€ æƒ°ä¹‹å¤§å¤šæ•°çš„ç¿»å€æ•ˆæœï¼‰
        function getActualSanChange(delta) {
            if (gameState.isReversed && gameState.character === 'normal' && delta < 0) {
                const multiplier = gameState.reversedAwakened ? 3 : 2;
                return delta * multiplier;
            }
            return delta;
        }
        
        function changeSan(delta) {
            if (gameState.isReversed && gameState.character === 'normal' && delta < 0) {
                const multiplier = gameState.reversedAwakened ? 3 : 2;
                delta = delta * multiplier;
            }
            
            if (delta > 0) {
                gameState.san = Math.min(gameState.sanMax, gameState.san + delta);
            } else {
                gameState.san += delta;
            }
            updateAllUI();
            if (gameState.san < 0) {
                triggerEnding('burnout');
                return false;
            }
            return true;
        }

        // â˜…â˜…â˜… å…³é”®ä¿®æ”¹ï¼šchangeGoldå‡½æ•° â˜…â˜…â˜…
        function changeGold(delta) {
            // è´ªæ±‚ä¹‹å¯Œå¯æ•Œå›½è§‰é†’åï¼šæ¯èŠ±è´¹6é‡‘å¸å±æ€§å„+1
            if (gameState.isReversed && gameState.character === 'rich' && gameState.reversedAwakened && delta < 0) {
                const spent = Math.abs(delta);
                gameState.goldSpentTotal = (gameState.goldSpentTotal || 0) + spent;
                
                // æ¯æ¶ˆè´¹6é‡‘å¸ï¼ŒSAN/ç§‘ç ”/ç¤¾äº¤/å¥½æ„Ÿå„+1
                const attributeGains = Math.floor(gameState.goldSpentTotal / 6);
                const previousGains = Math.floor((gameState.goldSpentTotal - spent) / 6);
                const newGains = attributeGains - previousGains;
                
                if (newGains > 0) {
                    gameState.san = Math.min(gameState.sanMax, gameState.san + newGains);
                    gameState.research = Math.min(20, gameState.research + newGains);
                    gameState.social = Math.min(20, gameState.social + newGains);
                    gameState.favor = Math.min(20, gameState.favor + newGains);
                    addLog('é€†ä½æ•ˆæœ', 'é‡‘é’±è§‰é†’', `ç´¯è®¡æ¶ˆè´¹${gameState.goldSpentTotal}é‡‘ â†’ SAN+${newGains}, ç§‘ç ”+${newGains}, ç¤¾äº¤+${newGains}, å¥½æ„Ÿ+${newGains}`);
                }
            }
            
            gameState.gold += delta;
            updateAllUI();
            if (gameState.gold < 0) {
                triggerEnding('poor');
                return false;
            }
            return true;
        }

        function changeFavor(delta) {
            const oldFavor = gameState.favor;
            
            // ç©ä¸–ä¹‹å¯¼å¸ˆå­å¥³ï¼šå¥½æ„Ÿé™ä½ä¸ç¿»å€ï¼Œä½†æ¯é™1ç‚¹SAN+1é‡‘+1
            if (gameState.isReversed && gameState.character === 'teacher-child' && delta < 0) {
                const oldFavor = gameState.favor;
                gameState.favor = gameState.favor + delta;
                const decreased = Math.max(0, oldFavor - gameState.favor);
                if (decreased > 0) {
                    gameState.san = Math.min(gameState.sanMax, gameState.san + decreased);
                    gameState.gold += decreased;
                    addLog('é€†ä½æ•ˆæœ', 'ç©ä¸–ä¸æ­', `å¥½æ„Ÿåº¦-${decreased} â†’ SAN+${decreased}, é‡‘é’±+${decreased}`);
                }
                updateAllUI();
                if (gameState.favor < 0) {
                    triggerEnding('expelled');
                    return false;
                }
                return true;
            }
            
            if (delta > 0) {
                gameState.favor = Math.min(20, gameState.favor + delta);
            } else {
                gameState.favor += delta;
            }
            
            updateAllUI();
            if (gameState.favor < 0) {
                triggerEnding('expelled');
                return false;
            }
            return true;
        }

        function changeResearch(delta) {
            // æ„šé’ä¹‹é™¢å£«è½¬ä¸–ï¼šç§‘ç ”èƒ½åŠ›å›ºå®šä¸º0
            if (gameState.isReversed && gameState.character === 'genius') {
                if (delta > 0) {
                    gameState.blockedResearchGains += delta;
                    if (gameState.reversedAwakened) {
                        const sanGain = delta * 6;
                        const goldGain = delta * 6;
                        const favorGain = delta * 2;
                        const socialGain = delta * 2;
                        gameState.san = Math.min(gameState.sanMax, gameState.san + sanGain);
                        gameState.gold += goldGain;
                        gameState.favor = Math.min(20, gameState.favor + favorGain);
                        gameState.social = Math.min(20, gameState.social + socialGain);
                        addLog('é€†ä½æ•ˆæœ', 'å¤§æ™ºè‹¥æ„š', `ç§‘ç ”æå‡è¢«è½¬åŒ– â†’ SAN+${sanGain}, é‡‘+${goldGain}, å¥½æ„Ÿ+${favorGain}, ç¤¾äº¤+${socialGain}`);
                    } else {
                        const sanGain = delta * 4;
                        const goldGain = delta * 4;
                        gameState.san = Math.min(gameState.sanMax, gameState.san + sanGain);
                        gameState.gold += goldGain;
                        addLog('é€†ä½æ•ˆæœ', 'æ„šé’è½¬åŒ–', `ç§‘ç ”æå‡è¢«è½¬åŒ– â†’ SAN+${sanGain}, é‡‘é’±+${goldGain}`);
                    }
                }
                gameState.research = 0;
                updateAllUI();
                return true;
            }
            
            if (delta > 0) {
                gameState.research = Math.min(20, gameState.research + delta);
                checkResearchUnlock();
            } else {
                gameState.research = Math.max(0, gameState.research + delta);
            }
            updateAllUI();
            return true;
        }

        function changeSocial(delta) {
            const oldSocial = gameState.social;
            
            if (delta > 0) {
                gameState.social = Math.min(20, gameState.social + delta);
            } else {
                gameState.social = Math.max(0, gameState.social + delta);
            }
            
            // å«‰å¦’ä¹‹ç¤¾äº¤è¾¾äººï¼šç¤¾äº¤å˜åŒ–è§¦å‘æ•ˆæœ
            if (gameState.isReversed && gameState.character === 'social') {
                const change = gameState.social - oldSocial;
                if (change < 0) {
                    const amount = Math.abs(change);
                    changeResearch(amount);
                    gameState.favor = Math.min(20, gameState.favor + amount);
                    addLog('é€†ä½æ•ˆæœ', 'å«‰å¦’è½¬åŒ–', `ç¤¾äº¤-${amount} â†’ ç§‘ç ”+${amount}, å¥½æ„Ÿ+${amount}`);
                } else if (change > 0) {
                    gameState.san = Math.min(gameState.sanMax, gameState.san + change);
                    gameState.gold += change;
                    addLog('é€†ä½æ•ˆæœ', 'å«‰å¦’åé¦ˆ', `ç¤¾äº¤+${change} â†’ SAN+${change}, é‡‘é’±+${change}`);
                }
            }
            
            updateAllUI();
            return true;
        }

        function changeSanMax(delta) {
            gameState.sanMax += delta;
            updateAllUI();
            return true;
        }

        // â˜…â˜…â˜… å…³é”®ä¿®æ”¹ï¼šchangeStatså‡½æ•° â˜…â˜…â˜…
        function changeStats(changes) {
            let gameOver = false;
            
            if (changes.sanMax) gameState.sanMax += changes.sanMax;
            
            if (changes.san) {
                let sanDelta = changes.san;
                if (gameState.isReversed && gameState.character === 'normal' && sanDelta < 0) {
                    const multiplier = gameState.reversedAwakened ? 3 : 2;
                    sanDelta = sanDelta * multiplier;
                }
                
                if (sanDelta > 0) {
                    gameState.san = Math.min(gameState.sanMax, gameState.san + sanDelta);
                } else {
                    gameState.san += sanDelta;
                }
                if (gameState.san < 0) gameOver = 'burnout';
            }
            
            if (changes.gold) {
                // è´ªæ±‚ä¹‹å¯Œå¯æ•Œå›½è§‰é†’åï¼šæ¶ˆè´¹é‡‘å¸å¢åŠ å±æ€§
                if (gameState.isReversed && gameState.character === 'rich' && gameState.reversedAwakened && changes.gold < 0) {
                    const spent = Math.abs(changes.gold);
                    gameState.goldSpentTotal = (gameState.goldSpentTotal || 0) + spent;
                    
                    const attributeGains = Math.floor(gameState.goldSpentTotal / 6);
                    const previousGains = Math.floor((gameState.goldSpentTotal - spent) / 6);
                    const newGains = attributeGains - previousGains;
                    
                    if (newGains > 0) {
                        gameState.san = Math.min(gameState.sanMax, gameState.san + newGains);
                        gameState.research = Math.min(20, gameState.research + newGains);
                        gameState.social = Math.min(20, gameState.social + newGains);
                        gameState.favor = Math.min(20, gameState.favor + newGains);
                        addLog('é€†ä½æ•ˆæœ', 'é‡‘é’±è§‰é†’', `ç´¯è®¡æ¶ˆè´¹${gameState.goldSpentTotal}é‡‘ â†’ SAN+${newGains}, ç§‘ç ”+${newGains}, ç¤¾äº¤+${newGains}, å¥½æ„Ÿ+${newGains}`);
                    }
                }
                gameState.gold += changes.gold;
                if (gameState.gold < 0 && !gameOver) gameOver = 'poor';
            }
            
            if (changes.favor) {
                if (gameState.isReversed && gameState.character === 'teacher-child' && changes.favor < 0) {
                    const oldFavor = gameState.favor;
                    gameState.favor = gameState.favor + changes.favor;
                    const decreased = Math.max(0, oldFavor - gameState.favor);
                    if (decreased > 0) {
                        gameState.san = Math.min(gameState.sanMax, gameState.san + decreased);
                        gameState.gold += decreased;
                    }
                } else {
                    if (changes.favor > 0) {
                        gameState.favor = Math.min(20, gameState.favor + changes.favor);
                    } else {
                        gameState.favor += changes.favor;
                    }
                }
                if (gameState.favor < 0 && !gameOver) gameOver = 'expelled';
            }
            
            if (changes.research) {
                if (gameState.isReversed && gameState.character === 'genius') {
                    if (changes.research > 0) {
                        gameState.blockedResearchGains += changes.research;
                        const sanGain = changes.research * (gameState.reversedAwakened ? 6 : 4);
                        const goldGain = changes.research * (gameState.reversedAwakened ? 6 : 4);
                        gameState.san = Math.min(gameState.sanMax, gameState.san + sanGain);
                        gameState.gold += goldGain;
                        if (gameState.reversedAwakened) {
                            gameState.favor = Math.min(20, gameState.favor + changes.research * 2);
                            gameState.social = Math.min(20, gameState.social + changes.research * 2);
                        }
                    }
                    gameState.research = 0;
                } else {
                    if (changes.research > 0) {
                        gameState.research = Math.min(20, gameState.research + changes.research);
                        checkResearchUnlock();
                    } else {
                        gameState.research = Math.max(0, gameState.research + changes.research);
                    }
                }
            }
            
            if (changes.social) {
                const oldSocial = gameState.social;
                if (changes.social > 0) {
                    gameState.social = Math.min(20, gameState.social + changes.social);
                } else {
                    gameState.social = Math.max(0, gameState.social + changes.social);
                }
                
                // å«‰å¦’ä¹‹ç¤¾äº¤è¾¾äºº
                if (gameState.isReversed && gameState.character === 'social') {
                    const change = gameState.social - oldSocial;
                    if (change < 0) {
                        const amount = Math.abs(change);
                        changeResearch(amount);
                        gameState.favor = Math.min(20, gameState.favor + amount);
                        addLog('é€†ä½æ•ˆæœ', 'å«‰å¦’è½¬åŒ–', `ç¤¾äº¤-${amount} â†’ ç§‘ç ”+${amount}, å¥½æ„Ÿ+${amount}`);
                    } else if (change > 0) {
                        gameState.san = Math.min(gameState.sanMax, gameState.san + change);
                        gameState.gold += change;
                        addLog('é€†ä½æ•ˆæœ', 'å«‰å¦’åé¦ˆ', `ç¤¾äº¤+${change} â†’ SAN+${change}, é‡‘é’±+${change}`);
                    }
                }
            }
            
            updateAllUI();
            
            if (gameOver) {
                triggerEnding(gameOver);
                return false;
            }
            return true;
        }
		
        // ==================== UIæ›´æ–° ====================
        function updateAllUI() {
            updateAttributes();
            updateGraduation();
            updateBuffs();
            updateResearchResults();
            updateActionButtons();
            updateEventPreview();
        }

        function updateAttributes() {
            document.getElementById('san-value').textContent = gameState.san;
            document.getElementById('san-max').textContent = gameState.sanMax;
            document.getElementById('san-bar').style.width = `${Math.max(0, (gameState.san / gameState.sanMax) * 100)}%`;

            document.getElementById('research-value').textContent = gameState.research;
            document.getElementById('research-bar').style.width = `${(gameState.research / 20) * 100}%`;

            document.getElementById('social-value').textContent = gameState.social;
            document.getElementById('social-bar').style.width = `${(gameState.social / 20) * 100}%`;

            document.getElementById('favor-value').textContent = gameState.favor;
            document.getElementById('favor-bar').style.width = `${Math.max(0, (gameState.favor / 20) * 100)}%`;

            document.getElementById('gold-value').textContent = gameState.gold;
            updateCharacterDisplay();
        }

        function updateCharacterDisplay() {
            const charData = characters.find(c => c.id === gameState.character);
            if (!charData) return;
            
            const displayData = gameState.isReversed && charData.reversed ? charData.reversed : charData;
            const isAwakened = gameState.reversedAwakened || (gameState.degree === 'phd' && !gameState.isReversed);
            
            const icon = isAwakened
                ? (gameState.isReversed ? displayData.awakenIcon : charData.awakenIcon)
                : displayData.icon;
            
            document.getElementById('char-icon').textContent = icon;
            document.getElementById('char-name').textContent = displayData.name;
            
            const modeEl = document.getElementById('char-mode');
            if (gameState.isReversed) {
                modeEl.textContent = 'ğŸŒ‘ é€†ä½';
                modeEl.className = 'char-mode reversed-mode';
            } else {
                modeEl.textContent = 'â˜€ï¸ æ­£ä½';
                modeEl.className = 'char-mode normal-mode';
            }
        }

        function showCharacterDetail() {
            const charData = characters.find(c => c.id === gameState.character);
            if (!charData) return;
            
            const isReversed = gameState.isReversed;
            const displayData = isReversed && charData.reversed ? charData.reversed : charData;
            const isAwakened = gameState.reversedAwakened || (gameState.degree === 'phd' && !isReversed);
            
            const currentIcon = isAwakened
                ? (isReversed ? displayData.awakenIcon : charData.awakenIcon)
                : displayData.icon;
            
            const modeColor = isReversed ? '#9b59b6' : '#6c5ce7';
            const modeText = isReversed ? 'ğŸŒ‘ é€†ä½æ¨¡å¼' : 'â˜€ï¸ æ­£ä½æ¨¡å¼';
            
            let html = `
                <div style="text-align:center;margin-bottom:15px;">
                    <div style="font-size:3rem;margin-bottom:8px;">${currentIcon}</div>
                    <div style="font-size:1.2rem;font-weight:700;color:${modeColor};">${displayData.name}</div>
                    <div style="font-size:0.8rem;color:var(--text-secondary);margin-top:4px;">${modeText}</div>
                    ${isAwakened ? '<div style="margin-top:6px;"><span style="padding:3px 10px;background:linear-gradient(135deg,#f39c12,#e74c3c);color:white;border-radius:12px;font-size:0.75rem;">âš¡ å·²è§‰é†’</span></div>' : ''}
                </div>
                
                <div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:10px;">
                    <div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:5px;">ğŸ“œ è§’è‰²æè¿°</div>
                    <div style="font-size:0.85rem;">${displayData.desc}</div>
                </div>
                
                <div style="background:var(--light-bg);border-radius:10px;padding:12px;margin-bottom:10px;">
                    <div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:5px;">âœ¨ åˆå§‹æ•ˆæœ</div>
                    <div style="font-size:0.85rem;color:var(--success-color);font-weight:500;">${displayData.bonus}</div>
                </div>
                
                <div style="background:${isReversed ? 'rgba(155,89,182,0.1)' : 'rgba(102,126,234,0.1)'};border-radius:10px;padding:12px;border:1px dashed ${modeColor};">
                    <div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:5px;">âš¡ è½¬åšè§‰é†’: ${isReversed ? displayData.awakenName : charData.awakenName}</div>
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:5px;">
                        <span style="font-size:1.2rem;">${isReversed ? displayData.awakenIcon : charData.awakenIcon}</span>
                        <span style="font-size:0.9rem;font-weight:600;color:${modeColor};">${isReversed ? displayData.awakenName : charData.awakenName}</span>
                    </div>
                    <div style="font-size:0.85rem;">${isReversed ? displayData.awakenDesc : charData.awakenDesc}</div>
                    ${isAwakened ? '<div style="margin-top:6px;font-size:0.7rem;color:var(--success-color);">âœ“ å·²æ¿€æ´»</div>' : '<div style="margin-top:6px;font-size:0.7rem;color:var(--text-secondary);">æœªæ¿€æ´» - è½¬åšæ—¶è§¦å‘</div>'}
                </div>
            `;
            
            showModal('ğŸ‘¤ è§’è‰²è¯¦æƒ…', html, [{ text: 'å…³é—­', class: 'btn-primary', action: closeModal }]);
        }

        function updateGraduation() {
            document.getElementById('current-year').textContent = gameState.year;
            document.getElementById('current-month').textContent = gameState.month;
            const remaining = (gameState.maxYears * 12) - gameState.totalMonths;
            document.getElementById('remaining-time').textContent = remaining;
            document.getElementById('graduation-target').textContent = 
                gameState.degree === 'master' ? 'ğŸ¯ ç¡•å£«ï¼šç§‘ç ”åˆ†â‰¥1' : 'ğŸ¯ åšå£«ï¼šç§‘ç ”åˆ†â‰¥7';
        }

		function updateBuffs() {
			const list = document.getElementById('buff-list');
			const allBuffs = [...gameState.buffs.permanent, ...gameState.buffs.temporary];
			
			if (!gameState.triggeredBuffTypes) {
				gameState.triggeredBuffTypes = [];
			}
			allBuffs.forEach(buff => {
				if (buff.type && !gameState.triggeredBuffTypes.includes(buff.type)) {
					gameState.triggeredBuffTypes.push(buff.type);
				}
			});
			
			if (gameState.hasLover) {
				const loverBuffName = gameState.loverType === 'beautiful' 
					? 'ğŸ’•æ‹äºº(SAN+3,é‡‘-1)' 
					: 'ğŸ’•èªæ…§æ‹äºº(é‡‘-1)';
				allBuffs.push({ type: 'lover', name: loverBuffName, permanent: true, isLove: true });
			}
			
			if (gameState.ailabInternship) {
				const sanCost = gameState.isReversed && gameState.character === 'normal' 
					? (gameState.reversedAwakened ? 9 : 6) 
					: 3;
				allBuffs.push({ 
					type: 'internship', 
					name: `ğŸ¢AILabå®ä¹ (é‡‘+2,SAN-${sanCost})`, 
					permanent: true, 
					isInternship: true 
				});
			}
			
			if (allBuffs.length === 0) {
				list.innerHTML = '<span style="color:var(--text-secondary);font-size:0.8rem;">æš‚æ— æ•ˆæœ</span>';
				return;
			}
            
            const mergedMap = {};
            allBuffs.forEach(buff => {
                if (buff.isLove) {
                    mergedMap['lover'] = buff;
                    return;
                }
                if (buff.isInternship) {
                    mergedMap['internship'] = buff;
                    return;
                }

                if (buff.type === 'mentorship') {
                    mergedMap['mentorship'] = buff;
                    return;
                }
                
                const key = `${buff.type}_${buff.multiply ? 'mul' : 'add'}_${buff.permanent ? 'perm' : 'temp'}`;
                
                if (mergedMap[key]) {
                    if (buff.multiply) {
                        mergedMap[key].value += (buff.value - 1);
                    } else {
                        mergedMap[key].value += buff.value;
                    }
                } else {
                    mergedMap[key] = { ...buff };
                }
                
                if (buff.multiply && mergedMap[key].value < 0) {
                    mergedMap[key].value = 0;
                }
            });
            
            const merged = Object.values(mergedMap).map(buff => {
                if (buff.isLove) {
                    return { name: buff.name, permanent: true, isLove: true, isDebuff: false };
                }
                if (buff.isInternship) {
                    return { name: buff.name, permanent: true, isInternship: true, isDebuff: false };
                }

                if (buff.type === 'mentorship') {
                    return { 
                        name: buff.name, 
                        desc: buff.desc,
                        permanent: true, 
                        isLove: false, 
                        isDebuff: false,
                        isMentorship: true 
                    };
                }
                
                let name = '';
                const prefix = buff.permanent ? 'æ¯æ¬¡' : 'ä¸‹æ¬¡';
                const typeNames = {
                    'idea_bonus': 'æƒ³ideaåˆ†æ•°',
                    'exp_bonus': 'åšå®éªŒåˆ†æ•°',
                    'write_bonus': 'å†™è®ºæ–‡åˆ†æ•°',
                    'idea_times': 'æƒ³idea',
                    'exp_times': 'åšå®éªŒ',
                    'write_times': 'å†™è®ºæ–‡',
                    'monthly_san': 'æ¯æœˆSAN',
                    'read_san_reduce': 'è¯»è®ºæ–‡SAN',
                    'write_san_reduce': 'å†™è®ºæ–‡SAN',
                    'citation_multiply': 'ä¸­ç¨¿å¼•ç”¨'
                };
                
                const typeName = typeNames[buff.type] || buff.type;
                let isDebuff = false;
                
                if (buff.type.includes('_times')) {
                    name = `${prefix}${typeName}+${buff.value}æ¬¡`;
                } else if (buff.type === 'monthly_san') {
                    name = `æ¯æœˆSAN+${buff.value}`;
                } else if (buff.type === 'read_san_reduce') {
                    name = `è¯»è®ºæ–‡SAN-1`;
                } else if (buff.type === 'write_san_reduce') {
                    name = `å†™è®ºæ–‡SAN-3`;
                } else if (buff.type === 'citation_multiply') {
                    name = `ä¸‹ç¯‡ä¸­ç¨¿å¼•ç”¨Ã—${buff.value}`;
                } else if (buff.multiply) {
                    if (buff.value < 1) isDebuff = true;
                    name = `${prefix}${typeName}Ã—${buff.value}`;
                } else {
                    if (buff.value < 0) isDebuff = true;
                    const sign = buff.value >= 0 ? '+' : '';
                    name = `${prefix}${typeName}${sign}${buff.value}`;
                }
                
                return { name, permanent: buff.permanent, isLove: false, isDebuff };
            });
            
            list.innerHTML = merged.map(buff => {
                let tagClass = 'buff-tag ';
                if (buff.isLove) tagClass += 'love';
                else if (buff.isInternship) tagClass += 'temporary';
                else if (buff.isSpecial) tagClass += 'debuff';  // ç‰¹æ®Šæ•ˆæœç”¨çº¢è‰²
                else if (buff.isMentorship) tagClass += 'permanent';
                else if (buff.isDebuff) tagClass += 'debuff';
                else if (buff.permanent) tagClass += 'permanent';
                else tagClass += 'temporary';
                
                const icon = buff.isLove ? 'fa-heart' :
                            buff.isInternship ? 'fa-building' :
                            buff.isSpecial ? 'fa-coins' :
                            buff.isMentorship ? 'fa-user-graduate' :
                            buff.isDebuff ? 'fa-arrow-down' : 
                            buff.permanent ? 'fa-infinity' : 'fa-clock';
                
                const descText = buff.isMentorship && buff.desc ? ` (${buff.desc})` : '';
                
                return `<span class="${tagClass}">
                    <i class="fas ${icon}"></i>
                    ${buff.name}${descText}
                </span>`;
            }).join('');
        }

        function updateResearchResults() {
            document.getElementById('paper-a-count').textContent = gameState.paperA;
            document.getElementById('paper-b-count').textContent = gameState.paperB;
            document.getElementById('paper-c-count').textContent = gameState.paperC;
            document.getElementById('total-score').textContent = gameState.totalScore;
            document.getElementById('total-citations').textContent = gameState.totalCitations;
            document.getElementById('paper-total-count').textContent = gameState.publishedPapers.length;

            const paperList = document.getElementById('published-papers');
            if (gameState.publishedPapers.length === 0) {
                paperList.innerHTML = '<p style="color:var(--text-secondary);font-size:0.75rem;text-align:center;">æš‚æ— å·²å‘è¡¨è®ºæ–‡</p>';
            } else {
                paperList.innerHTML = gameState.publishedPapers.map((p, index) => `
                    <div class="paper-item grade-${p.grade}">
                        <div class="title">${p.title}</div>
                        <div class="meta">
                            <span>${p.grade}ç±»|${p.acceptType}</span>
                            <span>åˆ†:${p.score} å¼•:${p.citations}${p.citationMultiplier > 1 ? ' (Ã—' + p.citationMultiplier.toFixed(2) + ')' : ''}</span>
                        </div>
                        <div class="paper-promotions" style="margin-top:6px;display:flex;flex-wrap:wrap;gap:3px;">
                            <button class="btn ${p.promotions?.arxiv ? '' : 'btn-info'}" 
                                style="padding:2px 5px;font-size:0.6rem;${p.promotions?.arxiv ? 'opacity:0.5;background:#ccc;color:#666;cursor:default;' : ''}" 
                                onclick="promotePaper(${index}, 'arxiv')" 
                                ${p.promotions?.arxiv ? 'disabled' : ''}>
                                ${p.promotions?.arxiv ? 'âœ“arxiv' : 'æŒ‚arxiv'}
                            </button>
                            <button class="btn ${p.promotions?.github ? '' : 'btn-success'}" 
                                style="padding:2px 5px;font-size:0.6rem;${p.promotions?.github ? 'opacity:0.5;background:#ccc;color:#666;cursor:default;' : ''}" 
                                onclick="promotePaper(${index}, 'github')" 
                                ${p.promotions?.github ? 'disabled' : ''}>
                                ${p.promotions?.github ? 'âœ“å¼€æº' : 'githubå¼€æº'}
                            </button>
                            <button class="btn ${p.promotions?.xiaohongshu ? '' : 'btn-accent'}" 
                                style="padding:2px 5px;font-size:0.6rem;${p.promotions?.xiaohongshu ? 'opacity:0.5;background:#ccc;color:#666;cursor:default;' : ''}" 
                                onclick="promotePaper(${index}, 'xiaohongshu')" 
                                ${p.promotions?.xiaohongshu ? 'disabled' : ''}>
                                ${p.promotions?.xiaohongshu ? 'âœ“å°çº¢ä¹¦' : 'å°çº¢ä¹¦å®£ä¼ '}
                            </button>
                            <button class="btn ${p.promotions?.quantumbit ? '' : (p.grade === 'A' ? 'btn-warning' : '')}" 
                                style="padding:2px 5px;font-size:0.6rem;${p.promotions?.quantumbit || p.grade !== 'A' ? 'opacity:0.5;background:#ccc;color:#666;cursor:default;' : ''}" 
                                onclick="promotePaper(${index}, 'quantumbit')" 
                                ${p.promotions?.quantumbit || p.grade !== 'A' ? 'disabled' : ''}
                                title="${p.grade !== 'A' ? 'ä»…Aç±»è®ºæ–‡å¯ç”¨' : ''}">
                                ${p.promotions?.quantumbit ? 'âœ“é‡å­ä½' : (p.grade !== 'A' ? 'é‡å­ä½(ä»…Aç±»)' : 'é‡å­ä½å°é¢')}
                            </button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function getActionCosts() {
            const has4K = gameState.buffs.permanent.some(b => b.type === 'read_san_reduce');
            const hasKeyboard = gameState.buffs.permanent.some(b => b.type === 'write_san_reduce');
            
            return {
                read: { san: has4K ? -1 : -2 },
                work: { san: -5, gold: 2 },
                idea: { san: -2 },
                experiment: { san: -3 },
                write: { san: hasKeyboard ? -3 : -4 }
            };
        }

        function formatCost(cost) {
            const parts = [];
            if (cost.san) parts.push(`<span style="color:${cost.san > 0 ? 'var(--success-color)' : 'var(--danger-color)'}">SAN${cost.san > 0 ? '+' : ''}${cost.san}</span>`);
            if (cost.gold) parts.push(`<span style="color:${cost.gold > 0 ? 'var(--success-color)' : 'var(--danger-color)'}">ğŸ’°${cost.gold > 0 ? '+' : ''}${cost.gold}</span>`);
            return parts.join(' ');
        }

        function updateActionButtons() {
            const btns = ['btn-read', 'btn-work', 'btn-idea', 'btn-experiment', 'btn-write'];
            btns.forEach(id => {
                const btn = document.getElementById(id);
                btn.disabled = gameState.actionUsed;
                btn.style.opacity = gameState.actionUsed ? '0.5' : '1';
            });
            
            const costs = getActionCosts();
            
            document.getElementById('btn-read').innerHTML = `<i class="fas fa-book-open"></i><span>çœ‹è®ºæ–‡</span><span class="action-cost">${formatCost(costs.read)}</span>`;
            document.getElementById('btn-work').innerHTML = `<i class="fas fa-briefcase"></i><span>æ‰“å·¥</span><span class="action-cost">${formatCost(costs.work)}</span>`;
            document.getElementById('btn-idea').innerHTML = `<i class="fas fa-lightbulb"></i><span>æƒ³idea</span><span class="action-cost">${formatCost(costs.idea)}</span>`;
            document.getElementById('btn-experiment').innerHTML = `<i class="fas fa-vial"></i><span>åšå®éªŒ</span><span class="action-cost">${formatCost(costs.experiment)}</span>`;
            document.getElementById('btn-write').innerHTML = `<i class="fas fa-pen-fancy"></i><span>å†™è®ºæ–‡</span><span class="action-cost">${formatCost(costs.write)}</span>`;
        }

        // ==================== äº‹ä»¶é¢„å‘Šç³»ç»Ÿ ====================
        function getUpcomingEvents() {
            const events = [];
            
            for (let i = 1; i <= 2; i++) {
                let checkMonth = gameState.month + i;
                let checkYear = gameState.year;
                
                if (checkMonth > 12) {
                    checkMonth -= 12;
                    checkYear++;
                }
                
                const checkTotalMonths = gameState.totalMonths + i;
                const maxMonths = gameState.maxYears * 12;
                if (checkTotalMonths > maxMonths) continue;
                
                let eventName = null;
                let eventIcon = '';
                
                if (checkMonth === 5) {
                    eventName = 'å¯’å‡';
                    eventIcon = 'â„ï¸';
                } else if (checkMonth === 11) {
                    eventName = 'æš‘å‡';
                    eventIcon = 'â˜€ï¸';
                } else if (checkMonth === 1 && checkYear >= 2) {
                    eventName = 'å¥–å­¦é‡‘';
                    eventIcon = 'ğŸ“';
                } else if (checkMonth === 2) {
                    eventName = 'æ•™å¸ˆèŠ‚';
                    eventIcon = 'ğŸ';
                } else if (checkMonth % 2 === 0) {
                    eventName = 'éšæœºäº‹ä»¶';
                    eventIcon = 'ğŸ²';
                }
                
                if (eventName) {
                    events.push({
                        month: i,
                        name: eventName,
                        icon: eventIcon,
                        label: i === 1 ? 'ä¸‹æœˆ' : '2æœˆå'
                    });
                }
            }
            
            return events;
        }

        function updateEventPreview() {
            const previewEl = document.getElementById('event-preview');
            if (!previewEl) return;
            
            const events = getUpcomingEvents();
            
            if (events.length === 0) {
                previewEl.innerHTML = '';
                return;
            }
            
            const previewHtml = events.map(e => 
                `<span style="margin-left:6px;padding:2px 6px;background:${getEventColor(e.name)};border-radius:10px;font-size:0.6rem;white-space:nowrap;">${e.icon} ${e.label}:${e.name}</span>`
            ).join('');
            
            previewEl.innerHTML = `ğŸ“…${previewHtml}`;
        }

        function getEventColor(eventName) {
            const colors = {
                'å¯’å‡': 'rgba(116,185,255,0.25)',
                'æš‘å‡': 'rgba(253,203,110,0.25)',
                'å¥–å­¦é‡‘': 'rgba(108,92,231,0.25)',
                'æ•™å¸ˆèŠ‚': 'rgba(253,121,168,0.25)',
                'éšæœºäº‹ä»¶': 'rgba(0,184,148,0.2)'
            };
            return colors[eventName] || 'rgba(99,110,114,0.15)';
        }

        // ==================== ä¸‹ä¸€ä¸ªæœˆ ====================
		function nextMonth() {
			gameState.actionUsed = false;
			gameState.month++;
			gameState.totalMonths++;
			
			// â˜…â˜…â˜… è´ªæ±‚ä¹‹å¯Œå¯æ•Œå›½ï¼šåœ¨æœˆåˆæœ€å…ˆæ‰§è¡Œé‡ç½® â˜…â˜…â˜…
			if (gameState.isReversed && gameState.character === 'rich') {
				let shouldReset = false;
				if (gameState.reversedAwakened) {
					// è§‰é†’åï¼šåŠå¹´ï¼ˆ6ä¸ªæœˆï¼‰é‡ç½®ä¸€æ¬¡
					if (gameState.totalMonths - gameState.lastResetMonth >= 6) {
						shouldReset = true;
						gameState.lastResetMonth = gameState.totalMonths;
					}
				} else {
					// è§‰é†’å‰ï¼šæ¯æœˆé‡ç½®
					shouldReset = true;
				}
				
				if (shouldReset) {
					const oldSan = gameState.san;
					const oldResearch = gameState.research;
					const oldSocial = gameState.social;
					const oldFavor = gameState.favor;
					
					gameState.san = 0;
					gameState.research = 0;
					gameState.social = 0;
					gameState.favor = 0;
					
					const resetType = gameState.reversedAwakened ? 'åŠå¹´é‡ç½®' : 'æ¯æœˆé‡ç½®';
					addLog('é€†ä½æ•ˆæœ', `è´ªæ±‚ä¹‹${resetType}`, 
						`SAN ${oldSan}â†’0, ç§‘ç ” ${oldResearch}â†’0, ç¤¾äº¤ ${oldSocial}â†’0, å¥½æ„Ÿ ${oldFavor}â†’0`);
				}
			}
					
			let newYearBonus = false;
			if (gameState.month > 12) {
				gameState.month = 1;
				gameState.year++;
				
				if (gameState.year >= 2) {
					newYearBonus = true;
					gameState.social = Math.min(20, gameState.social + 1);
					gameState.favor = Math.min(20, gameState.favor + 1);
				}
			}

			const salary = gameState.degree === 'master' ? 1 : 3;
			
			// â˜…â˜…â˜… è´ªæ±‚ä¹‹å¯Œå¯æ•Œå›½ï¼šåªä¿ç•™æ¯æœˆ+3é‡‘ï¼Œç§»é™¤é‡ç½®é€»è¾‘ï¼ˆå·²åœ¨ä¸Šé¢æ‰§è¡Œï¼‰â˜…â˜…â˜…
			let extraGold = 0;
			if (gameState.isReversed && gameState.character === 'rich') {
				extraGold = 3;
			}
			
			gameState.gold += salary - 1 + extraGold;

			let sanRecovery = 1;
			if (gameState.isReversed && gameState.character === 'normal') {
				sanRecovery = gameState.reversedAwakened ? 5 : 3;
			}
			gameState.san = Math.min(gameState.sanMax, gameState.san + sanRecovery);

			if (gameState.hasLover) {
				if (gameState.loverType === 'beautiful') {
					gameState.san = Math.min(gameState.sanMax, gameState.san + 3);
				}
				
				gameState.gold -= 1;
				
				// å¯Œå¯æ•Œå›½è§‰é†’ï¼šæ‹çˆ±å¼€é”€ä¹Ÿç®—æ¶ˆè´¹
				if (gameState.isReversed && gameState.character === 'rich' && gameState.reversedAwakened) {
					gameState.goldSpentTotal = (gameState.goldSpentTotal || 0) + 1;
					
					const attributeGains = Math.floor(gameState.goldSpentTotal / 6);
					const previousGains = Math.floor((gameState.goldSpentTotal - 1) / 6);
					const newGains = attributeGains - previousGains;
					
					if (newGains > 0) {
						gameState.san = Math.min(gameState.sanMax, gameState.san + newGains);
						gameState.research = Math.min(20, gameState.research + newGains);
						gameState.social = Math.min(20, gameState.social + newGains);
						gameState.favor = Math.min(20, gameState.favor + newGains);
						addLog('é€†ä½æ•ˆæœ', 'é‡‘é’±è§‰é†’', `ç´¯è®¡æ¶ˆè´¹${gameState.goldSpentTotal}é‡‘ â†’ SAN+${newGains}, ç§‘ç ”+${newGains}, ç¤¾äº¤+${newGains}, å¥½æ„Ÿ+${newGains}`);
					}
				}
				
				if (gameState.gold < 0) {
					triggerEnding('poor');
					return;
				}
			}

			// â˜…â˜…â˜… AILab å®ä¹ æ•ˆæœ - ç§»é™¤å¯¹è´ªæ±‚çš„ç‰¹æ®Šåˆ¤æ–­ â˜…â˜…â˜…
			if (gameState.ailabInternship) {
				gameState.gold += 2;
				
				const baseSanCost = 3;
				const actualSanCost = Math.abs(getActualSanChange(-baseSanCost));
				gameState.san -= actualSanCost;
				
				if (gameState.san < 0) {
					triggerEnding('burnout');
					return;
				}
			}

			// â˜…â˜…â˜… äººä½“å·¥å­¦æ¤…æ•ˆæœ - ç§»é™¤å¯¹è´ªæ±‚çš„ç‰¹æ®Šåˆ¤æ–­ â˜…â˜…â˜…
			if (gameState.buffs.permanent.some(b => b.type === 'monthly_san')) {
				gameState.san = Math.min(gameState.sanMax, gameState.san + 1);
			}
			
			const mentorshipBuff = gameState.buffs.permanent.find(b => b.type === 'mentorship');
			if(mentorshipBuff) {
				const baseSanCost = 1;
				const actualSanCost = Math.abs(getActualSanChange(-baseSanCost));
				
				changeSan(-baseSanCost);
				
				const researchBonus = gameState.research;
				gameState.totalCitations += researchBonus;
				gameState.publishedPapers.forEach(paper => {
					paper.citations += Math.floor(researchBonus / gameState.publishedPapers.length);
				});
				
				let sanText = `SAN-${actualSanCost}`;
				if (actualSanCost !== baseSanCost) {
					sanText += `ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰`;
				}
				addLog('é•¿æœŸåˆä½œ', 'æŒ‡å¯¼å¸ˆå¼Ÿå¸ˆå¦¹çš„æˆæœ', `${sanText}ï¼Œæ€»å¼•ç”¨+${researchBonus}`);
			}

            // ç©ä¸–ä¹‹å¯¼å¸ˆå­å¥³ï¼šæ¯æœˆå¥½æ„Ÿ-1ï¼ˆä¸ç¿»å€ï¼‰
            if (gameState.isReversed && gameState.character === 'teacher-child') {
                const oldFavor = gameState.favor;
                gameState.favor = gameState.favor - 1;
                const decreased = Math.max(0, oldFavor - gameState.favor);
                if (decreased > 0) {
                    gameState.san = Math.min(gameState.sanMax, gameState.san + decreased);
                    gameState.gold += decreased;
                    addLog('é€†ä½æ•ˆæœ', 'ç©ä¸–ä¸æ­ï¼ˆæ¯æœˆï¼‰', `å¥½æ„Ÿåº¦-${decreased} â†’ SAN+${decreased}, é‡‘é’±+${decreased}`);
                }
                
                if (gameState.favor < 0) {
                    triggerEnding('expelled');
                    return;
                }
            }
            
            // ç©ºæƒ³ä¹‹å¤©é€‰ä¹‹äººï¼šæ¯æœˆéšæœºäº¤æ¢å±æ€§
            if (gameState.isReversed && gameState.character === 'chosen') {
                processChosenSwap();
            }

            // è®ºæ–‡åˆ†æ•°è¡°å‡
            let decayLogs = [];
            gameState.papers.forEach((paper, idx) => {
                if (paper) {
                    let decayInfo = [];
                    if (paper.ideaScore > 1) {
                        paper.ideaScore--;
                        decayInfo.push(`idea-1`);
                    }
                    if (paper.expScore > 1) {
                        paper.expScore--;
                        decayInfo.push(`å®éªŒ-1`);
                    }
                    if (decayInfo.length > 0) {
                        const status = paper.reviewing ? '(å®¡ç¨¿ä¸­)' : '';
                        decayLogs.push(`æ§½${idx + 1}${status}:${decayInfo.join('ï¼Œ')}`);
                    }
                }
            });

            // å®¡ç¨¿è¿›åº¦
            gameState.papers.forEach((paper, idx) => {
                if (paper && paper.reviewing) {
                    paper.reviewMonths--;
                    if (paper.reviewMonths < 1) {
                        paper.reviewMonths = 0;
                        setTimeout(() => {
                            if (gameState.papers[idx] && gameState.papers[idx].reviewing) {
                                processPaperResult(idx);
                            }
                        }, 100 * idx);
                    }
                }
            });

            // æ›´æ–°å¼•ç”¨
            updateCitations();

            // é‡ç½®æœˆåº¦å•†å“
            shopItems.forEach(item => {
                if (item.monthlyOnce) item.boughtThisMonth = false;
            });

            // æ—¥å¿—
            if (newYearBonus) {
				addLog('ğŸŠ æ–°çš„ä¸€å¹´', `ç¬¬${gameState.year}å¹´å¼€å§‹äº†`, 'ä¸å¯¼å¸ˆå’ŒåŒå­¦çš„ç£¨åˆæ›´åŠ é¡ºåˆ©ï¼Œç¤¾äº¤èƒ½åŠ›+1ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦+1');
			}

            let logResult = `å·¥èµ„+${salary}ï¼Œå¼€é”€-1`;
            if (extraGold > 0) logResult += `ï¼Œé€†ä½é¢å¤–+${extraGold}é‡‘`;
            logResult += `ï¼Œä¼‘æ¯SAN+${sanRecovery}`;
            if (gameState.hasLover) {
				if (gameState.loverType === 'beautiful') {
					logResult += 'ï¼Œæ‹äººSAN+3';
				}
				logResult += 'ï¼Œçº¦ä¼š-1é‡‘';
			}
			if (gameState.ailabInternship) {
				const actualSanCost = Math.abs(getActualSanChange(-3));
				logResult += `ï¼Œå®ä¹ +2é‡‘ï¼Œå®ä¹ SAN-${actualSanCost}`;
			}
            
			if (gameState.buffs.permanent.some(b => b.type === 'monthly_san')) {
				logResult += 'ï¼Œå·¥å­¦æ¤…SAN+1';
			}
            addLog('è¿›å…¥ä¸‹ä¸€æœˆ', `ç¬¬${gameState.year}å¹´ç¬¬${gameState.month}æœˆ`, logResult);

            if (decayLogs.length > 0) {
                addLog('æ—¶æ•ˆæ€§é™ä½', 'è®ºæ–‡åˆ†æ•°è‡ªç„¶è¡°å‡', decayLogs.join('ï¼›'));
            }

            // äº‹ä»¶è§¦å‘
            if (gameState.month === 5) {
                triggerWinterVacationEvent();
            } else if (gameState.month === 11) {
                triggerSummerVacationEvent();
            } else if (gameState.month === 1 && gameState.year >= 2) {
                triggerScholarshipEvent();
            } else if (gameState.month === 2) {
                triggerTeachersDayEvent();
            } else if (gameState.month % 2 === 0) {
                triggerOtherRandomEvent();
            }
            
            // æ£€æŸ¥æ¯•ä¸š
            checkGraduation();

            updateAllUI();
            renderPaperSlots();
        }

        // ç©ºæƒ³ä¹‹å¤©é€‰ä¹‹äººï¼šå±æ€§éšæœºäº¤æ¢
        function processChosenSwap() {
            if (gameState.reversedAwakened) {
                const values = [gameState.research, gameState.social, gameState.favor, gameState.san, gameState.gold];
                const shuffled = shuffle([...values]);
                
                const oldStats = `ç§‘ç ”${gameState.research}/ç¤¾äº¤${gameState.social}/å¥½æ„Ÿ${gameState.favor}/SAN${gameState.san}/é‡‘${gameState.gold}`;
                
                gameState.research = Math.min(20, Math.max(0, shuffled[0]));
                gameState.social = Math.min(20, Math.max(0, shuffled[1]));
                gameState.favor = Math.min(20, Math.max(0, shuffled[2]));
                gameState.san = Math.min(gameState.sanMax, Math.max(0, shuffled[3]));
                gameState.gold = shuffled[4];
                
                const newStats = `ç§‘ç ”${gameState.research}/ç¤¾äº¤${gameState.social}/å¥½æ„Ÿ${gameState.favor}/SAN${gameState.san}/é‡‘${gameState.gold}`;
                addLog('å‘½è¿è½®ç›˜', 'å…¨å±æ€§éšæœºäº¤æ¢', `${oldStats} â†’ ${newStats}`);
            } else {
                const stats1 = [gameState.research, gameState.social, gameState.favor];
                const shuffled1 = shuffle([...stats1]);
                
                const stats2 = [gameState.san, gameState.gold];
                const shuffled2 = shuffle([...stats2]);
                
                const oldStats = `ç§‘ç ”${gameState.research}/ç¤¾äº¤${gameState.social}/å¥½æ„Ÿ${gameState.favor} | SAN${gameState.san}/é‡‘${gameState.gold}`;
                
                gameState.research = Math.min(20, Math.max(0, shuffled1[0]));
                gameState.social = Math.min(20, Math.max(0, shuffled1[1]));
                gameState.favor = Math.min(20, Math.max(0, shuffled1[2]));
                gameState.san = Math.min(gameState.sanMax, Math.max(0, shuffled2[0]));
                gameState.gold = shuffled2[1];
                
                const newStats = `ç§‘ç ”${gameState.research}/ç¤¾äº¤${gameState.social}/å¥½æ„Ÿ${gameState.favor} | SAN${gameState.san}/é‡‘${gameState.gold}`;
                addLog('å‘½è¿è½®ç›˜', 'å±æ€§éšæœºäº¤æ¢', `${oldStats} â†’ ${newStats}`);
            }
            
            checkResearchUnlock();
        }

		function updateCitations() {
			gameState.publishedPapers.forEach(paper => {
				paper.monthsSincePublish = (paper.monthsSincePublish || 0) + 1;
				
				// â˜…â˜…â˜… æ–°å¢ï¼šè®¡ç®—å¼•ç”¨è¡°å‡ç³»æ•° â˜…â˜…â˜…
				// æ¨¡æ‹Ÿè®ºæ–‡çƒ­åº¦æ›²çº¿ï¼šå…ˆå‡åé™
				let decayFactor;
				const age = paper.monthsSincePublish;
				
				if (age <= 6) {
					// åˆæœŸï¼šçƒ­åº¦ä¸Šå‡æœŸï¼Œç³»æ•°ä»0.8å‡åˆ°1.2
					decayFactor = 0.8 + (age / 6) * 0.4;
				} else if (age <= 18) {
					// é«˜å³°æœŸï¼šç³»æ•°ä»1.2é€æ¸é™åˆ°0.6
					decayFactor = 1.2 - ((age - 6) / 12) * 0.6;
				} else if (age <= 36) {
					// è¡°å‡æœŸï¼šç³»æ•°ä»0.6é™åˆ°0.3
					decayFactor = 0.6 - ((age - 18) / 18) * 0.3;
				} else {
					// é•¿å°¾æœŸï¼šç»´æŒ0.2çš„æœ€ä½å¢é•¿
					decayFactor = 0.2;
				}
				
				let shouldUpdate = false;
				if (paper.grade === 'A') shouldUpdate = true;
				else if (paper.grade === 'B' && paper.monthsSincePublish % 3 === 0) shouldUpdate = true;
				else if (paper.grade === 'C' && paper.monthsSincePublish % 6 === 0) shouldUpdate = true;

				if (shouldUpdate) {
					let gain = Math.round(paper.score / 10);
					if (paper.acceptType === 'Oral') gain = Math.round(gain * 1.5);
					if (paper.acceptType === 'Best Paper') gain = Math.round(gain * 5);
					gain = Math.round(gain * (paper.citationMultiplier || 1));
					
					// â˜…â˜…â˜… åº”ç”¨è¡°å‡ç³»æ•° â˜…â˜…â˜…
					gain = Math.max(1, Math.round(gain * decayFactor));
					
					paper.citations += gain;
					gameState.totalCitations += gain;
				}
			});
		}
		
        // ==================== æ¯•ä¸šæ£€æŸ¥ ====================
        function checkGraduation() {
            if (gameState.pendingPhDChoice) {
                return;
            }
            
            const maxMonths = gameState.maxYears * 12;
            
            if (gameState.degree === 'master') {
                if ((gameState.year === 2 && gameState.month === 12 && gameState.totalScore >= 2) ||
                    (gameState.year === 3 && gameState.month === 12 && gameState.totalScore >= 3)) {
                    showPhDOptionModal();
                    return;
                }
            }
            
            if (gameState.totalMonths >= maxMonths) {
                if (gameState.degree === 'master') {
                    if (gameState.totalScore >= 1) {
                        triggerEnding('master');
                    } else {
                        triggerEnding('delay');
                    }
                } else if (gameState.degree === 'phd') {
                    if (gameState.totalScore >= 7) {
                        triggerEnding('phd');
                    } else {
                        triggerEnding('delay');
                    }
                }
                return;
            }
        }

        function showPhDOptionModal() {
            if (gameState.totalScore >= 7) {
                gameState.achievementConditions = gameState.achievementConditions || {};
                gameState.achievementConditions.phdRequirementMetEarly = true;
            }
            
            gameState.pendingPhDChoice = true;
            
            const isSecondYear = gameState.year === 2;
            const notPhDText = isSecondYear ? 'ç»§ç»­è¯»ç¡•å£«' : 'ç¡•å£«æ¯•ä¸š';
            const notPhDDesc = isSecondYear 
                ? '<p style="color:var(--text-secondary);font-size:0.85rem;">é€‰æ‹©ç»§ç»­è¯»ç¡•å£«ï¼Œæ˜å¹´è¿˜æœ‰ä¸€æ¬¡è½¬åšæœºä¼š</p>'
                : '';
            
            showModal('ğŸ“ è½¬åšé€‰æ‹©',
                `<p>æ­å–œï¼ä½ çš„ç§‘ç ”æˆç»©ä¼˜å¼‚ï¼ˆç§‘ç ”åˆ†${gameState.totalScore}ï¼‰ï¼Œè·å¾—äº†è½¬åšèµ„æ ¼ï¼</p>
                 <p>æ˜¯å¦é€‰æ‹©ç»§ç»­æ”»è¯»åšå£«å­¦ä½ï¼Ÿ</p>
                 <p style="color:var(--text-secondary);font-size:0.85rem;">åšå£«æ¯•ä¸šè¦æ±‚ï¼šç§‘ç ”åˆ†â‰¥7ï¼Œå­¦ä¹ å¹´é™5å¹´</p>
                 ${notPhDDesc}`,
                [
                    { text: notPhDText, class: 'btn-info', action: () => { 
                        gameState.pendingPhDChoice = false;
                        gameState.phdOpportunitiesRejected = (gameState.phdOpportunitiesRejected || 0) + 1;
                        if (gameState.phdOpportunitiesRejected >= 2) {
                            gameState.achievementConditions = gameState.achievementConditions || {};
                            gameState.achievementConditions.rejectedPhdTwice = true;
                        }
                        closeModal();
                        
                        if (isSecondYear) {
                            addLog('è½¬åšé€‰æ‹©', 'é€‰æ‹©ç»§ç»­è¯»ç¡•å£«', 'æ˜å¹´è¿˜æœ‰ä¸€æ¬¡è½¬åšæœºä¼š');
                            updateAllUI();
                            
                            if (gameState.pendingConference) {
                                const grade = gameState.pendingConference;
                                gameState.pendingConference = null;
                                setTimeout(() => showConferenceModal(grade), 300);
                            }
                        } else {
                            triggerEnding('master');
                        }
                    }},
                    { text: 'ğŸ“š è½¬ä¸ºåšå£«', class: 'btn-primary', action: () => {
                        gameState.pendingPhDChoice = false;
                        gameState.degree = 'phd';
                        gameState.maxYears = 5;
                        closeModal();
                        setTimeout(() => showPhDTribulationModal(), 200);
                    }}
                ]
            );
        }

        // â˜…â˜…â˜… å…³é”®ä¿®æ”¹ï¼šè½¬åšè§‰é†’å‡½æ•° â˜…â˜…â˜…
        function showPhDTribulationModal() {
            const character = gameState.character;
            let effectName = '';
            let effectDesc = '';
            let bonusDetails = [];
            
            // é€†ä½è§’è‰²è§‰é†’
            if (gameState.isReversed) {
                gameState.reversedAwakened = true;
                
                switch (character) {
                    case 'normal': // æ€ æƒ°ä¹‹å¤§å¤šæ•°
                        effectName = 'ğŸ’€ æè‡´æ€ æƒ°';
                        effectDesc = 'æ‡’æƒ°çš„æè‡´å°±æ˜¯ä¸€åˆ‡éƒ½ç¿»å€...åŒ…æ‹¬ç—›è‹¦';
                        const oldR1 = gameState.research, oldS1 = gameState.social, oldF1 = gameState.favor, oldG1 = gameState.gold;
                        gameState.research = Math.min(20, gameState.research * 2);
                        gameState.social = Math.min(20, gameState.social * 2);
                        gameState.favor = Math.min(20, gameState.favor * 2);
                        gameState.gold = gameState.gold * 2;
                        bonusDetails.push(`ç§‘ç ” ${oldR1} â†’ ${gameState.research}`);
                        bonusDetails.push(`ç¤¾äº¤ ${oldS1} â†’ ${gameState.social}`);
                        bonusDetails.push(`å¥½æ„Ÿ ${oldF1} â†’ ${gameState.favor}`);
                        bonusDetails.push(`é‡‘å¸ ${oldG1} â†’ ${gameState.gold}`);
                        bonusDetails.push('âš ï¸ SANå‡å°‘å˜ä¸º3å€');
                        bonusDetails.push('âœ¨ æ¯æœˆSANå›å¤å˜ä¸º5');
                        
                        const mentorshipBuff = gameState.buffs.permanent.find(b => b.type === 'mentorship');
                        if (mentorshipBuff) {
                            mentorshipBuff.desc = 'æ¯æœˆSAN-3ï¼ˆæ€ æƒ°Ã—3ï¼‰ï¼Œæ€»å¼•ç”¨+ç§‘ç ”èƒ½åŠ›å€¼';
                        }
                        break;
                        
                    case 'genius': // æ„šé’ä¹‹é™¢å£«è½¬ä¸–
                        effectName = 'ğŸ­ å¤§æ™ºè‹¥æ„š';
                        effectDesc = 'çœŸæ­£çš„æ™ºæ…§ä¸åœ¨äºç§‘ç ”æ•°å€¼';
                        bonusDetails.push('ç§‘ç ”æå‡è½¬åŒ–æ•ˆæœå‡çº§');
                        bonusDetails.push('æ¯1ç‚¹ç§‘ç ”æå‡ â†’ å¥½æ„Ÿ+2, SAN+6, ç¤¾äº¤+2, é‡‘+6');
                        break;
                        
                    case 'social': // å«‰å¦’ä¹‹ç¤¾äº¤è¾¾äºº
                        effectName = 'ğŸ‘ï¸ å«‰å¦’é‡ç½®';
                        effectDesc = 'ç¤¾äº¤èƒ½åŠ›é‡ç½®ï¼Œè§¦å‘è¿å¸¦æ•ˆæœ';
                        const oldSocialVal = gameState.social;
                        if (oldSocialVal > 5) {
                            const decrease = oldSocialVal - 5;
                            gameState.research = Math.min(20, gameState.research + decrease);
                            gameState.favor = Math.min(20, gameState.favor + decrease);
                            bonusDetails.push(`ç¤¾äº¤ ${oldSocialVal} â†’ 5`);
                            bonusDetails.push(`è§¦å‘å«‰å¦’è½¬åŒ–ï¼šç§‘ç ”+${decrease}, å¥½æ„Ÿ+${decrease}`);
                        } else if (oldSocialVal < 5) {
                            const increase = 5 - oldSocialVal;
                            gameState.san = Math.min(gameState.sanMax, gameState.san + increase);
                            gameState.gold += increase;
                            bonusDetails.push(`ç¤¾äº¤ ${oldSocialVal} â†’ 5`);
                            bonusDetails.push(`è§¦å‘å«‰å¦’åé¦ˆï¼šSAN+${increase}, é‡‘é’±+${increase}`);
                        } else {
                            bonusDetails.push('ç¤¾äº¤å·²ç»æ˜¯5ï¼Œæ— å˜åŒ–');
                        }
                        gameState.social = 5;
                        break;
                        
                    // â˜…â˜…â˜… å…³é”®ä¿®æ”¹ï¼šé€†ä½å¯Œå¯æ•Œå›½è§‰é†’ â˜…â˜…â˜…
                    case 'rich':
                        effectName = 'ğŸ‘‘ é‡‘é’±çš„åŠ›é‡';
                        effectDesc = 'åŠå¹´é‡ç½®ä¸€æ¬¡ï¼Œæ¶ˆè´¹é‡‘å¸å¯æå‡å±æ€§';
                        gameState.goldSpentTotal = 0;  // é‡ç½®æ¶ˆè´¹è®¡æ•°
                        gameState.lastResetMonth = gameState.totalMonths;  // è®°å½•è§‰é†’æ—¶é—´ç‚¹
                        bonusDetails.push('âœ¨ å±æ€§é‡ç½®å‘¨æœŸï¼šæ¯æœˆ â†’ æ¯åŠå¹´');
                        bonusDetails.push('âœ¨ æ¯èŠ±è´¹6é‡‘å¸ â†’ SAN+1, ç§‘ç ”+1, ç¤¾äº¤+1, å¥½æ„Ÿ+1');
                        bonusDetails.push('ğŸ’° å¿«å»èŠ±é’±æå‡å±æ€§å§ï¼');
                        break;
                        
                    case 'teacher-child': // ç©ä¸–ä¹‹å¯¼å¸ˆå­å¥³
                        effectName = 'ğŸƒ æµªå­å›å¤´';
                        effectDesc = 'å¥½æ„Ÿåº¦å€’ç½®ï¼Œä»å›é€†èµ°å‘å’Œè§£';
                        const oldFavorVal = gameState.favor;
                        const newFavorVal = Math.min(20, Math.max(0, 20 - oldFavorVal));
                        gameState.favor = newFavorVal;
                        bonusDetails.push(`å¥½æ„Ÿåº¦å€’ç½®ï¼š${oldFavorVal} â†’ ${newFavorVal} (20-${oldFavorVal})`);
                        break;
                        
                    case 'chosen': // ç©ºæƒ³ä¹‹å¤©é€‰ä¹‹äºº
                        effectName = 'ğŸ² å‘½è¿è½®ç›˜';
                        effectDesc = 'äº”å±æ€§å…¨éƒ¨åŠ å…¥è½®ç›˜èµŒå±€';
                        bonusDetails.push('æ¯æœˆéšæœºäº¤æ¢å‡çº§');
                        bonusDetails.push('ç§‘ç ”/ç¤¾äº¤/å¥½æ„Ÿ/SAN/é‡‘ å…¨éƒ¨å‚ä¸äº¤æ¢');
                        break;
                }
                
                checkResearchUnlock(true);
                
                const html = `
                    <div style="text-align:center;">
                        <div style="font-size:4rem;margin-bottom:15px;animation:pulse 1s infinite;">ğŸŒ‘</div>
                        <div style="font-size:1.5rem;font-weight:700;background:linear-gradient(135deg,#9b59b6,#e74c3c);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:10px;">
                            é€†ä½è§‰é†’ï¼
                        </div>
                        <div style="font-size:0.95rem;color:var(--text-secondary);margin-bottom:20px;">
                            é»‘æš—ä¸­è•´å«çš„åŠ›é‡å·²è¢«æ¿€æ´»...
                        </div>
                    </div>
                    
                    <div style="background:linear-gradient(135deg,rgba(155,89,182,0.2),rgba(231,76,60,0.2));border-radius:12px;padding:15px;margin-bottom:15px;border:2px solid rgba(231,76,60,0.5);">
                        <div style="text-align:center;margin-bottom:12px;">
                            <div style="font-size:1.3rem;font-weight:700;color:#e74c3c;margin-bottom:5px;">${effectName}</div>
                            <div style="font-size:0.85rem;color:var(--text-secondary);font-style:italic;">${effectDesc}</div>
                        </div>
                        <div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:12px;">
                            <div style="font-size:0.8rem;color:#a0a0a0;margin-bottom:8px;text-align:center;">ğŸŒ™ è§‰é†’æ•ˆæœ ğŸŒ™</div>
                            <div style="display:flex;flex-direction:column;gap:6px;">
                                ${bonusDetails.map(detail => `
                                    <div style="display:flex;align-items:center;justify-content:center;gap:8px;padding:6px 12px;background:linear-gradient(135deg,rgba(155,89,182,0.2),rgba(231,76,60,0.2));border-radius:6px;font-size:0.85rem;font-weight:500;color:#e74c3c;">
                                        ${detail.startsWith('âš ï¸') || detail.startsWith('âœ¨') || detail.startsWith('ğŸ’°') ? '' : '<i class="fas fa-moon"></i>'} ${detail}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align:center;padding:10px;background:rgba(0,0,0,0.1);border-radius:8px;font-size:0.85rem;">
                        <div style="color:#9b59b6;font-weight:600;margin-bottom:5px;">ğŸ“œ ç»§ç»­ä½ çš„é»‘æš—æ—…ç¨‹</div>
                        <div style="color:var(--text-secondary);">åšå£«æ¯•ä¸šè¦æ±‚ï¼šç§‘ç ”åˆ† â‰¥ 7</div>
                    </div>
                `;
                
                showModal('ğŸŒ‘ é€†ä½è§‰é†’', html, [
                    { text: 'ğŸŒ™ æ‹¥æŠ±é»‘æš—', class: 'btn-danger', action: () => {
                        addLog('é€†ä½è§‰é†’', `è§¦å‘ã€${effectName}ã€‘`, bonusDetails.join('ï¼Œ'));
                        closeModal();
                        updateAllUI();
                        renderPaperSlots();
                        
                        if (gameState.pendingConference) {
                            const grade = gameState.pendingConference;
                            gameState.pendingConference = null;
                            setTimeout(() => showConferenceModal(grade), 300);
                        }
                    }}
                ]);
                
                return;
            }
            
            // â˜…â˜…â˜… å…³é”®ä¿®æ”¹ï¼šæ­£ä½è§’è‰²è§‰é†’ â˜…â˜…â˜…
            switch (character) {
                case 'genius':
                    effectName = 'ğŸ§¬ å­¦æœ¯å¤©èµ‹è§‰é†’';
                    effectDesc = 'é™¢å£«è½¬ä¸–çš„è¡€è„‰å¼€å§‹æ²¸è…¾ï¼Œè¿‡å¾€æˆå°±åŒ–ä¸ºå®åŠ›ï¼';
					const aCount = gameState.paperA || 0;
					if (aCount > 0) {
						const researchGain = aCount * 2;
						gameState.research = Math.min(20, gameState.research + researchGain);
						bonusDetails.push(`Aç±»è®ºæ–‡ ${aCount} ç¯‡`);
						bonusDetails.push(`ç§‘ç ”èƒ½åŠ› +${researchGain}`);
					} else {
						bonusDetails.push('æš‚æ— Aç±»è®ºæ–‡ï¼Œç»§ç»­åŠªåŠ›ï¼');
					}
					break;
                    
				case 'social':
					effectName = 'ğŸŒ äººè„‰ç½‘ç»œæ¿€æ´»';
					effectDesc = 'ç¤¾äº¤è¾¾äººçš„äººè„‰å…¨é¢ç»½æ”¾ï¼Œå†¥å†¥ä¹‹ä¸­å½±å“äº†å®¡ç¨¿äººåˆ†å¸ƒï¼';
					gameState.socialAwakened = true;
					
					// â˜…â˜…â˜… æ ¹æ®å½“å‰ç¤¾äº¤è®¡ç®—å¹¶å›ºå®šæ¦‚ç‡åˆ†å¸ƒ â˜…â˜…â˜…
					const socialVal = gameState.social;
					let normalP = Math.max(0, 0.40 - socialVal * 0.01);
					let kindP = 0.10 + socialVal * 0.005;
					let expertP = 0.10 + socialVal * 0.01;
					let hostileP = Math.max(0, 0.10 - socialVal * 0.005);
					let gptP = Math.max(0, 0.20 - socialVal * 0.005);
					let questionsP = Math.max(0, 0.10 - socialVal * 0.005);
					
					// å½’ä¸€åŒ–
					const totalP = normalP + kindP + expertP + hostileP + gptP + questionsP;
					normalP /= totalP;
					kindP /= totalP;
					expertP /= totalP;
					hostileP /= totalP;
					gptP /= totalP;
					questionsP /= totalP;
					
					// â˜…â˜…â˜… ä¿å­˜å›ºå®šçš„æ¦‚ç‡åˆ†å¸ƒ â˜…â˜…â˜…
					gameState.reviewerDistribution = {
						normal: normalP,
						kind: kindP,
						expert: expertP,
						hostile: hostileP,
						gpt: gptP,
						questions: questionsP
					};
					
					bonusDetails.push(`è½¬åšæ—¶ç¤¾äº¤: ${socialVal}`);
					bonusDetails.push(`å®¡ç¨¿äººåˆ†å¸ƒå·²æ°¸ä¹…æ”¹å˜ï¼š`);
					bonusDetails.push(`æ™®é€šå®¡ç¨¿äºº ${(normalP * 100).toFixed(1)}%`);
					bonusDetails.push(`å¿ƒè½¯å®¡ç¨¿äºº ${(kindP * 100).toFixed(1)}%`);
					bonusDetails.push(`èµ„æ·±å¤§ç‰› ${(expertP * 100).toFixed(1)}%`);
					bonusDetails.push(`æ¶æ„å°åŒè¡Œ ${(hostileP * 100).toFixed(1)}%`);
					bonusDetails.push(`GPTå®¡ç¨¿äºº ${(gptP * 100).toFixed(1)}%`);
					bonusDetails.push(`40é—®é¢˜å®¡ç¨¿äºº ${(questionsP * 100).toFixed(1)}%`);
					break;
                    
                // â˜…â˜…â˜… å…³é”®ä¿®æ”¹ï¼šæ­£ä½å¯Œå¯æ•Œå›½è§‰é†’æ”¹ä¸ºÃ—3 â˜…â˜…â˜…
                case 'rich':
                    effectName = 'ğŸ’ è´¢å¯Œå€å¢æœ¯';
                    effectDesc = 'å¯Œå¯æ•Œå›½çš„åº•è•´æ˜¾ç°ï¼Œé‡‘å¸å‚¨å¤‡ç¬é—´ç¿»ä¸‰å€ï¼';
                    const oldGold = gameState.gold;
                    gameState.gold = gameState.gold * 3;  // â˜…â˜…â˜… æ”¹ä¸ºÃ—3 â˜…â˜…â˜…
                    bonusDetails.push(`é‡‘å¸ ${oldGold} â†’ ${gameState.gold} (Ã—3)`);
                    break;
                    
				case 'teacher-child':
					effectName = 'ğŸ‘‘ è¡€è„‰å…±é¸£';
					effectDesc = 'å¯¼å¸ˆå­å¥³çš„èº«ä»½ä¼˜åŠ¿å‡¸æ˜¾ï¼Œå°†äººè„‰è½¬åŒ–ä¸ºå®é™…èµ„æºï¼';
					const oldFavorTC = gameState.favor;
					if (oldFavorTC > 12) {
						const overflow = oldFavorTC - 12;
						gameState.favor = 12;
						gameState.research = Math.min(20, gameState.research + overflow);
						gameState.gold += overflow;
						bonusDetails.push(`å¯¼å¸ˆå¥½æ„Ÿåº¦ ${oldFavorTC} â†’ 12`);
						bonusDetails.push(`ç§‘ç ”èƒ½åŠ› +${overflow}`);
						bonusDetails.push(`é‡‘å¸ +${overflow}`);
					} else {
						bonusDetails.push(`å¯¼å¸ˆå¥½æ„Ÿåº¦æœªè¶…è¿‡12ï¼Œæš‚æ— è½¬åŒ–`);
					}
					break;
                    
                case 'chosen':
                    effectName = 'âœ¨ æŸ¥ç¼ºè¡¥æ¼';
                    effectDesc = 'å¤©é€‰ä¹‹äººçš„å‘½è¿é½¿è½®è½¬åŠ¨ï¼ŒçŸ­æ¿ç¬é—´è¡¥é½ï¼';
                    const maxStat = Math.max(gameState.research, gameState.social, gameState.favor);
                    const oldStats = { research: gameState.research, social: gameState.social, favor: gameState.favor };
                    gameState.research = Math.min(20, maxStat);
                    gameState.social = Math.min(20, maxStat);
                    gameState.favor = Math.min(20, maxStat);
                    if (oldStats.research !== maxStat) bonusDetails.push(`ç§‘ç ”èƒ½åŠ› ${oldStats.research} â†’ ${gameState.research}`);
                    if (oldStats.social !== maxStat) bonusDetails.push(`ç¤¾äº¤èƒ½åŠ› ${oldStats.social} â†’ ${gameState.social}`);
                    if (oldStats.favor !== maxStat) bonusDetails.push(`å¯¼å¸ˆå¥½æ„Ÿåº¦ ${oldStats.favor} â†’ ${gameState.favor}`);
                    if (bonusDetails.length === 0) bonusDetails.push('å±æ€§å·²è¾¾æœ€ä¼˜ï¼Œæ— éœ€è¡¥é½');
                    break;
                    
                case 'normal':
                default:
                    effectName = 'ğŸ”¥ æˆ‘å‘½ç”±æˆ‘ä¸ç”±å¤©';
                    effectDesc = 'å¹³å‡¡ä¹‹äººçˆ†å‘å‡ºæƒŠäººæ½œåŠ›ï¼Œå…¨é¢çªç ´è‡ªæˆ‘æé™ï¼';
                    const oldR = gameState.research, oldS = gameState.social, oldF = gameState.favor, oldG = gameState.gold;
                    gameState.research = Math.min(20, gameState.research * 2);
                    gameState.social = Math.min(20, gameState.social * 2);
                    gameState.favor = Math.min(20, gameState.favor * 2);
                    gameState.gold = gameState.gold * 2;
                    bonusDetails.push(`ç§‘ç ”èƒ½åŠ› ${oldR} â†’ ${gameState.research} (Ã—2)`);
                    bonusDetails.push(`ç¤¾äº¤èƒ½åŠ› ${oldS} â†’ ${gameState.social} (Ã—2)`);
                    bonusDetails.push(`å¯¼å¸ˆå¥½æ„Ÿåº¦ ${oldF} â†’ ${gameState.favor} (Ã—2)`);
                    bonusDetails.push(`é‡‘å¸ ${oldG} â†’ ${gameState.gold} (Ã—2)`);
                    break;
            }
            
            checkResearchUnlock(true);
            
            const html = `
                <div style="text-align:center;">
                    <div style="font-size:4rem;margin-bottom:15px;animation:pulse 1s infinite;">âš¡</div>
                    <div style="font-size:1.5rem;font-weight:700;background:linear-gradient(135deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:10px;">
                        æ¸¡åŠ«æˆåŠŸï¼
                    </div>
                    <div style="font-size:0.95rem;color:var(--text-secondary);margin-bottom:20px;">
                        æ­å–œçªç ´ç¡•å£«å¢ƒç•Œï¼Œæ™‹å‡åšå£«ä¿®ç‚¼è€…ï¼
                    </div>
                </div>
                
                <div style="background:linear-gradient(135deg,rgba(102,126,234,0.15),rgba(118,75,162,0.15));border-radius:12px;padding:15px;margin-bottom:15px;border:2px solid rgba(102,126,234,0.3);">
                    <div style="text-align:center;margin-bottom:12px;">
                        <div style="font-size:1.3rem;font-weight:700;color:#667eea;margin-bottom:5px;">${effectName}</div>
                        <div style="font-size:0.85rem;color:var(--text-secondary);font-style:italic;">${effectDesc}</div>
                    </div>
                    <div style="background:white;border-radius:8px;padding:12px;">
                        <div style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:8px;text-align:center;">âœ¨ è·å¾—åŠ æˆ âœ¨</div>
                        <div style="display:flex;flex-direction:column;gap:6px;">
                            ${bonusDetails.map(detail => `
                                <div style="display:flex;align-items:center;justify-content:center;gap:8px;padding:6px 12px;background:linear-gradient(135deg,rgba(0,184,148,0.1),rgba(85,239,196,0.1));border-radius:6px;font-size:0.9rem;font-weight:500;color:var(--success-color);">
                                    <i class="fas fa-arrow-up"></i> ${detail}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                
                <div style="text-align:center;padding:10px;background:var(--light-bg);border-radius:8px;font-size:0.85rem;">
                    <div style="color:var(--primary-color);font-weight:600;margin-bottom:5px;">ğŸ“œ æ–°çš„ä¿®ç‚¼ç›®æ ‡</div>
                    <div style="color:var(--text-secondary);">åšå£«æ¯•ä¸šè¦æ±‚ï¼šç§‘ç ”åˆ† â‰¥ 7</div>
                    <div style="color:var(--text-secondary);">ä¿®ç‚¼å¹´é™ï¼š5å¹´</div>
                </div>
            `;
            
            if (!document.getElementById('tribulation-style')) {
                const style = document.createElement('style');
                style.id = 'tribulation-style';
                style.textContent = `
                    @keyframes pulse {
                        0%, 100% { transform: scale(1); opacity: 1; }
                        50% { transform: scale(1.1); opacity: 0.8; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            showModal('âš¡ è½¬åšæ¸¡åŠ«', html, [
                { text: 'ğŸ¯ å¼€å¯åšå£«ä¿®ç‚¼ä¹‹è·¯', class: 'btn-primary', action: () => {
                    addLog('è½¬åšæ¸¡åŠ«', `è§¦å‘ã€${effectName}ã€‘`, bonusDetails.join('ï¼Œ'));
                    closeModal();
                    updateAllUI();
                    renderPaperSlots();
                    
                    if (gameState.pendingConference) {
                        const grade = gameState.pendingConference;
                        gameState.pendingConference = null;
                        setTimeout(() => showConferenceModal(grade), 300);
                    }
                }}
            ]);
        }
		
        // ==================== è®ºæ–‡æ¨å¹¿åŠŸèƒ½ ====================
        function promotePaper(index, type) {
            const paper = gameState.publishedPapers[index];
            if (!paper) return;

            if (!paper.promotions) {
                paper.promotions = { arxiv: false, github: false, xiaohongshu: false, quantumbit: false };
            }
            if (!paper.citationMultiplier) paper.citationMultiplier = 1;

            if (paper.promotions[type]) return;

            const typeNames = {
                arxiv: 'æŒ‚arxiv',
                github: 'githubå¼€æº',
                xiaohongshu: 'å°çº¢ä¹¦å®£ä¼ ',
                quantumbit: 'é‡å­ä½å°é¢'
            };

            let result = '';
            let canProceed = true;
            
            switch(type) {
                case 'arxiv': {
                    const baseSanCost = 3;
                    const actualSanCost = Math.abs(getActualSanChange(-baseSanCost));
                    
                    if (gameState.san < actualSanCost) {
                        const tipText = actualSanCost !== baseSanCost 
                            ? `<p>SANå€¼ä¸è¶³ï¼åŸºç¡€æ¶ˆè€—${baseSanCost}ç‚¹ï¼Œæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}åéœ€è¦${actualSanCost}ç‚¹SANå€¼ã€‚</p>` 
                            : `<p>SANå€¼ä¸è¶³ï¼éœ€è¦è‡³å°‘${baseSanCost}ç‚¹SANå€¼ã€‚</p>`;
                        showModal('âŒ æ“ä½œå¤±è´¥', tipText, 
                            [{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
                        return;
                    }
                    paper.promotions.arxiv = true;
                    paper.citationMultiplier *= 1.25;
                    const sanText = actualSanCost !== baseSanCost 
                        ? `SANå€¼-${actualSanCost}ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰` 
                        : `SANå€¼-${baseSanCost}`;
                    result = `${sanText}ï¼Œè®ºæ–‡å¼•ç”¨é€Ÿåº¦Ã—1.25`;
                    canProceed = changeSan(-baseSanCost);
                    break;
                }
                case 'github': {
                    const baseSanCost = 6;
                    const actualSanCost = Math.abs(getActualSanChange(-baseSanCost));
                    
                    if (gameState.san < actualSanCost) {
                        const tipText = actualSanCost !== baseSanCost 
                            ? `<p>SANå€¼ä¸è¶³ï¼åŸºç¡€æ¶ˆè€—${baseSanCost}ç‚¹ï¼Œæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}åéœ€è¦${actualSanCost}ç‚¹SANå€¼ã€‚</p>` 
                            : `<p>SANå€¼ä¸è¶³ï¼éœ€è¦è‡³å°‘${baseSanCost}ç‚¹SANå€¼ã€‚</p>`;
                        showModal('âŒ æ“ä½œå¤±è´¥', tipText, 
                            [{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
                        return;
                    }
                    paper.promotions.github = true;
                    paper.citationMultiplier *= 1.5;
                    const sanText = actualSanCost !== baseSanCost 
                        ? `SANå€¼-${actualSanCost}ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰` 
                        : `SANå€¼-${baseSanCost}`;
                    result = `${sanText}ï¼Œè®ºæ–‡å¼•ç”¨é€Ÿåº¦Ã—1.5`;
                    canProceed = changeSan(-baseSanCost);
                    break;
                }
                case 'xiaohongshu': {
                    const baseSanCost = 3;
                    const actualSanCost = Math.abs(getActualSanChange(-baseSanCost));
                    
                    if (gameState.san < actualSanCost) {
                        const tipText = actualSanCost !== baseSanCost 
                            ? `<p>SANå€¼ä¸è¶³ï¼åŸºç¡€æ¶ˆè€—${baseSanCost}ç‚¹ï¼Œæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}åéœ€è¦${actualSanCost}ç‚¹SANå€¼ã€‚</p>` 
                            : `<p>SANå€¼ä¸è¶³ï¼éœ€è¦è‡³å°‘${baseSanCost}ç‚¹SANå€¼ã€‚</p>`;
                        showModal('âŒ æ“ä½œå¤±è´¥', tipText, 
                            [{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
                        return;
                    }
                    paper.promotions.xiaohongshu = true;
                    paper.citationMultiplier *= 1.25;
                    const sanText = actualSanCost !== baseSanCost 
                        ? `SANå€¼-${actualSanCost}ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰` 
                        : `SANå€¼-${baseSanCost}`;
                    result = `${sanText}ï¼Œè®ºæ–‡å¼•ç”¨é€Ÿåº¦Ã—1.25`;
                    canProceed = changeSan(-baseSanCost);
                    break;
                }
                case 'quantumbit':
                    if (paper.grade !== 'A') {
                        showModal('âŒ æ“ä½œå¤±è´¥', '<p>åªæœ‰Aç±»è®ºæ–‡æ‰èƒ½ä¸Šé‡å­ä½å°é¢ï¼</p>', 
                            [{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
                        return;
                    }
                    if (gameState.gold < 10) {
                        showModal('âŒ æ“ä½œå¤±è´¥', '<p>é‡‘é’±ä¸è¶³ï¼éœ€è¦è‡³å°‘10é‡‘å¸ã€‚</p>', 
                            [{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
                        return;
                    }
                    paper.promotions.quantumbit = true;
                    paper.citations += 100;
                    gameState.totalCitations += 100;
                    result = 'é‡‘é’±-10ï¼Œè®ºæ–‡å¼•ç”¨+100';
                    canProceed = changeGold(-10);
                    break;
            }

            if (canProceed) {
                addLog('è®ºæ–‡æ¨å¹¿', `"${paper.title.substring(0, 15)}..." ${typeNames[type]}`, result);
                updateAllUI();
            }
        }

        // ==================== è®ºæ–‡å·¥ä½œç«™ ====================
        function renderPaperSlots() {
            const container = document.getElementById('paper-slots');
            let html = '';
            for (let i = 0; i < 4; i++) {
                const unlocked = i < gameState.paperSlots;
                const paper = gameState.papers[i];
                
                if (!unlocked) {
                    const req = [0, 6, 12, 18][i];
                    html += `<div class="paper-slot locked">
                        <div class="slot-header">
                            <span class="slot-title">è®ºæ–‡æ§½${i + 1}</span>
                            <span class="reviewing-badge"><i class="fas fa-lock"></i> ç§‘ç ”${req}è§£é”</span>
                        </div>
                    </div>`;
                } else if (!paper) {
                    html += `<div class="paper-slot">
                        <div class="slot-header">
                            <span class="slot-title">è®ºæ–‡æ§½${i + 1}</span>
                            <span style="color:var(--text-secondary);font-size:0.75rem;">ç©ºé—²</span>
                        </div>
                        <button class="new-paper-btn" onclick="createNewPaper(${i})">
                            <i class="fas fa-plus"></i> å¼€å¯æ–°è®ºæ–‡
                        </button>
                    </div>`;
                } else {
                    const total = paper.ideaScore + paper.expScore + paper.writeScore;
                    const canSubmit = paper.ideaScore > 0 && paper.expScore > 0 && paper.writeScore > 0 && !paper.reviewing;
                    const reviewingBadgeClass = paper.reviewing ? `reviewing-badge grade-${paper.submittedGrade}` : '';
                    html += `<div class="paper-slot active">
                        <div class="slot-header">
                            <span class="slot-title">è®ºæ–‡æ§½${i + 1}</span>
                            ${paper.reviewing ? `<span class="${reviewingBadgeClass}"><i class="fas fa-hourglass-half"></i> ${paper.submittedGrade}ç±» å‰©ä½™${Math.max(0, paper.reviewMonths)}æœˆ</span>` : ''}
                        </div>
                        <div class="paper-title">${paper.title}</div>
                        <div class="paper-scores">
                            <div class="score-box"><div class="label">Idea</div><div class="value">${paper.ideaScore}</div></div>
                            <div class="score-box"><div class="label">å®éªŒ</div><div class="value">${paper.expScore}</div></div>
                            <div class="score-box"><div class="label">å†™ä½œ</div><div class="value">${paper.writeScore}</div></div>
                        </div>
                        <div class="paper-total">æ€»åˆ†: ${total}</div>
                        <div class="paper-actions">
                            <button class="btn btn-danger" onclick="submitPaper(${i},'A')" ${!canSubmit?'disabled':''}><i class="fas fa-star"></i> æŠ•A</button>
                            <button class="btn btn-warning" onclick="submitPaper(${i},'B')" ${!canSubmit?'disabled':''}><i class="fas fa-certificate"></i> æŠ•B</button>
                            <button class="btn btn-success" onclick="submitPaper(${i},'C')" ${!canSubmit?'disabled':''}><i class="fas fa-check"></i> æŠ•C</button>
                            <button class="btn btn-info" onclick="abandonPaper(${i})" ${paper.reviewing?'disabled':''}><i class="fas fa-trash"></i> æ”¾å¼ƒ</button>
                        </div>
                    </div>`;
                }
            }
            container.innerHTML = html;
        }

        function generatePaperTitle() {
            const w = paperTitleWords;
            const templates = [
                () => `${rand(w.adjectives)} ${rand(w.nouns)} for ${rand(w.domains)} ${rand(w.verbs)}`,
                () => `${rand(w.verbs)} ${rand(w.domains)} with ${rand(w.adjectives)} ${rand(w.nouns)}`,
                () => `${rand(w.adjectives)} ${rand(w.adjectives)} ${rand(w.nouns)}`,
                () => `Towards ${rand(w.adjectives)} ${rand(w.domains)} ${rand(w.nouns)}`,
                () => `${rand(w.domains)} ${rand(w.verbs)} via ${rand(w.adjectives)} ${rand(w.nouns)}`
            ];
            return rand(templates)();
        }

        function createNewPaper(slot) {
            const title = generatePaperTitle();
            gameState.papers[slot] = {
                title: title,
                ideaScore: 0,
                expScore: 0,
                writeScore: 0,
                reviewing: false,
                reviewMonths: 0,
                submittedGrade: null,
                submittedScore: 0
            };
            addLog('æ–°è®ºæ–‡', `åœ¨è®ºæ–‡æ§½${slot + 1}å¼€å¯ï¼š${title}`);
            renderPaperSlots();
        }

        function checkResearchUnlock(silent = false) {
            // æ„šé’ä¹‹é™¢å£«è½¬ä¸–ï¼šå·²å…¨éƒ¨è§£é”
            if (gameState.isReversed && gameState.character === 'genius') {
                gameState.paperSlots = 4;
                return;
            }
            
            const thresholds = [0, 6, 12, 18];
            let newUnlock = false;
            for (let i = 1; i < 4; i++) {
                if (gameState.research >= thresholds[i] && gameState.paperSlots <= i) {
                    gameState.paperSlots = i + 1;
                    newUnlock = true;
                }
            }
            if (newUnlock && !silent) {
                showModal('ğŸ‰ æ–°è®ºæ–‡æ§½è§£é”ï¼', 
                    `<p>æ­å–œï¼ç§‘ç ”èƒ½åŠ›è¾¾åˆ°${gameState.research}ï¼Œè§£é”è®ºæ–‡æ§½${gameState.paperSlots}ï¼</p>`,
                    [{ text: 'å¤ªæ£’äº†ï¼', class: 'btn-primary', action: closeModal }]);
                renderPaperSlots();
            }
        }
		
        // ==================== æ“ä½œåŠŸèƒ½ ====================
        function readPaper() {
            if (gameState.actionUsed) return;
            
            const has4K = gameState.buffs.permanent.some(b => b.type === 'read_san_reduce');
            const baseSanCost = has4K ? 1 : 2;
            const actualSanCost = Math.abs(getActualSanChange(-baseSanCost));
            
            if (gameState.san < actualSanCost) {
                const tipText = actualSanCost !== baseSanCost 
                    ? `<p>SANå€¼ä¸è¶³ï¼åŸºç¡€æ¶ˆè€—${baseSanCost}ç‚¹ï¼Œæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}åéœ€è¦${actualSanCost}ç‚¹SANå€¼ã€‚</p>` 
                    : `<p>SANå€¼ä¸è¶³ï¼éœ€è¦è‡³å°‘${baseSanCost}ç‚¹SANå€¼ã€‚</p>`;
                showModal('âŒ æ“ä½œå¤±è´¥', tipText, 
                    [{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
                return;
            }
            
            gameState.actionUsed = true;
            
            gameState.buffs.temporary.push({ type: 'idea_bonus', name: 'ä¸‹æ¬¡æƒ³ideaåˆ†æ•°+1', value: 1, permanent: false });
            gameState.readCount++;

            let result = `SANå€¼-${actualSanCost}`;
            if (has4K) result += 'ï¼ˆ4Kæ˜¾ç¤ºå™¨ç”Ÿæ•ˆï¼‰';
            if (actualSanCost !== baseSanCost) {
                result += `ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰`;
            }
            result += 'ï¼Œè·å¾—ä¸´æ—¶buffï¼šä¸‹æ¬¡æƒ³ideaåˆ†æ•°+1';

            if (gameState.readCount % 5 === 0) {
                changeResearch(1);
                result += `ï¼Œé˜…è¯»è®ºæ–‡è¾¾åˆ°${gameState.readCount}æ¬¡ï¼Œç§‘ç ”èƒ½åŠ›+1`;
            }

            addLog('çœ‹è®ºæ–‡', 'è®¤çœŸé˜…è¯»äº†å­¦æœ¯è®ºæ–‡', result);
            updateBuffs();
            changeSan(-baseSanCost);
        }

        function partTimeJob() {
            if (gameState.actionUsed) return;
            
            const baseSanCost = 5;
            const actualSanCost = Math.abs(getActualSanChange(-baseSanCost));
            
            if (gameState.san < actualSanCost) {
                const tipText = actualSanCost !== baseSanCost 
                    ? `<p>SANå€¼ä¸è¶³ï¼åŸºç¡€æ¶ˆè€—${baseSanCost}ç‚¹ï¼Œæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}åéœ€è¦${actualSanCost}ç‚¹SANå€¼ã€‚</p>` 
                    : `<p>SANå€¼ä¸è¶³ï¼éœ€è¦è‡³å°‘${baseSanCost}ç‚¹SANå€¼ã€‚</p>`;
                showModal('âŒ æ“ä½œå¤±è´¥', tipText, 
                    [{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
                return;
            }
            
            gameState.actionUsed = true;
            
            let result = `SANå€¼-${actualSanCost}`;
            if (actualSanCost !== baseSanCost) {
                result += `ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰`;
            }
            result += 'ï¼Œé‡‘é’±+2';
            
            addLog('æ‰“å·¥', 'è¾›è‹¦å·¥ä½œèµšå–ç”Ÿæ´»è´¹', result);
            changeStats({ san: -baseSanCost, gold: 2 });
        }

        function thinkIdea() {
            if (gameState.actionUsed) return;
            
            const baseSanCost = 2;
            const actualSanCost = Math.abs(getActualSanChange(-baseSanCost));
            
            if (gameState.san < actualSanCost) {
                const tipText = actualSanCost !== baseSanCost 
                    ? `<p>SANå€¼ä¸è¶³ï¼åŸºç¡€æ¶ˆè€—${baseSanCost}ç‚¹ï¼Œæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}åéœ€è¦${actualSanCost}ç‚¹SANå€¼ã€‚</p>` 
                    : `<p>SANå€¼ä¸è¶³ï¼éœ€è¦è‡³å°‘${baseSanCost}ç‚¹SANå€¼ã€‚</p>`;
                showModal('âŒ æ“ä½œå¤±è´¥', tipText, 
                    [{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
                return;
            }
            
            const available = gameState.papers.map((p, i) => ({ paper: p, index: i }))
                .filter(({ paper }) => paper && !paper.reviewing);
            if (available.length === 0) {
                showModal('æ— æ³•æ“ä½œ', '<p>æ²¡æœ‰å¯ç”¨çš„è®ºæ–‡ï¼è¯·å…ˆå¼€å¯ä¸€ç¯‡æ–°è®ºæ–‡ã€‚</p>', 
                    [{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
                return;
            }
            showPaperSelectModal('æƒ³idea', available, (index) => {
                gameState.actionUsed = true;
                const paper = gameState.papers[index];
                
                let times = 1 + countBuff('idea_times');
                let bestScore = paper.ideaScore;
                let lastGen = 0;
                for (let i = 0; i < times; i++) {
                    const gen = calculateScore('idea');
                    lastGen = gen;
                    if (gen > bestScore) bestScore = gen;
                }
                
                let result = `SANå€¼-${actualSanCost}`;
                if (actualSanCost !== baseSanCost) {
                    result += `ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰`;
                }
                if (times > 1) result += `ï¼ˆæƒ³${times}æ¬¡ï¼‰`;
                if (bestScore > paper.ideaScore) {
                    paper.ideaScore = bestScore;
                    result += `ï¼Œideaåˆ†æ›´æ–°ä¸º${bestScore}`;
                } else {
                    result += `ï¼Œideaåˆ†æœªæ›´æ–°ï¼ˆç”Ÿæˆ${lastGen}ï¼Œå½“å‰${paper.ideaScore}ï¼‰`;
                }
                
                consumeTempBuff('idea_times');
                consumeTempBuff('idea_bonus');
                addLog('æƒ³idea', `ä¸º"${paper.title.substring(0, 15)}..."æ€è€ƒidea`, result);
                renderPaperSlots();
                changeSan(-baseSanCost);
            });
        }

        function doExperiment() {
            if (gameState.actionUsed) return;
            
            const baseSanCost = 3;
            const actualSanCost = Math.abs(getActualSanChange(-baseSanCost));
            
            if (gameState.san < actualSanCost) {
                const tipText = actualSanCost !== baseSanCost 
                    ? `<p>SANå€¼ä¸è¶³ï¼åŸºç¡€æ¶ˆè€—${baseSanCost}ç‚¹ï¼Œæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}åéœ€è¦${actualSanCost}ç‚¹SANå€¼ã€‚</p>` 
                    : `<p>SANå€¼ä¸è¶³ï¼éœ€è¦è‡³å°‘${baseSanCost}ç‚¹SANå€¼ã€‚</p>`;
                showModal('âŒ æ“ä½œå¤±è´¥', tipText, 
                    [{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
                return;
            }
            
            const available = gameState.papers.map((p, i) => ({ paper: p, index: i }))
                .filter(({ paper }) => paper && !paper.reviewing && paper.ideaScore > 0);
            if (available.length === 0) {
                showModal('æ— æ³•æ“ä½œ', '<p>æ²¡æœ‰å¯ç”¨çš„è®ºæ–‡ï¼éœ€è¦å…ˆæœ‰ideaåˆ†å¤§äº0çš„è®ºæ–‡ã€‚</p>', 
                    [{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
                return;
            }
            showPaperSelectModal('åšå®éªŒ', available, (index) => {
                gameState.actionUsed = true;
                const paper = gameState.papers[index];
                
                let times = 1 + countBuff('exp_times');
                let bestScore = paper.expScore;
                let lastGen = 0;
                for (let i = 0; i < times; i++) {
                    const gen = calculateScore('exp');
                    lastGen = gen;
                    if (gen > bestScore) bestScore = gen;
                }
                
                let result = `SANå€¼-${actualSanCost}`;
                if (actualSanCost !== baseSanCost) {
                    result += `ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰`;
                }
                if (times > 1) result += `ï¼ˆå®éªŒ${times}æ¬¡ï¼‰`;
                if (bestScore > paper.expScore) {
                    paper.expScore = bestScore;
                    result += `ï¼Œå®éªŒåˆ†æ›´æ–°ä¸º${bestScore}`;
                } else {
                    result += `ï¼Œå®éªŒåˆ†æœªæ›´æ–°ï¼ˆç”Ÿæˆ${lastGen}ï¼Œå½“å‰${paper.expScore}ï¼‰`;
                }
                
                consumeTempBuff('exp_times');
                consumeTempBuff('exp_bonus');
                addLog('åšå®éªŒ', `ä¸º"${paper.title.substring(0, 15)}..."åšå®éªŒ`, result);
                renderPaperSlots();
                changeSan(-baseSanCost);
            });
        }

        function writePaper() {
            if (gameState.actionUsed) return;
            
            const hasKeyboard = gameState.buffs.permanent.some(b => b.type === 'write_san_reduce');
            const baseSanCost = hasKeyboard ? 3 : 4;
            const actualSanCost = Math.abs(getActualSanChange(-baseSanCost));
            
            if (gameState.san < actualSanCost) {
                const tipText = actualSanCost !== baseSanCost 
                    ? `<p>SANå€¼ä¸è¶³ï¼åŸºç¡€æ¶ˆè€—${baseSanCost}ç‚¹ï¼Œæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}åéœ€è¦${actualSanCost}ç‚¹SANå€¼ã€‚</p>` 
                    : `<p>SANå€¼ä¸è¶³ï¼éœ€è¦è‡³å°‘${baseSanCost}ç‚¹SANå€¼ã€‚</p>`;
                showModal('âŒ æ“ä½œå¤±è´¥', tipText, 
                    [{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
                return;
            }
            
            const available = gameState.papers.map((p, i) => ({ paper: p, index: i }))
                .filter(({ paper }) => paper && !paper.reviewing && paper.expScore > 0);
            if (available.length === 0) {
                showModal('æ— æ³•æ“ä½œ', '<p>æ²¡æœ‰å¯ç”¨çš„è®ºæ–‡ï¼éœ€è¦å…ˆæœ‰å®éªŒåˆ†å¤§äº0çš„è®ºæ–‡ã€‚</p>', 
                    [{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
                return;
            }
            showPaperSelectModal('å†™è®ºæ–‡', available, (index) => {
                gameState.actionUsed = true;
                const paper = gameState.papers[index];
                
                let times = 1 + countBuff('write_times');
                let bestScore = paper.writeScore;
                let lastGen = 0;
                for (let i = 0; i < times; i++) {
                    const gen = calculateScore('write');
                    lastGen = gen;
                    if (gen > bestScore) bestScore = gen;
                }
                
                let result = `SANå€¼-${actualSanCost}`;
                if (hasKeyboard) result += 'ï¼ˆæœºæ¢°é”®ç›˜ç”Ÿæ•ˆï¼‰';
                if (actualSanCost !== baseSanCost) {
                    result += `ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰`;
                }
                if (times > 1) result += `ï¼ˆå†™${times}æ¬¡ï¼‰`;
                if (bestScore > paper.writeScore) {
                    paper.writeScore = bestScore;
                    result += `ï¼Œå†™ä½œåˆ†æ›´æ–°ä¸º${bestScore}`;
                } else {
                    result += `ï¼Œå†™ä½œåˆ†æœªæ›´æ–°ï¼ˆç”Ÿæˆ${lastGen}ï¼Œå½“å‰${paper.writeScore}ï¼‰`;
                }
                
                consumeTempBuff('write_times');
                consumeTempBuff('write_bonus');
                addLog('å†™è®ºæ–‡', `ä¸º"${paper.title.substring(0, 15)}..."å†™ä½œ`, result);
                renderPaperSlots();
                changeSan(-baseSanCost);
            });
        }

        function calculateScore(type) {
            const base = gameState.research * (0.5 + Math.random());
            const randomBonus = Math.floor(Math.random() * 6);
            let score = Math.round(base + randomBonus);

            let bonus = 0, multiplier = 1;
            const buffType = type + '_bonus';
            [...gameState.buffs.permanent, ...gameState.buffs.temporary].forEach(b => {
                if (b.type === buffType) {
                    if (b.multiply) {
                        multiplier += (b.value - 1);
                    } else {
                        bonus += b.value;
                    }
                }
            });
            multiplier = Math.max(0, multiplier);
            return Math.max(0, Math.round(score * multiplier + bonus));
        }

        function countBuff(type) {
            let count = 0;
            [...gameState.buffs.permanent, ...gameState.buffs.temporary].forEach(b => {
                if (b.type === type) count += b.value;
            });
            return count;
        }

        function consumeTempBuff(type) {
            gameState.buffs.temporary = gameState.buffs.temporary.filter(b => b.type !== type);
        }
		
        // ==================== è®ºæ–‡æŠ•ç¨¿ä¸å®¡ç¨¿ ====================
        function submitPaper(slot, grade) {
            const paper = gameState.papers[slot];
            
            if (!paper || paper.reviewing) return;
            if (paper.ideaScore <= 0 || paper.expScore <= 0 || paper.writeScore <= 0) return;

            paper.reviewing = true;
            paper.reviewMonths = 4;
            paper.submittedGrade = grade;
            paper.submittedScore = paper.ideaScore + paper.expScore + paper.writeScore;

            const currentReviews = gameState.papers.filter(p => p?.reviewing).length;
            gameState.maxConcurrentReviews = Math.max(gameState.maxConcurrentReviews || 0, currentReviews);

            addLog('æŠ•ç¨¿', `å°†"${paper.title.substring(0, 15)}..."æŠ•è‡³${grade}ç±»ä¼šè®®`, `æ€»åˆ†${paper.submittedScore}ï¼Œè¿›å…¥4ä¸ªæœˆå®¡ç¨¿æœŸ`);
            renderPaperSlots();
        }

        function abandonPaper(slot) {
            const paper = gameState.papers[slot];
            if (!paper || paper.reviewing) return;
            
            showModal('ç¡®è®¤æ”¾å¼ƒ', '<p>ç¡®å®šè¦æ”¾å¼ƒè¿™ç¯‡è®ºæ–‡å—ï¼Ÿæ‰€æœ‰è¿›åº¦å°†ä¸¢å¤±ï¼</p>', [
                { text: 'å–æ¶ˆ', class: 'btn-info', action: closeModal },
                { text: 'ç¡®å®šæ”¾å¼ƒ', class: 'btn-danger', action: () => {
                    addLog('æ”¾å¼ƒè®ºæ–‡', `æ”¾å¼ƒäº†"${paper.title.substring(0, 15)}..."`, 'è®ºæ–‡æ§½å·²æ¸…ç©º');
                    gameState.papers[slot] = null;
                    closeModal();
                    renderPaperSlots();
                }}
            ]);
        }

        function processPaperResult(slot) {
            const paper = gameState.papers[slot];
            if (!paper || !paper.reviewing) return;
            
            const grade = paper.submittedGrade;
            const submittedScore = paper.submittedScore;

            const beforeScores = {
                idea: paper.ideaScore,
                exp: paper.expScore,
                write: paper.writeScore,
                total: paper.ideaScore + paper.expScore + paper.writeScore
            };

            const reviewers = [generateReviewer(), generateReviewer(), generateReviewer()];

            let totalReviewScore = 0;
            const results = reviewers.map(reviewer => {
                const result = getReviewResult(reviewer, grade, submittedScore);
                totalReviewScore += result.score;
                return { reviewer, ...result };
            });

            let acceptType = null, accepted = false;
            if (totalReviewScore >= 3) { acceptType = 'Best Paper'; accepted = true; }
            else if (totalReviewScore >= 2) { acceptType = 'Oral'; accepted = true; }
            else if (totalReviewScore >= 0) { acceptType = 'Poster'; accepted = true; }

            results.forEach(r => {
                if (r.improvement > 0) {
                    if (r.improvementType === 'idea') paper.ideaScore += r.improvement;
                    else if (r.improvementType === 'exp') paper.expScore += r.improvement;
                    else paper.writeScore += r.improvement;
                }
            });

            const afterScores = {
                idea: paper.ideaScore,
                exp: paper.expScore,
                write: paper.writeScore,
                total: paper.ideaScore + paper.expScore + paper.writeScore
            };

            showReviewResultModal(paper, grade, results, totalReviewScore, acceptType, accepted, slot, beforeScores, afterScores);
        }

		function generateReviewer() {
			// â˜…â˜…â˜… ç¤¾äº¤è¾¾äººè§‰é†’åä½¿ç”¨å›ºå®šçš„æ¦‚ç‡åˆ†å¸ƒ â˜…â˜…â˜…
			if (gameState.socialAwakened && gameState.reviewerDistribution) {
				const dist = gameState.reviewerDistribution;
				
				const r = Math.random();
				let cumulative = 0;
				
				cumulative += dist.normal;
				if (r < cumulative) return { type: 'normal', name: 'æ™®é€šå®¡ç¨¿äºº' };
				
				cumulative += dist.kind;
				if (r < cumulative) return { type: 'kind', name: 'å¿ƒè½¯å®¡ç¨¿äºº' };
				
				cumulative += dist.expert;
				if (r < cumulative) return { type: 'expert', name: 'èµ„æ·±å¤§ç‰›' };
				
				cumulative += dist.hostile;
				if (r < cumulative) return { type: 'hostile', name: 'æ¶æ„å°åŒè¡Œ' };
				
				cumulative += dist.gpt;
				if (r < cumulative) return { type: 'gpt', name: 'GPTå®¡ç¨¿äºº' };
				
				return { type: 'questions', name: '40ä¸ªé—®é¢˜å®¡ç¨¿äºº' };
			}
			
			// é»˜è®¤åˆ†å¸ƒ
			const r = Math.random();
			if (r < 0.40) return { type: 'normal', name: 'æ™®é€šå®¡ç¨¿äºº' };
			if (r < 0.50) return { type: 'kind', name: 'å¿ƒè½¯å®¡ç¨¿äºº' };
			if (r < 0.60) return { type: 'expert', name: 'èµ„æ·±å¤§ç‰›' };
			if (r < 0.70) return { type: 'hostile', name: 'æ¶æ„å°åŒè¡Œ' };
			if (r < 0.90) return { type: 'gpt', name: 'GPTå®¡ç¨¿äºº' };
			return { type: 'questions', name: '40ä¸ªé—®é¢˜å®¡ç¨¿äºº' };
		}

        function getReviewResult(reviewer, grade, score) {
            let thresholds;
            if (grade === 'A') {
                switch (reviewer.type) {
                    case 'kind': thresholds = { reject: 40, borderline: 60 }; break;
                    case 'normal': case 'expert': thresholds = { reject: 50, borderline: 70 }; break;
                    case 'gpt': thresholds = { reject: 40, borderline: 80 }; break;
                    case 'hostile': case 'questions': thresholds = { reject: 80, borderline: 90 }; break;
                }
            } else if (grade === 'B') {
                switch (reviewer.type) {
                    case 'kind': thresholds = { reject: 20, borderline: 40 }; break;
                    case 'normal': case 'expert': thresholds = { reject: 30, borderline: 50 }; break;
                    case 'gpt': thresholds = { reject: 20, borderline: 60 }; break;
                    case 'hostile': case 'questions': thresholds = { reject: 40, borderline: 60 }; break;
                }
            } else {
                switch (reviewer.type) {
                    case 'kind': thresholds = { reject: 10, borderline: 20 }; break;
                    case 'normal': case 'expert': thresholds = { reject: 15, borderline: 30 }; break;
                    case 'gpt': thresholds = { reject: 15, borderline: 40 }; break;
                    case 'hostile': case 'questions': thresholds = { reject: 25, borderline: 40 }; break;
                }
            }

            let decision, reviewScore;
            if (score < thresholds.reject) { decision = 'Reject'; reviewScore = -1; }
            else if (score < thresholds.borderline) { decision = 'Borderline'; reviewScore = 0; }
            else { decision = 'Accept'; reviewScore = 1; }

            const comment = generateComment(decision, reviewer.type);
            
            let improvement = 0, improvementType = '';
            if ((reviewer.type === 'normal' || reviewer.type === 'expert') && decision !== 'Reject') {
                improvement = reviewer.type === 'expert' ? 6 : 3;
                improvementType = ['idea', 'exp', 'write'][Math.floor(Math.random() * 3)];
            }

            return { decision, score: reviewScore, comment, improvement, improvementType };
        }

        function generateComment(decision, type) {
            if (type === 'questions') return 'æˆ‘æœ‰40ä¸ªé—®é¢˜ã€‚';
            const positive = ['åˆ›æ–°æ€§å¼ºï¼Œå®éªŒå……åˆ†', 'å†™ä½œæ¸…æ™°ï¼Œè´¡çŒ®æ˜ç¡®', 'æ–¹æ³•æ–°é¢–ï¼Œç»“æœæœ‰è¯´æœåŠ›', 'å·¥ä½œæ‰å®ï¼Œæœ‰é‡è¦è´¡çŒ®'];
            const negative = ['ç¼ºä¹åˆ›æ–°', 'å†™ä½œä¸è¶³ï¼Œè¡¨è¾¾ä¸æ¸…', 'å®éªŒä¸è¶³ï¼Œç¼ºå°‘å¯¹æ¯”', 'è´¡çŒ®æœ‰é™ï¼Œå¢é‡å·¥ä½œ'];
            const neutral = ['æœ‰ä¸€å®šåˆ›æ–°ä½†å®éªŒå¯åŠ å¼º', 'æƒ³æ³•æœ‰è¶£ä½†å†™ä½œéœ€æ”¹è¿›', 'å·¥ä½œè¿˜å¯ä»¥ä½†ç¼ºå°‘æ·±å…¥åˆ†æ'];
            if (decision === 'Accept') return rand(positive);
            if (decision === 'Reject') return rand(negative);
            return rand([...positive, ...negative, ...neutral]);
        }

        function showReviewResultModal(paper, grade, results, totalScore, acceptType, accepted, slot, beforeScores, afterScores) {
            const improved = afterScores.total > beforeScores.total;
            
            if (afterScores.total >= 125) {
                gameState.achievementConditions = gameState.achievementConditions || {};
                gameState.achievementConditions.highScorePaper = true;
            }
            
            const allImproved = results.every(r => r.improvement > 0);
            if (allImproved) {
                gameState.achievementConditions = gameState.achievementConditions || {};
                gameState.achievementConditions.unanimousImprovement = true;
            }
            
            const isBadReviewer = r => r.reviewer.type === 'hostile' || r.reviewer.type === 'questions';
            if (results.every(isBadReviewer)) {
                gameState.achievementConditions = gameState.achievementConditions || {};
                gameState.achievementConditions.allBadReviewers = true;
            }
            
            if (accepted) {
                gameState.paperTypeCollection = gameState.paperTypeCollection || new Set();
                gameState.paperTypeCollection.add(`${grade}-${acceptType}`);
            }
            
            const improvements = results.filter(r => r.improvement > 0).map(r => ({
                reviewer: r.reviewer.name,
                type: r.improvementType,
                typeName: r.improvementType === 'idea' ? 'Idea' : r.improvementType === 'exp' ? 'å®éªŒ' : 'å†™ä½œ',
                value: r.improvement
            }));
            
            let html = `<div style="margin-bottom:12px;font-size:0.9rem;">
                <strong>è®ºæ–‡ï¼š</strong>${paper.title.substring(0, 30)}${paper.title.length > 30 ? '...' : ''}<br>
                <strong>æŠ•ç¨¿ï¼š</strong>${grade}ç±»ä¼šè®® | <strong>æŠ•ç¨¿æ—¶æ€»åˆ†ï¼š</strong>${paper.submittedScore}
            </div><div style="margin-bottom:12px;">`;
            
            results.forEach(r => {
                const color = r.decision === 'Accept' ? 'var(--success-color)' : r.decision === 'Reject' ? 'var(--danger-color)' : 'var(--warning-color)';
                html += `<div style="padding:8px;background:var(--light-bg);border-radius:6px;margin-bottom:6px;font-size:0.85rem;">
                    <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                        <strong>${r.reviewer.name}</strong>
                        <span style="color:${color};font-weight:600;">${r.decision}(${r.score > 0 ? '+' : ''}${r.score})</span>
                    </div>
                    <div style="font-size:0.8rem;color:var(--text-secondary);">"${r.comment}"</div>
                    ${r.improvement > 0 ? `<div style="color:var(--success-color);font-size:0.75rem;margin-top:3px;background:rgba(0,184,148,0.1);padding:3px 6px;border-radius:4px;display:inline-block;">
                        ğŸ“ æ”¹è¿›è®ºæ–‡ â†’ ${r.improvementType === 'idea' ? 'Idea' : r.improvementType === 'exp' ? 'å®éªŒ' : 'å†™ä½œ'}åˆ† <strong>+${r.improvement}</strong></div>` : ''}
                </div>`;
            });
            html += '</div>';

            if (improved) {
                html += `<div style="padding:10px;background:rgba(0,184,148,0.1);border-radius:8px;margin-bottom:12px;font-size:0.85rem;">
                    <div style="font-weight:600;color:var(--success-color);margin-bottom:8px;">ğŸ“ˆ å®¡ç¨¿æ„è§æ”¹è¿›äº†è®ºæ–‡è´¨é‡</div>`;
                
                if (improvements.length > 0) {
                    html += `<div style="margin-bottom:8px;font-size:0.8rem;">`;
                    improvements.forEach(imp => {
                        html += `<div style="margin-bottom:3px;">â€¢ <strong>${imp.reviewer}</strong>ï¼š${imp.typeName}åˆ† +${imp.value}</div>`;
                    });
                    html += `</div>`;
                }
                
                html += `<div style="display:flex;justify-content:space-around;text-align:center;padding:8px;background:white;border-radius:6px;">
                        <div>
                            <div style="color:var(--text-secondary);font-size:0.7rem;">Ideaåˆ†</div>
                            <div style="font-size:0.9rem;">${beforeScores.idea}${beforeScores.idea !== afterScores.idea ? ` â†’ <strong style="color:var(--success-color);">${afterScores.idea}</strong>` : ''}</div>
                        </div>
                        <div>
                            <div style="color:var(--text-secondary);font-size:0.7rem;">å®éªŒåˆ†</div>
                            <div style="font-size:0.9rem;">${beforeScores.exp}${beforeScores.exp !== afterScores.exp ? ` â†’ <strong style="color:var(--success-color);">${afterScores.exp}</strong>` : ''}</div>
                        </div>
                        <div>
                            <div style="color:var(--text-secondary);font-size:0.7rem;">å†™ä½œåˆ†</div>
                            <div style="font-size:0.9rem;">${beforeScores.write}${beforeScores.write !== afterScores.write ? ` â†’ <strong style="color:var(--success-color);">${afterScores.write}</strong>` : ''}</div>
                        </div>
                    </div>
                    <div style="text-align:center;margin-top:8px;font-weight:600;">
                        æ€»åˆ†ï¼š${beforeScores.total} â†’ <span style="color:var(--success-color);">${afterScores.total}</span> 
                        <span style="color:var(--success-color);">(+${afterScores.total - beforeScores.total})</span>
                    </div>
                </div>`;
            }

            if (accepted) {
                const colors = { 'Poster': '#74b9ff', 'Oral': '#fdcb6e', 'Best Paper': '#fd79a8' };
                html += `<div style="text-align:center;padding:12px;background:linear-gradient(135deg,${colors[acceptType]}33,${colors[acceptType]}66);border-radius:10px;">
                    <div style="font-size:1.8rem;margin-bottom:8px;">ğŸ‰</div>
                    <div style="font-size:1.1rem;font-weight:700;color:${colors[acceptType]};">æ­å–œï¼è®ºæ–‡è¢«${grade}ç±»ä¼šè®®æ¥æ”¶ä¸º ${acceptType}ï¼</div>
                    <div style="margin-top:6px;font-size:0.85rem;">æ€»å®¡ç¨¿åˆ†: ${totalScore}</div>
                </div>`;
            } else {
                html += `<div style="text-align:center;padding:12px;background:rgba(225,112,85,0.15);border-radius:10px;">
                    <div style="font-size:1.8rem;margin-bottom:8px;">ğŸ˜¢</div>
                    <div style="font-size:1.1rem;font-weight:700;color:var(--danger-color);">å¾ˆé—æ†¾ï¼Œè®ºæ–‡è¢«${grade}ç±»ä¼šè®®æ‹’ç¨¿äº†</div>
                    <div style="margin-top:6px;font-size:0.85rem;">æ€»å®¡ç¨¿åˆ†: ${totalScore}ï¼ˆéœ€è¦â‰¥0æ‰èƒ½æ¥æ”¶ï¼‰</div>
                    <div style="margin-top:6px;font-size:0.8rem;color:var(--text-secondary);">
                        ${improved ? 'è®ºæ–‡å·²æ ¹æ®å®¡ç¨¿æ„è§æ”¹è¿›ï¼Œ' : ''}å¯ç»§ç»­ä¿®æ”¹åé‡æŠ•
                    </div>
                </div>`;
            }

            showModal('ğŸ“ å®¡ç¨¿ç»“æœ', html, [
                { text: 'ç¡®å®š', class: 'btn-primary', action: () => {
                    if (accepted) {
                        handlePaperAccepted(paper, grade, acceptType, slot);
                    } else {
                        gameState.rejectedCount++;
                        gameState.rejectedPapers[paper.title] = (gameState.rejectedPapers[paper.title] || 0) + 1;
                        
                        if (gameState.rejectedPapers[paper.title] >= 3) {
                            gameState.achievementConditions.tripleRejected = true;
                        }
                        paper.reviewing = false;
                        paper.submittedGrade = null;
                        paper.submittedScore = null;
                        paper.reviewMonths = 0;
                        let logMsg = 'å¯ç»§ç»­ä¿®æ”¹åé‡æŠ•';
                        if (improved) {
                            const impDetail = improvements.map(i => `${i.typeName}+${i.value}`).join('ï¼Œ');
                            logMsg = `å®¡ç¨¿æ”¹è¿›(${impDetail})ï¼Œæ€»åˆ†${beforeScores.total}â†’${afterScores.total}ï¼Œå¯é‡æŠ•`;
                        }
                        addLog('æ‹’ç¨¿', `"${paper.title.substring(0, 15)}..."è¢«${grade}ç±»ä¼šè®®æ‹’ç¨¿`, logMsg);
                    }
                    closeModal();
                    renderPaperSlots();
                    updateAllUI();
                }}
            ]);
        }

        function handlePaperAccepted(paper, grade, acceptType, slot) {
            const scoreMap = { 'A': 4, 'B': 2, 'C': 1 };
            const sanGain = { 'A': { 'Poster': 6, 'Oral': 8, 'Best Paper': 12 }, 'B': { 'Poster': 3, 'Oral': 4, 'Best Paper': 5 }, 'C': { 'Poster': 2, 'Oral': 2, 'Best Paper': 3 } };
            const favorGain = { 'A': { 'Poster': 2, 'Oral': 3, 'Best Paper': 4 }, 'B': { 'Poster': 1, 'Oral': 1, 'Best Paper': 2 }, 'C': { 'Poster': 0, 'Oral': 0, 'Best Paper': 1 } };

            // é€†ä½å¯Œå¯æ•Œå›½ï¼šSANå¢åŠ æ— æ•ˆï¼ˆä½†å¥½æ„Ÿåº¦ä»ç„¶ä¼šè¢«é‡ç½®ï¼‰
            gameState.san = Math.min(gameState.sanMax, gameState.san + sanGain[grade][acceptType]);
			gameState.favor = Math.min(20, gameState.favor + favorGain[grade][acceptType]);
            gameState.totalScore += scoreMap[grade];

            if (grade === 'A') gameState.paperA++;
            else if (grade === 'B') gameState.paperB++;
            else gameState.paperC++;

            let bonusResearch = 0;
            if (!gameState.firstPaperAccepted) {
                gameState.firstPaperAccepted = true;
                bonusResearch++;
                addLog('é¦–æ¬¡å‘è¡¨è®ºæ–‡', 'ç§‘ç ”èƒ½åŠ›+1', 'é¦–æ¬¡å‘è¡¨è®ºæ–‡å¥–åŠ±');
            }
            if (grade === 'A' && !gameState.firstAPaperAccepted) {
                gameState.firstAPaperAccepted = true;
                bonusResearch++;
                addLog('é¦–æ¬¡å‘è¡¨Aç±»è®ºæ–‡', 'ç§‘ç ”èƒ½åŠ›+1', 'é¦–æ¬¡å‘è¡¨Aç±»è®ºæ–‡å¥–åŠ±');
            }
            if (acceptType === 'Best Paper' && !gameState.firstBestPaperAccepted) {
                gameState.firstBestPaperAccepted = true;
                bonusResearch++;
                addLog('é¦–æ¬¡å‘è¡¨Best Paper', 'ç§‘ç ”èƒ½åŠ›+1', 'é¦–æ¬¡å‘è¡¨Best Paperå¥–åŠ±');
            }
            if (bonusResearch > 0) {
                changeResearch(bonusResearch);
            }

            const finalScore = paper.ideaScore + paper.expScore + paper.writeScore;
            gameState.publishedPapers.push({
                title: paper.title,
                grade,
                acceptType,
                score: finalScore,
                citations: 0,
                monthsSincePublish: 0,
                promotions: { arxiv: false, github: false, xiaohongshu: false, quantumbit: false },
                citationMultiplier: 1
            });

            if (gameState.publishedPapers.length === 1 && !gameState.availableRandomEvents.includes(14)) {
                gameState.availableRandomEvents.push(14);
                addLog('ç³»ç»Ÿ', 'æ–°äº‹ä»¶è§£é”', 'æŒ‡å¯¼å¸ˆå¼Ÿå¸ˆå¦¹äº‹ä»¶å·²è§£é”');
            }

            gameState.papers[slot] = null;

            let result = `SAN+${sanGain[grade][acceptType]}ï¼Œå¥½æ„Ÿ+${favorGain[grade][acceptType]}ï¼Œç§‘ç ”åˆ†+${scoreMap[grade]}`;
            if (bonusResearch > 0) result += `ï¼Œç§‘ç ”èƒ½åŠ›+${bonusResearch}`;
            addLog('è®ºæ–‡ä¸­ç¨¿', `${grade}ç±»ä¼šè®®è¢«æ¥æ”¶ä¸º${acceptType}`, result);

            const canPhD = gameState.degree === 'master' && (
                (gameState.year === 2 && gameState.month === 12 && gameState.totalScore >= 2) ||
                (gameState.year === 3 && gameState.month === 12 && gameState.totalScore >= 3)
            );

            if (canPhD) {
                gameState.pendingConference = grade;
                setTimeout(() => showPhDOptionModal(), 300);
            } else {
                setTimeout(() => showConferenceModal(grade), 300);
            }
        }
		
        // ==================== å¼€ä¼šç³»ç»Ÿ ====================
        function showConferenceModal(grade) {
            const favorCost = gameState.favor >= 6 ? 1 : 2;
            const proxyCost = gameState.social >= 6 ? 0 : 1;

            const favorText = gameState.favor >= 6 
                ? 'ğŸ‘¨â€ğŸ« å¯¼å¸ˆæŠ¥é”€ï¼ˆå¥½æ„Ÿåº¦-1ï¼‰' 
                : 'ğŸ‘¨â€ğŸ« å¯¼å¸ˆæŠ¥é”€ï¼ˆå¥½æ„Ÿåº¦-2ï¼‰';
            const proxyText = gameState.social >= 6 
                ? 'ğŸ‘¥ è¯·åŒå­¦ä»£å‚åŠ ï¼ˆå…è´¹ï¼‰' 
                : 'ğŸ‘¥ è¯·äººä»£å‚åŠ ï¼ˆé‡‘é’±-1ï¼‰';

            showModal('ğŸ“ å¼€ä¼šé€‰æ‹©', '<p>æ­å–œè®ºæ–‡è¢«æ¥æ”¶ï¼éœ€è¦å‚åŠ å­¦æœ¯ä¼šè®®è¿›è¡Œå±•ç¤ºã€‚è¯·é€‰æ‹©å‚ä¼šæ–¹å¼ï¼š</p>', [
                { text: 'ğŸ’° è‡ªå·±å‡ºé’±ï¼ˆé‡‘é’±-4ï¼‰', class: 'btn-warning', action: () => {
                    addLog('å¼€ä¼š', 'è‡ªå·±å‡ºé’±å‚åŠ å­¦æœ¯ä¼šè®®', 'é‡‘é’±-4');
                    closeModal();
                    if (changeGold(-4)) {
                        setTimeout(showConferenceEventModal, 200);
                    }
                }},
                { text: favorText, class: 'btn-info', action: () => {
                    const result = gameState.favor >= 6 
                        ? 'å¯¼å¸ˆçˆ½å¿«æŠ¥é”€ï¼Œå¥½æ„Ÿåº¦-1' 
                        : 'å¯¼å¸ˆå¥½æ„Ÿåº¦-2';
                    addLog('å¼€ä¼š', 'å¯¼å¸ˆæŠ¥é”€å‚åŠ å­¦æœ¯ä¼šè®®', result);
                    closeModal();
                    if (changeFavor(-favorCost)) {
                        setTimeout(showConferenceEventModal, 200);
                    }
                }},
                { text: proxyText, class: 'btn-primary', action: () => {
                    if (gameState.social >= 6) {
                        addLog('å¼€ä¼š', 'è¯·åŒå­¦ä»£ä¸ºå‚åŠ å­¦æœ¯ä¼šè®®', 'åŒå­¦ä¹‰æ°”å¸®å¿™ï¼Œå…è´¹');
                        closeModal();
                    } else {
                        addLog('å¼€ä¼š', 'è¯·äººä»£ä¸ºå‚åŠ å­¦æœ¯ä¼šè®®', 'é‡‘é’±-1');
                        closeModal();
                        changeGold(-proxyCost);
                    }
                }}
            ]);
        }

        function showConferenceEventModal() {
            let options = [
                { text: 'ğŸ–ï¸ é¡ºä¾¿æ—…æ¸¸', fn: () => { 
                    gameState.tourCount++;
                    addLog('å¼€ä¼šäº‹ä»¶', 'é¡ºä¾¿æ—…æ¸¸', 'SANå€¼+6');
                    return changeSan(6);
                }},
                { text: 'â˜• èŒ¶æ­‡+æ™šå®´', fn: () => { 
                    gameState.teaBreakCount++;
                    addLog('å¼€ä¼šäº‹ä»¶', 'èŒ¶æ­‡+æ™šå®´', 'SANå€¼+1ï¼Œç¤¾äº¤èƒ½åŠ›+1');
                    return changeStats({ san: 1, social: 1 });
                }},
                { text: 'ğŸ”¬ åŒè¡Œäº¤æµ', fn: () => { 
                    gameState.buffs.temporary.push({ type: 'exp_times', name: 'ä¸‹æ¬¡åšå®éªŒå¤šåš3æ¬¡', value: 3, permanent: false }); 
                    addLog('å¼€ä¼šäº‹ä»¶', 'åŒè¡Œäº¤æµ', 'ä¸´æ—¶buff-ä¸‹æ¬¡åšå®éªŒå¤šåš3æ¬¡');
                    updateBuffs();
                    return true;
                }},
                { text: 'ğŸ’¡ å¹¿æ³›äº¤æµ', fn: () => { 
                    gameState.buffs.temporary.push({ type: 'idea_times', name: 'ä¸‹æ¬¡æƒ³ideaå¤šæƒ³3æ¬¡', value: 3, permanent: false }); 
                    addLog('å¼€ä¼šäº‹ä»¶', 'å¹¿æ³›äº¤æµ', 'ä¸´æ—¶buff-ä¸‹æ¬¡æƒ³ideaå¤šæƒ³3æ¬¡');
                    updateBuffs();
                    return true;
                }},
                { text: 'ğŸŒŸ æ‰¾å¤§ç‰›äº¤æµ', fn: () => { 
                    gameState.buffs.temporary.push({ type: 'idea_bonus', name: 'ä¸‹æ¬¡æƒ³ideaåˆ†æ•°Ã—1.25', value: 1.25, multiply: true, permanent: false }); 
                    gameState.metBigBull = true;
                    addLog('å¼€ä¼šäº‹ä»¶', 'æ‰¾å¤§ç‰›äº¤æµ', 'ä¸´æ—¶buff-ä¸‹æ¬¡æƒ³ideaåˆ†æ•°Ã—1.25');
                    updateBuffs();
                    return true;
                }},
                { text: 'ğŸ¢ æ‰¾ä¼ä¸šäº¤æµ', fn: () => { 
                    gameState.enterpriseCount = (gameState.enterpriseCount || 0) + 1;
                    gameState.buffs.temporary.push({ type: 'exp_bonus', name: 'ä¸‹æ¬¡åšå®éªŒåˆ†æ•°Ã—1.25', value: 1.25, multiply: true, permanent: false }); 
                    addLog('å¼€ä¼šäº‹ä»¶', 'æ‰¾ä¼ä¸šäº¤æµ', `ä¸´æ—¶buff-ä¸‹æ¬¡åšå®éªŒåˆ†æ•°Ã—1.25ï¼ˆç¬¬${gameState.enterpriseCount}æ¬¡ï¼‰`);
                    updateBuffs();
                    
                    if (gameState.enterpriseCount === 3 && !gameState.ailabInternship) {
                        setTimeout(() => showAILabInternshipModal(), 300);
                    }
                    return true;
                }},
                { text: 'ğŸ¤ æ‰¾åŒå­¦åˆä½œ', fn: () => { 
                    gameState.buffs.temporary.push({ type: 'exp_bonus', name: 'ä¸‹æ¬¡åšå®éªŒåˆ†æ•°+5', value: 5, permanent: false }); 
                    addLog('å¼€ä¼šäº‹ä»¶', 'æ‰¾åŒå­¦åˆä½œ', 'ä¸´æ—¶buff-ä¸‹æ¬¡åšå®éªŒåˆ†æ•°+5');
                    updateBuffs();
                    return true;
                }}
            ];

            if (gameState.social >= 6) {
                options.push(
                    { text: 'ğŸ“ æ‰¾å¤§ç‰›åˆä½œ', fn: () => { 
                        gameState.buffs.temporary.push({ type: 'write_bonus', name: 'ä¸‹æ¬¡å†™è®ºæ–‡åˆ†æ•°+8', value: 8, permanent: false }); 
                        gameState.metBigBull = true;
                        addLog('å¼€ä¼šäº‹ä»¶', 'æ‰¾å¤§ç‰›åˆä½œ', 'ä¸´æ—¶buff-ä¸‹æ¬¡å†™è®ºæ–‡åˆ†æ•°+8ï¼Œç¤¾äº¤èƒ½åŠ›+1');
                        updateBuffs();
                        return changeSocial(1);
                    }},
                    { text: 'ğŸ’• å’Œå¥½çœ‹çš„å¼‚æ€§å­¦è€…äº¤æµ', fn: () => { 
                        gameState.metBeautiful = true;
                        gameState.beautifulCount++;
                        addLog('å¼€ä¼šäº‹ä»¶', 'å’Œå¥½çœ‹çš„å¼‚æ€§å­¦è€…äº¤æµ', 'SANå€¼+5ï¼Œç¤¾äº¤èƒ½åŠ›+1');
                        return changeStats({ san: 5, social: 1 });
                    }},
                    { text: 'ğŸ§  å’Œèªæ…§çš„å¼‚æ€§å­¦è€…äº¤æµ', fn: () => { 
                        gameState.buffs.temporary.push({ type: 'idea_times', name: 'ä¸‹æ¬¡æƒ³ideaå¤šæƒ³2æ¬¡', value: 2, permanent: false });
                        gameState.metSmart = true;
                        gameState.smartCount++;
                        addLog('å¼€ä¼šäº‹ä»¶', 'å’Œèªæ…§çš„å¼‚æ€§å­¦è€…äº¤æµ', 'SANå€¼+1ï¼Œç¤¾äº¤èƒ½åŠ›+1ï¼Œä¸´æ—¶buff-ä¸‹æ¬¡æƒ³ideaå¤šæƒ³2æ¬¡');
                        updateBuffs();
                        return changeStats({ san: 1, social: 1 });
                    }}
                );
            }

            if (gameState.metBigBull && !gameState.bigBullCooperation) {
                options.push({ text: 'ğŸŒŸ å’Œä¸Šæ¬¡é‚£ä¸ªå¤§ç‰›æ·±å…¥åˆä½œ', fn: () => {
                    gameState.buffs.temporary.push({ type: 'write_bonus', name: 'ä¸‹æ¬¡å†™è®ºæ–‡åˆ†æ•°+10', value: 10, permanent: false });
                    gameState.bigBullDeepCount++;
                    addLog('å¼€ä¼šäº‹ä»¶', 'å’Œä¸Šæ¬¡é‚£ä¸ªå¤§ç‰›æ·±å…¥åˆä½œ', 'ä¸´æ—¶buff-ä¸‹æ¬¡å†™è®ºæ–‡åˆ†æ•°+10');
                    updateBuffs();
                    if (gameState.research >= 12 && gameState.bigBullDeepCount >= 2) {
                        setTimeout(showBigBullCoopModal, 300);
                    }
                    return true;
                }});
            }

            if (gameState.metBeautiful && !gameState.hasLover) {
                options.push({ text: 'ğŸ’• å’Œä¸Šæ¬¡é‚£ä¸ªå¥½çœ‹çš„å¼‚æ€§å­¦è€…äº¤æµ', fn: () => {
                    gameState.beautifulCount++;
                    addLog('å¼€ä¼šäº‹ä»¶', 'å’Œä¸Šæ¬¡é‚£ä¸ªå¥½çœ‹çš„å¼‚æ€§å­¦è€…äº¤æµ', 'SANå€¼+8ï¼ŒSANå€¼ä¸Šé™+3');
                    gameState.sanMax += 3;
                    changeSan(8);
                    if (gameState.social >= 12 && gameState.beautifulCount >= 2) {
                        setTimeout(() => showLoverModal('beautiful'), 300);
                    }
                    return true;
                }});
            }

            if (gameState.metSmart && !gameState.hasLover) {
                options.push({ text: 'ğŸ§  å’Œä¸Šæ¬¡é‚£ä¸ªèªæ…§çš„å¼‚æ€§å­¦è€…äº¤æµ', fn: () => {
                    gameState.smartCount++;
                    addLog('å¼€ä¼šäº‹ä»¶', 'å’Œä¸Šæ¬¡é‚£ä¸ªèªæ…§çš„å¼‚æ€§å­¦è€…äº¤æµ', 'SANå€¼+1ï¼Œç§‘ç ”èƒ½åŠ›+1');
                    changeSan(1);
                    changeResearch(1);
                    if (gameState.social >= 12 && gameState.smartCount >= 2) {
                        setTimeout(() => showLoverModal('smart'), 300);
                    }
                    return true;
                }});
            }

            const selected = shuffle(options).slice(0, 3);
            showModal('ğŸ‰ å¼€ä¼šäº‹ä»¶', '<p>åœ¨å­¦æœ¯ä¼šè®®ä¸Šï¼Œä½ å¯ä»¥é€‰æ‹©ï¼š</p>', selected.map(opt => ({
                text: opt.text, class: 'btn-primary', action: () => {
                    closeModal();
                    opt.fn();
                }
            })));
        }

        function showLoverModal(type) {
            const desc = type === 'beautiful' 
                ? 'ä½ å’Œé‚£ä¸ªå¥½çœ‹çš„å¼‚æ€§å­¦è€…è¶Šæ¥è¶Šç†Ÿæ‚‰äº†' 
                : 'ä½ å’Œé‚£ä¸ªèªæ…§çš„å¼‚æ€§å­¦è€…è¶Šæ¥è¶Šé»˜å¥‘äº†';
            
            const bonusDesc = type === 'beautiful'
                ? '<div style="margin-top:10px;padding:8px;background:rgba(253,121,168,0.1);border-radius:8px;font-size:0.8rem;"><strong>æ‹äººæ•ˆæœï¼š</strong><br>âœ¨ SANå€¼ç«‹å³å›æ»¡<br>âœ¨ SANä¸Šé™+4<br>âœ¨ æ¯æœˆSAN+3<br>ğŸ’¸ æ¯æœˆé‡‘é’±-1ï¼ˆçº¦ä¼šå¼€é”€ï¼‰</div>'
                : '<div style="margin-top:10px;padding:8px;background:rgba(116,185,255,0.1);border-radius:8px;font-size:0.8rem;"><strong>æ‹äººæ•ˆæœï¼š</strong><br>âœ¨ SAN+1ï¼Œç§‘ç ”èƒ½åŠ›+1<br>âœ¨ æ¯æ¬¡æƒ³idea/åšå®éªŒ/å†™è®ºæ–‡å¤šä¸€æ¬¡<br>ğŸ’¸ æ¯æœˆé‡‘é’±-1ï¼ˆçº¦ä¼šå¼€é”€ï¼‰</div>';
            
            showModal('ğŸ’• å‘å±•å…³ç³»', `<p>${desc}ï¼Œæ˜¯å¦æˆä¸ºæ‹äººï¼Ÿ</p>${bonusDesc}`, [
                { text: 'è¿˜æ˜¯ç®—äº†', class: 'btn-info', action: closeModal },
                { text: 'â¤ï¸ æˆä¸ºæ‹äºº', class: 'btn-accent', action: () => {
                    gameState.hasLover = true;
                    gameState.loverType = type;
                    if (type === 'beautiful') {
                        gameState.san = gameState.sanMax;
                        gameState.sanMax += 4;
                        addLog('ğŸ’• æ‹çˆ±', 'å’Œå¥½çœ‹çš„å¼‚æ€§å­¦è€…æˆä¸ºæ‹äºº', 'SANå€¼å›æ»¡ï¼ŒSANä¸Šé™+4ï¼Œæ¯æœˆSAN+3ï¼Œæ¯æœˆé‡‘é’±-1');
                    } else {
                        changeResearch(1);
                        gameState.buffs.permanent.push(
                            { type: 'idea_times', name: 'æ¯æ¬¡æƒ³ideaå¤šæƒ³1æ¬¡', value: 1, permanent: true },
                            { type: 'exp_times', name: 'æ¯æ¬¡åšå®éªŒå¤šåš1æ¬¡', value: 1, permanent: true },
                            { type: 'write_times', name: 'æ¯æ¬¡å†™è®ºæ–‡å¤šå†™1æ¬¡', value: 1, permanent: true }
                        );
                        addLog('ğŸ’• æ‹çˆ±', 'å’Œèªæ…§çš„å¼‚æ€§å­¦è€…æˆä¸ºæ‹äºº', 'SAN+1ï¼Œç§‘ç ”èƒ½åŠ›+1ï¼Œæ°¸ä¹…buff-æ¯æ¬¡æƒ³idea/åšå®éªŒ/å†™è®ºæ–‡å¤šä¸€æ¬¡ï¼Œæ¯æœˆé‡‘é’±-1');
                        changeSan(1);
                    }
                    closeModal();
                    updateAllUI();
                    updateBuffs();
                }}
            ]);
        }

        function showAILabInternshipModal() {
            const sanCost = gameState.isReversed && gameState.character === 'normal' 
                ? (gameState.reversedAwakened ? 9 : 6) 
                : 3;
            
            showModal('ğŸ¢ å®ä¹ é‚€è¯·', 
                `<div style="text-align:center;margin-bottom:15px;">
                    <div style="font-size:2.5rem;margin-bottom:10px;">ğŸ¤–</div>
                    <div style="font-size:1.1rem;font-weight:600;color:var(--primary-color);">ä¸Šæµ·AI Lab è¿œç¨‹å®ä¹ é‚€è¯·</div>
                </div>
                <p>ä½ åœ¨ä¼ä¸šäº¤æµä¸­è¡¨ç°å‡ºè‰²ï¼ŒAI Lab çš„ç ”ç©¶å‘˜å¯¹ä½ å°è±¡æ·±åˆ»ï¼Œå‘ä½ å‘å‡ºäº†è¿œç¨‹å®ä¹ é‚€è¯·ï¼</p>
                
                <div style="background:var(--light-bg);border-radius:10px;padding:12px;margin:15px 0;">
                    <div style="font-size:0.85rem;font-weight:600;margin-bottom:8px;">ğŸ“‹ å®ä¹ å¾…é‡ï¼š</div>
                    <div style="display:flex;flex-direction:column;gap:6px;font-size:0.85rem;">
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span style="color:var(--success-color);">âœ“</span>
                            <span>æ°¸ä¹…buffï¼šåšå®éªŒåˆ†æ•° Ã—1.25</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span style="color:var(--success-color);">âœ“</span>
                            <span>æ¯æœˆé‡‘é’± +2ï¼ˆå®ä¹ å·¥èµ„ï¼‰</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span style="color:var(--danger-color);">âœ—</span>
                            <span>æ¯æœˆSAN -${sanCost}ï¼ˆå·¥ä½œå‹åŠ›ï¼‰${sanCost !== 3 ? 'ï¼ˆæ€ æƒ°æ•ˆæœï¼‰' : ''}</span>
                        </div>
                    </div>
                </div>
                
                <p style="font-size:0.8rem;color:var(--text-secondary);text-align:center;">
                    è¿œç¨‹å®ä¹ å¯ä»¥å…¼é¡¾å­¦ä¸šï¼Œä½†éœ€è¦æ‰¿æ‹…é¢å¤–çš„å·¥ä½œå‹åŠ›
                </p>`,
                [
                    { text: 'å©‰æ‹’é‚€è¯·', class: 'btn-info', action: () => {
                        addLog('å®ä¹ é‚€è¯·', 'å©‰æ‹’äº†AI Labçš„å®ä¹ é‚€è¯·', 'ä¸“å¿ƒå®Œæˆå­¦ä¸š');
                        closeModal();
                    }},
                    { text: 'ğŸš€ æ¥å—å®ä¹ ', class: 'btn-primary', action: () => {
                        gameState.ailabInternship = true;
                        gameState.buffs.permanent.push({ 
                            type: 'exp_bonus', 
                            name: 'å®ä¹ åŠ æˆï¼šåšå®éªŒåˆ†æ•°Ã—1.25', 
                            value: 1.25, 
                            multiply: true, 
                            permanent: true 
                        });
                        addLog('å®ä¹ é‚€è¯·', 'æ¥å—äº†AI Labçš„è¿œç¨‹å®ä¹ ', 'æ°¸ä¹…buff-åšå®éªŒåˆ†æ•°Ã—1.25ï¼Œæ¯æœˆé‡‘é’±+2ï¼Œæ¯æœˆSAN-3');
                        closeModal();
                        updateBuffs();
                        updateAllUI();
                    }}
                ]
            );
        }

        function showBigBullCoopModal() {
            showModal('ğŸŒŸ è”åˆåŸ¹å…»', '<p>å¤§ç‰›å¯¹ä½ çš„ç§‘ç ”èƒ½åŠ›å°è±¡æ·±åˆ»ï¼Œæè®®ä¸ä½ çš„å¯¼å¸ˆè”åˆåŸ¹å…»ä½ ï¼Œæ˜¯å¦æ¥å—ï¼Ÿ</p>', [
                { text: 'å©‰æ‹’', class: 'btn-info', action: closeModal },
                { text: 'âœ¨ æ¥å—è”åˆåŸ¹å…»', class: 'btn-primary', action: () => {
                    gameState.bigBullCooperation = true;
                    gameState.buffs.permanent.push({ type: 'write_bonus', name: 'æ¯æ¬¡å†™è®ºæ–‡åˆ†æ•°+10', value: 10, permanent: true });
                    addLog('è”åˆåŸ¹å…»', 'å¯¼å¸ˆä¸å¤§ç‰›è”åˆåŸ¹å…»', 'æ°¸ä¹…buff-æ¯æ¬¡å†™è®ºæ–‡åˆ†æ•°+10');
                    closeModal();
                    updateBuffs();
                }}
            ]);
        }
		
        // ==================== å•†åº—ç³»ç»Ÿ ====================
		function openShop() {
			let html = '<div>';
			shopItems.forEach(item => {
				const canBuy = gameState.gold >= item.price && !(item.once && item.bought) && !(item.monthlyOnce && item.boughtThisMonth);
				const reason = gameState.gold < item.price ? 'é‡‘å¸ä¸è¶³' : (item.once && item.bought) ? 'å·²è´­ä¹°' : (item.monthlyOnce && item.boughtThisMonth) ? 'æœ¬æœˆå·²è´­' : '';
				
				// â˜…â˜…â˜… æ–°å¢ï¼šå†°ç¾å¼åŠ¨æ€æè¿° â˜…â˜…â˜…
				let itemDesc = item.desc;
				if (item.id === 'coffee') {
					const count = gameState.coffeeBoughtCount || 0;
					const currentBonus = count >= 15 ? 3 : 2;
					itemDesc = `SANå€¼+${currentBonus}`;
					if (count < 15) {
						itemDesc += ` (${count}/15æ¯å+3)`;
					} else {
						itemDesc += ' (å·²å‡çº§)';
					}
				}
				
				html += `<div class="shop-item ${!canBuy ? 'disabled' : ''}">
					<div class="shop-item-info">
						<div class="shop-item-name">${item.name}</div>
						<div class="shop-item-desc">${itemDesc}</div>
					</div>
					<div class="shop-item-action">
						<span class="shop-item-price">ğŸ’°${item.price}</span>
						<button class="btn btn-primary" onclick="buyItem('${item.id}')" ${!canBuy ? 'disabled' : ''}>${reason || 'è´­ä¹°'}</button>
					</div>
				</div>`;
			});
			html += '</div>';
			showModal('ğŸ›’ å•†åº—', html, [{ text: 'å…³é—­', class: 'btn-info', action: closeModal }]);
		}

        function buyItem(id) {
            const item = shopItems.find(i => i.id === id);
            if (!item) return;
            
            if (gameState.gold < item.price) {
                showModal('âŒ è´­ä¹°å¤±è´¥', `<p>é‡‘é’±ä¸è¶³ï¼è´­ä¹°${item.name}éœ€è¦${item.price}é‡‘å¸ï¼Œå½“å‰åªæœ‰${gameState.gold}é‡‘å¸ã€‚</p>`, 
                    [{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
                return;
            }
            
            let result = `é‡‘é’±-${item.price}`;
            
            // å¯Œå¯æ•Œå›½è§‰é†’ï¼šé€šè¿‡æ¶ˆè´¹å¢åŠ å±æ€§
            if (gameState.isReversed && gameState.character === 'rich' && gameState.reversedAwakened) {
                const spent = item.price;
                gameState.goldSpentTotal = (gameState.goldSpentTotal || 0) + spent;
                
                const attributeGains = Math.floor(gameState.goldSpentTotal / 6);
                const previousGains = Math.floor((gameState.goldSpentTotal - spent) / 6);
                const newGains = attributeGains - previousGains;
                
                if (newGains > 0) {
                    gameState.san = Math.min(gameState.sanMax, gameState.san + newGains);
                    gameState.research = Math.min(20, gameState.research + newGains);
                    gameState.social = Math.min(20, gameState.social + newGains);
                    gameState.favor = Math.min(20, gameState.favor + newGains);
                    result += `ï¼Œé‡‘é’±è§‰é†’(ç´¯è®¡${gameState.goldSpentTotal}é‡‘)ï¼šSAN+${newGains}, ç§‘ç ”+${newGains}, ç¤¾äº¤+${newGains}, å¥½æ„Ÿ+${newGains}`;
                }
            }
            
            gameState.gold -= item.price;
            
            switch(id) {
                case 'gpu_buy':
                    gameState.gpuServersBought = (gameState.gpuServersBought || 0) + 1;
                    if (gameState.gpuServersBought >= 5) {
                        gameState.achievementConditions = gameState.achievementConditions || {};
                        gameState.achievementConditions.bought5GPUs = true;
                    }
                    break;
                    
                case 'chair':
                    gameState.furnitureBought = gameState.furnitureBought || {};
                    gameState.furnitureBought.chair = true;
                    break;
                case 'monitor':
                    gameState.furnitureBought = gameState.furnitureBought || {};
                    gameState.furnitureBought.monitor = true;
                    break;
                case 'keyboard':
                    gameState.furnitureBought = gameState.furnitureBought || {};
                    gameState.furnitureBought.keyboard = true;
                    break;
            }
            
            // æ£€æŸ¥å…¨å¥—å®¶å…·æˆå°±
            if (gameState.furnitureBought && 
                gameState.furnitureBought.chair && 
                gameState.furnitureBought.monitor && 
                gameState.furnitureBought.keyboard) {
                gameState.achievementConditions = gameState.achievementConditions || {};
                gameState.achievementConditions.fullFurnitureSet = true;
            }
            
            switch (id) {
                case 'chair':
                    item.bought = true;
                    gameState.buffs.permanent.push({ type: 'monthly_san', name: 'æ¯æœˆSANå€¼+1', value: 1, permanent: true });
                    result += 'ï¼Œè·å¾—æ°¸ä¹…buff-æ¯æœˆSANå€¼+1';
                    break;
                case 'gpu_rent':
                    gameState.buffs.temporary.push({ type: 'exp_times', name: 'ä¸‹æ¬¡åšå®éªŒå¤šåš1æ¬¡', value: 1, permanent: false });
                    result += 'ï¼Œè·å¾—ä¸´æ—¶buff-ä¸‹æ¬¡åšå®éªŒå¤šåš1æ¬¡';
                    break;
                case 'gpu_buy':
                    gameState.buffs.permanent.push({ type: 'exp_times', name: 'æ¯æ¬¡åšå®éªŒå¤šåš1æ¬¡', value: 1, permanent: true });
                    result += 'ï¼Œè·å¾—æ°¸ä¹…buff-æ¯æ¬¡åšå®éªŒå¤šåš1æ¬¡';
                    break;
                case 'keyboard':
                    item.bought = true;
                    gameState.buffs.permanent.push({ type: 'write_san_reduce', name: 'å†™è®ºæ–‡SAN-3', value: 1, permanent: true });
                    result += 'ï¼Œè·å¾—æ°¸ä¹…buff-æ¯æ¬¡å†™è®ºæ–‡å˜ä¸ºSANå€¼-3';
                    break;
                case 'monitor':
                    item.bought = true;
                    gameState.buffs.permanent.push({ type: 'read_san_reduce', name: 'è¯»è®ºæ–‡SAN-1', value: 1, permanent: true });
                    result += 'ï¼Œè·å¾—æ°¸ä¹…buff-è¯»è®ºæ–‡å˜ä¸ºSANå€¼-1';
                    break;
				case 'coffee':
					item.boughtThisMonth = true;
					gameState.coffeeBoughtCount = (gameState.coffeeBoughtCount || 0) + 1;
					
					// â˜…â˜…â˜… æ–°å¢ï¼šå–æ»¡15æ¬¡åæ•ˆæœ+1 â˜…â˜…â˜…
					const coffeeBonus = gameState.coffeeBoughtCount >= 15 ? 3 : 2;
					gameState.san = Math.min(gameState.sanMax, gameState.san + coffeeBonus);
					result += `ï¼ŒSANå€¼+${coffeeBonus}`;
					
					// è¾¾åˆ°15æ¬¡æ—¶æç¤º
					if (gameState.coffeeBoughtCount === 15) {
						result += 'ï¼ˆå’–å•¡å› è€å—ï¼Œæ•ˆæœæå‡ï¼ï¼‰';
						addLog('â˜• å’–å•¡å‡çº§', 'ä½ å·²ç»å–äº†15æ¯å†°ç¾å¼', 'äº§ç”Ÿå’–å•¡å› è€å—ï¼Œä»¥åæ¯æ¯SAN+3ï¼');
					}
					break;
                case 'polish':
                    item.boughtThisMonth = true;
                    gameState.buffs.temporary.push({ type: 'write_bonus', name: 'ä¸‹æ¬¡è®ºæ–‡å†™ä½œåˆ†æ•°+5', value: 5, permanent: false });
                    result += 'ï¼Œè·å¾—ä¸´æ—¶buff-ä¸‹æ¬¡è®ºæ–‡å†™ä½œåˆ†æ•°+5';
                    break;
                case 'gemini':
                    item.boughtThisMonth = true;
                    gameState.buffs.temporary.push({ type: 'idea_bonus', name: 'ä¸‹æ¬¡æƒ³ideaåˆ†æ•°+4', value: 4, permanent: false });
                    result += 'ï¼Œè·å¾—ä¸´æ—¶buff-ä¸‹æ¬¡æƒ³ideaåˆ†æ•°+4';
                    break;
                case 'gpt':
                    item.boughtThisMonth = true;
                    gameState.buffs.temporary.push({ type: 'write_bonus', name: 'ä¸‹æ¬¡å†™è®ºæ–‡åˆ†æ•°+4', value: 4, permanent: false });
                    result += 'ï¼Œè·å¾—ä¸´æ—¶buff-ä¸‹æ¬¡å†™è®ºæ–‡åˆ†æ•°+4';
                    break;
                case 'claude':
                    item.boughtThisMonth = true;
                    gameState.buffs.temporary.push({ type: 'exp_bonus', name: 'ä¸‹æ¬¡åšå®éªŒåˆ†æ•°+4', value: 4, permanent: false });
                    result += 'ï¼Œè·å¾—ä¸´æ—¶buff-ä¸‹æ¬¡åšå®éªŒåˆ†æ•°+4';
                    break;
            }
            
            addLog('è´­ä¹°', `è´­ä¹°äº†${item.name}`, result);
            closeModal();
            openShop();
            updateAllUI();
            updateBuffs();
        }
        // ==================== å¯’å‡æš‘å‡äº‹ä»¶ ====================
        function triggerWinterVacationEvent() {
            showModal('â„ï¸ å¯’å‡', 
                `<p>å¯’å‡åˆ°äº†ï¼å›å®¶è¿‡å¹´ï¼Œæ”¶åˆ°äº†é•¿è¾ˆçš„å‹å²é’±ï¼Œå¥½å¥½ä¼‘æ¯ä¸€ä¸‹å§ï½</p>
                 <div style="text-align:center;font-size:2rem;margin:15px 0;">ğŸ§§ğŸ ğŸ†</div>`,
                [{ 
                    text: 'ğŸŠ æ–°å¹´å¿«ä¹ï¼', 
                    class: 'btn-accent', 
					action: () => {
						gameState.gold += 1;
						gameState.san = Math.min(gameState.sanMax, gameState.san + 2);
						addLog('â„ï¸ å¯’å‡', 'å›å®¶è¿‡å¹´', 'å‹å²é’±+1ï¼ŒSANå€¼+2');
						closeModal();
						updateAllUI();
					}
                }]
            );
        }

        function triggerSummerVacationEvent() {
            showModal('â˜€ï¸ æš‘å‡', 
                `<p>æš‘å‡æ¥å•¦ï¼è™½ç„¶ç§‘ç ”ä¸èƒ½åœï¼Œä½†å¯ä»¥ç¨å¾®æ”¾æ¾ä¸€ä¸‹ï¼Œè°ƒæ•´çŠ¶æ€ï½</p>
                 <div style="text-align:center;font-size:2rem;margin:15px 0;">ğŸ–ï¸ğŸ‰ğŸŒ´</div>`,
                [{ 
                    text: 'ğŸ˜ å¥½å¥½ä¼‘æ¯ï¼', 
                    class: 'btn-success', 
					action: () => {
						gameState.san = Math.min(gameState.sanMax, gameState.san + 3);
						addLog('â˜€ï¸ æš‘å‡', 'æš‘å‡ä¼‘æ¯', 'SANå€¼+3');
						closeModal();
						updateAllUI();
					}
                }]
            );
        }
        
        // ==================== éšæœºäº‹ä»¶ç³»ç»Ÿ ====================
        function triggerScholarshipEvent() {
            const req = { 2: 1, 3: 3, 4: 6, 5: 9 }[gameState.year] || 9;
            const reward = { 2: 5, 3: 5, 4: 10, 5: 10 }[gameState.year] || 10;
            if (gameState.totalScore >= req) {
                gameState.gold += reward;
                showModal('ğŸ“ å¥–å­¦é‡‘', `<p>æ­å–œï¼ä½ çš„ç§‘ç ”åˆ†è¾¾åˆ°${gameState.totalScore}åˆ†ï¼Œæ»¡è¶³æœ¬å¹´åº¦å¥–å­¦é‡‘è¦æ±‚ï¼ˆâ‰¥${req}åˆ†ï¼‰ï¼Œè·å¾—å¥–å­¦é‡‘${reward}é‡‘å¸ï¼</p>`,
                    [{ text: 'å¤ªæ£’äº†ï¼', class: 'btn-primary', action: () => {
                        addLog('å¥–å­¦é‡‘', `ç¬¬${gameState.year}å¹´å¥–å­¦é‡‘`, `ç§‘ç ”åˆ†${gameState.totalScore}â‰¥${req}ï¼Œé‡‘é’±+${reward}`);
                        closeModal(); updateAllUI();
                    }}]);
            } else {
                showModal('ğŸ“ å¥–å­¦é‡‘', `<p>é—æ†¾è½é€‰ï¼æœ¬å¹´åº¦å¥–å­¦é‡‘è¦æ±‚ç§‘ç ”åˆ†â‰¥${req}ï¼Œä½ ç›®å‰${gameState.totalScore}åˆ†ã€‚</p>`,
                    [{ text: 'ç»§ç»­åŠªåŠ›', class: 'btn-info', action: () => {
                        addLog('å¥–å­¦é‡‘', `ç¬¬${gameState.year}å¹´å¥–å­¦é‡‘`, `ç§‘ç ”åˆ†${gameState.totalScore}<${req}ï¼Œé—æ†¾è½é€‰`);
                        closeModal();
                    }}]);
            }
        }

        function triggerTeachersDayEvent() {
            showModal('ğŸ æ•™å¸ˆèŠ‚', '<p>æ•™å¸ˆèŠ‚åˆ°äº†ï¼Œä½ å‡†å¤‡é€å¯¼å¸ˆä»€ä¹ˆç¤¼ç‰©ï¼Ÿ</p>', [
                { text: 'ä»€ä¹ˆä¹Ÿä¸é€', class: 'btn-info', action: () => {
                    closeModal();
                    if (gameState.favor >= 6) {
                        addLog('æ•™å¸ˆèŠ‚', 'ä»€ä¹ˆä¹Ÿä¸é€', 'æ— äº‹å‘ç”Ÿ');
                        updateAllUI();
                    } else {
                        addLog('æ•™å¸ˆèŠ‚', 'ä»€ä¹ˆä¹Ÿä¸é€', 'å¯¼å¸ˆå¯¹ä½ ç•¥æœ‰ä¸æ»¡ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦-1');
                        changeFavor(-1);
                    }
                }},
                { text: 'ğŸµ èµ é€èŒ¶å¶ï¼ˆ1é‡‘ï¼‰', class: 'btn-primary', action: () => {
                    addLog('æ•™å¸ˆèŠ‚', 'èµ é€èŒ¶å¶', 'é‡‘é’±-1ï¼Œå¯¼å¸ˆå¼€å¿ƒæ”¶ä¸‹èŒ¶å¶ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦+1');
                    closeModal();
                    gameState.favor = Math.min(20, gameState.favor + 1);
                    changeGold(-1);
                }},
                { text: 'ğŸ“® èµ é€é‚®ç¥¨ï¼ˆ3é‡‘ï¼‰', class: 'btn-warning', action: () => {
                    addLog('æ•™å¸ˆèŠ‚', 'èµ é€é‚®ç¥¨', 'é‡‘é’±-3ï¼Œå¯¼å¸ˆå¼€å¿ƒæ”¶ä¸‹é‚®ç¥¨å¹¶ç‚¹äº†ç‚¹å¤´ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦+2');
                    closeModal();
                    gameState.favor = Math.min(20, gameState.favor + 2);
                    changeGold(-3);
                }}
            ]);
        }

        function triggerOtherRandomEvent() {
            let availableEvents = [...gameState.availableRandomEvents];
            
            if (gameState.social >= 6 && !availableEvents.includes(11) && !gameState.usedRandomEvents.includes(11)) {
                availableEvents.push(11);
            }
            
            if (availableEvents.length === 0) {
                resetRandomEventPool();
                availableEvents = [...gameState.availableRandomEvents];
                if (gameState.social >= 6) {
                    availableEvents.push(11);
                }
                addLog('äº‹ä»¶è½®æ¢', 'æ–°ä¸€è½®éšæœºäº‹ä»¶å¼€å§‹', 'æ‰€æœ‰äº‹ä»¶é‡æ–°å¯ç”¨');
            }
            
            const eventIndex = Math.floor(Math.random() * availableEvents.length);
            const eventId = availableEvents[eventIndex];
            // â˜…â˜…â˜… æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦æŠµæŠ—æ„Ÿå†’ â˜…â˜…â˜…
			if (eventId === 3 && gameState.totalMonths === gameState.badmintonMonth + 1) {
				// ä»å¯ç”¨æ± ä¸­ç§»é™¤æ„Ÿå†’äº‹ä»¶
				gameState.availableRandomEvents = gameState.availableRandomEvents.filter(e => e !== 3);
				if (!gameState.usedRandomEvents.includes(3)) {
					gameState.usedRandomEvents.push(3);
				}
				
				// æ˜¾ç¤ºæŠµæŠ—æ„Ÿå†’çš„æç¤º
				showModal('ğŸ’ª éšæœºäº‹ä»¶', 
					`<p>æœ¬æ¥ä½ è¦æ„Ÿå†’äº†...</p>
					 <div style="text-align:center;font-size:2rem;margin:15px 0;">ğŸ¸â¡ï¸ğŸ›¡ï¸</div>
					 <p>ä½†æ˜¯ä¸Šä¸ªæœˆæ‰“ç¾½æ¯›çƒå¼ºåŒ–äº†èº«ä½“ï¼ŒæˆåŠŸæŠµæŠ—äº†æ„Ÿå†’ï¼</p>`,
					[{ 
						text: 'èº«ä½“å€å„¿æ£’ï¼', 
						class: 'btn-success', 
						action: () => {
							addLog('éšæœºäº‹ä»¶', 'æ„Ÿå†’æ¥è¢­', 'ä¸Šä¸ªæœˆæ‰“ç¾½æ¯›çƒå¼ºåŒ–äº†èº«ä½“ï¼ŒæˆåŠŸæŠµæŠ—ï¼');
							closeModal();
							updateAllUI();
						}
					}]
				);
				return;
			}
			
			gameState.availableRandomEvents = gameState.availableRandomEvents.filter(e => e !== eventId);
			if (!gameState.usedRandomEvents.includes(eventId)) {
				gameState.usedRandomEvents.push(eventId);
			}
			
			const eventMap = {
				1: showRandomEvent1,
				2: showRandomEvent2,
				3: showRandomEvent3,
				4: showRandomEvent4,
				5: showRandomEvent5,
				6: showRandomEvent6,
				7: showRandomEvent7,
				8: showRandomEvent8,
				9: showRandomEvent9,
				10: showRandomEvent10,
				11: showRandomEvent11,
				12: showRandomEvent12,
				13: showRandomEvent13,
				14: showRandomEvent14,
			};
			
			if (eventMap[eventId]) {
				eventMap[eventId]();
			}
		}

        function showRandomEvent1() {
            showModal('ğŸ“š éšæœºäº‹ä»¶', '<p>å¯¼å¸ˆæ´¾ä½ æŒ‡å¯¼æœ¬ç§‘ç”Ÿæ¯•è®¾ã€‚</p>', [
                { text: 'æ®‹å¿æ‹’ç»', class: 'btn-danger', action: () => {
                    addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæ´¾ä½ æŒ‡å¯¼æœ¬ç§‘ç”Ÿæ¯•è®¾ - æ®‹å¿æ‹’ç»', 'å¯¼å¸ˆå¯¹ä½ ç•¥æœ‰ä¸æ»¡ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦-1');
                    closeModal();
                    changeFavor(-1);
                }},
                { text: 'äº²åŠ›äº²ä¸º', class: 'btn-primary', action: () => {
                    closeModal();
                    const baseSanCost = -3;
                    const actualSanCost = getActualSanChange(baseSanCost);
                    const sanText = actualSanCost !== baseSanCost ? `SANå€¼${actualSanCost}ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰` : `SANå€¼${actualSanCost}`;
                    
                    if (Math.random() < 0.5) {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæ´¾ä½ æŒ‡å¯¼æœ¬ç§‘ç”Ÿæ¯•è®¾ - äº²åŠ›äº²ä¸º', `æœ¬ç§‘ç”Ÿé¡ºåˆ©æ¯•ä¸šï¼Œåæˆä¸ºä½ çš„å¸ˆå¼Ÿå¸ˆå¦¹å¸®åŠ©ä½ ç§‘ç ”æ‰“ä¸‹æ‰‹ï¼Œ${sanText}ï¼Œç§‘ç ”èƒ½åŠ›+1`);
                        changeResearch(1);
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæ´¾ä½ æŒ‡å¯¼æœ¬ç§‘ç”Ÿæ¯•è®¾ - äº²åŠ›äº²ä¸º', `æœ¬ç§‘ç”Ÿé¡ºåˆ©æ¯•ä¸šï¼Œ${sanText}`);
                    }
                    changeSan(baseSanCost);
                }},
                { text: 'è®©å¸ˆå¼Ÿå¸ˆå¦¹å»æŒ‡å¯¼', class: 'btn-info', action: () => {
                    closeModal();
                    if (gameState.social < 6) {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæ´¾ä½ æŒ‡å¯¼æœ¬ç§‘ç”Ÿæ¯•è®¾ - è®©å¸ˆå¼Ÿå¸ˆå¦¹å»æŒ‡å¯¼', 'å¸ˆå¼Ÿå¸ˆå¦¹å¯¹ä½ é¢‡æœ‰å¾®è¯ï¼Œç¤¾äº¤èƒ½åŠ›-1');
                        changeSocial(-1);
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæ´¾ä½ æŒ‡å¯¼æœ¬ç§‘ç”Ÿæ¯•è®¾ - è®©å¸ˆå¼Ÿå¸ˆå¦¹å»æŒ‡å¯¼', 'å¸ˆå¼Ÿå¸ˆå¦¹æˆåŠŸä¸ºä½ åˆ†å¿§');
                        updateAllUI();
                    }
                }}
            ]);
        }

        function showRandomEvent2() {
            showModal('ğŸ“ éšæœºäº‹ä»¶', '<p>å¯¼å¸ˆè®©ä½ å¸®ä»–å®¡ç¨¿ã€‚</p>', [
                { text: 'ä»¥æ²¡æ—¶é—´ä¸ºç”±æ‹’ç»', class: 'btn-danger', action: () => {
                    addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆè®©ä½ å¸®ä»–å®¡ç¨¿ - ä»¥æ²¡æ—¶é—´ä¸ºç”±æ‹’ç»', 'å¯¼å¸ˆå¯¹ä½ ç•¥æœ‰ä¸æ»¡ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦-1');
                    closeModal();
                    changeFavor(-1);
                }},
                { text: 'è®¤çœŸå®¡ç¨¿', class: 'btn-primary', action: () => {
                    closeModal();
                    const baseSanCost = -2;
                    const actualSanCost = getActualSanChange(baseSanCost);
                    const sanText = actualSanCost !== baseSanCost ? `SANå€¼${actualSanCost}ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰` : `SANå€¼${actualSanCost}`;
                    
                    if (Math.random() < 0.5) {
                        gameState.buffs.temporary.push({ type: 'idea_bonus', name: 'ä¸‹æ¬¡æƒ³ideaåˆ†æ•°+4', value: 4, permanent: false });
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆè®©ä½ å¸®ä»–å®¡ç¨¿ - è®¤çœŸå®¡ç¨¿', `å¾—åˆ°äº†å¯å‘ï¼Œ${sanText}ï¼Œä¸´æ—¶buff-ä¸‹æ¬¡æƒ³ideaåˆ†æ•°+4`);
                        updateBuffs();
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆè®©ä½ å¸®ä»–å®¡ç¨¿ - è®¤çœŸå®¡ç¨¿', `æ— äº‹å‘ç”Ÿï¼Œ${sanText}`);
                    }
                    changeSan(baseSanCost);
                }},
                { text: 'äº¤ç»™å¸ˆå¼Ÿå¸ˆå¦¹', class: 'btn-info', action: () => {
                    closeModal();
                    if (gameState.social < 6) {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆè®©ä½ å¸®ä»–å®¡ç¨¿ - äº¤ç»™å¸ˆå¼Ÿå¸ˆå¦¹', 'å¸ˆå¼Ÿå¸ˆå¦¹å¯¹ä½ é¢‡æœ‰å¾®è¯ï¼Œç¤¾äº¤èƒ½åŠ›-1');
                        changeSocial(-1);
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆè®©ä½ å¸®ä»–å®¡ç¨¿ - äº¤ç»™å¸ˆå¼Ÿå¸ˆå¦¹', 'å¸ˆå¼Ÿå¸ˆå¦¹æˆåŠŸä¸ºä½ åˆ†å¿§');
                        updateAllUI();
                    }
                }}
            ]);
        }

        function showRandomEvent3() {
            showModal('ğŸ¤§ éšæœºäº‹ä»¶', '<p>çªç„¶æ„Ÿå†’äº†ã€‚</p>', [
                { text: 'å¼ºæ’‘', class: 'btn-danger', action: () => {
                    closeModal();
                    if (Math.random() < 0.5) {
                        const baseSanCost = -8;
                        const actualSanCost = getActualSanChange(baseSanCost);
                        const sanText = actualSanCost !== baseSanCost ? `SANå€¼${actualSanCost}ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰` : `SANå€¼${actualSanCost}`;
                        addLog('éšæœºäº‹ä»¶', 'çªç„¶æ„Ÿå†’äº† - å¼ºæ’‘', `èº«ä½“é€æ”¯äº†ï¼Œ${sanText}`);
                        changeSan(baseSanCost);
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'çªç„¶æ„Ÿå†’äº† - å¼ºæ’‘', 'æ’‘è¿‡å»äº†ï¼Œå¹´è½»äººèº«ä½“å¥½');
                        updateAllUI();
                    }
                }},
                { text: 'è‡ªå·±ä¹°æ„Ÿå†’è¯', class: 'btn-primary', action: () => {
                    addLog('éšæœºäº‹ä»¶', 'çªç„¶æ„Ÿå†’äº† - è‡ªå·±ä¹°æ„Ÿå†’è¯', 'å–999æ„Ÿå†’çµå¥½äº†ï¼Œé‡‘é’±-2');
                    closeModal();
                    changeGold(-2);
                }},
				{ text: 'å»åŒ»é™¢çœ‹ç—…', class: 'btn-info', action: () => {
					addLog('éšæœºäº‹ä»¶', 'çªç„¶æ„Ÿå†’äº† - å»åŒ»é™¢çœ‹ç—…', 'åŒ»ç”Ÿå¦™æ‰‹å›æ˜¥ï¼Œä½ æ¯”ç”Ÿç—…å‰è¿˜ç²¾ç¥ï¼ŒSANå€¼+2ï¼Œé‡‘é’±-4');
					gameState.san = Math.min(gameState.sanMax, gameState.san + 2);
					closeModal();
					changeGold(-4);
				}}
            ]);
        }

        function showRandomEvent4() {
            showModal('ğŸ’¼ éšæœºäº‹ä»¶', '<p>å¯¼å¸ˆå®‰æ’ä½ åšé¡¹ç›®ã€‚</p>', [
                { text: 'æ¨ªå‘é¡¹ç›®', class: 'btn-warning', action: () => {
                    const baseSanCost = -7;
                    const actualSanCost = getActualSanChange(baseSanCost);
                    const sanText = actualSanCost !== baseSanCost ? `SANå€¼${actualSanCost}ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰` : `SANå€¼${actualSanCost}`;
                    addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆå®‰æ’ä½ åšé¡¹ç›® - æ¨ªå‘é¡¹ç›®', `æˆåŠŸç»“é¡¹ï¼Œ${sanText}ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦+1ï¼Œé‡‘é’±+5`);
                    closeModal();
                    gameState.favor = Math.min(20, gameState.favor + 1);
                    gameState.gold += 5;
                    changeSan(baseSanCost);
                }},
                { text: 'çºµå‘é¡¹ç›®', class: 'btn-primary', action: () => {
                    const baseSanCost = -5;
                    const actualSanCost = getActualSanChange(baseSanCost);
                    const sanText = actualSanCost !== baseSanCost ? `SANå€¼${actualSanCost}ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰` : `SANå€¼${actualSanCost}`;
                    addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆå®‰æ’ä½ åšé¡¹ç›® - çºµå‘é¡¹ç›®', `æˆåŠŸç»“é¡¹ï¼Œ${sanText}ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦+1ï¼Œç§‘ç ”èƒ½åŠ›+1`);
                    closeModal();
                    gameState.favor = Math.min(20, gameState.favor + 1);
                    changeResearch(1);
                    changeSan(baseSanCost);
                }},
                { text: 'æ‹’ç»é¡¹ç›®', class: 'btn-danger', action: () => {
                    closeModal();
                    if (gameState.research < 6) {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆå®‰æ’ä½ åšé¡¹ç›® - æ‹’ç»é¡¹ç›®', 'å¯¼å¸ˆå¯¹ä½ æ¯”è¾ƒä¸æ»¡ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦-2');
                        changeFavor(-2);
                    } else if (gameState.research < 12) {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆå®‰æ’ä½ åšé¡¹ç›® - æ‹’ç»é¡¹ç›®', 'å¯¼å¸ˆå¯¹ä½ ç•¥ä¸ºä¸æ»¡ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦-1');
                        changeFavor(-1);
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆå®‰æ’ä½ åšé¡¹ç›® - æ‹’ç»é¡¹ç›®', 'å¯¼å¸ˆè®©ä½ ä»¥ç§‘ç ”ä¸ºé‡');
                        updateAllUI();
                    }
                }},
                { text: 'è®©å¸ˆå¼Ÿå¸ˆå¦¹åˆ†æ‹…', class: 'btn-info', action: () => {
                    closeModal();
                    if (gameState.social < 6) {
                        const baseSanCost = -2;
                        const actualSanCost = getActualSanChange(baseSanCost);
                        const sanText = actualSanCost !== baseSanCost ? `SANå€¼${actualSanCost}ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰` : `SANå€¼${actualSanCost}`;
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆå®‰æ’ä½ åšé¡¹ç›® - è®©å¸ˆå¼Ÿå¸ˆå¦¹åˆ†æ‹…ä¸€éƒ¨åˆ†', `å¸ˆå¼Ÿå¸ˆå¦¹å¯¹ä½ é¢‡æœ‰å¾®è¯ï¼Œ${sanText}ï¼Œç¤¾äº¤èƒ½åŠ›-1`);
                        changeSocial(-1);
                        changeSan(baseSanCost);
                    } else if (gameState.social < 12) {
                        const baseSanCost = -2;
                        const actualSanCost = getActualSanChange(baseSanCost);
                        const sanText = actualSanCost !== baseSanCost ? `SANå€¼${actualSanCost}ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰` : `SANå€¼${actualSanCost}`;
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆå®‰æ’ä½ åšé¡¹ç›® - è®©å¸ˆå¼Ÿå¸ˆå¦¹åˆ†æ‹…ä¸€éƒ¨åˆ†', `å¸ˆå¼Ÿå¸ˆå¦¹æˆåŠŸä¸ºä½ åˆ†å¿§ï¼Œ${sanText}`);
                        changeSan(baseSanCost);
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆå®‰æ’ä½ åšé¡¹ç›® - è®©å¸ˆå¼Ÿå¸ˆå¦¹åˆ†æ‹…ä¸€éƒ¨åˆ†', 'å¸ˆå¼Ÿå¸ˆå¦¹ä¸»åŠ¨å…¨åŒ…äº†');
                        updateAllUI();
                    }
                }}
            ]);
        }

        function showRandomEvent5() {
            showModal('ğŸ’¬ éšæœºäº‹ä»¶', '<p>å¯¼å¸ˆæ‰¾ä½ è°ˆè¯ã€‚</p>', [
                { text: 'è®¤çœŸå‡†å¤‡ç§‘ç ”è¿›å±•', class: 'btn-primary', action: () => {
                    closeModal();
                    if (Math.random() < 0.5) {
                        gameState.buffs.temporary.push({ type: 'idea_bonus', name: 'ä¸‹æ¬¡æƒ³ideaåˆ†æ•°+5', value: 5, permanent: false });
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæ‰¾ä½ è°ˆè¯ - è®¤çœŸå‡†å¤‡ç§‘ç ”è¿›å±•', 'å¯¼å¸ˆæŒ‡å‡ºä½ å…³é”®é”™è¯¯ï¼Œä¸´æ—¶buff-ä¸‹æ¬¡æƒ³ideaåˆ†æ•°+5');
                        updateBuffs();
                        updateAllUI();
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæ‰¾ä½ è°ˆè¯ - è®¤çœŸå‡†å¤‡ç§‘ç ”è¿›å±•', 'å¯¼å¸ˆå‘ç°ä½ åœ¨æ‘¸é±¼ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦-1');
                        changeFavor(-1);
                    }
                }},
                { text: 'å‘å¯¼å¸ˆè¯¢é—®å¦‚ä½•ç§‘ç ”', class: 'btn-info', action: () => {
                    closeModal();
                    if (gameState.favor < 6) {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæ‰¾ä½ è°ˆè¯ - å‘å¯¼å¸ˆè¯¢é—®å¦‚ä½•ç§‘ç ”', 'å¯¼å¸ˆè§‰å¾—ä½ å¤©èµ„æ„šç¬¨ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦-1');
                        changeFavor(-1);
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæ‰¾ä½ è°ˆè¯ - å‘å¯¼å¸ˆè¯¢é—®å¦‚ä½•ç§‘ç ”', 'å¯¼å¸ˆä¼ æˆä½ ç§‘ç ”ç§˜è¯€ï¼Œç§‘ç ”èƒ½åŠ›+1');
                        changeResearch(1);
                    }
                }},
                { text: 'å‘Šè¯‰å¯¼å¸ˆæƒ³è¦å»å®ä¹ ', class: 'btn-warning', action: () => {
                    closeModal();
                    if (gameState.favor >= 6) {
                        const baseSanCost = -6;
                        const actualSanCost = getActualSanChange(baseSanCost);
                        const sanText = actualSanCost !== baseSanCost ? `SANå€¼${actualSanCost}ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰` : `SANå€¼${actualSanCost}`;
                        gameState.buffs.temporary.push({ type: 'exp_bonus', name: 'ä¸‹æ¬¡åšå®éªŒåˆ†æ•°+5', value: 5, permanent: false });
                        gameState.gold += 5;
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæ‰¾ä½ è°ˆè¯ - å‘Šè¯‰å¯¼å¸ˆæƒ³è¦å»å®ä¹ ', `å¯¼å¸ˆå±…ç„¶åŒæ„äº†ä½†è¦å…¼é¡¾ç§‘ç ”ï¼Œ${sanText}ï¼Œä¸´æ—¶buff-ä¸‹æ¬¡åšå®éªŒåˆ†æ•°+5ï¼Œé‡‘é’±+5`);
                        updateBuffs();
                        changeSan(baseSanCost);
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæ‰¾ä½ è°ˆè¯ - å‘Šè¯‰å¯¼å¸ˆæƒ³è¦å»å®ä¹ ', 'å¯¼å¸ˆæœç„¶æ‹’ç»äº†ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦-1');
                        changeFavor(-1);
                    }
                }}
            ]);
        }

        function showRandomEvent6() {
            showModal('ğŸ“Š éšæœºäº‹ä»¶', '<p>å®éªŒå®¤å¬å¼€ç»„ä¼šã€‚</p>', [
                { text: 'è®²è§£ä¸€ç¯‡æ·±å¥¥è®ºæ–‡', class: 'btn-primary', action: () => {
                    closeModal();
                    if (gameState.research < 6) {
                        addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤å¬å¼€ç»„ä¼š - è®²è§£ä¸€ç¯‡æ·±å¥¥è®ºæ–‡', 'å¯¼å¸ˆå‘ç°ä½ ä¸æ‡‚è£…æ‡‚ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦-1');
                        changeFavor(-1);
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤å¬å¼€ç»„ä¼š - è®²è§£ä¸€ç¯‡æ·±å¥¥è®ºæ–‡', 'å¯¼å¸ˆå¤¸èµäº†ä½ çš„è§è§£ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦+1');
                        changeFavor(1);
                    }
                }},
                { text: 'è®²è§£ç³»åˆ—è®ºæ–‡', class: 'btn-warning', action: () => {
                    closeModal();
                    const baseSanCost = -3;
                    const actualSanCost = getActualSanChange(baseSanCost);
                    const sanText = actualSanCost !== baseSanCost ? `SANå€¼${actualSanCost}ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰` : `SANå€¼${actualSanCost}`;
                    
                    if (Math.random() < 0.5) {
                        addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤å¬å¼€ç»„ä¼š - è®²è§£ç³»åˆ—è®ºæ–‡', `è™½ç„¶å¾ˆè¾›è‹¦ä½†å¯¼å¸ˆå¤§åŠ›å¤¸èµäº†ä½ çš„è§è§£ï¼Œ${sanText}ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦+2`);
                        gameState.favor = Math.min(20, gameState.favor + 2);
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤å¬å¼€ç»„ä¼š - è®²è§£ç³»åˆ—è®ºæ–‡', `è™½ç„¶å¾ˆè¾›è‹¦ä½†å¯¼å¸ˆæ²¡æ¥å‚ä¼šï¼Œ${sanText}`);
                    }
                    changeSan(baseSanCost);
                }},
                { text: 'å·å·æ°´è¿‡å»', class: 'btn-info', action: () => {
                    closeModal();
                    if (Math.random() < 0.5) {
                        addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤å¬å¼€ç»„ä¼š - å·å·æ°´è¿‡å»', 'å¯¼å¸ˆå¯¹ä½ ç•¥æœ‰ä¸æ»¡ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦-1');
                        changeFavor(-1);
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤å¬å¼€ç»„ä¼š - å·å·æ°´è¿‡å»', 'å¯¼å¸ˆæ°å¥½æ²¡æ¥');
                        updateAllUI();
                    }
                }}
            ]);
        }

        function showRandomEvent7() {
            showModal('ğŸ‰ éšæœºäº‹ä»¶', '<p>å®éªŒå®¤ç»„ç»‡å›¢å»ºã€‚</p>', [
                { text: 'ğŸ¸ æ‰“ç¾½æ¯›çƒ', class: 'btn-primary', action: () => {
					gameState.badmintonMonth = gameState.totalMonths;
                    addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤ç»„ç»‡å›¢å»º - æ‰“ç¾½æ¯›çƒ', 'è„–å­å’Œæ‰‹è‡‚å¾—åˆ°äº†å¼ºåŒ–ï¼Œæœ‰åŠ©äºæŠµæŠ—æ„Ÿå†’ï¼ŒSANå€¼+2');
                    closeModal();
                    changeSan(2);
                }},
                { text: 'ğŸƒ æ‰“å¾·å·æ‰‘å…‹', class: 'btn-warning', action: () => {
                    closeModal();
                    if (Math.random() < 0.5) {
                        addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤ç»„ç»‡å›¢å»º - æ‰“å¾·å·æ‰‘å…‹', 'è¾“äº†ï¼Œé‡‘é’±-5');
                        changeGold(-5);
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤ç»„ç»‡å›¢å»º - æ‰“å¾·å·æ‰‘å…‹', 'èµ¢äº†ï¼Œé‡‘é’±+5');
                        changeGold(5);
                    }
                }},
                { text: 'ğŸ¤ KTVå”±æ­Œ', class: 'btn-accent', action: () => {
                    addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤ç»„ç»‡å›¢å»º - KTVå”±æ­Œ', 'å”±äº†çŒªçŒªä¾ ä¸»é¢˜æ›²ï¼Œèªæ˜å‹‡æ•¢æœ‰åŠ›æ°”ï¼Œç¤¾äº¤èƒ½åŠ›+1');
                    closeModal();
                    changeSocial(1);
                }},
				{ text: 'ğŸœ èšé¤', class: 'btn-info', action: () => {
					closeModal();
					if (Math.random() < 0.5) {
						addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤ç»„ç»‡å›¢å»º - èšé¤', 'åƒé¥±äº†ï¼Œé‡‘é’±-3ï¼ŒSANå€¼+5');
						gameState.san = Math.min(gameState.sanMax, gameState.san + 5);
						changeGold(-3);
					} else {
						addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤ç»„ç»‡å›¢å»º - èšé¤', 'å¯¼å¸ˆè¯·å®¢ï¼ŒSANå€¼+5');
						changeSan(5);
					}
				}}
            ]);
        }

        function showRandomEvent8() {
            showModal('ğŸ’° éšæœºäº‹ä»¶', '<p>å¯¼å¸ˆç§‘ç ”ç»è´¹å……è¶³ï¼Œä½ å»ºè®®ã€‚</p>', [
                { text: 'ğŸ–¥ï¸ è´­ä¹°GPUæœåŠ¡å™¨', class: 'btn-primary', action: () => {
                    closeModal();
                    if (Math.random() < 0.5) {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆç§‘ç ”ç»è´¹å……è¶³ - è´­ä¹°é«˜æ€§èƒ½GPUæœåŠ¡å™¨', 'å¯¼å¸ˆå¹¶ä¸æƒ³ä¹°');
                    } else {
                        gameState.buffs.permanent.push({ type: 'exp_times', name: 'æ¯æ¬¡åšå®éªŒå¤šåšä¸€æ¬¡', value: 1, permanent: true });
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆç§‘ç ”ç»è´¹å……è¶³ - è´­ä¹°é«˜æ€§èƒ½GPUæœåŠ¡å™¨', 'ä½ åªåˆ†åˆ°äº†ä¸€å¼ æ˜¾å¡ï¼Œä½†æ€»æ¯”æ²¡æœ‰å¥½ï¼Œæ°¸ä¹…buff-æ¯æ¬¡åšå®éªŒå¤šåšä¸€æ¬¡');
                        updateBuffs();
                    }
                    updateAllUI();
                }},
                { text: 'ğŸ’µ å¤šå‘åŠ³åŠ¡è´¹', class: 'btn-warning', action: () => {
                    closeModal();
                    const amount = gameState.favor < 6 ? 2 : gameState.favor < 12 ? 4 : 8;
                    const desc = gameState.favor < 6 ? 'å¯¼å¸ˆåªå‘äº†ä¸€ç‚¹ç‚¹' : gameState.favor < 12 ? 'å¯¼å¸ˆå‘äº†å¾ˆå¤š' : 'å¯¼å¸ˆå…¨ç»™ä½ äº†';
                    gameState.gold += amount;
                    addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆç§‘ç ”ç»è´¹å……è¶³ - å¤šå‘åŠ³åŠ¡è´¹', `${desc}ï¼Œé‡‘é’±+${amount}`);
                    updateAllUI();
                }},
                { text: 'ğŸª‘ è£…ä¿®å­¦ç”Ÿå·¥ä½', class: 'btn-info', action: () => {
                    closeModal();
                    gameState.buffs.permanent.push(
                        { type: 'idea_bonus', name: 'æ¯æ¬¡æƒ³ideaåˆ†æ•°+1', value: 1, permanent: true },
                        { type: 'write_bonus', name: 'æ¯æ¬¡å†™è®ºæ–‡åˆ†æ•°+1', value: 1, permanent: true }
                    );
                    addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆç§‘ç ”ç»è´¹å……è¶³ - è£…ä¿®å­¦ç”Ÿå·¥ä½', 'éå¸¸èˆ’é€‚ï¼Œæ°¸ä¹…buff-æ¯æ¬¡æƒ³ideaåˆ†æ•°+1ï¼Œæ°¸ä¹…buff-æ¯æ¬¡å†™è®ºæ–‡åˆ†æ•°+1');
                    updateAllUI();
                    updateBuffs();
                }}
            ]);
        }

        function showRandomEvent9() {
            showModal('ğŸ“– éšæœºäº‹ä»¶', '<p>ä½ æ‰“ç®—å­¦ç‚¹æ–°çŸ¥è¯†ï¼Œä½ ä¼šé€‰æ‹©ã€‚</p>', [
                { text: 'ğŸ“š åŸºç¡€çŸ¥è¯†', class: 'btn-primary', action: () => {
                    closeModal();
                    if (gameState.research < 4) {
                        addLog('éšæœºäº‹ä»¶', 'å­¦ä¹ æ–°çŸ¥è¯† - åŸºç¡€çŸ¥è¯†', 'æ‰“å¥½äº†åŸºç¡€ï¼Œç§‘ç ”èƒ½åŠ›+1');
                        changeResearch(1);
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'å­¦ä¹ æ–°çŸ¥è¯† - åŸºç¡€çŸ¥è¯†', 'å¯¹ä½ æ²¡æœ‰ä»€ä¹ˆå¸®åŠ©');
                        updateAllUI();
                    }
                }},
                { text: 'ğŸ’» ä»£ç çŸ¥è¯†', class: 'btn-info', action: () => {
                    closeModal();
                    gameState.buffs.permanent.push({ type: 'exp_bonus', name: 'æ¯æ¬¡åšå®éªŒåˆ†æ•°+1', value: 1, permanent: true });
                    addLog('éšæœºäº‹ä»¶', 'å­¦ä¹ æ–°çŸ¥è¯† - ä»£ç çŸ¥è¯†', 'æ°¸ä¹…buff-æ¯æ¬¡åšå®éªŒåˆ†æ•°+1');
                    updateAllUI();
                    updateBuffs();
                }},
                { text: 'ğŸš€ æœ€æ–°æŠ€æœ¯', class: 'btn-warning', action: () => {
                    closeModal();
                    gameState.buffs.permanent.push({ type: 'idea_bonus', name: 'æ¯æ¬¡æƒ³ideaåˆ†æ•°+1', value: 1, permanent: true });
                    addLog('éšæœºäº‹ä»¶', 'å­¦ä¹ æ–°çŸ¥è¯† - æœ€æ–°æŠ€æœ¯', 'æ°¸ä¹…buff-æ¯æ¬¡æƒ³ideaåˆ†æ•°+1');
                    updateAllUI();
                    updateBuffs();
                }},
                { text: 'ğŸ”® æ·±å¥¥çš„çŸ¥è¯†', class: 'btn-accent', action: () => {
                    closeModal();
                    gameState.buffs.permanent.push({ type: 'write_bonus', name: 'æ¯æ¬¡å†™è®ºæ–‡åˆ†æ•°+1', value: 1, permanent: true });
                    addLog('éšæœºäº‹ä»¶', 'å­¦ä¹ æ–°çŸ¥è¯† - çœ‹èµ·æ¥å¾ˆæ·±å¥¥çš„çŸ¥è¯†', 'æ°¸ä¹…buff-æ¯æ¬¡å†™è®ºæ–‡åˆ†æ•°+1');
                    updateAllUI();
                    updateBuffs();
                }}
            ]);
        }

        function showRandomEvent10() {
            showModal('ğŸ¤ éšæœºäº‹ä»¶', '<p>åŒé—¨æ‰¾ä½ åˆä½œè®ºæ–‡ï¼Œä½ ä¼šé€‰æ‹©ã€‚</p>', [
                { text: 'å­¦æœ¯äº¤æµ', class: 'btn-primary', action: () => {
                    closeModal();
                    if (Math.random() < 0.5) {
                        gameState.buffs.temporary.push({ type: 'idea_bonus', name: 'ä¸‹æ¬¡æƒ³ideaåˆ†æ•°Ã—0.5', value: 0.5, multiply: true, permanent: false });
                        addLog('éšæœºäº‹ä»¶', 'åŒé—¨æ‰¾ä½ åˆä½œè®ºæ–‡ - å­¦æœ¯äº¤æµ', 'è¢«åŒé—¨å·èµ°ideaï¼Œä¸´æ—¶buff-ä¸‹æ¬¡æƒ³ideaåˆ†æ•°Ã—0.5');
                    } else {
                        gameState.buffs.temporary.push({ type: 'idea_bonus', name: 'ä¸‹æ¬¡æƒ³ideaåˆ†æ•°+5', value: 5, permanent: false });
                        addLog('éšæœºäº‹ä»¶', 'åŒé—¨æ‰¾ä½ åˆä½œè®ºæ–‡ - å­¦æœ¯äº¤æµ', 'å…±åŒè¿›æ­¥ï¼Œä¸´æ—¶buff-ä¸‹æ¬¡æƒ³ideaåˆ†æ•°+5');
                    }
                    updateAllUI();
                    updateBuffs();
                }},
                { text: 'çº¦å®šäº’æŒ‚è®ºæ–‡', class: 'btn-warning', action: () => {
                    closeModal();
                    if (Math.random() < 0.5) {
                        gameState.buffs.temporary.push({ type: 'citation_multiply', name: 'ä¸‹ä¸€ç¯‡ä¸­ç¨¿è®ºæ–‡å¼•ç”¨æ•°Ã—2', value: 2, permanent: false });
                        addLog('éšæœºäº‹ä»¶', 'åŒé—¨æ‰¾ä½ åˆä½œè®ºæ–‡ - çº¦å®šäº’æŒ‚è®ºæ–‡', 'ä½ ä»¬ä¸€èµ·ä¸­äº†è®ºæ–‡ï¼Œ1å˜æˆ2ï¼Œä¸´æ—¶buff-ä¸‹ä¸€ç¯‡ä¸­ç¨¿çš„è®ºæ–‡å¼•ç”¨æ•°Ã—2');
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'åŒé—¨æ‰¾ä½ åˆä½œè®ºæ–‡ - çº¦å®šäº’æŒ‚è®ºæ–‡', 'åŒé—¨å¤ªèœäº†ï¼Œä¸€ç›´æ²¡ä¸­è®ºæ–‡');
                    }
                    updateAllUI();
                    updateBuffs();
                }},
                { text: 'å©‰æ‹’åˆä½œ', class: 'btn-info', action: () => {
                    addLog('éšæœºäº‹ä»¶', 'åŒé—¨æ‰¾ä½ åˆä½œè®ºæ–‡ - å©‰æ‹’åˆä½œ', 'æ— äº‹å‘ç”Ÿ');
                    closeModal();
                }},
                { text: 'å¼€å±•å…¨é¢åˆä½œ', class: 'btn-success', action: () => {
                    closeModal();
                    if (gameState.social < 6) {
                        gameState.buffs.temporary.push({ type: 'idea_times', name: 'ä¸‹æ¬¡æƒ³ideaå¤šæƒ³1æ¬¡', value: 1, permanent: false });
                        addLog('éšæœºäº‹ä»¶', 'åŒé—¨æ‰¾ä½ åˆä½œè®ºæ–‡ - å¼€å±•å…¨é¢åˆä½œ', 'æˆåŠŸåˆä½œï¼Œä¸´æ—¶buff-ä¸‹æ¬¡æƒ³ideaå¤šæƒ³1æ¬¡');
                    } else {
                        gameState.buffs.temporary.push(
                            { type: 'idea_times', name: 'ä¸‹æ¬¡æƒ³ideaå¤šæƒ³1æ¬¡', value: 1, permanent: false },
                            { type: 'write_times', name: 'ä¸‹æ¬¡å†™è®ºæ–‡å¤šå†™1æ¬¡', value: 1, permanent: false }
                        );
                        addLog('éšæœºäº‹ä»¶', 'åŒé—¨æ‰¾ä½ åˆä½œè®ºæ–‡ - å¼€å±•å…¨é¢åˆä½œ', 'æ·±å…¥åˆä½œï¼Œä¸´æ—¶buff-ä¸‹æ¬¡æƒ³ideaå¤šæƒ³1æ¬¡ï¼Œä¸´æ—¶buff-ä¸‹æ¬¡å†™è®ºæ–‡å¤šå†™1æ¬¡');
                    }
                    updateAllUI();
                    updateBuffs();
                }}
            ]);
        }

        function showRandomEvent11() {
            showModal('ğŸ‘¨â€ğŸ“ éšæœºäº‹ä»¶', '<p>å¸ˆå…„å¸ˆå§æ‰¾ä½ åˆä½œè®ºæ–‡ï¼Œä½ ä¼šé€‰æ‹©ã€‚</p>', [
                { text: 'è§‚æœ›ä¸€ä¸‹', class: 'btn-info', action: () => {
                    addLog('éšæœºäº‹ä»¶', 'å¸ˆå…„å¸ˆå§æ‰¾ä½ åˆä½œè®ºæ–‡ - è§‚æœ›ä¸€ä¸‹', 'å¸ˆå…„å¸ˆå§å…ˆæ‰¾äº†åŒé—¨åˆä½œ');
                    closeModal();
                }},
                { text: 'æµ…æµ…åˆä½œ', class: 'btn-primary', action: () => {
                    closeModal();
                    gameState.buffs.temporary.push({ type: 'idea_bonus', name: 'ä¸‹æ¬¡æƒ³ideaåˆ†æ•°+10', value: 10, permanent: false });
                    addLog('éšæœºäº‹ä»¶', 'å¸ˆå…„å¸ˆå§æ‰¾ä½ åˆä½œè®ºæ–‡ - æµ…æµ…åˆä½œ', 'å¸ˆå…„å¸ˆå§ç»™äº†ä½ ä¸€ä¸ªideaï¼Œä¸´æ—¶buff-ä¸‹æ¬¡æƒ³ideaåˆ†æ•°+10');
                    updateAllUI();
                    updateBuffs();
                }},
                { text: 'æ·±å…¥åˆä½œ', class: 'btn-warning', action: () => {
                    addLog('éšæœºäº‹ä»¶', 'å¸ˆå…„å¸ˆå§æ‰¾ä½ åˆä½œè®ºæ–‡ - æ·±å…¥åˆä½œ', 'é‡åˆ°é è°±çš„å¸ˆå…„å¸ˆå§ï¼Œç§‘ç ”èƒ½åŠ›+1');
                    closeModal();
                    changeResearch(1);
                }},
                { text: 'æ‹œå…¥é—¨ä¸‹', class: 'btn-success', action: () => {
                    closeModal();
                    changeResearch(1);
                    gameState.buffs.permanent.push({ type: 'write_bonus', name: 'æ¯æ¬¡å†™è®ºæ–‡åˆ†æ•°+3', value: 3, permanent: true });
                    addLog('éšæœºäº‹ä»¶', 'å¸ˆå…„å¸ˆå§æ‰¾ä½ åˆä½œè®ºæ–‡ - æ‹œå…¥é—¨ä¸‹', 'ä½ æ”¶è·äº†ç¬¬äºŒå¯¼å¸ˆï¼Œç§‘ç ”èƒ½åŠ›+1ï¼Œæ°¸ä¹…buff-æ¯æ¬¡å†™è®ºæ–‡åˆ†æ•°+3');
                    updateAllUI();
                    updateBuffs();
                }}
            ]);
        }

        function showRandomEvent12() {
            showModal('âš ï¸ éšæœºäº‹ä»¶', '<p>å¯¼å¸ˆæƒ³è¦æŠ¢ä½ è®ºæ–‡çš„ä¸€ä½œã€‚</p>', [
                { text: 'å‘å¯¼å¸ˆè¯‰è‹¦', class: 'btn-primary', action: () => {
                    closeModal();
                    if (gameState.favor >= 6) {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæƒ³è¦æŠ¢ä½ è®ºæ–‡çš„ä¸€ä½œ - å‘å¯¼å¸ˆè¯‰è‹¦', 'å¯¼å¸ˆå¿ƒè½¯äº†');
                        updateAllUI();
                    } else {
                        gameState.buffs.temporary.push({ type: 'idea_bonus', name: 'ä¸‹æ¬¡æƒ³ideaåˆ†æ•°-3', value: -3, permanent: false });
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæƒ³è¦æŠ¢ä½ è®ºæ–‡çš„ä¸€ä½œ - å‘å¯¼å¸ˆè¯‰è‹¦', 'å¯¼å¸ˆä¸è¦ä¸€ä½œäº†ï¼Œä½†ä¹Ÿå‡å°‘äº†æŒ‡å¯¼ï¼Œä¸´æ—¶debuff-ä¸‹æ¬¡æƒ³ideaåˆ†æ•°-3');
                        updateAllUI();
                        updateBuffs();
                    }
                }},
                { text: 'åŠè¯´å¯¼å¸ˆæŠ¢å¸ˆå¼Ÿå¸ˆå¦¹ä¸€ä½œ', class: 'btn-warning', action: () => {
                    closeModal();
                    if (gameState.character === 'teacher-child' || (gameState.isReversed && gameState.character === 'teacher-child')) {
                        const title = generatePaperTitle();
                        gameState.publishedPapers.push({
                            title: title,
                            grade: 'C',
                            acceptType: 'Poster',
                            score: 1,
                            citations: 0,
                            monthsSincePublish: 0,
                            promotions: { arxiv: false, github: false, xiaohongshu: false, quantumbit: false },
                            citationMultiplier: 1
                        });
                        gameState.paperC++;
                        gameState.totalScore += 1;
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæƒ³è¦æŠ¢ä½ è®ºæ–‡çš„ä¸€ä½œ - åŠè¯´å¯¼å¸ˆæŠ¢å¸ˆå¼Ÿå¸ˆå¦¹ä¸€ä½œ', 'å¯¼å¸ˆæŠ¢æ¥å¹¶ç»™äº†ä½ ä¸€ç¯‡Cç±»è®ºæ–‡');
                    } else {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæƒ³è¦æŠ¢ä½ è®ºæ–‡çš„ä¸€ä½œ - åŠè¯´å¯¼å¸ˆæŠ¢å¸ˆå¼Ÿå¸ˆå¦¹ä¸€ä½œ', 'å¸ˆå¼Ÿå¸ˆå¦¹å¯¹ä½ ç•¥æœ‰ä¸æ»¡ï¼Œç¤¾äº¤èƒ½åŠ›-1');
                        changeSocial(-1);
                    }
                    updateAllUI();
                }},
                { text: 'æ®ç†åŠ›äº‰', class: 'btn-info', action: () => {
                    closeModal();
                    if (gameState.favor >= 6) {
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæƒ³è¦æŠ¢ä½ è®ºæ–‡çš„ä¸€ä½œ - æ®ç†åŠ›äº‰', 'å¯¼å¸ˆè½»æ¾è¢«ä½ è¯´æœ');
                        updateAllUI();
                    } else {
                        const baseSanCost = -2;
                        const actualSanCost = getActualSanChange(baseSanCost);
                        const sanText = actualSanCost !== baseSanCost ? `SANå€¼${actualSanCost}ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰` : `SANå€¼${actualSanCost}`;
                        addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæƒ³è¦æŠ¢ä½ è®ºæ–‡çš„ä¸€ä½œ - æ®ç†åŠ›äº‰', `å¯¼å¸ˆè‰°éš¾è¢«ä½ è¯´æœï¼Œ${sanText}`);
                        changeSan(baseSanCost);
                    }
                }},
                { text: 'ä»¥æ­»ç›¸é€¼', class: 'btn-danger', action: () => {
                    addLog('éšæœºäº‹ä»¶', 'å¯¼å¸ˆæƒ³è¦æŠ¢ä½ è®ºæ–‡çš„ä¸€ä½œ - ä»¥æ­»ç›¸é€¼', 'å¯¼å¸ˆå¯¹ä½ ç•¥æœ‰ä¸æ»¡ï¼Œå¯¼å¸ˆå¥½æ„Ÿåº¦-1');
                    closeModal();
                    changeFavor(-1);
                }}
            ]);
        }

        function showRandomEvent13() {
            showModal('ğŸ’» éšæœºäº‹ä»¶', '<p>å®éªŒå®¤æœåŠ¡å™¨çªç„¶åäº†ã€‚</p>', [
                { text: 'å‚¬å¯¼å¸ˆå¿«ä¿®', class: 'btn-primary', action: () => {
                    closeModal();
                    gameState.buffs.permanent.push({ type: 'exp_bonus', name: 'æ¯æ¬¡åšå®éªŒåˆ†æ•°-2', value: -2, permanent: true });
                    addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤æœåŠ¡å™¨çªç„¶åäº† - å‚¬å¯¼å¸ˆå¿«ä¿®', 'å¯¼å¸ˆæ¯æ¬¡åäº†å°±å¸®ä½ é‡å¯ï¼Œæ°¸ä¹…debuff-æ¯æ¬¡åšå®éªŒåˆ†æ•°-2');
                    updateAllUI();
                    updateBuffs();
                }},
                { text: 'ä¸¾æŠ¥åŒé—¨æŒ–çŸ¿', class: 'btn-warning', action: () => {
                    addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤æœåŠ¡å™¨çªç„¶åäº† - ä¸¾æŠ¥åŒé—¨ç”¨æœåŠ¡å™¨æŒ–çŸ¿', 'åŒé—¨è´Ÿè´£ä¿®å¥½äº†ï¼Œç¤¾äº¤èƒ½åŠ›-2');
                    closeModal();
                    changeSocial(-2);
                }},
                { text: 'è‡ªå·±é‡è£…ç³»ç»Ÿ', class: 'btn-info', action: () => {
                    closeModal();
                    const baseSanCost = -3;
                    const actualSanCost = getActualSanChange(baseSanCost);
                    const sanText = actualSanCost !== baseSanCost ? `SANå€¼${actualSanCost}ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰` : `SANå€¼${actualSanCost}`;
                    
                    if (Math.random() < 0.5) {
                        addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤æœåŠ¡å™¨çªç„¶åäº† - è‡ªå·±å°è¯•é‡è£…ç³»ç»Ÿ', `è´¹åŠ²å‘¨æŠ˜ä¿®å¥½äº†ï¼Œ${sanText}`);
                    } else {
                        changeSocial(-1);
                        gameState.buffs.temporary.push({ type: 'exp_bonus', name: 'ä¸‹æ¬¡å®éªŒåˆ†æ•°Ã—0', value: 0, multiply: true, permanent: false });
                        addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤æœåŠ¡å™¨çªç„¶åäº† - è‡ªå·±å°è¯•é‡è£…ç³»ç»Ÿ', `æœåŠ¡å™¨æ•°æ®å¿˜äº†å¤‡ä»½äº†ï¼Œä¸´æ—¶debuff-ä¸‹æ¬¡å®éªŒåˆ†æ•°Ã—0ï¼Œç¤¾äº¤èƒ½åŠ›-1ï¼Œ${sanText}`);
                        updateBuffs();
                    }
                    changeSan(baseSanCost);
                }},
                { text: 'æ·˜å®æ‰¾äººä¿®ç†', class: 'btn-danger', action: () => {
                    closeModal();
                    if (Math.random() < 0.5) {
                        addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤æœåŠ¡å™¨çªç„¶åäº† - æ·˜å®æ‰¾äººä¿®ç†', 'é‡åˆ°é«˜æ‰‹ä¿®å¥½äº†ï¼Œé‡‘å¸-2');
                        changeGold(-2);
                    } else {
                        const baseSanCost = -2;
                        const actualSanCost = getActualSanChange(baseSanCost);
                        const sanText = actualSanCost !== baseSanCost ? `SANå€¼${actualSanCost}ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰` : `SANå€¼${actualSanCost}`;
                        addLog('éšæœºäº‹ä»¶', 'å®éªŒå®¤æœåŠ¡å™¨çªç„¶åäº† - æ·˜å®æ‰¾äººä¿®ç†', `é‡åˆ°æ— è‰¯å•†å®¶ä¿®äº†å¾ˆä¹…ï¼Œé‡‘å¸-4ï¼Œ${sanText}`);
                        gameState.san += actualSanCost;
                        changeGold(-4);
                    }
                }}
            ]);
        }

        function showRandomEvent14() {
            const baseSanCost = 1;
            const actualSanCost = Math.abs(getActualSanChange(-baseSanCost));
            const sanDescText = actualSanCost !== baseSanCost 
                ? `æ¯æœˆSAN-${actualSanCost}ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰` 
                : `æ¯æœˆSAN-${baseSanCost}`;
            
            showModal('ğŸ‘¨â€ğŸ“ éšæœºäº‹ä»¶', '<p>ä½ å·²ç»åˆçª¥ç§‘ç ”é—¨é“äº†ï¼Œè€ƒè™‘æŒ‡å¯¼å¸ˆå¼Ÿå¸ˆå¦¹ï¼š</p>', [
                { text: 'ç²¾åŠ›æœ‰é™ç®—äº†', class: 'btn-info', action: () => {
                    addLog('éšæœºäº‹ä»¶', 'æŒ‡å¯¼å¸ˆå¼Ÿå¸ˆå¦¹ - ç²¾åŠ›æœ‰é™ç®—äº†', 'æ— äº‹å‘ç”Ÿ');
                    closeModal();
                }},
                { text: 'æœ€è¿‘æœ‰ä¸ªideaå¯ä»¥åˆä½œä¸€æ³¢', class: 'btn-primary', action: () => {
                    const baseCost = 5;
                    const actualCost = Math.abs(getActualSanChange(-baseCost));
                    
                    if (gameState.san < actualCost) {
                        const tipText = actualCost !== baseCost 
                            ? `<p>SANå€¼ä¸è¶³ï¼åŸºç¡€æ¶ˆè€—${baseCost}ç‚¹ï¼Œæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}åéœ€è¦${actualCost}ç‚¹SANå€¼ã€‚</p>` 
                            : `<p>SANå€¼ä¸è¶³ï¼éœ€è¦è‡³å°‘${baseCost}ç‚¹SANå€¼ã€‚</p>`;
                        showModal('âŒ æ“ä½œå¤±è´¥', tipText, 
                            [{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
                        return;
                    }
                    
                    let sanText = `SAN-${actualCost}`;
                    if (actualCost !== baseCost) {
                        sanText += `ï¼ˆæ€ æƒ°Ã—${gameState.reversedAwakened ? 3 : 2}ï¼‰`;
                    }
                    addLog('éšæœºäº‹ä»¶', 'æŒ‡å¯¼å¸ˆå¼Ÿå¸ˆå¦¹ - åˆä½œä¸€ä¸ªidea', `${sanText}ï¼Œç¤¾äº¤+1`);
                    closeModal();
                    changeSan(-baseCost);
                    changeSocial(1);
                }},
                { text: 'å±•å¼€é•¿æœŸåˆä½œ', class: 'btn-success', action: () => {
                    gameState.buffs.permanent.push({
                        type: 'mentorship',
                        name: 'æŒ‡å¯¼å¸ˆå¼Ÿå¸ˆå¦¹',
                        desc: `${sanDescText}ï¼Œæ€»å¼•ç”¨+ç§‘ç ”èƒ½åŠ›å€¼`,
                        permanent: true
                    });
                    addLog('éšæœºäº‹ä»¶', 'æŒ‡å¯¼å¸ˆå¼Ÿå¸ˆå¦¹ - å±•å¼€é•¿æœŸåˆä½œ', `${sanDescText}ï¼Œæ€»å¼•ç”¨+ç§‘ç ”èƒ½åŠ›å€¼`);
                    closeModal();
                    updateBuffs();
                }}
            ]);
        }

        // ==================== æ¸¸æˆç»“å±€ ====================
        function triggerEnding(type) {
            let title, desc, emoji;
            let endingType = type;
            
            switch (type) {
                case 'burnout': title = 'ä¸å ªé‡è´Ÿ'; desc = 'ç¹é‡çš„ç§‘ç ”å‹åŠ›å‹å®äº†ä½ ï¼Œä½ æœ€ç»ˆé€‰æ‹©äº†ç¦»å¼€...'; emoji = 'ğŸ˜¢'; break;
                case 'expelled': title = 'è¢«é€€å­¦'; desc = 'å¯¼å¸ˆå¯¹ä½ å½»åº•å¤±æœ›ï¼Œä½ è¢«åŠé€€äº†...'; emoji = 'ğŸ˜­'; break;
                case 'poor': title = 'ç©·å›°æ½¦å€’'; desc = 'ä½ è¿é¥­éƒ½åƒä¸èµ·äº†ï¼Œåªèƒ½å«æ¨ç¦»å¼€...'; emoji = 'ğŸ’¸'; break;
                case 'delay': title = 'å»¶æ¯•'; desc = 'ä½ æ²¡èƒ½åœ¨è§„å®šæ—¶é—´å†…å®Œæˆæ¯•ä¸šè¦æ±‚ï¼Œåªèƒ½å»¶æœŸæ¯•ä¸š...'; emoji = 'â°'; break;
                case 'quit': title = 'ä¸»åŠ¨é€€å­¦'; desc = 'ä½ å†³å®šæ”¾å¼ƒå­¦ä¸šï¼Œå¼€å¯äººç”Ÿæ–°ç¯‡ç« ...ä¹Ÿè®¸è¿™ä¹Ÿæ˜¯ä¸€ç§å‹‡æ°”ã€‚'; emoji = 'ğŸšª'; break;
                case 'master':
                    if (gameState.totalScore >= 4) { 
                        title = 'ä¼˜ç§€ç¡•å£«æ¯•ä¸š'; 
                        desc = 'æ­å–œï¼ä½ ä»¥ä¼˜å¼‚çš„æˆç»©å®Œæˆäº†ç¡•å£«å­¦ä¸šï¼Œæœªæ¥å¯æœŸï¼'; 
                        emoji = 'ğŸŒŸ'; 
                        endingType = 'excellent_master';
                    } else { 
                        title = 'ç¡•å£«æ¯•ä¸š'; 
                        desc = 'æ­å–œï¼ä½ é¡ºåˆ©å®Œæˆäº†ç¡•å£«å­¦ä¸šï¼'; 
                        emoji = 'ğŸ“'; 
                    }
                    break;
                case 'phd':
                    const e = getPhDEndingType();
                    title = e.title; desc = e.desc; emoji = e.emoji;
                    endingType = e.type;
                    break;
            }
            
            recordEnding(endingType, title);
            
            const achievements = collectAchievements(endingType);
            recordAchievements(achievements);
            
            showEndingModal(title, desc, emoji, endingType);
        }

        function getPhDEndingType() {
            const { paperA, totalCitations, bigBullCooperation } = gameState;
            if (paperA >= 5 && totalCitations > 2000 && bigBullCooperation) 
                return { type: 'future_academician', title: 'æœªæ¥é™¢å£«', desc: 'ä½ çš„å­¦æœ¯æˆå°±ä»¤äººç©ç›®ï¼ŒæˆåŠŸå»å¤§ç‰›ç»„å½“å‰¯æ•™æˆï¼', emoji: 'ğŸ‘‘' };
            if (paperA >= 5 && totalCitations > 1000 && bigBullCooperation) 
                return { type: 'academic_star', title: 'å­¦æœ¯ä¹‹æ˜Ÿ', desc: 'ä½ çš„æ‰åè¢«å¤§ç‰›èµè¯†ï¼ŒæˆåŠŸå»å¤§ç‰›ç»„é£å‡ç–¾èµ°ï¼', emoji: 'â­' };
            if (paperA >= 5 && totalCitations > 1000) 
                return { type: 'become_advisor', title: 'æˆ‘å°±æ˜¯å¯¼å¸ˆ', desc: 'æ­å–œï¼ä½ æˆåŠŸç•™æ ¡æˆä¸ºå‰¯æ•™æˆï¼', emoji: 'ğŸ‘¨â€ğŸ«' };
            if (paperA >= 4 && totalCitations > 500) 
                return { type: 'green_pepper', title: 'é’æ¤’', desc: 'æ­å–œï¼ä½ æˆåŠŸç•™æ ¡é£å‡ç–¾èµ°ï¼', emoji: 'ğŸŒ¶ï¸' };
            if (paperA >= 3) 
                return { type: 'excellent_phd', title: 'ä¼˜ç§€åšå£«æ¯•ä¸š', desc: 'æ­å–œï¼ä½ ä»¥ä¼˜å¼‚çš„æˆç»©å®Œæˆäº†åšå£«å­¦ä¸šï¼', emoji: 'ğŸ†' };
            return { type: 'phd', title: 'åšå£«æ¯•ä¸š', desc: 'æ­å–œï¼ä½ é¡ºåˆ©å®Œæˆäº†åšå£«å­¦ä¸šï¼', emoji: 'ğŸ“' };
        }

        function collectAchievements(endingType) {
            const a = [];
            if (gameState.hasLover) a.push('ğŸ’• å–œç»“è‰¯ç¼˜');
            if (gameState.gold > 30) a.push('ğŸ’° å®¶è´¢ä¸‡è´¯');
            if (gameState.research > 12 && gameState.social > 12 && gameState.favor > 12 && gameState.gold > 12) a.push('â¬¡ å…­è¾¹å½¢æˆ˜å£«');
            if (gameState.research >= 20) a.push('ğŸ† è¯ºå¥–é€‰æ‰‹');
            if (gameState.social >= 20) a.push('ğŸŒ¸ äº¤é™…èŠ±');
            if (gameState.favor >= 20) a.push('ğŸ¤ é“æ†å¸ˆç”Ÿ');
            if (gameState.san >= 20) a.push('âš¡ ç²¾åŠ›æ»¡æ»¡');
            if (gameState.rejectedCount === 0 && gameState.publishedPapers.length > 0) a.push('ğŸ¯ ç™¾å‘ç™¾ä¸­');
            if (gameState.teaBreakCount >= 3) a.push('â˜• æˆ‘çˆ±èŒ¶æ­‡');
            if (gameState.tourCount >= 3) a.push('ğŸ–ï¸ å…¬è´¹æ—…æ¸¸');
            if (gameState.publishedPapers.length >= 10) a.push('ğŸ¤– è®ºæ–‡æœºå™¨');
            if (gameState.totalCitations >= 1000) a.push('ğŸ“š åƒå¼•å¤§ä½¬');
            const graduationEndings = ['master', 'excellent_master', 'phd', 'excellent_phd', 'green_pepper', 'become_advisor', 'academic_star', 'future_academician'];
            if (graduationEndings.includes(endingType) && gameState.coffeeBoughtCount >= gameState.totalMonths && gameState.totalMonths > 0) {
                a.push('â˜• å’–å•¡çˆ±å¥½è€…');
            }
            if (gameState.triggeredBuffTypes && ALL_BUFF_TYPES.every(type => gameState.triggeredBuffTypes.includes(type))) {
                a.push('âœ¨ Buffä¹‹ç¥');
            }
            
            if (gameState.achievementConditions && gameState.achievementConditions.highScorePaper) a.push('ğŸ“œ é«˜åˆ†è®ºæ–‡');
            if (gameState.achievementConditions && gameState.achievementConditions.unanimousImprovement) a.push('ğŸ€ å¹¸è¿å„¿');
            if (gameState.achievementConditions && gameState.achievementConditions.allBadReviewers) a.push('ğŸ˜­ å€’éœ‰è›‹');
            if (gameState.paperA > 0 && gameState.paperB === 0 && gameState.paperC === 0) a.push('ğŸ» æ›²é«˜å’Œå¯¡');
            if (gameState.san === 0 && gameState.gold === 0) a.push('ğŸ’ª å…¨åŠ›ä»¥èµ´');
            
            const requiredTypes = [
                'A-Poster', 'A-Oral', 'A-Best Paper',
                'B-Poster', 'B-Oral', 'B-Best Paper',
                'C-Poster', 'C-Oral', 'C-Best Paper'
            ];
            if (gameState.paperTypeCollection && requiredTypes.every(type => gameState.paperTypeCollection.has(type))) {
                a.push('ğŸ† å…¨æ”¶é›†');
            }
            
            if (gameState.rejectedCount >= 5) a.push('ğŸ‘Š è¶Šæˆ˜è¶Šå‹‡');
            if (gameState.achievementConditions && gameState.achievementConditions.rejectedPhdTwice) a.push('ğŸ§  äººé—´æ¸…é†’');
            if (gameState.maxConcurrentReviews >= 4) a.push('ğŸ”¥ ç«åŠ›å…¨å¼€');
            if (gameState.achievementConditions && gameState.achievementConditions.tripleRejected) a.push('ğŸš é£Ÿä¹‹æ— å‘³');
            if (gameState.achievementConditions && gameState.achievementConditions.bought5GPUs) a.push('ğŸ¤– æœºæ¢°é£å‡');
            if (gameState.achievementConditions && gameState.achievementConditions.fullFurnitureSet) a.push('ğŸ›‹ï¸ å…¨å¥—å®¶å…·');
            if (gameState.achievementConditions && gameState.achievementConditions.phdRequirementMetEarly) a.push('ğŸ§’ å¤©æ‰å°‘å¹´');
            
            return a;
        }

		function showEndingModal(title, desc, emoji, endingType) {
			currentEndingData = { title, desc, emoji, endingType };

			const achievements = collectAchievements(endingType);
			const locked = ALL_ACHIEVEMENTS.filter(x => !achievements.includes(x));
			
			const modeLabel = gameState.isReversed 
				? '<span style="color:#9b59b6;font-size:0.8rem;">ğŸŒ‘ é€†ä½æ¨¡å¼</span>' 
				: '<span style="color:#6c5ce7;font-size:0.8rem;">â˜€ï¸ æ­£ä½æ¨¡å¼</span>';

			const failedEndings = ['quit', 'burnout', 'expelled', 'poor', 'delay'];
			const successEndings = ['master', 'excellent_master', 'phd', 'excellent_phd', 'green_pepper', 'become_advisor', 'academic_star', 'future_academician'];
			const isFailed = failedEndings.includes(endingType);
			const isSuccess = successEndings.includes(endingType);

			let html = `<div style="text-align:center;margin-bottom:15px;">
				<div style="font-size:3rem;margin-bottom:10px;">${emoji}</div>
				<div style="font-size:1.3rem;font-weight:700;color:var(--primary-color);margin-bottom:8px;">${title}</div>
				${modeLabel}
				<div style="color:var(--text-secondary);line-height:1.5;font-size:0.9rem;margin-top:8px;">${desc}</div>
			</div>`;
			
			if (isFailed) {
				html += `
				<div style="background:linear-gradient(135deg,rgba(253,121,168,0.15),rgba(108,92,231,0.15));border-radius:12px;padding:12px;margin-bottom:12px;text-align:center;">
					<div style="font-size:0.9rem;margin-bottom:8px;">ğŸ’ª ä¸è¦ç°å¿ƒï¼ç§‘ç ”ä¹‹è·¯æ¼«æ¼«ï¼Œæ¥æ—¥æ–¹é•¿~</div>
					<a href="http://xhslink.com/o/8czcPQfNziK" target="_blank" 
					   style="display:inline-block;padding:8px 16px;background:linear-gradient(135deg,var(--accent-color),var(--primary-color));color:white;text-decoration:none;border-radius:20px;font-size:0.85rem;font-weight:500;transition:all 0.3s ease;"
					   onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(253,121,168,0.4)'"
					   onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none'">
						<i class="fas fa-palette"></i> ä½œè€…å‘ä½ ä¼ æˆç§‘ç ”ç»˜å›¾å¿ƒå¾—
					</a>
				</div>`;
			}
			
			if (isSuccess) {
				html += `
				<div style="background:linear-gradient(135deg,rgba(0,184,148,0.15),rgba(108,92,231,0.15));border-radius:12px;padding:12px;margin-bottom:12px;text-align:center;">
					<div style="font-size:0.9rem;margin-bottom:8px;">ğŸ‰ æ­å–œæ¯•ä¸šï¼æ–°çš„å¾ç¨‹å³å°†å¼€å§‹~</div>
					  <a href="http://xhslink.com/o/AC6pvxkgOhv" target="_blank" 
						 style="display:inline-block;padding:8px 16px;background:linear-gradient(135deg,var(--success-color),var(--primary-color));color:white;text-decoration:none;border-radius:20px;font-size:0.85rem;font-weight:500;transition:all 0.3s ease;"
						 onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(0,184,148,0.4)'"
						 onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none'">
						<i class="fas fa-building"></i> ä½œè€…è¯šé‚€ä½ æ¥ä¸Šæµ·AI Labå®ä¹ 
					  </a>
				</div>`;
			}
			
			// â˜…â˜…â˜… æ–°å¢ï¼šé‡å¼€æŒ‰é’®æ”¾åœ¨ç”Ÿæ¶¯æ€»ç»“ä¸Šæ–¹ â˜…â˜…â˜…
			html += `
			<div style="text-align:center;margin-bottom:12px;">
				<button class="btn btn-primary" onclick="restartGame()" style="padding:10px 30px;font-size:1rem;">
					<i class="fas fa-redo"></i> ğŸ”„ æˆ‘è¦é‡å¼€
				</button>
			</div>`;
			
			html += `<div style="background:var(--light-bg);border-radius:12px;padding:15px;margin-bottom:12px;">
				<div style="font-weight:600;margin-bottom:10px;color:var(--primary-color);font-size:0.9rem;"><i class="fas fa-scroll"></i> ç”Ÿæ¶¯æ€»ç»“</div>
				<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:6px;font-size:0.8rem;">
					<div>ğŸ‘¤ è§’è‰²ï¼š${gameState.characterName}</div>
					<div>ğŸ“… å†æ—¶ï¼š${gameState.totalMonths}ä¸ªæœˆ</div>
					<div>ğŸ“Š ç§‘ç ”åˆ†ï¼š${gameState.totalScore}</div>
					<div>ğŸ“ è®ºæ–‡æ•°ï¼š${gameState.publishedPapers.length}</div>
					<div>ğŸ…°ï¸ Aç±»ï¼š${gameState.paperA} ğŸ…±ï¸ Bç±»ï¼š${gameState.paperB}</div>
					<div>Â©ï¸ Cç±»ï¼š${gameState.paperC} ğŸ“ˆ å¼•ç”¨ï¼š${gameState.totalCitations}</div>
					<div>ğŸ§  ç§‘ç ”ï¼š${gameState.research} ğŸ‘¥ ç¤¾äº¤ï¼š${gameState.social}</div>
					<div>â¤ï¸ å¥½æ„Ÿï¼š${gameState.favor} ğŸ’° é‡‘å¸ï¼š${gameState.gold}</div>
				</div>
			</div>`;

			if (achievements.length > 0) {
				html += `
					<div class="achievements-container" 
						 style="margin: 15px 0; background: ${gameState.isReversed ? 'rgba(93, 44, 111, 0.3)' : 'rgba(253, 203, 110, 0.1)'}; 
								border-radius: 12px; 
								padding: 12px;
								border: 1px solid ${gameState.isReversed ? '#8e44ad' : '#fdcb6e'};">
						<div style="font-weight: 600; 
								   margin-bottom: 8px; 
								   color: ${gameState.isReversed ? '#d7bde2' : '#d68910'};">
							<i class="fas fa-trophy"></i> è¾¾æˆæˆå°± (${achievements.length})
						</div>
						<div style="display: flex; flex-wrap: wrap; gap: 6px;">
							${achievements.map(a => `
								<span class="achievement-item" onclick="showSingleAchievementRequirement('${a}')">
									${a}
								</span>
							`).join('')}
						</div>
					</div>`;
			}

			if (locked.length > 0) {
				html += `
					<div style="background: var(--light-bg); border-radius: 12px; padding: 12px; margin-bottom: 10px;">
						<div style="font-weight: 600; margin-bottom: 8px; color: var(--text-secondary); font-size: 0.85rem; display: flex; align-items: center; justify-content: space-between;">
							<span><i class="fas fa-lock"></i> æœªè§£é”æˆå°±</span>
							<span style="font-size: 0.7rem; cursor: pointer;" onclick="showAchievementRequirements()">
								<i class="fas fa-question-circle"></i> æŸ¥çœ‹è¦æ±‚
							</span>
						</div>
						<div style="display: flex; flex-wrap: wrap; gap: 6px;">
							${locked.map(a => `
								<span class="locked-achievement-tag" onclick="showSingleAchievementRequirement('${a}')">
									${a}
								</span>
							`).join('')}
						</div>
					</div>`;
			}

			html += `<div style="background:linear-gradient(135deg,rgba(108,92,231,0.1),rgba(162,155,254,0.1));border-radius:12px;padding:12px;margin-bottom:10px;cursor:pointer;" onclick="showEndingStatistics()">
				<div style="font-weight:600;margin-bottom:8px;color:var(--primary-color);font-size:0.85rem;display:flex;align-items:center;justify-content:space-between;">
					<span><i class="fas fa-globe"></i> å…¨çƒç»Ÿè®¡</span>
					<span style="font-size:0.7rem;color:var(--text-secondary);">
						<i class="fas fa-chevron-right"></i> ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…
					</span>
				</div>
				<div style="font-size:0.8rem;color:var(--text-secondary);">
					æŸ¥çœ‹æ‰€æœ‰ç»“å±€å’Œæˆå°±çš„å…¨çƒè¾¾æˆç»Ÿè®¡
				</div>
			</div>`;

			// â˜…â˜…â˜… ä¿®æ”¹ï¼šåº•éƒ¨ä¸å†ä¼ å…¥æŒ‰é’®ï¼Œæ”¹ä¸ºç©ºæ•°ç»„ â˜…â˜…â˜…
			showModal('ğŸ® æ¸¸æˆç»“æŸ', html, []);
		}
        
        function showSingleAchievementRequirement(name) {
            const req = ACHIEVEMENT_REQUIREMENTS[name];
            if (!req) return;
            
            const achieved = collectAchievements(null).includes(name);
            
            showModal('ğŸ† æˆå°±è¦æ±‚', `
                <div style="text-align:center;margin-bottom:15px;">
                    <div style="font-size:2rem;margin-bottom:10px;">${name.split(' ')[0]}</div>
                    <div style="font-size:1.1rem;font-weight:600;">${name}</div>
                    ${achieved ? '<div style="color:var(--success-color);margin-top:5px;">âœ“ å·²è¾¾æˆ</div>' : ''}
                </div>
                <div style="background:var(--light-bg);border-radius:10px;padding:15px;">
                    <div style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:5px;">è¾¾æˆæ¡ä»¶ï¼š</div>
                    <div style="font-size:0.9rem;">${req}</div>
                </div>
            `, [{ 
                text: currentEndingData ? 'è¿”å›ç»“å±€' : 'å…³é—­', 
                class: 'btn-primary', 
                action: () => {
                    closeModal();
                    if (currentEndingData) {
                        setTimeout(() => {
                            showEndingModal(currentEndingData.title, currentEndingData.desc, currentEndingData.emoji, currentEndingData.endingType);
                        }, 100);
                    }
                }
            }]);
        }

        async function showEndingStatistics() {
            showModal('ğŸ“Š å…¨çƒç»Ÿè®¡', '<div style="text-align:center;padding:20px;"><i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...</div>', []);
            
            const stats = await getGlobalStats();
            
            if (!stats) {
                showModal('ğŸ“Š å…¨çƒç»Ÿè®¡', '<p style="text-align:center;color:var(--text-secondary);">æš‚æ— ç»Ÿè®¡æ•°æ®</p>', 
                    [{ 
                        text: currentEndingData ? 'è¿”å›ç»“å±€' : 'å…³é—­', 
                        class: 'btn-primary', 
                        action: () => {
                            closeModal();
                            if (currentEndingData) {
                                setTimeout(() => {
                                    showEndingModal(currentEndingData.title, currentEndingData.desc, currentEndingData.emoji, currentEndingData.endingType);
                                }, 100);
                            }
                        }
                    }]);
                return;
            }
            
            const mode = gameState.isReversed ? 'reversed' : 'normal';
            const modeStats = stats[mode];
            const modeIcon = gameState.isReversed ? 'ğŸŒ‘' : 'â˜€ï¸';
            const modeName = gameState.isReversed ? 'é€†ä½' : 'æ­£ä½';
            
            let totalEndings = 0;
            for (const count of Object.values(modeStats.endings)) {
                totalEndings += count;
            }
            
            let html = `
                <div style="margin-bottom:15px;text-align:center;">
                    <span style="font-size:0.9rem;color:var(--primary-color);font-weight:600;">${modeIcon} ${modeName}æ¨¡å¼ç»Ÿè®¡</span>
                    <span style="font-size:0.75rem;color:var(--text-secondary);margin-left:10px;">å…± ${totalEndings} å±€æ¸¸æˆ</span>
                </div>
                
                <div style="margin-bottom:15px;">
                    <div style="font-weight:600;font-size:0.85rem;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
                        <span>ğŸ“œ ç»“å±€ç»Ÿè®¡</span>
                        <span style="font-size:0.7rem;color:var(--text-secondary);cursor:pointer;" onclick="showEndingRequirements()">
                            <i class="fas fa-question-circle"></i> æŸ¥çœ‹è¦æ±‚
                        </span>
                    </div>
                    <div style="display:flex;flex-direction:column;gap:6px;max-height:180px;overflow-y:auto;">
            `;
            
            for (const [type, name] of Object.entries(ENDING_NAMES)) {
                const count = modeStats.endings[type] || 0;
                const percent = totalEndings > 0 ? ((count / totalEndings) * 100).toFixed(1) : 0;
                const barWidth = totalEndings > 0 ? (count / totalEndings) * 100 : 0;
                
                html += `
                    <div style="padding:6px 8px;background:var(--light-bg);border-radius:6px;cursor:pointer;" onclick="showSingleEndingRequirement('${type}')">
                        <div style="display:flex;justify-content:space-between;font-size:0.8rem;margin-bottom:3px;">
                            <span>${name}</span>
                            <span style="color:var(--primary-color);font-weight:600;">${count} <span style="color:var(--text-secondary);font-weight:400;">(${percent}%)</span></span>
                        </div>
                        <div style="height:4px;background:var(--border-color);border-radius:2px;overflow:hidden;">
                            <div style="width:${barWidth}%;height:100%;background:var(--primary-color);border-radius:2px;"></div>
                        </div>
                    </div>
                `;
            }
            
            html += `</div></div>
                
                <div>
                    <div style="font-weight:600;font-size:0.85rem;margin-bottom:8px;">ğŸ† æˆå°±ç»Ÿè®¡</div>
                    <div style="display:flex;flex-wrap:wrap;gap:6px;max-height:120px;overflow-y:auto;">
            `;
            
            for (const ach of ALL_ACHIEVEMENTS) {
                const count = modeStats.achievements[ach] || 0;
                const opacity = count > 0 ? '1' : '0.5';
                html += `
                    <div style="padding:4px 8px;background:var(--light-bg);border-radius:6px;font-size:0.7rem;opacity:${opacity};cursor:pointer;" onclick="showSingleAchievementRequirement('${ach}')">
                        ${ach} <strong style="color:var(--success-color);">${count}</strong>
                    </div>
                `;
            }
            
            html += '</div></div>';
            
            showModal('ğŸ“Š å…¨çƒç»Ÿè®¡', html, [{ 
                text: currentEndingData ? 'è¿”å›ç»“å±€' : 'å…³é—­', 
                class: 'btn-primary', 
                action: () => {
                    closeModal();
                    if (currentEndingData) {
                        setTimeout(() => {
                            showEndingModal(currentEndingData.title, currentEndingData.desc, currentEndingData.emoji, currentEndingData.endingType);
                        }, 100);
                    }
                }
            }]);
        }

        function showEndingRequirements() {
            let html = '<div style="max-height:60vh;overflow-y:auto;">';
            
            for (const [type, name] of Object.entries(ENDING_NAMES)) {
                const req = ENDING_REQUIREMENTS[type] || 'æœªçŸ¥';
                html += `
                    <div style="padding:10px;background:var(--light-bg);border-radius:8px;margin-bottom:8px;">
                        <div style="font-weight:600;font-size:0.85rem;margin-bottom:4px;">${name}</div>
                        <div style="font-size:0.75rem;color:var(--text-secondary);">${req}</div>
                    </div>
                `;
            }
            html += '</div>';
            
            showModal('ğŸ“œ ç»“å±€è¾¾æˆè¦æ±‚', html, [{ 
                text: currentEndingData ? 'è¿”å›ç»“å±€' : 'å…³é—­', 
                class: 'btn-primary', 
                action: () => {
                    closeModal();
                    if (currentEndingData) {
                        setTimeout(() => {
                            showEndingModal(currentEndingData.title, currentEndingData.desc, currentEndingData.emoji, currentEndingData.endingType);
                        }, 100);
                    }
                }
            }]);
        }

        function showSingleEndingRequirement(type) {
            const name = ENDING_NAMES[type];
            const req = ENDING_REQUIREMENTS[type] || 'æœªçŸ¥';
            
            showModal('ğŸ“œ ç»“å±€è¦æ±‚', `
                <div style="text-align:center;margin-bottom:15px;">
                    <div style="font-size:1.1rem;font-weight:600;">${name}</div>
                </div>
                <div style="background:var(--light-bg);border-radius:10px;padding:15px;">
                    <div style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:5px;">è¾¾æˆæ¡ä»¶ï¼š</div>
                    <div style="font-size:0.9rem;">${req}</div>
                </div>
            `, [{ 
                text: currentEndingData ? 'è¿”å›ç»“å±€' : 'å…³é—­', 
                class: 'btn-primary', 
                action: () => {
                    closeModal();
                    if (currentEndingData) {
                        setTimeout(() => {
                            showEndingModal(currentEndingData.title, currentEndingData.desc, currentEndingData.emoji, currentEndingData.endingType);
                        }, 100);
                    }
                }
            }]);
        }
		
        // ==================== é‡å¼€ç¡®è®¤ ====================
        function confirmRestart() {
            if (gameState.totalMonths > 0) {
                showModal('âš ï¸ ç¡®è®¤é‡å¼€', 
                    '<p>ç¡®å®šè¦æ”¾å¼ƒå½“å‰æ¸¸æˆå—ï¼Ÿ</p><p style="color:var(--danger-color);font-size:0.85rem;">è¿™å°†è§¦å‘"ä¸»åŠ¨é€€å­¦"ç»“å±€ï¼</p>', 
                    [
                        { text: 'ç»§ç»­æ¸¸æˆ', class: 'btn-info', action: closeModal },
                        { text: 'ğŸ˜¢ ä¸»åŠ¨é€€å­¦', class: 'btn-danger', action: () => {
                            closeModal();
                            triggerEnding('quit');
                        }}
                    ]
                );
            } else {
                restartGame();
            }
        }

        function restartGame() {
            closeModal();
            
            currentEndingData = null;
            
            document.getElementById('mobile-quick-bar').classList.remove('game-active');
            
            selectedCharacter = null;
            document.querySelectorAll('.character-card').forEach(c => c.classList.remove('selected'));
            
            document.getElementById('start-btn').disabled = true;
            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('start-screen').classList.remove('hidden');

            const wasReversed = gameState.isReversed;
            if (wasReversed) {
                document.getElementById('normal-mode-btn').classList.remove('active');
                document.getElementById('reversed-mode-btn').classList.add('active', 'reversed-active');
            } else {
                document.body.classList.remove('reversed-theme');
                isReversedMode = false;
                document.getElementById('normal-mode-btn').classList.add('active');
                document.getElementById('reversed-mode-btn').classList.remove('active', 'reversed-active');
            }

            renderCharacterGrid();
            loadGlobalStatsDisplay();
        }

		// ==================== Metaè¿›åº¦ç³»ç»Ÿ ====================
		const META_KEY = 'graduateSimulatorMeta';
		const META_START_DATE = '2025-12-11T00:00:00Z';

		function getLocalMeta() {
			const meta = localStorage.getItem(META_KEY);
			return meta ? JSON.parse(meta) : { normal: {}, reversed: {} };
		}

		function saveLocalMeta(meta) {
			localStorage.setItem(META_KEY, JSON.stringify(meta));
		}

		function updateLocalMeta(character, isReversed, score, citations, achievementCount) {
			const meta = getLocalMeta();
			const mode = isReversed ? 'reversed' : 'normal';
			
			if (!meta[mode]) meta[mode] = {};
			if (!meta[mode][character]) {
				meta[mode][character] = { maxScore: 0, maxCitations: 0, maxAchievements: 0 };
			}
			
			const record = meta[mode][character];
			if (score > record.maxScore) record.maxScore = score;
			if (citations > record.maxCitations) record.maxCitations = citations;
			if (achievementCount > record.maxAchievements) record.maxAchievements = achievementCount;
			
			saveLocalMeta(meta);
			return record;
		}

		function getCharacterLocalRecord(characterId, isReversed) {
			const meta = getLocalMeta();
			const mode = isReversed ? 'reversed' : 'normal';
			return meta[mode]?.[characterId] || { maxScore: 0, maxCitations: 0, maxAchievements: 0 };
		}

		// å…¨çƒè§’è‰²è®°å½•ç¼“å­˜
		let globalCharacterRecords = null;
		let globalCharacterRecordsTime = 0;

		async function getGlobalCharacterRecords() {
			if (globalCharacterRecords && (Date.now() - globalCharacterRecordsTime < CACHE_DURATION)) {
				return globalCharacterRecords;
			}
			
			if (!supabase) return null;
			
			try {
				// è®¡ç®—åŒ—äº¬æ—¶é—´ä»Šæ—¥0ç‚¹å¯¹åº”çš„UTCæ—¶é—´
				const now = new Date();
				const beijingOffset = 8 * 60;
				const localOffset = now.getTimezoneOffset();
				const beijingTime = new Date(now.getTime() + (beijingOffset + localOffset) * 60 * 1000);
				const beijingToday = new Date(beijingTime);
				beijingToday.setHours(0, 0, 0, 0);
				const todayUtc = new Date(beijingToday.getTime() - beijingOffset * 60 * 1000);
				const todayStr = todayUtc.toISOString();
				
				// 12æœˆ11æ—¥åŒ—äº¬æ—¶é—´8ç‚¹
				const startDateStr = '2025-12-11T00:00:00Z';
				
				const records = {
					normal: {},
					reversed: {}
				};
				
				// åˆå§‹åŒ–æ‰€æœ‰è§’è‰²
				characters.forEach(char => {
					records.normal[char.id] = {
						today: { maxScore: 0, maxCitations: 0, maxAchievements: 0 },
						history: { maxScore: 0, maxCitations: 0, maxAchievements: 0 }
					};
					records.reversed[char.id] = {
						today: { maxScore: 0, maxCitations: 0, maxAchievements: 0 },
						history: { maxScore: 0, maxCitations: 0, maxAchievements: 0 }
					};
				});
				
				// â˜…â˜…â˜… ä¼˜åŒ–ï¼šåˆ†åˆ«æŸ¥è¯¢å†å²æœ€é«˜å’Œä»Šæ—¥æœ€é«˜ â˜…â˜…â˜…
				
				// 1. æŸ¥è¯¢å†å²æœ€é«˜ï¼ˆæŒ‰è§’è‰²å’Œæ¨¡å¼åˆ†ç»„ï¼‰
				const { data: historyData, error: historyError } = await supabase
					.from('game_endings')
					.select('character, is_reversed, total_score, total_citations, achievements_count')
					.gte('created_at', startDateStr)
					.order('total_score', { ascending: false });
				
				if (historyError) throw historyError;
				
				// 2. æŸ¥è¯¢ä»Šæ—¥æœ€é«˜
				const { data: todayData, error: todayError } = await supabase
					.from('game_endings')
					.select('character, is_reversed, total_score, total_citations, achievements_count')
					.gte('created_at', todayStr)
					.order('total_score', { ascending: false });
				
				if (todayError) throw todayError;
				
				// å¤„ç†å†å²æ•°æ® - åªå–æ¯ä¸ªè§’è‰²çš„æœ€é«˜å€¼
				const historyProcessed = {};
				(historyData || []).forEach(row => {
					const mode = row.is_reversed ? 'reversed' : 'normal';
					const charId = row.character;
					const key = `${mode}_${charId}`;
					
					if (!historyProcessed[key]) {
						historyProcessed[key] = { maxScore: 0, maxCitations: 0, maxAchievements: 0 };
					}
					
					const record = historyProcessed[key];
					if ((row.total_score || 0) > record.maxScore) {
						record.maxScore = row.total_score || 0;
					}
					if ((row.total_citations || 0) > record.maxCitations) {
						record.maxCitations = row.total_citations || 0;
					}
					if ((row.achievements_count || 0) > record.maxAchievements) {
						record.maxAchievements = row.achievements_count || 0;
					}
				});
				
				// å¤„ç†ä»Šæ—¥æ•°æ®
				const todayProcessed = {};
				(todayData || []).forEach(row => {
					const mode = row.is_reversed ? 'reversed' : 'normal';
					const charId = row.character;
					const key = `${mode}_${charId}`;
					
					if (!todayProcessed[key]) {
						todayProcessed[key] = { maxScore: 0, maxCitations: 0, maxAchievements: 0 };
					}
					
					const record = todayProcessed[key];
					if ((row.total_score || 0) > record.maxScore) {
						record.maxScore = row.total_score || 0;
					}
					if ((row.total_citations || 0) > record.maxCitations) {
						record.maxCitations = row.total_citations || 0;
					}
					if ((row.achievements_count || 0) > record.maxAchievements) {
						record.maxAchievements = row.achievements_count || 0;
					}
				});
				
				// åˆå¹¶åˆ° records
				characters.forEach(char => {
					['normal', 'reversed'].forEach(mode => {
						const key = `${mode}_${char.id}`;
						if (historyProcessed[key]) {
							records[mode][char.id].history = historyProcessed[key];
						}
						if (todayProcessed[key]) {
							records[mode][char.id].today = todayProcessed[key];
						}
					});
				});
				
				globalCharacterRecords = records;
				globalCharacterRecordsTime = Date.now();
				
				console.log('âœ… å…¨çƒè§’è‰²è®°å½•åŠ è½½å®Œæˆ');
				return records;
			} catch (e) {
				console.error('è·å–å…¨çƒè§’è‰²è®°å½•å¤±è´¥:', e);
				return globalCharacterRecords || null;
			}
		}

        // ==================== å­˜æ¡£ç³»ç»Ÿ ====================
        const SAVE_KEY = 'graduateSimulatorSaves';
        const MAX_SAVES = 5;

        function getSaves() {
            const saves = localStorage.getItem(SAVE_KEY);
            return saves ? JSON.parse(saves) : [];
        }

        function saveSaves(saves) {
            localStorage.setItem(SAVE_KEY, JSON.stringify(saves));
        }

        function openSaveModal() {
            const saves = getSaves();
            let html = '<div style="margin-bottom:15px;color:var(--text-secondary);font-size:0.85rem;">é€‰æ‹©å­˜æ¡£æ§½ä½ï¼ˆæœ€å¤š5ä¸ªï¼‰ï¼š</div>';
            
            for (let i = 0; i < MAX_SAVES; i++) {
                const save = saves[i];
                if (save) {
                    const modeIcon = save.isReversed ? 'ğŸŒ‘' : 'â˜€ï¸';
                    html += `
                        <div style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--light-bg);border-radius:8px;margin-bottom:8px;">
                            <div style="flex:1;">
                                <div style="font-weight:600;font-size:0.9rem;">${modeIcon} æ§½ä½ ${i + 1}: ${save.characterName}</div>
                                <div style="font-size:0.75rem;color:var(--text-secondary);">
                                    ${save.degree === 'master' ? 'ç¡•å£«' : 'åšå£«'} | ç¬¬${save.year}å¹´${save.month}æœˆ | ç§‘ç ”åˆ†:${save.totalScore}
                                </div>
                                <div style="font-size:0.7rem;color:var(--text-secondary);">
                                    ä¿å­˜äº: ${save.saveTime}
                                </div>
                            </div>
                            <button class="btn btn-primary" style="padding:5px 12px;font-size:0.75rem;" onclick="saveGame(${i})">
                                <i class="fas fa-save"></i> è¦†ç›–
                            </button>
                        </div>`;
                } else {
                    html += `
                        <div style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--light-bg);border-radius:8px;margin-bottom:8px;opacity:0.7;">
                            <div style="flex:1;">
                                <div style="font-weight:600;font-size:0.9rem;">æ§½ä½ ${i + 1}: ç©º</div>
                                <div style="font-size:0.75rem;color:var(--text-secondary);">æš‚æ— å­˜æ¡£</div>
                            </div>
                            <button class="btn btn-success" style="padding:5px 12px;font-size:0.75rem;" onclick="saveGame(${i})">
                                <i class="fas fa-plus"></i> æ–°å»º
                            </button>
                        </div>`;
                }
            }
            
            showModal('ğŸ’¾ å­˜æ¡£', html, [{ text: 'å–æ¶ˆ', class: 'btn-info', action: closeModal }]);
        }

        function openLoadModal() {
            const saves = getSaves();
            
            if (saves.filter(s => s).length === 0) {
                showModal('ğŸ“‚ è¯»æ¡£', '<p style="text-align:center;color:var(--text-secondary);">æš‚æ— å­˜æ¡£</p>', 
                    [{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
                return;
            }
            
            let html = '<div style="margin-bottom:15px;color:var(--text-secondary);font-size:0.85rem;">é€‰æ‹©è¦è¯»å–çš„å­˜æ¡£ï¼š</div>';
            
            for (let i = 0; i < MAX_SAVES; i++) {
                const save = saves[i];
                if (save) {
                    const modeIcon = save.isReversed ? 'ğŸŒ‘' : 'â˜€ï¸';
                    html += `
                        <div style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--light-bg);border-radius:8px;margin-bottom:8px;">
                            <div style="flex:1;">
                                <div style="font-weight:600;font-size:0.9rem;">${modeIcon} æ§½ä½ ${i + 1}: ${save.characterName}</div>
                                <div style="font-size:0.75rem;color:var(--text-secondary);">
                                    ${save.degree === 'master' ? 'ç¡•å£«' : 'åšå£«'} | ç¬¬${save.year}å¹´${save.month}æœˆ | ç§‘ç ”åˆ†:${save.totalScore}
                                </div>
                                <div style="font-size:0.7rem;color:var(--text-secondary);">
                                    Aç±»:${save.paperA} Bç±»:${save.paperB} Cç±»:${save.paperC} | ä¿å­˜äº: ${save.saveTime}
                                </div>
                            </div>
                            <button class="btn btn-primary" style="padding:5px 12px;font-size:0.75rem;" onclick="loadGame(${i})">
                                <i class="fas fa-folder-open"></i> è¯»å–
                            </button>
                            <button class="btn btn-danger" style="padding:5px 12px;font-size:0.75rem;" onclick="deleteSave(${i})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>`;
                }
            }
            
            showModal('ğŸ“‚ è¯»æ¡£', html, [{ text: 'å–æ¶ˆ', class: 'btn-info', action: closeModal }]);
        }

        function openLoadModalFromStart() {
            const saves = getSaves();
            
            if (saves.filter(s => s).length === 0) {
                showModal('ğŸ“‚ è¯»æ¡£', '<p style="text-align:center;color:var(--text-secondary);">æš‚æ— å­˜æ¡£</p>', 
                    [{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
                return;
            }
            
            let html = '<div style="margin-bottom:15px;color:var(--text-secondary);font-size:0.85rem;">é€‰æ‹©è¦è¯»å–çš„å­˜æ¡£ï¼š</div>';
            
            for (let i = 0; i < MAX_SAVES; i++) {
                const save = saves[i];
                if (save) {
                    const modeIcon = save.isReversed ? 'ğŸŒ‘' : 'â˜€ï¸';
                    html += `
                        <div style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--light-bg);border-radius:8px;margin-bottom:8px;">
                            <div style="flex:1;">
                                <div style="font-weight:600;font-size:0.9rem;">${modeIcon} æ§½ä½ ${i + 1}: ${save.characterName}</div>
                                <div style="font-size:0.75rem;color:var(--text-secondary);">
                                    ${save.degree === 'master' ? 'ç¡•å£«' : 'åšå£«'} | ç¬¬${save.year}å¹´${save.month}æœˆ | ç§‘ç ”åˆ†:${save.totalScore}
                                </div>
                                <div style="font-size:0.7rem;color:var(--text-secondary);">
                                    Aç±»:${save.paperA} Bç±»:${save.paperB} Cç±»:${save.paperC} | ä¿å­˜äº: ${save.saveTime}
                                </div>
                            </div>
                            <button class="btn btn-primary" style="padding:5px 12px;font-size:0.75rem;" onclick="loadGame(${i})">
                                <i class="fas fa-folder-open"></i> è¯»å–
                            </button>
                        </div>`;
                }
            }
            
            showModal('ğŸ“‚ è¯»æ¡£', html, [{ text: 'å–æ¶ˆ', class: 'btn-info', action: closeModal }]);
        }

        function saveGame(slot) {
            const saves = getSaves();
            const now = new Date();
            const timeStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            
            const shopState = shopItems.map(item => ({
                id: item.id,
                bought: item.bought || false,
                boughtThisMonth: item.boughtThisMonth || false
            }));
            
            const papersCopy = gameState.papers.map(paper => {
                if (paper === null) return null;
                return {
                    title: paper.title,
                    ideaScore: paper.ideaScore,
                    expScore: paper.expScore,
                    writeScore: paper.writeScore,
                    reviewing: paper.reviewing || false,
                    reviewMonths: paper.reviewing ? Math.min(4, Math.max(0, paper.reviewMonths)) : 0,
                    submittedGrade: paper.submittedGrade || null,
                    submittedScore: paper.submittedScore || 0
                };
            });
            
            const publishedPapersCopy = gameState.publishedPapers.map(paper => ({
                title: paper.title,
                grade: paper.grade,
                acceptType: paper.acceptType,
                score: paper.score,
                citations: paper.citations,
                monthsSincePublish: paper.monthsSincePublish || 0,
                promotions: paper.promotions ? { ...paper.promotions } : { arxiv: false, github: false, xiaohongshu: false, quantumbit: false },
                citationMultiplier: paper.citationMultiplier || 1
            }));
            
            const buffsCopy = {
                permanent: gameState.buffs.permanent.map(b => ({ ...b })),
                temporary: gameState.buffs.temporary.map(b => ({ ...b }))
            };
            
            const saveData = {
                character: gameState.character,
                characterName: gameState.characterName,
                degree: gameState.degree,
                year: gameState.year,
                month: gameState.month,
                totalMonths: gameState.totalMonths,
                maxYears: gameState.maxYears,
                san: gameState.san,
                sanMax: gameState.sanMax,
                research: gameState.research,
                social: gameState.social,
                favor: gameState.favor,
                gold: gameState.gold,
                
                paperA: gameState.paperA,
                paperB: gameState.paperB,
                paperC: gameState.paperC,
                totalScore: gameState.totalScore,
                totalCitations: gameState.totalCitations,
                publishedPapers: publishedPapersCopy,
                paperSlots: gameState.paperSlots,
                papers: papersCopy,
                
                buffs: buffsCopy,
                
                actionUsed: gameState.actionUsed,
                readCount: gameState.readCount,
                firstPaperAccepted: gameState.firstPaperAccepted,
                firstAPaperAccepted: gameState.firstAPaperAccepted,
                hasLover: gameState.hasLover,
                loverType: gameState.loverType,
                bigBullCooperation: gameState.bigBullCooperation,
                rejectedCount: gameState.rejectedCount,
                teaBreakCount: gameState.teaBreakCount,
                tourCount: gameState.tourCount,
                metBigBull: gameState.metBigBull,
                metBeautiful: gameState.metBeautiful,
                metSmart: gameState.metSmart,
                bigBullDeepCount: gameState.bigBullDeepCount,
                beautifulCount: gameState.beautifulCount,
                smartCount: gameState.smartCount,
                
                availableRandomEvents: [...gameState.availableRandomEvents],
                usedRandomEvents: [...gameState.usedRandomEvents],
                triggeredBuffTypes: [...(gameState.triggeredBuffTypes || [])],
                coffeeBoughtCount: gameState.coffeeBoughtCount || 0,
                goldSpentTotal: gameState.goldSpentTotal || 0,
                
                isReversed: gameState.isReversed,
                reversedAwakened: gameState.reversedAwakened,
                blockedResearchGains: gameState.blockedResearchGains,
                goldLocked: gameState.goldLocked,
                statsLocked: gameState.statsLocked,
                
                pendingPhDChoice: gameState.pendingPhDChoice || false,
                pendingConference: gameState.pendingConference || null,
                enterpriseCount: gameState.enterpriseCount || 0,
                ailabInternship: gameState.ailabInternship || false,
                firstBestPaperAccepted: gameState.firstBestPaperAccepted || false,
                
                // â˜…â˜…â˜… æ–°å¢ï¼šé€†ä½å¯Œå¯æ•Œå›½çš„ä¿å­˜å­—æ®µ â˜…â˜…â˜…
                lastResetMonth: gameState.lastResetMonth || 0,
				socialAwakened: gameState.socialAwakened || false,
				reviewerDistribution: gameState.reviewerDistribution || null,
				badmintonMonth: gameState.badmintonMonth || -1,
                
                rejectedPapers: {...(gameState.rejectedPapers || {})},
                maxConcurrentReviews: gameState.maxConcurrentReviews || 0,
                phdOpportunitiesRejected: gameState.phdOpportunitiesRejected || 0,
                gpuServersBought: gameState.gpuServersBought || 0,
                furnitureBought: {...(gameState.furnitureBought || {})},
                achievementConditions: {...(gameState.achievementConditions || {})},
                paperTypeCollection: gameState.paperTypeCollection ? [...gameState.paperTypeCollection] : [],
                
                shopState: shopState,
                saveTime: timeStr
            };
            
            saves[slot] = saveData;
            saveSaves(saves);
            closeModal();
            
            showModal('âœ… å­˜æ¡£æˆåŠŸ', `<p style="text-align:center;">æ¸¸æˆå·²ä¿å­˜åˆ°æ§½ä½ ${slot + 1}</p>`, 
                [{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
            
            addLog('ç³»ç»Ÿ', 'æ¸¸æˆå·²å­˜æ¡£', `æ§½ä½ ${slot + 1}`);
        }

        function loadGame(slot) {
            const saves = getSaves();
            const save = saves[slot];
            
            if (!save) {
                showModal('âŒ è¯»æ¡£å¤±è´¥', '<p>è¯¥å­˜æ¡£ä¸å­˜åœ¨ï¼</p>', 
                    [{ text: 'ç¡®å®š', class: 'btn-primary', action: closeModal }]);
                return;
            }
            
            showModal('âš ï¸ ç¡®è®¤è¯»æ¡£', 
                `<p>ç¡®å®šè¦è¯»å–æ§½ä½ ${slot + 1} çš„å­˜æ¡£å—ï¼Ÿ</p><p style="color:var(--danger-color);font-size:0.85rem;">å½“å‰æ¸¸æˆè¿›åº¦å°†ä¸¢å¤±ï¼</p>`, 
                [
                    { text: 'å–æ¶ˆ', class: 'btn-info', action: closeModal },
                    { text: 'ç¡®å®šè¯»å–', class: 'btn-primary', action: () => {
                        if (save.shopState) {
                            save.shopState.forEach(savedItem => {
                                const item = shopItems.find(i => i.id === savedItem.id);
                                if (item) {
                                    item.bought = savedItem.bought;
                                    item.boughtThisMonth = savedItem.boughtThisMonth;
                                }
                            });
                        }
                        
                        gameState = {
                            character: save.character,
                            characterName: save.characterName,
                            degree: save.degree,
                            year: save.year,
                            month: save.month,
                            totalMonths: save.totalMonths,
                            maxYears: save.maxYears,
                            san: save.san,
                            sanMax: save.sanMax,
                            research: save.research,
                            social: save.social,
                            favor: save.favor,
                            gold: save.gold,
                            
                            paperA: save.paperA,
                            paperB: save.paperB,
                            paperC: save.paperC,
                            totalScore: save.totalScore,
                            totalCitations: save.totalCitations,
                            publishedPapers: save.publishedPapers.map(p => ({ 
                                ...p, 
                                promotions: p.promotions ? { ...p.promotions } : { arxiv: false, github: false, xiaohongshu: false, quantumbit: false },
                                citationMultiplier: p.citationMultiplier || 1,
                                monthsSincePublish: p.monthsSincePublish || 0
                            })),
                            paperSlots: save.paperSlots,
                            
                            papers: save.papers.map(p => {
                                if (p === null) return null;
                                return {
                                    title: p.title,
                                    ideaScore: p.ideaScore,
                                    expScore: p.expScore,
                                    writeScore: p.writeScore,
                                    reviewing: p.reviewing || false,
                                    reviewMonths: p.reviewing ? Math.min(4, Math.max(0, p.reviewMonths || 0)) : 0,
                                    submittedGrade: p.submittedGrade || null,
                                    submittedScore: p.submittedScore || 0
                                };
                            }),
                            
                            buffs: {
                                permanent: save.buffs.permanent.map(b => ({ ...b })),
                                temporary: save.buffs.temporary.map(b => ({ ...b }))
                            },
                            
                            actionUsed: save.actionUsed,
                            readCount: save.readCount,
                            firstPaperAccepted: save.firstPaperAccepted,
                            firstAPaperAccepted: save.firstAPaperAccepted,
                            hasLover: save.hasLover,
                            loverType: save.loverType,
                            bigBullCooperation: save.bigBullCooperation,
                            rejectedCount: save.rejectedCount,
                            teaBreakCount: save.teaBreakCount,
                            tourCount: save.tourCount,
                            metBigBull: save.metBigBull,
                            metBeautiful: save.metBeautiful,
                            metSmart: save.metSmart,
                            bigBullDeepCount: save.bigBullDeepCount,
                            beautifulCount: save.beautifulCount,
                            smartCount: save.smartCount,
                            enterpriseCount: save.enterpriseCount || 0,
                            ailabInternship: save.ailabInternship || false,
                            firstBestPaperAccepted: save.firstBestPaperAccepted || false,
                            goldSpentTotal: save.goldSpentTotal || 0,
                            
                            availableRandomEvents: save.availableRandomEvents ? [...save.availableRandomEvents] : [],
                            usedRandomEvents: save.usedRandomEvents ? [...save.usedRandomEvents] : [],
                            triggeredBuffTypes: save.triggeredBuffTypes ? [...save.triggeredBuffTypes] : [],
                            coffeeBoughtCount: save.coffeeBoughtCount || 0,
                            
                            pendingPhDChoice: save.pendingPhDChoice || false,
                            pendingConference: save.pendingConference || null,
                            
                            isReversed: save.isReversed || false,
                            reversedAwakened: save.reversedAwakened || false,
                            blockedResearchGains: save.blockedResearchGains || 0,
                            goldLocked: save.goldLocked || false,
                            statsLocked: save.statsLocked || false,
                            _isMonthlyFavorDecrease: false,
                            
                            // â˜…â˜…â˜… æ–°å¢ï¼šé€†ä½å¯Œå¯æ•Œå›½çš„è¯»æ¡£å­—æ®µ â˜…â˜…â˜…
                            lastResetMonth: save.lastResetMonth || 0,
							socialAwakened: save.socialAwakened || false,
							reviewerDistribution: save.reviewerDistribution || null,
							badmintonMonth: save.badmintonMonth || -1,
                            
                            rejectedPapers: save.rejectedPapers ? {...save.rejectedPapers} : {},
                            furnitureBought: save.furnitureBought ? {...save.furnitureBought} : {
                                chair: false,
                                monitor: false,
                                keyboard: false
                            },
                            achievementConditions: save.achievementConditions ? {...save.achievementConditions} : {
                                highScorePaper: false,
                                unanimousImprovement: false,
                                allBadReviewers: false,
                                tripleRejected: false,
                                bought5GPUs: false,
                                fullFurnitureSet: false,
                                phdRequirementMetEarly: false,
                                rejectedPhdTwice: false
                            },
                            maxConcurrentReviews: save.maxConcurrentReviews || 0,
                            phdOpportunitiesRejected: save.phdOpportunitiesRejected || 0,
                            gpuServersBought: save.gpuServersBought || 0,
                            paperTypeCollection: new Set(save.paperTypeCollection || [])
                        };
                        
                        if (!gameState.availableRandomEvents || gameState.availableRandomEvents.length === 0) {
                            if (!gameState.usedRandomEvents || gameState.usedRandomEvents.length === 0) {
                                resetRandomEventPool();
                            }
                        }
                        
                        if (gameState.isReversed) {
                            document.body.classList.add('reversed-theme');
                            isReversedMode = true;
                        } else {
                            document.body.classList.remove('reversed-theme');
                            isReversedMode = false;
                        }
                        
                        document.getElementById('start-screen').classList.add('hidden');
                        document.getElementById('game-screen').style.display = 'block';
                        document.getElementById('mobile-quick-bar').classList.add('game-active');
                        
                        updateAllUI();
                        renderPaperSlots();
                        
                        closeModal();
                        addLog('ç³»ç»Ÿ', 'è¯»å–å­˜æ¡£æˆåŠŸ', `æ§½ä½ ${slot + 1}`);
                        
                        let pendingReviews = [];
                        gameState.papers.forEach((paper, idx) => {
                            if (paper && paper.reviewing && paper.reviewMonths <= 0) {
                                pendingReviews.push(idx);
                            }
                        });

                        if (pendingReviews.length > 0) {
                            pendingReviews.forEach((idx, i) => {
                                setTimeout(() => {
                                    if (gameState.papers[idx] && gameState.papers[idx].reviewing) {
                                        processPaperResult(idx);
                                    }
                                }, 500 + i * 300);
                            });
                        } else {
                            let reviewingInfo = '';
                            gameState.papers.forEach((paper, idx) => {
                                if (paper && paper.reviewing) {
                                    reviewingInfo += `<br>â€¢ æ§½ä½${idx + 1}: ${paper.submittedGrade}ç±»å®¡ç¨¿ä¸­ï¼Œå‰©ä½™${paper.reviewMonths}æœˆ`;
                                }
                            });
                            
                            const modeText = gameState.isReversed ? 'ï¼ˆé€†ä½æ¨¡å¼ï¼‰' : 'ï¼ˆæ­£ä½æ¨¡å¼ï¼‰';
                            showModal('âœ… è¯»æ¡£æˆåŠŸ', 
                                `<p style="text-align:center;">å·²è¯»å–æ§½ä½ ${slot + 1} çš„å­˜æ¡£ ${modeText}</p>
                                 <p style="font-size:0.85rem;color:var(--text-secondary);">
                                    å½“å‰è¿›åº¦ï¼šç¬¬${gameState.year}å¹´${gameState.month}æœˆ<br>
                                    ç§‘ç ”åˆ†ï¼š${gameState.totalScore}
                                    ${reviewingInfo ? '<br><strong>å®¡ç¨¿ä¸­çš„è®ºæ–‡ï¼š</strong>' + reviewingInfo : ''}
                                 </p>`, 
                                [{ text: 'ç»§ç»­æ¸¸æˆ', class: 'btn-primary', action: closeModal }]);
                        }
                    }}
                ]
            );
        }

        function deleteSave(slot) {
            showModal('âš ï¸ ç¡®è®¤åˆ é™¤', 
                `<p>ç¡®å®šè¦åˆ é™¤æ§½ä½ ${slot + 1} çš„å­˜æ¡£å—ï¼Ÿ</p><p style="color:var(--danger-color);font-size:0.85rem;">æ­¤æ“ä½œä¸å¯æ¢å¤ï¼</p>`, 
                [
                    { text: 'å–æ¶ˆ', class: 'btn-info', action: closeModal },
                    { text: 'ç¡®å®šåˆ é™¤', class: 'btn-danger', action: () => {
                        const saves = getSaves();
                        saves[slot] = null;
                        saveSaves(saves);
                        closeModal();
                        openLoadModal();
                    }}
                ]
            );
        }
		
        // ==================== å¼¹çª—ç³»ç»Ÿ ====================
        let modalCallbacks = [];

        function showModal(title, content, buttons) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-content').innerHTML = content;
            modalCallbacks = buttons.map(b => b.action);
            document.getElementById('modal-buttons').innerHTML = buttons.map((b, i) =>
                `<button class="btn ${b.class}" onclick="modalCallbacks[${i}]()">${b.text}</button>`
            ).join('');
            document.getElementById('modal-overlay').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('active');
        }

        function showPaperSelectModal(action, papers, callback) {
            let html = `<p style="font-size:0.9rem;">è¯·é€‰æ‹©è¦è¿›è¡Œ"${action}"çš„è®ºæ–‡ï¼š</p><div style="display:flex;flex-direction:column;gap:8px;margin-top:10px;">`;
            papers.forEach(({ paper, index }) => {
                const total = paper.ideaScore + paper.expScore + paper.writeScore;
                html += `<div style="padding:12px;background:var(--light-bg);border-radius:10px;cursor:pointer;border:2px solid transparent;transition:all 0.3s;"
                    onmouseover="this.style.borderColor='var(--primary-color)'"
                    onmouseout="this.style.borderColor='transparent'"
                    onclick="paperSelectCallback(${index})">
                    <div style="font-weight:600;margin-bottom:5px;font-size:0.85rem;">${paper.title.substring(0, 30)}${paper.title.length > 30 ? '...' : ''}</div>
                    <div style="display:flex;gap:10px;font-size:0.75rem;color:var(--text-secondary);">
                        <span>ğŸ’¡${paper.ideaScore}</span>
                        <span>ğŸ”¬${paper.expScore}</span>
                        <span>âœï¸${paper.writeScore}</span>
                        <span style="color:var(--primary-color);font-weight:600;">æ€»åˆ†:${total}</span>
                    </div>
                </div>`;
            });
            html += '</div>';
            window.paperSelectCallback = (idx) => { closeModal(); callback(idx); };
            showModal(`ğŸ“ é€‰æ‹©è®ºæ–‡ - ${action}`, html, [{ text: 'å–æ¶ˆ', class: 'btn-info', action: closeModal }]);
        }

        // ==================== æ—¥å¿—ç³»ç»Ÿ ====================
        function addLog(event, detail, result = '') {
            const logContent = document.getElementById('log-content');
            const dateStr = `ç¬¬${gameState.year}å¹´${gameState.month}æœˆ`;
            const isNegative = result && (result.includes('-') || result.includes('æ‹’ç¨¿') || result.includes('ä¸æ»¡') || result.includes('å¤±è´¥') || result.includes('è½é€‰'));
            const entry = document.createElement('div');
            entry.className = `log-entry ${isNegative ? 'negative' : ''}`;
            entry.innerHTML = `<div class="date">[${dateStr}] ${event}</div><div class="event">${detail}</div>${result ? `<div class="result">â†’ ${result}</div>` : ''}`;
            logContent.insertBefore(entry, logContent.firstChild);
            while (logContent.children.length > 100) logContent.removeChild(logContent.lastChild);
        }

        // ==================== å·¥å…·å‡½æ•° ====================
        function rand(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

        function shuffle(arr) {
            const a = [...arr];
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }

        function scrollToPanel(panelId) {
            const panel = document.getElementById(panelId);
            if (panel) {
                panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // ==================== å¯åŠ¨æ¸¸æˆ ====================
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
